<application>
  <component name="VimSettings">
    <state version="4" enabled="true" />
    <globalmarks />
    <filemarks>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.animation/CMakeLists.txt" timestamp="1512584919648">
        <mark key="'" line="190" column="36" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/api/RendererObjectFactory.cpp" timestamp="1494605056851">
        <mark key="'" line="237" column="36" />
      </file>
      <file name="$USER_HOME$/dev/igbuild/linux/debug/proj_tmp/com.amazon.ignition.framework.network/com.amazon.ignition.framework.network/LuaFFIExport.cpp" timestamp="1512580713080">
        <mark key="'" line="91" column="72" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.report/internal/src/report/PluginReport.cpp" timestamp="1497549183510">
        <mark key="'" line="44" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/internal/platform/ps3/include/cppcompatibility/UniquePtr.h" timestamp="1513097482447">
        <mark key="'" line="177" column="4" />
      </file>
      <file name="$USER_HOME$/psdev/ig382build/init.js" timestamp="1510827609967">
        <mark key="'" line="83483" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/src/bindings/sm/StorageExtension.cpp" timestamp="1510922342352">
        <mark key="'" line="70" column="14" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/scripts/lua/job/StartupJob.lua" timestamp="1512645833987">
        <mark key="'" line="5" column="36" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/internal/src/Network.cpp" timestamp="1502117425936">
        <mark key="'" line="28" column="18" />
      </file>
      <file name="$USER_HOME$/dev/igbuild/linux/debug/proj_tmp/com.amazon.ignition.framework.lua/luajit/src/lauxlib.h" timestamp="1512644980582">
        <mark key="'" line="109" column="8" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/allocation/memory/IAllocator.h" timestamp="1512051744483">
        <mark key="'" line="43" column="22" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/src/Bucket.cpp" timestamp="1510922247224">
        <mark key="'" line="18" column="21" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/scripts/lua/availability/BaseCandidateRetriever.lua" timestamp="1512647600168">
        <mark key="'" line="7" column="32" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.deviceinfo/thirdparty/devicepropertiescomponent/amazonite/library-loader/src/ExternalContextFactory.cpp" timestamp="1501251380525">
        <mark key="'" line="245" column="39" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/com.amazon.ignition.framework.core/internal/platform/android/src/SystemInit.cpp" timestamp="1516102548337">
        <mark key="'" line="130" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.scene/src/scene/SceneLifecycleManager.cpp" timestamp="1512057545856">
        <mark key="'" line="76" column="28" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/allocation/memory/PoolAllocatorAdapter.h" timestamp="1512128213169">
        <mark key="'" line="23" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/src/backends/SecureStorageBackend.cpp" timestamp="1511544158816">
        <mark key="'" line="164" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/backend/gles2/src/api/GLES2FrameBufferObject.cpp" timestamp="1494604554298">
        <mark key="'" line="69" column="77" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/tests/TextToSpeechTest.cpp" timestamp="1493982507515">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/include/api/Texture.h" timestamp="1512643575205">
        <mark key="'" line="64" column="17" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/include/av_display.h" timestamp="1493734469271">
        <mark key="'" line="82" column="13" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/com.amazon.ignition.framework.player/internal/platform/android/src/player/PlayerPlatformFactory.cpp" timestamp="1502117932596">
        <mark key="'" line="10" column="30" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/internal/platform/linux/src/filesystem/FileSystemFacade.cpp" timestamp="1511279881495">
        <mark key="'" line="23" column="28" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.display/internal/src/display/DevicePlatformContext.cpp" timestamp="1512488088863">
        <mark key="'" line="49" column="10" />
      </file>
      <file name="$USER_HOME$/dev/ig/samsung-ignition/com.amazon.ignition.framework.deviceinfo/internal/platform/samsungtv/src/deviceinfo/properties/SamsungTVDevicePropertiesProvider.cpp" timestamp="1499794013967">
        <mark key="'" line="95" column="8" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.input/src/bindings/sm/InputExtension.cpp" timestamp="1497959148658">
        <mark key="'" line="173" column="21" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/errors/CrashDataCollector.cpp" timestamp="1513014044487">
        <mark key="'" line="55" column="25" />
      </file>
      <file name="/usr/include/curl/easy.h" timestamp="1510243231373">
        <mark key="'" line="29" column="21" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.animation/include/bindings/lua/InterpolatorLuaBinding.h" timestamp="1512643159460">
        <mark key="'" line="9" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/cmakescripts/build/backend.cmake" timestamp="1497605724960">
        <mark key="'" line="5" column="17" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/utils/TaggedBuffer.h" timestamp="1512050850449">
        <mark key="'" line="16" column="50" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/src/ota/bindings/sm/ManagerEventsExtension.cpp" timestamp="1513696719118">
        <mark key="'" line="58" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/include/backends/SecureStorageBackend.h" timestamp="1511277827809">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/errors/CrashDataCollector.h" timestamp="1513013425170">
        <mark key="'" line="32" column="14" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/internal/include/deviceinfo/utils/ThreadSafeInitialiser.h" timestamp="1502723863814">
        <mark key="'" line="18" column="17" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/com.amazon.ignition.framework.renderer/internal/platform/android/cmakescripts/build.cmake" timestamp="1498065989182">
        <mark key="'" line="0" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicerpi/implementation/linux/src/avDisplay.cpp" timestamp="1504720197545">
        <mark key="'" line="163" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.input/src/Input.cpp" timestamp="1512655917550">
        <mark key="'" line="138" column="22" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.display/internal/src/PluginDisplay.cpp" timestamp="1501076700002">
        <mark key="'" line="99" column="26" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/internal/src/http/HttpResponse.cpp" timestamp="1513091676450">
        <mark key="'" line="87" column="51" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/include/utils/ForwardDeclarations.h" timestamp="1494605318859">
        <mark key="'" line="38" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.input/include/util/KeyRepeatManager.h" timestamp="1497959885619">
        <mark key="'" line="116" column="15" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/scripts/lua/availability/UpdateChecker.lua" timestamp="1512647930102">
        <mark key="'" line="16" column="59" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/backend/gles2/include/api/GLES2Api.h" timestamp="1507112717072">
        <mark key="'" line="352" column="9" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/allocation/memory/allocator/ChunkAllocator.cpp" timestamp="1513009064552">
        <mark key="'" line="31" column="7" />
      </file>
      <file name="/GlyphAtlas.cpp" timestamp="1512049013089">
        <mark key="'" line="51" column="12" />
      </file>
      <file name="$USER_HOME$/local/depo/src/depo/config.py" timestamp="1495212797707">
        <mark key="'" line="51" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.display/internal/platform/device/src/display/DevicePlatformContext.cpp" timestamp="1495465446468">
        <mark key="'" line="152" column="40" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/megablast_native_apis.cpp" timestamp="1516712883089">
        <mark key="'" line="538" column="53" />
        <mark key="[" line="625" column="5" />
        <mark key="]" line="625" column="4" />
        <mark key="^" line="625" column="4" />
        <mark key="." line="625" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/internal/src/SDLCommonContext.cpp" timestamp="1493982740057">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/igbuild/linux/debug/amazonite/linux/platform/device-properties/implementation/devicepropertiesprovider/src/PlatformDevicePropertiesProvider.cpp" timestamp="1499795243833">
        <mark key="'" line="425" column="70" />
      </file>
      <file name="$USER_HOME$/dev/raspberry-pi-tools/arm-bcm2708/arm-bcm2708hardfp-linux-gnueabi/arm-bcm2708hardfp-linux-gnueabi/include/c++/4.7.1/bits/stl_queue.h" timestamp="1503415803655">
        <mark key="'" line="160" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/allocation/memory/HeapAllocatorMultiPoolFrontEnd.h" timestamp="1512127942344">
        <mark key="'" line="22" column="38" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" timestamp="1518445361804">
        <mark key="'" line="333" column="17" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/libcurl.cmake" timestamp="1515152273694">
        <mark key="'" line="171" column="6" />
      </file>
      <file name="$USER_HOME$/dev/iglg/lg-ignition/lg/com.amazon.ignition.framework.network/internal/platform/lg/src/PlatformUtils.cpp" timestamp="1499444056666">
        <mark key="'" line="118" column="24" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.font/src/font/GlyphAtlas.cpp" timestamp="1512049093623">
        <mark key="'" line="141" column="29" />
      </file>
      <file name="/usr/include/c++/4.9/bits/basic_string.h" timestamp="1511962081025">
        <mark key="'" line="440" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/internal/include/SecureStorage.h" timestamp="1511963103524">
        <mark key="'" line="9" column="0" />
      </file>
      <file name="$USER_HOME$/dev/portingkitreleasetools/tools/release/export_clean/src/filesystem/cleaner/FileSystemCleaner.py" timestamp="1495201610283">
        <mark key="'" line="50" column="17" />
      </file>
      <file name="$USER_HOME$/dev/iglg/devicelg/implementation/lg/internal/src/SDLDisplayContext.cpp" timestamp="1501077304523">
        <mark key="'" line="324" column="24" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.texttospeech/device/tests/TextToSpeechTest.cpp" timestamp="1499949294890">
        <mark key="'" line="75" column="26" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.javascript/src/sm/extensions/CommandLineArgsExtension.cpp" timestamp="1494321323849">
        <mark key="'" line="40" column="68" />
      </file>
      <file name="$USER_HOME$/dev/iglg/lg-ignition/lg/com.amazon.ignition.framework.core/internal/platform/lg/src/luna/NativeAppHandler.cpp" timestamp="1501005775169">
        <mark key="'" line="95" column="23" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.app.stark/scripts/config.js" timestamp="1513098766325">
        <mark key="'" line="109" column="21" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/cppcompatibility/std/UniquePtr.h" timestamp="1513097495616">
        <mark key="'" line="15" column="34" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/backend/null/include/display/NullDisplayContext.h" timestamp="1499792355733">
        <mark key="'" line="18" column="34" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/com.amazon.ignition.framework.player/internal/platform/android/include/player/AndroidPlayerPlatform.h" timestamp="1502118076013">
        <mark key="'" line="15" column="42" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/internal/src/http/data/FileHttpResponseConsumer.cpp" timestamp="1513092251238">
        <mark key="'" line="40" column="26" />
      </file>
      <file name="$USER_HOME$/dev/igbuild/linux/debug/proj_tmp/com.amazon.ignition.framework.animation/src/bindings/sm/generated/AnimationExtensionClassBinding.cpp" timestamp="1497535604119">
        <mark key="'" line="44" column="43" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.devicelayerloader/cmakescripts/config/devicelayer.cmake" timestamp="1510927825049">
        <mark key="'" line="2" column="8" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.renderer/internal/backend/gles2/include/api/GLES2Api.h" timestamp="1499435369100">
        <mark key="'" line="376" column="38" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.focus.logic/scripts/lua/FocusApi.lua" timestamp="1512580276749">
        <mark key="'" line="16" column="20" />
      </file>
      <file name="$USER_HOME$/dev/ci/patches/ignition.local" timestamp="1499162175051">
        <mark key="'" line="44" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/src/ota/package/PackageInstallerFactory.cpp" timestamp="1512648464854">
        <mark key="'" line="33" column="57" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.devicelayerloader/device-layer-skeleton/interface/include/device/av_display_defs.h" timestamp="1505127084189">
        <mark key="'" line="61" column="2" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/ConfigurationManager.cpp" timestamp="1517247698198">
        <mark key="'" line="92" column="20" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/internal/platform/linux/assets/launch" timestamp="1494407539106">
        <mark key="'" line="9" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/test/CMakeLists.txt" timestamp="1512135283358">
        <mark key="'" line="35" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/thirdparty/curl/lib/curl_setup.h" timestamp="1515152800959">
        <mark key="'" line="55" column="1" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/IgnitionHostMessage.cpp" timestamp="1511776210608">
        <mark key="'" line="3" column="14" />
      </file>
      <file name="$USER_HOME$/dev/iglg/devicelg/implementation/lg/internal/src/deviceLuna/LGMediaLSCall.cpp" timestamp="1499190031788">
        <mark key="'" line="194" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/interface/include/device/av_input_defs.h" timestamp="1495626114088">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/internal/src/SDLDisplayContext.cpp" timestamp="1512045845050">
        <mark key="'" line="242" column="12" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicerpi/implementation/rpi/CMakeLists.txt" timestamp="1512135951587">
        <mark key="[" line="23" column="0" />
        <mark key="]" line="23" column="42" />
        <mark key="." line="23" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/DuktapePolyfills.js" timestamp="1518444434018">
        <mark key="'" line="58" column="20" />
        <mark key="[" line="58" column="15" />
        <mark key="]" line="26" column="19" />
        <mark key="." line="58" column="19" />
        <mark key="^" line="26" column="19" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/internal/include/LegacySecureStorage.h" timestamp="1512134549269">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="/usr/include/c++/4.9/functional" timestamp="1511178079009">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/igbuild/linux/relwithdebinfo/CMakeCache.txt" timestamp="1512046951790">
        <mark key="'" line="36" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/internal/include/SDLCommonContext.h" timestamp="1493982759051">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.player/internal/src/videoPlayer/player/amp/PlayerPlatform.cpp" timestamp="1503659122474">
        <mark key="'" line="198" column="21" />
      </file>
      <file name="$USER_HOME$/dev/igrpi/devicerpi/implementation/rpi/src/avSecureStorageBackend.cpp" timestamp="1498736188272">
        <mark key="'" line="38" column="25" />
      </file>
      <file name="$USER_HOME$/dev/igbuildlg/lg/release/amazonite/lg/platform/device-properties/adaptor/devicepropertiesprovider/include/PropertyEntry.h" timestamp="1501251681101">
        <mark key="'" line="39" column="58" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/com.amazon.ignition.framework.core/internal/platform/android/cmakescripts/build.cmake" timestamp="1497263936870">
        <mark key="'" line="63" column="11" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/internal/src/deviceinfo/identity/GeneratedSerialNumberProvider.cpp" timestamp="1502722872589">
        <mark key="'" line="13" column="14" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.report/tests/report/listeners/LogListenerTest.cpp" timestamp="1497549176982">
        <mark key="'" line="130" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/src/ota/package/PackageExpander.cpp" timestamp="1512649116679">
        <mark key="'" line="57" column="19" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/thirdparty/curl/include/curl/system.h" timestamp="1515159948670">
        <mark key="[" line="436" column="0" />
        <mark key="]" line="436" column="40" />
        <mark key="." line="436" column="0" />
      </file>
      <file name="/Dummy.txt" timestamp="1518445349245">
        <mark key="[" line="0" column="0" />
        <mark key="]" line="0" column="0" />
        <mark key="." line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/porting/linux/SDLRenderBackend.cpp" timestamp="1510306611131">
        <mark key="'" line="213" column="61" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/com.amazon.ignition.framework.core/internal/platform/android/mainlib/src/main.cpp" timestamp="1502116323049">
        <mark key="'" line="25" column="16" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.display/internal/platform/linux/src/egl/LinuxPlatformContext.cpp" timestamp="1510240820808">
        <mark key="'" line="215" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.font/thirdparty/icu/source/common/unicode/unistr.h" timestamp="1497968563924">
        <mark key="'" line="34" column="0" />
      </file>
      <file name="/usr/include/c++/4.9/bits/unique_ptr.h" timestamp="1513100943345">
        <mark key="'" line="231" column="6" />
      </file>
      <file name="$USER_HOME$/opt/cross/lg/M16p/usr/include/luna-service2/lunaservice.h" timestamp="1499450799538">
        <mark key="'" line="359" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/samsung-ignition/com.amazon.ignition.framework.core/internal/platform/samsungtv/src/plugin/PluginPathPlatform.cpp" timestamp="1497621666727">
        <mark key="'" line="28" column="29" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/tests/errors/CrashDataCollectorCrashDataMapTest.cpp" timestamp="1513014831013">
        <mark key="'" line="164" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/allocation/memory/allocator/HighFilterAllocator.cpp" timestamp="1512051919795">
        <mark key="'" line="15" column="15" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/tests/lib/gmock/include/gmock/gmock-matchers.h" timestamp="1498663905923">
        <mark key="'" line="2409" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.scene/src/scene/bindings/lua/LuaSceneBinding.cpp" timestamp="1509109379266">
        <mark key="'" line="157" column="20" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/internal/src/bindings/lua/ffi/HttpRequestSharedPtrLuaBinding.cpp" timestamp="1512580624413">
        <mark key="'" line="176" column="36" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/include/api/RendererObjectFactory.h" timestamp="1494605317227">
        <mark key="'" line="62" column="12" />
      </file>
      <file name="$USER_HOME$/dev/ci/deliver/deliver.cmake" timestamp="1499161901044">
        <mark key="'" line="8" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/CommandBuffer.h" timestamp="1510243688832">
        <mark key="'" line="103" column="8" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/cmakescripts/get-plugin-platform-dir.cmake" timestamp="1496761900229">
        <mark key="'" line="17" column="23" />
      </file>
      <file name="$USER_HOME$/dev/ci/prepare-source/ignition.cmake" timestamp="1499159974188">
        <mark key="'" line="22" column="47" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/internal/src/SDLInputContext.cpp" timestamp="1512132530056">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/src/ota/PluginOTA.cpp" timestamp="1513696793766">
        <mark key="'" line="77" column="23" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/internal/platform/linux/src/plugin/PluginPathPlatform.cpp" timestamp="1497612368796">
        <mark key="'" line="60" column="29" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.deviceinfo/thirdparty/devicepropertiescomponent/amazonite/config.cmake" timestamp="1499346509348">
        <mark key="'" line="55" column="40" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/allocation/memory/allocator/HighFilterAllocator.h" timestamp="1512051934908">
        <mark key="'" line="37" column="13" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" timestamp="1518450726932">
        <mark key="'" line="23053" column="63" />
        <mark key="[" line="0" column="0" />
        <mark key="]" line="52142" column="11" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/allocation/memory/MultiPoolAllocator.h" timestamp="1512128209658">
        <mark key="'" line="183" column="36" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/scripts/lua/job/InstallPackagesJob.lua" timestamp="1512648399878">
        <mark key="'" line="87" column="14" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/internal/platform/ps4/src/plugin/PluginPathPlatform.cpp" timestamp="1502270361957">
        <mark key="'" line="39" column="8" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelayerskeleton/include_files.txt" timestamp="1496226740853">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/lg-ignition/lg/com.amazon.ignition.framework.display/internal/platform/lg/src/sdl/LGPlatformContext.cpp" timestamp="1496160450345">
        <mark key="'" line="23" column="22" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/errors/Errors.cpp" timestamp="1513013587770">
        <mark key="'" line="594" column="22" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/src/avDisplay.cpp" timestamp="1513703088756">
        <mark key="'" line="80" column="22" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/external/include/deviceinfo/bindings/sm/DeviceInfoExtension.h" timestamp="1499792496661">
        <mark key="'" line="60" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/scripts/lua/Manager.lua" timestamp="1512645531443">
        <mark key="'" line="3" column="28" />
      </file>
      <file name="$USER_HOME$/dev/ignite/TextTest/index.embedded.js" timestamp="1518451153727">
        <mark key="'" line="8" column="24" />
        <mark key="[" line="0" column="0" />
        <mark key="]" line="8" column="57" />
        <mark key="." line="6" column="49" />
        <mark key="^" line="6" column="49" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/external/include/ota/package/PayloadMetadata.h" timestamp="1512650413971">
        <mark key="'" line="26" column="29" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/renderer/SceneGraphRenderer.cpp" timestamp="1499884944544">
        <mark key="'" line="1502" column="26" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-panda/com.amazon.ignition.framework.input/internal/platform/panda/src/PlatformRemoteDelegate.cpp" timestamp="1497959632664">
        <mark key="'" line="74" column="27" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.lua/scripts/lua/commandLine/commandLine.lua" timestamp="1512580388109">
        <mark key="'" line="34" column="16" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.javascript/src/sm/SpiderMonkeyEnvironment.cpp" timestamp="1512062086466">
        <mark key="'" line="757" column="23" />
      </file>
      <file name="$USER_HOME$/dev/ig/install/plugins/com.amazon.ignition.app.stark/static/1.4.3/scripts/config.js" timestamp="1513095940431">
        <mark key="'" line="11" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/allocation/memory/allocator/TagAllocator.cpp" timestamp="1512051237594">
        <mark key="'" line="144" column="16" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.app.stark/scripts/fetchIndexJs.js" timestamp="1513098926963">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/utils/RendererInputEventDelegate.cpp" timestamp="1517579591544">
        <mark key="'" line="298" column="24" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.lua/CMakeLists.txt" timestamp="1502115878109">
        <mark key="'" line="30" column="45" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/allocation/memory/Memory.cpp" timestamp="1512051335104">
        <mark key="'" line="63" column="29" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/backend/gles2/cmakescripts/build.cmake" timestamp="1497605980688">
        <mark key="'" line="203" column="12" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/internal/src/deviceinfo/properties/AbstractDeviceProperties.cpp" timestamp="1511782746358">
        <mark key="'" line="45" column="32" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/allocation/memory/allocator/MallocAllocator.cpp" timestamp="1513076227168">
        <mark key="'" line="76" column="18" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.javascript/tests/CMakeLists.txt" timestamp="1499182336068">
        <mark key="'" line="331" column="0" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.scene/include/IScene.h" timestamp="1501062696746">
        <mark key="'" line="42" column="26" />
      </file>
      <file name="$USER_HOME$/dev/ci/common/deliveries.cmake" timestamp="1499161998475">
        <mark key="'" line="61" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/lg-ignition/lg/com.amazon.ignition.framework.network/internal/platform/lg/src/PlatformUtils.cpp" timestamp="1495799385313">
        <mark key="'" line="72" column="35" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.app.stark/scripts/connectivityErrorMessage.js" timestamp="1513091126818">
        <mark key="'" line="144" column="21" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.font/include/font/utils/ParseState.h" timestamp="1502981865728">
        <mark key="'" line="12" column="19" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicerpi/implementation/rpi/internal/src/EGLUtils.cpp" timestamp="1510240826359">
        <mark key="'" line="117" column="41" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.deviceinfo/CMakeLists.txt" timestamp="1499358682223">
        <mark key="'" line="37" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/plugin/PluginManifest.cpp" timestamp="1497611971145">
        <mark key="'" line="439" column="16" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/allocation/memory/ScopedAllocator.cpp" timestamp="1512051583416">
        <mark key="'" line="14" column="25" />
      </file>
      <file name="$USER_HOME$/dev/portingkitreleasetools/tools/release/export_clean/src/ignition/filesystem/cleaner/ArgumentParser.py" timestamp="1495201457105">
        <mark key="'" line="28" column="7" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelayerskeleton/tests/test_files.txt" timestamp="1496226749285">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ci/JSONParser.cmake" timestamp="1499159771026">
        <mark key="'" line="113" column="33" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.player/CMakeListsThirdparty.txt" timestamp="1512052574743">
        <mark key="'" line="194" column="8" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/script_engine.h" timestamp="1517312477085">
        <mark key="[" line="88" column="0" />
        <mark key="]" line="89" column="31" />
        <mark key="." line="89" column="31" />
        <mark key="^" line="89" column="31" />
      </file>
      <file name="$USER_HOME$/dev/ig/lg-ignition/lg/com.amazon.ignition.framework.core/internal/platform/lg/src/luna/SystemSettingUtils.cpp" timestamp="1495733524774">
        <mark key="'" line="105" column="5" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelayerskeleton/tests/DisplayTests.cpp" timestamp="1496410086413">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/thirdparty/curl/src/tool_paramhlp.c" timestamp="1515160595642">
        <mark key="[" line="404" column="0" />
        <mark key="]" line="404" column="0" />
        <mark key="." line="404" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/include/api/RenderStateManager.h" timestamp="1499949585650">
        <mark key="'" line="68" column="19" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/allocation/memory/PoolAllocator.cpp" timestamp="1512128150110">
        <mark key="'" line="88" column="30" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicerpi/tests/SecureStorageBackendTest.cpp" timestamp="1512136033775">
        <mark key="'" line="35" column="36" />
      </file>
      <file name="$USER_HOME$/dev/ig/lg-ignition/lg/com.amazon.ignition.framework.storage/internal/platform/lg/src/backends/SecureStorageBackend.cpp" timestamp="1511539450142">
        <mark key="'" line="35" column="50" />
      </file>
      <file name="/usr/include/c++/4.9/unordered_set" timestamp="1494596511559">
        <mark key="'" line="55" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/internal/src/deviceinfo/properties/DevicePropertiesDelegate.cpp" timestamp="1502462593025">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/lua_engine.h" timestamp="1517251816836">
        <mark key="[" line="23" column="0" />
        <mark key="]" line="23" column="5" />
        <mark key="." line="23" column="5" />
        <mark key="^" line="23" column="5" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.input/include/util/AVPKTestInputEmitter.h" timestamp="1511188853888">
        <mark key="'" line="19" column="9" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/plugin/PluginPath.h" timestamp="1513185226469">
        <mark key="'" line="53" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/thirdparty/curl/lib/mime.c" timestamp="1515084197902">
        <mark key="[" line="46" column="0" />
        <mark key="]" line="46" column="0" />
        <mark key="." line="46" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.player/internal/src/videoPlayer/PlayerPlatformFactory.cpp" timestamp="1512053004470">
        <mark key="'" line="12" column="22" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/cmakescripts/create-monolith.cmake" timestamp="1494411486915">
        <mark key="'" line="117" column="10" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/plugin/LifecycleState.h" timestamp="1497625434427">
        <mark key="'" line="107" column="15" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/include/utils/RendererObjectScope.h" timestamp="1494604594673">
        <mark key="'" line="20" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ignite/tests/CMakeLists.txt" timestamp="1516878138149">
        <mark key="'" line="87" column="60" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.devicelayerloader/CMakeLists.txt" timestamp="1510927834413">
        <mark key="'" line="100" column="55" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/plugin/path/TemplatedPluginPathBuilder.h" timestamp="1496317518515">
        <mark key="'" line="28" column="52" />
      </file>
      <file name="$USER_HOME$/local/depo/src/depo/versioning/IgnitionVersioningStrategy.py" timestamp="1495208794282">
        <mark key="'" line="12" column="37" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.scene/src/scene/image/ScopedImageHandle.cpp" timestamp="1512057624240">
        <mark key="'" line="152" column="20" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/com.amazon.ignition.framework.player/internal/platform/android/src/player/AndroidPlayerPlatform.cpp" timestamp="1502118068355">
        <mark key="'" line="48" column="13" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/thirdparty/curl/lib/strtoofft.h" timestamp="1515160503282">
        <mark key="[" line="43" column="0" />
        <mark key="]" line="43" column="0" />
        <mark key="." line="43" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/thirdparty/curl/lib/strtoofft.c" timestamp="1515160454874">
        <mark key="[" line="36" column="0" />
        <mark key="]" line="36" column="0" />
        <mark key="." line="36" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/interface/include/device/av_display.h" timestamp="1498747160839">
        <mark key="'" line="101" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/include/PluginRenderer.h" timestamp="1512643284812">
        <mark key="'" line="202" column="19" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/com.amazon.ignition.framework.deviceinfo/internal/platform/android/src/deviceinfo/properties/AndroidDeviceProperties.cpp" timestamp="1499793478666">
        <mark key="'" line="112" column="23" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/backend/gles2/include/api/GLES2FrameBufferObject.h" timestamp="1494603590831">
        <mark key="'" line="23" column="4" />
      </file>
      <file name="$USER_HOME$/dev/igbuildlg/lg/debug/amazonite/lg/platform/device-properties/implementation/devicepropertiesprovider/include/PlatformDevicePropertiesProvider.h" timestamp="1501251767245">
        <mark key="'" line="422" column="26" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/function_binders.h" timestamp="1518175970090">
        <mark key="'" line="369" column="25" />
        <mark key="]" line="278" column="2" />
        <mark key="^" line="278" column="2" />
        <mark key="." line="278" column="2" />
      </file>
      <file name="$USER_HOME$/dev/igbuild/linux/debug/graph/cmake.ignition" timestamp="1494411013130">
        <mark key="'" line="468" column="5" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/utils/bits/FileSystemFlipBit.cpp" timestamp="1513357162855">
        <mark key="[" line="58" column="49" />
        <mark key="]" line="58" column="50" />
        <mark key="." line="58" column="50" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/src/backends/DeviceSecureStorageBackend.cpp" timestamp="1512134972837">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.player/internal/src/videoPlayer/player/amp/PlayerPlatform.cpp" timestamp="1502118148994">
        <mark key="'" line="337" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/tests/plugin/DependencyGraphTest.cpp" timestamp="1497612014990">
        <mark key="'" line="31" column="28" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.scene/tests/scene/utils/nodepropertyappliers/EffectUtilsTest.cpp" timestamp="1513942352695">
        <mark key="'" line="20" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ignite/docs/CHANGES" timestamp="1516384514095">
        <mark key="'" line="163" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.app.stark/scripts/stateManager.js" timestamp="1513098959370">
        <mark key="'" line="10" column="8" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/script_engine_config.h" timestamp="1517246543115">
        <mark key="'" line="35" column="15" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/Render.h" timestamp="1510243481406">
        <mark key="'" line="78" column="21" />
      </file>
      <file name="$USER_HOME$/dev/ci/commitment/common-commit-message.cmake" timestamp="1499162305205">
        <mark key="'" line="13" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/event/EventService.cpp" timestamp="1497440331129">
        <mark key="'" line="80" column="17" />
      </file>
      <file name="$USER_HOME$/dev/igbuildlg/lg/debug/amazonite/lg/platform/device-properties/implementation/devicepropertiesprovider/src/PlatformDevicePropertiesProvider.cpp" timestamp="1501251764629">
        <mark key="'" line="147" column="27" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/interface/include/device/av_secure_storage_backend.h" timestamp="1495626110265">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.display/internal/src/PluginDisplay.cpp" timestamp="1512655881927">
        <mark key="'" line="222" column="26" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/platform/sx6/cmakescripts/build.cmake" timestamp="1498065986571">
        <mark key="'" line="4" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/backend/gles2/include/display/GLES2DisplayContext.h" timestamp="1499791779460">
        <mark key="'" line="18" column="35" />
      </file>
      <file name="$USER_HOME$/dev/ignite/docs/adr/0001-record-architecture-decisions.md" timestamp="1516988219554">
        <mark key="[" line="34" column="51" />
        <mark key="]" line="34" column="51" />
        <mark key="." line="34" column="51" />
        <mark key="^" line="34" column="51" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-panda/com.amazon.ignition.framework.storage/internal/platform/panda/src/backends/SecureStorageBackend.cpp" timestamp="1511539370038">
        <mark key="'" line="55" column="47" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/index.embedded.js" timestamp="1518191221038">
        <mark key="[" line="0" column="50" />
        <mark key="]" line="1" column="34" />
        <mark key="." line="1" column="34" />
        <mark key="^" line="1" column="34" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/backend/gles2/src/api/GLES2RendererPlatformStats.cpp" timestamp="1504699313200">
        <mark key="'" line="245" column="50" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.deviceinfo/thirdparty/devicepropertiesprovider/device-properties/adaptor/devicepropertiesprovider/src/DevicePropertiesProviderAdapter.cpp" timestamp="1501251632397">
        <mark key="'" line="23" column="34" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.font/src/font/utils/ParagraphDefinition.cpp" timestamp="1512048385466">
        <mark key="'" line="325" column="16" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/external/include/websockets/WebSocketDelegate.h" timestamp="1517569908310">
        <mark key="'" line="53" column="9" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/include/ota/bindings/lua/ffi/PackageInstallerFactoryLuaBinding.h" timestamp="1512648444375">
        <mark key="'" line="26" column="41" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/event/events/LifecycleEvent.h" timestamp="1497629640221">
        <mark key="'" line="38" column="28" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/external/include/ota/package/PackageInstaller.h" timestamp="1512648473582">
        <mark key="'" line="80" column="14" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.player/internal/platform/ps3/src/player/PlayerPlatform.cpp" timestamp="1512053222820">
        <mark key="'" line="78" column="46" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/internal/src/http/client/CurlHttpClient.cpp" timestamp="1513094718385">
        <mark key="'" line="101" column="4" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.display/internal/platform/linux/src/sdl/SDLPlatformContext.cpp" timestamp="1499197545605">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.display/internal/include/display/DevicePlatformContext.h" timestamp="1499194857354">
        <mark key="'" line="67" column="19" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.core/tools/MonolithDependencyGenerator.py" timestamp="1503663233092">
        <mark key="'" line="152" column="17" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.app.stark/scripts/start.js" timestamp="1513089852592">
        <mark key="'" line="24" column="65" />
      </file>
      <file name="$USER_HOME$/dev/ignite/libs/lua/src/lua.h" timestamp="1510243400045">
        <mark key="'" line="340" column="28" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.javascript/include/sm/SpiderMonkeyEnvironment.h" timestamp="1512062168120">
        <mark key="'" line="68" column="23" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/porting/linux/SDLWrapper.cpp" timestamp="1516712984626">
        <mark key="'" line="39" column="30" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.lua/tests/ffi/LuaFFILibWrapperTest.cpp" timestamp="1493402549290">
        <mark key="'" line="49" column="6" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.display/internal/include/display/DisplayDeviceLayerData.h" timestamp="1501077212563">
        <mark key="'" line="18" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicerpi/implementation/rpi/internal/src/EGLDisplayContext.cpp" timestamp="1498746905348">
        <mark key="'" line="75" column="24" />
      </file>
      <file name="$USER_HOME$/dev/portingkitreleasetools/tools/release/export_clean/src/filesystem/cleaner/SanityChecklistChecker.py" timestamp="1495201580315">
        <mark key="'" line="111" column="20" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/internal/platform/ps3/include/allocation/HeapAllocatorMatHeapDecorator.h" timestamp="1512127576896">
        <mark key="'" line="41" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/utils/SplashScreenManager.cpp" timestamp="1515080962636">
        <mark key="'" line="38" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/allocation/memory/allocator/TagAllocator.h" timestamp="1512051435682">
        <mark key="'" line="40" column="12" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.renderer/internal/backend/gles2/src/api/GLES2RendererPlatformStats.cpp" timestamp="1499434875157">
        <mark key="'" line="241" column="8" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/interface/include/device/av_text_to_speech.h" timestamp="1496226602485">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/igbuildlg/lg/release/amazonite/lg/platform/device-properties/CMakeLists.txt" timestamp="1499345611968">
        <mark key="'" line="12" column="29" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.javascript/thirdparty/spidermonkey/mozjs-45.0.2/dist/include/js/Value.h" timestamp="1494414600151">
        <mark key="'" line="1195" column="31" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.player/internal/platform/ps3/src/player/AmpConfig.cpp" timestamp="1512050308198">
        <mark key="'" line="57" column="30" />
      </file>
      <file name="$USER_HOME$/dev/ignite/TextTest/App.js" timestamp="1518450834477">
        <mark key="'" line="1" column="9" />
        <mark key="[" line="12" column="0" />
        <mark key="]" line="12" column="0" />
        <mark key="." line="12" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ci/prepare-source/common.cmake" timestamp="1499159670257">
        <mark key="'" line="10" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.input/include/events/KeyInputEvent.h" timestamp="1517578327661">
        <mark key="'" line="51" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelg/implementation/lg/internal/src/SDLInputContext.cpp" timestamp="1502462612770">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/thirdparty/curl/configure.ac" timestamp="1515159267387">
        <mark key="[" line="186" column="0" />
        <mark key="]" line="188" column="0" />
        <mark key="." line="186" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/device/tests/SecureStorageBackendTest.cpp" timestamp="1512135431758">
        <mark key="'" line="112" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.player/CMakeLists.txt" timestamp="1512052442645">
        <mark key="'" line="124" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelayerskeleton/tests/CMakeLists.txt" timestamp="1496410095493">
        <mark key="'" line="44" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.scene/src/scene/nodes/SceneNode.cpp" timestamp="1506332108199">
        <mark key="'" line="98" column="0" />
      </file>
      <file name="$USER_HOME$/local/depo/src/depo.py" timestamp="1494950515264">
        <mark key="'" line="16" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicerpi/interface/include/device/av_secure_storage_migration_from_v0.h" timestamp="1512558550224">
        <mark key="'" line="52" column="33" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/internal/src/LegacySecureStorage.cpp" timestamp="1512136101912">
        <mark key="'" line="41" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/UIManager.js" timestamp="1518443083563">
        <mark key="'" line="81" column="34" />
        <mark key="[" line="54" column="126" />
        <mark key="]" line="54" column="127" />
        <mark key="." line="54" column="127" />
        <mark key="^" line="54" column="127" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/tests/test_files.txt" timestamp="1493982510659">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/external/include/http/data/FileHttpResponseConsumer.h" timestamp="1513092083134">
        <mark key="'" line="26" column="43" />
      </file>
      <file name="$USER_HOME$/dev/ignite/cmake-build-debug/CMakeCache.txt" timestamp="1516384689680">
        <mark key="'" line="34" column="37" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.scene/src/scene/nodes/ImageNode.cpp" timestamp="1512057602500">
        <mark key="'" line="251" column="12" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/allocation/MemoryPool.cpp" timestamp="1512051363804">
        <mark key="'" line="104" column="23" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.report/internal/src/report/listeners/LogListener.cpp" timestamp="1497549186902">
        <mark key="'" line="315" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.scene/src/scene/image/ImageRegistry.cpp" timestamp="1512058127120">
        <mark key="'" line="411" column="20" />
      </file>
      <file name="$USER_HOME$/dev/igrpi/com.amazon.ignition.framework.core/internal/platform/ps4/src/SystemInit.cpp" timestamp="1503482736546">
        <mark key="'" line="261" column="32" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/thirdparty/SDL2/cmake/sdlchecks.cmake" timestamp="1497022769343">
        <mark key="'" line="338" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.scene/include/scene/image/ScopedImageHandle.h" timestamp="1512057608452">
        <mark key="'" line="23" column="27" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/thirdparty/devicepropertiescomponent/amazonite/common/platform/posix-gnuc/include/amazonite/PodTypes.h" timestamp="1501253604431">
        <mark key="'" line="18" column="17" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/renderer/RendererNodeGenerator.cpp" timestamp="1509106820745">
        <mark key="'" line="37" column="36" />
      </file>
      <file name="$USER_HOME$/dev/portingkitreleasetools/tools/release/export_clean/src/ignition_export_clean.py" timestamp="1495201490578">
        <mark key="'" line="39" column="22" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/tick/TickGenerator.cpp" timestamp="1510939743273">
        <mark key="'" line="44" column="48" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelayerskeleton/CMakeLists.txt" timestamp="1496226746053">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/errors/ICrashDataCollector.h" timestamp="1513013741523">
        <mark key="'" line="24" column="29" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.scene/src/scene/utils/SceneUpdateThread.cpp" timestamp="1497959164402">
        <mark key="'" line="74" column="44" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/main.cpp" timestamp="1516101668943">
        <mark key="'" line="44" column="29" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/Ignition.cpp" timestamp="1511443510827">
        <mark key="'" line="550" column="18" />
      </file>
      <file name="$USER_HOME$/dev/igrpi/devicerpi/implementation/rpi/internal/include/DisplayContext.h" timestamp="1498671472605">
        <mark key="'" line="31" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/plugin/version/VersionTable.cpp" timestamp="1513357288954">
        <mark key="'" line="118" column="35" />
      </file>
      <file name="$USER_HOME$/local/depo/tests/depo/git/test_GitRepo.py" timestamp="1495212903973">
        <mark key="'" line="40" column="34" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/Logger.h" timestamp="1516712337536">
        <mark key="'" line="13" column="33" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/thirdparty/curl/lib/config-linux.h" timestamp="1515152145927">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/internal/src/SecureStorageBackendContext.cpp" timestamp="1511545303051">
        <mark key="'" line="53" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.input/src/delegates/DeviceDelegate.cpp" timestamp="1505134653579">
        <mark key="'" line="210" column="50" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/external/include/bindings/sm/HttpRequestFactoryExtension.h" timestamp="1513091636562">
        <mark key="'" line="22" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/ignition-android/ignition/src/main/java/com/amazon/ignition/IgnitionActivity.java" timestamp="1502117309213">
        <mark key="'" line="57" column="47" />
      </file>
      <file name="$USER_HOME$/dev/igrpi/devicerpi/tests/SecureStorageBackendTest.cpp" timestamp="1498669631906">
        <mark key="'" line="15" column="38" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/internal/include/deviceinfo/PluginDeviceInfo.h" timestamp="1502285646175">
        <mark key="'" line="27" column="29" />
      </file>
      <file name="$USER_HOME$/dev/ignite/portingplatforms/linux/cmake/platform-config.cmake" timestamp="1509725255386">
        <mark key="'" line="4" column="7" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.display/cmakescripts/build/platformcontext.cmake" timestamp="1495460067621">
        <mark key="'" line="5" column="77" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.javascript/include/sm/IBindable.h" timestamp="1497355949826">
        <mark key="'" line="19" column="29" />
      </file>
      <file name="$USER_HOME$/dev/ignite/TextTest/dist/TextTest.js" timestamp="1518439800046">
        <mark key="'" line="52457" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/NativeModuleProxy.js" timestamp="1518176730435">
        <mark key="'" line="4" column="4" />
        <mark key="[" line="30" column="2" />
        <mark key="]" line="31" column="44" />
        <mark key="^" line="31" column="44" />
        <mark key="." line="31" column="44" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/internal/src/deviceinfo/bindings/sm/DeviceInfoExtension.cpp" timestamp="1499792491045">
        <mark key="'" line="24" column="16" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.renderer/internal/src/renderer/OffScreenSceneGraphManager.cpp" timestamp="1501062737210">
        <mark key="'" line="90" column="48" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.scene/include/scene/nodes/ImageNode.h" timestamp="1512057588261">
        <mark key="'" line="117" column="21" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.javascript/tests/CMakeLists.txt" timestamp="1494499436457">
        <mark key="'" line="338" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.display/internal/platform/ps4/src/egl/PS4PlatformContext.cpp" timestamp="1511525779989">
        <mark key="'" line="41" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/thirdparty/fruit/configuration/CMakeLists.txt" timestamp="1494597569682">
        <mark key="'" line="48" column="15" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/utils/RendererObjectScope.cpp" timestamp="1494604082073">
        <mark key="'" line="19" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/internal/src/http/cache/CacheServiceHttpCacheProvider.cpp" timestamp="1512050768326">
        <mark key="'" line="34" column="34" />
      </file>
      <file name="$USER_HOME$/dev/ci/doxygen/doxygen.cmake" timestamp="1499162535044">
        <mark key="'" line="142" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.javascript/include/sm/SpiderMonkeyDefs.h" timestamp="1512061939430">
        <mark key="'" line="26" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.javascript/src/sm/extensions/LifecycleExtension.cpp" timestamp="1497549195366">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/platform/ps3/include/display/PS3DisplayContext.h" timestamp="1499792801704">
        <mark key="'" line="56" column="11" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.input/include/InputDefs.h" timestamp="1497958544165">
        <mark key="'" line="109" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.input/src/util/KeyRepeatManager.cpp" timestamp="1498496788587">
        <mark key="'" line="154" column="23" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.devicelayerloader/device-layer-skeleton/interface/include/device/av_input_defs.h" timestamp="1505123660945">
        <mark key="'" line="171" column="0" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.texttospeech/CMakeLists.txt" timestamp="1499699339852">
        <mark key="'" line="97" column="16" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.core/src/plugin/LifecycleEventManager.cpp" timestamp="1501162978602">
        <mark key="'" line="16" column="52" />
      </file>
      <file name="$USER_HOME$/local/depo/src/depo/dependencies/OverridesParser.py" timestamp="1495212547243">
        <mark key="'" line="123" column="32" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/ignite/init.js" timestamp="1518197950295">
        <mark key="'" line="0" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/internal/include/deviceinfo/identity/GeneratedSerialNumberProvider.h" timestamp="1502284831781">
        <mark key="'" line="15" column="15" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.focus.logic/scripts/lua/FocusCalculator.lua" timestamp="1512580325464">
        <mark key="'" line="398" column="24" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/thirdparty/SDL2/cmake/macros.cmake" timestamp="1497022728583">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/duktape_engine.cpp" timestamp="1517248319307">
        <mark key="'" line="71" column="27" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/tests/InputTests.cpp" timestamp="1498747324924">
        <mark key="'" line="94" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ignite/libs/di/include/boost/di.hpp" timestamp="1517322639932">
        <mark key="'" line="1644" column="21" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/megablast_roku.h" timestamp="1517246784300">
        <mark key="'" line="161" column="19" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/thirdparty/devicepropertiescomponent/amazonite/device-properties/src/DevicePropertiesProvider.cpp" timestamp="1501253193383">
        <mark key="'" line="28" column="19" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.lua/src/LuaState.cpp" timestamp="1512644974382">
        <mark key="'" line="192" column="22" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/lua_engine.cpp" timestamp="1517253154001">
        <mark key="'" line="2" column="1" />
        <mark key="[" line="75" column="2" />
        <mark key="]" line="75" column="22" />
        <mark key="^" line="75" column="22" />
        <mark key="." line="75" column="22" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/script_engine.cpp" timestamp="1517247283469">
        <mark key="'" line="82" column="42" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/plugin/PluginVersionManager.cpp" timestamp="1513357231106">
        <mark key="'" line="93" column="21" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/allocation/memory/PoolAllocator.h" timestamp="1512128051021">
        <mark key="'" line="22" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.report/internal/src/report/dispatchers/formatters/DeviceEventFormatter.cpp" timestamp="1497548776245">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/utils/CommandLine.h" timestamp="1511353775443">
        <mark key="'" line="27" column="10" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/utils/StringUtils.h" timestamp="1495104516966">
        <mark key="'" line="19" column="37" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.player/internal/platform/ps3/include/player/MemoryPoolConfiguration.h" timestamp="1512051811317">
        <mark key="'" line="34" column="34" />
      </file>
      <file name="/usr/include/c++/4.9/ext/atomicity.h" timestamp="1510856196303">
        <mark key="'" line="52" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/com.amazon.ignition.framework.texttospeech/internal/platform/android/src/ignition/texttospeech/engine/TextToSpeechEngine.cpp" timestamp="1493736403808">
        <mark key="'" line="184" column="11" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/ignition-android/ignition/src/main/java/com/amazon/ignition/IgnitionApplication.java" timestamp="1502117835437">
        <mark key="'" line="57" column="16" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/thirdparty/fruit/include/fruit/impl/util/hash_helpers.h" timestamp="1494596531672">
        <mark key="'" line="26" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/ignite/ReactNativeIgnite.js" timestamp="1518445170172">
        <mark key="'" line="54" column="3" />
        <mark key="[" line="123" column="0" />
        <mark key="]" line="123" column="0" />
        <mark key="." line="123" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/Render.cpp" timestamp="1510244136755">
        <mark key="'" line="46" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.player/thirdparty/kubrick/amp-ps4/apps/AIV/VideoCore/VideoCore.vcxproj" timestamp="1512052391547">
        <mark key="'" line="124" column="3" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.cache/include/cache/MultiLevelCache.h" timestamp="1512659853922">
        <mark key="'" line="37" column="11" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/src/ota/manager/ManagerState.cpp" timestamp="1512645504360">
        <mark key="'" line="54" column="50" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/internal/src/deviceinfo/identity/DefaultDeviceTypeProvider.cpp" timestamp="1511261913681">
        <mark key="'" line="68" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/display/DisplayContext.cpp" timestamp="1499792685709">
        <mark key="'" line="36" column="16" />
      </file>
      <file name="$USER_HOME$/dev/igrpi/devicerpi/implementation/rpi/internal/src/DisplayContext.cpp" timestamp="1498671449324">
        <mark key="'" line="44" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.font/include/font/GlyphAtlas.h" timestamp="1512048391450">
        <mark key="'" line="57" column="26" />
      </file>
      <file name="$USER_HOME$/dev/ci/ci.cmake" timestamp="1499162534335">
        <mark key="'" line="87" column="129" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.app.stark/scripts/requestManager.js" timestamp="1513096014959">
        <mark key="'" line="67" column="29" />
      </file>
      <file name="$USER_HOME$/dev/ig/lg-ignition/lg/com.amazon.ignition.framework.core/internal/platform/lg/src/luna/NativeAppHandler.cpp" timestamp="1512487632864">
        <mark key="'" line="107" column="23" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelg/implementation/lg/internal/src/SDLDisplayContext.cpp" timestamp="1512484185558">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/local/depo/src/depo/dependencies/Revision.py" timestamp="1495208819203">
        <mark key="'" line="41" column="39" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/thirdparty/gmock/gtest/include/gtest/gtest.h" timestamp="1513074096227">
        <mark key="'" line="1423" column="17" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.texttospeech/external/src/ignition/texttospeech/PluginTextToSpeech.cpp" timestamp="1512657178881">
        <mark key="'" line="111" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/internal/src/websockets/WebSocketDelegate.cpp" timestamp="1517936598697">
        <mark key="'" line="462" column="48" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/backend/gles2/src/api/GLES2Api.cpp" timestamp="1507112793361">
        <mark key="'" line="28" column="7" />
      </file>
      <file name="$USER_HOME$/dev/ig/samsung-ignition/com.amazon.ignition.framework.renderer/internal/platform/samsungtv/cmakescripts/build.cmake" timestamp="1498066000388">
        <mark key="'" line="4" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/internal/src/deviceinfo/services/DefaultPlatformServicesProvider.cpp" timestamp="1493904393781">
        <mark key="'" line="12" column="13" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/internal/src/deviceinfo/identity/DeviceIdentity.cpp" timestamp="1502285644800">
        <mark key="'" line="53" column="50" />
      </file>
      <file name="$USER_HOME$/dev/ig/lg-ignition/lg/com.amazon.ignition.framework.input/internal/platform/lg/src/LGRemoteDelegate.cpp" timestamp="1498149242223">
        <mark key="'" line="88" column="26" />
      </file>
      <file name="$USER_HOME$/local/depo/src/depo/git/GitRepo.py" timestamp="1495212637659">
        <mark key="'" line="32" column="17" />
      </file>
      <file name="$USER_HOME$/dev/igrpi/com.amazon.ignition.framework.player/internal/src/videoPlayer/player/amp/PlayerPlatform.cpp" timestamp="1503658648398">
        <mark key="'" line="148" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/filesystem/FileSystemUtils.cpp" timestamp="1511539486969">
        <mark key="'" line="242" column="30" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/com.amazon.ignition.framework.core/internal/platform/android/src/utils/SDLJavaEnvironment.cpp" timestamp="1502117252521">
        <mark key="'" line="40" column="32" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/cmakescripts/create-test-symlink-for-plugin.cmake" timestamp="1506957424045">
        <mark key="'" line="12" column="53" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.animation/tests/CMakeLists.txt" timestamp="1493748473755">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/igrpi/devicerpi/include_files.txt" timestamp="1498670874660">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/main.cpp" timestamp="1517312974718">
        <mark key="'" line="12" column="46" />
        <mark key="[" line="14" column="34" />
        <mark key="]" line="14" column="41" />
        <mark key="^" line="14" column="41" />
        <mark key="." line="14" column="41" />
      </file>
      <file name="$USER_HOME$/dev/ignite/CMakeLists.txt" timestamp="1516972970315">
        <mark key="'" line="17" column="0" />
        <mark key="[" line="16" column="26" />
        <mark key="]" line="16" column="26" />
        <mark key="^" line="16" column="4" />
        <mark key="." line="16" column="26" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/CMakeLists.txt" timestamp="1512134572708">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/plugin/path/PluginPathResolver.cpp" timestamp="1513090795872">
        <mark key="'" line="37" column="21" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/thirdparty/curl/lib/warnless.c" timestamp="1515152749263">
        <mark key="'" line="30" column="3" />
      </file>
      <file name="$USER_HOME$/dev/iglg/devicelg/implementation/lg/internal/include/SDLDisplayContext.h" timestamp="1499197846806">
        <mark key="'" line="39" column="9" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/external/include/http/HttpRequest.h" timestamp="1513094402536">
        <mark key="'" line="74" column="39" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.app.stark/scripts/networkUtils.js" timestamp="1513096069172">
        <mark key="'" line="92" column="28" />
      </file>
      <file name="$USER_HOME$/dev/ignite/.gitignore" timestamp="1516988082103">
        <mark key="[" line="4" column="0" />
        <mark key="]" line="4" column="0" />
        <mark key="." line="4" column="0" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.display/device/include/device/av_display.h" timestamp="1499170753214">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/scripts/lua/job/FetchPackagesJob.lua" timestamp="1512648287586">
        <mark key="'" line="129" column="9" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/manifest.ps4" timestamp="1515147096104">
        <mark key="[" line="21" column="50" />
        <mark key="]" line="21" column="29" />
        <mark key="." line="21" column="51" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/internal/src/http/factory/HttpResponseConsumerFactory.cpp" timestamp="1513092050014">
        <mark key="'" line="39" column="38" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/manifest.ps3" timestamp="1515147093916">
        <mark key="[" line="21" column="50" />
        <mark key="]" line="21" column="29" />
        <mark key="." line="21" column="51" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/utils/Profiler.h" timestamp="1498128654550">
        <mark key="'" line="16" column="7" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.app.stark/scripts/fetchFile.js" timestamp="1513095966869">
        <mark key="'" line="224" column="13" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.animation/include/Animation.h" timestamp="1497535727392">
        <mark key="'" line="29" column="44" />
      </file>
      <file name="/usr/include/c++/4.9/array" timestamp="1513013896579">
        <mark key="'" line="276" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTestRunner.js" timestamp="1518451476696">
        <mark key="[" line="20" column="16" />
        <mark key="]" line="20" column="20" />
        <mark key="^" line="20" column="20" />
        <mark key="." line="20" column="20" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/porting/linux/linux.cpp" timestamp="1516713321084">
        <mark key="'" line="0" column="13" />
      </file>
      <file name="$USER_HOME$/dev/ci/git.cmake" timestamp="1499162312837">
        <mark key="'" line="41" column="9" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.cache/include/cache/ICache.h" timestamp="1494001306551">
        <mark key="'" line="15" column="38" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/renderer/Renderer.cpp" timestamp="1499789643859">
        <mark key="'" line="74" column="8" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/include/StorageBackend.h" timestamp="1511355305672">
        <mark key="'" line="17" column="7" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.scene/include/scene/image/ImageRegistry.h" timestamp="1512057846117">
        <mark key="'" line="100" column="41" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/internal/platform/linux/src/filesystem/LinuxFileSystemFacade.cpp" timestamp="1511279928111">
        <mark key="'" line="260" column="11" />
      </file>
      <file name="$USER_HOME$/dev/ignite/ATVLunarCore/src/js/init.js" timestamp="1518187835446">
        <mark key="." line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/internal/platform/ps3/cmakescripts/CMakeMacros.cmake" timestamp="1512054133191">
        <mark key="'" line="188" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/scripts/lua/workspace/WorkspaceProvisioner.lua" timestamp="1512645602311">
        <mark key="'" line="7" column="40" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/plugin/path/TemplatedPluginPathBuilder.cpp" timestamp="1512036495427">
        <mark key="'" line="88" column="45" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/src/Storage.cpp" timestamp="1512134926503">
        <mark key="'" line="92" column="17" />
      </file>
      <file name="$USER_HOME$/dev/ci/commitment/commitment.cmake" timestamp="1499162490404">
        <mark key="'" line="92" column="16" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.cache/src/cache/cacheable/CacheableBuffer.cpp" timestamp="1493896695260">
        <mark key="'" line="183" column="47" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/scripts/lua/availability/s4nd/S4NDCandidateRetriever.lua" timestamp="1512647905373">
        <mark key="'" line="73" column="63" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/thirdparty/gmock/gtest/include/gtest/gtest_pred_impl.h" timestamp="1513073878994">
        <mark key="'" line="146" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/resource/texture/TextureLoader.cpp" timestamp="1515081267119">
        <mark key="'" line="427" column="56" />
      </file>
      <file name="$USER_HOME$/dev/ignite/docs/adr/README.md" timestamp="1516988850503">
        <mark key="'" line="47" column="51" />
        <mark key="[" line="13" column="3" />
        <mark key="]" line="13" column="6" />
        <mark key="." line="13" column="6" />
        <mark key="^" line="13" column="6" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.deviceinfo/external/include/deviceinfo/properties/AbstractDeviceProperties.h" timestamp="1511782748251">
        <mark key="'" line="50" column="17" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/allocation/memory/IHeapAllocator.h" timestamp="1513076232815">
        <mark key="'" line="25" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/backend/gles2/src/display/GLES2DisplayContext.cpp" timestamp="1499792664973">
        <mark key="'" line="61" column="27" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/event/EventService.h" timestamp="1497440237449">
        <mark key="'" line="138" column="19" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/platform/thread/posix/Thread.cpp" timestamp="1512048119275">
        <mark key="'" line="499" column="49" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/tests/Library.cpp" timestamp="1497021800229">
        <mark key="'" line="19" column="11" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/lua_function_binders.h" timestamp="1516712816265">
        <mark key="'" line="400" column="83" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/perfmetrics/PerformanceMetricsUtil.h" timestamp="1515073285067">
        <mark key="'" line="3" column="16" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/include/backends/SecureStorageBackendMigrator.h" timestamp="1512134999238">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/internal/platform/linux/include/curl/curlbuild.h" timestamp="1515152409598">
        <mark key="'" line="60" column="7" />
      </file>
      <file name="$USER_HOME$/dev/ig/install/plugins/com.amazon.ignition.app.stark/var/web-cache/init.js" timestamp="1503074081198">
        <mark key="'" line="41" column="28823" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTestRunner.js" timestamp="1518451247096">
        <mark key="[" line="19" column="0" />
        <mark key="]" line="19" column="90" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.deviceinfo/internal/include/deviceinfo/properties/DevicePropertiesDelegate.h" timestamp="1501249979048">
        <mark key="'" line="64" column="51" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/include/ota/PluginOTA.h" timestamp="1513696595678">
        <mark key="'" line="41" column="27" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/tests/CMakeLists.txt" timestamp="1506957313813">
        <mark key="'" line="204" column="17" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.deviceinfo/thirdparty/devicepropertiescomponent/amazonite/device-properties/src/DevicePropertiesProvider.cpp" timestamp="1501251410829">
        <mark key="'" line="28" column="40" />
      </file>
      <file name="$USER_HOME$/dev/ig/tools/generate_plugin.sh" timestamp="1495128940748">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/thirdparty/fruit/CMakeLists.txt" timestamp="1494597605010">
        <mark key="'" line="81" column="17" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.javascript/src/sm/extensions/PluginsExtension.cpp" timestamp="1513090782628">
        <mark key="'" line="108" column="34" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/internal/src/bindings/sm/WebSocketExtension.cpp" timestamp="1516705872182">
        <mark key="'" line="100" column="56" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.devicelayerloader/device-layer-skeleton/tests/TextToSpeechTest.cpp" timestamp="1493736291751">
        <mark key="'" line="99" column="31" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/include/Storage.h" timestamp="1511355303352">
        <mark key="'" line="65" column="36" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-rpi/com.amazon.ignition.framework.core/internal/platform/rpi/src/plugin/PluginPathPlatform.cpp" timestamp="1502271372175">
        <mark key="'" line="140" column="16" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/thirdparty/boost/tools/build/v2/engine/build.sh" timestamp="1496844122638">
        <mark key="'" line="66" column="8" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/renderer/OffScreenSceneGraphManager.cpp" timestamp="1509106753802">
        <mark key="'" line="237" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/internal/platform/ps3/src/CustomMalloc.cpp" timestamp="1512127757301">
        <mark key="'" line="121" column="28" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.font/internal/platform/linux/cmakescripts/build.cmake" timestamp="1497968636514">
        <mark key="'" line="7" column="7" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/src/ota/package/PackageInstaller.cpp" timestamp="1513357226666">
        <mark key="'" line="239" column="29" />
      </file>
      <file name="$USER_HOME$/dev/ignite/cmake/websocket.cmake" timestamp="1516973175762">
        <mark key="'" line="13" column="5" />
        <mark key="[" line="13" column="6" />
        <mark key="]" line="13" column="9" />
        <mark key="." line="13" column="9" />
        <mark key="^" line="13" column="9" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-panda/com.amazon.ignition.framework.deviceinfo/internal/platform/panda/src/deviceinfo/properties/PlatformDeviceProperties.cpp" timestamp="1499793586646">
        <mark key="'" line="109" column="43" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/tests/Library.h" timestamp="1493982516851">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.devicelayerloader/tests/CMakeLists.txt" timestamp="1495030670803">
        <mark key="'" line="48" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/device/include/device/av_secure_storage_backend.h" timestamp="1511265510668">
        <mark key="'" line="42" column="35" />
      </file>
      <file name="$USER_HOME$/dev/igbuildlg/lg/release/amazonite/lg/platform/device-properties/adaptor/devicepropertiesprovider/include/DevicePropertiesProviderAdapter.h" timestamp="1501251298740">
        <mark key="'" line="19" column="31" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.animation/src/Animation.cpp" timestamp="1497535790047">
        <mark key="'" line="145" column="10" />
      </file>
      <file name="$USER_HOME$/dev/igrpi/com.amazon.ignition.framework.core/CMakeLists.txt" timestamp="1503427317563">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/scripts/lua/job/UpdateCheckJob.lua" timestamp="1512648054981">
        <mark key="'" line="61" column="29" />
      </file>
      <file name="$USER_HOME$/dev/igbuildlg/lg/debug/amazonite/lg/platform/device-properties/implementation/devicepropertiesprovider/lg/include/_lgnc_ls_call.h" timestamp="1499769097058">
        <mark key="'" line="145" column="1" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" timestamp="1518451462403">
        <mark key="[" line="0" column="0" />
        <mark key="]" line="52772" column="11" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-panda/com.amazon.ignition.framework.renderer/internal/platform/panda/cmakescripts/build.cmake" timestamp="1498065991635">
        <mark key="'" line="4" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.javascript/PluginJavaScriptConfig.cmake" timestamp="1497535348943">
        <mark key="'" line="149" column="25" />
      </file>
      <file name="$USER_HOME$/dev/hjdocs/broadcom-relation-to-external.puml" timestamp="1517355780565">
        <mark key="'" line="77" column="0" />
        <mark key="[" line="12" column="10" />
        <mark key="]" line="12" column="11" />
        <mark key="." line="12" column="11" />
        <mark key="^" line="11" column="10" />
      </file>
      <file name="/usr/include/c++/4.9/bits/ios_base.h" timestamp="1513092264515">
        <mark key="'" line="364" column="10" />
      </file>
      <file name="$USER_HOME$/dev/ignite/src/megablast_roku.cpp" timestamp="1518182262233">
        <mark key="'" line="1947" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/implementation/linux/internal/include/SecureStorageBackendContext.h" timestamp="1511541912732">
        <mark key="'" line="14" column="10" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.javascript/CMakeLists.txt" timestamp="1502115726659">
        <mark key="'" line="31" column="43" />
      </file>
      <file name="$USER_HOME$/dev/igbuildlg/lg/release/amazonite/lg/platform/device-properties/adaptor/devicepropertiesprovider/src/DevicePropertiesProviderAdapter.cpp" timestamp="1501251293580">
        <mark key="'" line="11" column="0" />
      </file>
      <file name="$USER_HOME$/dev/hjdocs/broadcom-binaries-dependency.puml" timestamp="1517355640043">
        <mark key="'" line="92" column="0" />
        <mark key="[" line="5" column="64" />
        <mark key="]" line="5" column="72" />
        <mark key="." line="5" column="72" />
        <mark key="^" line="5" column="72" />
      </file>
      <file name="$USER_HOME$/dev/ig/ignition-android/com.amazon.ignition.framework.core/internal/platform/android/src/utils/AndroidJniAttachment.cpp" timestamp="1502118320515">
        <mark key="'" line="135" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/internal/platform/ps4/src/SystemInit.cpp" timestamp="1513013583474">
        <mark key="'" line="229" column="37" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/tests/DisplayTests.cpp" timestamp="1502462627009">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/backend/gles2/src/api/GLES2CubeTexture.cpp" timestamp="1494605209507">
        <mark key="'" line="67" column="32" />
      </file>
      <file name="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/src/main.c" timestamp="1518181872216">
        <mark key="'" line="172" column="20" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.texttospeech/internal/platform/ps4/src/ignition/texttospeech/engine/TextToSpeechEngine.cpp" timestamp="1493736340568">
        <mark key="'" line="75" column="9" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.display/internal/include/display/DisplayDeviceLayerData.h" timestamp="1506619965112">
        <mark key="'" line="17" column="45" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.player/manifest.ps3" timestamp="1512052319814">
        <mark key="'" line="21" column="29" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.player/manifest.ps4" timestamp="1512052308638">
        <mark key="'" line="21" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ignite/tools/generate_project.py" timestamp="1509725245499">
        <mark key="'" line="60" column="41" />
      </file>
      <file name="$USER_HOME$/dev/ig/devicelinux/interface/include/device/av_display_defs.h" timestamp="1512487770262">
        <mark key="'" line="43" column="2" />
      </file>
      <file name="$USER_HOME$/dev/ig/lg-ignition/lg/com.amazon.ignition.framework.deviceinfo/internal/platform/lg/src/deviceinfo/properties/LGDevicePropertiesProvider.cpp" timestamp="1499793887623">
        <mark key="'" line="113" column="46" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/errors/CrashDataMap.h" timestamp="1513013323066">
        <mark key="'" line="45" column="16" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/src/ota/package/PayloadMetadata.cpp" timestamp="1512650562951">
        <mark key="'" line="99" column="21" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/api/Texture.cpp" timestamp="1512643582909">
        <mark key="'" line="316" column="8" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.texttospeech/internal/include/ignition/texttospeech/engine/ThreadSafeTextNarrator.h" timestamp="1499699383465">
        <mark key="'" line="59" column="16" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/CMakeLists.txt" timestamp="1499092408811">
        <mark key="'" line="651" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.devicelayerloader/internal/src/devicelayerloader/PluginDummyDeviceLayerLoader.cpp" timestamp="1493718092022">
        <mark key="'" line="32" column="95" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/internal/platform/linux/src/allocation/AllocWrapperFunctions.cpp" timestamp="1513076231352">
        <mark key="'" line="54" column="33" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/cppcompatibility/std/Atomic.h" timestamp="1510833583878">
        <mark key="'" line="12" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/include/ota/manager/ManagerState.h" timestamp="1512645469682">
        <mark key="'" line="39" column="17" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/include/allocation/memory/IHighAllocator.h" timestamp="1512051939753">
        <mark key="'" line="22" column="24" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.ota/internal/src/ota/bindings/lua/ffi/PackageInstallerFactoryLuaBinding.cpp" timestamp="1512648453590">
        <mark key="'" line="15" column="18" />
      </file>
      <file name="/connect.c" timestamp="1515160224417">
        <mark key="'" line="1082" column="24" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/plugin/LifecycleEventManager.cpp" timestamp="1512487548168">
        <mark key="'" line="0" column="0" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.storage/include/backends/DeviceLayerData.h" timestamp="1511960281909">
        <mark key="'" line="38" column="4" />
      </file>
      <file name="$USER_HOME$/dev/ci/VersionsParser.cmake" timestamp="1499159724857">
        <mark key="'" line="4" column="7" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.cache/src/cache/MultiLevelCache.cpp" timestamp="1512644095417">
        <mark key="'" line="59" column="8" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/PluginRenderer.cpp" timestamp="1515080928109">
        <mark key="'" line="819" column="25" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.core/src/allocation/memory/PoolAllocatorAdapter.cpp" timestamp="1512128280038">
        <mark key="'" line="74" column="22" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.display/external/include/IDisplay.h" timestamp="1499248385720">
        <mark key="'" line="30" column="18" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.renderer/internal/src/materials/TexturedMaterial.cpp" timestamp="1515081122892">
        <mark key="'" line="152" column="13" />
      </file>
      <file name="$USER_HOME$/dev/ig/com.amazon.ignition.framework.network/internal/src/crypto/CertConfiguration.cpp" timestamp="1502117561335">
        <mark key="'" line="77" column="12" />
      </file>
      <file name="$USER_HOME$/dev/iglg/com.amazon.ignition.framework.core/cmakescripts/create-monolith.cmake" timestamp="1503663069607">
        <mark key="'" line="82" column="20" />
      </file>
    </filemarks>
    <jumps>
      <jump line="46904" column="34" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTestRunner.js" />
      <jump line="46906" column="21" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTestRunner.js" />
      <jump line="52144" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="47126" column="15" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="47125" column="17" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="47031" column="9" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="46912" column="27" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="46887" column="62" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="46885" column="38" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="46884" column="11" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="46882" column="24" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="46881" column="4" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="46492" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="43791" column="8" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="0" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="43759" column="57" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="43760" column="42" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="46489" column="7" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="46493" column="122" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="47010" column="10" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="1306" column="6" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="466" column="37" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="99" column="3" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="113" column="3" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="88" column="3" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="197" column="4" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/ignite/ReactNativeIgnite.js" />
      <jump line="54" column="3" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/ignite/ReactNativeIgnite.js" />
      <jump line="73" column="18" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="0" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="326" column="8" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="322" column="4" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="481" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="507" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="374" column="36" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="467" column="40" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="470" column="30" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="324" column="9" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="348" column="42" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="359" column="39" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="333" column="17" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/web/ReactNativeWeb.js" />
      <jump line="47013" column="15" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="94" column="29" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="43688" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="52" column="47" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="116" column="11" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52561" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="1" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="3154" column="41" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="2376" column="10" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="1418" column="11" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="1402" column="11" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="1408" column="11" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="15" column="6" filename="$USER_HOME$/dev/ignite/TextTest/node_modules/react-native/local-cli/templates/HelloNavigation/App.js" />
      <jump line="5" column="46" filename="$USER_HOME$/dev/ignite/TextTest/index.embedded.js" />
      <jump line="1" column="11" filename="$USER_HOME$/dev/ignite/TextTest/index.embedded.js" />
      <jump line="1413" column="4" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52612" column="51" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52687" column="21" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52686" column="13" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52720" column="21" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52715" column="21" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52714" column="13" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52718" column="4" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52604" column="13" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52605" column="40" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52606" column="98" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52609" column="29" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52640" column="21" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52665" column="11" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52668" column="20" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52669" column="26" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="1404" column="6" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="1406" column="6" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52090" column="29" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="52121" column="11" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="52124" column="18" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="52140" column="15" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="1225" column="7" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="1233" column="16" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="1240" column="13" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="23053" column="63" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/SimpleTest.js" />
      <jump line="1412" column="11" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="6" column="14" filename="$USER_HOME$/dev/ignite/TextTest/index.embedded.js" />
      <jump line="52673" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="1399" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="1821" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="1420" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="2705" column="47" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="1467" column="36" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="8" column="24" filename="$USER_HOME$/dev/ignite/TextTest/index.embedded.js" />
      <jump line="20" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTestRunner.js" />
      <jump line="1419" column="2" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52773" column="0" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="52772" column="12" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
      <jump line="129" column="37" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTestRunner.js" />
      <jump line="1786" column="16" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTestRunner.js" />
      <jump line="1787" column="52" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTestRunner.js" />
      <jump line="43562" column="36" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTestRunner.js" />
      <jump line="11460" column="19" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTestRunner.js" />
      <jump line="18" column="15" filename="$USER_HOME$/dev/ignite/AlexaReactNativeRuntimePrototype/js/apps/TextTest.js" />
    </jumps>
    <registers>
      <register name="a" type="2">
        <text encoding="base64">Ly8hIEBkZWZncm91cCBkaXNwbGF5IERpc3BsYXkKLy8hIEBpbmdyb3VwIGlkbAovLyEgQHsKCg==</text>
      </register>
      <register name="&quot;" type="4">
        <text>true</text>
      </register>
      <register name="b" type="2">
        <text encoding="base64">Ly8hIEB9Cg==</text>
      </register>
      <register name="f" type="2">
        <text encoding="base64">CXZpcnR1YWwgdm9pZCBzZXRJbkJhY2tncm91bmRNb2RlKCkgb3ZlcnJpZGU7Cgl2aXJ0dWFsIHZvaWQgc2V0SW5Gb3JlZ3JvdW5kTW9kZSgpIG92ZXJyaWRlOwo=</text>
      </register>
      <register name="g" type="4">
        <text>DEVICE_PROPERTIES_PROVIDER_LOCATION</text>
      </register>
      <register name="k" type="2">
        <text encoding="base64">CWxvZ0xpc3RlbmVyLnJlc2V0KG5ldyBMb2dMaXN0ZW5lcigKCQkJbW9ja0NvbnRleHQsIG1vY2tNZXNzYWdlQnVmZmVyLAoJCQljb3JlOjptZW1vcnk6OlVuaXF1ZVB0cjxJRXZlbnRCbGFja2xpc3RNYW5hZ2VyPihibGFja2xpc3RNYW5hZ2VyKSkpOwoJTG9nOjpnZXQoKS5yZWdpc3Rlckxpc3RlbmVyKGNvcmU6Om1lbW9yeTo6V2Vha1B0cjxJTG9nTGlzdGVuZXI+IHtsb2dMaXN0ZW5lcn0pOwo=</text>
      </register>
      <register name="l" type="4">
        <keys>
          <key char="99" code="0" mods="0" />
          <key char="116" code="0" mods="0" />
          <key char="76" code="0" mods="0" />
          <key char="68" code="0" mods="0" />
          <key char="69" code="0" mods="0" />
          <key char="86" code="0" mods="0" />
          <key char="73" code="0" mods="0" />
          <key char="67" code="0" mods="0" />
          <key char="69" code="0" mods="0" />
          <key char="76" code="0" mods="0" />
          <key char="65" code="0" mods="0" />
          <key char="89" code="0" mods="0" />
          <key char="69" code="0" mods="0" />
          <key char="82" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="-" type="4">
        <text>true</text>
      </register>
      <register name="m" type="4">
        <keys>
          <key char="121" code="0" mods="0" />
          <key char="121" code="0" mods="0" />
          <key char="80" code="0" mods="0" />
          <key char="87" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="87" code="0" mods="0" />
          <key char="64" code="0" mods="0" />
          <key char="116" code="0" mods="0" />
          <key char="111" code="0" mods="0" />
          <key char="100" code="0" mods="0" />
          <key char="111" code="0" mods="0" />
          <key char="32" code="0" mods="0" />
          <key char="60" code="0" mods="0" />
          <key char="98" code="0" mods="0" />
          <key char="62" code="0" mods="0" />
          <key char="77" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="110" code="0" mods="0" />
          <key char="100" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="116" code="0" mods="0" />
          <key char="111" code="0" mods="0" />
          <key char="114" code="0" mods="0" />
          <key char="121" code="0" mods="0" />
          <key char="32" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="65" code="0" mods="0" />
          <key char="60" code="0" mods="0" />
          <key char="47" code="0" mods="0" />
          <key char="98" code="0" mods="0" />
          <key char="62" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="/" type="4">
        <text encoding="base64">XDxfX1JDVFByb2ZpbGVJc1Byb2ZpbGluZ1w+</text>
      </register>
      <register name="0" type="2">
        <text encoding="base64">dmFyIF9fREVWX189dHJ1ZSxfX0JVTkRMRV9TVEFSVF9USU1FX189dGhpcy5uYXRpdmVQZXJmb3JtYW5jZU5vdz9uYXRpdmVQZXJmb3JtYW5jZU5vdygpOkRhdGUubm93KCkscHJvY2Vzcz10aGlzLnByb2Nlc3N8fHt9O3Byb2Nlc3MuZW52PXByb2Nlc3MuZW52fHx7fTtwcm9jZXNzLmVudi5OT0RFX0VOVj0nZGV2ZWxvcG1lbnQnOwooZnVuY3Rpb24gKGdsb2JhbCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZnVuY3Rpb24gX3RvQ29uc3VtYWJsZUFycmF5KGFycikgewogICAgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgewogICAgICBmb3IgKHZhciBpID0gMCwgYXJyMiA9IEFycmF5KGFyci5sZW5ndGgpOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYXJyMltpXSA9IGFycltpXTsKICAgICAgfQoKICAgICAgcmV0dXJuIGFycjI7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gQXJyYXkuZnJvbShhcnIpOwogICAgfQogIH0KCiAgZ2xvYmFsLnJlcXVpcmUgPSBfcmVxdWlyZTsKICBnbG9iYWwuX19kID0gZGVmaW5lOwogIHZhciBtb2R1bGVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgaWYgKF9fREVWX18pIHsKICAgIHZhciB2ZXJib3NlTmFtZXNUb01vZHVsZUlkcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgfQoKICBmdW5jdGlvbiBkZWZpbmUoZmFjdG9yeSwgbW9kdWxlSWQsIGRlcGVuZGVuY3lNYXApIHsKICAgIGlmIChtb2R1bGVJZCBpbiBtb2R1bGVzKSB7CiAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgdmFyIGludmVyc2VEZXBlbmRlbmNpZXMgPSBhcmd1bWVudHNbNF07CgogICAgICAgIGlmIChpbnZlcnNlRGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICBnbG9iYWwuX19hY2NlcHQobW9kdWxlSWQsIGZhY3RvcnksIGRlcGVuZGVuY3lNYXAsIGludmVyc2VEZXBlbmRlbmNpZXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oIlRyeWluZyB0byBkZWZpbmUgdHdpY2UgbW9kdWxlIElEICIgKyBtb2R1bGVJZCArICIgaW4gdGhlIHNhbWUgYnVuZGxlIik7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm47CiAgICB9CgogICAgbW9kdWxlc1ttb2R1bGVJZF0gPSB7CiAgICAgIGRlcGVuZGVuY3lNYXA6IGRlcGVuZGVuY3lNYXAsCiAgICAgIGV4cG9ydHM6IHVuZGVmaW5lZCwKICAgICAgZmFjdG9yeTogZmFjdG9yeSwKICAgICAgaGFzRXJyb3I6IGZhbHNlLAogICAgICBpc0luaXRpYWxpemVkOiBmYWxzZQogICAgfTsKCiAgICBpZiAoX19ERVZfXykgewogICAgICBtb2R1bGVzW21vZHVsZUlkXS5ob3QgPSBjcmVhdGVIb3RSZWxvYWRpbmdPYmplY3QoKTsKICAgICAgdmFyIHZlcmJvc2VOYW1lID0gYXJndW1lbnRzWzNdOwoKICAgICAgaWYgKHZlcmJvc2VOYW1lKSB7CiAgICAgICAgbW9kdWxlc1ttb2R1bGVJZF0udmVyYm9zZU5hbWUgPSB2ZXJib3NlTmFtZTsKICAgICAgICB2ZXJib3NlTmFtZXNUb01vZHVsZUlkc1t2ZXJib3NlTmFtZV0gPSBtb2R1bGVJZDsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gX3JlcXVpcmUobW9kdWxlSWQpIHsKICAgIGlmIChfX0RFVl9fICYmIHR5cGVvZiBtb2R1bGVJZCA9PT0gJ3N0cmluZycpIHsKICAgICAgdmFyIHZlcmJvc2VOYW1lID0gbW9kdWxlSWQ7CiAgICAgIG1vZHVsZUlkID0gdmVyYm9zZU5hbWVzVG9Nb2R1bGVJZHNbdmVyYm9zZU5hbWVdOwoKICAgICAgaWYgKG1vZHVsZUlkID09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbmFtZWQgbW9kdWxlOiAnIiArIHZlcmJvc2VOYW1lICsgIiciKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLndhcm4oIlJlcXVpcmluZyBtb2R1bGUgJyIgKyB2ZXJib3NlTmFtZSArICInIGJ5IG5hbWUgaXMgb25seSBzdXBwb3J0ZWQgZm9yICIgKyAnZGVidWdnaW5nIHB1cnBvc2VzIGFuZCB3aWxsIEJSRUFLIElOIFBST0RVQ1RJT04hJyk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgbW9kdWxlSWRSZWFsbHlJc051bWJlciA9IG1vZHVsZUlkOwogICAgdmFyIG1vZHVsZSA9IG1vZHVsZXNbbW9kdWxlSWRSZWFsbHlJc051bWJlcl07CiAgICByZXR1cm4gbW9kdWxlICYmIG1vZHVsZS5pc0luaXRpYWxpemVkID8gbW9kdWxlLmV4cG9ydHMgOiBndWFyZGVkTG9hZE1vZHVsZShtb2R1bGVJZFJlYWxseUlzTnVtYmVyLCBtb2R1bGUpOwogIH0KCiAgdmFyIGluR3VhcmQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gZ3VhcmRlZExvYWRNb2R1bGUobW9kdWxlSWQsIG1vZHVsZSkgewogICAgaWYgKCFpbkd1YXJkICYmIGdsb2JhbC5FcnJvclV0aWxzKSB7CiAgICAgIGluR3VhcmQgPSB0cnVlOwogICAgICB2YXIgcmV0dXJuVmFsdWUgPSB2b2lkIDA7CgogICAgICB0cnkgewogICAgICAgIHJldHVyblZhbHVlID0gbG9hZE1vZHVsZUltcGxlbWVudGF0aW9uKG1vZHVsZUlkLCBtb2R1bGUpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZ2xvYmFsLkVycm9yVXRpbHMucmVwb3J0RmF0YWxFcnJvcihlKTsKICAgICAgfQoKICAgICAgaW5HdWFyZCA9IGZhbHNlOwogICAgICByZXR1cm4gcmV0dXJuVmFsdWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbG9hZE1vZHVsZUltcGxlbWVudGF0aW9uKG1vZHVsZUlkLCBtb2R1bGUpOwogICAgfQogIH0KCiAgdmFyIElEX01BU0tfU0hJRlQgPSAxNjsKICB2YXIgTE9DQUxfSURfTUFTSyA9IH4wID4+PiBJRF9NQVNLX1NISUZUOwoKICBmdW5jdGlvbiB1bnBhY2tNb2R1bGVJZChtb2R1bGVJZCkgewogICAgdmFyIHNlZ21lbnRJZCA9IG1vZHVsZUlkID4+PiBJRF9NQVNLX1NISUZUOwogICAgdmFyIGxvY2FsSWQgPSBtb2R1bGVJZCAmIExPQ0FMX0lEX01BU0s7CiAgICByZXR1cm4gewogICAgICBzZWdtZW50SWQ6IHNlZ21lbnRJZCwKICAgICAgbG9jYWxJZDogbG9jYWxJZAogICAgfTsKICB9CgogIF9yZXF1aXJlLnVucGFja01vZHVsZUlkID0gdW5wYWNrTW9kdWxlSWQ7CgogIGZ1bmN0aW9uIHBhY2tNb2R1bGVJZCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLnNlZ21lbnRJZCA8PCBJRF9NQVNLX1NISUZUICsgdmFsdWUubG9jYWxJZDsKICB9CgogIF9yZXF1aXJlLnBhY2tNb2R1bGVJZCA9IHBhY2tNb2R1bGVJZDsKCiAgZnVuY3Rpb24gbG9hZE1vZHVsZUltcGxlbWVudGF0aW9uKG1vZHVsZUlkLCBtb2R1bGUpIHsKICAgIHZhciBuYXRpdmVSZXF1aXJlID0gZ2xvYmFsLm5hdGl2ZVJlcXVpcmU7CgogICAgaWYgKCFtb2R1bGUgJiYgbmF0aXZlUmVxdWlyZSkgewogICAgICB2YXIgX3VucGFja01vZHVsZUlkID0gdW5wYWNrTW9kdWxlSWQobW9kdWxlSWQpOwoKICAgICAgdmFyIHNlZ21lbnRJZCA9IF91bnBhY2tNb2R1bGVJZC5zZWdtZW50SWQsCiAgICAgICAgICBsb2NhbElkID0gX3VucGFja01vZHVsZUlkLmxvY2FsSWQ7CiAgICAgIG5hdGl2ZVJlcXVpcmUobG9jYWxJZCwgc2VnbWVudElkKTsKICAgICAgbW9kdWxlID0gbW9kdWxlc1ttb2R1bGVJZF07CiAgICB9CgogICAgaWYgKCFtb2R1bGUpIHsKICAgICAgdGhyb3cgdW5rbm93bk1vZHVsZUVycm9yKG1vZHVsZUlkKTsKICAgIH0KCiAgICBpZiAobW9kdWxlLmhhc0Vycm9yKSB7CiAgICAgIHRocm93IG1vZHVsZVRocmV3RXJyb3IobW9kdWxlSWQsIG1vZHVsZS5lcnJvcik7CiAgICB9CgogICAgaWYgKF9fREVWX18pIHsKICAgICAgdmFyIFN5c3RyYWNlID0gX3JlcXVpcmUuU3lzdHJhY2U7CiAgICB9CgogICAgbW9kdWxlLmlzSW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgdmFyIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IHt9OwogICAgdmFyIF9tb2R1bGUgPSBtb2R1bGU7CiAgICB2YXIgZmFjdG9yeSA9IF9tb2R1bGUuZmFjdG9yeSwKICAgICAgICBkZXBlbmRlbmN5TWFwID0gX21vZHVsZS5kZXBlbmRlbmN5TWFwOwoKICAgIHRyeSB7CiAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgU3lzdHJhY2UuYmVnaW5FdmVudCgnSlNfcmVxdWlyZV8nICsgKG1vZHVsZS52ZXJib3NlTmFtZSB8fCBtb2R1bGVJZCkpOwogICAgICB9CgogICAgICB2YXIgbW9kdWxlT2JqZWN0ID0gewogICAgICAgIGV4cG9ydHM6IGV4cG9ydHMKICAgICAgfTsKCiAgICAgIGlmIChfX0RFVl9fICYmIG1vZHVsZS5ob3QpIHsKICAgICAgICBtb2R1bGVPYmplY3QuaG90ID0gbW9kdWxlLmhvdDsKICAgICAgfQoKICAgICAgZmFjdG9yeShnbG9iYWwsIF9yZXF1aXJlLCBtb2R1bGVPYmplY3QsIGV4cG9ydHMsIGRlcGVuZGVuY3lNYXApOwoKICAgICAgaWYgKCFfX0RFVl9fKSB7CiAgICAgICAgbW9kdWxlLmZhY3RvcnkgPSB1bmRlZmluZWQ7CiAgICAgICAgbW9kdWxlLmRlcGVuZGVuY3lNYXAgPSB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgU3lzdHJhY2UuZW5kRXZlbnQoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG1vZHVsZS5leHBvcnRzID0gbW9kdWxlT2JqZWN0LmV4cG9ydHM7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIG1vZHVsZS5oYXNFcnJvciA9IHRydWU7CiAgICAgIG1vZHVsZS5lcnJvciA9IGU7CiAgICAgIG1vZHVsZS5pc0luaXRpYWxpemVkID0gZmFsc2U7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gdW5kZWZpbmVkOwogICAgICB0aHJvdyBlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdW5rbm93bk1vZHVsZUVycm9yKGlkKSB7CiAgICB2YXIgbWVzc2FnZSA9ICdSZXF1aXJpbmcgdW5rbm93biBtb2R1bGUgIicgKyBpZCArICciLic7CgogICAgaWYgKF9fREVWX18pIHsKICAgICAgbWVzc2FnZSArPSAnSWYgeW91IGFyZSBzdXJlIHRoZSBtb2R1bGUgaXMgdGhlcmUsIHRyeSByZXN0YXJ0aW5nIE1ldHJvIEJ1bmRsZXIuICcgKyAnWW91IG1heSBhbHNvIHdhbnQgdG8gcnVuIGB5YXJuYCwgb3IgYG5wbSBpbnN0YWxsYCAoZGVwZW5kaW5nIG9uIHlvdXIgZW52aXJvbm1lbnQpLic7CiAgICB9CgogICAgcmV0dXJuIEVycm9yKG1lc3NhZ2UpOwogIH0KCiAgZnVuY3Rpb24gbW9kdWxlVGhyZXdFcnJvcihpZCwgZXJyb3IpIHsKICAgIHZhciBkaXNwbGF5TmFtZSA9IF9fREVWX18gJiYgbW9kdWxlc1tpZF0gJiYgbW9kdWxlc1tpZF0udmVyYm9zZU5hbWUgfHwgaWQ7CiAgICByZXR1cm4gRXJyb3IoJ1JlcXVpcmluZyBtb2R1bGUgIicgKyBkaXNwbGF5TmFtZSArICciLCB3aGljaCB0aHJldyBhbiBleGNlcHRpb246ICcgKyBlcnJvcik7CiAgfQoKICBpZiAoX19ERVZfXykgewogICAgX3JlcXVpcmUuU3lzdHJhY2UgPSB7CiAgICAgIGJlZ2luRXZlbnQ6IGZ1bmN0aW9uIGJlZ2luRXZlbnQoKSB7fSwKICAgICAgZW5kRXZlbnQ6IGZ1bmN0aW9uIGVuZEV2ZW50KCkge30KICAgIH07CgogICAgX3JlcXVpcmUuZ2V0TW9kdWxlcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG1vZHVsZXM7CiAgICB9OwoKICAgIHZhciBjcmVhdGVIb3RSZWxvYWRpbmdPYmplY3QgPSBmdW5jdGlvbiBjcmVhdGVIb3RSZWxvYWRpbmdPYmplY3QoKSB7CiAgICAgIHZhciBob3QgPSB7CiAgICAgICAgYWNjZXB0Q2FsbGJhY2s6IG51bGwsCiAgICAgICAgYWNjZXB0OiBmdW5jdGlvbiBhY2NlcHQoY2FsbGJhY2spIHsKICAgICAgICAgIGhvdC5hY2NlcHRDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIGhvdDsKICAgIH07CgogICAgdmFyIGFjY2VwdEFsbCA9IGZ1bmN0aW9uIGFjY2VwdEFsbChkZXBlbmRlbnRNb2R1bGVzLCBpbnZlcnNlRGVwZW5kZW5jaWVzKSB7CiAgICAgIGlmICghZGVwZW5kZW50TW9kdWxlcyB8fCBkZXBlbmRlbnRNb2R1bGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICB2YXIgbm90QWNjZXB0ZWQgPSBkZXBlbmRlbnRNb2R1bGVzLmZpbHRlcihmdW5jdGlvbiAobW9kdWxlKSB7CiAgICAgICAgcmV0dXJuICFhY2NlcHQobW9kdWxlLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgaW52ZXJzZURlcGVuZGVuY2llcyk7CiAgICAgIH0pOwogICAgICB2YXIgcGFyZW50cyA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub3RBY2NlcHRlZC5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChpbnZlcnNlRGVwZW5kZW5jaWVzW25vdEFjY2VwdGVkW2ldXS5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHBhcmVudHMucHVzaC5hcHBseShwYXJlbnRzLCBfdG9Db25zdW1hYmxlQXJyYXkoaW52ZXJzZURlcGVuZGVuY2llc1tub3RBY2NlcHRlZFtpXV0pKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGFjY2VwdEFsbChwYXJlbnRzLCBpbnZlcnNlRGVwZW5kZW5jaWVzKTsKICAgIH07CgogICAgdmFyIGFjY2VwdCA9IGZ1bmN0aW9uIGFjY2VwdChpZCwgZmFjdG9yeSwgZGVwZW5kZW5jeU1hcCwgaW52ZXJzZURlcGVuZGVuY2llcykgewogICAgICB2YXIgbW9kID0gbW9kdWxlc1tpZF07CgogICAgICBpZiAoIW1vZCAmJiBmYWN0b3J5KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIHZhciBob3QgPSBtb2QuaG90OwoKICAgICAgaWYgKCFob3QpIHsKICAgICAgICBjb25zb2xlLndhcm4oJ0Nhbm5vdCBhY2NlcHQgbW9kdWxlIGJlY2F1c2UgSG90IE1vZHVsZSBSZXBsYWNlbWVudCAnICsgJ0FQSSB3YXMgbm90IGluc3RhbGxlZC4nKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmIChmYWN0b3J5KSB7CiAgICAgICAgbW9kLmZhY3RvcnkgPSBmYWN0b3J5OwogICAgICB9CgogICAgICBpZiAoZGVwZW5kZW5jeU1hcCkgewogICAgICAgIG1vZC5kZXBlbmRlbmN5TWFwID0gZGVwZW5kZW5jeU1hcDsKICAgICAgfQoKICAgICAgbW9kLmhhc0Vycm9yID0gZmFsc2U7CiAgICAgIG1vZC5pc0luaXRpYWxpemVkID0gZmFsc2U7CgogICAgICBfcmVxdWlyZShpZCk7CgogICAgICBpZiAoaG90LmFjY2VwdENhbGxiYWNrKSB7CiAgICAgICAgaG90LmFjY2VwdENhbGxiYWNrKCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFpbnZlcnNlRGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZGVmaW5lZCBgaW52ZXJzZURlcGVuZGVuY2llc2AnKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhY2NlcHRBbGwoaW52ZXJzZURlcGVuZGVuY2llc1tpZF0sIGludmVyc2VEZXBlbmRlbmNpZXMpOwogICAgICB9CiAgICB9OwoKICAgIGdsb2JhbC5fX2FjY2VwdCA9IGFjY2VwdDsKICB9Cn0pKHRoaXMpOwooZnVuY3Rpb24gKGdsb2JhbCkgewogIE9iamVjdC5hc3NpZ24gPSBmdW5jdGlvbiAodGFyZ2V0LCBzb3VyY2VzKSB7CiAgICBpZiAoX19ERVZfXykgewogICAgICBpZiAodGFyZ2V0ID09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdPYmplY3QuYXNzaWduIHRhcmdldCBjYW5ub3QgYmUgbnVsbCBvciB1bmRlZmluZWQnKTsKICAgICAgfQoKICAgICAgaWYgKHR5cGVvZiB0YXJnZXQgIT09ICdvYmplY3QnICYmIHR5cGVvZiB0YXJnZXQgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbiB0aGlzIGVudmlyb25tZW50IHRoZSB0YXJnZXQgb2YgYXNzaWduIE1VU1QgYmUgYW4gb2JqZWN0LiAnICsgJ1RoaXMgZXJyb3IgaXMgYSBwZXJmb3JtYW5jZSBvcHRpbWl6YXRpb24gYW5kIG5vdCBzcGVjIGNvbXBsaWFudC4nKTsKICAgICAgfQogICAgfQoKICAgIGZvciAodmFyIG5leHRJbmRleCA9IDE7IG5leHRJbmRleCA8IGFyZ3VtZW50cy5sZW5ndGg7IG5leHRJbmRleCsrKSB7CiAgICAgIHZhciBuZXh0U291cmNlID0gYXJndW1lbnRzW25leHRJbmRleF07CgogICAgICBpZiAobmV4dFNvdXJjZSA9PSBudWxsKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgaWYgKHR5cGVvZiBuZXh0U291cmNlICE9PSAnb2JqZWN0JyAmJiB0eXBlb2YgbmV4dFNvdXJjZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSW4gdGhpcyBlbnZpcm9ubWVudCB0aGUgc291cmNlcyBmb3IgYXNzaWduIE1VU1QgYmUgYW4gb2JqZWN0LiAnICsgJ1RoaXMgZXJyb3IgaXMgYSBwZXJmb3JtYW5jZSBvcHRpbWl6YXRpb24gYW5kIG5vdCBzcGVjIGNvbXBsaWFudC4nKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGtleSBpbiBuZXh0U291cmNlKSB7CiAgICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgogICAgICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eS5jYWxsKG5leHRTb3VyY2UsIGtleSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignT25lIG9mIHRoZSBzb3VyY2VzIGZvciBhc3NpZ24gaGFzIGFuIGVudW1lcmFibGUga2V5IG9uIHRoZSAnICsgJ3Byb3RvdHlwZSBjaGFpbi4gQXJlIHlvdSB0cnlpbmcgdG8gYXNzaWduIGEgcHJvdG90eXBlIHByb3BlcnR5PyAnICsgJ1dlIGRvblwndCBhbGxvdyBpdCwgYXMgdGhpcyBpcyBhbiBlZGdlIGNhc2UgdGhhdCB3ZSBkbyBub3Qgc3VwcG9ydC4gJyArICdUaGlzIGVycm9yIGlzIGEgcGVyZm9ybWFuY2Ugb3B0aW1pemF0aW9uIGFuZCBub3Qgc3BlYyBjb21wbGlhbnQuJyk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0YXJnZXRba2V5XSA9IG5leHRTb3VyY2Vba2V5XTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0YXJnZXQ7CiAgfTsKfSkodGhpcyk7CihmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgdmFyIGluc3BlY3QgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBpbnNwZWN0KG9iaiwgb3B0cykgewogICAgICB2YXIgY3R4ID0gewogICAgICAgIHNlZW46IFtdLAogICAgICAgIHN0eWxpemU6IHN0eWxpemVOb0NvbG9yCiAgICAgIH07CiAgICAgIHJldHVybiBmb3JtYXRWYWx1ZShjdHgsIG9iaiwgb3B0cy5kZXB0aCk7CiAgICB9CgogICAgZnVuY3Rpb24gc3R5bGl6ZU5vQ29sb3Ioc3RyLCBzdHlsZVR5cGUpIHsKICAgICAgcmV0dXJuIHN0cjsKICAgIH0KCiAgICBmdW5jdGlvbiBhcnJheVRvSGFzaChhcnJheSkgewogICAgICB2YXIgaGFzaCA9IHt9OwogICAgICBhcnJheS5mb3JFYWNoKGZ1bmN0aW9uICh2YWwsIGlkeCkgewogICAgICAgIGhhc2hbdmFsXSA9IHRydWU7CiAgICAgIH0pOwogICAgICByZXR1cm4gaGFzaDsKICAgIH0KCiAgICBmdW5jdGlvbiBmb3JtYXRWYWx1ZShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMpIHsKICAgICAgdmFyIHByaW1pdGl2ZSA9IGZvcm1hdFByaW1pdGl2ZShjdHgsIHZhbHVlKTsKCiAgICAgIGlmIChwcmltaXRpdmUpIHsKICAgICAgICByZXR1cm4gcHJpbWl0aXZlOwogICAgICB9CgogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgICAgdmFyIHZpc2libGVLZXlzID0gYXJyYXlUb0hhc2goa2V5cyk7CgogICAgICBpZiAoaXNFcnJvcih2YWx1ZSkgJiYgKGtleXMuaW5kZXhPZignbWVzc2FnZScpID49IDAgfHwga2V5cy5pbmRleE9mKCdkZXNjcmlwdGlvbicpID49IDApKSB7CiAgICAgICAgcmV0dXJuIGZvcm1hdEVycm9yKHZhbHVlKTsKICAgICAgfQoKICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IHZhbHVlLm5hbWUgPyAnOiAnICsgdmFsdWUubmFtZSA6ICcnOwogICAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCdbRnVuY3Rpb24nICsgbmFtZSArICddJywgJ3NwZWNpYWwnKTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBjdHguc3R5bGl6ZShSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAncmVnZXhwJyk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNEYXRlKHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKERhdGUucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAnZGF0ZScpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzRXJyb3IodmFsdWUpKSB7CiAgICAgICAgICByZXR1cm4gZm9ybWF0RXJyb3IodmFsdWUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIGJhc2UgPSAnJywKICAgICAgICAgIGFycmF5ID0gZmFsc2UsCiAgICAgICAgICBicmFjZXMgPSBbJ3snLCAnfSddOwoKICAgICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgYXJyYXkgPSB0cnVlOwogICAgICAgIGJyYWNlcyA9IFsnWycsICddJ107CiAgICAgIH0KCiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHZhciBuID0gdmFsdWUubmFtZSA/ICc6ICcgKyB2YWx1ZS5uYW1lIDogJyc7CiAgICAgICAgYmFzZSA9ICcgW0Z1bmN0aW9uJyArIG4gKyAnXSc7CiAgICAgIH0KCiAgICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgICBiYXNlID0gJyAnICsgUmVnRXhwLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKTsKICAgICAgfQoKICAgICAgaWYgKGlzRGF0ZSh2YWx1ZSkpIHsKICAgICAgICBiYXNlID0gJyAnICsgRGF0ZS5wcm90b3R5cGUudG9VVENTdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICAgIH0KCiAgICAgIGlmIChpc0Vycm9yKHZhbHVlKSkgewogICAgICAgIGJhc2UgPSAnICcgKyBmb3JtYXRFcnJvcih2YWx1ZSk7CiAgICAgIH0KCiAgICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCAmJiAoIWFycmF5IHx8IHZhbHVlLmxlbmd0aCA9PSAwKSkgewogICAgICAgIHJldHVybiBicmFjZXNbMF0gKyBiYXNlICsgYnJhY2VzWzFdOwogICAgICB9CgogICAgICBpZiAocmVjdXJzZVRpbWVzIDwgMCkgewogICAgICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBjdHguc3R5bGl6ZShSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAncmVnZXhwJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnW09iamVjdF0nLCAnc3BlY2lhbCcpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgY3R4LnNlZW4ucHVzaCh2YWx1ZSk7CiAgICAgIHZhciBvdXRwdXQ7CgogICAgICBpZiAoYXJyYXkpIHsKICAgICAgICBvdXRwdXQgPSBmb3JtYXRBcnJheShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQgPSBrZXlzLm1hcChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICByZXR1cm4gZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5LCBhcnJheSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGN0eC5zZWVuLnBvcCgpOwogICAgICByZXR1cm4gcmVkdWNlVG9TaW5nbGVTdHJpbmcob3V0cHV0LCBiYXNlLCBicmFjZXMpOwogICAgfQoKICAgIGZ1bmN0aW9uIGZvcm1hdFByaW1pdGl2ZShjdHgsIHZhbHVlKSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHJldHVybiBjdHguc3R5bGl6ZSgndW5kZWZpbmVkJywgJ3VuZGVmaW5lZCcpOwoKICAgICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgIHZhciBzaW1wbGUgPSAiJyIgKyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkucmVwbGFjZSgvXiJ8IiQvZywgJycpLnJlcGxhY2UoLycvZywgIlxcJyIpLnJlcGxhY2UoL1xcIi9nLCAnIicpICsgIiciOwogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZShzaW1wbGUsICdzdHJpbmcnKTsKICAgICAgfQoKICAgICAgaWYgKGlzTnVtYmVyKHZhbHVlKSkgcmV0dXJuIGN0eC5zdHlsaXplKCcnICsgdmFsdWUsICdudW1iZXInKTsKICAgICAgaWYgKGlzQm9vbGVhbih2YWx1ZSkpIHJldHVybiBjdHguc3R5bGl6ZSgnJyArIHZhbHVlLCAnYm9vbGVhbicpOwogICAgICBpZiAoaXNOdWxsKHZhbHVlKSkgcmV0dXJuIGN0eC5zdHlsaXplKCdudWxsJywgJ251bGwnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBmb3JtYXRFcnJvcih2YWx1ZSkgewogICAgICByZXR1cm4gJ1snICsgRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpICsgJ10nOwogICAgfQoKICAgIGZ1bmN0aW9uIGZvcm1hdEFycmF5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleXMpIHsKICAgICAgdmFyIG91dHB1dCA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2YWx1ZS5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkodmFsdWUsIFN0cmluZyhpKSkpIHsKICAgICAgICAgIG91dHB1dC5wdXNoKGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIFN0cmluZyhpKSwgdHJ1ZSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvdXRwdXQucHVzaCgnJyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBrZXlzLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIGlmICgha2V5Lm1hdGNoKC9eXGQrJC8pKSB7CiAgICAgICAgICBvdXRwdXQucHVzaChmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXksIHRydWUpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gb3V0cHV0OwogICAgfQoKICAgIGZ1bmN0aW9uIGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleSwgYXJyYXkpIHsKICAgICAgdmFyIG5hbWUsIHN0ciwgZGVzYzsKICAgICAgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodmFsdWUsIGtleSkgfHwgewogICAgICAgIHZhbHVlOiB2YWx1ZVtrZXldCiAgICAgIH07CgogICAgICBpZiAoZGVzYy5nZXQpIHsKICAgICAgICBpZiAoZGVzYy5zZXQpIHsKICAgICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbR2V0dGVyL1NldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW0dldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZGVzYy5zZXQpIHsKICAgICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbU2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIWhhc093blByb3BlcnR5KHZpc2libGVLZXlzLCBrZXkpKSB7CiAgICAgICAgbmFtZSA9ICdbJyArIGtleSArICddJzsKICAgICAgfQoKICAgICAgaWYgKCFzdHIpIHsKICAgICAgICBpZiAoY3R4LnNlZW4uaW5kZXhPZihkZXNjLnZhbHVlKSA8IDApIHsKICAgICAgICAgIGlmIChpc051bGwocmVjdXJzZVRpbWVzKSkgewogICAgICAgICAgICBzdHIgPSBmb3JtYXRWYWx1ZShjdHgsIGRlc2MudmFsdWUsIG51bGwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RyID0gZm9ybWF0VmFsdWUoY3R4LCBkZXNjLnZhbHVlLCByZWN1cnNlVGltZXMgLSAxKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc3RyLmluZGV4T2YoJ1xuJykgPiAtMSkgewogICAgICAgICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAgICAgICBzdHIgPSBzdHIuc3BsaXQoJ1xuJykubWFwKGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJyAgJyArIGxpbmU7CiAgICAgICAgICAgICAgfSkuam9pbignXG4nKS5zdWJzdHIoMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyID0gJ1xuJyArIHN0ci5zcGxpdCgnXG4nKS5tYXAoZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAnICAgJyArIGxpbmU7CiAgICAgICAgICAgICAgfSkuam9pbignXG4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW0NpcmN1bGFyXScsICdzcGVjaWFsJyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNVbmRlZmluZWQobmFtZSkpIHsKICAgICAgICBpZiAoYXJyYXkgJiYga2V5Lm1hdGNoKC9eXGQrJC8pKSB7CiAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgIH0KCiAgICAgICAgbmFtZSA9IEpTT04uc3RyaW5naWZ5KCcnICsga2V5KTsKCiAgICAgICAgaWYgKG5hbWUubWF0Y2goL14iKFthLXpBLVpfXVthLXpBLVpfMC05XSopIiQvKSkgewogICAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKDEsIG5hbWUubGVuZ3RoIC0gMik7CiAgICAgICAgICBuYW1lID0gY3R4LnN0eWxpemUobmFtZSwgJ25hbWUnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvJy9nLCAiXFwnIikucmVwbGFjZSgvXFwiL2csICciJykucmVwbGFjZSgvKF4ifCIkKS9nLCAiJyIpOwogICAgICAgICAgbmFtZSA9IGN0eC5zdHlsaXplKG5hbWUsICdzdHJpbmcnKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBuYW1lICsgJzogJyArIHN0cjsKICAgIH0KCiAgICBmdW5jdGlvbiByZWR1Y2VUb1NpbmdsZVN0cmluZyhvdXRwdXQsIGJhc2UsIGJyYWNlcykgewogICAgICB2YXIgbnVtTGluZXNFc3QgPSAwOwogICAgICB2YXIgbGVuZ3RoID0gb3V0cHV0LnJlZHVjZShmdW5jdGlvbiAocHJldiwgY3VyKSB7CiAgICAgICAgbnVtTGluZXNFc3QrKzsKICAgICAgICBpZiAoY3VyLmluZGV4T2YoJ1xuJykgPj0gMCkgbnVtTGluZXNFc3QrKzsKICAgICAgICByZXR1cm4gcHJldiArIGN1ci5yZXBsYWNlKC9cdTAwMWJcW1xkXGQ/bS9nLCAnJykubGVuZ3RoICsgMTsKICAgICAgfSwgMCk7CgogICAgICBpZiAobGVuZ3RoID4gNjApIHsKICAgICAgICByZXR1cm4gYnJhY2VzWzBdICsgKGJhc2UgPT09ICcnID8gJycgOiBiYXNlICsgJ1xuICcpICsgJyAnICsgb3V0cHV0LmpvaW4oJyxcbiAgJykgKyAnICcgKyBicmFjZXNbMV07CiAgICAgIH0KCiAgICAgIHJldHVybiBicmFjZXNbMF0gKyBiYXNlICsgJyAnICsgb3V0cHV0LmpvaW4oJywgJykgKyAnICcgKyBicmFjZXNbMV07CiAgICB9CgogICAgZnVuY3Rpb24gaXNBcnJheShhcikgewogICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShhcik7CiAgICB9CgogICAgZnVuY3Rpb24gaXNCb29sZWFuKGFyZykgewogICAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Jvb2xlYW4nOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTnVsbChhcmcpIHsKICAgICAgcmV0dXJuIGFyZyA9PT0gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBpc051bGxPclVuZGVmaW5lZChhcmcpIHsKICAgICAgcmV0dXJuIGFyZyA9PSBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTnVtYmVyKGFyZykgewogICAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ251bWJlcic7CiAgICB9CgogICAgZnVuY3Rpb24gaXNTdHJpbmcoYXJnKSB7CiAgICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnc3RyaW5nJzsKICAgIH0KCiAgICBmdW5jdGlvbiBpc1N5bWJvbChhcmcpIHsKICAgICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdzeW1ib2wnOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzVW5kZWZpbmVkKGFyZykgewogICAgICByZXR1cm4gYXJnID09PSB2b2lkIDA7CiAgICB9CgogICAgZnVuY3Rpb24gaXNSZWdFeHAocmUpIHsKICAgICAgcmV0dXJuIGlzT2JqZWN0KHJlKSAmJiBvYmplY3RUb1N0cmluZyhyZSkgPT09ICdbb2JqZWN0IFJlZ0V4cF0nOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogICAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzRGF0ZShkKSB7CiAgICAgIHJldHVybiBpc09iamVjdChkKSAmJiBvYmplY3RUb1N0cmluZyhkKSA9PT0gJ1tvYmplY3QgRGF0ZV0nOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzRXJyb3IoZSkgewogICAgICByZXR1cm4gaXNPYmplY3QoZSkgJiYgKG9iamVjdFRvU3RyaW5nKGUpID09PSAnW29iamVjdCBFcnJvcl0nIHx8IGUgaW5zdGFuY2VvZiBFcnJvcik7CiAgICB9CgogICAgZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICAgICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdmdW5jdGlvbic7CiAgICB9CgogICAgZnVuY3Rpb24gaXNQcmltaXRpdmUoYXJnKSB7CiAgICAgIHJldHVybiBhcmcgPT09IG51bGwgfHwgdHlwZW9mIGFyZyA9PT0gJ2Jvb2xlYW4nIHx8IHR5cGVvZiBhcmcgPT09ICdudW1iZXInIHx8IHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiBhcmcgPT09ICdzeW1ib2wnIHx8IHR5cGVvZiBhcmcgPT09ICd1bmRlZmluZWQnOwogICAgfQoKICAgIGZ1bmN0aW9uIG9iamVjdFRvU3RyaW5nKG8pIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvKTsKICAgIH0KCiAgICBmdW5jdGlvbiBoYXNPd25Qcm9wZXJ0eShvYmosIHByb3ApIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApOwogICAgfQoKICAgIHJldHVybiBpbnNwZWN0OwogIH0oKTsKCiAgdmFyIE9CSkVDVF9DT0xVTU5fTkFNRSA9ICcoaW5kZXgpJzsKICB2YXIgTE9HX0xFVkVMUyA9IHsKICAgIHRyYWNlOiAwLAogICAgaW5mbzogMSwKICAgIHdhcm46IDIsCiAgICBlcnJvcjogMwogIH07CiAgdmFyIElOU1BFQ1RPUl9MRVZFTFMgPSBbXTsKICBJTlNQRUNUT1JfTEVWRUxTW0xPR19MRVZFTFMudHJhY2VdID0gJ2RlYnVnJzsKICBJTlNQRUNUT1JfTEVWRUxTW0xPR19MRVZFTFMuaW5mb10gPSAnbG9nJzsKICBJTlNQRUNUT1JfTEVWRUxTW0xPR19MRVZFTFMud2Fybl0gPSAnd2FybmluZyc7CiAgSU5TUEVDVE9SX0xFVkVMU1tMT0dfTEVWRUxTLmVycm9yXSA9ICdlcnJvcic7CiAgdmFyIElOU1BFQ1RPUl9GUkFNRVNfVE9fU0tJUCA9IF9fREVWX18gPyAyIDogMTsKCiAgaWYgKGdsb2JhbC5uYXRpdmVMb2dnaW5nSG9vaykgewogICAgZnVuY3Rpb24gZ2V0TmF0aXZlTG9nRnVuY3Rpb24obGV2ZWwpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgc3RyID0gdm9pZCAwOwoKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdID09PSAnc3RyaW5nJykgewogICAgICAgICAgc3RyID0gYXJndW1lbnRzWzBdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHIgPSBBcnJheS5wcm90b3R5cGUubWFwLmNhbGwoYXJndW1lbnRzLCBmdW5jdGlvbiAoYXJnKSB7CiAgICAgICAgICAgIHJldHVybiBpbnNwZWN0KGFyZywgewogICAgICAgICAgICAgIGRlcHRoOiAxMAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pLmpvaW4oJywgJyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgbG9nTGV2ZWwgPSBsZXZlbDsKCiAgICAgICAgaWYgKHN0ci5zbGljZSgwLCA5KSA9PT0gJ1dhcm5pbmc6ICcgJiYgbG9nTGV2ZWwgPj0gTE9HX0xFVkVMUy5lcnJvcikgewogICAgICAgICAgbG9nTGV2ZWwgPSBMT0dfTEVWRUxTLndhcm47CiAgICAgICAgfQoKICAgICAgICBpZiAoZ2xvYmFsLl9faW5zcGVjdG9yTG9nKSB7CiAgICAgICAgICBnbG9iYWwuX19pbnNwZWN0b3JMb2coSU5TUEVDVE9SX0xFVkVMU1tsb2dMZXZlbF0sIHN0ciwgW10uc2xpY2UuY2FsbChhcmd1bWVudHMpLCBJTlNQRUNUT1JfRlJBTUVTX1RPX1NLSVApOwogICAgICAgIH0KCiAgICAgICAgZ2xvYmFsLm5hdGl2ZUxvZ2dpbmdIb29rKHN0ciwgbG9nTGV2ZWwpOwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHJlcGVhdChlbGVtZW50LCBuKSB7CiAgICAgIHJldHVybiBBcnJheS5hcHBseShudWxsLCBBcnJheShuKSkubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gY29uc29sZVRhYmxlUG9seWZpbGwocm93cykgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkocm93cykpIHsKICAgICAgICB2YXIgZGF0YSA9IHJvd3M7CiAgICAgICAgcm93cyA9IFtdOwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICB2YXIgcm93ID0gZGF0YVtrZXldOwogICAgICAgICAgICByb3dbT0JKRUNUX0NPTFVNTl9OQU1FXSA9IGtleTsKICAgICAgICAgICAgcm93cy5wdXNoKHJvdyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocm93cy5sZW5ndGggPT09IDApIHsKICAgICAgICBnbG9iYWwubmF0aXZlTG9nZ2luZ0hvb2soJycsIExPR19MRVZFTFMuaW5mbyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgY29sdW1ucyA9IE9iamVjdC5rZXlzKHJvd3NbMF0pLnNvcnQoKTsKICAgICAgdmFyIHN0cmluZ1Jvd3MgPSBbXTsKICAgICAgdmFyIGNvbHVtbldpZHRocyA9IFtdOwogICAgICBjb2x1bW5zLmZvckVhY2goZnVuY3Rpb24gKGssIGkpIHsKICAgICAgICBjb2x1bW5XaWR0aHNbaV0gPSBrLmxlbmd0aDsKCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCByb3dzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICB2YXIgY2VsbFN0ciA9IChyb3dzW2pdW2tdIHx8ICc/JykudG9TdHJpbmcoKTsKICAgICAgICAgIHN0cmluZ1Jvd3Nbal0gPSBzdHJpbmdSb3dzW2pdIHx8IFtdOwogICAgICAgICAgc3RyaW5nUm93c1tqXVtpXSA9IGNlbGxTdHI7CiAgICAgICAgICBjb2x1bW5XaWR0aHNbaV0gPSBNYXRoLm1heChjb2x1bW5XaWR0aHNbaV0sIGNlbGxTdHIubGVuZ3RoKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgZnVuY3Rpb24gam9pblJvdyhyb3csIHNwYWNlKSB7CiAgICAgICAgdmFyIGNlbGxzID0gcm93Lm1hcChmdW5jdGlvbiAoY2VsbCwgaSkgewogICAgICAgICAgdmFyIGV4dHJhU3BhY2VzID0gcmVwZWF0KCcgJywgY29sdW1uV2lkdGhzW2ldIC0gY2VsbC5sZW5ndGgpLmpvaW4oJycpOwogICAgICAgICAgcmV0dXJuIGNlbGwgKyBleHRyYVNwYWNlczsKICAgICAgICB9KTsKICAgICAgICBzcGFjZSA9IHNwYWNlIHx8ICcgJzsKICAgICAgICByZXR1cm4gY2VsbHMuam9pbihzcGFjZSArICd8JyArIHNwYWNlKTsKICAgICAgfQoKICAgICAgdmFyIHNlcGFyYXRvcnMgPSBjb2x1bW5XaWR0aHMubWFwKGZ1bmN0aW9uIChjb2x1bW5XaWR0aCkgewogICAgICAgIHJldHVybiByZXBlYXQoJy0nLCBjb2x1bW5XaWR0aCkuam9pbignJyk7CiAgICAgIH0pOwogICAgICB2YXIgc2VwYXJhdG9yUm93ID0gam9pblJvdyhzZXBhcmF0b3JzLCAnLScpOwogICAgICB2YXIgaGVhZGVyID0gam9pblJvdyhjb2x1bW5zKTsKICAgICAgdmFyIHRhYmxlID0gW2hlYWRlciwgc2VwYXJhdG9yUm93XTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcm93cy5sZW5ndGg7IGkrKykgewogICAgICAgIHRhYmxlLnB1c2goam9pblJvdyhzdHJpbmdSb3dzW2ldKSk7CiAgICAgIH0KCiAgICAgIGdsb2JhbC5uYXRpdmVMb2dnaW5nSG9vaygnXG4nICsgdGFibGUuam9pbignXG4nKSwgTE9HX0xFVkVMUy5pbmZvKTsKICAgIH0KCiAgICB2YXIgb3JpZ2luYWxDb25zb2xlID0gZ2xvYmFsLmNvbnNvbGU7CiAgICBnbG9iYWwuY29uc29sZSA9IHsKICAgICAgZXJyb3I6IGdldE5hdGl2ZUxvZ0Z1bmN0aW9uKExPR19MRVZFTFMuZXJyb3IpLAogICAgICBpbmZvOiBnZXROYXRpdmVMb2dGdW5jdGlvbihMT0dfTEVWRUxTLmluZm8pLAogICAgICBsb2c6IGdldE5hdGl2ZUxvZ0Z1bmN0aW9uKExPR19MRVZFTFMuaW5mbyksCiAgICAgIHdhcm46IGdldE5hdGl2ZUxvZ0Z1bmN0aW9uKExPR19MRVZFTFMud2FybiksCiAgICAgIHRyYWNlOiBnZXROYXRpdmVMb2dGdW5jdGlvbihMT0dfTEVWRUxTLnRyYWNlKSwKICAgICAgZGVidWc6IGdldE5hdGl2ZUxvZ0Z1bmN0aW9uKExPR19MRVZFTFMudHJhY2UpLAogICAgICB0YWJsZTogY29uc29sZVRhYmxlUG9seWZpbGwKICAgIH07CgogICAgaWYgKF9fREVWX18gJiYgb3JpZ2luYWxDb25zb2xlKSB7CiAgICAgIHZhciBkZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihnbG9iYWwsICdjb25zb2xlJyk7CgogICAgICBpZiAoZGVzY3JpcHRvcikgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShnbG9iYWwsICdvcmlnaW5hbENvbnNvbGUnLCBkZXNjcmlwdG9yKTsKICAgICAgfQoKICAgICAgT2JqZWN0LmtleXMoY29uc29sZSkuZm9yRWFjaChmdW5jdGlvbiAobWV0aG9kTmFtZSkgewogICAgICAgIHZhciByZWFjdE5hdGl2ZU1ldGhvZCA9IGNvbnNvbGVbbWV0aG9kTmFtZV07CgogICAgICAgIGlmIChvcmlnaW5hbENvbnNvbGVbbWV0aG9kTmFtZV0pIHsKICAgICAgICAgIGNvbnNvbGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIG9yaWdpbmFsQ29uc29sZVttZXRob2ROYW1lXS5hcHBseShvcmlnaW5hbENvbnNvbGUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHJlYWN0TmF0aXZlTWV0aG9kLmFwcGx5KGNvbnNvbGUsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmICghZ2xvYmFsLmNvbnNvbGUpIHsKICAgIHZhciBsb2cgPSBnbG9iYWwucHJpbnQgfHwgZnVuY3Rpb24gY29uc29sZUxvZ2dpbmdTdHViKCkge307CgogICAgZ2xvYmFsLmNvbnNvbGUgPSB7CiAgICAgIGVycm9yOiBsb2csCiAgICAgIGluZm86IGxvZywKICAgICAgbG9nOiBsb2csCiAgICAgIHdhcm46IGxvZywKICAgICAgdHJhY2U6IGxvZywKICAgICAgZGVidWc6IGxvZywKICAgICAgdGFibGU6IGxvZwogICAgfTsKICB9Cn0pKHRoaXMpOwooZnVuY3Rpb24gKGdsb2JhbCkgewogIHZhciBfaW5HdWFyZCA9IDA7CgogIHZhciBfZ2xvYmFsSGFuZGxlciA9IGZ1bmN0aW9uIG9uRXJyb3IoZSkgewogICAgdGhyb3cgZTsKICB9OwoKICB2YXIgRXJyb3JVdGlscyA9IHsKICAgIHNldEdsb2JhbEhhbmRsZXI6IGZ1bmN0aW9uIHNldEdsb2JhbEhhbmRsZXIoZnVuKSB7CiAgICAgIF9nbG9iYWxIYW5kbGVyID0gZnVuOwogICAgfSwKICAgIGdldEdsb2JhbEhhbmRsZXI6IGZ1bmN0aW9uIGdldEdsb2JhbEhhbmRsZXIoKSB7CiAgICAgIHJldHVybiBfZ2xvYmFsSGFuZGxlcjsKICAgIH0sCiAgICByZXBvcnRFcnJvcjogZnVuY3Rpb24gcmVwb3J0RXJyb3IoZXJyb3IpIHsKICAgICAgX2dsb2JhbEhhbmRsZXIgJiYgX2dsb2JhbEhhbmRsZXIoZXJyb3IpOwogICAgfSwKICAgIHJlcG9ydEZhdGFsRXJyb3I6IGZ1bmN0aW9uIHJlcG9ydEZhdGFsRXJyb3IoZXJyb3IpIHsKICAgICAgX2dsb2JhbEhhbmRsZXIgJiYgX2dsb2JhbEhhbmRsZXIoZXJyb3IsIHRydWUpOwogICAgfSwKICAgIGFwcGx5V2l0aEd1YXJkOiBmdW5jdGlvbiBhcHBseVdpdGhHdWFyZChmdW4sIGNvbnRleHQsIGFyZ3MpIHsKICAgICAgdHJ5IHsKICAgICAgICBfaW5HdWFyZCsrOwogICAgICAgIHJldHVybiBmdW4uYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBFcnJvclV0aWxzLnJlcG9ydEVycm9yKGUpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIF9pbkd1YXJkLS07CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfSwKICAgIGFwcGx5V2l0aEd1YXJkSWZOZWVkZWQ6IGZ1bmN0aW9uIGFwcGx5V2l0aEd1YXJkSWZOZWVkZWQoZnVuLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgIGlmIChFcnJvclV0aWxzLmluR3VhcmQoKSkgewogICAgICAgIHJldHVybiBmdW4uYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgRXJyb3JVdGlscy5hcHBseVdpdGhHdWFyZChmdW4sIGNvbnRleHQsIGFyZ3MpOwogICAgICB9CgogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCiAgICBpbkd1YXJkOiBmdW5jdGlvbiBpbkd1YXJkKCkgewogICAgICByZXR1cm4gX2luR3VhcmQ7CiAgICB9LAogICAgZ3VhcmQ6IGZ1bmN0aW9uIGd1YXJkKGZ1biwgbmFtZSwgY29udGV4dCkgewogICAgICBpZiAodHlwZW9mIGZ1biAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNvbnNvbGUud2FybignQSBmdW5jdGlvbiBtdXN0IGJlIHBhc3NlZCB0byBFcnJvclV0aWxzLmd1YXJkLCBnb3QgJywgZnVuKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgbmFtZSA9IG5hbWUgfHwgZnVuLm5hbWUgfHwgJzxnZW5lcmF0ZWQgZ3VhcmQ+JzsKCiAgICAgIGZ1bmN0aW9uIGd1YXJkZWQoKSB7CiAgICAgICAgcmV0dXJuIEVycm9yVXRpbHMuYXBwbHlXaXRoR3VhcmQoZnVuLCBjb250ZXh0IHx8IHRoaXMsIGFyZ3VtZW50cywgbnVsbCwgbmFtZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBndWFyZGVkOwogICAgfQogIH07CiAgZ2xvYmFsLkVycm9yVXRpbHMgPSBFcnJvclV0aWxzOwp9KSh0aGlzKTsKKGZ1bmN0aW9uIChnbG9iYWwpIHsKICBpZiAoTnVtYmVyLkVQU0lMT04gPT09IHVuZGVmaW5lZCkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE51bWJlciwgJ0VQU0lMT04nLCB7CiAgICAgIHZhbHVlOiBNYXRoLnBvdygyLCAtNTIpCiAgICB9KTsKICB9CgogIGlmIChOdW1iZXIuTUFYX1NBRkVfSU5URUdFUiA9PT0gdW5kZWZpbmVkKSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTnVtYmVyLCAnTUFYX1NBRkVfSU5URUdFUicsIHsKICAgICAgdmFsdWU6IE1hdGgucG93KDIsIDUzKSAtIDEKICAgIH0pOwogIH0KCiAgaWYgKE51bWJlci5NSU5fU0FGRV9JTlRFR0VSID09PSB1bmRlZmluZWQpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShOdW1iZXIsICdNSU5fU0FGRV9JTlRFR0VSJywgewogICAgICB2YWx1ZTogLShNYXRoLnBvdygyLCA1MykgLSAxKQogICAgfSk7CiAgfQoKICBpZiAoIU51bWJlci5pc05hTikgewogICAgdmFyIGdsb2JhbElzTmFOID0gZ2xvYmFsLmlzTmFOOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE51bWJlciwgJ2lzTmFOJywgewogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICB2YWx1ZTogZnVuY3Rpb24gaXNOYU4odmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyAmJiBnbG9iYWxJc05hTih2YWx1ZSk7CiAgICAgIH0sCiAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICB9KTsKICB9Cn0pKHRoaXMpOwooZnVuY3Rpb24gKGdsb2JhbCkgewogIGlmICghU3RyaW5nLnByb3RvdHlwZS5zdGFydHNXaXRoKSB7CiAgICBTdHJpbmcucHJvdG90eXBlLnN0YXJ0c1dpdGggPSBmdW5jdGlvbiAoc2VhcmNoKSB7CiAgICAgICd1c2Ugc3RyaWN0JzsKCiAgICAgIGlmICh0aGlzID09IG51bGwpIHsKICAgICAgICB0aHJvdyBUeXBlRXJyb3IoKTsKICAgICAgfQoKICAgICAgdmFyIHN0cmluZyA9IFN0cmluZyh0aGlzKTsKICAgICAgdmFyIHBvcyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gTnVtYmVyKGFyZ3VtZW50c1sxXSkgfHwgMCA6IDA7CiAgICAgIHZhciBzdGFydCA9IE1hdGgubWluKE1hdGgubWF4KHBvcywgMCksIHN0cmluZy5sZW5ndGgpOwogICAgICByZXR1cm4gc3RyaW5nLmluZGV4T2YoU3RyaW5nKHNlYXJjaCksIHBvcykgPT09IHN0YXJ0OwogICAgfTsKICB9CgogIGlmICghU3RyaW5nLnByb3RvdHlwZS5lbmRzV2l0aCkgewogICAgU3RyaW5nLnByb3RvdHlwZS5lbmRzV2l0aCA9IGZ1bmN0aW9uIChzZWFyY2gpIHsKICAgICAgJ3VzZSBzdHJpY3QnOwoKICAgICAgaWYgKHRoaXMgPT0gbnVsbCkgewogICAgICAgIHRocm93IFR5cGVFcnJvcigpOwogICAgICB9CgogICAgICB2YXIgc3RyaW5nID0gU3RyaW5nKHRoaXMpOwogICAgICB2YXIgc3RyaW5nTGVuZ3RoID0gc3RyaW5nLmxlbmd0aDsKICAgICAgdmFyIHNlYXJjaFN0cmluZyA9IFN0cmluZyhzZWFyY2gpOwogICAgICB2YXIgcG9zID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBOdW1iZXIoYXJndW1lbnRzWzFdKSB8fCAwIDogc3RyaW5nTGVuZ3RoOwogICAgICB2YXIgZW5kID0gTWF0aC5taW4oTWF0aC5tYXgocG9zLCAwKSwgc3RyaW5nTGVuZ3RoKTsKICAgICAgdmFyIHN0YXJ0ID0gZW5kIC0gc2VhcmNoU3RyaW5nLmxlbmd0aDsKCiAgICAgIGlmIChzdGFydCA8IDApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiBzdHJpbmcubGFzdEluZGV4T2Yoc2VhcmNoU3RyaW5nLCBzdGFydCkgPT09IHN0YXJ0OwogICAgfTsKICB9CgogIGlmICghU3RyaW5nLnByb3RvdHlwZS5yZXBlYXQpIHsKICAgIFN0cmluZy5wcm90b3R5cGUucmVwZWF0ID0gZnVuY3Rpb24gKGNvdW50KSB7CiAgICAgICd1c2Ugc3RyaWN0JzsKCiAgICAgIGlmICh0aGlzID09IG51bGwpIHsKICAgICAgICB0aHJvdyBUeXBlRXJyb3IoKTsKICAgICAgfQoKICAgICAgdmFyIHN0cmluZyA9IFN0cmluZyh0aGlzKTsKICAgICAgY291bnQgPSBOdW1iZXIoY291bnQpIHx8IDA7CgogICAgICBpZiAoY291bnQgPCAwIHx8IGNvdW50ID09PSBJbmZpbml0eSkgewogICAgICAgIHRocm93IFJhbmdlRXJyb3IoKTsKICAgICAgfQoKICAgICAgaWYgKGNvdW50ID09PSAxKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgfQoKICAgICAgdmFyIHJlc3VsdCA9ICcnOwoKICAgICAgd2hpbGUgKGNvdW50KSB7CiAgICAgICAgaWYgKGNvdW50ICYgMSkgewogICAgICAgICAgcmVzdWx0ICs9IHN0cmluZzsKICAgICAgICB9CgogICAgICAgIGlmIChjb3VudCA+Pj0gMSkgewogICAgICAgICAgc3RyaW5nICs9IHN0cmluZzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KCiAgaWYgKCFTdHJpbmcucHJvdG90eXBlLmluY2x1ZGVzKSB7CiAgICBTdHJpbmcucHJvdG90eXBlLmluY2x1ZGVzID0gZnVuY3Rpb24gKHNlYXJjaCwgc3RhcnQpIHsKICAgICAgJ3VzZSBzdHJpY3QnOwoKICAgICAgaWYgKHR5cGVvZiBzdGFydCAhPT0gJ251bWJlcicpIHsKICAgICAgICBzdGFydCA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChzdGFydCArIHNlYXJjaC5sZW5ndGggPiB0aGlzLmxlbmd0aCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmRleE9mKHNlYXJjaCwgc3RhcnQpICE9PSAtMTsKICAgICAgfQogICAgfTsKICB9CgogIGlmICghU3RyaW5nLnByb3RvdHlwZS5jb2RlUG9pbnRBdCkgewogICAgU3RyaW5nLnByb3RvdHlwZS5jb2RlUG9pbnRBdCA9IGZ1bmN0aW9uIChwb3NpdGlvbikgewogICAgICBpZiAodGhpcyA9PSBudWxsKSB7CiAgICAgICAgdGhyb3cgVHlwZUVycm9yKCk7CiAgICAgIH0KCiAgICAgIHZhciBzdHJpbmcgPSBTdHJpbmcodGhpcyk7CiAgICAgIHZhciBzaXplID0gc3RyaW5nLmxlbmd0aDsKICAgICAgdmFyIGluZGV4ID0gcG9zaXRpb24gPyBOdW1iZXIocG9zaXRpb24pIDogMDsKCiAgICAgIGlmIChOdW1iZXIuaXNOYU4oaW5kZXgpKSB7CiAgICAgICAgaW5kZXggPSAwOwogICAgICB9CgogICAgICBpZiAoaW5kZXggPCAwIHx8IGluZGV4ID49IHNpemUpIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9CgogICAgICB2YXIgZmlyc3QgPSBzdHJpbmcuY2hhckNvZGVBdChpbmRleCk7CiAgICAgIHZhciBzZWNvbmQ7CgogICAgICBpZiAoZmlyc3QgPj0gMHhkODAwICYmIGZpcnN0IDw9IDB4ZGJmZiAmJiBzaXplID4gaW5kZXggKyAxKSB7CiAgICAgICAgICBzZWNvbmQgPSBzdHJpbmcuY2hhckNvZGVBdChpbmRleCArIDEpOwoKICAgICAgICAgIGlmIChzZWNvbmQgPj0gMHhkYzAwICYmIHNlY29uZCA8PSAweGRmZmYpIHsKICAgICAgICAgICAgcmV0dXJuIChmaXJzdCAtIDB4ZDgwMCkgKiAweDQwMCArIHNlY29uZCAtIDB4ZGMwMCArIDB4MTAwMDA7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgcmV0dXJuIGZpcnN0OwogICAgfTsKICB9Cn0pKHRoaXMpOwooZnVuY3Rpb24gKGdsb2JhbCkgewogIGZ1bmN0aW9uIGZpbmRJbmRleChwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIGlmICh0aGlzID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJyYXkucHJvdG90eXBlLmZpbmRJbmRleCBjYWxsZWQgb24gbnVsbCBvciB1bmRlZmluZWQnKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIHByZWRpY2F0ZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdwcmVkaWNhdGUgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICB9CgogICAgdmFyIGxpc3QgPSBPYmplY3QodGhpcyk7CiAgICB2YXIgbGVuZ3RoID0gbGlzdC5sZW5ndGggPj4+IDA7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBpZiAocHJlZGljYXRlLmNhbGwoY29udGV4dCwgbGlzdFtpXSwgaSwgbGlzdCkpIHsKICAgICAgICByZXR1cm4gaTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiAtMTsKICB9CgogIGlmICghQXJyYXkucHJvdG90eXBlLmZpbmRJbmRleCkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEFycmF5LnByb3RvdHlwZSwgJ2ZpbmRJbmRleCcsIHsKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIHZhbHVlOiBmaW5kSW5kZXgKICAgIH0pOwogIH0KCiAgaWYgKCFBcnJheS5wcm90b3R5cGUuZmluZCkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEFycmF5LnByb3RvdHlwZSwgJ2ZpbmQnLCB7CiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUocHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKHRoaXMgPT0gbnVsbCkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJyYXkucHJvdG90eXBlLmZpbmQgY2FsbGVkIG9uIG51bGwgb3IgdW5kZWZpbmVkJyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgaW5kZXggPSBmaW5kSW5kZXguY2FsbCh0aGlzLCBwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgICAgIHJldHVybiBpbmRleCA9PT0gLTEgPyB1bmRlZmluZWQgOiB0aGlzW2luZGV4XTsKICAgICAgfQogICAgfSk7CiAgfQoKICBpZiAoIUFycmF5LnByb3RvdHlwZS5pbmNsdWRlcykgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEFycmF5LnByb3RvdHlwZSwgJ2luY2x1ZGVzJywgewogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKHNlYXJjaEVsZW1lbnQpIHsKICAgICAgICB2YXIgTyA9IE9iamVjdCh0aGlzKTsKICAgICAgICB2YXIgbGVuID0gcGFyc2VJbnQoTy5sZW5ndGgpIHx8IDA7CgogICAgICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciBuID0gcGFyc2VJbnQoYXJndW1lbnRzWzFdKSB8fCAwOwogICAgICAgIHZhciBrOwoKICAgICAgICBpZiAobiA+PSAwKSB7CiAgICAgICAgICBrID0gbjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgayA9IGxlbiArIG47CgogICAgICAgICAgaWYgKGsgPCAwKSB7CiAgICAgICAgICAgIGsgPSAwOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGN1cnJlbnRFbGVtZW50OwoKICAgICAgICB3aGlsZSAoayA8IGxlbikgewogICAgICAgICAgY3VycmVudEVsZW1lbnQgPSBPW2tdOwoKICAgICAgICAgIGlmIChzZWFyY2hFbGVtZW50ID09PSBjdXJyZW50RWxlbWVudCB8fCBzZWFyY2hFbGVtZW50ICE9PSBzZWFyY2hFbGVtZW50ICYmIGN1cnJlbnRFbGVtZW50ICE9PSBjdXJyZW50RWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBrKys7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0pOwogIH0KfSkodGhpcyk7CihmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgaWYgKCFBcnJheS5mcm9tKSB7CiAgICBBcnJheS5mcm9tID0gZnVuY3Rpb24gKGFycmF5TGlrZSkgewogICAgICBpZiAoYXJyYXlMaWtlID09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdPYmplY3QgaXMgbnVsbCBvciB1bmRlZmluZWQnKTsKICAgICAgfQoKICAgICAgdmFyIG1hcEZuID0gYXJndW1lbnRzWzFdOwogICAgICB2YXIgdGhpc0FyZyA9IGFyZ3VtZW50c1syXTsKICAgICAgdmFyIEMgPSB0aGlzOwogICAgICB2YXIgaXRlbXMgPSBPYmplY3QoYXJyYXlMaWtlKTsKICAgICAgdmFyIHN5bWJvbEl0ZXJhdG9yID0gdHlwZW9mIFN5bWJvbCA9PT0gJ2Z1bmN0aW9uJyA/IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciIgOiAnQEBpdGVyYXRvcic7CiAgICAgIHZhciBtYXBwaW5nID0gdHlwZW9mIG1hcEZuID09PSAnZnVuY3Rpb24nOwogICAgICB2YXIgdXNpbmdJdGVyYXRvciA9IHR5cGVvZiBpdGVtc1tzeW1ib2xJdGVyYXRvcl0gPT09ICdmdW5jdGlvbic7CiAgICAgIHZhciBrZXkgPSAwOwogICAgICB2YXIgcmV0OwogICAgICB2YXIgdmFsdWU7CgogICAgICBpZiAodXNpbmdJdGVyYXRvcikgewogICAgICAgIHJldCA9IHR5cGVvZiBDID09PSAnZnVuY3Rpb24nID8gbmV3IEMoKSA6IFtdOwogICAgICAgIHZhciBpdCA9IGl0ZW1zW3N5bWJvbEl0ZXJhdG9yXSgpOwogICAgICAgIHZhciBuZXh0OwoKICAgICAgICB3aGlsZSAoIShuZXh0ID0gaXQubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICB2YWx1ZSA9IG5leHQudmFsdWU7CgogICAgICAgICAgaWYgKG1hcHBpbmcpIHsKICAgICAgICAgICAgdmFsdWUgPSBtYXBGbi5jYWxsKHRoaXNBcmcsIHZhbHVlLCBrZXkpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldFtrZXldID0gdmFsdWU7CiAgICAgICAgICBrZXkgKz0gMTsKICAgICAgICB9CgogICAgICAgIHJldC5sZW5ndGggPSBrZXk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfQoKICAgICAgdmFyIGxlbiA9IGl0ZW1zLmxlbmd0aDsKCiAgICAgIGlmIChpc05hTihsZW4pIHx8IGxlbiA8IDApIHsKICAgICAgICBsZW4gPSAwOwogICAgICB9CgogICAgICByZXQgPSB0eXBlb2YgQyA9PT0gJ2Z1bmN0aW9uJyA/IG5ldyBDKGxlbikgOiBuZXcgQXJyYXkobGVuKTsKCiAgICAgIHdoaWxlIChrZXkgPCBsZW4pIHsKICAgICAgICB2YWx1ZSA9IGl0ZW1zW2tleV07CgogICAgICAgIGlmIChtYXBwaW5nKSB7CiAgICAgICAgICB2YWx1ZSA9IG1hcEZuLmNhbGwodGhpc0FyZywgdmFsdWUsIGtleSk7CiAgICAgICAgfQoKICAgICAgICByZXRba2V5XSA9IHZhbHVlOwogICAgICAgIGtleSArPSAxOwogICAgICB9CgogICAgICByZXQubGVuZ3RoID0ga2V5OwogICAgICByZXR1cm4gcmV0OwogICAgfTsKICB9Cn0pKHRoaXMpOwooZnVuY3Rpb24gKGdsb2JhbCkgewogIChmdW5jdGlvbiAoKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCiAgICBpZiAodHlwZW9mIE9iamVjdC5lbnRyaWVzICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIE9iamVjdC5lbnRyaWVzID0gZnVuY3Rpb24gKG9iamVjdCkgewogICAgICAgIGlmIChvYmplY3QgPT0gbnVsbCkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignT2JqZWN0LmVudHJpZXMgY2FsbGVkIG9uIG5vbi1vYmplY3QnKTsKICAgICAgICB9CgogICAgICAgIHZhciBlbnRyaWVzID0gW107CgogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgewogICAgICAgICAgICBlbnRyaWVzLnB1c2goW2tleSwgb2JqZWN0W2tleV1dKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBlbnRyaWVzOwogICAgICB9OwogICAgfQoKICAgIGlmICh0eXBlb2YgT2JqZWN0LnZhbHVlcyAhPT0gJ2Z1bmN0aW9uJykgewogICAgICBPYmplY3QudmFsdWVzID0gZnVuY3Rpb24gKG9iamVjdCkgewogICAgICAgIGlmIChvYmplY3QgPT0gbnVsbCkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignT2JqZWN0LnZhbHVlcyBjYWxsZWQgb24gbm9uLW9iamVjdCcpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHZhbHVlcyA9IFtdOwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHsKICAgICAgICAgICAgdmFsdWVzLnB1c2gob2JqZWN0W2tleV0pOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgfTsKICAgIH0KICB9KSgpOwp9KSh0aGlzKTsKKGZ1bmN0aW9uIChnbG9iYWwpIHsKICB2YXIgYmFiZWxIZWxwZXJzID0gZ2xvYmFsLmJhYmVsSGVscGVycyA9IHt9OwogIGJhYmVsSGVscGVycy50eXBlb2YgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5pdGVyYXRvciA6ICJAQGl0ZXJhdG9yIikgPT09ICJzeW1ib2wiID8gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIHR5cGVvZiBvYmo7CiAgfSA6IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBvYmogJiYgdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBvYmouY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvYmogIT09ICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLnByb3RvdHlwZSA6ICJAQHByb3RvdHlwZSIpID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOwogIH07CgogIGJhYmVsSGVscGVycy5jcmVhdGVSYXdSZWFjdEVsZW1lbnQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5mb3IgOiAiQEBmb3IiKSAmJiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5mb3IgOiAiQEBmb3IiKSgicmVhY3QuZWxlbWVudCIpIHx8IDB4ZWFjNzsKICAgIHJldHVybiBmdW5jdGlvbiBjcmVhdGVSYXdSZWFjdEVsZW1lbnQodHlwZSwga2V5LCBwcm9wcykgewogICAgICByZXR1cm4gewogICAgICAgICQkdHlwZW9mOiBSRUFDVF9FTEVNRU5UX1RZUEUsCiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBrZXk6IGtleSwKICAgICAgICByZWY6IG51bGwsCiAgICAgICAgcHJvcHM6IHByb3BzLAogICAgICAgIF9vd25lcjogbnVsbAogICAgICB9OwogICAgfTsKICB9KCk7CgogIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayA9IGZ1bmN0aW9uIChpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsKICAgIGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOwogICAgfQogIH07CgogIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsKICAgICAgICBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7CiAgICAgICAgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOwogICAgICAgIGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICAgIGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CiAgICAgIGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOwogICAgICByZXR1cm4gQ29uc3RydWN0b3I7CiAgICB9OwogIH0oKTsKCiAgYmFiZWxIZWxwZXJzLmRlZmluZUVudW1lcmFibGVQcm9wZXJ0aWVzID0gZnVuY3Rpb24gKG9iaiwgZGVzY3MpIHsKICAgIGZvciAodmFyIGtleSBpbiBkZXNjcykgewogICAgICB2YXIgZGVzYyA9IGRlc2NzW2tleV07CiAgICAgIGRlc2MuY29uZmlndXJhYmxlID0gZGVzYy5lbnVtZXJhYmxlID0gdHJ1ZTsKICAgICAgaWYgKCd2YWx1ZScgaW4gZGVzYykgZGVzYy53cml0YWJsZSA9IHRydWU7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgZGVzYyk7CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9OwoKICBiYWJlbEhlbHBlcnMuZGVmaW5lUHJvcGVydHkgPSBmdW5jdGlvbiAob2JqLCBrZXksIHZhbHVlKSB7CiAgICBpZiAoa2V5IGluIG9iaikgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBvYmpba2V5XSA9IHZhbHVlOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgYmFiZWxIZWxwZXJzLl9leHRlbmRzID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMgPSBPYmplY3QuYXNzaWduIHx8IGZ1bmN0aW9uICh0YXJnZXQpIHsKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV07CgogICAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIGtleSkpIHsKICAgICAgICAgIHRhcmdldFtrZXldID0gc291cmNlW2tleV07CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRhcmdldDsKICB9OwoKICBiYWJlbEhlbHBlcnMuZ2V0ID0gZnVuY3Rpb24gZ2V0KG9iamVjdCwgcHJvcGVydHksIHJlY2VpdmVyKSB7CiAgICBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7CiAgICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBwcm9wZXJ0eSk7CgogICAgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgewogICAgICB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7CgogICAgICBpZiAocGFyZW50ID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZ2V0KHBhcmVudCwgcHJvcGVydHksIHJlY2VpdmVyKTsKICAgICAgfQogICAgfSBlbHNlIGlmICgidmFsdWUiIGluIGRlc2MpIHsKICAgICAgcmV0dXJuIGRlc2MudmFsdWU7CiAgICB9IGVsc2UgewogICAgICB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7CgogICAgICBpZiAoZ2V0dGVyID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9CgogICAgICByZXR1cm4gZ2V0dGVyLmNhbGwocmVjZWl2ZXIpOwogICAgfQogIH07CgogIGJhYmVsSGVscGVycy5pbmhlcml0cyA9IGZ1bmN0aW9uIChzdWJDbGFzcywgc3VwZXJDbGFzcykgewogICAgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAiZnVuY3Rpb24iICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAiICsgdHlwZW9mIHN1cGVyQ2xhc3MpOwogICAgfQoKICAgIHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgewogICAgICBjb25zdHJ1Y3RvcjogewogICAgICAgIHZhbHVlOiBzdWJDbGFzcywKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfQogICAgfSk7CiAgICBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7CiAgfTsKCiAgYmFiZWxIZWxwZXJzLmludGVyb3BSZXF1aXJlRGVmYXVsdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7CiAgICAgIGRlZmF1bHQ6IG9iagogICAgfTsKICB9OwoKICBiYWJlbEhlbHBlcnMuaW50ZXJvcFJlcXVpcmVXaWxkY2FyZCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGlmIChvYmogJiYgb2JqLl9fZXNNb2R1bGUpIHsKICAgICAgcmV0dXJuIG9iajsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBuZXdPYmogPSB7fTsKCiAgICAgIGlmIChvYmogIT0gbnVsbCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSBuZXdPYmpba2V5XSA9IG9ialtrZXldOwogICAgICAgIH0KICAgICAgfQoKICAgICAgbmV3T2JqLmRlZmF1bHQgPSBvYmo7CiAgICAgIHJldHVybiBuZXdPYmo7CiAgICB9CiAgfTsKCiAgYmFiZWxIZWxwZXJzLm9iamVjdFdpdGhvdXRQcm9wZXJ0aWVzID0gZnVuY3Rpb24gKG9iaiwga2V5cykgewogICAgdmFyIHRhcmdldCA9IHt9OwoKICAgIGZvciAodmFyIGkgaW4gb2JqKSB7CiAgICAgIGlmIChrZXlzLmluZGV4T2YoaSkgPj0gMCkgY29udGludWU7CiAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgaSkpIGNvbnRpbnVlOwogICAgICB0YXJnZXRbaV0gPSBvYmpbaV07CiAgICB9CgogICAgcmV0dXJuIHRhcmdldDsKICB9OwoKICBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybiA9IGZ1bmN0aW9uIChzZWxmLCBjYWxsKSB7CiAgICBpZiAoIXNlbGYpIHsKICAgICAgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJ0aGlzIGhhc24ndCBiZWVuIGluaXRpYWxpc2VkIC0gc3VwZXIoKSBoYXNuJ3QgYmVlbiBjYWxsZWQiKTsKICAgIH0KCiAgICByZXR1cm4gY2FsbCAmJiAodHlwZW9mIGNhbGwgPT09ICJvYmplY3QiIHx8IHR5cGVvZiBjYWxsID09PSAiZnVuY3Rpb24iKSA/IGNhbGwgOiBzZWxmOwogIH07CgogIGJhYmVsSGVscGVycy5zbGljZWRUb0FycmF5ID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gc2xpY2VJdGVyYXRvcihhcnIsIGkpIHsKICAgICAgdmFyIF9hcnIgPSBbXTsKICAgICAgdmFyIF9uID0gdHJ1ZTsKICAgICAgdmFyIF9kID0gZmFsc2U7CiAgICAgIHZhciBfZSA9IHVuZGVmaW5lZDsKCiAgICAgIHRyeSB7CiAgICAgICAgZm9yICh2YXIgX2kgPSBhcnJbdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5pdGVyYXRvciA6ICJAQGl0ZXJhdG9yIl0oKSwgX3M7ICEoX24gPSAoX3MgPSBfaS5uZXh0KCkpLmRvbmUpOyBfbiA9IHRydWUpIHsKICAgICAgICAgIF9hcnIucHVzaChfcy52YWx1ZSk7CgogICAgICAgICAgaWYgKGkgJiYgX2Fyci5sZW5ndGggPT09IGkpIGJyZWFrOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2QgPSB0cnVlOwogICAgICAgIF9lID0gZXJyOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIV9uICYmIF9pWyJyZXR1cm4iXSkgX2lbInJldHVybiJdKCk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChfZCkgdGhyb3cgX2U7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gX2FycjsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gKGFyciwgaSkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICAgICAgcmV0dXJuIGFycjsKICAgICAgfSBlbHNlIGlmICgodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5pdGVyYXRvciA6ICJAQGl0ZXJhdG9yIikgaW4gT2JqZWN0KGFycikpIHsKICAgICAgICByZXR1cm4gc2xpY2VJdGVyYXRvcihhcnIsIGkpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgYXR0ZW1wdCB0byBkZXN0cnVjdHVyZSBub24taXRlcmFibGUgaW5zdGFuY2UiKTsKICAgICAgfQogICAgfTsKICB9KCk7CgogIGJhYmVsSGVscGVycy50YWdnZWRUZW1wbGF0ZUxpdGVyYWwgPSBmdW5jdGlvbiAoc3RyaW5ncywgcmF3KSB7CiAgICByZXR1cm4gT2JqZWN0LmZyZWV6ZShPYmplY3QuZGVmaW5lUHJvcGVydGllcyhzdHJpbmdzLCB7CiAgICAgIHJhdzogewogICAgICAgIHZhbHVlOiBPYmplY3QuZnJlZXplKHJhdykKICAgICAgfQogICAgfSkpOwogIH07CgogIGJhYmVsSGVscGVycy50b0FycmF5ID0gZnVuY3Rpb24gKGFycikgewogICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoYXJyKSA/IGFyciA6IEFycmF5LmZyb20oYXJyKTsKICB9OwoKICBiYWJlbEhlbHBlcnMudG9Db25zdW1hYmxlQXJyYXkgPSBmdW5jdGlvbiAoYXJyKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhcnIyID0gQXJyYXkoYXJyLmxlbmd0aCk7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICBhcnIyW2ldID0gYXJyW2ldOwogICAgICB9CgogICAgICByZXR1cm4gYXJyMjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBBcnJheS5mcm9tKGFycik7CiAgICB9CiAgfTsKfSkodGhpcyk7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgdmFyIF9yZWFjdE5hdGl2ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJyZWFjdC1uYXRpdmUiKTsKCiAgdmFyIF9yZWFjdE5hdGl2ZTIgPSBiYWJlbEhlbHBlcnMuaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9yZWFjdE5hdGl2ZSk7CgogIHZhciBfQXBwID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIi4vQXBwIik7CgogIHZhciBfQXBwMiA9IGJhYmVsSGVscGVycy5pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0FwcCk7CgogIHZhciBBUFBfTkFNRSA9ICdUZXh0VGVzdCc7CiAgdmFyIFJPT1RfVEFHID0gdHlwZW9mIGdldFJvb3RUYWcgPT09ICdmdW5jdGlvbicgPyBnZXRSb290VGFnKCkgOiAxMDE7CiAgY29uc29sZS53YXJuKCdzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3MnKTsKCiAgX3JlYWN0TmF0aXZlLkFwcFJlZ2lzdHJ5LnJlZ2lzdGVyQ29tcG9uZW50KEFQUF9OQU1FLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gX0FwcDIuZGVmYXVsdDsKICB9KTsKCiAgX3JlYWN0TmF0aXZlLkFwcFJlZ2lzdHJ5LnJ1bkFwcGxpY2F0aW9uKEFQUF9OQU1FLCB7CiAgICByb290VGFnOiBST09UX1RBRwogIH0pOwp9LDExLFsxMiwzMzNdLCJUZXh0VGVzdC9pbmRleC5lbWJlZGRlZC5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIFJlYWN0TmF0aXZlID0gewogICAgZ2V0IEFjY2Vzc2liaWxpdHlJbmZvKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkFjY2Vzc2liaWxpdHlJbmZvIik7CiAgICB9LAoKICAgIGdldCBBY3Rpdml0eUluZGljYXRvcigpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJBY3Rpdml0eUluZGljYXRvciIpOwogICAgfSwKCiAgICBnZXQgQVJUKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlJlYWN0TmF0aXZlQVJUIik7CiAgICB9LAoKICAgIGdldCBCdXR0b24oKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiQnV0dG9uIik7CiAgICB9LAoKICAgIGdldCBDaGVja0JveCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJDaGVja0JveCIpOwogICAgfSwKCiAgICBnZXQgRGF0ZVBpY2tlcklPUygpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJEYXRlUGlja2VySU9TIik7CiAgICB9LAoKICAgIGdldCBEcmF3ZXJMYXlvdXRBbmRyb2lkKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgIkRyYXdlckxheW91dEFuZHJvaWQiKTsKICAgIH0sCgogICAgZ2V0IEZsYXRMaXN0KCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4XSwgIkZsYXRMaXN0Iik7CiAgICB9LAoKICAgIGdldCBJbWFnZSgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOV0sICJJbWFnZSIpOwogICAgfSwKCiAgICBnZXQgSW1hZ2VCYWNrZ3JvdW5kKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMF0sICJJbWFnZUJhY2tncm91bmQiKTsKICAgIH0sCgogICAgZ2V0IEltYWdlRWRpdG9yKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMV0sICJJbWFnZUVkaXRvciIpOwogICAgfSwKCiAgICBnZXQgSW1hZ2VTdG9yZSgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTJdLCAiSW1hZ2VTdG9yZSIpOwogICAgfSwKCiAgICBnZXQgS2V5Ym9hcmRBdm9pZGluZ1ZpZXcoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEzXSwgIktleWJvYXJkQXZvaWRpbmdWaWV3Iik7CiAgICB9LAoKICAgIGdldCBMaXN0VmlldygpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTRdLCAiTGlzdFZpZXciKTsKICAgIH0sCgogICAgZ2V0IE1hc2tlZFZpZXdJT1MoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE1XSwgIk1hc2tlZFZpZXdJT1MiKTsKICAgIH0sCgogICAgZ2V0IE1vZGFsKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxNl0sICJNb2RhbCIpOwogICAgfSwKCiAgICBnZXQgTmF2aWdhdG9ySU9TKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxN10sICJOYXZpZ2F0b3JJT1MiKTsKICAgIH0sCgogICAgZ2V0IFBpY2tlcigpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMThdLCAiUGlja2VyIik7CiAgICB9LAoKICAgIGdldCBQaWNrZXJJT1MoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE5XSwgIlBpY2tlcklPUyIpOwogICAgfSwKCiAgICBnZXQgUHJvZ3Jlc3NCYXJBbmRyb2lkKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyMF0sICJQcm9ncmVzc0JhckFuZHJvaWQiKTsKICAgIH0sCgogICAgZ2V0IFByb2dyZXNzVmlld0lPUygpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMjFdLCAiUHJvZ3Jlc3NWaWV3SU9TIik7CiAgICB9LAoKICAgIGdldCBTYWZlQXJlYVZpZXcoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzIyXSwgIlNhZmVBcmVhVmlldyIpOwogICAgfSwKCiAgICBnZXQgU2Nyb2xsVmlldygpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMjNdLCAiU2Nyb2xsVmlldyIpOwogICAgfSwKCiAgICBnZXQgU2VjdGlvbkxpc3QoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzI0XSwgIlNlY3Rpb25MaXN0Iik7CiAgICB9LAoKICAgIGdldCBTZWdtZW50ZWRDb250cm9sSU9TKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyNV0sICJTZWdtZW50ZWRDb250cm9sSU9TIik7CiAgICB9LAoKICAgIGdldCBTbGlkZXIoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzI2XSwgIlNsaWRlciIpOwogICAgfSwKCiAgICBnZXQgU25hcHNob3RWaWV3SU9TKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyN10sICJTbmFwc2hvdFZpZXdJT1MiKTsKICAgIH0sCgogICAgZ2V0IFN3aXRjaCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMjhdLCAiU3dpdGNoIik7CiAgICB9LAoKICAgIGdldCBSZWZyZXNoQ29udHJvbCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMjldLCAiUmVmcmVzaENvbnRyb2wiKTsKICAgIH0sCgogICAgZ2V0IFN0YXR1c0JhcigpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMzBdLCAiU3RhdHVzQmFyIik7CiAgICB9LAoKICAgIGdldCBTd2lwZWFibGVGbGF0TGlzdCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMzFdLCAiU3dpcGVhYmxlRmxhdExpc3QiKTsKICAgIH0sCgogICAgZ2V0IFN3aXBlYWJsZUxpc3RWaWV3KCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszMl0sICJTd2lwZWFibGVMaXN0VmlldyIpOwogICAgfSwKCiAgICBnZXQgVGFiQmFySU9TKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszM10sICJUYWJCYXJJT1MiKTsKICAgIH0sCgogICAgZ2V0IFRleHQoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzM0XSwgIlRleHQiKTsKICAgIH0sCgogICAgZ2V0IFRleHRJbnB1dCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMzVdLCAiVGV4dElucHV0Iik7CiAgICB9LAoKICAgIGdldCBUb2FzdEFuZHJvaWQoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzM2XSwgIlRvYXN0QW5kcm9pZCIpOwogICAgfSwKCiAgICBnZXQgVG9vbGJhckFuZHJvaWQoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzM3XSwgIlRvb2xiYXJBbmRyb2lkIik7CiAgICB9LAoKICAgIGdldCBUb3VjaGFibGUoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzM4XSwgIlRvdWNoYWJsZSIpOwogICAgfSwKCiAgICBnZXQgVG91Y2hhYmxlSGlnaGxpZ2h0KCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszOV0sICJUb3VjaGFibGVIaWdobGlnaHQiKTsKICAgIH0sCgogICAgZ2V0IFRvdWNoYWJsZU5hdGl2ZUZlZWRiYWNrKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0MF0sICJUb3VjaGFibGVOYXRpdmVGZWVkYmFjayIpOwogICAgfSwKCiAgICBnZXQgVG91Y2hhYmxlT3BhY2l0eSgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNDFdLCAiVG91Y2hhYmxlT3BhY2l0eSIpOwogICAgfSwKCiAgICBnZXQgVG91Y2hhYmxlV2l0aG91dEZlZWRiYWNrKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0Ml0sICJUb3VjaGFibGVXaXRob3V0RmVlZGJhY2siKTsKICAgIH0sCgogICAgZ2V0IFZpZXcoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzQzXSwgIlZpZXciKTsKICAgIH0sCgogICAgZ2V0IFZpZXdQYWdlckFuZHJvaWQoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzQ0XSwgIlZpZXdQYWdlckFuZHJvaWQiKTsKICAgIH0sCgogICAgZ2V0IFZpcnR1YWxpemVkTGlzdCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNDVdLCAiVmlydHVhbGl6ZWRMaXN0Iik7CiAgICB9LAoKICAgIGdldCBXZWJWaWV3KCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0Nl0sICJXZWJWaWV3Iik7CiAgICB9LAoKICAgIGdldCBBY3Rpb25TaGVldElPUygpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNDddLCAiQWN0aW9uU2hlZXRJT1MiKTsKICAgIH0sCgogICAgZ2V0IEFsZXJ0KCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0OF0sICJBbGVydCIpOwogICAgfSwKCiAgICBnZXQgQWxlcnRJT1MoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzQ5XSwgIkFsZXJ0SU9TIik7CiAgICB9LAoKICAgIGdldCBBbmltYXRlZCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNTBdLCAiQW5pbWF0ZWQiKTsKICAgIH0sCgogICAgZ2V0IEFwcFJlZ2lzdHJ5KCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1MV0sICJBcHBSZWdpc3RyeSIpOwogICAgfSwKCiAgICBnZXQgQXBwU3RhdGUoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzUyXSwgIkFwcFN0YXRlIik7CiAgICB9LAoKICAgIGdldCBBc3luY1N0b3JhZ2UoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzUzXSwgIkFzeW5jU3RvcmFnZSIpOwogICAgfSwKCiAgICBnZXQgQmFja0FuZHJvaWQoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzU0XSwgIkJhY2tBbmRyb2lkIik7CiAgICB9LAoKICAgIGdldCBCYWNrSGFuZGxlcigpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNTVdLCAiQmFja0hhbmRsZXIiKTsKICAgIH0sCgogICAgZ2V0IENhbWVyYVJvbGwoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzU2XSwgIkNhbWVyYVJvbGwiKTsKICAgIH0sCgogICAgZ2V0IENsaXBib2FyZCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNTddLCAiQ2xpcGJvYXJkIik7CiAgICB9LAoKICAgIGdldCBEYXRlUGlja2VyQW5kcm9pZCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNThdLCAiRGF0ZVBpY2tlckFuZHJvaWQiKTsKICAgIH0sCgogICAgZ2V0IERldmljZUluZm8oKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzU5XSwgIkRldmljZUluZm8iKTsKICAgIH0sCgogICAgZ2V0IERpbWVuc2lvbnMoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzYwXSwgIkRpbWVuc2lvbnMiKTsKICAgIH0sCgogICAgZ2V0IEVhc2luZygpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNjFdLCAiRWFzaW5nIik7CiAgICB9LAoKICAgIGdldCBmaW5kTm9kZUhhbmRsZSgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNjJdLCAiUmVhY3ROYXRpdmUiKS5maW5kTm9kZUhhbmRsZTsKICAgIH0sCgogICAgZ2V0IEkxOG5NYW5hZ2VyKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2M10sICJJMThuTWFuYWdlciIpOwogICAgfSwKCiAgICBnZXQgSW1hZ2VQaWNrZXJJT1MoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzY0XSwgIkltYWdlUGlja2VySU9TIik7CiAgICB9LAoKICAgIGdldCBJbnRlcmFjdGlvbk1hbmFnZXIoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzY1XSwgIkludGVyYWN0aW9uTWFuYWdlciIpOwogICAgfSwKCiAgICBnZXQgS2V5Ym9hcmQoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzY2XSwgIktleWJvYXJkIik7CiAgICB9LAoKICAgIGdldCBMYXlvdXRBbmltYXRpb24oKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzY3XSwgIkxheW91dEFuaW1hdGlvbiIpOwogICAgfSwKCiAgICBnZXQgTGlua2luZygpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNjhdLCAiTGlua2luZyIpOwogICAgfSwKCiAgICBnZXQgTmF0aXZlRXZlbnRFbWl0dGVyKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2OV0sICJOYXRpdmVFdmVudEVtaXR0ZXIiKTsKICAgIH0sCgogICAgZ2V0IE5ldEluZm8oKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzcwXSwgIk5ldEluZm8iKTsKICAgIH0sCgogICAgZ2V0IFBhblJlc3BvbmRlcigpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNzFdLCAiUGFuUmVzcG9uZGVyIik7CiAgICB9LAoKICAgIGdldCBQZXJtaXNzaW9uc0FuZHJvaWQoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzcyXSwgIlBlcm1pc3Npb25zQW5kcm9pZCIpOwogICAgfSwKCiAgICBnZXQgUGl4ZWxSYXRpbygpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNzNdLCAiUGl4ZWxSYXRpbyIpOwogICAgfSwKCiAgICBnZXQgUHVzaE5vdGlmaWNhdGlvbklPUygpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNzRdLCAiUHVzaE5vdGlmaWNhdGlvbklPUyIpOwogICAgfSwKCiAgICBnZXQgU2V0dGluZ3MoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzc1XSwgIlNldHRpbmdzIik7CiAgICB9LAoKICAgIGdldCBTaGFyZSgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNzZdLCAiU2hhcmUiKTsKICAgIH0sCgogICAgZ2V0IFN0YXR1c0JhcklPUygpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNzddLCAiU3RhdHVzQmFySU9TIik7CiAgICB9LAoKICAgIGdldCBTdHlsZVNoZWV0KCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3OF0sICJTdHlsZVNoZWV0Iik7CiAgICB9LAoKICAgIGdldCBTeXN0cmFjZSgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNzldLCAiU3lzdHJhY2UiKTsKICAgIH0sCgogICAgZ2V0IFRpbWVQaWNrZXJBbmRyb2lkKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4MF0sICJUaW1lUGlja2VyQW5kcm9pZCIpOwogICAgfSwKCiAgICBnZXQgVFZFdmVudEhhbmRsZXIoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzgxXSwgIlRWRXZlbnRIYW5kbGVyIik7CiAgICB9LAoKICAgIGdldCBVSU1hbmFnZXIoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzgyXSwgIlVJTWFuYWdlciIpOwogICAgfSwKCiAgICBnZXQgdW5zdGFibGVfYmF0Y2hlZFVwZGF0ZXMoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzYyXSwgIlJlYWN0TmF0aXZlIikudW5zdGFibGVfYmF0Y2hlZFVwZGF0ZXM7CiAgICB9LAoKICAgIGdldCBWaWJyYXRpb24oKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzgzXSwgIlZpYnJhdGlvbiIpOwogICAgfSwKCiAgICBnZXQgVmlicmF0aW9uSU9TKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4NF0sICJWaWJyYXRpb25JT1MiKTsKICAgIH0sCgogICAgZ2V0IFllbGxvd0JveCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbODVdLCAiWWVsbG93Qm94Iik7CiAgICB9LAoKICAgIGdldCBEZXZpY2VFdmVudEVtaXR0ZXIoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzg2XSwgIlJDVERldmljZUV2ZW50RW1pdHRlciIpOwogICAgfSwKCiAgICBnZXQgTmF0aXZlQXBwRXZlbnRFbWl0dGVyKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4N10sICJSQ1ROYXRpdmVBcHBFdmVudEVtaXR0ZXIiKTsKICAgIH0sCgogICAgZ2V0IE5hdGl2ZU1vZHVsZXMoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzg4XSwgIk5hdGl2ZU1vZHVsZXMiKTsKICAgIH0sCgogICAgZ2V0IFBsYXRmb3JtKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4OV0sICJQbGF0Zm9ybSIpOwogICAgfSwKCiAgICBnZXQgcHJvY2Vzc0NvbG9yKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs5MF0sICJwcm9jZXNzQ29sb3IiKTsKICAgIH0sCgogICAgZ2V0IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzkxXSwgInJlcXVpcmVOYXRpdmVDb21wb25lbnQiKTsKICAgIH0sCgogICAgZ2V0IHRha2VTbmFwc2hvdCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOTJdLCAidGFrZVNuYXBzaG90Iik7CiAgICB9LAoKICAgIGdldCBDb2xvclByb3BUeXBlKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs5M10sICJDb2xvclByb3BUeXBlIik7CiAgICB9LAoKICAgIGdldCBFZGdlSW5zZXRzUHJvcFR5cGUoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzk0XSwgIkVkZ2VJbnNldHNQcm9wVHlwZSIpOwogICAgfSwKCiAgICBnZXQgUG9pbnRQcm9wVHlwZSgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOTVdLCAiUG9pbnRQcm9wVHlwZSIpOwogICAgfSwKCiAgICBnZXQgVmlld1Byb3BUeXBlcygpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOTZdLCAiVmlld1Byb3BUeXBlcyIpOwogICAgfSwKCiAgICBnZXQgTmF2aWdhdG9yKCkgewogICAgICBpbnZhcmlhbnQoZmFsc2UsICdOYXZpZ2F0b3IgaXMgZGVwcmVjYXRlZCBhbmQgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tIHRoaXMgcGFja2FnZS4gSXQgY2FuIG5vdyBiZSBpbnN0YWxsZWQgJyArICdhbmQgaW1wb3J0ZWQgZnJvbSBgcmVhY3QtbmF0aXZlLWRlcHJlY2F0ZWQtY3VzdG9tLWNvbXBvbmVudHNgIGluc3RlYWQgb2YgYHJlYWN0LW5hdGl2ZWAuICcgKyAnTGVhcm4gYWJvdXQgYWx0ZXJuYXRpdmUgbmF2aWdhdGlvbiBzb2x1dGlvbnMgYXQgaHR0cDovL2ZhY2Vib29rLmdpdGh1Yi5pby9yZWFjdC1uYXRpdmUvZG9jcy9uYXZpZ2F0aW9uLmh0bWwnKTsKICAgIH0KCiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IFJlYWN0TmF0aXZlOwp9LDEyLFsxMywxNCwxMjIsMTc0LDE4MCwyMzUsMjM2LDIzNywyMzksMjIyLDI1MiwyNTQsMjU1LDI1NiwyNDEsMjU4LDI2MCwyODEsMjgyLDI4MywxMjYsMjg1LDI3OSwyMjQsMjg2LDI4OCwyODksMjkwLDI5MSwyNDYsMjM4LDI5MiwyOTYsMjk4LDE4MSwzMDAsOTcsMzA3LDE4MiwyNzEsMTg5LDE5MywxOTAsMTcwLDMwOCwyNDcsMzA5LDMxMCw4NCw4NSwxOTQsMzExLDk5LDMxNywzMTgsMzE2LDMxOSwzMjAsMzIxLDE2NSwxNjQsMjE5LDIxLDI4MCwzMjIsMjAyLDIyOCwyNTcsMzIzLDY5LDMyNCwyOTQsODgsMTYzLDMyNSwzMjYsMzI3LDMyOCwxNjgsMTksMzI5LDE4NiwxMDcsMzMwLDMzMSwyNzgsNzAsOTIsMTUsNTIsMTUyLDE0NSwzMzIsMTIzLDEzMiwyMjUsMTMxXSwicmVhY3QtbmF0aXZlLWltcGxlbWVudGF0aW9uIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgdmFsaWRhdGVGb3JtYXQgPSBmdW5jdGlvbiB2YWxpZGF0ZUZvcm1hdChmb3JtYXQpIHt9OwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgdmFsaWRhdGVGb3JtYXQgPSBmdW5jdGlvbiB2YWxpZGF0ZUZvcm1hdChmb3JtYXQpIHsKICAgICAgaWYgKGZvcm1hdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhcmlhbnQgcmVxdWlyZXMgYW4gZXJyb3IgbWVzc2FnZSBhcmd1bWVudCcpOwogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gaW52YXJpYW50KGNvbmRpdGlvbiwgZm9ybWF0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICB2YWxpZGF0ZUZvcm1hdChmb3JtYXQpOwoKICAgIGlmICghY29uZGl0aW9uKSB7CiAgICAgIHZhciBlcnJvcjsKCiAgICAgIGlmIChmb3JtYXQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGVycm9yID0gbmV3IEVycm9yKCdNaW5pZmllZCBleGNlcHRpb24gb2NjdXJyZWQ7IHVzZSB0aGUgbm9uLW1pbmlmaWVkIGRldiBlbnZpcm9ubWVudCAnICsgJ2ZvciB0aGUgZnVsbCBlcnJvciBtZXNzYWdlIGFuZCBhZGRpdGlvbmFsIGhlbHBmdWwgd2FybmluZ3MuJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbYSwgYiwgYywgZCwgZSwgZl07CiAgICAgICAgdmFyIGFyZ0luZGV4ID0gMDsKICAgICAgICBlcnJvciA9IG5ldyBFcnJvcihmb3JtYXQucmVwbGFjZSgvJXMvZywgZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIGFyZ3NbYXJnSW5kZXgrK107CiAgICAgICAgfSkpOwogICAgICAgIGVycm9yLm5hbWUgPSAnSW52YXJpYW50IFZpb2xhdGlvbic7CiAgICAgIH0KCiAgICAgIGVycm9yLmZyYW1lc1RvUG9wID0gMTsKICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGludmFyaWFudDsKfSwxMyxbXSwiZmJqcy9saWIvaW52YXJpYW50LmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgTmF0aXZlTW9kdWxlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIik7CgogIHZhciBSQ1REZXZpY2VFdmVudEVtaXR0ZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUkNURGV2aWNlRXZlbnRFbWl0dGVyIik7CgogIHZhciBSQ1RBY2Nlc3NpYmlsaXR5SW5mbyA9IE5hdGl2ZU1vZHVsZXMuQWNjZXNzaWJpbGl0eUluZm87CiAgdmFyIFRPVUNIX0VYUExPUkFUSU9OX0VWRU5UID0gJ3RvdWNoRXhwbG9yYXRpb25EaWRDaGFuZ2UnOwoKICB2YXIgX3N1YnNjcmlwdGlvbnMgPSBuZXcgTWFwKCk7CgogIHZhciBBY2Nlc3NpYmlsaXR5SW5mbyA9IHsKICAgIGZldGNoOiBmdW5jdGlvbiBmZXRjaCgpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBSQ1RBY2Nlc3NpYmlsaXR5SW5mby5pc1RvdWNoRXhwbG9yYXRpb25FbmFibGVkKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICByZXNvbHZlKHJlc3ApOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgICBhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgaGFuZGxlcikgewogICAgICB2YXIgbGlzdGVuZXIgPSBSQ1REZXZpY2VFdmVudEVtaXR0ZXIuYWRkTGlzdGVuZXIoVE9VQ0hfRVhQTE9SQVRJT05fRVZFTlQsIGZ1bmN0aW9uIChlbmFibGVkKSB7CiAgICAgICAgaGFuZGxlcihlbmFibGVkKTsKICAgICAgfSk7CgogICAgICBfc3Vic2NyaXB0aW9ucy5zZXQoaGFuZGxlciwgbGlzdGVuZXIpOwogICAgfSwKICAgIHJlbW92ZUV2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uIHJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBoYW5kbGVyKSB7CiAgICAgIHZhciBsaXN0ZW5lciA9IF9zdWJzY3JpcHRpb25zLmdldChoYW5kbGVyKTsKCiAgICAgIGlmICghbGlzdGVuZXIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGxpc3RlbmVyLnJlbW92ZSgpOwoKICAgICAgX3N1YnNjcmlwdGlvbnMuZGVsZXRlKGhhbmRsZXIpOwogICAgfQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBBY2Nlc3NpYmlsaXR5SW5mbzsKfSwxNCxbMTUsNzBdLCJBY2Nlc3NpYmlsaXR5SW5mbyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEJhdGNoZWRCcmlkZ2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQmF0Y2hlZEJyaWRnZSIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICBmdW5jdGlvbiBnZW5Nb2R1bGUoY29uZmlnLCBtb2R1bGVJRCkgewogICAgaWYgKCFjb25maWcpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgdmFyIF9jb25maWcgPSBiYWJlbEhlbHBlcnMuc2xpY2VkVG9BcnJheShjb25maWcsIDUpLAogICAgICAgIG1vZHVsZU5hbWUgPSBfY29uZmlnWzBdLAogICAgICAgIGNvbnN0YW50cyA9IF9jb25maWdbMV0sCiAgICAgICAgbWV0aG9kcyA9IF9jb25maWdbMl0sCiAgICAgICAgcHJvbWlzZU1ldGhvZHMgPSBfY29uZmlnWzNdLAogICAgICAgIHN5bmNNZXRob2RzID0gX2NvbmZpZ1s0XTsKCiAgICBpbnZhcmlhbnQoIW1vZHVsZU5hbWUuc3RhcnRzV2l0aCgnUkNUJykgJiYgIW1vZHVsZU5hbWUuc3RhcnRzV2l0aCgnUksnKSwgJ01vZHVsZSBuYW1lIHByZWZpeGVzIHNob3VsZFwndmUgYmVlbiBzdHJpcHBlZCBieSB0aGUgbmF0aXZlIHNpZGUgJyArICdidXQgd2FzblwndCBmb3IgJyArIG1vZHVsZU5hbWUpOwoKICAgIGlmICghY29uc3RhbnRzICYmICFtZXRob2RzKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgbmFtZTogbW9kdWxlTmFtZQogICAgICB9OwogICAgfQoKICAgIHZhciBtb2R1bGUgPSB7fTsKICAgIG1ldGhvZHMgJiYgbWV0aG9kcy5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2ROYW1lLCBtZXRob2RJRCkgewogICAgICB2YXIgaXNQcm9taXNlID0gcHJvbWlzZU1ldGhvZHMgJiYgYXJyYXlDb250YWlucyhwcm9taXNlTWV0aG9kcywgbWV0aG9kSUQpOwogICAgICB2YXIgaXNTeW5jID0gc3luY01ldGhvZHMgJiYgYXJyYXlDb250YWlucyhzeW5jTWV0aG9kcywgbWV0aG9kSUQpOwogICAgICBpbnZhcmlhbnQoIWlzUHJvbWlzZSB8fCAhaXNTeW5jLCAnQ2Fubm90IGhhdmUgYSBtZXRob2QgdGhhdCBpcyBib3RoIGFzeW5jIGFuZCBhIHN5bmMgaG9vaycpOwogICAgICB2YXIgbWV0aG9kVHlwZSA9IGlzUHJvbWlzZSA/ICdwcm9taXNlJyA6IGlzU3luYyA/ICdzeW5jJyA6ICdhc3luYyc7CiAgICAgIG1vZHVsZVttZXRob2ROYW1lXSA9IGdlbk1ldGhvZChtb2R1bGVJRCwgbWV0aG9kSUQsIG1ldGhvZFR5cGUpOwogICAgfSk7CiAgICBiYWJlbEhlbHBlcnMuZXh0ZW5kcyhtb2R1bGUsIGNvbnN0YW50cyk7CgogICAgaWYgKF9fREVWX18pIHsKICAgICAgQmF0Y2hlZEJyaWRnZS5jcmVhdGVEZWJ1Z0xvb2t1cChtb2R1bGVJRCwgbW9kdWxlTmFtZSwgbWV0aG9kcyk7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgbmFtZTogbW9kdWxlTmFtZSwKICAgICAgbW9kdWxlOiBtb2R1bGUKICAgIH07CiAgfQoKICBnbG9iYWwuX19mYkdlbk5hdGl2ZU1vZHVsZSA9IGdlbk1vZHVsZTsKCiAgZnVuY3Rpb24gbG9hZE1vZHVsZShuYW1lLCBtb2R1bGVJRCkgewogICAgaW52YXJpYW50KGdsb2JhbC5uYXRpdmVSZXF1aXJlTW9kdWxlQ29uZmlnLCAnQ2FuXCd0IGxhemlseSBjcmVhdGUgbW9kdWxlIHdpdGhvdXQgbmF0aXZlUmVxdWlyZU1vZHVsZUNvbmZpZycpOwogICAgdmFyIGNvbmZpZyA9IGdsb2JhbC5uYXRpdmVSZXF1aXJlTW9kdWxlQ29uZmlnKG5hbWUpOwogICAgdmFyIGluZm8gPSBnZW5Nb2R1bGUoY29uZmlnLCBtb2R1bGVJRCk7CiAgICByZXR1cm4gaW5mbyAmJiBpbmZvLm1vZHVsZTsKICB9CgogIGZ1bmN0aW9uIGdlbk1ldGhvZChtb2R1bGVJRCwgbWV0aG9kSUQsIHR5cGUpIHsKICAgIHZhciBmbiA9IG51bGw7CgogICAgaWYgKHR5cGUgPT09ICdwcm9taXNlJykgewogICAgICBmbiA9IGZ1bmN0aW9uIGZuKCkgewogICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIEJhdGNoZWRCcmlkZ2UuZW5xdWV1ZU5hdGl2ZUNhbGwobW9kdWxlSUQsIG1ldGhvZElELCBhcmdzLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhKTsKICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvckRhdGEpIHsKICAgICAgICAgICAgcmV0dXJuIHJlamVjdChjcmVhdGVFcnJvckZyb21FcnJvckRhdGEoZXJyb3JEYXRhKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3N5bmMnKSB7CiAgICAgIGZuID0gZnVuY3Rpb24gZm4oKSB7CiAgICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICAgIGludmFyaWFudChnbG9iYWwubmF0aXZlQ2FsbFN5bmNIb29rLCAnQ2FsbGluZyBzeW5jaHJvbm91cyBtZXRob2RzIG9uIG5hdGl2ZSAnICsgJ21vZHVsZXMgaXMgbm90IHN1cHBvcnRlZCBpbiBDaHJvbWUuXG5cbiBDb25zaWRlciBwcm92aWRpbmcgYWx0ZXJuYXRpdmUgJyArICdtZXRob2RzIHRvIGV4cG9zZSB0aGlzIG1ldGhvZCBpbiBkZWJ1ZyBtb2RlLCBlLmcuIGJ5IGV4cG9zaW5nIGNvbnN0YW50cyAnICsgJ2FoZWFkLW9mLXRpbWUuJyk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgYXJnc1tfa2V5Ml0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGdsb2JhbC5uYXRpdmVDYWxsU3luY0hvb2sobW9kdWxlSUQsIG1ldGhvZElELCBhcmdzKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIGZuID0gZnVuY3Rpb24gZm4oKSB7CiAgICAgICAgZm9yICh2YXIgX2xlbjMgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbjMpLCBfa2V5MyA9IDA7IF9rZXkzIDwgX2xlbjM7IF9rZXkzKyspIHsKICAgICAgICAgIGFyZ3NbX2tleTNdID0gYXJndW1lbnRzW19rZXkzXTsKICAgICAgICB9CgogICAgICAgIHZhciBsYXN0QXJnID0gYXJncy5sZW5ndGggPiAwID8gYXJnc1thcmdzLmxlbmd0aCAtIDFdIDogbnVsbDsKICAgICAgICB2YXIgc2Vjb25kTGFzdEFyZyA9IGFyZ3MubGVuZ3RoID4gMSA/IGFyZ3NbYXJncy5sZW5ndGggLSAyXSA6IG51bGw7CiAgICAgICAgdmFyIGhhc1N1Y2Nlc3NDYWxsYmFjayA9IHR5cGVvZiBsYXN0QXJnID09PSAnZnVuY3Rpb24nOwogICAgICAgIHZhciBoYXNFcnJvckNhbGxiYWNrID0gdHlwZW9mIHNlY29uZExhc3RBcmcgPT09ICdmdW5jdGlvbic7CiAgICAgICAgaGFzRXJyb3JDYWxsYmFjayAmJiBpbnZhcmlhbnQoaGFzU3VjY2Vzc0NhbGxiYWNrLCAnQ2Fubm90IGhhdmUgYSBub24tZnVuY3Rpb24gYXJnIGFmdGVyIGEgZnVuY3Rpb24gYXJnLicpOwogICAgICAgIHZhciBvblN1Y2Nlc3MgPSBoYXNTdWNjZXNzQ2FsbGJhY2sgPyBsYXN0QXJnIDogbnVsbDsKICAgICAgICB2YXIgb25GYWlsID0gaGFzRXJyb3JDYWxsYmFjayA/IHNlY29uZExhc3RBcmcgOiBudWxsOwogICAgICAgIHZhciBjYWxsYmFja0NvdW50ID0gaGFzU3VjY2Vzc0NhbGxiYWNrICsgaGFzRXJyb3JDYWxsYmFjazsKICAgICAgICBhcmdzID0gYXJncy5zbGljZSgwLCBhcmdzLmxlbmd0aCAtIGNhbGxiYWNrQ291bnQpOwogICAgICAgIEJhdGNoZWRCcmlkZ2UuZW5xdWV1ZU5hdGl2ZUNhbGwobW9kdWxlSUQsIG1ldGhvZElELCBhcmdzLCBvbkZhaWwsIG9uU3VjY2Vzcyk7CiAgICAgIH07CiAgICB9CgogICAgZm4udHlwZSA9IHR5cGU7CiAgICByZXR1cm4gZm47CiAgfQoKICBmdW5jdGlvbiBhcnJheUNvbnRhaW5zKGFycmF5LCB2YWx1ZSkgewogICAgcmV0dXJuIGFycmF5LmluZGV4T2YodmFsdWUpICE9PSAtMTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUVycm9yRnJvbUVycm9yRGF0YShlcnJvckRhdGEpIHsKICAgIHZhciBfcmVmID0gZXJyb3JEYXRhIHx8IHt9LAogICAgICAgIG1lc3NhZ2UgPSBfcmVmLm1lc3NhZ2UsCiAgICAgICAgZXh0cmFFcnJvckluZm8gPSBiYWJlbEhlbHBlcnMub2JqZWN0V2l0aG91dFByb3BlcnRpZXMoX3JlZiwgWyJtZXNzYWdlIl0pOwoKICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcihtZXNzYWdlKTsKICAgIGVycm9yLmZyYW1lc1RvUG9wID0gMTsKICAgIHJldHVybiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyhlcnJvciwgZXh0cmFFcnJvckluZm8pOwogIH0KCiAgdmFyIE5hdGl2ZU1vZHVsZXMgPSB7fTsKCiAgaWYgKGdsb2JhbC5uYXRpdmVNb2R1bGVQcm94eSkgewogICAgTmF0aXZlTW9kdWxlcyA9IGdsb2JhbC5uYXRpdmVNb2R1bGVQcm94eTsKICB9IGVsc2UgewogICAgdmFyIGJyaWRnZUNvbmZpZyA9IGdsb2JhbC5fX2ZiQmF0Y2hlZEJyaWRnZUNvbmZpZzsKICAgIGludmFyaWFudChicmlkZ2VDb25maWcsICdfX2ZiQmF0Y2hlZEJyaWRnZUNvbmZpZyBpcyBub3Qgc2V0LCBjYW5ub3QgaW52b2tlIG5hdGl2ZSBtb2R1bGVzJyk7CgogICAgdmFyIGRlZmluZUxhenlPYmplY3RQcm9wZXJ0eSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJkZWZpbmVMYXp5T2JqZWN0UHJvcGVydHkiKTsKCiAgICAoYnJpZGdlQ29uZmlnLnJlbW90ZU1vZHVsZUNvbmZpZyB8fCBbXSkuZm9yRWFjaChmdW5jdGlvbiAoY29uZmlnLCBtb2R1bGVJRCkgewogICAgICB2YXIgaW5mbyA9IGdlbk1vZHVsZShjb25maWcsIG1vZHVsZUlEKTsKCiAgICAgIGlmICghaW5mbykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGluZm8ubW9kdWxlKSB7CiAgICAgICAgTmF0aXZlTW9kdWxlc1tpbmZvLm5hbWVdID0gaW5mby5tb2R1bGU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWZpbmVMYXp5T2JqZWN0UHJvcGVydHkoTmF0aXZlTW9kdWxlcywgaW5mby5uYW1lLCB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICAgIHJldHVybiBsb2FkTW9kdWxlKGluZm8ubmFtZSwgbW9kdWxlSUQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gTmF0aXZlTW9kdWxlczsKfSwxNSxbMTYsMTMsMjRdLCJOYXRpdmVNb2R1bGVzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgTWVzc2FnZVF1ZXVlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIk1lc3NhZ2VRdWV1ZSIpOwoKICB2YXIgQmF0Y2hlZEJyaWRnZSA9IG5ldyBNZXNzYWdlUXVldWUodHlwZW9mIF9fZmJVbmluc3RhbGxSTkdsb2JhbEVycm9ySGFuZGxlciAhPT0gJ3VuZGVmaW5lZCcgJiYgX19mYlVuaW5zdGFsbFJOR2xvYmFsRXJyb3JIYW5kbGVyID09PSB0cnVlKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZ2xvYmFsLCAnX19mYkJhdGNoZWRCcmlkZ2UnLCB7CiAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICB2YWx1ZTogQmF0Y2hlZEJyaWRnZQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gQmF0Y2hlZEJyaWRnZTsKfSwxNixbMTddLCJCYXRjaGVkQnJpZGdlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgRXJyb3JVdGlscyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJFcnJvclV0aWxzIik7CgogIHZhciBTeXN0cmFjZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJTeXN0cmFjZSIpOwoKICB2YXIgZGVlcEZyZWV6ZUFuZFRocm93T25NdXRhdGlvbkluRGV2ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgImRlZXBGcmVlemVBbmRUaHJvd09uTXV0YXRpb25JbkRldiIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgc3RyaW5naWZ5U2FmZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJzdHJpbmdpZnlTYWZlIik7CgogIHZhciBUT19KUyA9IDA7CiAgdmFyIFRPX05BVElWRSA9IDE7CiAgdmFyIE1PRFVMRV9JRFMgPSAwOwogIHZhciBNRVRIT0RfSURTID0gMTsKICB2YXIgUEFSQU1TID0gMjsKICB2YXIgTUlOX1RJTUVfQkVUV0VFTl9GTFVTSEVTX01TID0gNTsKICB2YXIgVFJBQ0VfVEFHX1JFQUNUX0FQUFMgPSAxIDw8IDE3OwogIHZhciBERUJVR19JTkZPX0xJTUlUID0gMzI7CiAgdmFyIEpTVGltZXJzID0gbnVsbDsKCiAgdmFyIE1lc3NhZ2VRdWV1ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIE1lc3NhZ2VRdWV1ZSgpIHsKICAgICAgdmFyIHNob3VsZFVuaW5zdGFsbEdsb2JhbEVycm9ySGFuZGxlciA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogZmFsc2U7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBNZXNzYWdlUXVldWUpOwogICAgICB0aGlzLl9sYXp5Q2FsbGFibGVNb2R1bGVzID0ge307CiAgICAgIHRoaXMuX3F1ZXVlID0gW1tdLCBbXSwgW10sIDBdOwogICAgICB0aGlzLl9zdWNjZXNzQ2FsbGJhY2tzID0gW107CiAgICAgIHRoaXMuX2ZhaWx1cmVDYWxsYmFja3MgPSBbXTsKICAgICAgdGhpcy5fY2FsbElEID0gMDsKICAgICAgdGhpcy5fbGFzdEZsdXNoID0gMDsKICAgICAgdGhpcy5fZXZlbnRMb29wU3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CgogICAgICBpZiAoc2hvdWxkVW5pbnN0YWxsR2xvYmFsRXJyb3JIYW5kbGVyKSB7CiAgICAgICAgdGhpcy51bmluc3RhbGxHbG9iYWxFcnJvckhhbmRsZXIoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmluc3RhbGxHbG9iYWxFcnJvckhhbmRsZXIoKTsKICAgICAgfQoKICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICB0aGlzLl9kZWJ1Z0luZm8gPSB7fTsKICAgICAgICB0aGlzLl9yZW1vdGVNb2R1bGVUYWJsZSA9IHt9OwogICAgICAgIHRoaXMuX3JlbW90ZU1ldGhvZFRhYmxlID0ge307CiAgICAgIH0KCiAgICAgIHRoaXMuY2FsbEZ1bmN0aW9uUmV0dXJuRmx1c2hlZFF1ZXVlID0gdGhpcy5jYWxsRnVuY3Rpb25SZXR1cm5GbHVzaGVkUXVldWUuYmluZCh0aGlzKTsKICAgICAgdGhpcy5jYWxsRnVuY3Rpb25SZXR1cm5SZXN1bHRBbmRGbHVzaGVkUXVldWUgPSB0aGlzLmNhbGxGdW5jdGlvblJldHVyblJlc3VsdEFuZEZsdXNoZWRRdWV1ZS5iaW5kKHRoaXMpOwogICAgICB0aGlzLmZsdXNoZWRRdWV1ZSA9IHRoaXMuZmx1c2hlZFF1ZXVlLmJpbmQodGhpcyk7CiAgICAgIHRoaXMuaW52b2tlQ2FsbGJhY2tBbmRSZXR1cm5GbHVzaGVkUXVldWUgPSB0aGlzLmludm9rZUNhbGxiYWNrQW5kUmV0dXJuRmx1c2hlZFF1ZXVlLmJpbmQodGhpcyk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKE1lc3NhZ2VRdWV1ZSwgW3sKICAgICAga2V5OiAiY2FsbEZ1bmN0aW9uUmV0dXJuRmx1c2hlZFF1ZXVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNhbGxGdW5jdGlvblJldHVybkZsdXNoZWRRdWV1ZShtb2R1bGUsIG1ldGhvZCwgYXJncykgewogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHRoaXMuX19ndWFyZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpcy5fX2NhbGxGdW5jdGlvbihtb2R1bGUsIG1ldGhvZCwgYXJncyk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiB0aGlzLmZsdXNoZWRRdWV1ZSgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNhbGxGdW5jdGlvblJldHVyblJlc3VsdEFuZEZsdXNoZWRRdWV1ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjYWxsRnVuY3Rpb25SZXR1cm5SZXN1bHRBbmRGbHVzaGVkUXVldWUobW9kdWxlLCBtZXRob2QsIGFyZ3MpIHsKICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgICAgdmFyIHJlc3VsdCA9IHZvaWQgMDsKCiAgICAgICAgdGhpcy5fX2d1YXJkKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlc3VsdCA9IF90aGlzMi5fX2NhbGxGdW5jdGlvbihtb2R1bGUsIG1ldGhvZCwgYXJncyk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBbcmVzdWx0LCB0aGlzLmZsdXNoZWRRdWV1ZSgpXTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJpbnZva2VDYWxsYmFja0FuZFJldHVybkZsdXNoZWRRdWV1ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBpbnZva2VDYWxsYmFja0FuZFJldHVybkZsdXNoZWRRdWV1ZShjYklELCBhcmdzKSB7CiAgICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICAgIHRoaXMuX19ndWFyZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpczMuX19pbnZva2VDYWxsYmFjayhjYklELCBhcmdzKTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHRoaXMuZmx1c2hlZFF1ZXVlKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZmx1c2hlZFF1ZXVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGZsdXNoZWRRdWV1ZSgpIHsKICAgICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgICAgdGhpcy5fX2d1YXJkKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIF90aGlzNC5fX2NhbGxJbW1lZGlhdGVzKCk7CiAgICAgICAgfSk7CgogICAgICAgIHZhciBxdWV1ZSA9IHRoaXMuX3F1ZXVlOwogICAgICAgIHRoaXMuX3F1ZXVlID0gW1tdLCBbXSwgW10sIHRoaXMuX2NhbGxJRF07CiAgICAgICAgcmV0dXJuIHF1ZXVlWzBdLmxlbmd0aCA/IHF1ZXVlIDogbnVsbDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRFdmVudExvb3BSdW5uaW5nVGltZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRFdmVudExvb3BSdW5uaW5nVGltZSgpIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSB0aGlzLl9ldmVudExvb3BTdGFydFRpbWU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVnaXN0ZXJDYWxsYWJsZU1vZHVsZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZWdpc3RlckNhbGxhYmxlTW9kdWxlKG5hbWUsIG1vZHVsZSkgewogICAgICAgIHRoaXMuX2xhenlDYWxsYWJsZU1vZHVsZXNbbmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gbW9kdWxlOwogICAgICAgIH07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVnaXN0ZXJMYXp5Q2FsbGFibGVNb2R1bGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVnaXN0ZXJMYXp5Q2FsbGFibGVNb2R1bGUobmFtZSwgZmFjdG9yeSkgewogICAgICAgIHZhciBtb2R1bGUgPSB2b2lkIDA7CiAgICAgICAgdmFyIGdldFZhbHVlID0gZmFjdG9yeTsKCiAgICAgICAgdGhpcy5fbGF6eUNhbGxhYmxlTW9kdWxlc1tuYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChnZXRWYWx1ZSkgewogICAgICAgICAgICBtb2R1bGUgPSBnZXRWYWx1ZSgpOwogICAgICAgICAgICBnZXRWYWx1ZSA9IG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIG1vZHVsZTsKICAgICAgICB9OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldENhbGxhYmxlTW9kdWxlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldENhbGxhYmxlTW9kdWxlKG5hbWUpIHsKICAgICAgICB2YXIgZ2V0VmFsdWUgPSB0aGlzLl9sYXp5Q2FsbGFibGVNb2R1bGVzW25hbWVdOwogICAgICAgIHJldHVybiBnZXRWYWx1ZSA/IGdldFZhbHVlKCkgOiBudWxsOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImVucXVldWVOYXRpdmVDYWxsIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGVucXVldWVOYXRpdmVDYWxsKG1vZHVsZUlELCBtZXRob2RJRCwgcGFyYW1zLCBvbkZhaWwsIG9uU3VjYykgewogICAgICAgIGlmIChvbkZhaWwgfHwgb25TdWNjKSB7CiAgICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgICB0aGlzLl9kZWJ1Z0luZm9bdGhpcy5fY2FsbElEXSA9IFttb2R1bGVJRCwgbWV0aG9kSURdOwoKICAgICAgICAgICAgaWYgKHRoaXMuX2NhbGxJRCA+IERFQlVHX0lORk9fTElNSVQpIHsKICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fZGVidWdJbmZvW3RoaXMuX2NhbGxJRCAtIERFQlVHX0lORk9fTElNSVRdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgb25GYWlsICYmIHBhcmFtcy5wdXNoKHRoaXMuX2NhbGxJRCA8PCAxKTsKICAgICAgICAgIG9uU3VjYyAmJiBwYXJhbXMucHVzaCh0aGlzLl9jYWxsSUQgPDwgMSB8IDEpOwogICAgICAgICAgdGhpcy5fc3VjY2Vzc0NhbGxiYWNrc1t0aGlzLl9jYWxsSURdID0gb25TdWNjOwogICAgICAgICAgdGhpcy5fZmFpbHVyZUNhbGxiYWNrc1t0aGlzLl9jYWxsSURdID0gb25GYWlsOwogICAgICAgIH0KCiAgICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUJlZ2luQXN5bmNGbG93ICYmIGdsb2JhbC5uYXRpdmVUcmFjZUJlZ2luQXN5bmNGbG93KFRSQUNFX1RBR19SRUFDVF9BUFBTLCAnbmF0aXZlJywgdGhpcy5fY2FsbElEKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2NhbGxJRCsrOwoKICAgICAgICB0aGlzLl9xdWV1ZVtNT0RVTEVfSURTXS5wdXNoKG1vZHVsZUlEKTsKCiAgICAgICAgdGhpcy5fcXVldWVbTUVUSE9EX0lEU10ucHVzaChtZXRob2RJRCk7CgogICAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgICB2YXIgaXNWYWxpZEFyZ3VtZW50ID0gZnVuY3Rpb24gaXNWYWxpZEFyZ3VtZW50KHZhbCkgewogICAgICAgICAgICB2YXIgdCA9IHR5cGVvZiB2YWw7CgogICAgICAgICAgICBpZiAodCA9PT0gJ3VuZGVmaW5lZCcgfHwgdCA9PT0gJ251bGwnIHx8IHQgPT09ICdib29sZWFuJyB8fCB0ID09PSAnbnVtYmVyJyB8fCB0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodCA9PT0gJ2Z1bmN0aW9uJyB8fCB0ICE9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgICAgICAgICAgIHJldHVybiB2YWwuZXZlcnkoaXNWYWxpZEFyZ3VtZW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICh2YXIgayBpbiB2YWwpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbFtrXSAhPT0gJ2Z1bmN0aW9uJyAmJiAhaXNWYWxpZEFyZ3VtZW50KHZhbFtrXSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfTsKCiAgICAgICAgICBpbnZhcmlhbnQoaXNWYWxpZEFyZ3VtZW50KHBhcmFtcyksICclcyBpcyBub3QgdXNhYmxlIGFzIGEgbmF0aXZlIG1ldGhvZCBhcmd1bWVudCcsIHBhcmFtcyk7CiAgICAgICAgICBkZWVwRnJlZXplQW5kVGhyb3dPbk11dGF0aW9uSW5EZXYocGFyYW1zKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3F1ZXVlW1BBUkFNU10ucHVzaChwYXJhbXMpOwoKICAgICAgICB2YXIgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CgogICAgICAgIGlmIChnbG9iYWwubmF0aXZlRmx1c2hRdWV1ZUltbWVkaWF0ZSAmJiAobm93IC0gdGhpcy5fbGFzdEZsdXNoID49IE1JTl9USU1FX0JFVFdFRU5fRkxVU0hFU19NUyB8fCB0aGlzLl9pbkNhbGwgPT09IDApKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB0aGlzLl9xdWV1ZTsKICAgICAgICAgIHRoaXMuX3F1ZXVlID0gW1tdLCBbXSwgW10sIHRoaXMuX2NhbGxJRF07CiAgICAgICAgICB0aGlzLl9sYXN0Rmx1c2ggPSBub3c7CiAgICAgICAgICBnbG9iYWwubmF0aXZlRmx1c2hRdWV1ZUltbWVkaWF0ZShxdWV1ZSk7CiAgICAgICAgfQoKICAgICAgICBTeXN0cmFjZS5jb3VudGVyRXZlbnQoJ3BlbmRpbmdfanNfdG9fbmF0aXZlX3F1ZXVlJywgdGhpcy5fcXVldWVbMF0ubGVuZ3RoKTsKCiAgICAgICAgaWYgKF9fREVWX18gJiYgdGhpcy5fX3NweSAmJiBpc0Zpbml0ZShtb2R1bGVJRCkpIHsKICAgICAgICAgIHRoaXMuX19zcHkoewogICAgICAgICAgICB0eXBlOiBUT19OQVRJVkUsCiAgICAgICAgICAgIG1vZHVsZTogdGhpcy5fcmVtb3RlTW9kdWxlVGFibGVbbW9kdWxlSURdLAogICAgICAgICAgICBtZXRob2Q6IHRoaXMuX3JlbW90ZU1ldGhvZFRhYmxlW21vZHVsZUlEXVttZXRob2RJRF0sCiAgICAgICAgICAgIGFyZ3M6IHBhcmFtcwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9fc3B5KSB7CiAgICAgICAgICB0aGlzLl9fc3B5KHsKICAgICAgICAgICAgdHlwZTogVE9fTkFUSVZFLAogICAgICAgICAgICBtb2R1bGU6IG1vZHVsZUlEICsgJycsCiAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kSUQsCiAgICAgICAgICAgIGFyZ3M6IHBhcmFtcwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNyZWF0ZURlYnVnTG9va3VwIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZURlYnVnTG9va3VwKG1vZHVsZUlELCBuYW1lLCBtZXRob2RzKSB7CiAgICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICAgIHRoaXMuX3JlbW90ZU1vZHVsZVRhYmxlW21vZHVsZUlEXSA9IG5hbWU7CiAgICAgICAgICB0aGlzLl9yZW1vdGVNZXRob2RUYWJsZVttb2R1bGVJRF0gPSBtZXRob2RzOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJ1bmluc3RhbGxHbG9iYWxFcnJvckhhbmRsZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gdW5pbnN0YWxsR2xvYmFsRXJyb3JIYW5kbGVyKCkgewogICAgICAgIHRoaXMuX19ndWFyZCA9IHRoaXMuX19ndWFyZFVuc2FmZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJpbnN0YWxsR2xvYmFsRXJyb3JIYW5kbGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGluc3RhbGxHbG9iYWxFcnJvckhhbmRsZXIoKSB7CiAgICAgICAgdGhpcy5fX2d1YXJkID0gdGhpcy5fX2d1YXJkU2FmZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2d1YXJkVW5zYWZlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ3VhcmRVbnNhZmUoZm4pIHsKICAgICAgICB0aGlzLl9pbkNhbGwrKzsKICAgICAgICBmbigpOwogICAgICAgIHRoaXMuX2luQ2FsbC0tOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ3VhcmRTYWZlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ3VhcmRTYWZlKGZuKSB7CiAgICAgICAgdGhpcy5faW5DYWxsKys7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBmbigpOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICBFcnJvclV0aWxzLnJlcG9ydEZhdGFsRXJyb3IoZXJyb3IpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICB0aGlzLl9pbkNhbGwtLTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19jYWxsSW1tZWRpYXRlcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2NhbGxJbW1lZGlhdGVzKCkgewogICAgICAgIFN5c3RyYWNlLmJlZ2luRXZlbnQoJ0pTVGltZXJzLmNhbGxJbW1lZGlhdGVzKCknKTsKCiAgICAgICAgaWYgKCFKU1RpbWVycykgewogICAgICAgICAgSlNUaW1lcnMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiSlNUaW1lcnMiKTsKICAgICAgICB9CgogICAgICAgIEpTVGltZXJzLmNhbGxJbW1lZGlhdGVzKCk7CiAgICAgICAgU3lzdHJhY2UuZW5kRXZlbnQoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2NhbGxGdW5jdGlvbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2NhbGxGdW5jdGlvbihtb2R1bGUsIG1ldGhvZCwgYXJncykgewogICAgICAgIHRoaXMuX2xhc3RGbHVzaCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgIHRoaXMuX2V2ZW50TG9vcFN0YXJ0VGltZSA9IHRoaXMuX2xhc3RGbHVzaDsKICAgICAgICBTeXN0cmFjZS5iZWdpbkV2ZW50KG1vZHVsZSArICIuIiArIG1ldGhvZCArICIoKSIpOwoKICAgICAgICBpZiAodGhpcy5fX3NweSkgewogICAgICAgICAgdGhpcy5fX3NweSh7CiAgICAgICAgICAgIHR5cGU6IFRPX0pTLAogICAgICAgICAgICBtb2R1bGU6IG1vZHVsZSwKICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsCiAgICAgICAgICAgIGFyZ3M6IGFyZ3MKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdmFyIG1vZHVsZU1ldGhvZHMgPSB0aGlzLmdldENhbGxhYmxlTW9kdWxlKG1vZHVsZSk7CiAgICAgICAgaW52YXJpYW50KCEhbW9kdWxlTWV0aG9kcywgJ01vZHVsZSAlcyBpcyBub3QgYSByZWdpc3RlcmVkIGNhbGxhYmxlIG1vZHVsZSAoY2FsbGluZyAlcyknLCBtb2R1bGUsIG1ldGhvZCk7CiAgICAgICAgaW52YXJpYW50KCEhbW9kdWxlTWV0aG9kc1ttZXRob2RdLCAnTWV0aG9kICVzIGRvZXMgbm90IGV4aXN0IG9uIG1vZHVsZSAlcycsIG1ldGhvZCwgbW9kdWxlKTsKICAgICAgICB2YXIgcmVzdWx0ID0gbW9kdWxlTWV0aG9kc1ttZXRob2RdLmFwcGx5KG1vZHVsZU1ldGhvZHMsIGFyZ3MpOwogICAgICAgIFN5c3RyYWNlLmVuZEV2ZW50KCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2ludm9rZUNhbGxiYWNrIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9faW52b2tlQ2FsbGJhY2soY2JJRCwgYXJncykgewogICAgICAgIHRoaXMuX2xhc3RGbHVzaCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgIHRoaXMuX2V2ZW50TG9vcFN0YXJ0VGltZSA9IHRoaXMuX2xhc3RGbHVzaDsKICAgICAgICB2YXIgY2FsbElEID0gY2JJRCA+Pj4gMTsKICAgICAgICB2YXIgaXNTdWNjZXNzID0gY2JJRCAmIDE7CiAgICAgICAgdmFyIGNhbGxiYWNrID0gaXNTdWNjZXNzID8gdGhpcy5fc3VjY2Vzc0NhbGxiYWNrc1tjYWxsSURdIDogdGhpcy5fZmFpbHVyZUNhbGxiYWNrc1tjYWxsSURdOwoKICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgdmFyIGRlYnVnID0gdGhpcy5fZGVidWdJbmZvW2NhbGxJRF07CgogICAgICAgICAgdmFyIF9tb2R1bGUgPSBkZWJ1ZyAmJiB0aGlzLl9yZW1vdGVNb2R1bGVUYWJsZVtkZWJ1Z1swXV07CgogICAgICAgICAgdmFyIF9tZXRob2QgPSBkZWJ1ZyAmJiB0aGlzLl9yZW1vdGVNZXRob2RUYWJsZVtkZWJ1Z1swXV1bZGVidWdbMV1dOwoKICAgICAgICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGVycm9yTWVzc2FnZSA9ICJDYWxsYmFjayB3aXRoIGlkICIgKyBjYklEICsgIjogIiArIF9tb2R1bGUgKyAiLiIgKyBfbWV0aG9kICsgIigpIG5vdCBmb3VuZCI7CgogICAgICAgICAgICBpZiAoX21ldGhvZCkgewogICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9ICJUaGUgY2FsbGJhY2sgIiArIF9tZXRob2QgKyAiKCkgZXhpc3RzIGluIG1vZHVsZSAiICsgX21vZHVsZSArICIsICIgKyAnYnV0IG9ubHkgb25lIGNhbGxiYWNrIG1heSBiZSByZWdpc3RlcmVkIHRvIGEgZnVuY3Rpb24gaW4gYSBuYXRpdmUgbW9kdWxlLic7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGludmFyaWFudChjYWxsYmFjaywgZXJyb3JNZXNzYWdlKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgcHJvZmlsZU5hbWUgPSBkZWJ1ZyA/ICc8Y2FsbGJhY2sgZm9yICcgKyBfbW9kdWxlICsgJy4nICsgX21ldGhvZCArICc+JyA6IGNiSUQ7CgogICAgICAgICAgaWYgKGNhbGxiYWNrICYmIHRoaXMuX19zcHkpIHsKICAgICAgICAgICAgdGhpcy5fX3NweSh7CiAgICAgICAgICAgICAgdHlwZTogVE9fSlMsCiAgICAgICAgICAgICAgbW9kdWxlOiBudWxsLAogICAgICAgICAgICAgIG1ldGhvZDogcHJvZmlsZU5hbWUsCiAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBTeXN0cmFjZS5iZWdpbkV2ZW50KCJNZXNzYWdlUXVldWUuaW52b2tlQ2FsbGJhY2soIiArIHByb2ZpbGVOYW1lICsgIiwgIiArIHN0cmluZ2lmeVNhZmUoYXJncykgKyAiKSIpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fc3VjY2Vzc0NhbGxiYWNrc1tjYWxsSURdID0gdGhpcy5fZmFpbHVyZUNhbGxiYWNrc1tjYWxsSURdID0gbnVsbDsKICAgICAgICBjYWxsYmFjay5hcHBseSh1bmRlZmluZWQsIGJhYmVsSGVscGVycy50b0NvbnN1bWFibGVBcnJheShhcmdzKSk7CgogICAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgICBTeXN0cmFjZS5lbmRFdmVudCgpOwogICAgICAgIH0KICAgICAgfQogICAgfV0sIFt7CiAgICAgIGtleTogInNweSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzcHkoc3B5T3JUb2dnbGUpIHsKICAgICAgICBpZiAoc3B5T3JUb2dnbGUgPT09IHRydWUpIHsKICAgICAgICAgIE1lc3NhZ2VRdWV1ZS5wcm90b3R5cGUuX19zcHkgPSBmdW5jdGlvbiAoaW5mbykgewogICAgICAgICAgICBjb25zb2xlLmxvZygoaW5mby50eXBlID09PSBUT19KUyA/ICdOLT5KUycgOiAnSlMtPk4nKSArICIgOiAiICsgKCIiICsgKGluZm8ubW9kdWxlID8gaW5mby5tb2R1bGUgKyAnLicgOiAnJykgKyBpbmZvLm1ldGhvZCkgKyAoIigiICsgSlNPTi5zdHJpbmdpZnkoaW5mby5hcmdzKSArICIpIikpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKHNweU9yVG9nZ2xlID09PSBmYWxzZSkgewogICAgICAgICAgTWVzc2FnZVF1ZXVlLnByb3RvdHlwZS5fX3NweSA9IG51bGw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIE1lc3NhZ2VRdWV1ZS5wcm90b3R5cGUuX19zcHkgPSBzcHlPclRvZ2dsZTsKICAgICAgICB9CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBNZXNzYWdlUXVldWU7CiAgfSgpOwoKICBtb2R1bGUuZXhwb3J0cyA9IE1lc3NhZ2VRdWV1ZTsKfSwxNyxbMTgsMTksMTE4LDEzLDM5LDUxXSwiTWVzc2FnZVF1ZXVlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgbW9kdWxlLmV4cG9ydHMgPSBnbG9iYWwuRXJyb3JVdGlsczsKfSwxOCxbXSwiRXJyb3JVdGlscyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIFRSQUNFX1RBR19SRUFDVF9BUFBTID0gMSA8PCAxNzsKICB2YXIgVFJBQ0VfVEFHX0pTX1ZNX0NBTExTID0gMSA8PCAyNzsKICB2YXIgX2VuYWJsZWQgPSBmYWxzZTsKICB2YXIgX2FzeW5jQ29va2llID0gMDsKICB2YXIgX21hcmtTdGFjayA9IFtdOwoKICB2YXIgX21hcmtTdGFja0luZGV4ID0gLTE7CgogIHZhciBfY2FuSW5zdGFsbFJlYWN0SG9vayA9IGZhbHNlOwogIHZhciBfdXNlRmliZXIgPSBmYWxzZTsKICB2YXIgUkVBQ1RfTUFSS0VSID0gIlx1MjY5QiI7CiAgdmFyIHVzZXJUaW1pbmdQb2x5ZmlsbCA9IF9fREVWX18gPyB7CiAgICBtYXJrOiBmdW5jdGlvbiBtYXJrKG1hcmtOYW1lKSB7CiAgICAgIGlmIChfZW5hYmxlZCkgewogICAgICAgIF9tYXJrU3RhY2tJbmRleCsrOwogICAgICAgIF9tYXJrU3RhY2tbX21hcmtTdGFja0luZGV4XSA9IG1hcmtOYW1lOwogICAgICAgIHZhciBzeXN0cmFjZUxhYmVsID0gbWFya05hbWU7CgogICAgICAgIGlmIChtYXJrTmFtZVswXSA9PT0gUkVBQ1RfTUFSS0VSKSB7CiAgICAgICAgICB2YXIgaW5kZXhPZklkID0gbWFya05hbWUubGFzdEluZGV4T2YoJyAoIycpOwogICAgICAgICAgdmFyIGN1dG9mZkluZGV4ID0gaW5kZXhPZklkICE9PSAtMSA/IGluZGV4T2ZJZCA6IG1hcmtOYW1lLmxlbmd0aDsKICAgICAgICAgIHN5c3RyYWNlTGFiZWwgPSBtYXJrTmFtZS5zbGljZSgyLCBjdXRvZmZJbmRleCk7CiAgICAgICAgfQoKICAgICAgICBTeXN0cmFjZS5iZWdpbkV2ZW50KHN5c3RyYWNlTGFiZWwpOwogICAgICB9CiAgICB9LAogICAgbWVhc3VyZTogZnVuY3Rpb24gbWVhc3VyZShtZWFzdXJlTmFtZSwgc3RhcnRNYXJrLCBlbmRNYXJrKSB7CiAgICAgIGlmIChfZW5hYmxlZCkgewogICAgICAgIGludmFyaWFudCh0eXBlb2YgbWVhc3VyZU5hbWUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBzdGFydE1hcmsgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBlbmRNYXJrID09PSAndW5kZWZpbmVkJywgJ09ubHkgcGVyZm9ybWFuY2UubWVhc3VyZShzdHJpbmcsIHN0cmluZykgb3ZlcmxvYWQgaXMgc3VwcG9ydGVkLicpOwogICAgICAgIHZhciB0b3BNYXJrID0gX21hcmtTdGFja1tfbWFya1N0YWNrSW5kZXhdOwogICAgICAgIGludmFyaWFudChzdGFydE1hcmsgPT09IHRvcE1hcmssICdUaGVyZSB3YXMgYSBtaXNtYXRjaGluZyBwZXJmb3JtYW5jZS5tZWFzdXJlKCkgY2FsbC4gJyArICdFeHBlY3RlZCAiJXMiIGJ1dCBnb3QgIiVzLiInLCB0b3BNYXJrLCBzdGFydE1hcmspOwogICAgICAgIF9tYXJrU3RhY2tJbmRleC0tOwogICAgICAgIFN5c3RyYWNlLmVuZEV2ZW50KCk7CiAgICAgIH0KICAgIH0sCiAgICBjbGVhck1hcmtzOiBmdW5jdGlvbiBjbGVhck1hcmtzKG1hcmtOYW1lKSB7CiAgICAgIGlmIChfZW5hYmxlZCkgewogICAgICAgIGlmIChfbWFya1N0YWNrSW5kZXggPT09IC0xKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAobWFya05hbWUgPT09IF9tYXJrU3RhY2tbX21hcmtTdGFja0luZGV4XSkgewogICAgICAgICAgaWYgKHVzZXJUaW1pbmdQb2x5ZmlsbCAhPSBudWxsKSB7CiAgICAgICAgICAgIHVzZXJUaW1pbmdQb2x5ZmlsbC5tZWFzdXJlKG1hcmtOYW1lLCBtYXJrTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgY2xlYXJNZWFzdXJlczogZnVuY3Rpb24gY2xlYXJNZWFzdXJlcygpIHt9CiAgfSA6IG51bGw7CiAgdmFyIHJlYWN0RGVidWdUb29sSG9vayA9IF9fREVWX18gPyB7CiAgICBvbkJlZm9yZU1vdW50Q29tcG9uZW50OiBmdW5jdGlvbiBvbkJlZm9yZU1vdW50Q29tcG9uZW50KGRlYnVnSUQpIHsKICAgICAgdmFyIFJlYWN0Q29tcG9uZW50VHJlZUhvb2sgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUmVhY3RHbG9iYWxTaGFyZWRTdGF0ZSIpLlJlYWN0Q29tcG9uZW50VHJlZUhvb2s7CgogICAgICB2YXIgZGlzcGxheU5hbWUgPSBSZWFjdENvbXBvbmVudFRyZWVIb29rLmdldERpc3BsYXlOYW1lKGRlYnVnSUQpOwogICAgICBTeXN0cmFjZS5iZWdpbkV2ZW50KCJSZWFjdFJlY29uY2lsZXIubW91bnRDb21wb25lbnQoIiArIGRpc3BsYXlOYW1lICsgIikiKTsKICAgIH0sCiAgICBvbk1vdW50Q29tcG9uZW50OiBmdW5jdGlvbiBvbk1vdW50Q29tcG9uZW50KGRlYnVnSUQpIHsKICAgICAgU3lzdHJhY2UuZW5kRXZlbnQoKTsKICAgIH0sCiAgICBvbkJlZm9yZVVwZGF0ZUNvbXBvbmVudDogZnVuY3Rpb24gb25CZWZvcmVVcGRhdGVDb21wb25lbnQoZGVidWdJRCkgewogICAgICB2YXIgUmVhY3RDb21wb25lbnRUcmVlSG9vayA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJSZWFjdEdsb2JhbFNoYXJlZFN0YXRlIikuUmVhY3RDb21wb25lbnRUcmVlSG9vazsKCiAgICAgIHZhciBkaXNwbGF5TmFtZSA9IFJlYWN0Q29tcG9uZW50VHJlZUhvb2suZ2V0RGlzcGxheU5hbWUoZGVidWdJRCk7CiAgICAgIFN5c3RyYWNlLmJlZ2luRXZlbnQoIlJlYWN0UmVjb25jaWxlci51cGRhdGVDb21wb25lbnQoIiArIGRpc3BsYXlOYW1lICsgIikiKTsKICAgIH0sCiAgICBvblVwZGF0ZUNvbXBvbmVudDogZnVuY3Rpb24gb25VcGRhdGVDb21wb25lbnQoZGVidWdJRCkgewogICAgICBTeXN0cmFjZS5lbmRFdmVudCgpOwogICAgfSwKICAgIG9uQmVmb3JlVW5tb3VudENvbXBvbmVudDogZnVuY3Rpb24gb25CZWZvcmVVbm1vdW50Q29tcG9uZW50KGRlYnVnSUQpIHsKICAgICAgdmFyIFJlYWN0Q29tcG9uZW50VHJlZUhvb2sgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUmVhY3RHbG9iYWxTaGFyZWRTdGF0ZSIpLlJlYWN0Q29tcG9uZW50VHJlZUhvb2s7CgogICAgICB2YXIgZGlzcGxheU5hbWUgPSBSZWFjdENvbXBvbmVudFRyZWVIb29rLmdldERpc3BsYXlOYW1lKGRlYnVnSUQpOwogICAgICBTeXN0cmFjZS5iZWdpbkV2ZW50KCJSZWFjdFJlY29uY2lsZXIudW5tb3VudENvbXBvbmVudCgiICsgZGlzcGxheU5hbWUgKyAiKSIpOwogICAgfSwKICAgIG9uVW5tb3VudENvbXBvbmVudDogZnVuY3Rpb24gb25Vbm1vdW50Q29tcG9uZW50KGRlYnVnSUQpIHsKICAgICAgU3lzdHJhY2UuZW5kRXZlbnQoKTsKICAgIH0sCiAgICBvbkJlZ2luTGlmZUN5Y2xlVGltZXI6IGZ1bmN0aW9uIG9uQmVnaW5MaWZlQ3ljbGVUaW1lcihkZWJ1Z0lELCB0aW1lclR5cGUpIHsKICAgICAgdmFyIFJlYWN0Q29tcG9uZW50VHJlZUhvb2sgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUmVhY3RHbG9iYWxTaGFyZWRTdGF0ZSIpLlJlYWN0Q29tcG9uZW50VHJlZUhvb2s7CgogICAgICB2YXIgZGlzcGxheU5hbWUgPSBSZWFjdENvbXBvbmVudFRyZWVIb29rLmdldERpc3BsYXlOYW1lKGRlYnVnSUQpOwogICAgICBTeXN0cmFjZS5iZWdpbkV2ZW50KGRpc3BsYXlOYW1lICsgIi4iICsgdGltZXJUeXBlICsgIigpIik7CiAgICB9LAogICAgb25FbmRMaWZlQ3ljbGVUaW1lcjogZnVuY3Rpb24gb25FbmRMaWZlQ3ljbGVUaW1lcihkZWJ1Z0lELCB0aW1lclR5cGUpIHsKICAgICAgU3lzdHJhY2UuZW5kRXZlbnQoKTsKICAgIH0KICB9IDogbnVsbDsKICB2YXIgU3lzdHJhY2UgPSB7CiAgICBpbnN0YWxsUmVhY3RIb29rOiBmdW5jdGlvbiBpbnN0YWxsUmVhY3RIb29rKHVzZUZpYmVyKSB7CiAgICAgIGlmIChfZW5hYmxlZCkgewogICAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgICBpZiAodXNlRmliZXIpIHsKICAgICAgICAgICAgZ2xvYmFsLnBlcmZvcm1hbmNlID0gdXNlclRpbWluZ1BvbHlmaWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlJlYWN0RGVidWdUb29sIikuYWRkSG9vayhyZWFjdERlYnVnVG9vbEhvb2spOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgX3VzZUZpYmVyID0gdXNlRmliZXI7CiAgICAgIF9jYW5JbnN0YWxsUmVhY3RIb29rID0gdHJ1ZTsKICAgIH0sCiAgICBzZXRFbmFibGVkOiBmdW5jdGlvbiBzZXRFbmFibGVkKGVuYWJsZWQpIHsKICAgICAgaWYgKF9lbmFibGVkICE9PSBlbmFibGVkKSB7CiAgICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICAgIGlmIChlbmFibGVkKSB7CiAgICAgICAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUJlZ2luTGVnYWN5ICYmIGdsb2JhbC5uYXRpdmVUcmFjZUJlZ2luTGVnYWN5KFRSQUNFX1RBR19KU19WTV9DQUxMUyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnbG9iYWwubmF0aXZlVHJhY2VFbmRMZWdhY3kgJiYgZ2xvYmFsLm5hdGl2ZVRyYWNlRW5kTGVnYWN5KFRSQUNFX1RBR19KU19WTV9DQUxMUyk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKF9jYW5JbnN0YWxsUmVhY3RIb29rKSB7CiAgICAgICAgICAgIGlmIChfdXNlRmliZXIpIHsKICAgICAgICAgICAgICBpZiAoZW5hYmxlZCAmJiBnbG9iYWwucGVyZm9ybWFuY2UgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgZ2xvYmFsLnBlcmZvcm1hbmNlID0gdXNlclRpbWluZ1BvbHlmaWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z1Rvb2wgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUmVhY3REZWJ1Z1Rvb2wiKTsKCiAgICAgICAgICAgICAgaWYgKGVuYWJsZWQpIHsKICAgICAgICAgICAgICAgIFJlYWN0RGVidWdUb29sLmFkZEhvb2socmVhY3REZWJ1Z1Rvb2xIb29rKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgUmVhY3REZWJ1Z1Rvb2wucmVtb3ZlSG9vayhyZWFjdERlYnVnVG9vbEhvb2spOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2VuYWJsZWQgPSBlbmFibGVkOwogICAgICB9CiAgICB9LAogICAgaXNFbmFibGVkOiBmdW5jdGlvbiBpc0VuYWJsZWQoKSB7CiAgICAgIHJldHVybiBfZW5hYmxlZDsKICAgIH0sCiAgICBiZWdpbkV2ZW50OiBmdW5jdGlvbiBiZWdpbkV2ZW50KHByb2ZpbGVOYW1lLCBhcmdzKSB7CiAgICAgIGlmIChfZW5hYmxlZCkgewogICAgICAgIHByb2ZpbGVOYW1lID0gdHlwZW9mIHByb2ZpbGVOYW1lID09PSAnZnVuY3Rpb24nID8gcHJvZmlsZU5hbWUoKSA6IHByb2ZpbGVOYW1lOwogICAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUJlZ2luU2VjdGlvbihUUkFDRV9UQUdfUkVBQ1RfQVBQUywgcHJvZmlsZU5hbWUsIGFyZ3MpOwogICAgICB9CiAgICB9LAogICAgZW5kRXZlbnQ6IGZ1bmN0aW9uIGVuZEV2ZW50KCkgewogICAgICBpZiAoX2VuYWJsZWQpIHsKICAgICAgICBnbG9iYWwubmF0aXZlVHJhY2VFbmRTZWN0aW9uKFRSQUNFX1RBR19SRUFDVF9BUFBTKTsKICAgICAgfQogICAgfSwKICAgIGJlZ2luQXN5bmNFdmVudDogZnVuY3Rpb24gYmVnaW5Bc3luY0V2ZW50KHByb2ZpbGVOYW1lKSB7CiAgICAgIHZhciBjb29raWUgPSBfYXN5bmNDb29raWU7CgogICAgICBpZiAoX2VuYWJsZWQpIHsKICAgICAgICBfYXN5bmNDb29raWUrKzsKICAgICAgICBwcm9maWxlTmFtZSA9IHR5cGVvZiBwcm9maWxlTmFtZSA9PT0gJ2Z1bmN0aW9uJyA/IHByb2ZpbGVOYW1lKCkgOiBwcm9maWxlTmFtZTsKICAgICAgICBnbG9iYWwubmF0aXZlVHJhY2VCZWdpbkFzeW5jU2VjdGlvbihUUkFDRV9UQUdfUkVBQ1RfQVBQUywgcHJvZmlsZU5hbWUsIGNvb2tpZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBjb29raWU7CiAgICB9LAogICAgZW5kQXN5bmNFdmVudDogZnVuY3Rpb24gZW5kQXN5bmNFdmVudChwcm9maWxlTmFtZSwgY29va2llKSB7CiAgICAgIGlmIChfZW5hYmxlZCkgewogICAgICAgIHByb2ZpbGVOYW1lID0gdHlwZW9mIHByb2ZpbGVOYW1lID09PSAnZnVuY3Rpb24nID8gcHJvZmlsZU5hbWUoKSA6IHByb2ZpbGVOYW1lOwogICAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUVuZEFzeW5jU2VjdGlvbihUUkFDRV9UQUdfUkVBQ1RfQVBQUywgcHJvZmlsZU5hbWUsIGNvb2tpZSk7CiAgICAgIH0KICAgIH0sCiAgICBjb3VudGVyRXZlbnQ6IGZ1bmN0aW9uIGNvdW50ZXJFdmVudChwcm9maWxlTmFtZSwgdmFsdWUpIHsKICAgICAgaWYgKF9lbmFibGVkKSB7CiAgICAgICAgcHJvZmlsZU5hbWUgPSB0eXBlb2YgcHJvZmlsZU5hbWUgPT09ICdmdW5jdGlvbicgPyBwcm9maWxlTmFtZSgpIDogcHJvZmlsZU5hbWU7CiAgICAgICAgZ2xvYmFsLm5hdGl2ZVRyYWNlQ291bnRlciAmJiBnbG9iYWwubmF0aXZlVHJhY2VDb3VudGVyKFRSQUNFX1RBR19SRUFDVF9BUFBTLCBwcm9maWxlTmFtZSwgdmFsdWUpOwogICAgICB9CiAgICB9LAogICAgYXR0YWNoVG9SZWxheVByb2ZpbGVyOiBmdW5jdGlvbiBhdHRhY2hUb1JlbGF5UHJvZmlsZXIocmVsYXlQcm9maWxlcikgewogICAgICByZWxheVByb2ZpbGVyLmF0dGFjaFByb2ZpbGVIYW5kbGVyKCcqJywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgY29va2llID0gU3lzdHJhY2UuYmVnaW5Bc3luY0V2ZW50KG5hbWUpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBTeXN0cmFjZS5lbmRBc3luY0V2ZW50KG5hbWUsIGNvb2tpZSk7CiAgICAgICAgfTsKICAgICAgfSk7CiAgICAgIHJlbGF5UHJvZmlsZXIuYXR0YWNoQWdncmVnYXRlSGFuZGxlcignKicsIGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaykgewogICAgICAgIFN5c3RyYWNlLmJlZ2luRXZlbnQobmFtZSk7CiAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICBTeXN0cmFjZS5lbmRFdmVudCgpOwogICAgICB9KTsKICAgIH0sCiAgICBzd2l6emxlSlNPTjogZnVuY3Rpb24gc3dpenpsZUpTT04oKSB7CiAgICAgIFN5c3RyYWNlLm1lYXN1cmVNZXRob2RzKEpTT04sICdKU09OJywgWydwYXJzZScsICdzdHJpbmdpZnknXSk7CiAgICB9LAogICAgbWVhc3VyZU1ldGhvZHM6IGZ1bmN0aW9uIG1lYXN1cmVNZXRob2RzKG9iamVjdCwgb2JqZWN0TmFtZSwgbWV0aG9kTmFtZXMpIHsKICAgICAgaWYgKCFfX0RFVl9fKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBtZXRob2ROYW1lcy5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CiAgICAgICAgb2JqZWN0W21ldGhvZE5hbWVdID0gU3lzdHJhY2UubWVhc3VyZShvYmplY3ROYW1lLCBtZXRob2ROYW1lLCBvYmplY3RbbWV0aG9kTmFtZV0pOwogICAgICB9KTsKICAgIH0sCiAgICBtZWFzdXJlOiBmdW5jdGlvbiBtZWFzdXJlKG9iak5hbWUsIGZuTmFtZSwgZnVuYykgewogICAgICBpZiAoIV9fREVWX18pIHsKICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgfQoKICAgICAgdmFyIHByb2ZpbGVOYW1lID0gb2JqTmFtZSArICIuIiArIGZuTmFtZTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIV9lbmFibGVkKSB7CiAgICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KCiAgICAgICAgU3lzdHJhY2UuYmVnaW5FdmVudChwcm9maWxlTmFtZSk7CiAgICAgICAgdmFyIHJldCA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICBTeXN0cmFjZS5lbmRFdmVudCgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH07CiAgICB9CiAgfTsKCiAgaWYgKF9fREVWX18pIHsKICAgIHJlcXVpcmUuU3lzdHJhY2UgPSBTeXN0cmFjZTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gU3lzdHJhY2U7Cn0sMTksWzEzLDIwLDEyMV0sIlN5c3RyYWNlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX3JlcXVpcmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiUmVhY3ROYXRpdmUiKSwKICAgICAgX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQgPSBfcmVxdWlyZS5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRDsKCiAgbW9kdWxlLmV4cG9ydHMgPSBfX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRC5SZWFjdEdsb2JhbFNoYXJlZFN0YXRlOwp9LDIwLFsyMV0sIlJlYWN0R2xvYmFsU2hhcmVkU3RhdGUiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBSZWFjdE5hdGl2ZSA9IHZvaWQgMDsKCiAgaWYgKF9fREVWX18pIHsKICAgIFJlYWN0TmF0aXZlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0TmF0aXZlUmVuZGVyZXItZGV2Iik7CiAgfSBlbHNlIHsKICAgIFJlYWN0TmF0aXZlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlJlYWN0TmF0aXZlUmVuZGVyZXItcHJvZCIpOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBSZWFjdE5hdGl2ZTsKfSwyMSxbMjIsMTIwXSwiUmVhY3ROYXRpdmUiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIGlmIChfX0RFVl9fKSB7CiAgICAoZnVuY3Rpb24gKCkgewogICAgICAidXNlIHN0cmljdCI7CgogICAgICByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiSW5pdGlhbGl6ZUNvcmUiKTsKCiAgICAgIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogICAgICB2YXIgd2FybmluZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJmYmpzL2xpYi93YXJuaW5nIik7CgogICAgICB2YXIgZW1wdHlGdW5jdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJmYmpzL2xpYi9lbXB0eUZ1bmN0aW9uIik7CgogICAgICB2YXIgUkNURXZlbnRFbWl0dGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlJDVEV2ZW50RW1pdHRlciIpOwoKICAgICAgdmFyIFVJTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJVSU1hbmFnZXIiKTsKCiAgICAgIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJyZWFjdCIpOwoKICAgICAgdmFyIEV4Y2VwdGlvbnNNYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgIkV4Y2VwdGlvbnNNYW5hZ2VyIik7CgogICAgICB2YXIgVGV4dElucHV0U3RhdGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAiVGV4dElucHV0U3RhdGUiKTsKCiAgICAgIHZhciBkZWVwRGlmZmVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs5XSwgImRlZXBEaWZmZXIiKTsKCiAgICAgIHZhciBmbGF0dGVuU3R5bGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEwXSwgImZsYXR0ZW5TdHlsZSIpOwoKICAgICAgdmFyIGVtcHR5T2JqZWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMV0sICJmYmpzL2xpYi9lbXB0eU9iamVjdCIpOwoKICAgICAgdmFyIGNoZWNrUHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMl0sICJwcm9wLXR5cGVzL2NoZWNrUHJvcFR5cGVzIik7CgogICAgICB2YXIgc2hhbGxvd0VxdWFsID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxM10sICJmYmpzL2xpYi9zaGFsbG93RXF1YWwiKTsKCiAgICAgIHZhciBkZWVwRnJlZXplQW5kVGhyb3dPbk11dGF0aW9uSW5EZXYgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE0XSwgImRlZXBGcmVlemVBbmRUaHJvd09uTXV0YXRpb25JbkRldiIpOwoKICAgICAgdmFyIFJlYWN0RXJyb3JVdGlscyA9IHsKICAgICAgICBfY2F1Z2h0RXJyb3I6IG51bGwsCiAgICAgICAgX2hhc0NhdWdodEVycm9yOiBmYWxzZSwKICAgICAgICBfcmV0aHJvd0Vycm9yOiBudWxsLAogICAgICAgIF9oYXNSZXRocm93RXJyb3I6IGZhbHNlLAogICAgICAgIGluamVjdGlvbjogewogICAgICAgICAgaW5qZWN0RXJyb3JVdGlsczogZnVuY3Rpb24gaW5qZWN0RXJyb3JVdGlscyhpbmplY3RlZEVycm9yVXRpbHMpIHsKICAgICAgICAgICAgaW52YXJpYW50KHR5cGVvZiBpbmplY3RlZEVycm9yVXRpbHMuaW52b2tlR3VhcmRlZENhbGxiYWNrID09PSAiZnVuY3Rpb24iLCAiSW5qZWN0ZWQgaW52b2tlR3VhcmRlZENhbGxiYWNrKCkgbXVzdCBiZSBhIGZ1bmN0aW9uLiIpOwogICAgICAgICAgICBfaW52b2tlR3VhcmRlZENhbGxiYWNrID0gaW5qZWN0ZWRFcnJvclV0aWxzLmludm9rZUd1YXJkZWRDYWxsYmFjazsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjazogZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIF9pbnZva2VHdWFyZGVkQ2FsbGJhY2suYXBwbHkoUmVhY3RFcnJvclV0aWxzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCiAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yOiBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tBbmRDYXRjaEZpcnN0RXJyb3IobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgUmVhY3RFcnJvclV0aWxzLmludm9rZUd1YXJkZWRDYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAgIGlmIChSZWFjdEVycm9yVXRpbHMuaGFzQ2F1Z2h0RXJyb3IoKSkgewogICAgICAgICAgICB2YXIgZXJyb3IgPSBSZWFjdEVycm9yVXRpbHMuY2xlYXJDYXVnaHRFcnJvcigpOwoKICAgICAgICAgICAgaWYgKCFSZWFjdEVycm9yVXRpbHMuX2hhc1JldGhyb3dFcnJvcikgewogICAgICAgICAgICAgIFJlYWN0RXJyb3JVdGlscy5faGFzUmV0aHJvd0Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICBSZWFjdEVycm9yVXRpbHMuX3JldGhyb3dFcnJvciA9IGVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICByZXRocm93Q2F1Z2h0RXJyb3I6IGZ1bmN0aW9uIHJldGhyb3dDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIHJldHVybiBfcmV0aHJvd0NhdWdodEVycm9yLmFwcGx5KFJlYWN0RXJyb3JVdGlscywgYXJndW1lbnRzKTsKICAgICAgICB9LAogICAgICAgIGhhc0NhdWdodEVycm9yOiBmdW5jdGlvbiBoYXNDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIHJldHVybiBSZWFjdEVycm9yVXRpbHMuX2hhc0NhdWdodEVycm9yOwogICAgICAgIH0sCiAgICAgICAgY2xlYXJDYXVnaHRFcnJvcjogZnVuY3Rpb24gY2xlYXJDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIGlmIChSZWFjdEVycm9yVXRpbHMuX2hhc0NhdWdodEVycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvciA9IFJlYWN0RXJyb3JVdGlscy5fY2F1Z2h0RXJyb3I7CiAgICAgICAgICAgIFJlYWN0RXJyb3JVdGlscy5fY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgICBSZWFjdEVycm9yVXRpbHMuX2hhc0NhdWdodEVycm9yID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiBlcnJvcjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgImNsZWFyQ2F1Z2h0RXJyb3Igd2FzIGNhbGxlZCBidXQgbm8gZXJyb3Igd2FzIGNhcHR1cmVkLiBUaGlzIGVycm9yICIgKyAiaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIF9pbnZva2VHdWFyZGVkQ2FsbGJhY2sgPSBmdW5jdGlvbiBfaW52b2tlR3VhcmRlZENhbGxiYWNrKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICBSZWFjdEVycm9yVXRpbHMuX2hhc0NhdWdodEVycm9yID0gZmFsc2U7CiAgICAgICAgUmVhY3RFcnJvclV0aWxzLl9jYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIGZ1bmNBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgZnVuY0FyZ3MpOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICBSZWFjdEVycm9yVXRpbHMuX2NhdWdodEVycm9yID0gZXJyb3I7CiAgICAgICAgICBSZWFjdEVycm9yVXRpbHMuX2hhc0NhdWdodEVycm9yID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB7CiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiB3aW5kb3cuZGlzcGF0Y2hFdmVudCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFdmVudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdmFyIGZha2VOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicmVhY3QiKTsKCiAgICAgICAgICB2YXIgaW52b2tlR3VhcmRlZENhbGxiYWNrRGV2ID0gZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrRGV2KG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgICAgaW52YXJpYW50KHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIsICJUaGUgYGRvY3VtZW50YCBnbG9iYWwgd2FzIGRlZmluZWQgd2hlbiBSZWFjdCB3YXMgaW5pdGlhbGl6ZWQsIGJ1dCBpcyBub3QgIiArICJkZWZpbmVkIGFueW1vcmUuIFRoaXMgY2FuIGhhcHBlbiBpbiBhIHRlc3QgZW52aXJvbm1lbnQgaWYgYSBjb21wb25lbnQgIiArICJzY2hlZHVsZXMgYW4gdXBkYXRlIGZyb20gYW4gYXN5bmNocm9ub3VzIGNhbGxiYWNrLCBidXQgdGhlIHRlc3QgaGFzIGFscmVhZHkgIiArICJmaW5pc2hlZCBydW5uaW5nLiBUbyBzb2x2ZSB0aGlzLCB5b3UgY2FuIGVpdGhlciB1bm1vdW50IHRoZSBjb21wb25lbnQgYXQgIiArICJ0aGUgZW5kIG9mIHlvdXIgdGVzdCAoYW5kIGVuc3VyZSB0aGF0IGFueSBhc3luY2hyb25vdXMgb3BlcmF0aW9ucyBnZXQgIiArICJjYW5jZWxlZCBpbiBgY29tcG9uZW50V2lsbFVubW91bnRgKSwgb3IgeW91IGNhbiBjaGFuZ2UgdGhlIHRlc3QgaXRzZWxmICIgKyAidG8gYmUgYXN5bmNocm9ub3VzLiIpOwogICAgICAgICAgICB2YXIgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIkV2ZW50Iik7CiAgICAgICAgICAgIHZhciBkaWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgIHZhciBmdW5jQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CgogICAgICAgICAgICBmdW5jdGlvbiBjYWxsQ2FsbGJhY2soKSB7CiAgICAgICAgICAgICAgZmFrZU5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnRUeXBlLCBjYWxsQ2FsbGJhY2ssIGZhbHNlKTsKICAgICAgICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGZ1bmNBcmdzKTsKICAgICAgICAgICAgICBkaWRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZXJyb3IgPSB2b2lkIDA7CiAgICAgICAgICAgIHZhciBkaWRTZXRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgaXNDcm9zc09yaWdpbkVycm9yID0gZmFsc2U7CgogICAgICAgICAgICBmdW5jdGlvbiBvbkVycm9yKGV2ZW50KSB7CiAgICAgICAgICAgICAgZXJyb3IgPSBldmVudC5lcnJvcjsKICAgICAgICAgICAgICBkaWRTZXRFcnJvciA9IHRydWU7CgogICAgICAgICAgICAgIGlmIChlcnJvciA9PT0gbnVsbCAmJiBldmVudC5jb2xubyA9PT0gMCAmJiBldmVudC5saW5lbm8gPT09IDApIHsKICAgICAgICAgICAgICAgIGlzQ3Jvc3NPcmlnaW5FcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZXZ0VHlwZSA9ICJyZWFjdC0iICsgKG5hbWUgPyBuYW1lIDogImludm9rZWd1YXJkZWRjYWxsYmFjayIpOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBvbkVycm9yKTsKICAgICAgICAgICAgZmFrZU5vZGUuYWRkRXZlbnRMaXN0ZW5lcihldnRUeXBlLCBjYWxsQ2FsbGJhY2ssIGZhbHNlKTsKICAgICAgICAgICAgZXZ0LmluaXRFdmVudChldnRUeXBlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICBmYWtlTm9kZS5kaXNwYXRjaEV2ZW50KGV2dCk7CgogICAgICAgICAgICBpZiAoZGlkRXJyb3IpIHsKICAgICAgICAgICAgICBpZiAoIWRpZFNldEVycm9yKSB7CiAgICAgICAgICAgICAgICBlcnJvciA9IG5ldyBFcnJvcigiQW4gZXJyb3Igd2FzIHRocm93biBpbnNpZGUgb25lIG9mIHlvdXIgY29tcG9uZW50cywgYnV0IFJlYWN0ICIgKyAiZG9lc24ndCBrbm93IHdoYXQgaXQgd2FzLiBUaGlzIGlzIGxpa2VseSBkdWUgdG8gYnJvd3NlciAiICsgJ2ZsYWtpbmVzcy4gUmVhY3QgZG9lcyBpdHMgYmVzdCB0byBwcmVzZXJ2ZSB0aGUgIlBhdXNlIG9uICcgKyAnZXhjZXB0aW9ucyIgYmVoYXZpb3Igb2YgdGhlIERldlRvb2xzLCB3aGljaCByZXF1aXJlcyBzb21lICcgKyAiREVWLW1vZGUgb25seSB0cmlja3MuIEl0J3MgcG9zc2libGUgdGhhdCB0aGVzZSBkb24ndCB3b3JrIGluICIgKyAieW91ciBicm93c2VyLiBUcnkgdHJpZ2dlcmluZyB0aGUgZXJyb3IgaW4gcHJvZHVjdGlvbiBtb2RlLCAiICsgIm9yIHN3aXRjaGluZyB0byBhIG1vZGVybiBicm93c2VyLiBJZiB5b3Ugc3VzcGVjdCB0aGF0IHRoaXMgaXMgIiArICJhY3R1YWxseSBhbiBpc3N1ZSB3aXRoIFJlYWN0LCBwbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQ3Jvc3NPcmlnaW5FcnJvcikgewogICAgICAgICAgICAgICAgZXJyb3IgPSBuZXcgRXJyb3IoIkEgY3Jvc3Mtb3JpZ2luIGVycm9yIHdhcyB0aHJvd24uIFJlYWN0IGRvZXNuJ3QgaGF2ZSBhY2Nlc3MgdG8gIiArICJ0aGUgYWN0dWFsIGVycm9yIG9iamVjdCBpbiBkZXZlbG9wbWVudC4gIiArICJTZWUgaHR0cHM6Ly9mYi5tZS9yZWFjdC1jcm9zc29yaWdpbi1lcnJvciBmb3IgbW9yZSBpbmZvcm1hdGlvbi4iKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIFJlYWN0RXJyb3JVdGlscy5faGFzQ2F1Z2h0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgIFJlYWN0RXJyb3JVdGlscy5fY2F1Z2h0RXJyb3IgPSBlcnJvcjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdEVycm9yVXRpbHMuX2hhc0NhdWdodEVycm9yID0gZmFsc2U7CiAgICAgICAgICAgICAgUmVhY3RFcnJvclV0aWxzLl9jYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJlcnJvciIsIG9uRXJyb3IpOwogICAgICAgICAgfTsKCiAgICAgICAgICBfaW52b2tlR3VhcmRlZENhbGxiYWNrID0gaW52b2tlR3VhcmRlZENhbGxiYWNrRGV2OwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIF9yZXRocm93Q2F1Z2h0RXJyb3IgPSBmdW5jdGlvbiBfcmV0aHJvd0NhdWdodEVycm9yKCkgewogICAgICAgIGlmIChSZWFjdEVycm9yVXRpbHMuX2hhc1JldGhyb3dFcnJvcikgewogICAgICAgICAgdmFyIGVycm9yID0gUmVhY3RFcnJvclV0aWxzLl9yZXRocm93RXJyb3I7CiAgICAgICAgICBSZWFjdEVycm9yVXRpbHMuX3JldGhyb3dFcnJvciA9IG51bGw7CiAgICAgICAgICBSZWFjdEVycm9yVXRpbHMuX2hhc1JldGhyb3dFcnJvciA9IGZhbHNlOwogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIGV2ZW50UGx1Z2luT3JkZXIgPSBudWxsOwogICAgICB2YXIgbmFtZXNUb1BsdWdpbnMgPSB7fTsKCiAgICAgIGZ1bmN0aW9uIHJlY29tcHV0ZVBsdWdpbk9yZGVyaW5nKCkgewogICAgICAgIGlmICghZXZlbnRQbHVnaW5PcmRlcikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgcGx1Z2luTmFtZSBpbiBuYW1lc1RvUGx1Z2lucykgewogICAgICAgICAgdmFyIHBsdWdpbk1vZHVsZSA9IG5hbWVzVG9QbHVnaW5zW3BsdWdpbk5hbWVdOwogICAgICAgICAgdmFyIHBsdWdpbkluZGV4ID0gZXZlbnRQbHVnaW5PcmRlci5pbmRleE9mKHBsdWdpbk5hbWUpOwogICAgICAgICAgaW52YXJpYW50KHBsdWdpbkluZGV4ID4gLTEsICJFdmVudFBsdWdpblJlZ2lzdHJ5OiBDYW5ub3QgaW5qZWN0IGV2ZW50IHBsdWdpbnMgdGhhdCBkbyBub3QgZXhpc3QgaW4gIiArICJ0aGUgcGx1Z2luIG9yZGVyaW5nLCBgJXNgLiIsIHBsdWdpbk5hbWUpOwoKICAgICAgICAgIGlmIChwbHVnaW5zW3BsdWdpbkluZGV4XSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpbnZhcmlhbnQocGx1Z2luTW9kdWxlLmV4dHJhY3RFdmVudHMsICJFdmVudFBsdWdpblJlZ2lzdHJ5OiBFdmVudCBwbHVnaW5zIG11c3QgaW1wbGVtZW50IGFuIGBleHRyYWN0RXZlbnRzYCAiICsgIm1ldGhvZCwgYnV0IGAlc2AgZG9lcyBub3QuIiwgcGx1Z2luTmFtZSk7CiAgICAgICAgICBwbHVnaW5zW3BsdWdpbkluZGV4XSA9IHBsdWdpbk1vZHVsZTsKICAgICAgICAgIHZhciBwdWJsaXNoZWRFdmVudHMgPSBwbHVnaW5Nb2R1bGUuZXZlbnRUeXBlczsKCiAgICAgICAgICBmb3IgKHZhciBldmVudE5hbWUgaW4gcHVibGlzaGVkRXZlbnRzKSB7CiAgICAgICAgICAgIGludmFyaWFudChwdWJsaXNoRXZlbnRGb3JQbHVnaW4ocHVibGlzaGVkRXZlbnRzW2V2ZW50TmFtZV0sIHBsdWdpbk1vZHVsZSwgZXZlbnROYW1lKSwgIkV2ZW50UGx1Z2luUmVnaXN0cnk6IEZhaWxlZCB0byBwdWJsaXNoIGV2ZW50IGAlc2AgZm9yIHBsdWdpbiBgJXNgLiIsIGV2ZW50TmFtZSwgcGx1Z2luTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBwdWJsaXNoRXZlbnRGb3JQbHVnaW4oZGlzcGF0Y2hDb25maWcsIHBsdWdpbk1vZHVsZSwgZXZlbnROYW1lKSB7CiAgICAgICAgaW52YXJpYW50KCFldmVudE5hbWVEaXNwYXRjaENvbmZpZ3MuaGFzT3duUHJvcGVydHkoZXZlbnROYW1lKSwgIkV2ZW50UGx1Z2luSHViOiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSAiICsgImV2ZW50IG5hbWUsIGAlc2AuIiwgZXZlbnROYW1lKTsKICAgICAgICBldmVudE5hbWVEaXNwYXRjaENvbmZpZ3NbZXZlbnROYW1lXSA9IGRpc3BhdGNoQ29uZmlnOwogICAgICAgIHZhciBwaGFzZWRSZWdpc3RyYXRpb25OYW1lcyA9IGRpc3BhdGNoQ29uZmlnLnBoYXNlZFJlZ2lzdHJhdGlvbk5hbWVzOwoKICAgICAgICBpZiAocGhhc2VkUmVnaXN0cmF0aW9uTmFtZXMpIHsKICAgICAgICAgIGZvciAodmFyIHBoYXNlTmFtZSBpbiBwaGFzZWRSZWdpc3RyYXRpb25OYW1lcykgewogICAgICAgICAgICBpZiAocGhhc2VkUmVnaXN0cmF0aW9uTmFtZXMuaGFzT3duUHJvcGVydHkocGhhc2VOYW1lKSkgewogICAgICAgICAgICAgIHZhciBwaGFzZWRSZWdpc3RyYXRpb25OYW1lID0gcGhhc2VkUmVnaXN0cmF0aW9uTmFtZXNbcGhhc2VOYW1lXTsKICAgICAgICAgICAgICBwdWJsaXNoUmVnaXN0cmF0aW9uTmFtZShwaGFzZWRSZWdpc3RyYXRpb25OYW1lLCBwbHVnaW5Nb2R1bGUsIGV2ZW50TmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKGRpc3BhdGNoQ29uZmlnLnJlZ2lzdHJhdGlvbk5hbWUpIHsKICAgICAgICAgIHB1Ymxpc2hSZWdpc3RyYXRpb25OYW1lKGRpc3BhdGNoQ29uZmlnLnJlZ2lzdHJhdGlvbk5hbWUsIHBsdWdpbk1vZHVsZSwgZXZlbnROYW1lKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwdWJsaXNoUmVnaXN0cmF0aW9uTmFtZShyZWdpc3RyYXRpb25OYW1lLCBwbHVnaW5Nb2R1bGUsIGV2ZW50TmFtZSkgewogICAgICAgIGludmFyaWFudCghcmVnaXN0cmF0aW9uTmFtZU1vZHVsZXNbcmVnaXN0cmF0aW9uTmFtZV0sICJFdmVudFBsdWdpbkh1YjogTW9yZSB0aGFuIG9uZSBwbHVnaW4gYXR0ZW1wdGVkIHRvIHB1Ymxpc2ggdGhlIHNhbWUgIiArICJyZWdpc3RyYXRpb24gbmFtZSwgYCVzYC4iLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICByZWdpc3RyYXRpb25OYW1lTW9kdWxlc1tyZWdpc3RyYXRpb25OYW1lXSA9IHBsdWdpbk1vZHVsZTsKICAgICAgICByZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzW3JlZ2lzdHJhdGlvbk5hbWVdID0gcGx1Z2luTW9kdWxlLmV2ZW50VHlwZXNbZXZlbnROYW1lXS5kZXBlbmRlbmNpZXM7CiAgICAgICAgewogICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcmVnaXN0cmF0aW9uTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHBsdWdpbnMgPSBbXTsKICAgICAgdmFyIGV2ZW50TmFtZURpc3BhdGNoQ29uZmlncyA9IHt9OwogICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZU1vZHVsZXMgPSB7fTsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMgPSB7fTsKCiAgICAgIGZ1bmN0aW9uIGluamVjdEV2ZW50UGx1Z2luT3JkZXIoaW5qZWN0ZWRFdmVudFBsdWdpbk9yZGVyKSB7CiAgICAgICAgaW52YXJpYW50KCFldmVudFBsdWdpbk9yZGVyLCAiRXZlbnRQbHVnaW5SZWdpc3RyeTogQ2Fubm90IGluamVjdCBldmVudCBwbHVnaW4gb3JkZXJpbmcgbW9yZSB0aGFuICIgKyAib25jZS4gWW91IGFyZSBsaWtlbHkgdHJ5aW5nIHRvIGxvYWQgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0LiIpOwogICAgICAgIGV2ZW50UGx1Z2luT3JkZXIgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChpbmplY3RlZEV2ZW50UGx1Z2luT3JkZXIpOwogICAgICAgIHJlY29tcHV0ZVBsdWdpbk9yZGVyaW5nKCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGluamVjdEV2ZW50UGx1Z2luc0J5TmFtZShpbmplY3RlZE5hbWVzVG9QbHVnaW5zKSB7CiAgICAgICAgdmFyIGlzT3JkZXJpbmdEaXJ0eSA9IGZhbHNlOwoKICAgICAgICBmb3IgKHZhciBwbHVnaW5OYW1lIGluIGluamVjdGVkTmFtZXNUb1BsdWdpbnMpIHsKICAgICAgICAgIGlmICghaW5qZWN0ZWROYW1lc1RvUGx1Z2lucy5oYXNPd25Qcm9wZXJ0eShwbHVnaW5OYW1lKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgcGx1Z2luTW9kdWxlID0gaW5qZWN0ZWROYW1lc1RvUGx1Z2luc1twbHVnaW5OYW1lXTsKCiAgICAgICAgICBpZiAoIW5hbWVzVG9QbHVnaW5zLmhhc093blByb3BlcnR5KHBsdWdpbk5hbWUpIHx8IG5hbWVzVG9QbHVnaW5zW3BsdWdpbk5hbWVdICE9PSBwbHVnaW5Nb2R1bGUpIHsKICAgICAgICAgICAgaW52YXJpYW50KCFuYW1lc1RvUGx1Z2luc1twbHVnaW5OYW1lXSwgIkV2ZW50UGx1Z2luUmVnaXN0cnk6IENhbm5vdCBpbmplY3QgdHdvIGRpZmZlcmVudCBldmVudCBwbHVnaW5zICIgKyAidXNpbmcgdGhlIHNhbWUgbmFtZSwgYCVzYC4iLCBwbHVnaW5OYW1lKTsKICAgICAgICAgICAgbmFtZXNUb1BsdWdpbnNbcGx1Z2luTmFtZV0gPSBwbHVnaW5Nb2R1bGU7CiAgICAgICAgICAgIGlzT3JkZXJpbmdEaXJ0eSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNPcmRlcmluZ0RpcnR5KSB7CiAgICAgICAgICByZWNvbXB1dGVQbHVnaW5PcmRlcmluZygpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUgPSBudWxsOwogICAgICB2YXIgZ2V0SW5zdGFuY2VGcm9tTm9kZSA9IG51bGw7CiAgICAgIHZhciBnZXROb2RlRnJvbUluc3RhbmNlID0gbnVsbDsKICAgICAgdmFyIGluamVjdGlvbiQxID0gewogICAgICAgIGluamVjdENvbXBvbmVudFRyZWU6IGZ1bmN0aW9uIGluamVjdENvbXBvbmVudFRyZWUoSW5qZWN0ZWQpIHsKICAgICAgICAgIGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUgPSBJbmplY3RlZC5nZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlOwogICAgICAgICAgZ2V0SW5zdGFuY2VGcm9tTm9kZSA9IEluamVjdGVkLmdldEluc3RhbmNlRnJvbU5vZGU7CiAgICAgICAgICBnZXROb2RlRnJvbUluc3RhbmNlID0gSW5qZWN0ZWQuZ2V0Tm9kZUZyb21JbnN0YW5jZTsKICAgICAgICAgIHsKICAgICAgICAgICAgd2FybmluZyhnZXROb2RlRnJvbUluc3RhbmNlICYmIGdldEluc3RhbmNlRnJvbU5vZGUsICJFdmVudFBsdWdpblV0aWxzLmluamVjdGlvbi5pbmplY3RDb21wb25lbnRUcmVlKC4uLik6IEluamVjdGVkICIgKyAibW9kdWxlIGlzIG1pc3NpbmcgZ2V0Tm9kZUZyb21JbnN0YW5jZSBvciBnZXRJbnN0YW5jZUZyb21Ob2RlLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIGlzRW5kaXNoKHRvcExldmVsVHlwZSkgewogICAgICAgIHJldHVybiB0b3BMZXZlbFR5cGUgPT09ICJ0b3BNb3VzZVVwIiB8fCB0b3BMZXZlbFR5cGUgPT09ICJ0b3BUb3VjaEVuZCIgfHwgdG9wTGV2ZWxUeXBlID09PSAidG9wVG91Y2hDYW5jZWwiOwogICAgICB9CgogICAgICBmdW5jdGlvbiBpc01vdmVpc2godG9wTGV2ZWxUeXBlKSB7CiAgICAgICAgcmV0dXJuIHRvcExldmVsVHlwZSA9PT0gInRvcE1vdXNlTW92ZSIgfHwgdG9wTGV2ZWxUeXBlID09PSAidG9wVG91Y2hNb3ZlIjsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gaXNTdGFydGlzaCh0b3BMZXZlbFR5cGUpIHsKICAgICAgICByZXR1cm4gdG9wTGV2ZWxUeXBlID09PSAidG9wTW91c2VEb3duIiB8fCB0b3BMZXZlbFR5cGUgPT09ICJ0b3BUb3VjaFN0YXJ0IjsKICAgICAgfQoKICAgICAgdmFyIHZhbGlkYXRlRXZlbnREaXNwYXRjaGVzOwogICAgICB7CiAgICAgICAgdmFsaWRhdGVFdmVudERpc3BhdGNoZXMgPSBmdW5jdGlvbiB2YWxpZGF0ZUV2ZW50RGlzcGF0Y2hlcyhldmVudCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoTGlzdGVuZXJzID0gZXZlbnQuX2Rpc3BhdGNoTGlzdGVuZXJzOwogICAgICAgICAgdmFyIGRpc3BhdGNoSW5zdGFuY2VzID0gZXZlbnQuX2Rpc3BhdGNoSW5zdGFuY2VzOwogICAgICAgICAgdmFyIGxpc3RlbmVyc0lzQXJyID0gQXJyYXkuaXNBcnJheShkaXNwYXRjaExpc3RlbmVycyk7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzTGVuID0gbGlzdGVuZXJzSXNBcnIgPyBkaXNwYXRjaExpc3RlbmVycy5sZW5ndGggOiBkaXNwYXRjaExpc3RlbmVycyA/IDEgOiAwOwogICAgICAgICAgdmFyIGluc3RhbmNlc0lzQXJyID0gQXJyYXkuaXNBcnJheShkaXNwYXRjaEluc3RhbmNlcyk7CiAgICAgICAgICB2YXIgaW5zdGFuY2VzTGVuID0gaW5zdGFuY2VzSXNBcnIgPyBkaXNwYXRjaEluc3RhbmNlcy5sZW5ndGggOiBkaXNwYXRjaEluc3RhbmNlcyA/IDEgOiAwOwogICAgICAgICAgd2FybmluZyhpbnN0YW5jZXNJc0FyciA9PT0gbGlzdGVuZXJzSXNBcnIgJiYgaW5zdGFuY2VzTGVuID09PSBsaXN0ZW5lcnNMZW4sICJFdmVudFBsdWdpblV0aWxzOiBJbnZhbGlkIGBldmVudGAuIik7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBzaW11bGF0ZWQsIGxpc3RlbmVyLCBpbnN0KSB7CiAgICAgICAgdmFyIHR5cGUgPSBldmVudC50eXBlIHx8ICJ1bmtub3duLWV2ZW50IjsKICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gZ2V0Tm9kZUZyb21JbnN0YW5jZShpbnN0KTsKICAgICAgICBSZWFjdEVycm9yVXRpbHMuaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKHR5cGUsIGxpc3RlbmVyLCB1bmRlZmluZWQsIGV2ZW50KTsKICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZXhlY3V0ZURpc3BhdGNoZXNJbk9yZGVyKGV2ZW50LCBzaW11bGF0ZWQpIHsKICAgICAgICB2YXIgZGlzcGF0Y2hMaXN0ZW5lcnMgPSBldmVudC5fZGlzcGF0Y2hMaXN0ZW5lcnM7CiAgICAgICAgdmFyIGRpc3BhdGNoSW5zdGFuY2VzID0gZXZlbnQuX2Rpc3BhdGNoSW5zdGFuY2VzOwogICAgICAgIHsKICAgICAgICAgIHZhbGlkYXRlRXZlbnREaXNwYXRjaGVzKGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGRpc3BhdGNoTGlzdGVuZXJzKSkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXNwYXRjaExpc3RlbmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIHNpbXVsYXRlZCwgZGlzcGF0Y2hMaXN0ZW5lcnNbaV0sIGRpc3BhdGNoSW5zdGFuY2VzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGRpc3BhdGNoTGlzdGVuZXJzKSB7CiAgICAgICAgICBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIHNpbXVsYXRlZCwgZGlzcGF0Y2hMaXN0ZW5lcnMsIGRpc3BhdGNoSW5zdGFuY2VzKTsKICAgICAgICB9CgogICAgICAgIGV2ZW50Ll9kaXNwYXRjaExpc3RlbmVycyA9IG51bGw7CiAgICAgICAgZXZlbnQuX2Rpc3BhdGNoSW5zdGFuY2VzID0gbnVsbDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZXhlY3V0ZURpc3BhdGNoZXNJbk9yZGVyU3RvcEF0VHJ1ZUltcGwoZXZlbnQpIHsKICAgICAgICB2YXIgZGlzcGF0Y2hMaXN0ZW5lcnMgPSBldmVudC5fZGlzcGF0Y2hMaXN0ZW5lcnM7CiAgICAgICAgdmFyIGRpc3BhdGNoSW5zdGFuY2VzID0gZXZlbnQuX2Rpc3BhdGNoSW5zdGFuY2VzOwogICAgICAgIHsKICAgICAgICAgIHZhbGlkYXRlRXZlbnREaXNwYXRjaGVzKGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGRpc3BhdGNoTGlzdGVuZXJzKSkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXNwYXRjaExpc3RlbmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlzcGF0Y2hMaXN0ZW5lcnNbaV0oZXZlbnQsIGRpc3BhdGNoSW5zdGFuY2VzW2ldKSkgewogICAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaEluc3RhbmNlc1tpXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZGlzcGF0Y2hMaXN0ZW5lcnMpIHsKICAgICAgICAgIGlmIChkaXNwYXRjaExpc3RlbmVycyhldmVudCwgZGlzcGF0Y2hJbnN0YW5jZXMpKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaEluc3RhbmNlczsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICBmdW5jdGlvbiBleGVjdXRlRGlzcGF0Y2hlc0luT3JkZXJTdG9wQXRUcnVlKGV2ZW50KSB7CiAgICAgICAgdmFyIHJldCA9IGV4ZWN1dGVEaXNwYXRjaGVzSW5PcmRlclN0b3BBdFRydWVJbXBsKGV2ZW50KTsKICAgICAgICBldmVudC5fZGlzcGF0Y2hJbnN0YW5jZXMgPSBudWxsOwogICAgICAgIGV2ZW50Ll9kaXNwYXRjaExpc3RlbmVycyA9IG51bGw7CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZXhlY3V0ZURpcmVjdERpc3BhdGNoKGV2ZW50KSB7CiAgICAgICAgewogICAgICAgICAgdmFsaWRhdGVFdmVudERpc3BhdGNoZXMoZXZlbnQpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlzcGF0Y2hMaXN0ZW5lciA9IGV2ZW50Ll9kaXNwYXRjaExpc3RlbmVyczsKICAgICAgICB2YXIgZGlzcGF0Y2hJbnN0YW5jZSA9IGV2ZW50Ll9kaXNwYXRjaEluc3RhbmNlczsKICAgICAgICBpbnZhcmlhbnQoIUFycmF5LmlzQXJyYXkoZGlzcGF0Y2hMaXN0ZW5lciksICJleGVjdXRlRGlyZWN0RGlzcGF0Y2goLi4uKTogSW52YWxpZCBgZXZlbnRgLiIpOwogICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBkaXNwYXRjaExpc3RlbmVyID8gZ2V0Tm9kZUZyb21JbnN0YW5jZShkaXNwYXRjaEluc3RhbmNlKSA6IG51bGw7CiAgICAgICAgdmFyIHJlcyA9IGRpc3BhdGNoTGlzdGVuZXIgPyBkaXNwYXRjaExpc3RlbmVyKGV2ZW50KSA6IG51bGw7CiAgICAgICAgZXZlbnQuY3VycmVudFRhcmdldCA9IG51bGw7CiAgICAgICAgZXZlbnQuX2Rpc3BhdGNoTGlzdGVuZXJzID0gbnVsbDsKICAgICAgICBldmVudC5fZGlzcGF0Y2hJbnN0YW5jZXMgPSBudWxsOwogICAgICAgIHJldHVybiByZXM7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGhhc0Rpc3BhdGNoZXMoZXZlbnQpIHsKICAgICAgICByZXR1cm4gISFldmVudC5fZGlzcGF0Y2hMaXN0ZW5lcnM7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVJbnRvKGN1cnJlbnQsIG5leHQpIHsKICAgICAgICBpbnZhcmlhbnQobmV4dCAhPSBudWxsLCAiYWNjdW11bGF0ZUludG8oLi4uKTogQWNjdW11bGF0ZWQgaXRlbXMgbXVzdCBub3QgYmUgbnVsbCBvciB1bmRlZmluZWQuIik7CgogICAgICAgIGlmIChjdXJyZW50ID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBuZXh0OwogICAgICAgIH0KCiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3VycmVudCkpIHsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG5leHQpKSB7CiAgICAgICAgICAgIGN1cnJlbnQucHVzaC5hcHBseShjdXJyZW50LCBuZXh0KTsKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICAgICAgICB9CgogICAgICAgICAgY3VycmVudC5wdXNoKG5leHQpOwogICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShuZXh0KSkgewogICAgICAgICAgcmV0dXJuIFtjdXJyZW50XS5jb25jYXQobmV4dCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gW2N1cnJlbnQsIG5leHRdOwogICAgICB9CgogICAgICBmdW5jdGlvbiBmb3JFYWNoQWNjdW11bGF0ZWQoYXJyLCBjYiwgc2NvcGUpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICAgICAgICBhcnIuZm9yRWFjaChjYiwgc2NvcGUpOwogICAgICAgIH0gZWxzZSBpZiAoYXJyKSB7CiAgICAgICAgICBjYi5jYWxsKHNjb3BlLCBhcnIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIGV2ZW50UXVldWUgPSBudWxsOwoKICAgICAgdmFyIGV4ZWN1dGVEaXNwYXRjaGVzQW5kUmVsZWFzZSA9IGZ1bmN0aW9uIGV4ZWN1dGVEaXNwYXRjaGVzQW5kUmVsZWFzZShldmVudCwgc2ltdWxhdGVkKSB7CiAgICAgICAgaWYgKGV2ZW50KSB7CiAgICAgICAgICBleGVjdXRlRGlzcGF0Y2hlc0luT3JkZXIoZXZlbnQsIHNpbXVsYXRlZCk7CgogICAgICAgICAgaWYgKCFldmVudC5pc1BlcnNpc3RlbnQoKSkgewogICAgICAgICAgICBldmVudC5jb25zdHJ1Y3Rvci5yZWxlYXNlKGV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgZXhlY3V0ZURpc3BhdGNoZXNBbmRSZWxlYXNlU2ltdWxhdGVkID0gZnVuY3Rpb24gZXhlY3V0ZURpc3BhdGNoZXNBbmRSZWxlYXNlU2ltdWxhdGVkKGUpIHsKICAgICAgICByZXR1cm4gZXhlY3V0ZURpc3BhdGNoZXNBbmRSZWxlYXNlKGUsIHRydWUpOwogICAgICB9OwoKICAgICAgdmFyIGV4ZWN1dGVEaXNwYXRjaGVzQW5kUmVsZWFzZVRvcExldmVsID0gZnVuY3Rpb24gZXhlY3V0ZURpc3BhdGNoZXNBbmRSZWxlYXNlVG9wTGV2ZWwoZSkgewogICAgICAgIHJldHVybiBleGVjdXRlRGlzcGF0Y2hlc0FuZFJlbGVhc2UoZSwgZmFsc2UpOwogICAgICB9OwoKICAgICAgZnVuY3Rpb24gaXNJbnRlcmFjdGl2ZSh0YWcpIHsKICAgICAgICByZXR1cm4gdGFnID09PSAiYnV0dG9uIiB8fCB0YWcgPT09ICJpbnB1dCIgfHwgdGFnID09PSAic2VsZWN0IiB8fCB0YWcgPT09ICJ0ZXh0YXJlYSI7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KG5hbWUsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICBjYXNlICJvbkNsaWNrIjoKICAgICAgICAgIGNhc2UgIm9uQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgIGNhc2UgIm9uRG91YmxlQ2xpY2siOgogICAgICAgICAgY2FzZSAib25Eb3VibGVDbGlja0NhcHR1cmUiOgogICAgICAgICAgY2FzZSAib25Nb3VzZURvd24iOgogICAgICAgICAgY2FzZSAib25Nb3VzZURvd25DYXB0dXJlIjoKICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlIjoKICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlQ2FwdHVyZSI6CiAgICAgICAgICBjYXNlICJvbk1vdXNlVXAiOgogICAgICAgICAgY2FzZSAib25Nb3VzZVVwQ2FwdHVyZSI6CiAgICAgICAgICAgIHJldHVybiAhIShwcm9wcy5kaXNhYmxlZCAmJiBpc0ludGVyYWN0aXZlKHR5cGUpKTsKCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgaW5qZWN0aW9uID0gewogICAgICAgIGluamVjdEV2ZW50UGx1Z2luT3JkZXI6IGluamVjdEV2ZW50UGx1Z2luT3JkZXIsCiAgICAgICAgaW5qZWN0RXZlbnRQbHVnaW5zQnlOYW1lOiBpbmplY3RFdmVudFBsdWdpbnNCeU5hbWUKICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIGdldExpc3RlbmVyKGluc3QsIHJlZ2lzdHJhdGlvbk5hbWUpIHsKICAgICAgICB2YXIgbGlzdGVuZXI7CiAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGluc3Quc3RhdGVOb2RlOwoKICAgICAgICBpZiAoIXN0YXRlTm9kZSkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICB2YXIgcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSk7CgogICAgICAgIGlmICghcHJvcHMpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgbGlzdGVuZXIgPSBwcm9wc1tyZWdpc3RyYXRpb25OYW1lXTsKCiAgICAgICAgaWYgKHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGluc3QudHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIGludmFyaWFudCghbGlzdGVuZXIgfHwgdHlwZW9mIGxpc3RlbmVyID09PSAiZnVuY3Rpb24iLCAiRXhwZWN0ZWQgYCVzYCBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLCBpbnN0ZWFkIGdvdCBhIHZhbHVlIG9mIGAlc2AgdHlwZS4iLCByZWdpc3RyYXRpb25OYW1lLCB0eXBlb2YgbGlzdGVuZXIpOwogICAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyh0b3BMZXZlbFR5cGUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgIHZhciBldmVudHM7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGx1Z2lucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIHBvc3NpYmxlUGx1Z2luID0gcGx1Z2luc1tpXTsKCiAgICAgICAgICBpZiAocG9zc2libGVQbHVnaW4pIHsKICAgICAgICAgICAgdmFyIGV4dHJhY3RlZEV2ZW50cyA9IHBvc3NpYmxlUGx1Z2luLmV4dHJhY3RFdmVudHModG9wTGV2ZWxUeXBlLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwoKICAgICAgICAgICAgaWYgKGV4dHJhY3RlZEV2ZW50cykgewogICAgICAgICAgICAgIGV2ZW50cyA9IGFjY3VtdWxhdGVJbnRvKGV2ZW50cywgZXh0cmFjdGVkRXZlbnRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZW5xdWV1ZUV2ZW50cyhldmVudHMpIHsKICAgICAgICBpZiAoZXZlbnRzKSB7CiAgICAgICAgICBldmVudFF1ZXVlID0gYWNjdW11bGF0ZUludG8oZXZlbnRRdWV1ZSwgZXZlbnRzKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHByb2Nlc3NFdmVudFF1ZXVlKHNpbXVsYXRlZCkgewogICAgICAgIHZhciBwcm9jZXNzaW5nRXZlbnRRdWV1ZSA9IGV2ZW50UXVldWU7CiAgICAgICAgZXZlbnRRdWV1ZSA9IG51bGw7CgogICAgICAgIGlmICghcHJvY2Vzc2luZ0V2ZW50UXVldWUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChzaW11bGF0ZWQpIHsKICAgICAgICAgIGZvckVhY2hBY2N1bXVsYXRlZChwcm9jZXNzaW5nRXZlbnRRdWV1ZSwgZXhlY3V0ZURpc3BhdGNoZXNBbmRSZWxlYXNlU2ltdWxhdGVkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yRWFjaEFjY3VtdWxhdGVkKHByb2Nlc3NpbmdFdmVudFF1ZXVlLCBleGVjdXRlRGlzcGF0Y2hlc0FuZFJlbGVhc2VUb3BMZXZlbCk7CiAgICAgICAgfQoKICAgICAgICBpbnZhcmlhbnQoIWV2ZW50UXVldWUsICJwcm9jZXNzRXZlbnRRdWV1ZSgpOiBBZGRpdGlvbmFsIGV2ZW50cyB3ZXJlIGVucXVldWVkIHdoaWxlIHByb2Nlc3NpbmcgIiArICJhbiBldmVudCBxdWV1ZS4gU3VwcG9ydCBmb3IgdGhpcyBoYXMgbm90IHlldCBiZWVuIGltcGxlbWVudGVkLiIpOwogICAgICAgIFJlYWN0RXJyb3JVdGlscy5yZXRocm93Q2F1Z2h0RXJyb3IoKTsKICAgICAgfQoKICAgICAgdmFyIEluZGV0ZXJtaW5hdGVDb21wb25lbnQgPSAwOwogICAgICB2YXIgRnVuY3Rpb25hbENvbXBvbmVudCA9IDE7CiAgICAgIHZhciBDbGFzc0NvbXBvbmVudCA9IDI7CiAgICAgIHZhciBIb3N0Um9vdCA9IDM7CiAgICAgIHZhciBIb3N0UG9ydGFsID0gNDsKICAgICAgdmFyIEhvc3RDb21wb25lbnQgPSA1OwogICAgICB2YXIgSG9zdFRleHQgPSA2OwogICAgICB2YXIgQ2FsbENvbXBvbmVudCA9IDc7CiAgICAgIHZhciBDYWxsSGFuZGxlclBoYXNlID0gODsKICAgICAgdmFyIFJldHVybkNvbXBvbmVudCA9IDk7CiAgICAgIHZhciBGcmFnbWVudCA9IDEwOwoKICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50KGluc3QpIHsKICAgICAgICBkbyB7CiAgICAgICAgICBpbnN0ID0gaW5zdFsicmV0dXJuIl07CiAgICAgICAgfSB3aGlsZSAoaW5zdCAmJiBpbnN0LnRhZyAhPT0gSG9zdENvbXBvbmVudCk7CgogICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICByZXR1cm4gaW5zdDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXRMb3dlc3RDb21tb25BbmNlc3RvcihpbnN0QSwgaW5zdEIpIHsKICAgICAgICB2YXIgZGVwdGhBID0gMDsKCiAgICAgICAgZm9yICh2YXIgdGVtcEEgPSBpbnN0QTsgdGVtcEE7IHRlbXBBID0gZ2V0UGFyZW50KHRlbXBBKSkgewogICAgICAgICAgZGVwdGhBKys7CiAgICAgICAgfQoKICAgICAgICB2YXIgZGVwdGhCID0gMDsKCiAgICAgICAgZm9yICh2YXIgdGVtcEIgPSBpbnN0QjsgdGVtcEI7IHRlbXBCID0gZ2V0UGFyZW50KHRlbXBCKSkgewogICAgICAgICAgZGVwdGhCKys7CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoZGVwdGhBIC0gZGVwdGhCID4gMCkgewogICAgICAgICAgaW5zdEEgPSBnZXRQYXJlbnQoaW5zdEEpOwogICAgICAgICAgZGVwdGhBLS07CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoZGVwdGhCIC0gZGVwdGhBID4gMCkgewogICAgICAgICAgaW5zdEIgPSBnZXRQYXJlbnQoaW5zdEIpOwogICAgICAgICAgZGVwdGhCLS07CiAgICAgICAgfQoKICAgICAgICB2YXIgZGVwdGggPSBkZXB0aEE7CgogICAgICAgIHdoaWxlIChkZXB0aC0tKSB7CiAgICAgICAgICBpZiAoaW5zdEEgPT09IGluc3RCIHx8IGluc3RBID09PSBpbnN0Qi5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgcmV0dXJuIGluc3RBOwogICAgICAgICAgfQoKICAgICAgICAgIGluc3RBID0gZ2V0UGFyZW50KGluc3RBKTsKICAgICAgICAgIGluc3RCID0gZ2V0UGFyZW50KGluc3RCKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICBmdW5jdGlvbiBpc0FuY2VzdG9yKGluc3RBLCBpbnN0QikgewogICAgICAgIHdoaWxlIChpbnN0QikgewogICAgICAgICAgaWYgKGluc3RBID09PSBpbnN0QiB8fCBpbnN0QSA9PT0gaW5zdEIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGluc3RCID0gZ2V0UGFyZW50KGluc3RCKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50SW5zdGFuY2UoaW5zdCkgewogICAgICAgIHJldHVybiBnZXRQYXJlbnQoaW5zdCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHRyYXZlcnNlVHdvUGhhc2UoaW5zdCwgZm4sIGFyZykgewogICAgICAgIHZhciBwYXRoID0gW107CgogICAgICAgIHdoaWxlIChpbnN0KSB7CiAgICAgICAgICBwYXRoLnB1c2goaW5zdCk7CiAgICAgICAgICBpbnN0ID0gZ2V0UGFyZW50KGluc3QpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGk7CgogICAgICAgIGZvciAoaSA9IHBhdGgubGVuZ3RoOyBpLS0gPiAwOykgewogICAgICAgICAgZm4ocGF0aFtpXSwgImNhcHR1cmVkIiwgYXJnKTsKICAgICAgICB9CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBwYXRoLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBmbihwYXRoW2ldLCAiYnViYmxlZCIsIGFyZyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBsaXN0ZW5lckF0UGhhc2UoaW5zdCwgZXZlbnQsIHByb3BhZ2F0aW9uUGhhc2UpIHsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZSA9IGV2ZW50LmRpc3BhdGNoQ29uZmlnLnBoYXNlZFJlZ2lzdHJhdGlvbk5hbWVzW3Byb3BhZ2F0aW9uUGhhc2VdOwogICAgICAgIHJldHVybiBnZXRMaXN0ZW5lcihpbnN0LCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZURpcmVjdGlvbmFsRGlzcGF0Y2hlcyhpbnN0LCBwaGFzZSwgZXZlbnQpIHsKICAgICAgICB7CiAgICAgICAgICB3YXJuaW5nKGluc3QsICJEaXNwYXRjaGluZyBpbnN0IG11c3Qgbm90IGJlIG51bGwiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGxpc3RlbmVyID0gbGlzdGVuZXJBdFBoYXNlKGluc3QsIGV2ZW50LCBwaGFzZSk7CgogICAgICAgIGlmIChsaXN0ZW5lcikgewogICAgICAgICAgZXZlbnQuX2Rpc3BhdGNoTGlzdGVuZXJzID0gYWNjdW11bGF0ZUludG8oZXZlbnQuX2Rpc3BhdGNoTGlzdGVuZXJzLCBsaXN0ZW5lcik7CiAgICAgICAgICBldmVudC5fZGlzcGF0Y2hJbnN0YW5jZXMgPSBhY2N1bXVsYXRlSW50byhldmVudC5fZGlzcGF0Y2hJbnN0YW5jZXMsIGluc3QpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZVR3b1BoYXNlRGlzcGF0Y2hlc1NpbmdsZShldmVudCkgewogICAgICAgIGlmIChldmVudCAmJiBldmVudC5kaXNwYXRjaENvbmZpZy5waGFzZWRSZWdpc3RyYXRpb25OYW1lcykgewogICAgICAgICAgdHJhdmVyc2VUd29QaGFzZShldmVudC5fdGFyZ2V0SW5zdCwgYWNjdW11bGF0ZURpcmVjdGlvbmFsRGlzcGF0Y2hlcywgZXZlbnQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZVR3b1BoYXNlRGlzcGF0Y2hlc1NpbmdsZVNraXBUYXJnZXQoZXZlbnQpIHsKICAgICAgICBpZiAoZXZlbnQgJiYgZXZlbnQuZGlzcGF0Y2hDb25maWcucGhhc2VkUmVnaXN0cmF0aW9uTmFtZXMpIHsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gZXZlbnQuX3RhcmdldEluc3Q7CiAgICAgICAgICB2YXIgcGFyZW50SW5zdCA9IHRhcmdldEluc3QgPyBnZXRQYXJlbnRJbnN0YW5jZSh0YXJnZXRJbnN0KSA6IG51bGw7CiAgICAgICAgICB0cmF2ZXJzZVR3b1BoYXNlKHBhcmVudEluc3QsIGFjY3VtdWxhdGVEaXJlY3Rpb25hbERpc3BhdGNoZXMsIGV2ZW50KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVEaXNwYXRjaGVzKGluc3QsIGlnbm9yZWREaXJlY3Rpb24sIGV2ZW50KSB7CiAgICAgICAgaWYgKGluc3QgJiYgZXZlbnQgJiYgZXZlbnQuZGlzcGF0Y2hDb25maWcucmVnaXN0cmF0aW9uTmFtZSkgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBldmVudC5kaXNwYXRjaENvbmZpZy5yZWdpc3RyYXRpb25OYW1lOwogICAgICAgICAgdmFyIGxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdCwgcmVnaXN0cmF0aW9uTmFtZSk7CgogICAgICAgICAgaWYgKGxpc3RlbmVyKSB7CiAgICAgICAgICAgIGV2ZW50Ll9kaXNwYXRjaExpc3RlbmVycyA9IGFjY3VtdWxhdGVJbnRvKGV2ZW50Ll9kaXNwYXRjaExpc3RlbmVycywgbGlzdGVuZXIpOwogICAgICAgICAgICBldmVudC5fZGlzcGF0Y2hJbnN0YW5jZXMgPSBhY2N1bXVsYXRlSW50byhldmVudC5fZGlzcGF0Y2hJbnN0YW5jZXMsIGluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZURpcmVjdERpc3BhdGNoZXNTaW5nbGUoZXZlbnQpIHsKICAgICAgICBpZiAoZXZlbnQgJiYgZXZlbnQuZGlzcGF0Y2hDb25maWcucmVnaXN0cmF0aW9uTmFtZSkgewogICAgICAgICAgYWNjdW11bGF0ZURpc3BhdGNoZXMoZXZlbnQuX3RhcmdldEluc3QsIG51bGwsIGV2ZW50KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVUd29QaGFzZURpc3BhdGNoZXMoZXZlbnRzKSB7CiAgICAgICAgZm9yRWFjaEFjY3VtdWxhdGVkKGV2ZW50cywgYWNjdW11bGF0ZVR3b1BoYXNlRGlzcGF0Y2hlc1NpbmdsZSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVUd29QaGFzZURpc3BhdGNoZXNTa2lwVGFyZ2V0KGV2ZW50cykgewogICAgICAgIGZvckVhY2hBY2N1bXVsYXRlZChldmVudHMsIGFjY3VtdWxhdGVUd29QaGFzZURpc3BhdGNoZXNTaW5nbGVTa2lwVGFyZ2V0KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZURpcmVjdERpc3BhdGNoZXMoZXZlbnRzKSB7CiAgICAgICAgZm9yRWFjaEFjY3VtdWxhdGVkKGV2ZW50cywgYWNjdW11bGF0ZURpcmVjdERpc3BhdGNoZXNTaW5nbGUpOwogICAgICB9CgogICAgICB2YXIgZGlkV2FybkZvckFkZGVkTmV3UHJvcGVydHkgPSBmYWxzZTsKICAgICAgdmFyIGlzUHJveHlTdXBwb3J0ZWQgPSB0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiI7CiAgICAgIHZhciBFVkVOVF9QT09MX1NJWkUgPSAxMDsKICAgICAgdmFyIHNob3VsZEJlUmVsZWFzZWRQcm9wZXJ0aWVzID0gWyJkaXNwYXRjaENvbmZpZyIsICJfdGFyZ2V0SW5zdCIsICJuYXRpdmVFdmVudCIsICJpc0RlZmF1bHRQcmV2ZW50ZWQiLCAiaXNQcm9wYWdhdGlvblN0b3BwZWQiLCAiX2Rpc3BhdGNoTGlzdGVuZXJzIiwgIl9kaXNwYXRjaEluc3RhbmNlcyJdOwogICAgICB2YXIgRXZlbnRJbnRlcmZhY2UgPSB7CiAgICAgICAgdHlwZTogbnVsbCwKICAgICAgICB0YXJnZXQ6IG51bGwsCiAgICAgICAgY3VycmVudFRhcmdldDogZW1wdHlGdW5jdGlvbi50aGF0UmV0dXJuc051bGwsCiAgICAgICAgZXZlbnRQaGFzZTogbnVsbCwKICAgICAgICBidWJibGVzOiBudWxsLAogICAgICAgIGNhbmNlbGFibGU6IG51bGwsCiAgICAgICAgdGltZVN0YW1wOiBmdW5jdGlvbiB0aW1lU3RhbXAoZXZlbnQpIHsKICAgICAgICAgIHJldHVybiBldmVudC50aW1lU3RhbXAgfHwgRGF0ZS5ub3coKTsKICAgICAgICB9LAogICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQ6IG51bGwsCiAgICAgICAgaXNUcnVzdGVkOiBudWxsCiAgICAgIH07CgogICAgICBmdW5jdGlvbiBTeW50aGV0aWNFdmVudChkaXNwYXRjaENvbmZpZywgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgewogICAgICAgICAgZGVsZXRlIHRoaXMubmF0aXZlRXZlbnQ7CiAgICAgICAgICBkZWxldGUgdGhpcy5wcmV2ZW50RGVmYXVsdDsKICAgICAgICAgIGRlbGV0ZSB0aGlzLnN0b3BQcm9wYWdhdGlvbjsKICAgICAgICB9CiAgICAgICAgdGhpcy5kaXNwYXRjaENvbmZpZyA9IGRpc3BhdGNoQ29uZmlnOwogICAgICAgIHRoaXMuX3RhcmdldEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgIHRoaXMubmF0aXZlRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICB2YXIgSW50ZXJmYWNlID0gdGhpcy5jb25zdHJ1Y3Rvci5JbnRlcmZhY2U7CgogICAgICAgIGZvciAodmFyIHByb3BOYW1lIGluIEludGVyZmFjZSkgewogICAgICAgICAgaWYgKCFJbnRlcmZhY2UuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXNbcHJvcE5hbWVdOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vcm1hbGl6ZSA9IEludGVyZmFjZVtwcm9wTmFtZV07CgogICAgICAgICAgaWYgKG5vcm1hbGl6ZSkgewogICAgICAgICAgICB0aGlzW3Byb3BOYW1lXSA9IG5vcm1hbGl6ZShuYXRpdmVFdmVudCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAocHJvcE5hbWUgPT09ICJ0YXJnZXQiKSB7CiAgICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBuYXRpdmVFdmVudFRhcmdldDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzW3Byb3BOYW1lXSA9IG5hdGl2ZUV2ZW50W3Byb3BOYW1lXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGRlZmF1bHRQcmV2ZW50ZWQgPSBuYXRpdmVFdmVudC5kZWZhdWx0UHJldmVudGVkICE9IG51bGwgPyBuYXRpdmVFdmVudC5kZWZhdWx0UHJldmVudGVkIDogbmF0aXZlRXZlbnQucmV0dXJuVmFsdWUgPT09IGZhbHNlOwoKICAgICAgICBpZiAoZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zVHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zRmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZW1wdHlGdW5jdGlvbi50aGF0UmV0dXJuc0ZhbHNlOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CgogICAgICBiYWJlbEhlbHBlcnMuZXh0ZW5kcyhTeW50aGV0aWNFdmVudC5wcm90b3R5cGUsIHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gcHJldmVudERlZmF1bHQoKSB7CiAgICAgICAgICB0aGlzLmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKCiAgICAgICAgICBpZiAoIWV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LnJldHVyblZhbHVlICE9PSAidW5rbm93biIpIHsKICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGVtcHR5RnVuY3Rpb24udGhhdFJldHVybnNUcnVlOwogICAgICAgIH0sCiAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiBzdG9wUHJvcGFnYXRpb24oKSB7CiAgICAgICAgICB2YXIgZXZlbnQgPSB0aGlzLm5hdGl2ZUV2ZW50OwoKICAgICAgICAgIGlmICghZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBldmVudC5jYW5jZWxCdWJibGUgIT09ICJ1bmtub3duIikgewogICAgICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zVHJ1ZTsKICAgICAgICB9LAogICAgICAgIHBlcnNpc3Q6IGZ1bmN0aW9uIHBlcnNpc3QoKSB7CiAgICAgICAgICB0aGlzLmlzUGVyc2lzdGVudCA9IGVtcHR5RnVuY3Rpb24udGhhdFJldHVybnNUcnVlOwogICAgICAgIH0sCiAgICAgICAgaXNQZXJzaXN0ZW50OiBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zRmFsc2UsCiAgICAgICAgZGVzdHJ1Y3RvcjogZnVuY3Rpb24gZGVzdHJ1Y3RvcigpIHsKICAgICAgICAgIHZhciBJbnRlcmZhY2UgPSB0aGlzLmNvbnN0cnVjdG9yLkludGVyZmFjZTsKCiAgICAgICAgICBmb3IgKHZhciBwcm9wTmFtZSBpbiBJbnRlcmZhY2UpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wTmFtZSwgZ2V0UG9vbGVkV2FybmluZ1Byb3BlcnR5RGVmaW5pdGlvbihwcm9wTmFtZSwgSW50ZXJmYWNlW3Byb3BOYW1lXSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaG91bGRCZVJlbGVhc2VkUHJvcGVydGllcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0aGlzW3Nob3VsZEJlUmVsZWFzZWRQcm9wZXJ0aWVzW2ldXSA9IG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgIm5hdGl2ZUV2ZW50IiwgZ2V0UG9vbGVkV2FybmluZ1Byb3BlcnR5RGVmaW5pdGlvbigibmF0aXZlRXZlbnQiLCBudWxsKSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAicHJldmVudERlZmF1bHQiLCBnZXRQb29sZWRXYXJuaW5nUHJvcGVydHlEZWZpbml0aW9uKCJwcmV2ZW50RGVmYXVsdCIsIGVtcHR5RnVuY3Rpb24pKTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJzdG9wUHJvcGFnYXRpb24iLCBnZXRQb29sZWRXYXJuaW5nUHJvcGVydHlEZWZpbml0aW9uKCJzdG9wUHJvcGFnYXRpb24iLCBlbXB0eUZ1bmN0aW9uKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgU3ludGhldGljRXZlbnQuSW50ZXJmYWNlID0gRXZlbnRJbnRlcmZhY2U7CgogICAgICBTeW50aGV0aWNFdmVudC5hdWdtZW50Q2xhc3MgPSBmdW5jdGlvbiAoQ2xhc3MsIEludGVyZmFjZSkgewogICAgICAgIHZhciBTdXBlciA9IHRoaXM7CgogICAgICAgIHZhciBFID0gZnVuY3Rpb24gRSgpIHt9OwoKICAgICAgICBFLnByb3RvdHlwZSA9IFN1cGVyLnByb3RvdHlwZTsKICAgICAgICB2YXIgcHJvdG90eXBlID0gbmV3IEUoKTsKICAgICAgICBiYWJlbEhlbHBlcnMuZXh0ZW5kcyhwcm90b3R5cGUsIENsYXNzLnByb3RvdHlwZSk7CiAgICAgICAgQ2xhc3MucHJvdG90eXBlID0gcHJvdG90eXBlOwogICAgICAgIENsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENsYXNzOwogICAgICAgIENsYXNzLkludGVyZmFjZSA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBTdXBlci5JbnRlcmZhY2UsIEludGVyZmFjZSk7CiAgICAgICAgQ2xhc3MuYXVnbWVudENsYXNzID0gU3VwZXIuYXVnbWVudENsYXNzOwogICAgICAgIGFkZEV2ZW50UG9vbGluZ1RvKENsYXNzKTsKICAgICAgfTsKCiAgICAgIHsKICAgICAgICBpZiAoaXNQcm94eVN1cHBvcnRlZCkgewogICAgICAgICAgU3ludGhldGljRXZlbnQgPSBuZXcgUHJveHkoU3ludGhldGljRXZlbnQsIHsKICAgICAgICAgICAgY29uc3RydWN0OiBmdW5jdGlvbiBjb25zdHJ1Y3QodGFyZ2V0LCBhcmdzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHkodGFyZ2V0LCBPYmplY3QuY3JlYXRlKHRhcmdldC5wcm90b3R5cGUpLCBhcmdzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYXBwbHk6IGZ1bmN0aW9uIGFwcGx5KGNvbnN0cnVjdG9yLCB0aGF0LCBhcmdzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm94eShjb25zdHJ1Y3Rvci5hcHBseSh0aGF0LCBhcmdzKSwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodGFyZ2V0LCBwcm9wLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICBpZiAocHJvcCAhPT0gImlzUGVyc2lzdGVudCIgJiYgIXRhcmdldC5jb25zdHJ1Y3Rvci5JbnRlcmZhY2UuaGFzT3duUHJvcGVydHkocHJvcCkgJiYgc2hvdWxkQmVSZWxlYXNlZFByb3BlcnRpZXMuaW5kZXhPZihwcm9wKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuaW5nKGRpZFdhcm5Gb3JBZGRlZE5ld1Byb3BlcnR5IHx8IHRhcmdldC5pc1BlcnNpc3RlbnQoKSwgIlRoaXMgc3ludGhldGljIGV2ZW50IGlzIHJldXNlZCBmb3IgcGVyZm9ybWFuY2UgcmVhc29ucy4gSWYgeW91J3JlICIgKyAic2VlaW5nIHRoaXMsIHlvdSdyZSBhZGRpbmcgYSBuZXcgcHJvcGVydHkgaW4gdGhlIHN5bnRoZXRpYyBldmVudCBvYmplY3QuICIgKyAiVGhlIHByb3BlcnR5IGlzIG5ldmVyIHJlbGVhc2VkLiBTZWUgIiArICJodHRwczovL2ZiLm1lL3JlYWN0LWV2ZW50LXBvb2xpbmcgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkZvckFkZGVkTmV3UHJvcGVydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICB0YXJnZXRbcHJvcF0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBhZGRFdmVudFBvb2xpbmdUbyhTeW50aGV0aWNFdmVudCk7CgogICAgICBmdW5jdGlvbiBnZXRQb29sZWRXYXJuaW5nUHJvcGVydHlEZWZpbml0aW9uKHByb3BOYW1lLCBnZXRWYWwpIHsKICAgICAgICB2YXIgaXNGdW5jdGlvbiA9IHR5cGVvZiBnZXRWYWwgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgIHNldDogc2V0LAogICAgICAgICAgZ2V0OiBnZXQKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBzZXQodmFsKSB7CiAgICAgICAgICB2YXIgYWN0aW9uID0gaXNGdW5jdGlvbiA/ICJzZXR0aW5nIHRoZSBtZXRob2QiIDogInNldHRpbmcgdGhlIHByb3BlcnR5IjsKICAgICAgICAgIHdhcm4oYWN0aW9uLCAiVGhpcyBpcyBlZmZlY3RpdmVseSBhIG5vLW9wIik7CiAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgdmFyIGFjdGlvbiA9IGlzRnVuY3Rpb24gPyAiYWNjZXNzaW5nIHRoZSBtZXRob2QiIDogImFjY2Vzc2luZyB0aGUgcHJvcGVydHkiOwogICAgICAgICAgdmFyIHJlc3VsdCA9IGlzRnVuY3Rpb24gPyAiVGhpcyBpcyBhIG5vLW9wIGZ1bmN0aW9uIiA6ICJUaGlzIGlzIHNldCB0byBudWxsIjsKICAgICAgICAgIHdhcm4oYWN0aW9uLCByZXN1bHQpOwogICAgICAgICAgcmV0dXJuIGdldFZhbDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHdhcm4oYWN0aW9uLCByZXN1bHQpIHsKICAgICAgICAgIHZhciB3YXJuaW5nQ29uZGl0aW9uID0gZmFsc2U7CiAgICAgICAgICB3YXJuaW5nKHdhcm5pbmdDb25kaXRpb24sICJUaGlzIHN5bnRoZXRpYyBldmVudCBpcyByZXVzZWQgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMuIElmIHlvdSdyZSBzZWVpbmcgdGhpcywgIiArICJ5b3UncmUgJXMgYCVzYCBvbiBhIHJlbGVhc2VkL251bGxpZmllZCBzeW50aGV0aWMgZXZlbnQuICVzLiAiICsgIklmIHlvdSBtdXN0IGtlZXAgdGhlIG9yaWdpbmFsIHN5bnRoZXRpYyBldmVudCBhcm91bmQsIHVzZSBldmVudC5wZXJzaXN0KCkuICIgKyAiU2VlIGh0dHBzOi8vZmIubWUvcmVhY3QtZXZlbnQtcG9vbGluZyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4iLCBhY3Rpb24sIHByb3BOYW1lLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0UG9vbGVkRXZlbnQoZGlzcGF0Y2hDb25maWcsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVJbnN0KSB7CiAgICAgICAgdmFyIEV2ZW50Q29uc3RydWN0b3IgPSB0aGlzOwoKICAgICAgICBpZiAoRXZlbnRDb25zdHJ1Y3Rvci5ldmVudFBvb2wubGVuZ3RoKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBFdmVudENvbnN0cnVjdG9yLmV2ZW50UG9vbC5wb3AoKTsKICAgICAgICAgIEV2ZW50Q29uc3RydWN0b3IuY2FsbChpbnN0YW5jZSwgZGlzcGF0Y2hDb25maWcsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVJbnN0KTsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBuZXcgRXZlbnRDb25zdHJ1Y3RvcihkaXNwYXRjaENvbmZpZywgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUluc3QpOwogICAgICB9CgogICAgICBmdW5jdGlvbiByZWxlYXNlUG9vbGVkRXZlbnQoZXZlbnQpIHsKICAgICAgICB2YXIgRXZlbnRDb25zdHJ1Y3RvciA9IHRoaXM7CiAgICAgICAgaW52YXJpYW50KGV2ZW50IGluc3RhbmNlb2YgRXZlbnRDb25zdHJ1Y3RvciwgIlRyeWluZyB0byByZWxlYXNlIGFuIGV2ZW50IGluc3RhbmNlICBpbnRvIGEgcG9vbCBvZiBhIGRpZmZlcmVudCB0eXBlLiIpOwogICAgICAgIGV2ZW50LmRlc3RydWN0b3IoKTsKCiAgICAgICAgaWYgKEV2ZW50Q29uc3RydWN0b3IuZXZlbnRQb29sLmxlbmd0aCA8IEVWRU5UX1BPT0xfU0laRSkgewogICAgICAgICAgRXZlbnRDb25zdHJ1Y3Rvci5ldmVudFBvb2wucHVzaChldmVudCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBhZGRFdmVudFBvb2xpbmdUbyhFdmVudENvbnN0cnVjdG9yKSB7CiAgICAgICAgRXZlbnRDb25zdHJ1Y3Rvci5ldmVudFBvb2wgPSBbXTsKICAgICAgICBFdmVudENvbnN0cnVjdG9yLmdldFBvb2xlZCA9IGdldFBvb2xlZEV2ZW50OwogICAgICAgIEV2ZW50Q29uc3RydWN0b3IucmVsZWFzZSA9IHJlbGVhc2VQb29sZWRFdmVudDsKICAgICAgfQoKICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50JDEgPSBTeW50aGV0aWNFdmVudDsKICAgICAgdmFyIFJlc3BvbmRlckV2ZW50SW50ZXJmYWNlID0gewogICAgICAgIHRvdWNoSGlzdG9yeTogZnVuY3Rpb24gdG91Y2hIaXN0b3J5KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgIH07CgogICAgICBmdW5jdGlvbiBSZXNwb25kZXJTeW50aGV0aWNFdmVudChkaXNwYXRjaENvbmZpZywgZGlzcGF0Y2hNYXJrZXIsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgIHJldHVybiBTeW50aGV0aWNFdmVudCQxLmNhbGwodGhpcywgZGlzcGF0Y2hDb25maWcsIGRpc3BhdGNoTWFya2VyLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICB9CgogICAgICBTeW50aGV0aWNFdmVudCQxLmF1Z21lbnRDbGFzcyhSZXNwb25kZXJTeW50aGV0aWNFdmVudCwgUmVzcG9uZGVyRXZlbnRJbnRlcmZhY2UpOwogICAgICB2YXIgTUFYX1RPVUNIX0JBTksgPSAyMDsKICAgICAgdmFyIHRvdWNoQmFuayA9IFtdOwogICAgICB2YXIgdG91Y2hIaXN0b3J5ID0gewogICAgICAgIHRvdWNoQmFuazogdG91Y2hCYW5rLAogICAgICAgIG51bWJlckFjdGl2ZVRvdWNoZXM6IDAsCiAgICAgICAgaW5kZXhPZlNpbmdsZUFjdGl2ZVRvdWNoOiAtMSwKICAgICAgICBtb3N0UmVjZW50VGltZVN0YW1wOiAwCiAgICAgIH07CgogICAgICBmdW5jdGlvbiB0aW1lc3RhbXBGb3JUb3VjaCh0b3VjaCkgewogICAgICAgIHJldHVybiB0b3VjaC50aW1lU3RhbXAgfHwgdG91Y2gudGltZXN0YW1wOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjcmVhdGVUb3VjaFJlY29yZCh0b3VjaCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0b3VjaEFjdGl2ZTogdHJ1ZSwKICAgICAgICAgIHN0YXJ0UGFnZVg6IHRvdWNoLnBhZ2VYLAogICAgICAgICAgc3RhcnRQYWdlWTogdG91Y2gucGFnZVksCiAgICAgICAgICBzdGFydFRpbWVTdGFtcDogdGltZXN0YW1wRm9yVG91Y2godG91Y2gpLAogICAgICAgICAgY3VycmVudFBhZ2VYOiB0b3VjaC5wYWdlWCwKICAgICAgICAgIGN1cnJlbnRQYWdlWTogdG91Y2gucGFnZVksCiAgICAgICAgICBjdXJyZW50VGltZVN0YW1wOiB0aW1lc3RhbXBGb3JUb3VjaCh0b3VjaCksCiAgICAgICAgICBwcmV2aW91c1BhZ2VYOiB0b3VjaC5wYWdlWCwKICAgICAgICAgIHByZXZpb3VzUGFnZVk6IHRvdWNoLnBhZ2VZLAogICAgICAgICAgcHJldmlvdXNUaW1lU3RhbXA6IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHJlc2V0VG91Y2hSZWNvcmQodG91Y2hSZWNvcmQsIHRvdWNoKSB7CiAgICAgICAgdG91Y2hSZWNvcmQudG91Y2hBY3RpdmUgPSB0cnVlOwogICAgICAgIHRvdWNoUmVjb3JkLnN0YXJ0UGFnZVggPSB0b3VjaC5wYWdlWDsKICAgICAgICB0b3VjaFJlY29yZC5zdGFydFBhZ2VZID0gdG91Y2gucGFnZVk7CiAgICAgICAgdG91Y2hSZWNvcmQuc3RhcnRUaW1lU3RhbXAgPSB0aW1lc3RhbXBGb3JUb3VjaCh0b3VjaCk7CiAgICAgICAgdG91Y2hSZWNvcmQuY3VycmVudFBhZ2VYID0gdG91Y2gucGFnZVg7CiAgICAgICAgdG91Y2hSZWNvcmQuY3VycmVudFBhZ2VZID0gdG91Y2gucGFnZVk7CiAgICAgICAgdG91Y2hSZWNvcmQuY3VycmVudFRpbWVTdGFtcCA9IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKTsKICAgICAgICB0b3VjaFJlY29yZC5wcmV2aW91c1BhZ2VYID0gdG91Y2gucGFnZVg7CiAgICAgICAgdG91Y2hSZWNvcmQucHJldmlvdXNQYWdlWSA9IHRvdWNoLnBhZ2VZOwogICAgICAgIHRvdWNoUmVjb3JkLnByZXZpb3VzVGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXRUb3VjaElkZW50aWZpZXIoX3JlZikgewogICAgICAgIHZhciBpZGVudGlmaWVyID0gX3JlZi5pZGVudGlmaWVyOwogICAgICAgIGludmFyaWFudChpZGVudGlmaWVyICE9IG51bGwsICJUb3VjaCBvYmplY3QgaXMgbWlzc2luZyBpZGVudGlmaWVyLiIpOwogICAgICAgIHsKICAgICAgICAgIHdhcm5pbmcoaWRlbnRpZmllciA8PSBNQVhfVE9VQ0hfQkFOSywgIlRvdWNoIGlkZW50aWZpZXIgJXMgaXMgZ3JlYXRlciB0aGFuIG1heGltdW0gc3VwcG9ydGVkICVzIHdoaWNoIGNhdXNlcyAiICsgInBlcmZvcm1hbmNlIGlzc3VlcyBiYWNrZmlsbGluZyBhcnJheSBsb2NhdGlvbnMgZm9yIGFsbCBvZiB0aGUgaW5kaWNlcy4iLCBpZGVudGlmaWVyLCBNQVhfVE9VQ0hfQkFOSyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpZGVudGlmaWVyOwogICAgICB9CgogICAgICBmdW5jdGlvbiByZWNvcmRUb3VjaFN0YXJ0KHRvdWNoKSB7CiAgICAgICAgdmFyIGlkZW50aWZpZXIgPSBnZXRUb3VjaElkZW50aWZpZXIodG91Y2gpOwogICAgICAgIHZhciB0b3VjaFJlY29yZCA9IHRvdWNoQmFua1tpZGVudGlmaWVyXTsKCiAgICAgICAgaWYgKHRvdWNoUmVjb3JkKSB7CiAgICAgICAgICByZXNldFRvdWNoUmVjb3JkKHRvdWNoUmVjb3JkLCB0b3VjaCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRvdWNoQmFua1tpZGVudGlmaWVyXSA9IGNyZWF0ZVRvdWNoUmVjb3JkKHRvdWNoKTsKICAgICAgICB9CgogICAgICAgIHRvdWNoSGlzdG9yeS5tb3N0UmVjZW50VGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpOwogICAgICB9CgogICAgICBmdW5jdGlvbiByZWNvcmRUb3VjaE1vdmUodG91Y2gpIHsKICAgICAgICB2YXIgdG91Y2hSZWNvcmQgPSB0b3VjaEJhbmtbZ2V0VG91Y2hJZGVudGlmaWVyKHRvdWNoKV07CgogICAgICAgIGlmICh0b3VjaFJlY29yZCkgewogICAgICAgICAgdG91Y2hSZWNvcmQudG91Y2hBY3RpdmUgPSB0cnVlOwogICAgICAgICAgdG91Y2hSZWNvcmQucHJldmlvdXNQYWdlWCA9IHRvdWNoUmVjb3JkLmN1cnJlbnRQYWdlWDsKICAgICAgICAgIHRvdWNoUmVjb3JkLnByZXZpb3VzUGFnZVkgPSB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVk7CiAgICAgICAgICB0b3VjaFJlY29yZC5wcmV2aW91c1RpbWVTdGFtcCA9IHRvdWNoUmVjb3JkLmN1cnJlbnRUaW1lU3RhbXA7CiAgICAgICAgICB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVggPSB0b3VjaC5wYWdlWDsKICAgICAgICAgIHRvdWNoUmVjb3JkLmN1cnJlbnRQYWdlWSA9IHRvdWNoLnBhZ2VZOwogICAgICAgICAgdG91Y2hSZWNvcmQuY3VycmVudFRpbWVTdGFtcCA9IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKTsKICAgICAgICAgIHRvdWNoSGlzdG9yeS5tb3N0UmVjZW50VGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJDYW5ub3QgcmVjb3JkIHRvdWNoIG1vdmUgd2l0aG91dCBhIHRvdWNoIHN0YXJ0LlxuIiArICJUb3VjaCBNb3ZlOiAlc1xuIiwgIlRvdWNoIEJhbms6ICVzIiwgcHJpbnRUb3VjaCh0b3VjaCksIHByaW50VG91Y2hCYW5rKCkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gcmVjb3JkVG91Y2hFbmQodG91Y2gpIHsKICAgICAgICB2YXIgdG91Y2hSZWNvcmQgPSB0b3VjaEJhbmtbZ2V0VG91Y2hJZGVudGlmaWVyKHRvdWNoKV07CgogICAgICAgIGlmICh0b3VjaFJlY29yZCkgewogICAgICAgICAgdG91Y2hSZWNvcmQudG91Y2hBY3RpdmUgPSBmYWxzZTsKICAgICAgICAgIHRvdWNoUmVjb3JkLnByZXZpb3VzUGFnZVggPSB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVg7CiAgICAgICAgICB0b3VjaFJlY29yZC5wcmV2aW91c1BhZ2VZID0gdG91Y2hSZWNvcmQuY3VycmVudFBhZ2VZOwogICAgICAgICAgdG91Y2hSZWNvcmQucHJldmlvdXNUaW1lU3RhbXAgPSB0b3VjaFJlY29yZC5jdXJyZW50VGltZVN0YW1wOwogICAgICAgICAgdG91Y2hSZWNvcmQuY3VycmVudFBhZ2VYID0gdG91Y2gucGFnZVg7CiAgICAgICAgICB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVkgPSB0b3VjaC5wYWdlWTsKICAgICAgICAgIHRvdWNoUmVjb3JkLmN1cnJlbnRUaW1lU3RhbXAgPSB0aW1lc3RhbXBGb3JUb3VjaCh0b3VjaCk7CiAgICAgICAgICB0b3VjaEhpc3RvcnkubW9zdFJlY2VudFRpbWVTdGFtcCA9IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQ2Fubm90IHJlY29yZCB0b3VjaCBlbmQgd2l0aG91dCBhIHRvdWNoIHN0YXJ0LlxuIiArICJUb3VjaCBFbmQ6ICVzXG4iLCAiVG91Y2ggQmFuazogJXMiLCBwcmludFRvdWNoKHRvdWNoKSwgcHJpbnRUb3VjaEJhbmsoKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBwcmludFRvdWNoKHRvdWNoKSB7CiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIGlkZW50aWZpZXI6IHRvdWNoLmlkZW50aWZpZXIsCiAgICAgICAgICBwYWdlWDogdG91Y2gucGFnZVgsCiAgICAgICAgICBwYWdlWTogdG91Y2gucGFnZVksCiAgICAgICAgICB0aW1lc3RhbXA6IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKQogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwcmludFRvdWNoQmFuaygpIHsKICAgICAgICB2YXIgcHJpbnRlZCA9IEpTT04uc3RyaW5naWZ5KHRvdWNoQmFuay5zbGljZSgwLCBNQVhfVE9VQ0hfQkFOSykpOwoKICAgICAgICBpZiAodG91Y2hCYW5rLmxlbmd0aCA+IE1BWF9UT1VDSF9CQU5LKSB7CiAgICAgICAgICBwcmludGVkICs9ICIgKG9yaWdpbmFsIHNpemU6ICIgKyB0b3VjaEJhbmsubGVuZ3RoICsgIikiOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHByaW50ZWQ7CiAgICAgIH0KCiAgICAgIHZhciBSZXNwb25kZXJUb3VjaEhpc3RvcnlTdG9yZSA9IHsKICAgICAgICByZWNvcmRUb3VjaFRyYWNrOiBmdW5jdGlvbiByZWNvcmRUb3VjaFRyYWNrKHRvcExldmVsVHlwZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChpc01vdmVpc2godG9wTGV2ZWxUeXBlKSkgewogICAgICAgICAgICBuYXRpdmVFdmVudC5jaGFuZ2VkVG91Y2hlcy5mb3JFYWNoKHJlY29yZFRvdWNoTW92ZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzU3RhcnRpc2godG9wTGV2ZWxUeXBlKSkgewogICAgICAgICAgICBuYXRpdmVFdmVudC5jaGFuZ2VkVG91Y2hlcy5mb3JFYWNoKHJlY29yZFRvdWNoU3RhcnQpOwogICAgICAgICAgICB0b3VjaEhpc3RvcnkubnVtYmVyQWN0aXZlVG91Y2hlcyA9IG5hdGl2ZUV2ZW50LnRvdWNoZXMubGVuZ3RoOwoKICAgICAgICAgICAgaWYgKHRvdWNoSGlzdG9yeS5udW1iZXJBY3RpdmVUb3VjaGVzID09PSAxKSB7CiAgICAgICAgICAgICAgdG91Y2hIaXN0b3J5LmluZGV4T2ZTaW5nbGVBY3RpdmVUb3VjaCA9IG5hdGl2ZUV2ZW50LnRvdWNoZXNbMF0uaWRlbnRpZmllcjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0VuZGlzaCh0b3BMZXZlbFR5cGUpKSB7CiAgICAgICAgICAgIG5hdGl2ZUV2ZW50LmNoYW5nZWRUb3VjaGVzLmZvckVhY2gocmVjb3JkVG91Y2hFbmQpOwogICAgICAgICAgICB0b3VjaEhpc3RvcnkubnVtYmVyQWN0aXZlVG91Y2hlcyA9IG5hdGl2ZUV2ZW50LnRvdWNoZXMubGVuZ3RoOwoKICAgICAgICAgICAgaWYgKHRvdWNoSGlzdG9yeS5udW1iZXJBY3RpdmVUb3VjaGVzID09PSAxKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b3VjaEJhbmsubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciB0b3VjaFRyYWNrVG9DaGVjayA9IHRvdWNoQmFua1tpXTsKCiAgICAgICAgICAgICAgICBpZiAodG91Y2hUcmFja1RvQ2hlY2sgIT0gbnVsbCAmJiB0b3VjaFRyYWNrVG9DaGVjay50b3VjaEFjdGl2ZSkgewogICAgICAgICAgICAgICAgICB0b3VjaEhpc3RvcnkuaW5kZXhPZlNpbmdsZUFjdGl2ZVRvdWNoID0gaTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgYWN0aXZlUmVjb3JkID0gdG91Y2hCYW5rW3RvdWNoSGlzdG9yeS5pbmRleE9mU2luZ2xlQWN0aXZlVG91Y2hdOwogICAgICAgICAgICAgICAgd2FybmluZyhhY3RpdmVSZWNvcmQgIT0gbnVsbCAmJiBhY3RpdmVSZWNvcmQudG91Y2hBY3RpdmUsICJDYW5ub3QgZmluZCBzaW5nbGUgYWN0aXZlIHRvdWNoLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdG91Y2hIaXN0b3J5OiB0b3VjaEhpc3RvcnkKICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGUoY3VycmVudCwgbmV4dCkgewogICAgICAgIGludmFyaWFudChuZXh0ICE9IG51bGwsICJhY2N1bXVsYXRlKC4uLik6IEFjY3VtdWxhdGVkIGl0ZW1zIG11c3QgYmUgbm90IGJlIG51bGwgb3IgdW5kZWZpbmVkLiIpOwoKICAgICAgICBpZiAoY3VycmVudCA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICB9CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGN1cnJlbnQpKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudC5jb25jYXQobmV4dCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShuZXh0KSkgewogICAgICAgICAgcmV0dXJuIFtjdXJyZW50XS5jb25jYXQobmV4dCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gW2N1cnJlbnQsIG5leHRdOwogICAgICB9CgogICAgICB2YXIgcmVzcG9uZGVySW5zdCA9IG51bGw7CiAgICAgIHZhciB0cmFja2VkVG91Y2hDb3VudCA9IDA7CiAgICAgIHZhciBwcmV2aW91c0FjdGl2ZVRvdWNoZXMgPSAwOwoKICAgICAgdmFyIGNoYW5nZVJlc3BvbmRlciA9IGZ1bmN0aW9uIGNoYW5nZVJlc3BvbmRlcihuZXh0UmVzcG9uZGVySW5zdCwgYmxvY2tIb3N0UmVzcG9uZGVyKSB7CiAgICAgICAgdmFyIG9sZFJlc3BvbmRlckluc3QgPSByZXNwb25kZXJJbnN0OwogICAgICAgIHJlc3BvbmRlckluc3QgPSBuZXh0UmVzcG9uZGVySW5zdDsKCiAgICAgICAgaWYgKFJlc3BvbmRlckV2ZW50UGx1Z2luLkdsb2JhbFJlc3BvbmRlckhhbmRsZXIgIT09IG51bGwpIHsKICAgICAgICAgIFJlc3BvbmRlckV2ZW50UGx1Z2luLkdsb2JhbFJlc3BvbmRlckhhbmRsZXIub25DaGFuZ2Uob2xkUmVzcG9uZGVySW5zdCwgbmV4dFJlc3BvbmRlckluc3QsIGJsb2NrSG9zdFJlc3BvbmRlcik7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIGV2ZW50VHlwZXMgPSB7CiAgICAgICAgc3RhcnRTaG91bGRTZXRSZXNwb25kZXI6IHsKICAgICAgICAgIHBoYXNlZFJlZ2lzdHJhdGlvbk5hbWVzOiB7CiAgICAgICAgICAgIGJ1YmJsZWQ6ICJvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyIiwKICAgICAgICAgICAgY2FwdHVyZWQ6ICJvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyQ2FwdHVyZSIKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHNjcm9sbFNob3VsZFNldFJlc3BvbmRlcjogewogICAgICAgICAgcGhhc2VkUmVnaXN0cmF0aW9uTmFtZXM6IHsKICAgICAgICAgICAgYnViYmxlZDogIm9uU2Nyb2xsU2hvdWxkU2V0UmVzcG9uZGVyIiwKICAgICAgICAgICAgY2FwdHVyZWQ6ICJvblNjcm9sbFNob3VsZFNldFJlc3BvbmRlckNhcHR1cmUiCiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzZWxlY3Rpb25DaGFuZ2VTaG91bGRTZXRSZXNwb25kZXI6IHsKICAgICAgICAgIHBoYXNlZFJlZ2lzdHJhdGlvbk5hbWVzOiB7CiAgICAgICAgICAgIGJ1YmJsZWQ6ICJvblNlbGVjdGlvbkNoYW5nZVNob3VsZFNldFJlc3BvbmRlciIsCiAgICAgICAgICAgIGNhcHR1cmVkOiAib25TZWxlY3Rpb25DaGFuZ2VTaG91bGRTZXRSZXNwb25kZXJDYXB0dXJlIgogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbW92ZVNob3VsZFNldFJlc3BvbmRlcjogewogICAgICAgICAgcGhhc2VkUmVnaXN0cmF0aW9uTmFtZXM6IHsKICAgICAgICAgICAgYnViYmxlZDogIm9uTW92ZVNob3VsZFNldFJlc3BvbmRlciIsCiAgICAgICAgICAgIGNhcHR1cmVkOiAib25Nb3ZlU2hvdWxkU2V0UmVzcG9uZGVyQ2FwdHVyZSIKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHJlc3BvbmRlclN0YXJ0OiB7CiAgICAgICAgICByZWdpc3RyYXRpb25OYW1lOiAib25SZXNwb25kZXJTdGFydCIKICAgICAgICB9LAogICAgICAgIHJlc3BvbmRlck1vdmU6IHsKICAgICAgICAgIHJlZ2lzdHJhdGlvbk5hbWU6ICJvblJlc3BvbmRlck1vdmUiCiAgICAgICAgfSwKICAgICAgICByZXNwb25kZXJFbmQ6IHsKICAgICAgICAgIHJlZ2lzdHJhdGlvbk5hbWU6ICJvblJlc3BvbmRlckVuZCIKICAgICAgICB9LAogICAgICAgIHJlc3BvbmRlclJlbGVhc2U6IHsKICAgICAgICAgIHJlZ2lzdHJhdGlvbk5hbWU6ICJvblJlc3BvbmRlclJlbGVhc2UiCiAgICAgICAgfSwKICAgICAgICByZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3Q6IHsKICAgICAgICAgIHJlZ2lzdHJhdGlvbk5hbWU6ICJvblJlc3BvbmRlclRlcm1pbmF0aW9uUmVxdWVzdCIKICAgICAgICB9LAogICAgICAgIHJlc3BvbmRlckdyYW50OiB7CiAgICAgICAgICByZWdpc3RyYXRpb25OYW1lOiAib25SZXNwb25kZXJHcmFudCIKICAgICAgICB9LAogICAgICAgIHJlc3BvbmRlclJlamVjdDogewogICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZTogIm9uUmVzcG9uZGVyUmVqZWN0IgogICAgICAgIH0sCiAgICAgICAgcmVzcG9uZGVyVGVybWluYXRlOiB7CiAgICAgICAgICByZWdpc3RyYXRpb25OYW1lOiAib25SZXNwb25kZXJUZXJtaW5hdGUiCiAgICAgICAgfQogICAgICB9OwoKICAgICAgZnVuY3Rpb24gc2V0UmVzcG9uZGVyQW5kRXh0cmFjdFRyYW5zZmVyKHRvcExldmVsVHlwZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgdmFyIHNob3VsZFNldEV2ZW50VHlwZSA9IGlzU3RhcnRpc2godG9wTGV2ZWxUeXBlKSA/IGV2ZW50VHlwZXMuc3RhcnRTaG91bGRTZXRSZXNwb25kZXIgOiBpc01vdmVpc2godG9wTGV2ZWxUeXBlKSA/IGV2ZW50VHlwZXMubW92ZVNob3VsZFNldFJlc3BvbmRlciA6IHRvcExldmVsVHlwZSA9PT0gInRvcFNlbGVjdGlvbkNoYW5nZSIgPyBldmVudFR5cGVzLnNlbGVjdGlvbkNoYW5nZVNob3VsZFNldFJlc3BvbmRlciA6IGV2ZW50VHlwZXMuc2Nyb2xsU2hvdWxkU2V0UmVzcG9uZGVyOwogICAgICAgIHZhciBidWJibGVTaG91bGRTZXRGcm9tID0gIXJlc3BvbmRlckluc3QgPyB0YXJnZXRJbnN0IDogZ2V0TG93ZXN0Q29tbW9uQW5jZXN0b3IocmVzcG9uZGVySW5zdCwgdGFyZ2V0SW5zdCk7CiAgICAgICAgdmFyIHNraXBPdmVyQnViYmxlU2hvdWxkU2V0RnJvbSA9IGJ1YmJsZVNob3VsZFNldEZyb20gPT09IHJlc3BvbmRlckluc3Q7CiAgICAgICAgdmFyIHNob3VsZFNldEV2ZW50ID0gUmVzcG9uZGVyU3ludGhldGljRXZlbnQuZ2V0UG9vbGVkKHNob3VsZFNldEV2ZW50VHlwZSwgYnViYmxlU2hvdWxkU2V0RnJvbSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICBzaG91bGRTZXRFdmVudC50b3VjaEhpc3RvcnkgPSBSZXNwb25kZXJUb3VjaEhpc3RvcnlTdG9yZS50b3VjaEhpc3Rvcnk7CgogICAgICAgIGlmIChza2lwT3ZlckJ1YmJsZVNob3VsZFNldEZyb20pIHsKICAgICAgICAgIGFjY3VtdWxhdGVUd29QaGFzZURpc3BhdGNoZXNTa2lwVGFyZ2V0KHNob3VsZFNldEV2ZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWNjdW11bGF0ZVR3b1BoYXNlRGlzcGF0Y2hlcyhzaG91bGRTZXRFdmVudCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgd2FudHNSZXNwb25kZXJJbnN0ID0gZXhlY3V0ZURpc3BhdGNoZXNJbk9yZGVyU3RvcEF0VHJ1ZShzaG91bGRTZXRFdmVudCk7CgogICAgICAgIGlmICghc2hvdWxkU2V0RXZlbnQuaXNQZXJzaXN0ZW50KCkpIHsKICAgICAgICAgIHNob3VsZFNldEV2ZW50LmNvbnN0cnVjdG9yLnJlbGVhc2Uoc2hvdWxkU2V0RXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF3YW50c1Jlc3BvbmRlckluc3QgfHwgd2FudHNSZXNwb25kZXJJbnN0ID09PSByZXNwb25kZXJJbnN0KSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHZhciBleHRyYWN0ZWQ7CiAgICAgICAgdmFyIGdyYW50RXZlbnQgPSBSZXNwb25kZXJTeW50aGV0aWNFdmVudC5nZXRQb29sZWQoZXZlbnRUeXBlcy5yZXNwb25kZXJHcmFudCwgd2FudHNSZXNwb25kZXJJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgIGdyYW50RXZlbnQudG91Y2hIaXN0b3J5ID0gUmVzcG9uZGVyVG91Y2hIaXN0b3J5U3RvcmUudG91Y2hIaXN0b3J5OwogICAgICAgIGFjY3VtdWxhdGVEaXJlY3REaXNwYXRjaGVzKGdyYW50RXZlbnQpOwogICAgICAgIHZhciBibG9ja0hvc3RSZXNwb25kZXIgPSBleGVjdXRlRGlyZWN0RGlzcGF0Y2goZ3JhbnRFdmVudCkgPT09IHRydWU7CgogICAgICAgIGlmIChyZXNwb25kZXJJbnN0KSB7CiAgICAgICAgICB2YXIgdGVybWluYXRpb25SZXF1ZXN0RXZlbnQgPSBSZXNwb25kZXJTeW50aGV0aWNFdmVudC5nZXRQb29sZWQoZXZlbnRUeXBlcy5yZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3QsIHJlc3BvbmRlckluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICB0ZXJtaW5hdGlvblJlcXVlc3RFdmVudC50b3VjaEhpc3RvcnkgPSBSZXNwb25kZXJUb3VjaEhpc3RvcnlTdG9yZS50b3VjaEhpc3Rvcnk7CiAgICAgICAgICBhY2N1bXVsYXRlRGlyZWN0RGlzcGF0Y2hlcyh0ZXJtaW5hdGlvblJlcXVlc3RFdmVudCk7CiAgICAgICAgICB2YXIgc2hvdWxkU3dpdGNoID0gIWhhc0Rpc3BhdGNoZXModGVybWluYXRpb25SZXF1ZXN0RXZlbnQpIHx8IGV4ZWN1dGVEaXJlY3REaXNwYXRjaCh0ZXJtaW5hdGlvblJlcXVlc3RFdmVudCk7CgogICAgICAgICAgaWYgKCF0ZXJtaW5hdGlvblJlcXVlc3RFdmVudC5pc1BlcnNpc3RlbnQoKSkgewogICAgICAgICAgICB0ZXJtaW5hdGlvblJlcXVlc3RFdmVudC5jb25zdHJ1Y3Rvci5yZWxlYXNlKHRlcm1pbmF0aW9uUmVxdWVzdEV2ZW50KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2hvdWxkU3dpdGNoKSB7CiAgICAgICAgICAgIHZhciB0ZXJtaW5hdGVFdmVudCA9IFJlc3BvbmRlclN5bnRoZXRpY0V2ZW50LmdldFBvb2xlZChldmVudFR5cGVzLnJlc3BvbmRlclRlcm1pbmF0ZSwgcmVzcG9uZGVySW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgdGVybWluYXRlRXZlbnQudG91Y2hIaXN0b3J5ID0gUmVzcG9uZGVyVG91Y2hIaXN0b3J5U3RvcmUudG91Y2hIaXN0b3J5OwogICAgICAgICAgICBhY2N1bXVsYXRlRGlyZWN0RGlzcGF0Y2hlcyh0ZXJtaW5hdGVFdmVudCk7CiAgICAgICAgICAgIGV4dHJhY3RlZCA9IGFjY3VtdWxhdGUoZXh0cmFjdGVkLCBbZ3JhbnRFdmVudCwgdGVybWluYXRlRXZlbnRdKTsKICAgICAgICAgICAgY2hhbmdlUmVzcG9uZGVyKHdhbnRzUmVzcG9uZGVySW5zdCwgYmxvY2tIb3N0UmVzcG9uZGVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciByZWplY3RFdmVudCA9IFJlc3BvbmRlclN5bnRoZXRpY0V2ZW50LmdldFBvb2xlZChldmVudFR5cGVzLnJlc3BvbmRlclJlamVjdCwgd2FudHNSZXNwb25kZXJJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICByZWplY3RFdmVudC50b3VjaEhpc3RvcnkgPSBSZXNwb25kZXJUb3VjaEhpc3RvcnlTdG9yZS50b3VjaEhpc3Rvcnk7CiAgICAgICAgICAgIGFjY3VtdWxhdGVEaXJlY3REaXNwYXRjaGVzKHJlamVjdEV2ZW50KTsKICAgICAgICAgICAgZXh0cmFjdGVkID0gYWNjdW11bGF0ZShleHRyYWN0ZWQsIHJlamVjdEV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXh0cmFjdGVkID0gYWNjdW11bGF0ZShleHRyYWN0ZWQsIGdyYW50RXZlbnQpOwogICAgICAgICAgY2hhbmdlUmVzcG9uZGVyKHdhbnRzUmVzcG9uZGVySW5zdCwgYmxvY2tIb3N0UmVzcG9uZGVyKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBleHRyYWN0ZWQ7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNhblRyaWdnZXJUcmFuc2Zlcih0b3BMZXZlbFR5cGUsIHRvcExldmVsSW5zdCwgbmF0aXZlRXZlbnQpIHsKICAgICAgICByZXR1cm4gdG9wTGV2ZWxJbnN0ICYmICh0b3BMZXZlbFR5cGUgPT09ICJ0b3BTY3JvbGwiICYmICFuYXRpdmVFdmVudC5yZXNwb25kZXJJZ25vcmVTY3JvbGwgfHwgdHJhY2tlZFRvdWNoQ291bnQgPiAwICYmIHRvcExldmVsVHlwZSA9PT0gInRvcFNlbGVjdGlvbkNoYW5nZSIgfHwgaXNTdGFydGlzaCh0b3BMZXZlbFR5cGUpIHx8IGlzTW92ZWlzaCh0b3BMZXZlbFR5cGUpKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gbm9SZXNwb25kZXJUb3VjaGVzKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgdmFyIHRvdWNoZXMgPSBuYXRpdmVFdmVudC50b3VjaGVzOwoKICAgICAgICBpZiAoIXRvdWNoZXMgfHwgdG91Y2hlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b3VjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgYWN0aXZlVG91Y2ggPSB0b3VjaGVzW2ldOwogICAgICAgICAgdmFyIHRhcmdldCA9IGFjdGl2ZVRvdWNoLnRhcmdldDsKCiAgICAgICAgICBpZiAodGFyZ2V0ICE9PSBudWxsICYmIHRhcmdldCAhPT0gdW5kZWZpbmVkICYmIHRhcmdldCAhPT0gMCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0SW5zdCA9IGdldEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0KTsKCiAgICAgICAgICAgIGlmIChpc0FuY2VzdG9yKHJlc3BvbmRlckluc3QsIHRhcmdldEluc3QpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgdmFyIFJlc3BvbmRlckV2ZW50UGx1Z2luID0gewogICAgICAgIF9nZXRSZXNwb25kZXI6IGZ1bmN0aW9uIF9nZXRSZXNwb25kZXIoKSB7CiAgICAgICAgICByZXR1cm4gcmVzcG9uZGVySW5zdDsKICAgICAgICB9LAogICAgICAgIGV2ZW50VHlwZXM6IGV2ZW50VHlwZXMsCiAgICAgICAgZXh0cmFjdEV2ZW50czogZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyh0b3BMZXZlbFR5cGUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgaWYgKGlzU3RhcnRpc2godG9wTGV2ZWxUeXBlKSkgewogICAgICAgICAgICB0cmFja2VkVG91Y2hDb3VudCArPSAxOwogICAgICAgICAgfSBlbHNlIGlmIChpc0VuZGlzaCh0b3BMZXZlbFR5cGUpKSB7CiAgICAgICAgICAgIGlmICh0cmFja2VkVG91Y2hDb3VudCA+PSAwKSB7CiAgICAgICAgICAgICAgdHJhY2tlZFRvdWNoQ291bnQgLT0gMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJFbmRlZCBhIHRvdWNoIGV2ZW50IHdoaWNoIHdhcyBub3QgY291bnRlZCBpbiBgdHJhY2tlZFRvdWNoQ291bnRgLiIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgUmVzcG9uZGVyVG91Y2hIaXN0b3J5U3RvcmUucmVjb3JkVG91Y2hUcmFjayh0b3BMZXZlbFR5cGUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIHZhciBleHRyYWN0ZWQgPSBjYW5UcmlnZ2VyVHJhbnNmZXIodG9wTGV2ZWxUeXBlLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCkgPyBzZXRSZXNwb25kZXJBbmRFeHRyYWN0VHJhbnNmZXIodG9wTGV2ZWxUeXBlLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIDogbnVsbDsKICAgICAgICAgIHZhciBpc1Jlc3BvbmRlclRvdWNoU3RhcnQgPSByZXNwb25kZXJJbnN0ICYmIGlzU3RhcnRpc2godG9wTGV2ZWxUeXBlKTsKICAgICAgICAgIHZhciBpc1Jlc3BvbmRlclRvdWNoTW92ZSA9IHJlc3BvbmRlckluc3QgJiYgaXNNb3ZlaXNoKHRvcExldmVsVHlwZSk7CiAgICAgICAgICB2YXIgaXNSZXNwb25kZXJUb3VjaEVuZCA9IHJlc3BvbmRlckluc3QgJiYgaXNFbmRpc2godG9wTGV2ZWxUeXBlKTsKICAgICAgICAgIHZhciBpbmNyZW1lbnRhbFRvdWNoID0gaXNSZXNwb25kZXJUb3VjaFN0YXJ0ID8gZXZlbnRUeXBlcy5yZXNwb25kZXJTdGFydCA6IGlzUmVzcG9uZGVyVG91Y2hNb3ZlID8gZXZlbnRUeXBlcy5yZXNwb25kZXJNb3ZlIDogaXNSZXNwb25kZXJUb3VjaEVuZCA/IGV2ZW50VHlwZXMucmVzcG9uZGVyRW5kIDogbnVsbDsKCiAgICAgICAgICBpZiAoaW5jcmVtZW50YWxUb3VjaCkgewogICAgICAgICAgICB2YXIgZ2VzdHVyZSA9IFJlc3BvbmRlclN5bnRoZXRpY0V2ZW50LmdldFBvb2xlZChpbmNyZW1lbnRhbFRvdWNoLCByZXNwb25kZXJJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBnZXN0dXJlLnRvdWNoSGlzdG9yeSA9IFJlc3BvbmRlclRvdWNoSGlzdG9yeVN0b3JlLnRvdWNoSGlzdG9yeTsKICAgICAgICAgICAgYWNjdW11bGF0ZURpcmVjdERpc3BhdGNoZXMoZ2VzdHVyZSk7CiAgICAgICAgICAgIGV4dHJhY3RlZCA9IGFjY3VtdWxhdGUoZXh0cmFjdGVkLCBnZXN0dXJlKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgaXNSZXNwb25kZXJUZXJtaW5hdGUgPSByZXNwb25kZXJJbnN0ICYmIHRvcExldmVsVHlwZSA9PT0gInRvcFRvdWNoQ2FuY2VsIjsKICAgICAgICAgIHZhciBpc1Jlc3BvbmRlclJlbGVhc2UgPSByZXNwb25kZXJJbnN0ICYmICFpc1Jlc3BvbmRlclRlcm1pbmF0ZSAmJiBpc0VuZGlzaCh0b3BMZXZlbFR5cGUpICYmIG5vUmVzcG9uZGVyVG91Y2hlcyhuYXRpdmVFdmVudCk7CiAgICAgICAgICB2YXIgZmluYWxUb3VjaCA9IGlzUmVzcG9uZGVyVGVybWluYXRlID8gZXZlbnRUeXBlcy5yZXNwb25kZXJUZXJtaW5hdGUgOiBpc1Jlc3BvbmRlclJlbGVhc2UgPyBldmVudFR5cGVzLnJlc3BvbmRlclJlbGVhc2UgOiBudWxsOwoKICAgICAgICAgIGlmIChmaW5hbFRvdWNoKSB7CiAgICAgICAgICAgIHZhciBmaW5hbEV2ZW50ID0gUmVzcG9uZGVyU3ludGhldGljRXZlbnQuZ2V0UG9vbGVkKGZpbmFsVG91Y2gsIHJlc3BvbmRlckluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGZpbmFsRXZlbnQudG91Y2hIaXN0b3J5ID0gUmVzcG9uZGVyVG91Y2hIaXN0b3J5U3RvcmUudG91Y2hIaXN0b3J5OwogICAgICAgICAgICBhY2N1bXVsYXRlRGlyZWN0RGlzcGF0Y2hlcyhmaW5hbEV2ZW50KTsKICAgICAgICAgICAgZXh0cmFjdGVkID0gYWNjdW11bGF0ZShleHRyYWN0ZWQsIGZpbmFsRXZlbnQpOwogICAgICAgICAgICBjaGFuZ2VSZXNwb25kZXIobnVsbCk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG51bWJlckFjdGl2ZVRvdWNoZXMgPSBSZXNwb25kZXJUb3VjaEhpc3RvcnlTdG9yZS50b3VjaEhpc3RvcnkubnVtYmVyQWN0aXZlVG91Y2hlczsKCiAgICAgICAgICBpZiAoUmVzcG9uZGVyRXZlbnRQbHVnaW4uR2xvYmFsSW50ZXJhY3Rpb25IYW5kbGVyICYmIG51bWJlckFjdGl2ZVRvdWNoZXMgIT09IHByZXZpb3VzQWN0aXZlVG91Y2hlcykgewogICAgICAgICAgICBSZXNwb25kZXJFdmVudFBsdWdpbi5HbG9iYWxJbnRlcmFjdGlvbkhhbmRsZXIub25DaGFuZ2UobnVtYmVyQWN0aXZlVG91Y2hlcyk7CiAgICAgICAgICB9CgogICAgICAgICAgcHJldmlvdXNBY3RpdmVUb3VjaGVzID0gbnVtYmVyQWN0aXZlVG91Y2hlczsKICAgICAgICAgIHJldHVybiBleHRyYWN0ZWQ7CiAgICAgICAgfSwKICAgICAgICBHbG9iYWxSZXNwb25kZXJIYW5kbGVyOiBudWxsLAogICAgICAgIEdsb2JhbEludGVyYWN0aW9uSGFuZGxlcjogbnVsbCwKICAgICAgICBpbmplY3Rpb246IHsKICAgICAgICAgIGluamVjdEdsb2JhbFJlc3BvbmRlckhhbmRsZXI6IGZ1bmN0aW9uIGluamVjdEdsb2JhbFJlc3BvbmRlckhhbmRsZXIoR2xvYmFsUmVzcG9uZGVySGFuZGxlcikgewogICAgICAgICAgICBSZXNwb25kZXJFdmVudFBsdWdpbi5HbG9iYWxSZXNwb25kZXJIYW5kbGVyID0gR2xvYmFsUmVzcG9uZGVySGFuZGxlcjsKICAgICAgICAgIH0sCiAgICAgICAgICBpbmplY3RHbG9iYWxJbnRlcmFjdGlvbkhhbmRsZXI6IGZ1bmN0aW9uIGluamVjdEdsb2JhbEludGVyYWN0aW9uSGFuZGxlcihHbG9iYWxJbnRlcmFjdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgUmVzcG9uZGVyRXZlbnRQbHVnaW4uR2xvYmFsSW50ZXJhY3Rpb25IYW5kbGVyID0gR2xvYmFsSW50ZXJhY3Rpb25IYW5kbGVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgdmFyIGN1c3RvbUJ1YmJsaW5nRXZlbnRUeXBlcyA9IHt9OwogICAgICB2YXIgY3VzdG9tRGlyZWN0RXZlbnRUeXBlcyA9IHt9OwogICAgICB2YXIgUmVhY3ROYXRpdmVCcmlkZ2VFdmVudFBsdWdpbiA9IHsKICAgICAgICBldmVudFR5cGVzOiB7fSwKICAgICAgICBleHRyYWN0RXZlbnRzOiBmdW5jdGlvbiBleHRyYWN0RXZlbnRzKHRvcExldmVsVHlwZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgYnViYmxlRGlzcGF0Y2hDb25maWcgPSBjdXN0b21CdWJibGluZ0V2ZW50VHlwZXNbdG9wTGV2ZWxUeXBlXTsKICAgICAgICAgIHZhciBkaXJlY3REaXNwYXRjaENvbmZpZyA9IGN1c3RvbURpcmVjdEV2ZW50VHlwZXNbdG9wTGV2ZWxUeXBlXTsKICAgICAgICAgIGludmFyaWFudChidWJibGVEaXNwYXRjaENvbmZpZyB8fCBkaXJlY3REaXNwYXRjaENvbmZpZywgJ1Vuc3VwcG9ydGVkIHRvcCBsZXZlbCBldmVudCB0eXBlICIlcyIgZGlzcGF0Y2hlZCcsIHRvcExldmVsVHlwZSk7CiAgICAgICAgICB2YXIgZXZlbnQgPSBTeW50aGV0aWNFdmVudCQxLmdldFBvb2xlZChidWJibGVEaXNwYXRjaENvbmZpZyB8fCBkaXJlY3REaXNwYXRjaENvbmZpZywgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKCiAgICAgICAgICBpZiAoYnViYmxlRGlzcGF0Y2hDb25maWcpIHsKICAgICAgICAgICAgYWNjdW11bGF0ZVR3b1BoYXNlRGlzcGF0Y2hlcyhldmVudCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRpcmVjdERpc3BhdGNoQ29uZmlnKSB7CiAgICAgICAgICAgIGFjY3VtdWxhdGVEaXJlY3REaXNwYXRjaGVzKGV2ZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBldmVudDsKICAgICAgICB9LAogICAgICAgIHByb2Nlc3NFdmVudFR5cGVzOiBmdW5jdGlvbiBwcm9jZXNzRXZlbnRUeXBlcyh2aWV3Q29uZmlnKSB7CiAgICAgICAgICB2YXIgYnViYmxpbmdFdmVudFR5cGVzID0gdmlld0NvbmZpZy5idWJibGluZ0V2ZW50VHlwZXMsCiAgICAgICAgICAgICAgZGlyZWN0RXZlbnRUeXBlcyA9IHZpZXdDb25maWcuZGlyZWN0RXZlbnRUeXBlczsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGJ1YmJsaW5nRXZlbnRUeXBlcyAhPSBudWxsICYmIGRpcmVjdEV2ZW50VHlwZXMgIT0gbnVsbCkgewogICAgICAgICAgICAgIGZvciAodmFyIHRvcExldmVsVHlwZSBpbiBkaXJlY3RFdmVudFR5cGVzKSB7CiAgICAgICAgICAgICAgICBpbnZhcmlhbnQoYnViYmxpbmdFdmVudFR5cGVzW3RvcExldmVsVHlwZV0gPT0gbnVsbCwgIkV2ZW50IGNhbm5vdCBiZSBib3RoIGRpcmVjdCBhbmQgYnViYmxpbmc6ICVzIiwgdG9wTGV2ZWxUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoYnViYmxpbmdFdmVudFR5cGVzICE9IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgX3RvcExldmVsVHlwZSBpbiBidWJibGluZ0V2ZW50VHlwZXMpIHsKICAgICAgICAgICAgICBpZiAoY3VzdG9tQnViYmxpbmdFdmVudFR5cGVzW190b3BMZXZlbFR5cGVdID09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0TmF0aXZlQnJpZGdlRXZlbnRQbHVnaW4uZXZlbnRUeXBlc1tfdG9wTGV2ZWxUeXBlXSA9IGN1c3RvbUJ1YmJsaW5nRXZlbnRUeXBlc1tfdG9wTGV2ZWxUeXBlXSA9IGJ1YmJsaW5nRXZlbnRUeXBlc1tfdG9wTGV2ZWxUeXBlXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZGlyZWN0RXZlbnRUeXBlcyAhPSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIF90b3BMZXZlbFR5cGUyIGluIGRpcmVjdEV2ZW50VHlwZXMpIHsKICAgICAgICAgICAgICBpZiAoY3VzdG9tRGlyZWN0RXZlbnRUeXBlc1tfdG9wTGV2ZWxUeXBlMl0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmVhY3ROYXRpdmVCcmlkZ2VFdmVudFBsdWdpbi5ldmVudFR5cGVzW190b3BMZXZlbFR5cGUyXSA9IGN1c3RvbURpcmVjdEV2ZW50VHlwZXNbX3RvcExldmVsVHlwZTJdID0gZGlyZWN0RXZlbnRUeXBlc1tfdG9wTGV2ZWxUeXBlMl07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICB2YXIgaW5zdGFuY2VDYWNoZSA9IHt9OwogICAgICB2YXIgaW5zdGFuY2VQcm9wcyA9IHt9OwoKICAgICAgZnVuY3Rpb24gcHJlY2FjaGVGaWJlck5vZGUoaG9zdEluc3QsIHRhZykgewogICAgICAgIGluc3RhbmNlQ2FjaGVbdGFnXSA9IGhvc3RJbnN0OwogICAgICB9CgogICAgICBmdW5jdGlvbiB1bmNhY2hlRmliZXJOb2RlKHRhZykgewogICAgICAgIGRlbGV0ZSBpbnN0YW5jZUNhY2hlW3RhZ107CiAgICAgICAgZGVsZXRlIGluc3RhbmNlUHJvcHNbdGFnXTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2VGcm9tVGFnKHRhZykgewogICAgICAgIHJldHVybiBpbnN0YW5jZUNhY2hlW3RhZ10gfHwgbnVsbDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0VGFnRnJvbUluc3RhbmNlKGluc3QpIHsKICAgICAgICB2YXIgdGFnID0gaW5zdC5zdGF0ZU5vZGUuX25hdGl2ZVRhZzsKICAgICAgICBpbnZhcmlhbnQodGFnLCAiQWxsIG5hdGl2ZSBpbnN0YW5jZXMgc2hvdWxkIGhhdmUgYSB0YWcuIik7CiAgICAgICAgcmV0dXJuIHRhZzsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZSQxKHN0YXRlTm9kZSkgewogICAgICAgIHJldHVybiBpbnN0YW5jZVByb3BzW3N0YXRlTm9kZS5fbmF0aXZlVGFnXSB8fCBudWxsOwogICAgICB9CgogICAgICBmdW5jdGlvbiB1cGRhdGVGaWJlclByb3BzKHRhZywgcHJvcHMpIHsKICAgICAgICBpbnN0YW5jZVByb3BzW3RhZ10gPSBwcm9wczsKICAgICAgfQoKICAgICAgdmFyIFJlYWN0TmF0aXZlQ29tcG9uZW50VHJlZSA9IE9iamVjdC5mcmVlemUoewogICAgICAgIHByZWNhY2hlRmliZXJOb2RlOiBwcmVjYWNoZUZpYmVyTm9kZSwKICAgICAgICB1bmNhY2hlRmliZXJOb2RlOiB1bmNhY2hlRmliZXJOb2RlLAogICAgICAgIGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlOiBnZXRJbnN0YW5jZUZyb21UYWcsCiAgICAgICAgZ2V0SW5zdGFuY2VGcm9tTm9kZTogZ2V0SW5zdGFuY2VGcm9tVGFnLAogICAgICAgIGdldE5vZGVGcm9tSW5zdGFuY2U6IGdldFRhZ0Zyb21JbnN0YW5jZSwKICAgICAgICBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlOiBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlJDEsCiAgICAgICAgdXBkYXRlRmliZXJQcm9wczogdXBkYXRlRmliZXJQcm9wcwogICAgICB9KTsKICAgICAgdmFyIGZpYmVySG9zdENvbXBvbmVudCA9IG51bGw7CiAgICAgIHZhciByZXN0b3JlVGFyZ2V0ID0gbnVsbDsKICAgICAgdmFyIHJlc3RvcmVRdWV1ZSA9IG51bGw7CgogICAgICBmdW5jdGlvbiByZXN0b3JlU3RhdGVPZlRhcmdldCh0YXJnZXQpIHsKICAgICAgICB2YXIgaW50ZXJuYWxJbnN0YW5jZSA9IGdldEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0KTsKCiAgICAgICAgaWYgKCFpbnRlcm5hbEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpbnZhcmlhbnQoZmliZXJIb3N0Q29tcG9uZW50ICYmIHR5cGVvZiBmaWJlckhvc3RDb21wb25lbnQucmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSA9PT0gImZ1bmN0aW9uIiwgIkZpYmVyIG5lZWRzIHRvIGJlIGluamVjdGVkIHRvIGhhbmRsZSBhIGZpYmVyIHRhcmdldCBmb3IgY29udHJvbGxlZCAiICsgImV2ZW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB2YXIgcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlKTsKICAgICAgICBmaWJlckhvc3RDb21wb25lbnQucmVzdG9yZUNvbnRyb2xsZWRTdGF0ZShpbnRlcm5hbEluc3RhbmNlLnN0YXRlTm9kZSwgaW50ZXJuYWxJbnN0YW5jZS50eXBlLCBwcm9wcyk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCkgewogICAgICAgIGlmICghcmVzdG9yZVRhcmdldCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRhcmdldCA9IHJlc3RvcmVUYXJnZXQ7CiAgICAgICAgdmFyIHF1ZXVlZFRhcmdldHMgPSByZXN0b3JlUXVldWU7CiAgICAgICAgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgcmVzdG9yZVF1ZXVlID0gbnVsbDsKICAgICAgICByZXN0b3JlU3RhdGVPZlRhcmdldCh0YXJnZXQpOwoKICAgICAgICBpZiAocXVldWVkVGFyZ2V0cykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZWRUYXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHF1ZXVlZFRhcmdldHNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIGZpYmVyQmF0Y2hlZFVwZGF0ZXMgPSBmdW5jdGlvbiBmaWJlckJhdGNoZWRVcGRhdGVzKGZuLCBib29ra2VlcGluZykgewogICAgICAgIHJldHVybiBmbihib29ra2VlcGluZyk7CiAgICAgIH07CgogICAgICB2YXIgaXNOZXN0aW5nQmF0Y2hlZCA9IGZhbHNlOwoKICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMoZm4sIGJvb2trZWVwaW5nKSB7CiAgICAgICAgaWYgKGlzTmVzdGluZ0JhdGNoZWQpIHsKICAgICAgICAgIHJldHVybiBmaWJlckJhdGNoZWRVcGRhdGVzKGZuLCBib29ra2VlcGluZyk7CiAgICAgICAgfQoKICAgICAgICBpc05lc3RpbmdCYXRjaGVkID0gdHJ1ZTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBmaWJlckJhdGNoZWRVcGRhdGVzKGZuLCBib29ra2VlcGluZyk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlzTmVzdGluZ0JhdGNoZWQgPSBmYWxzZTsKICAgICAgICAgIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgUmVhY3RHZW5lcmljQmF0Y2hpbmdJbmplY3Rpb24gPSB7CiAgICAgICAgaW5qZWN0RmliZXJCYXRjaGVkVXBkYXRlczogZnVuY3Rpb24gaW5qZWN0RmliZXJCYXRjaGVkVXBkYXRlcyhfYmF0Y2hlZFVwZGF0ZXMpIHsKICAgICAgICAgIGZpYmVyQmF0Y2hlZFVwZGF0ZXMgPSBfYmF0Y2hlZFVwZGF0ZXM7CiAgICAgICAgfQogICAgICB9OwogICAgICB2YXIgaW5qZWN0aW9uJDIgPSBSZWFjdEdlbmVyaWNCYXRjaGluZ0luamVjdGlvbjsKCiAgICAgIGZ1bmN0aW9uIHJ1bkV2ZW50UXVldWVJbkJhdGNoKGV2ZW50cykgewogICAgICAgIGVucXVldWVFdmVudHMoZXZlbnRzKTsKICAgICAgICBwcm9jZXNzRXZlbnRRdWV1ZShmYWxzZSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvcExldmVsKHRvcExldmVsVHlwZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgdmFyIGV2ZW50cyA9IGV4dHJhY3RFdmVudHModG9wTGV2ZWxUeXBlLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgIHJ1bkV2ZW50UXVldWVJbkJhdGNoKGV2ZW50cyk7CiAgICAgIH0KCiAgICAgIHZhciBJTklUSUFMX1RBR19DT1VOVCA9IDE7CiAgICAgIHZhciBSZWFjdE5hdGl2ZVRhZ0hhbmRsZXMgPSB7CiAgICAgICAgdGFnc1N0YXJ0QXQ6IElOSVRJQUxfVEFHX0NPVU5ULAogICAgICAgIHRhZ0NvdW50OiBJTklUSUFMX1RBR19DT1VOVCwKICAgICAgICBhbGxvY2F0ZVRhZzogZnVuY3Rpb24gYWxsb2NhdGVUYWcoKSB7CiAgICAgICAgICB3aGlsZSAodGhpcy5yZWFjdFRhZ0lzTmF0aXZlVG9wUm9vdElEKFJlYWN0TmF0aXZlVGFnSGFuZGxlcy50YWdDb3VudCkpIHsKICAgICAgICAgICAgUmVhY3ROYXRpdmVUYWdIYW5kbGVzLnRhZ0NvdW50Kys7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHRhZyA9IFJlYWN0TmF0aXZlVGFnSGFuZGxlcy50YWdDb3VudDsKICAgICAgICAgIFJlYWN0TmF0aXZlVGFnSGFuZGxlcy50YWdDb3VudCsrOwogICAgICAgICAgcmV0dXJuIHRhZzsKICAgICAgICB9LAogICAgICAgIGFzc2VydFJvb3RUYWc6IGZ1bmN0aW9uIGFzc2VydFJvb3RUYWcodGFnKSB7CiAgICAgICAgICBpbnZhcmlhbnQodGhpcy5yZWFjdFRhZ0lzTmF0aXZlVG9wUm9vdElEKHRhZyksICJFeHBlY3QgYSBuYXRpdmUgcm9vdCB0YWcsIGluc3RlYWQgZ290ICVzIiwgdGFnKTsKICAgICAgICB9LAogICAgICAgIHJlYWN0VGFnSXNOYXRpdmVUb3BSb290SUQ6IGZ1bmN0aW9uIHJlYWN0VGFnSXNOYXRpdmVUb3BSb290SUQocmVhY3RUYWcpIHsKICAgICAgICAgIHJldHVybiByZWFjdFRhZyAlIDEwID09PSAxOwogICAgICAgIH0KICAgICAgfTsKICAgICAgdmFyIEVNUFRZX05BVElWRV9FVkVOVCA9IHt9OwoKICAgICAgdmFyIHRvdWNoU3Vic2VxdWVuY2UgPSBmdW5jdGlvbiB0b3VjaFN1YnNlcXVlbmNlKHRvdWNoZXMsIGluZGljZXMpIHsKICAgICAgICB2YXIgcmV0ID0gW107CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5kaWNlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmV0LnB1c2godG91Y2hlc1tpbmRpY2VzW2ldXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmV0OwogICAgICB9OwoKICAgICAgdmFyIHJlbW92ZVRvdWNoZXNBdEluZGljZXMgPSBmdW5jdGlvbiByZW1vdmVUb3VjaGVzQXRJbmRpY2VzKHRvdWNoZXMsIGluZGljZXMpIHsKICAgICAgICB2YXIgcmlwcGVkT3V0ID0gW107CiAgICAgICAgdmFyIHRlbXAgPSB0b3VjaGVzOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluZGljZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBpbmRleCA9IGluZGljZXNbaV07CiAgICAgICAgICByaXBwZWRPdXQucHVzaCh0b3VjaGVzW2luZGV4XSk7CiAgICAgICAgICB0ZW1wW2luZGV4XSA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICB2YXIgZmlsbEF0ID0gMDsKCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0ZW1wLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICB2YXIgY3VyID0gdGVtcFtqXTsKCiAgICAgICAgICBpZiAoY3VyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRlbXBbZmlsbEF0KytdID0gY3VyOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGVtcC5sZW5ndGggPSBmaWxsQXQ7CiAgICAgICAgcmV0dXJuIHJpcHBlZE91dDsKICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIF9yZWNlaXZlUm9vdE5vZGVJREV2ZW50KHJvb3ROb2RlSUQsIHRvcExldmVsVHlwZSwgbmF0aXZlRXZlbnRQYXJhbSkgewogICAgICAgIHZhciBuYXRpdmVFdmVudCA9IG5hdGl2ZUV2ZW50UGFyYW0gfHwgRU1QVFlfTkFUSVZFX0VWRU5UOwogICAgICAgIHZhciBpbnN0ID0gZ2V0SW5zdGFuY2VGcm9tVGFnKHJvb3ROb2RlSUQpOwogICAgICAgIGJhdGNoZWRVcGRhdGVzKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGhhbmRsZVRvcExldmVsKHRvcExldmVsVHlwZSwgaW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50LnRhcmdldCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHJlY2VpdmVFdmVudChyb290Tm9kZUlELCB0b3BMZXZlbFR5cGUsIG5hdGl2ZUV2ZW50UGFyYW0pIHsKICAgICAgICBfcmVjZWl2ZVJvb3ROb2RlSURFdmVudChyb290Tm9kZUlELCB0b3BMZXZlbFR5cGUsIG5hdGl2ZUV2ZW50UGFyYW0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiByZWNlaXZlVG91Y2hlcyhldmVudFRvcExldmVsVHlwZSwgdG91Y2hlcywgY2hhbmdlZEluZGljZXMpIHsKICAgICAgICB2YXIgY2hhbmdlZFRvdWNoZXMgPSBldmVudFRvcExldmVsVHlwZSA9PT0gInRvcFRvdWNoRW5kIiB8fCBldmVudFRvcExldmVsVHlwZSA9PT0gInRvcFRvdWNoQ2FuY2VsIiA/IHJlbW92ZVRvdWNoZXNBdEluZGljZXModG91Y2hlcywgY2hhbmdlZEluZGljZXMpIDogdG91Y2hTdWJzZXF1ZW5jZSh0b3VjaGVzLCBjaGFuZ2VkSW5kaWNlcyk7CgogICAgICAgIGZvciAodmFyIGpqID0gMDsgamogPCBjaGFuZ2VkVG91Y2hlcy5sZW5ndGg7IGpqKyspIHsKICAgICAgICAgIHZhciB0b3VjaCA9IGNoYW5nZWRUb3VjaGVzW2pqXTsKICAgICAgICAgIHRvdWNoLmNoYW5nZWRUb3VjaGVzID0gY2hhbmdlZFRvdWNoZXM7CiAgICAgICAgICB0b3VjaC50b3VjaGVzID0gdG91Y2hlczsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudCA9IHRvdWNoOwogICAgICAgICAgdmFyIHJvb3ROb2RlSUQgPSBudWxsOwogICAgICAgICAgdmFyIHRhcmdldCA9IG5hdGl2ZUV2ZW50LnRhcmdldDsKCiAgICAgICAgICBpZiAodGFyZ2V0ICE9PSBudWxsICYmIHRhcmdldCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGlmICh0YXJnZXQgPCBSZWFjdE5hdGl2ZVRhZ0hhbmRsZXMudGFnc1N0YXJ0QXQpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAiQSB2aWV3IGlzIHJlcG9ydGluZyB0aGF0IGEgdG91Y2ggb2NjdXJyZWQgb24gdGFnIHplcm8uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJvb3ROb2RlSUQgPSB0YXJnZXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBfcmVjZWl2ZVJvb3ROb2RlSURFdmVudChyb290Tm9kZUlELCBldmVudFRvcExldmVsVHlwZSwgbmF0aXZlRXZlbnQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIFJlYWN0TmF0aXZlRXZlbnRFbWl0dGVyID0gT2JqZWN0LmZyZWV6ZSh7CiAgICAgICAgZ2V0TGlzdGVuZXI6IGdldExpc3RlbmVyLAogICAgICAgIHJlZ2lzdHJhdGlvbk5hbWVzOiByZWdpc3RyYXRpb25OYW1lTW9kdWxlcywKICAgICAgICBfcmVjZWl2ZVJvb3ROb2RlSURFdmVudDogX3JlY2VpdmVSb290Tm9kZUlERXZlbnQsCiAgICAgICAgcmVjZWl2ZUV2ZW50OiByZWNlaXZlRXZlbnQsCiAgICAgICAgcmVjZWl2ZVRvdWNoZXM6IHJlY2VpdmVUb3VjaGVzLAogICAgICAgIGhhbmRsZVRvcExldmVsOiBoYW5kbGVUb3BMZXZlbAogICAgICB9KTsKICAgICAgdmFyIFJlYWN0TmF0aXZlRXZlbnRQbHVnaW5PcmRlciA9IFsiUmVzcG9uZGVyRXZlbnRQbHVnaW4iLCAiUmVhY3ROYXRpdmVCcmlkZ2VFdmVudFBsdWdpbiJdOwogICAgICB2YXIgUmVhY3ROYXRpdmVHbG9iYWxSZXNwb25kZXJIYW5kbGVyID0gewogICAgICAgIG9uQ2hhbmdlOiBmdW5jdGlvbiBvbkNoYW5nZShmcm9tLCB0bywgYmxvY2tOYXRpdmVSZXNwb25kZXIpIHsKICAgICAgICAgIGlmICh0byAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdGFnID0gdG8uc3RhdGVOb2RlLl9uYXRpdmVUYWc7CiAgICAgICAgICAgIFVJTWFuYWdlci5zZXRKU1Jlc3BvbmRlcih0YWcsIGJsb2NrTmF0aXZlUmVzcG9uZGVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIFVJTWFuYWdlci5jbGVhckpTUmVzcG9uZGVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICBSQ1RFdmVudEVtaXR0ZXIucmVnaXN0ZXIoUmVhY3ROYXRpdmVFdmVudEVtaXR0ZXIpOwogICAgICBpbmplY3Rpb24uaW5qZWN0RXZlbnRQbHVnaW5PcmRlcihSZWFjdE5hdGl2ZUV2ZW50UGx1Z2luT3JkZXIpOwogICAgICBpbmplY3Rpb24kMS5pbmplY3RDb21wb25lbnRUcmVlKFJlYWN0TmF0aXZlQ29tcG9uZW50VHJlZSk7CiAgICAgIFJlc3BvbmRlckV2ZW50UGx1Z2luLmluamVjdGlvbi5pbmplY3RHbG9iYWxSZXNwb25kZXJIYW5kbGVyKFJlYWN0TmF0aXZlR2xvYmFsUmVzcG9uZGVySGFuZGxlcik7CiAgICAgIGluamVjdGlvbi5pbmplY3RFdmVudFBsdWdpbnNCeU5hbWUoewogICAgICAgIFJlc3BvbmRlckV2ZW50UGx1Z2luOiBSZXNwb25kZXJFdmVudFBsdWdpbiwKICAgICAgICBSZWFjdE5hdGl2ZUJyaWRnZUV2ZW50UGx1Z2luOiBSZWFjdE5hdGl2ZUJyaWRnZUV2ZW50UGx1Z2luCiAgICAgIH0pOwoKICAgICAgdmFyIGRlZmF1bHRTaG93RGlhbG9nID0gZnVuY3Rpb24gZGVmYXVsdFNob3dEaWFsb2coY2FwdHVyZWRFcnJvcikgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9OwoKICAgICAgdmFyIHNob3dEaWFsb2cgPSBkZWZhdWx0U2hvd0RpYWxvZzsKCiAgICAgIGZ1bmN0aW9uIGxvZ0NhcHR1cmVkRXJyb3IoY2FwdHVyZWRFcnJvcikgewogICAgICAgIHZhciBsb2dFcnJvciA9IHNob3dEaWFsb2coY2FwdHVyZWRFcnJvcik7CgogICAgICAgIGlmIChsb2dFcnJvciA9PT0gZmFsc2UpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBlcnJvciA9IGNhcHR1cmVkRXJyb3IuZXJyb3I7CiAgICAgICAgdmFyIHN1cHByZXNzTG9nZ2luZyA9IGVycm9yICYmIGVycm9yLnN1cHByZXNzUmVhY3RFcnJvckxvZ2dpbmc7CgogICAgICAgIGlmIChzdXBwcmVzc0xvZ2dpbmcpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHsKICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gY2FwdHVyZWRFcnJvci5jb21wb25lbnROYW1lLAogICAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrID0gY2FwdHVyZWRFcnJvci5jb21wb25lbnRTdGFjaywKICAgICAgICAgICAgICBlcnJvckJvdW5kYXJ5TmFtZSA9IGNhcHR1cmVkRXJyb3IuZXJyb3JCb3VuZGFyeU5hbWUsCiAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeUZvdW5kID0gY2FwdHVyZWRFcnJvci5lcnJvckJvdW5kYXJ5Rm91bmQsCiAgICAgICAgICAgICAgd2lsbFJldHJ5ID0gY2FwdHVyZWRFcnJvci53aWxsUmV0cnk7CiAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZU1lc3NhZ2UgPSBjb21wb25lbnROYW1lID8gIlRoZSBhYm92ZSBlcnJvciBvY2N1cnJlZCBpbiB0aGUgPCIgKyBjb21wb25lbnROYW1lICsgIj4gY29tcG9uZW50OiIgOiAiVGhlIGFib3ZlIGVycm9yIG9jY3VycmVkIGluIG9uZSBvZiB5b3VyIFJlYWN0IGNvbXBvbmVudHM6IjsKICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TWVzc2FnZSA9IHZvaWQgMDsKCiAgICAgICAgICBpZiAoZXJyb3JCb3VuZGFyeUZvdW5kICYmIGVycm9yQm91bmRhcnlOYW1lKSB7CiAgICAgICAgICAgIGlmICh3aWxsUmV0cnkpIHsKICAgICAgICAgICAgICBlcnJvckJvdW5kYXJ5TWVzc2FnZSA9ICJSZWFjdCB3aWxsIHRyeSB0byByZWNyZWF0ZSB0aGlzIGNvbXBvbmVudCB0cmVlIGZyb20gc2NyYXRjaCAiICsgKCJ1c2luZyB0aGUgZXJyb3IgYm91bmRhcnkgeW91IHByb3ZpZGVkLCAiICsgZXJyb3JCb3VuZGFyeU5hbWUgKyAiLiIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yQm91bmRhcnlNZXNzYWdlID0gIlRoaXMgZXJyb3Igd2FzIGluaXRpYWxseSBoYW5kbGVkIGJ5IHRoZSBlcnJvciBib3VuZGFyeSAiICsgZXJyb3JCb3VuZGFyeU5hbWUgKyAiLlxuIiArICJSZWNyZWF0aW5nIHRoZSB0cmVlIGZyb20gc2NyYXRjaCBmYWlsZWQgc28gUmVhY3Qgd2lsbCB1bm1vdW50IHRoZSB0cmVlLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVycm9yQm91bmRhcnlNZXNzYWdlID0gIkNvbnNpZGVyIGFkZGluZyBhbiBlcnJvciBib3VuZGFyeSB0byB5b3VyIHRyZWUgdG8gY3VzdG9taXplIGVycm9yIGhhbmRsaW5nIGJlaGF2aW9yLlxuIiArICJWaXNpdCBodHRwczovL2ZiLm1lL3JlYWN0LWVycm9yLWJvdW5kYXJpZXMgdG8gbGVhcm4gbW9yZSBhYm91dCBlcnJvciBib3VuZGFyaWVzLiI7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGNvbWJpbmVkTWVzc2FnZSA9ICIiICsgY29tcG9uZW50TmFtZU1lc3NhZ2UgKyBjb21wb25lbnRTdGFjayArICJcblxuIiArICgiIiArIGVycm9yQm91bmRhcnlNZXNzYWdlKTsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoY29tYmluZWRNZXNzYWdlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBpbmplY3Rpb24kNCA9IHsKICAgICAgICBpbmplY3REaWFsb2c6IGZ1bmN0aW9uIGluamVjdERpYWxvZyhmbikgewogICAgICAgICAgaW52YXJpYW50KHNob3dEaWFsb2cgPT09IGRlZmF1bHRTaG93RGlhbG9nLCAiVGhlIGN1c3RvbSBkaWFsb2cgd2FzIGFscmVhZHkgaW5qZWN0ZWQuIik7CiAgICAgICAgICBpbnZhcmlhbnQodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iLCAiSW5qZWN0ZWQgc2hvd0RpYWxvZygpIG11c3QgYmUgYSBmdW5jdGlvbi4iKTsKICAgICAgICAgIHNob3dEaWFsb2cgPSBmbjsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHZhciBoYXNTeW1ib2wgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbFsiZm9yIl07CiAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBoYXNTeW1ib2wgPyBTeW1ib2xbImZvciJdKCJyZWFjdC5lbGVtZW50IikgOiAweGVhYzc7CiAgICAgIHZhciBSRUFDVF9DQUxMX1RZUEUgPSBoYXNTeW1ib2wgPyBTeW1ib2xbImZvciJdKCJyZWFjdC5jYWxsIikgOiAweGVhYzg7CiAgICAgIHZhciBSRUFDVF9SRVRVUk5fVFlQRSA9IGhhc1N5bWJvbCA/IFN5bWJvbFsiZm9yIl0oInJlYWN0LnJldHVybiIpIDogMHhlYWM5OwogICAgICB2YXIgUkVBQ1RfUE9SVEFMX1RZUEUgPSBoYXNTeW1ib2wgPyBTeW1ib2xbImZvciJdKCJyZWFjdC5wb3J0YWwiKSA6IDB4ZWFjYTsKICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBoYXNTeW1ib2wgPyBTeW1ib2xbImZvciJdKCJyZWFjdC5mcmFnbWVudCIpIDogMHhlYWNiOwogICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5pdGVyYXRvciA6ICJAQGl0ZXJhdG9yIik7CiAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKCiAgICAgIGZ1bmN0aW9uIGdldEl0ZXJhdG9yRm4obWF5YmVJdGVyYWJsZSkgewogICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CgogICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gX2NyZWF0ZVBvcnRhbChjaGlsZHJlbiwgY29udGFpbmVySW5mbywgaW1wbGVtZW50YXRpb24pIHsKICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbM10gOiBudWxsOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfUE9SVEFMX1RZUEUsCiAgICAgICAgICBrZXk6IGtleSA9PSBudWxsID8gbnVsbCA6ICIiICsga2V5LAogICAgICAgICAgY2hpbGRyZW46IGNoaWxkcmVuLAogICAgICAgICAgY29udGFpbmVySW5mbzogY29udGFpbmVySW5mbywKICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBpbXBsZW1lbnRhdGlvbgogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHZhciBUb3VjaEhpc3RvcnlNYXRoID0gewogICAgICAgIGNlbnRyb2lkRGltZW5zaW9uOiBmdW5jdGlvbiBjZW50cm9pZERpbWVuc2lvbih0b3VjaEhpc3RvcnksIHRvdWNoZXNDaGFuZ2VkQWZ0ZXIsIGlzWEF4aXMsIG9mQ3VycmVudCkgewogICAgICAgICAgdmFyIHRvdWNoQmFuayA9IHRvdWNoSGlzdG9yeS50b3VjaEJhbms7CiAgICAgICAgICB2YXIgdG90YWwgPSAwOwogICAgICAgICAgdmFyIGNvdW50ID0gMDsKICAgICAgICAgIHZhciBvbmVUb3VjaERhdGEgPSB0b3VjaEhpc3RvcnkubnVtYmVyQWN0aXZlVG91Y2hlcyA9PT0gMSA/IHRvdWNoSGlzdG9yeS50b3VjaEJhbmtbdG91Y2hIaXN0b3J5LmluZGV4T2ZTaW5nbGVBY3RpdmVUb3VjaF0gOiBudWxsOwoKICAgICAgICAgIGlmIChvbmVUb3VjaERhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG9uZVRvdWNoRGF0YS50b3VjaEFjdGl2ZSAmJiBvbmVUb3VjaERhdGEuY3VycmVudFRpbWVTdGFtcCA+IHRvdWNoZXNDaGFuZ2VkQWZ0ZXIpIHsKICAgICAgICAgICAgICB0b3RhbCArPSBvZkN1cnJlbnQgJiYgaXNYQXhpcyA/IG9uZVRvdWNoRGF0YS5jdXJyZW50UGFnZVggOiBvZkN1cnJlbnQgJiYgIWlzWEF4aXMgPyBvbmVUb3VjaERhdGEuY3VycmVudFBhZ2VZIDogIW9mQ3VycmVudCAmJiBpc1hBeGlzID8gb25lVG91Y2hEYXRhLnByZXZpb3VzUGFnZVggOiBvbmVUb3VjaERhdGEucHJldmlvdXNQYWdlWTsKICAgICAgICAgICAgICBjb3VudCA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdG91Y2hCYW5rLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHRvdWNoVHJhY2sgPSB0b3VjaEJhbmtbaV07CgogICAgICAgICAgICAgIGlmICh0b3VjaFRyYWNrICE9PSBudWxsICYmIHRvdWNoVHJhY2sgIT09IHVuZGVmaW5lZCAmJiB0b3VjaFRyYWNrLnRvdWNoQWN0aXZlICYmIHRvdWNoVHJhY2suY3VycmVudFRpbWVTdGFtcCA+PSB0b3VjaGVzQ2hhbmdlZEFmdGVyKSB7CiAgICAgICAgICAgICAgICB2YXIgdG9BZGQ7CgogICAgICAgICAgICAgICAgaWYgKG9mQ3VycmVudCAmJiBpc1hBeGlzKSB7CiAgICAgICAgICAgICAgICAgIHRvQWRkID0gdG91Y2hUcmFjay5jdXJyZW50UGFnZVg7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9mQ3VycmVudCAmJiAhaXNYQXhpcykgewogICAgICAgICAgICAgICAgICB0b0FkZCA9IHRvdWNoVHJhY2suY3VycmVudFBhZ2VZOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghb2ZDdXJyZW50ICYmIGlzWEF4aXMpIHsKICAgICAgICAgICAgICAgICAgdG9BZGQgPSB0b3VjaFRyYWNrLnByZXZpb3VzUGFnZVg7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0b0FkZCA9IHRvdWNoVHJhY2sucHJldmlvdXNQYWdlWTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0b3RhbCArPSB0b0FkZDsKICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGNvdW50ID4gMCA/IHRvdGFsIC8gY291bnQgOiBUb3VjaEhpc3RvcnlNYXRoLm5vQ2VudHJvaWQ7CiAgICAgICAgfSwKICAgICAgICBjdXJyZW50Q2VudHJvaWRYT2ZUb3VjaGVzQ2hhbmdlZEFmdGVyOiBmdW5jdGlvbiBjdXJyZW50Q2VudHJvaWRYT2ZUb3VjaGVzQ2hhbmdlZEFmdGVyKHRvdWNoSGlzdG9yeSwgdG91Y2hlc0NoYW5nZWRBZnRlcikgewogICAgICAgICAgcmV0dXJuIFRvdWNoSGlzdG9yeU1hdGguY2VudHJvaWREaW1lbnNpb24odG91Y2hIaXN0b3J5LCB0b3VjaGVzQ2hhbmdlZEFmdGVyLCB0cnVlLCB0cnVlKTsKICAgICAgICB9LAogICAgICAgIGN1cnJlbnRDZW50cm9pZFlPZlRvdWNoZXNDaGFuZ2VkQWZ0ZXI6IGZ1bmN0aW9uIGN1cnJlbnRDZW50cm9pZFlPZlRvdWNoZXNDaGFuZ2VkQWZ0ZXIodG91Y2hIaXN0b3J5LCB0b3VjaGVzQ2hhbmdlZEFmdGVyKSB7CiAgICAgICAgICByZXR1cm4gVG91Y2hIaXN0b3J5TWF0aC5jZW50cm9pZERpbWVuc2lvbih0b3VjaEhpc3RvcnksIHRvdWNoZXNDaGFuZ2VkQWZ0ZXIsIGZhbHNlLCB0cnVlKTsKICAgICAgICB9LAogICAgICAgIHByZXZpb3VzQ2VudHJvaWRYT2ZUb3VjaGVzQ2hhbmdlZEFmdGVyOiBmdW5jdGlvbiBwcmV2aW91c0NlbnRyb2lkWE9mVG91Y2hlc0NoYW5nZWRBZnRlcih0b3VjaEhpc3RvcnksIHRvdWNoZXNDaGFuZ2VkQWZ0ZXIpIHsKICAgICAgICAgIHJldHVybiBUb3VjaEhpc3RvcnlNYXRoLmNlbnRyb2lkRGltZW5zaW9uKHRvdWNoSGlzdG9yeSwgdG91Y2hlc0NoYW5nZWRBZnRlciwgdHJ1ZSwgZmFsc2UpOwogICAgICAgIH0sCiAgICAgICAgcHJldmlvdXNDZW50cm9pZFlPZlRvdWNoZXNDaGFuZ2VkQWZ0ZXI6IGZ1bmN0aW9uIHByZXZpb3VzQ2VudHJvaWRZT2ZUb3VjaGVzQ2hhbmdlZEFmdGVyKHRvdWNoSGlzdG9yeSwgdG91Y2hlc0NoYW5nZWRBZnRlcikgewogICAgICAgICAgcmV0dXJuIFRvdWNoSGlzdG9yeU1hdGguY2VudHJvaWREaW1lbnNpb24odG91Y2hIaXN0b3J5LCB0b3VjaGVzQ2hhbmdlZEFmdGVyLCBmYWxzZSwgZmFsc2UpOwogICAgICAgIH0sCiAgICAgICAgY3VycmVudENlbnRyb2lkWDogZnVuY3Rpb24gY3VycmVudENlbnRyb2lkWCh0b3VjaEhpc3RvcnkpIHsKICAgICAgICAgIHJldHVybiBUb3VjaEhpc3RvcnlNYXRoLmNlbnRyb2lkRGltZW5zaW9uKHRvdWNoSGlzdG9yeSwgMCwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgfSwKICAgICAgICBjdXJyZW50Q2VudHJvaWRZOiBmdW5jdGlvbiBjdXJyZW50Q2VudHJvaWRZKHRvdWNoSGlzdG9yeSkgewogICAgICAgICAgcmV0dXJuIFRvdWNoSGlzdG9yeU1hdGguY2VudHJvaWREaW1lbnNpb24odG91Y2hIaXN0b3J5LCAwLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgfSwKICAgICAgICBub0NlbnRyb2lkOiAtMQogICAgICB9OwogICAgICB2YXIgUmVhY3RJbnRlcm5hbHMgPSBSZWFjdC5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRDsKICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gUmVhY3RJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgdmFyIFJlYWN0R2xvYmFsU2hhcmVkU3RhdGUgPSBPYmplY3QuZnJlZXplKHsKICAgICAgICBSZWFjdEN1cnJlbnRPd25lcjogUmVhY3RDdXJyZW50T3duZXIsCiAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTogUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZQogICAgICB9KTsKICAgICAgdmFyIFJlYWN0VmVyc2lvbiA9ICIxNi4yLjAiOwoKICAgICAgZnVuY3Rpb24gc2hvd0RpYWxvZyQxKGNhcHR1cmVkRXJyb3IpIHsKICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSBjYXB0dXJlZEVycm9yLmNvbXBvbmVudFN0YWNrLAogICAgICAgICAgICBlcnJvciA9IGNhcHR1cmVkRXJyb3IuZXJyb3I7CiAgICAgICAgdmFyIGVycm9yVG9IYW5kbGUgPSB2b2lkIDA7CgogICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICB2YXIgbWVzc2FnZSA9IGVycm9yLm1lc3NhZ2UsCiAgICAgICAgICAgICAgbmFtZSA9IGVycm9yLm5hbWU7CiAgICAgICAgICB2YXIgc3VtbWFyeSA9IG1lc3NhZ2UgPyBuYW1lICsgIjogIiArIG1lc3NhZ2UgOiBuYW1lOwogICAgICAgICAgZXJyb3JUb0hhbmRsZSA9IGVycm9yOwoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGVycm9yVG9IYW5kbGUubWVzc2FnZSA9IHN1bW1hcnkgKyAiXG5cblRoaXMgZXJyb3IgaXMgbG9jYXRlZCBhdDoiICsgY29tcG9uZW50U3RhY2s7CiAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVycm9yID09PSAic3RyaW5nIikgewogICAgICAgICAgZXJyb3JUb0hhbmRsZSA9IG5ldyBFcnJvcihlcnJvciArICJcblxuVGhpcyBlcnJvciBpcyBsb2NhdGVkIGF0OiIgKyBjb21wb25lbnRTdGFjayk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVycm9yVG9IYW5kbGUgPSBuZXcgRXJyb3IoIlVuc3BlY2lmaWVkIGVycm9yIGF0OiIgKyBjb21wb25lbnRTdGFjayk7CiAgICAgICAgfQoKICAgICAgICBFeGNlcHRpb25zTWFuYWdlci5oYW5kbGVFeGNlcHRpb24oZXJyb3JUb0hhbmRsZSwgZmFsc2UpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgewogICAgICAgIGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBvYmplY3RzID0ge307CiAgICAgIHZhciB1bmlxdWVJRCA9IDE7CiAgICAgIHZhciBlbXB0eU9iamVjdCQyID0ge307CgogICAgICB2YXIgUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnkoKSB7CiAgICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnkpOwogICAgICAgIH0KCiAgICAgICAgUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnkucmVnaXN0ZXIgPSBmdW5jdGlvbiByZWdpc3RlcihvYmplY3QpIHsKICAgICAgICAgIHZhciBpZCA9ICsrdW5pcXVlSUQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIE9iamVjdC5mcmVlemUob2JqZWN0KTsKICAgICAgICAgIH0KICAgICAgICAgIG9iamVjdHNbaWRdID0gb2JqZWN0OwogICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgIH07CgogICAgICAgIFJlYWN0TmF0aXZlUHJvcFJlZ2lzdHJ5LmdldEJ5SUQgPSBmdW5jdGlvbiBnZXRCeUlEKGlkKSB7CiAgICAgICAgICBpZiAoIWlkKSB7CiAgICAgICAgICAgIHJldHVybiBlbXB0eU9iamVjdCQyOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBvYmplY3QgPSBvYmplY3RzW2lkXTsKCiAgICAgICAgICBpZiAoIW9iamVjdCkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIkludmFsaWQgc3R5bGUgd2l0aCBpZCBgIiArIGlkICsgImAuIFNraXBwaW5nIC4uLiIpOwogICAgICAgICAgICByZXR1cm4gZW1wdHlPYmplY3QkMjsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIH07CgogICAgICAgIHJldHVybiBSZWFjdE5hdGl2ZVByb3BSZWdpc3RyeTsKICAgICAgfSgpOwoKICAgICAgdmFyIGVtcHR5T2JqZWN0JDEgPSB7fTsKICAgICAgdmFyIHJlbW92ZWRLZXlzID0gbnVsbDsKICAgICAgdmFyIHJlbW92ZWRLZXlDb3VudCA9IDA7CgogICAgICBmdW5jdGlvbiBkZWZhdWx0RGlmZmVyKHByZXZQcm9wLCBuZXh0UHJvcCkgewogICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgIT09ICJvYmplY3QiIHx8IG5leHRQcm9wID09PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGRlZXBEaWZmZXIocHJldlByb3AsIG5leHRQcm9wKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHJlc29sdmVPYmplY3QoaWRPck9iamVjdCkgewogICAgICAgIGlmICh0eXBlb2YgaWRPck9iamVjdCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgIHJldHVybiBSZWFjdE5hdGl2ZVByb3BSZWdpc3RyeS5nZXRCeUlEKGlkT3JPYmplY3QpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGlkT3JPYmplY3Q7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHJlc3RvcmVEZWxldGVkVmFsdWVzSW5OZXN0ZWRBcnJheSh1cGRhdGVQYXlsb2FkLCBub2RlLCB2YWxpZEF0dHJpYnV0ZXMpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShub2RlKSkgewogICAgICAgICAgdmFyIGkgPSBub2RlLmxlbmd0aDsKCiAgICAgICAgICB3aGlsZSAoaS0tICYmIHJlbW92ZWRLZXlDb3VudCA+IDApIHsKICAgICAgICAgICAgcmVzdG9yZURlbGV0ZWRWYWx1ZXNJbk5lc3RlZEFycmF5KHVwZGF0ZVBheWxvYWQsIG5vZGVbaV0sIHZhbGlkQXR0cmlidXRlcyk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChub2RlICYmIHJlbW92ZWRLZXlDb3VudCA+IDApIHsKICAgICAgICAgIHZhciBvYmogPSByZXNvbHZlT2JqZWN0KG5vZGUpOwoKICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gcmVtb3ZlZEtleXMpIHsKICAgICAgICAgICAgaWYgKCFyZW1vdmVkS2V5c1twcm9wS2V5XSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBvYmpbcHJvcEtleV07CgogICAgICAgICAgICBpZiAobmV4dFByb3AgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgYXR0cmlidXRlQ29uZmlnID0gdmFsaWRBdHRyaWJ1dGVzW3Byb3BLZXldOwoKICAgICAgICAgICAgaWYgKCFhdHRyaWJ1dGVDb25maWcpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIG5leHRQcm9wID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBuZXh0UHJvcCA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlQ29uZmlnICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWRbcHJvcEtleV0gPSBuZXh0UHJvcDsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXR0cmlidXRlQ29uZmlnLmRpZmYgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGF0dHJpYnV0ZUNvbmZpZy5wcm9jZXNzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IHR5cGVvZiBhdHRyaWJ1dGVDb25maWcucHJvY2VzcyA9PT0gImZ1bmN0aW9uIiA/IGF0dHJpYnV0ZUNvbmZpZy5wcm9jZXNzKG5leHRQcm9wKSA6IG5leHRQcm9wOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWRbcHJvcEtleV0gPSBuZXh0VmFsdWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlbW92ZWRLZXlzW3Byb3BLZXldID0gZmFsc2U7CiAgICAgICAgICAgIHJlbW92ZWRLZXlDb3VudC0tOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gZGlmZk5lc3RlZEFycmF5UHJvcGVydHkodXBkYXRlUGF5bG9hZCwgcHJldkFycmF5LCBuZXh0QXJyYXksIHZhbGlkQXR0cmlidXRlcykgewogICAgICAgIHZhciBtaW5MZW5ndGggPSBwcmV2QXJyYXkubGVuZ3RoIDwgbmV4dEFycmF5Lmxlbmd0aCA/IHByZXZBcnJheS5sZW5ndGggOiBuZXh0QXJyYXkubGVuZ3RoOwogICAgICAgIHZhciBpOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbWluTGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBkaWZmTmVzdGVkUHJvcGVydHkodXBkYXRlUGF5bG9hZCwgcHJldkFycmF5W2ldLCBuZXh0QXJyYXlbaV0sIHZhbGlkQXR0cmlidXRlcyk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKDsgaSA8IHByZXZBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IGNsZWFyTmVzdGVkUHJvcGVydHkodXBkYXRlUGF5bG9hZCwgcHJldkFycmF5W2ldLCB2YWxpZEF0dHJpYnV0ZXMpOwogICAgICAgIH0KCiAgICAgICAgZm9yICg7IGkgPCBuZXh0QXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBhZGROZXN0ZWRQcm9wZXJ0eSh1cGRhdGVQYXlsb2FkLCBuZXh0QXJyYXlbaV0sIHZhbGlkQXR0cmlidXRlcyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZGlmZk5lc3RlZFByb3BlcnR5KHVwZGF0ZVBheWxvYWQsIHByZXZQcm9wLCBuZXh0UHJvcCwgdmFsaWRBdHRyaWJ1dGVzKSB7CiAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkICYmIHByZXZQcm9wID09PSBuZXh0UHJvcCkgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXByZXZQcm9wIHx8ICFuZXh0UHJvcCkgewogICAgICAgICAgaWYgKG5leHRQcm9wKSB7CiAgICAgICAgICAgIHJldHVybiBhZGROZXN0ZWRQcm9wZXJ0eSh1cGRhdGVQYXlsb2FkLCBuZXh0UHJvcCwgdmFsaWRBdHRyaWJ1dGVzKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAocHJldlByb3ApIHsKICAgICAgICAgICAgcmV0dXJuIGNsZWFyTmVzdGVkUHJvcGVydHkodXBkYXRlUGF5bG9hZCwgcHJldlByb3AsIHZhbGlkQXR0cmlidXRlcyk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocHJldlByb3ApICYmICFBcnJheS5pc0FycmF5KG5leHRQcm9wKSkgewogICAgICAgICAgcmV0dXJuIGRpZmZQcm9wZXJ0aWVzKHVwZGF0ZVBheWxvYWQsIHJlc29sdmVPYmplY3QocHJldlByb3ApLCByZXNvbHZlT2JqZWN0KG5leHRQcm9wKSwgdmFsaWRBdHRyaWJ1dGVzKTsKICAgICAgICB9CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHByZXZQcm9wKSAmJiBBcnJheS5pc0FycmF5KG5leHRQcm9wKSkgewogICAgICAgICAgcmV0dXJuIGRpZmZOZXN0ZWRBcnJheVByb3BlcnR5KHVwZGF0ZVBheWxvYWQsIHByZXZQcm9wLCBuZXh0UHJvcCwgdmFsaWRBdHRyaWJ1dGVzKTsKICAgICAgICB9CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHByZXZQcm9wKSkgewogICAgICAgICAgcmV0dXJuIGRpZmZQcm9wZXJ0aWVzKHVwZGF0ZVBheWxvYWQsIGZsYXR0ZW5TdHlsZShwcmV2UHJvcCksIHJlc29sdmVPYmplY3QobmV4dFByb3ApLCB2YWxpZEF0dHJpYnV0ZXMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRpZmZQcm9wZXJ0aWVzKHVwZGF0ZVBheWxvYWQsIHJlc29sdmVPYmplY3QocHJldlByb3ApLCBmbGF0dGVuU3R5bGUobmV4dFByb3ApLCB2YWxpZEF0dHJpYnV0ZXMpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBhZGROZXN0ZWRQcm9wZXJ0eSh1cGRhdGVQYXlsb2FkLCBuZXh0UHJvcCwgdmFsaWRBdHRyaWJ1dGVzKSB7CiAgICAgICAgaWYgKCFuZXh0UHJvcCkgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobmV4dFByb3ApKSB7CiAgICAgICAgICByZXR1cm4gYWRkUHJvcGVydGllcyh1cGRhdGVQYXlsb2FkLCByZXNvbHZlT2JqZWN0KG5leHRQcm9wKSwgdmFsaWRBdHRyaWJ1dGVzKTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV4dFByb3AubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBhZGROZXN0ZWRQcm9wZXJ0eSh1cGRhdGVQYXlsb2FkLCBuZXh0UHJvcFtpXSwgdmFsaWRBdHRyaWJ1dGVzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB1cGRhdGVQYXlsb2FkOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjbGVhck5lc3RlZFByb3BlcnR5KHVwZGF0ZVBheWxvYWQsIHByZXZQcm9wLCB2YWxpZEF0dHJpYnV0ZXMpIHsKICAgICAgICBpZiAoIXByZXZQcm9wKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICAgICAgICB9CgogICAgICAgIGlmICghQXJyYXkuaXNBcnJheShwcmV2UHJvcCkpIHsKICAgICAgICAgIHJldHVybiBjbGVhclByb3BlcnRpZXModXBkYXRlUGF5bG9hZCwgcmVzb2x2ZU9iamVjdChwcmV2UHJvcCksIHZhbGlkQXR0cmlidXRlcyk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByZXZQcm9wLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gY2xlYXJOZXN0ZWRQcm9wZXJ0eSh1cGRhdGVQYXlsb2FkLCBwcmV2UHJvcFtpXSwgdmFsaWRBdHRyaWJ1dGVzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB1cGRhdGVQYXlsb2FkOwogICAgICB9CgogICAgICBmdW5jdGlvbiBkaWZmUHJvcGVydGllcyh1cGRhdGVQYXlsb2FkLCBwcmV2UHJvcHMsIG5leHRQcm9wcywgdmFsaWRBdHRyaWJ1dGVzKSB7CiAgICAgICAgdmFyIGF0dHJpYnV0ZUNvbmZpZzsKICAgICAgICB2YXIgbmV4dFByb3A7CiAgICAgICAgdmFyIHByZXZQcm9wOwoKICAgICAgICBmb3IgKHZhciBwcm9wS2V5IGluIG5leHRQcm9wcykgewogICAgICAgICAgYXR0cmlidXRlQ29uZmlnID0gdmFsaWRBdHRyaWJ1dGVzW3Byb3BLZXldOwoKICAgICAgICAgIGlmICghYXR0cmlidXRlQ29uZmlnKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIHByZXZQcm9wID0gcHJldlByb3BzW3Byb3BLZXldOwogICAgICAgICAgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CgogICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBuZXh0UHJvcCA9IHRydWU7CgogICAgICAgICAgICBpZiAodHlwZW9mIHByZXZQcm9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcHJldlByb3AgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgbmV4dFByb3AgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBwcmV2UHJvcCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBwcmV2UHJvcCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAocmVtb3ZlZEtleXMpIHsKICAgICAgICAgICAgcmVtb3ZlZEtleXNbcHJvcEtleV0gPSBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodXBkYXRlUGF5bG9hZCAmJiB1cGRhdGVQYXlsb2FkW3Byb3BLZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGVDb25maWcgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZFtwcm9wS2V5XSA9IG5leHRQcm9wOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhdHRyaWJ1dGVDb25maWcuZGlmZiA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgYXR0cmlidXRlQ29uZmlnLnByb2Nlc3MgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gdHlwZW9mIGF0dHJpYnV0ZUNvbmZpZy5wcm9jZXNzID09PSAiZnVuY3Rpb24iID8gYXR0cmlidXRlQ29uZmlnLnByb2Nlc3MobmV4dFByb3ApIDogbmV4dFByb3A7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZFtwcm9wS2V5XSA9IG5leHRWYWx1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHByZXZQcm9wID09PSBuZXh0UHJvcCkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZUNvbmZpZyAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgaWYgKGRlZmF1bHREaWZmZXIocHJldlByb3AsIG5leHRQcm9wKSkgewogICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkIHx8ICh1cGRhdGVQYXlsb2FkID0ge30pKVtwcm9wS2V5XSA9IG5leHRQcm9wOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhdHRyaWJ1dGVDb25maWcuZGlmZiA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgYXR0cmlidXRlQ29uZmlnLnByb2Nlc3MgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IHByZXZQcm9wID09PSB1bmRlZmluZWQgfHwgKHR5cGVvZiBhdHRyaWJ1dGVDb25maWcuZGlmZiA9PT0gImZ1bmN0aW9uIiA/IGF0dHJpYnV0ZUNvbmZpZy5kaWZmKHByZXZQcm9wLCBuZXh0UHJvcCkgOiBkZWZhdWx0RGlmZmVyKHByZXZQcm9wLCBuZXh0UHJvcCkpOwoKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgIG5leHRWYWx1ZSA9IHR5cGVvZiBhdHRyaWJ1dGVDb25maWcucHJvY2VzcyA9PT0gImZ1bmN0aW9uIiA/IGF0dHJpYnV0ZUNvbmZpZy5wcm9jZXNzKG5leHRQcm9wKSA6IG5leHRQcm9wOwogICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkIHx8ICh1cGRhdGVQYXlsb2FkID0ge30pKVtwcm9wS2V5XSA9IG5leHRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVtb3ZlZEtleXMgPSBudWxsOwogICAgICAgICAgICByZW1vdmVkS2V5Q291bnQgPSAwOwogICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gZGlmZk5lc3RlZFByb3BlcnR5KHVwZGF0ZVBheWxvYWQsIHByZXZQcm9wLCBuZXh0UHJvcCwgYXR0cmlidXRlQ29uZmlnKTsKCiAgICAgICAgICAgIGlmIChyZW1vdmVkS2V5Q291bnQgPiAwICYmIHVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICByZXN0b3JlRGVsZXRlZFZhbHVlc0luTmVzdGVkQXJyYXkodXBkYXRlUGF5bG9hZCwgbmV4dFByb3AsIGF0dHJpYnV0ZUNvbmZpZyk7CiAgICAgICAgICAgICAgcmVtb3ZlZEtleXMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgKHByb3BLZXkgaW4gcHJldlByb3BzKSB7CiAgICAgICAgICBpZiAobmV4dFByb3BzW3Byb3BLZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgYXR0cmlidXRlQ29uZmlnID0gdmFsaWRBdHRyaWJ1dGVzW3Byb3BLZXldOwoKICAgICAgICAgIGlmICghYXR0cmlidXRlQ29uZmlnKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkICYmIHVwZGF0ZVBheWxvYWRbcHJvcEtleV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBwcmV2UHJvcCA9IHByZXZQcm9wc1twcm9wS2V5XTsKCiAgICAgICAgICBpZiAocHJldlByb3AgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZUNvbmZpZyAhPT0gIm9iamVjdCIgfHwgdHlwZW9mIGF0dHJpYnV0ZUNvbmZpZy5kaWZmID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBhdHRyaWJ1dGVDb25maWcucHJvY2VzcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAodXBkYXRlUGF5bG9hZCB8fCAodXBkYXRlUGF5bG9hZCA9IHt9KSlbcHJvcEtleV0gPSBudWxsOwoKICAgICAgICAgICAgaWYgKCFyZW1vdmVkS2V5cykgewogICAgICAgICAgICAgIHJlbW92ZWRLZXlzID0ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghcmVtb3ZlZEtleXNbcHJvcEtleV0pIHsKICAgICAgICAgICAgICByZW1vdmVkS2V5c1twcm9wS2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgcmVtb3ZlZEtleUNvdW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBjbGVhck5lc3RlZFByb3BlcnR5KHVwZGF0ZVBheWxvYWQsIHByZXZQcm9wLCBhdHRyaWJ1dGVDb25maWcpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFkZFByb3BlcnRpZXModXBkYXRlUGF5bG9hZCwgcHJvcHMsIHZhbGlkQXR0cmlidXRlcykgewogICAgICAgIHJldHVybiBkaWZmUHJvcGVydGllcyh1cGRhdGVQYXlsb2FkLCBlbXB0eU9iamVjdCQxLCBwcm9wcywgdmFsaWRBdHRyaWJ1dGVzKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY2xlYXJQcm9wZXJ0aWVzKHVwZGF0ZVBheWxvYWQsIHByZXZQcm9wcywgdmFsaWRBdHRyaWJ1dGVzKSB7CiAgICAgICAgcmV0dXJuIGRpZmZQcm9wZXJ0aWVzKHVwZGF0ZVBheWxvYWQsIHByZXZQcm9wcywgZW1wdHlPYmplY3QkMSwgdmFsaWRBdHRyaWJ1dGVzKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY3JlYXRlKHByb3BzLCB2YWxpZEF0dHJpYnV0ZXMpIHsKICAgICAgICByZXR1cm4gYWRkUHJvcGVydGllcyhudWxsLCBwcm9wcywgdmFsaWRBdHRyaWJ1dGVzKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZGlmZihwcmV2UHJvcHMsIG5leHRQcm9wcywgdmFsaWRBdHRyaWJ1dGVzKSB7CiAgICAgICAgcmV0dXJuIGRpZmZQcm9wZXJ0aWVzKG51bGwsIHByZXZQcm9wcywgbmV4dFByb3BzLCB2YWxpZEF0dHJpYnV0ZXMpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBtb3VudFNhZmVDYWxsYmFjayhjb250ZXh0LCBjYWxsYmFjaykgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0Ll9faXNNb3VudGVkID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgaWYgKCFjb250ZXh0Ll9faXNNb3VudGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dC5pc01vdW50ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaWYgKCFjb250ZXh0LmlzTW91bnRlZCgpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHRocm93T25TdHlsZXNQcm9wKGNvbXBvbmVudCwgcHJvcHMpIHsKICAgICAgICBpZiAocHJvcHMuc3R5bGVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciBvd25lciA9IGNvbXBvbmVudC5fb3duZXIgfHwgbnVsbDsKICAgICAgICAgIHZhciBuYW1lID0gY29tcG9uZW50LmNvbnN0cnVjdG9yLmRpc3BsYXlOYW1lOwogICAgICAgICAgdmFyIG1zZyA9ICJgc3R5bGVzYCBpcyBub3QgYSBzdXBwb3J0ZWQgcHJvcGVydHkgb2YgYCIgKyBuYW1lICsgImAsIGRpZCAiICsgInlvdSBtZWFuIGBzdHlsZWAgKHNpbmd1bGFyKT8iOwoKICAgICAgICAgIGlmIChvd25lciAmJiBvd25lci5jb25zdHJ1Y3RvciAmJiBvd25lci5jb25zdHJ1Y3Rvci5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICBtc2cgKz0gIlxuXG5DaGVjayB0aGUgYCIgKyBvd25lci5jb25zdHJ1Y3Rvci5kaXNwbGF5TmFtZSArICJgIHBhcmVudCAiICsgIiBjb21wb25lbnQuIjsKICAgICAgICAgIH0KCiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JTdHlsZVByb3BzKHByb3BzLCB2YWxpZEF0dHJpYnV0ZXMpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdmFsaWRBdHRyaWJ1dGVzLnN0eWxlKSB7CiAgICAgICAgICBpZiAoISh2YWxpZEF0dHJpYnV0ZXNba2V5XSB8fCBwcm9wc1trZXldID09PSB1bmRlZmluZWQpKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIllvdSBhcmUgc2V0dGluZyB0aGUgc3R5bGUgYHsgIiArIGtleSArICI6IC4uLiB9YCBhcyBhIHByb3AuIFlvdSAiICsgInNob3VsZCBuZXN0IGl0IGluIGEgc3R5bGUgb2JqZWN0LiAiICsgIkUuZy4gYHsgc3R5bGU6IHsgIiArIGtleSArICI6IC4uLiB9IH1gIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXQoa2V5KSB7CiAgICAgICAgcmV0dXJuIGtleS5fcmVhY3RJbnRlcm5hbEZpYmVyOwogICAgICB9CgogICAgICBmdW5jdGlvbiBzZXQoa2V5LCB2YWx1ZSkgewogICAgICAgIGtleS5fcmVhY3RJbnRlcm5hbEZpYmVyID0gdmFsdWU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWUoZmliZXIpIHsKICAgICAgICB2YXIgdHlwZSA9IGZpYmVyLnR5cGU7CgogICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxNV0sICJSZWFjdEZlYXR1cmVGbGFncyIpOwoKICAgICAgdmFyIGRlYnVnUmVuZGVyUGhhc2VTaWRlRWZmZWN0cyA9IF9yZXF1aXJlLmRlYnVnUmVuZGVyUGhhc2VTaWRlRWZmZWN0czsKICAgICAgdmFyIGVuYWJsZUFzeW5jU3VidHJlZUFQSSA9IHRydWU7CiAgICAgIHZhciBlbmFibGVVc2VyVGltaW5nQVBJID0gdHJ1ZTsKICAgICAgdmFyIGVuYWJsZU11dGF0aW5nUmVjb25jaWxlciA9IHRydWU7CiAgICAgIHZhciBlbmFibGVOb29wUmVjb25jaWxlciA9IGZhbHNlOwogICAgICB2YXIgZW5hYmxlUGVyc2lzdGVudFJlY29uY2lsZXIgPSBmYWxzZTsKICAgICAgdmFyIE5vRWZmZWN0ID0gMDsKICAgICAgdmFyIFBlcmZvcm1lZFdvcmsgPSAxOwogICAgICB2YXIgUGxhY2VtZW50ID0gMjsKICAgICAgdmFyIFVwZGF0ZSA9IDQ7CiAgICAgIHZhciBQbGFjZW1lbnRBbmRVcGRhdGUgPSA2OwogICAgICB2YXIgRGVsZXRpb24gPSA4OwogICAgICB2YXIgQ29udGVudFJlc2V0ID0gMTY7CiAgICAgIHZhciBDYWxsYmFjayA9IDMyOwogICAgICB2YXIgRXJyID0gNjQ7CiAgICAgIHZhciBSZWYgPSAxMjg7CiAgICAgIHZhciBNT1VOVElORyA9IDE7CiAgICAgIHZhciBNT1VOVEVEID0gMjsKICAgICAgdmFyIFVOTU9VTlRFRCA9IDM7CgogICAgICBmdW5jdGlvbiBpc0ZpYmVyTW91bnRlZEltcGwoZmliZXIpIHsKICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwoKICAgICAgICBpZiAoIWZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgaWYgKChub2RlLmVmZmVjdFRhZyAmIFBsYWNlbWVudCkgIT09IE5vRWZmZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBNT1VOVElORzsKICAgICAgICAgIH0KCiAgICAgICAgICB3aGlsZSAobm9kZVsicmV0dXJuIl0pIHsKICAgICAgICAgICAgbm9kZSA9IG5vZGVbInJldHVybiJdOwoKICAgICAgICAgICAgaWYgKChub2RlLmVmZmVjdFRhZyAmIFBsYWNlbWVudCkgIT09IE5vRWZmZWN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIE1PVU5USU5HOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdoaWxlIChub2RlWyJyZXR1cm4iXSkgewogICAgICAgICAgICBub2RlID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICByZXR1cm4gTU9VTlRFRDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBVTk1PVU5URUQ7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGlzRmliZXJNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgcmV0dXJuIGlzRmliZXJNb3VudGVkSW1wbChmaWJlcikgPT09IE1PVU5URUQ7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGlzTW91bnRlZChjb21wb25lbnQpIHsKICAgICAgICB7CiAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50OwoKICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHZhciBvd25lckZpYmVyID0gb3duZXI7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG93bmVyRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICB3YXJuaW5nKGluc3RhbmNlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlciwgIiVzIGlzIGFjY2Vzc2luZyBpc01vdW50ZWQgaW5zaWRlIGl0cyByZW5kZXIoKSBmdW5jdGlvbi4gIiArICJyZW5kZXIoKSBzaG91bGQgYmUgYSBwdXJlIGZ1bmN0aW9uIG9mIHByb3BzIGFuZCBzdGF0ZS4gSXQgc2hvdWxkICIgKyAibmV2ZXIgYWNjZXNzIHNvbWV0aGluZyB0aGF0IHJlcXVpcmVzIHN0YWxlIGRhdGEgZnJvbSB0aGUgcHJldmlvdXMgIiArICJyZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCAiICsgImNvbXBvbmVudERpZFVwZGF0ZSBpbnN0ZWFkLiIsIGdldENvbXBvbmVudE5hbWUob3duZXJGaWJlcikgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgIGluc3RhbmNlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlciA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmaWJlciA9IGdldChjb21wb25lbnQpOwoKICAgICAgICBpZiAoIWZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNGaWJlck1vdW50ZWRJbXBsKGZpYmVyKSA9PT0gTU9VTlRFRDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gYXNzZXJ0SXNNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgaW52YXJpYW50KGlzRmliZXJNb3VudGVkSW1wbChmaWJlcikgPT09IE1PVU5URUQsICJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKGZpYmVyKSB7CiAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKCiAgICAgICAgaWYgKCFhbHRlcm5hdGUpIHsKICAgICAgICAgIHZhciBzdGF0ZSA9IGlzRmliZXJNb3VudGVkSW1wbChmaWJlcik7CiAgICAgICAgICBpbnZhcmlhbnQoc3RhdGUgIT09IFVOTU9VTlRFRCwgIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKCiAgICAgICAgICBpZiAoc3RhdGUgPT09IE1PVU5USU5HKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CgogICAgICAgIHZhciBhID0gZmliZXI7CiAgICAgICAgdmFyIGIgPSBhbHRlcm5hdGU7CgogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICB2YXIgcGFyZW50QSA9IGFbInJldHVybiJdOwogICAgICAgICAgdmFyIHBhcmVudEIgPSBwYXJlbnRBID8gcGFyZW50QS5hbHRlcm5hdGUgOiBudWxsOwoKICAgICAgICAgIGlmICghcGFyZW50QSB8fCAhcGFyZW50QikgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAocGFyZW50QS5jaGlsZCA9PT0gcGFyZW50Qi5jaGlsZCkgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwoKICAgICAgICAgICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICBhc3NlcnRJc01vdW50ZWQocGFyZW50QSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgIHJldHVybiBhbHRlcm5hdGU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoYVsicmV0dXJuIl0gIT09IGJbInJldHVybiJdKSB7CiAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBkaWRGaW5kQ2hpbGQgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIF9jaGlsZCA9IHBhcmVudEEuY2hpbGQ7CgogICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYSkgewogICAgICAgICAgICAgICAgZGlkRmluZENoaWxkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgYiA9IHBhcmVudEI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICBiID0gcGFyZW50QTsKICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBfY2hpbGQgPSBfY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICBfY2hpbGQgPSBwYXJlbnRCLmNoaWxkOwoKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICBiID0gcGFyZW50QTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYikgewogICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYSA9IHBhcmVudEE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaW52YXJpYW50KGRpZEZpbmRDaGlsZCwgIkNoaWxkIHdhcyBub3QgZm91bmQgaW4gZWl0aGVyIHBhcmVudCBzZXQuIFRoaXMgaW5kaWNhdGVzIGEgYnVnICIgKyAiaW4gUmVhY3QgcmVsYXRlZCB0byB0aGUgcmV0dXJuIHBvaW50ZXIuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaW52YXJpYW50KGEuYWx0ZXJuYXRlID09PSBiLCAiUmV0dXJuIGZpYmVycyBzaG91bGQgYWx3YXlzIGJlIGVhY2ggb3RoZXJzJyBhbHRlcm5hdGVzLiAiICsgIlRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgfQoKICAgICAgICBpbnZhcmlhbnQoYS50YWcgPT09IEhvc3RSb290LCAiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwoKICAgICAgICBpZiAoYS5zdGF0ZU5vZGUuY3VycmVudCA9PT0gYSkgewogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXIocGFyZW50KSB7CiAgICAgICAgdmFyIGN1cnJlbnRQYXJlbnQgPSBmaW5kQ3VycmVudEZpYmVyVXNpbmdTbG93UGF0aChwYXJlbnQpOwoKICAgICAgICBpZiAoIWN1cnJlbnRQYXJlbnQpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgdmFyIG5vZGUgPSBjdXJyZW50UGFyZW50OwoKICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCkgewogICAgICAgICAgICBub2RlLmNoaWxkWyJyZXR1cm4iXSA9IG5vZGU7CiAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAobm9kZSA9PT0gY3VycmVudFBhcmVudCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICB3aGlsZSAoIW5vZGUuc2libGluZykgewogICAgICAgICAgICBpZiAoIW5vZGVbInJldHVybiJdIHx8IG5vZGVbInJldHVybiJdID09PSBjdXJyZW50UGFyZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vZGUgPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICAgIH0KCiAgICAgICAgICBub2RlLnNpYmxpbmdbInJldHVybiJdID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhwYXJlbnQpIHsKICAgICAgICB2YXIgY3VycmVudFBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CgogICAgICAgIGlmICghY3VycmVudFBhcmVudCkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICB2YXIgbm9kZSA9IGN1cnJlbnRQYXJlbnQ7CgogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfSBlbHNlIGlmIChub2RlLmNoaWxkICYmIG5vZGUudGFnICE9PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgIG5vZGUuY2hpbGRbInJldHVybiJdID0gbm9kZTsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChub2RlID09PSBjdXJyZW50UGFyZW50KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIHdoaWxlICghbm9kZS5zaWJsaW5nKSB7CiAgICAgICAgICAgIGlmICghbm9kZVsicmV0dXJuIl0gfHwgbm9kZVsicmV0dXJuIl0gPT09IGN1cnJlbnRQYXJlbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbm9kZSA9IG5vZGVbInJldHVybiJdOwogICAgICAgICAgfQoKICAgICAgICAgIG5vZGUuc2libGluZ1sicmV0dXJuIl0gPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIHZhbHVlU3RhY2sgPSBbXTsKICAgICAgewogICAgICAgIHZhciBmaWJlclN0YWNrID0gW107CiAgICAgIH0KICAgICAgdmFyIGluZGV4ID0gLTE7CgogICAgICBmdW5jdGlvbiBjcmVhdGVDdXJzb3IoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGN1cnJlbnQ6IGRlZmF1bHRWYWx1ZQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHBvcChjdXJzb3IsIGZpYmVyKSB7CiAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAiVW5leHBlY3RlZCBwb3AuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB7CiAgICAgICAgICBpZiAoZmliZXIgIT09IGZpYmVyU3RhY2tbaW5kZXhdKSB7CiAgICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICJVbmV4cGVjdGVkIEZpYmVyIHBvcHBlZC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY3Vyc29yLmN1cnJlbnQgPSB2YWx1ZVN0YWNrW2luZGV4XTsKICAgICAgICB2YWx1ZVN0YWNrW2luZGV4XSA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgZmliZXJTdGFja1tpbmRleF0gPSBudWxsOwogICAgICAgIH0KICAgICAgICBpbmRleC0tOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwdXNoKGN1cnNvciwgdmFsdWUsIGZpYmVyKSB7CiAgICAgICAgaW5kZXgrKzsKICAgICAgICB2YWx1ZVN0YWNrW2luZGV4XSA9IGN1cnNvci5jdXJyZW50OwogICAgICAgIHsKICAgICAgICAgIGZpYmVyU3RhY2tbaW5kZXhdID0gZmliZXI7CiAgICAgICAgfQogICAgICAgIGN1cnNvci5jdXJyZW50ID0gdmFsdWU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgIHdoaWxlIChpbmRleCA+IC0xKSB7CiAgICAgICAgICB2YWx1ZVN0YWNrW2luZGV4XSA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyU3RhY2tbaW5kZXhdID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGluZGV4LS07CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgZGVzY3JpYmVDb21wb25lbnRGcmFtZSA9IGZ1bmN0aW9uIGRlc2NyaWJlQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lck5hbWUpIHsKICAgICAgICByZXR1cm4gIlxuICAgIGluICIgKyAobmFtZSB8fCAiVW5rbm93biIpICsgKHNvdXJjZSA/ICIgKGF0ICIgKyBzb3VyY2UuZmlsZU5hbWUucmVwbGFjZSgvXi4qW1xcXC9dLywgIiIpICsgIjoiICsgc291cmNlLmxpbmVOdW1iZXIgKyAiKSIgOiBvd25lck5hbWUgPyAiIChjcmVhdGVkIGJ5ICIgKyBvd25lck5hbWUgKyAiKSIgOiAiIik7CiAgICAgIH07CgogICAgICBmdW5jdGlvbiBkZXNjcmliZUZpYmVyKGZpYmVyKSB7CiAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgIGNhc2UgRnVuY3Rpb25hbENvbXBvbmVudDoKICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgIHZhciBvd25lciA9IGZpYmVyLl9kZWJ1Z093bmVyOwogICAgICAgICAgICB2YXIgc291cmNlID0gZmliZXIuX2RlYnVnU291cmNlOwogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWUoZmliZXIpOwogICAgICAgICAgICB2YXIgb3duZXJOYW1lID0gbnVsbDsKCiAgICAgICAgICAgIGlmIChvd25lcikgewogICAgICAgICAgICAgIG93bmVyTmFtZSA9IGdldENvbXBvbmVudE5hbWUob3duZXIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVDb21wb25lbnRGcmFtZShuYW1lLCBzb3VyY2UsIG93bmVyTmFtZSk7CgogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0U3RhY2tBZGRlbmR1bUJ5V29ya0luUHJvZ3Jlc3NGaWJlcih3b3JrSW5Qcm9ncmVzcykgewogICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgdmFyIG5vZGUgPSB3b3JrSW5Qcm9ncmVzczsKCiAgICAgICAgZG8gewogICAgICAgICAgaW5mbyArPSBkZXNjcmliZUZpYmVyKG5vZGUpOwogICAgICAgICAgbm9kZSA9IG5vZGVbInJldHVybiJdOwogICAgICAgIH0gd2hpbGUgKG5vZGUpOwoKICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lKCkgewogICAgICAgIHsKICAgICAgICAgIHZhciBmaWJlciA9IFJlYWN0RGVidWdDdXJyZW50RmliZXIuY3VycmVudDsKCiAgICAgICAgICBpZiAoZmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG93bmVyID0gZmliZXIuX2RlYnVnT3duZXI7CgogICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIHR5cGVvZiBvd25lciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWUob3duZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyU3RhY2tBZGRlbmR1bSgpIHsKICAgICAgICB7CiAgICAgICAgICB2YXIgZmliZXIgPSBSZWFjdERlYnVnQ3VycmVudEZpYmVyLmN1cnJlbnQ7CgogICAgICAgICAgaWYgKGZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBnZXRTdGFja0FkZGVuZHVtQnlXb3JrSW5Qcm9ncmVzc0ZpYmVyKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHJlc2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrID0gbnVsbDsKICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZpYmVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgIFJlYWN0RGVidWdDdXJyZW50RmliZXIucGhhc2UgPSBudWxsOwogICAgICB9CgogICAgICBmdW5jdGlvbiBzZXRDdXJyZW50RmliZXIoZmliZXIpIHsKICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IGdldEN1cnJlbnRGaWJlclN0YWNrQWRkZW5kdW07CiAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5jdXJyZW50ID0gZmliZXI7CiAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5waGFzZSA9IG51bGw7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRQaGFzZShwaGFzZSkgewogICAgICAgIFJlYWN0RGVidWdDdXJyZW50RmliZXIucGhhc2UgPSBwaGFzZTsKICAgICAgfQoKICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RmliZXIgPSB7CiAgICAgICAgY3VycmVudDogbnVsbCwKICAgICAgICBwaGFzZTogbnVsbCwKICAgICAgICByZXNldEN1cnJlbnRGaWJlcjogcmVzZXRDdXJyZW50RmliZXIsCiAgICAgICAgc2V0Q3VycmVudEZpYmVyOiBzZXRDdXJyZW50RmliZXIsCiAgICAgICAgc2V0Q3VycmVudFBoYXNlOiBzZXRDdXJyZW50UGhhc2UsCiAgICAgICAgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lOiBnZXRDdXJyZW50RmliZXJPd25lck5hbWUsCiAgICAgICAgZ2V0Q3VycmVudEZpYmVyU3RhY2tBZGRlbmR1bTogZ2V0Q3VycmVudEZpYmVyU3RhY2tBZGRlbmR1bQogICAgICB9OwogICAgICB2YXIgcmVhY3RFbW9qaSA9ICJcdTI2OUIiOwogICAgICB2YXIgd2FybmluZ0Vtb2ppID0gIlx1MjZENCI7CiAgICAgIHZhciBzdXBwb3J0c1VzZXJUaW1pbmcgPSB0eXBlb2YgcGVyZm9ybWFuY2UgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5tYXJrID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5jbGVhck1hcmtzID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5tZWFzdXJlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5jbGVhck1lYXN1cmVzID09PSAiZnVuY3Rpb24iOwogICAgICB2YXIgY3VycmVudEZpYmVyID0gbnVsbDsKICAgICAgdmFyIGN1cnJlbnRQaGFzZSA9IG51bGw7CiAgICAgIHZhciBjdXJyZW50UGhhc2VGaWJlciA9IG51bGw7CiAgICAgIHZhciBpc0NvbW1pdHRpbmcgPSBmYWxzZTsKICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZUluQ3VycmVudENvbW1pdCA9IGZhbHNlOwogICAgICB2YXIgaGFzU2NoZWR1bGVkVXBkYXRlSW5DdXJyZW50UGhhc2UgPSBmYWxzZTsKICAgICAgdmFyIGNvbW1pdENvdW50SW5DdXJyZW50V29ya0xvb3AgPSAwOwogICAgICB2YXIgZWZmZWN0Q291bnRJbkN1cnJlbnRDb21taXQgPSAwOwogICAgICB2YXIgaXNXYWl0aW5nRm9yQ2FsbGJhY2sgPSBmYWxzZTsKICAgICAgdmFyIGxhYmVsc0luQ3VycmVudENvbW1pdCA9IG5ldyBTZXQoKTsKCiAgICAgIHZhciBmb3JtYXRNYXJrTmFtZSA9IGZ1bmN0aW9uIGZvcm1hdE1hcmtOYW1lKG1hcmtOYW1lKSB7CiAgICAgICAgcmV0dXJuIHJlYWN0RW1vamkgKyAiICIgKyBtYXJrTmFtZTsKICAgICAgfTsKCiAgICAgIHZhciBmb3JtYXRMYWJlbCA9IGZ1bmN0aW9uIGZvcm1hdExhYmVsKGxhYmVsLCB3YXJuaW5nJCQxKSB7CiAgICAgICAgdmFyIHByZWZpeCA9IHdhcm5pbmckJDEgPyB3YXJuaW5nRW1vamkgKyAiICIgOiByZWFjdEVtb2ppICsgIiAiOwogICAgICAgIHZhciBzdWZmaXggPSB3YXJuaW5nJCQxID8gIiBXYXJuaW5nOiAiICsgd2FybmluZyQkMSA6ICIiOwogICAgICAgIHJldHVybiAiIiArIHByZWZpeCArIGxhYmVsICsgc3VmZml4OwogICAgICB9OwoKICAgICAgdmFyIGJlZ2luTWFyayA9IGZ1bmN0aW9uIGJlZ2luTWFyayhtYXJrTmFtZSkgewogICAgICAgIHBlcmZvcm1hbmNlLm1hcmsoZm9ybWF0TWFya05hbWUobWFya05hbWUpKTsKICAgICAgfTsKCiAgICAgIHZhciBjbGVhck1hcmsgPSBmdW5jdGlvbiBjbGVhck1hcmsobWFya05hbWUpIHsKICAgICAgICBwZXJmb3JtYW5jZS5jbGVhck1hcmtzKGZvcm1hdE1hcmtOYW1lKG1hcmtOYW1lKSk7CiAgICAgIH07CgogICAgICB2YXIgZW5kTWFyayA9IGZ1bmN0aW9uIGVuZE1hcmsobGFiZWwsIG1hcmtOYW1lLCB3YXJuaW5nJCQxKSB7CiAgICAgICAgdmFyIGZvcm1hdHRlZE1hcmtOYW1lID0gZm9ybWF0TWFya05hbWUobWFya05hbWUpOwogICAgICAgIHZhciBmb3JtYXR0ZWRMYWJlbCA9IGZvcm1hdExhYmVsKGxhYmVsLCB3YXJuaW5nJCQxKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHBlcmZvcm1hbmNlLm1lYXN1cmUoZm9ybWF0dGVkTGFiZWwsIGZvcm1hdHRlZE1hcmtOYW1lKTsKICAgICAgICB9IGNhdGNoIChlcnIpIHt9CgogICAgICAgIHBlcmZvcm1hbmNlLmNsZWFyTWFya3MoZm9ybWF0dGVkTWFya05hbWUpOwogICAgICAgIHBlcmZvcm1hbmNlLmNsZWFyTWVhc3VyZXMoZm9ybWF0dGVkTGFiZWwpOwogICAgICB9OwoKICAgICAgdmFyIGdldEZpYmVyTWFya05hbWUgPSBmdW5jdGlvbiBnZXRGaWJlck1hcmtOYW1lKGxhYmVsLCBkZWJ1Z0lEKSB7CiAgICAgICAgcmV0dXJuIGxhYmVsICsgIiAoIyIgKyBkZWJ1Z0lEICsgIikiOwogICAgICB9OwoKICAgICAgdmFyIGdldEZpYmVyTGFiZWwgPSBmdW5jdGlvbiBnZXRGaWJlckxhYmVsKGNvbXBvbmVudE5hbWUsIGlzTW91bnRlZCwgcGhhc2UpIHsKICAgICAgICBpZiAocGhhc2UgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBjb21wb25lbnROYW1lICsgIiBbIiArIChpc01vdW50ZWQgPyAidXBkYXRlIiA6ICJtb3VudCIpICsgIl0iOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gY29tcG9uZW50TmFtZSArICIuIiArIHBoYXNlOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciBiZWdpbkZpYmVyTWFyayA9IGZ1bmN0aW9uIGJlZ2luRmliZXJNYXJrKGZpYmVyLCBwaGFzZSkgewogICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZShmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgIHZhciBkZWJ1Z0lEID0gZmliZXIuX2RlYnVnSUQ7CiAgICAgICAgdmFyIGlzTW91bnRlZCA9IGZpYmVyLmFsdGVybmF0ZSAhPT0gbnVsbDsKICAgICAgICB2YXIgbGFiZWwgPSBnZXRGaWJlckxhYmVsKGNvbXBvbmVudE5hbWUsIGlzTW91bnRlZCwgcGhhc2UpOwoKICAgICAgICBpZiAoaXNDb21taXR0aW5nICYmIGxhYmVsc0luQ3VycmVudENvbW1pdC5oYXMobGFiZWwpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBsYWJlbHNJbkN1cnJlbnRDb21taXQuYWRkKGxhYmVsKTsKICAgICAgICB2YXIgbWFya05hbWUgPSBnZXRGaWJlck1hcmtOYW1lKGxhYmVsLCBkZWJ1Z0lEKTsKICAgICAgICBiZWdpbk1hcmsobWFya05hbWUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9OwoKICAgICAgdmFyIGNsZWFyRmliZXJNYXJrID0gZnVuY3Rpb24gY2xlYXJGaWJlck1hcmsoZmliZXIsIHBoYXNlKSB7CiAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lKGZpYmVyKSB8fCAiVW5rbm93biI7CiAgICAgICAgdmFyIGRlYnVnSUQgPSBmaWJlci5fZGVidWdJRDsKICAgICAgICB2YXIgaXNNb3VudGVkID0gZmliZXIuYWx0ZXJuYXRlICE9PSBudWxsOwogICAgICAgIHZhciBsYWJlbCA9IGdldEZpYmVyTGFiZWwoY29tcG9uZW50TmFtZSwgaXNNb3VudGVkLCBwaGFzZSk7CiAgICAgICAgdmFyIG1hcmtOYW1lID0gZ2V0RmliZXJNYXJrTmFtZShsYWJlbCwgZGVidWdJRCk7CiAgICAgICAgY2xlYXJNYXJrKG1hcmtOYW1lKTsKICAgICAgfTsKCiAgICAgIHZhciBlbmRGaWJlck1hcmsgPSBmdW5jdGlvbiBlbmRGaWJlck1hcmsoZmliZXIsIHBoYXNlLCB3YXJuaW5nJCQxKSB7CiAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lKGZpYmVyKSB8fCAiVW5rbm93biI7CiAgICAgICAgdmFyIGRlYnVnSUQgPSBmaWJlci5fZGVidWdJRDsKICAgICAgICB2YXIgaXNNb3VudGVkID0gZmliZXIuYWx0ZXJuYXRlICE9PSBudWxsOwogICAgICAgIHZhciBsYWJlbCA9IGdldEZpYmVyTGFiZWwoY29tcG9uZW50TmFtZSwgaXNNb3VudGVkLCBwaGFzZSk7CiAgICAgICAgdmFyIG1hcmtOYW1lID0gZ2V0RmliZXJNYXJrTmFtZShsYWJlbCwgZGVidWdJRCk7CiAgICAgICAgZW5kTWFyayhsYWJlbCwgbWFya05hbWUsIHdhcm5pbmckJDEpOwogICAgICB9OwoKICAgICAgdmFyIHNob3VsZElnbm9yZUZpYmVyID0gZnVuY3Rpb24gc2hvdWxkSWdub3JlRmliZXIoZmliZXIpIHsKICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICBjYXNlIFJldHVybkNvbXBvbmVudDoKICAgICAgICAgIGNhc2UgRnJhZ21lbnQ6CiAgICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgY2xlYXJQZW5kaW5nUGhhc2VNZWFzdXJlbWVudCA9IGZ1bmN0aW9uIGNsZWFyUGVuZGluZ1BoYXNlTWVhc3VyZW1lbnQoKSB7CiAgICAgICAgaWYgKGN1cnJlbnRQaGFzZSAhPT0gbnVsbCAmJiBjdXJyZW50UGhhc2VGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgY2xlYXJGaWJlck1hcmsoY3VycmVudFBoYXNlRmliZXIsIGN1cnJlbnRQaGFzZSk7CiAgICAgICAgfQoKICAgICAgICBjdXJyZW50UGhhc2VGaWJlciA9IG51bGw7CiAgICAgICAgY3VycmVudFBoYXNlID0gbnVsbDsKICAgICAgICBoYXNTY2hlZHVsZWRVcGRhdGVJbkN1cnJlbnRQaGFzZSA9IGZhbHNlOwogICAgICB9OwoKICAgICAgdmFyIHBhdXNlVGltZXJzID0gZnVuY3Rpb24gcGF1c2VUaW1lcnMoKSB7CiAgICAgICAgdmFyIGZpYmVyID0gY3VycmVudEZpYmVyOwoKICAgICAgICB3aGlsZSAoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlci5fZGVidWdJc0N1cnJlbnRseVRpbWluZykgewogICAgICAgICAgICBlbmRGaWJlck1hcmsoZmliZXIsIG51bGwsIG51bGwpOwogICAgICAgICAgfQoKICAgICAgICAgIGZpYmVyID0gZmliZXJbInJldHVybiJdOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciByZXN1bWVUaW1lcnNSZWN1cnNpdmVseSA9IGZ1bmN0aW9uIHJlc3VtZVRpbWVyc1JlY3Vyc2l2ZWx5KGZpYmVyKSB7CiAgICAgICAgaWYgKGZpYmVyWyJyZXR1cm4iXSAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdW1lVGltZXJzUmVjdXJzaXZlbHkoZmliZXJbInJldHVybiJdKTsKICAgICAgICB9CgogICAgICAgIGlmIChmaWJlci5fZGVidWdJc0N1cnJlbnRseVRpbWluZykgewogICAgICAgICAgYmVnaW5GaWJlck1hcmsoZmliZXIsIG51bGwpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciByZXN1bWVUaW1lcnMgPSBmdW5jdGlvbiByZXN1bWVUaW1lcnMoKSB7CiAgICAgICAgaWYgKGN1cnJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdW1lVGltZXJzUmVjdXJzaXZlbHkoY3VycmVudEZpYmVyKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBmdW5jdGlvbiByZWNvcmRFZmZlY3QoKSB7CiAgICAgICAgaWYgKGVuYWJsZVVzZXJUaW1pbmdBUEkpIHsKICAgICAgICAgIGVmZmVjdENvdW50SW5DdXJyZW50Q29tbWl0Kys7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiByZWNvcmRTY2hlZHVsZVVwZGF0ZSgpIHsKICAgICAgICBpZiAoZW5hYmxlVXNlclRpbWluZ0FQSSkgewogICAgICAgICAgaWYgKGlzQ29tbWl0dGluZykgewogICAgICAgICAgICBoYXNTY2hlZHVsZWRVcGRhdGVJbkN1cnJlbnRDb21taXQgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChjdXJyZW50UGhhc2UgIT09IG51bGwgJiYgY3VycmVudFBoYXNlICE9PSAiY29tcG9uZW50V2lsbE1vdW50IiAmJiBjdXJyZW50UGhhc2UgIT09ICJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIikgewogICAgICAgICAgICBoYXNTY2hlZHVsZWRVcGRhdGVJbkN1cnJlbnRQaGFzZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBzdGFydFJlcXVlc3RDYWxsYmFja1RpbWVyKCkgewogICAgICAgIGlmIChlbmFibGVVc2VyVGltaW5nQVBJKSB7CiAgICAgICAgICBpZiAoc3VwcG9ydHNVc2VyVGltaW5nICYmICFpc1dhaXRpbmdGb3JDYWxsYmFjaykgewogICAgICAgICAgICBpc1dhaXRpbmdGb3JDYWxsYmFjayA9IHRydWU7CiAgICAgICAgICAgIGJlZ2luTWFyaygiKFdhaXRpbmcgZm9yIGFzeW5jIGNhbGxiYWNrLi4uKSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gc3RvcFJlcXVlc3RDYWxsYmFja1RpbWVyKGRpZEV4cGlyZSkgewogICAgICAgIGlmIChlbmFibGVVc2VyVGltaW5nQVBJKSB7CiAgICAgICAgICBpZiAoc3VwcG9ydHNVc2VyVGltaW5nKSB7CiAgICAgICAgICAgIGlzV2FpdGluZ0ZvckNhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICAgIHZhciB3YXJuaW5nJCQxID0gZGlkRXhwaXJlID8gIlJlYWN0IHdhcyBibG9ja2VkIGJ5IG1haW4gdGhyZWFkIiA6IG51bGw7CiAgICAgICAgICAgIGVuZE1hcmsoIihXYWl0aW5nIGZvciBhc3luYyBjYWxsYmFjay4uLikiLCAiKFdhaXRpbmcgZm9yIGFzeW5jIGNhbGxiYWNrLi4uKSIsIHdhcm5pbmckJDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gc3RhcnRXb3JrVGltZXIoZmliZXIpIHsKICAgICAgICBpZiAoZW5hYmxlVXNlclRpbWluZ0FQSSkgewogICAgICAgICAgaWYgKCFzdXBwb3J0c1VzZXJUaW1pbmcgfHwgc2hvdWxkSWdub3JlRmliZXIoZmliZXIpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBjdXJyZW50RmliZXIgPSBmaWJlcjsKCiAgICAgICAgICBpZiAoIWJlZ2luRmliZXJNYXJrKGZpYmVyLCBudWxsKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgZmliZXIuX2RlYnVnSXNDdXJyZW50bHlUaW1pbmcgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gY2FuY2VsV29ya1RpbWVyKGZpYmVyKSB7CiAgICAgICAgaWYgKGVuYWJsZVVzZXJUaW1pbmdBUEkpIHsKICAgICAgICAgIGlmICghc3VwcG9ydHNVc2VyVGltaW5nIHx8IHNob3VsZElnbm9yZUZpYmVyKGZpYmVyKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgZmliZXIuX2RlYnVnSXNDdXJyZW50bHlUaW1pbmcgPSBmYWxzZTsKICAgICAgICAgIGNsZWFyRmliZXJNYXJrKGZpYmVyLCBudWxsKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHN0b3BXb3JrVGltZXIoZmliZXIpIHsKICAgICAgICBpZiAoZW5hYmxlVXNlclRpbWluZ0FQSSkgewogICAgICAgICAgaWYgKCFzdXBwb3J0c1VzZXJUaW1pbmcgfHwgc2hvdWxkSWdub3JlRmliZXIoZmliZXIpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBjdXJyZW50RmliZXIgPSBmaWJlclsicmV0dXJuIl07CgogICAgICAgICAgaWYgKCFmaWJlci5fZGVidWdJc0N1cnJlbnRseVRpbWluZykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgZmliZXIuX2RlYnVnSXNDdXJyZW50bHlUaW1pbmcgPSBmYWxzZTsKICAgICAgICAgIGVuZEZpYmVyTWFyayhmaWJlciwgbnVsbCwgbnVsbCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBzdG9wRmFpbGVkV29ya1RpbWVyKGZpYmVyKSB7CiAgICAgICAgaWYgKGVuYWJsZVVzZXJUaW1pbmdBUEkpIHsKICAgICAgICAgIGlmICghc3VwcG9ydHNVc2VyVGltaW5nIHx8IHNob3VsZElnbm9yZUZpYmVyKGZpYmVyKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgY3VycmVudEZpYmVyID0gZmliZXJbInJldHVybiJdOwoKICAgICAgICAgIGlmICghZmliZXIuX2RlYnVnSXNDdXJyZW50bHlUaW1pbmcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGZpYmVyLl9kZWJ1Z0lzQ3VycmVudGx5VGltaW5nID0gZmFsc2U7CiAgICAgICAgICB2YXIgd2FybmluZyQkMSA9ICJBbiBlcnJvciB3YXMgdGhyb3duIGluc2lkZSB0aGlzIGVycm9yIGJvdW5kYXJ5IjsKICAgICAgICAgIGVuZEZpYmVyTWFyayhmaWJlciwgbnVsbCwgd2FybmluZyQkMSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBzdGFydFBoYXNlVGltZXIoZmliZXIsIHBoYXNlKSB7CiAgICAgICAgaWYgKGVuYWJsZVVzZXJUaW1pbmdBUEkpIHsKICAgICAgICAgIGlmICghc3VwcG9ydHNVc2VyVGltaW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBjbGVhclBlbmRpbmdQaGFzZU1lYXN1cmVtZW50KCk7CgogICAgICAgICAgaWYgKCFiZWdpbkZpYmVyTWFyayhmaWJlciwgcGhhc2UpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBjdXJyZW50UGhhc2VGaWJlciA9IGZpYmVyOwogICAgICAgICAgY3VycmVudFBoYXNlID0gcGhhc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBzdG9wUGhhc2VUaW1lcigpIHsKICAgICAgICBpZiAoZW5hYmxlVXNlclRpbWluZ0FQSSkgewogICAgICAgICAgaWYgKCFzdXBwb3J0c1VzZXJUaW1pbmcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChjdXJyZW50UGhhc2UgIT09IG51bGwgJiYgY3VycmVudFBoYXNlRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHdhcm5pbmckJDEgPSBoYXNTY2hlZHVsZWRVcGRhdGVJbkN1cnJlbnRQaGFzZSA/ICJTY2hlZHVsZWQgYSBjYXNjYWRpbmcgdXBkYXRlIiA6IG51bGw7CiAgICAgICAgICAgIGVuZEZpYmVyTWFyayhjdXJyZW50UGhhc2VGaWJlciwgY3VycmVudFBoYXNlLCB3YXJuaW5nJCQxKTsKICAgICAgICAgIH0KCiAgICAgICAgICBjdXJyZW50UGhhc2UgPSBudWxsOwogICAgICAgICAgY3VycmVudFBoYXNlRmliZXIgPSBudWxsOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gc3RhcnRXb3JrTG9vcFRpbWVyKG5leHRVbml0T2ZXb3JrKSB7CiAgICAgICAgaWYgKGVuYWJsZVVzZXJUaW1pbmdBUEkpIHsKICAgICAgICAgIGN1cnJlbnRGaWJlciA9IG5leHRVbml0T2ZXb3JrOwoKICAgICAgICAgIGlmICghc3VwcG9ydHNVc2VyVGltaW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBjb21taXRDb3VudEluQ3VycmVudFdvcmtMb29wID0gMDsKICAgICAgICAgIGJlZ2luTWFyaygiKFJlYWN0IFRyZWUgUmVjb25jaWxpYXRpb24pIik7CiAgICAgICAgICByZXN1bWVUaW1lcnMoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHN0b3BXb3JrTG9vcFRpbWVyKGludGVycnVwdGVkQnkpIHsKICAgICAgICBpZiAoZW5hYmxlVXNlclRpbWluZ0FQSSkgewogICAgICAgICAgaWYgKCFzdXBwb3J0c1VzZXJUaW1pbmcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciB3YXJuaW5nJCQxID0gbnVsbDsKCiAgICAgICAgICBpZiAoaW50ZXJydXB0ZWRCeSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaW50ZXJydXB0ZWRCeS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgd2FybmluZyQkMSA9ICJBIHRvcC1sZXZlbCB1cGRhdGUgaW50ZXJydXB0ZWQgdGhlIHByZXZpb3VzIHJlbmRlciI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lKGludGVycnVwdGVkQnkpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICB3YXJuaW5nJCQxID0gIkFuIHVwZGF0ZSB0byAiICsgY29tcG9uZW50TmFtZSArICIgaW50ZXJydXB0ZWQgdGhlIHByZXZpb3VzIHJlbmRlciI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoY29tbWl0Q291bnRJbkN1cnJlbnRXb3JrTG9vcCA+IDEpIHsKICAgICAgICAgICAgd2FybmluZyQkMSA9ICJUaGVyZSB3ZXJlIGNhc2NhZGluZyB1cGRhdGVzIjsKICAgICAgICAgIH0KCiAgICAgICAgICBjb21taXRDb3VudEluQ3VycmVudFdvcmtMb29wID0gMDsKICAgICAgICAgIHBhdXNlVGltZXJzKCk7CiAgICAgICAgICBlbmRNYXJrKCIoUmVhY3QgVHJlZSBSZWNvbmNpbGlhdGlvbikiLCAiKFJlYWN0IFRyZWUgUmVjb25jaWxpYXRpb24pIiwgd2FybmluZyQkMSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBzdGFydENvbW1pdFRpbWVyKCkgewogICAgICAgIGlmIChlbmFibGVVc2VyVGltaW5nQVBJKSB7CiAgICAgICAgICBpZiAoIXN1cHBvcnRzVXNlclRpbWluZykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgaXNDb21taXR0aW5nID0gdHJ1ZTsKICAgICAgICAgIGhhc1NjaGVkdWxlZFVwZGF0ZUluQ3VycmVudENvbW1pdCA9IGZhbHNlOwogICAgICAgICAgbGFiZWxzSW5DdXJyZW50Q29tbWl0LmNsZWFyKCk7CiAgICAgICAgICBiZWdpbk1hcmsoIihDb21taXR0aW5nIENoYW5nZXMpIik7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBzdG9wQ29tbWl0VGltZXIoKSB7CiAgICAgICAgaWYgKGVuYWJsZVVzZXJUaW1pbmdBUEkpIHsKICAgICAgICAgIGlmICghc3VwcG9ydHNVc2VyVGltaW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgd2FybmluZyQkMSA9IG51bGw7CgogICAgICAgICAgaWYgKGhhc1NjaGVkdWxlZFVwZGF0ZUluQ3VycmVudENvbW1pdCkgewogICAgICAgICAgICB3YXJuaW5nJCQxID0gIkxpZmVjeWNsZSBob29rIHNjaGVkdWxlZCBhIGNhc2NhZGluZyB1cGRhdGUiOwogICAgICAgICAgfSBlbHNlIGlmIChjb21taXRDb3VudEluQ3VycmVudFdvcmtMb29wID4gMCkgewogICAgICAgICAgICB3YXJuaW5nJCQxID0gIkNhdXNlZCBieSBhIGNhc2NhZGluZyB1cGRhdGUgaW4gZWFybGllciBjb21taXQiOwogICAgICAgICAgfQoKICAgICAgICAgIGhhc1NjaGVkdWxlZFVwZGF0ZUluQ3VycmVudENvbW1pdCA9IGZhbHNlOwogICAgICAgICAgY29tbWl0Q291bnRJbkN1cnJlbnRXb3JrTG9vcCsrOwogICAgICAgICAgaXNDb21taXR0aW5nID0gZmFsc2U7CiAgICAgICAgICBsYWJlbHNJbkN1cnJlbnRDb21taXQuY2xlYXIoKTsKICAgICAgICAgIGVuZE1hcmsoIihDb21taXR0aW5nIENoYW5nZXMpIiwgIihDb21taXR0aW5nIENoYW5nZXMpIiwgd2FybmluZyQkMSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBzdGFydENvbW1pdEhvc3RFZmZlY3RzVGltZXIoKSB7CiAgICAgICAgaWYgKGVuYWJsZVVzZXJUaW1pbmdBUEkpIHsKICAgICAgICAgIGlmICghc3VwcG9ydHNVc2VyVGltaW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBlZmZlY3RDb3VudEluQ3VycmVudENvbW1pdCA9IDA7CiAgICAgICAgICBiZWdpbk1hcmsoIihDb21taXR0aW5nIEhvc3QgRWZmZWN0cykiKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHN0b3BDb21taXRIb3N0RWZmZWN0c1RpbWVyKCkgewogICAgICAgIGlmIChlbmFibGVVc2VyVGltaW5nQVBJKSB7CiAgICAgICAgICBpZiAoIXN1cHBvcnRzVXNlclRpbWluZykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGNvdW50ID0gZWZmZWN0Q291bnRJbkN1cnJlbnRDb21taXQ7CiAgICAgICAgICBlZmZlY3RDb3VudEluQ3VycmVudENvbW1pdCA9IDA7CiAgICAgICAgICBlbmRNYXJrKCIoQ29tbWl0dGluZyBIb3N0IEVmZmVjdHM6ICIgKyBjb3VudCArICIgVG90YWwpIiwgIihDb21taXR0aW5nIEhvc3QgRWZmZWN0cykiLCBudWxsKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHN0YXJ0Q29tbWl0TGlmZUN5Y2xlc1RpbWVyKCkgewogICAgICAgIGlmIChlbmFibGVVc2VyVGltaW5nQVBJKSB7CiAgICAgICAgICBpZiAoIXN1cHBvcnRzVXNlclRpbWluZykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgZWZmZWN0Q291bnRJbkN1cnJlbnRDb21taXQgPSAwOwogICAgICAgICAgYmVnaW5NYXJrKCIoQ2FsbGluZyBMaWZlY3ljbGUgTWV0aG9kcykiKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHN0b3BDb21taXRMaWZlQ3ljbGVzVGltZXIoKSB7CiAgICAgICAgaWYgKGVuYWJsZVVzZXJUaW1pbmdBUEkpIHsKICAgICAgICAgIGlmICghc3VwcG9ydHNVc2VyVGltaW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgY291bnQgPSBlZmZlY3RDb3VudEluQ3VycmVudENvbW1pdDsKICAgICAgICAgIGVmZmVjdENvdW50SW5DdXJyZW50Q29tbWl0ID0gMDsKICAgICAgICAgIGVuZE1hcmsoIihDYWxsaW5nIExpZmVjeWNsZSBNZXRob2RzOiAiICsgY291bnQgKyAiIFRvdGFsKSIsICIoQ2FsbGluZyBMaWZlY3ljbGUgTWV0aG9kcykiLCBudWxsKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHsKICAgICAgICB2YXIgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0ID0ge307CiAgICAgIH0KICAgICAgdmFyIGNvbnRleHRTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihlbXB0eU9iamVjdCk7CiAgICAgIHZhciBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKGZhbHNlKTsKICAgICAgdmFyIHByZXZpb3VzQ29udGV4dCA9IGVtcHR5T2JqZWN0OwoKICAgICAgZnVuY3Rpb24gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgdmFyIGhhc093bkNvbnRleHQgPSBpc0NvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzcyk7CgogICAgICAgIGlmIChoYXNPd25Db250ZXh0KSB7CiAgICAgICAgICByZXR1cm4gcHJldmlvdXNDb250ZXh0OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGNvbnRleHRTdGFja0N1cnNvci5jdXJyZW50OwogICAgICB9CgogICAgICBmdW5jdGlvbiBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MsIHVubWFza2VkQ29udGV4dCwgbWFza2VkQ29udGV4dCkgewogICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZTsKICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZFVubWFza2VkQ2hpbGRDb250ZXh0ID0gdW5tYXNrZWRDb250ZXh0OwogICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0ID0gbWFza2VkQ29udGV4dDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzcywgdW5tYXNrZWRDb250ZXh0KSB7CiAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzcy50eXBlOwogICAgICAgIHZhciBjb250ZXh0VHlwZXMgPSB0eXBlLmNvbnRleHRUeXBlczsKCiAgICAgICAgaWYgKCFjb250ZXh0VHlwZXMpIHsKICAgICAgICAgIHJldHVybiBlbXB0eU9iamVjdDsKICAgICAgICB9CgogICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZTsKCiAgICAgICAgaWYgKGluc3RhbmNlICYmIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkVW5tYXNrZWRDaGlsZENvbnRleHQgPT09IHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0OwogICAgICAgIH0KCiAgICAgICAgdmFyIGNvbnRleHQgPSB7fTsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIGNvbnRleHRUeXBlcykgewogICAgICAgICAgY29udGV4dFtrZXldID0gdW5tYXNrZWRDb250ZXh0W2tleV07CiAgICAgICAgfQoKICAgICAgICB7CiAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWUod29ya0luUHJvZ3Jlc3MpIHx8ICJVbmtub3duIjsKICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNvbnRleHRUeXBlcywgY29udGV4dCwgImNvbnRleHQiLCBuYW1lLCBSZWFjdERlYnVnQ3VycmVudEZpYmVyLmdldEN1cnJlbnRGaWJlclN0YWNrQWRkZW5kdW0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKGluc3RhbmNlKSB7CiAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MsIHVubWFza2VkQ29udGV4dCwgY29udGV4dCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gaGFzQ29udGV4dENoYW5nZWQoKSB7CiAgICAgICAgcmV0dXJuIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gaXNDb250ZXh0Q29uc3VtZXIoZmliZXIpIHsKICAgICAgICByZXR1cm4gZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCAmJiBmaWJlci50eXBlLmNvbnRleHRUeXBlcyAhPSBudWxsOwogICAgICB9CgogICAgICBmdW5jdGlvbiBpc0NvbnRleHRQcm92aWRlcihmaWJlcikgewogICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50ICYmIGZpYmVyLnR5cGUuY2hpbGRDb250ZXh0VHlwZXMgIT0gbnVsbDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcG9wQ29udGV4dFByb3ZpZGVyKGZpYmVyKSB7CiAgICAgICAgaWYgKCFpc0NvbnRleHRQcm92aWRlcihmaWJlcikpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgZmliZXIpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwb3BUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIpIHsKICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcHVzaFRvcExldmVsQ29udGV4dE9iamVjdChmaWJlciwgY29udGV4dCwgZGlkQ2hhbmdlKSB7CiAgICAgICAgaW52YXJpYW50KGNvbnRleHRTdGFja0N1cnNvci5jdXJzb3IgPT0gbnVsbCwgIlVuZXhwZWN0ZWQgY29udGV4dCBmb3VuZCBvbiBzdGFjay4gIiArICJUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBjb250ZXh0LCBmaWJlcik7CiAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRDaGFuZ2UsIGZpYmVyKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcHJvY2Vzc0NoaWxkQ29udGV4dChmaWJlciwgcGFyZW50Q29udGV4dCkgewogICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSBmaWJlci50eXBlLmNoaWxkQ29udGV4dFR5cGVzOwoKICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWUoZmliZXIpIHx8ICJVbmtub3duIjsKCiAgICAgICAgICAgIGlmICghd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAiJXMuY2hpbGRDb250ZXh0VHlwZXMgaXMgc3BlY2lmaWVkIGJ1dCB0aGVyZSBpcyBubyBnZXRDaGlsZENvbnRleHQoKSBtZXRob2QgIiArICJvbiB0aGUgaW5zdGFuY2UuIFlvdSBjYW4gZWl0aGVyIGRlZmluZSBnZXRDaGlsZENvbnRleHQoKSBvbiAlcyBvciByZW1vdmUgIiArICJjaGlsZENvbnRleHRUeXBlcyBmcm9tIGl0LiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgICAgICB9CgogICAgICAgIHZhciBjaGlsZENvbnRleHQgPSB2b2lkIDA7CiAgICAgICAgewogICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5zZXRDdXJyZW50UGhhc2UoImdldENoaWxkQ29udGV4dCIpOwogICAgICAgIH0KICAgICAgICBzdGFydFBoYXNlVGltZXIoZmliZXIsICJnZXRDaGlsZENvbnRleHQiKTsKICAgICAgICBjaGlsZENvbnRleHQgPSBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQoKTsKICAgICAgICBzdG9wUGhhc2VUaW1lcigpOwogICAgICAgIHsKICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RmliZXIuc2V0Q3VycmVudFBoYXNlKG51bGwpOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgY29udGV4dEtleSBpbiBjaGlsZENvbnRleHQpIHsKICAgICAgICAgIGludmFyaWFudChjb250ZXh0S2V5IGluIGNoaWxkQ29udGV4dFR5cGVzLCAnJXMuZ2V0Q2hpbGRDb250ZXh0KCk6IGtleSAiJXMiIGlzIG5vdCBkZWZpbmVkIGluIGNoaWxkQ29udGV4dFR5cGVzLicsIGdldENvbXBvbmVudE5hbWUoZmliZXIpIHx8ICJVbmtub3duIiwgY29udGV4dEtleSk7CiAgICAgICAgfQoKICAgICAgICB7CiAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWUoZmliZXIpIHx8ICJVbmtub3duIjsKICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNoaWxkQ29udGV4dFR5cGVzLCBjaGlsZENvbnRleHQsICJjaGlsZCBjb250ZXh0IiwgbmFtZSwgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5nZXRDdXJyZW50RmliZXJTdGFja0FkZGVuZHVtKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBwYXJlbnRDb250ZXh0LCBjaGlsZENvbnRleHQpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgaWYgKCFpc0NvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzcykpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZTsKICAgICAgICB2YXIgbWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCB8fCBlbXB0eU9iamVjdDsKICAgICAgICBwcmV2aW91c0NvbnRleHQgPSBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgbWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQsIHdvcmtJblByb2dyZXNzKTsKICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudCwgd29ya0luUHJvZ3Jlc3MpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBmdW5jdGlvbiBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzLCBkaWRDaGFuZ2UpIHsKICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGU7CiAgICAgICAgaW52YXJpYW50KGluc3RhbmNlLCAiRXhwZWN0ZWQgdG8gaGF2ZSBhbiBpbnN0YW5jZSBieSB0aGlzIHBvaW50LiAiICsgIlRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CgogICAgICAgIGlmIChkaWRDaGFuZ2UpIHsKICAgICAgICAgIHZhciBtZXJnZWRDb250ZXh0ID0gcHJvY2Vzc0NoaWxkQ29udGV4dCh3b3JrSW5Qcm9ncmVzcywgcHJldmlvdXNDb250ZXh0KTsKICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0ID0gbWVyZ2VkQ29udGV4dDsKICAgICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgbWVyZ2VkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRDaGFuZ2UsIHdvcmtJblByb2dyZXNzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiByZXNldENvbnRleHQoKSB7CiAgICAgICAgcHJldmlvdXNDb250ZXh0ID0gZW1wdHlPYmplY3Q7CiAgICAgICAgY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQgPSBlbXB0eU9iamVjdDsKICAgICAgICBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQgPSBmYWxzZTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRVbm1hc2tlZENvbnRleHQoZmliZXIpIHsKICAgICAgICBpbnZhcmlhbnQoaXNGaWJlck1vdW50ZWQoZmliZXIpICYmIGZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQsICJFeHBlY3RlZCBzdWJ0cmVlIHBhcmVudCB0byBiZSBhIG1vdW50ZWQgY2xhc3MgY29tcG9uZW50LiAiICsgIlRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKCiAgICAgICAgd2hpbGUgKG5vZGUudGFnICE9PSBIb3N0Um9vdCkgewogICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKG5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dDsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgcGFyZW50ID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgICBpbnZhcmlhbnQocGFyZW50LCAiRm91bmQgdW5leHBlY3RlZCBkZXRhY2hlZCBzdWJ0cmVlIHBhcmVudC4gIiArICJUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgbm9kZSA9IHBhcmVudDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZS5jb250ZXh0OwogICAgICB9CgogICAgICB2YXIgTm9Xb3JrID0gMDsKICAgICAgdmFyIFN5bmMgPSAxOwogICAgICB2YXIgTmV2ZXIgPSAyMTQ3NDgzNjQ3OwogICAgICB2YXIgVU5JVF9TSVpFID0gMTA7CiAgICAgIHZhciBNQUdJQ19OVU1CRVJfT0ZGU0VUID0gMjsKCiAgICAgIGZ1bmN0aW9uIG1zVG9FeHBpcmF0aW9uVGltZShtcykgewogICAgICAgIHJldHVybiAobXMgLyBVTklUX1NJWkUgfCAwKSArIE1BR0lDX05VTUJFUl9PRkZTRVQ7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGV4cGlyYXRpb25UaW1lVG9NcyhleHBpcmF0aW9uVGltZSkgewogICAgICAgIHJldHVybiAoZXhwaXJhdGlvblRpbWUgLSBNQUdJQ19OVU1CRVJfT0ZGU0VUKSAqIFVOSVRfU0laRTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY2VpbGluZyhudW0sIHByZWNpc2lvbikgewogICAgICAgIHJldHVybiAoKG51bSAvIHByZWNpc2lvbiB8IDApICsgMSkgKiBwcmVjaXNpb247CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNvbXB1dGVFeHBpcmF0aW9uQnVja2V0KGN1cnJlbnRUaW1lLCBleHBpcmF0aW9uSW5NcywgYnVja2V0U2l6ZU1zKSB7CiAgICAgICAgcmV0dXJuIGNlaWxpbmcoY3VycmVudFRpbWUgKyBleHBpcmF0aW9uSW5NcyAvIFVOSVRfU0laRSwgYnVja2V0U2l6ZU1zIC8gVU5JVF9TSVpFKTsKICAgICAgfQoKICAgICAgdmFyIE5vQ29udGV4dCA9IDA7CiAgICAgIHZhciBBc3luY1VwZGF0ZXMgPSAxOwogICAgICB7CiAgICAgICAgdmFyIGhhc0JhZE1hcFBvbHlmaWxsID0gZmFsc2U7CgogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgbm9uRXh0ZW5zaWJsZU9iamVjdCA9IE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucyh7fSk7CiAgICAgICAgICBuZXcgTWFwKFtbbm9uRXh0ZW5zaWJsZU9iamVjdCwgbnVsbF1dKTsKICAgICAgICAgIG5ldyBTZXQoW25vbkV4dGVuc2libGVPYmplY3RdKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBoYXNCYWRNYXBQb2x5ZmlsbCA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHsKICAgICAgICB2YXIgZGVidWdDb3VudGVyID0gMTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIGludGVybmFsQ29udGV4dFRhZykgewogICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgIHRoaXMudHlwZSA9IG51bGw7CiAgICAgICAgdGhpcy5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgIHRoaXNbInJldHVybiJdID0gbnVsbDsKICAgICAgICB0aGlzLmNoaWxkID0gbnVsbDsKICAgICAgICB0aGlzLnNpYmxpbmcgPSBudWxsOwogICAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICAgIHRoaXMucmVmID0gbnVsbDsKICAgICAgICB0aGlzLnBlbmRpbmdQcm9wcyA9IHBlbmRpbmdQcm9wczsKICAgICAgICB0aGlzLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgIHRoaXMudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgIHRoaXMubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgdGhpcy5pbnRlcm5hbENvbnRleHRUYWcgPSBpbnRlcm5hbENvbnRleHRUYWc7CiAgICAgICAgdGhpcy5lZmZlY3RUYWcgPSBOb0VmZmVjdDsKICAgICAgICB0aGlzLm5leHRFZmZlY3QgPSBudWxsOwogICAgICAgIHRoaXMuZmlyc3RFZmZlY3QgPSBudWxsOwogICAgICAgIHRoaXMubGFzdEVmZmVjdCA9IG51bGw7CiAgICAgICAgdGhpcy5leHBpcmF0aW9uVGltZSA9IE5vV29yazsKICAgICAgICB0aGlzLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgdGhpcy5fZGVidWdJRCA9IGRlYnVnQ291bnRlcisrOwogICAgICAgICAgdGhpcy5fZGVidWdTb3VyY2UgPSBudWxsOwogICAgICAgICAgdGhpcy5fZGVidWdPd25lciA9IG51bGw7CiAgICAgICAgICB0aGlzLl9kZWJ1Z0lzQ3VycmVudGx5VGltaW5nID0gZmFsc2U7CgogICAgICAgICAgaWYgKCFoYXNCYWRNYXBQb2x5ZmlsbCAmJiB0eXBlb2YgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucyh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBjcmVhdGVGaWJlciA9IGZ1bmN0aW9uIGNyZWF0ZUZpYmVyKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIGludGVybmFsQ29udGV4dFRhZykgewogICAgICAgIHJldHVybiBuZXcgRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIGludGVybmFsQ29udGV4dFRhZyk7CiAgICAgIH07CgogICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50KSB7CiAgICAgICAgcmV0dXJuICEhKENvbXBvbmVudC5wcm90b3R5cGUgJiYgQ29tcG9uZW50LnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudCwgcGVuZGluZ1Byb3BzLCBleHBpcmF0aW9uVGltZSkgewogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzcyA9IGN1cnJlbnQuYWx0ZXJuYXRlOwoKICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgPT09IG51bGwpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gY3JlYXRlRmliZXIoY3VycmVudC50YWcsIHBlbmRpbmdQcm9wcywgY3VycmVudC5rZXksIGN1cnJlbnQuaW50ZXJuYWxDb250ZXh0VGFnKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzLnR5cGUgPSBjdXJyZW50LnR5cGU7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUgPSBjdXJyZW50LnN0YXRlTm9kZTsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MuX2RlYnVnSUQgPSBjdXJyZW50Ll9kZWJ1Z0lEOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5fZGVidWdTb3VyY2UgPSBjdXJyZW50Ll9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MuX2RlYnVnT3duZXIgPSBjdXJyZW50Ll9kZWJ1Z093bmVyOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MuYWx0ZXJuYXRlID0gY3VycmVudDsKICAgICAgICAgIGN1cnJlbnQuYWx0ZXJuYXRlID0gd29ya0luUHJvZ3Jlc3M7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzLnBlbmRpbmdQcm9wcyA9IHBlbmRpbmdQcm9wczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyA9IE5vRWZmZWN0OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MubmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5maXJzdEVmZmVjdCA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5sYXN0RWZmZWN0ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHdvcmtJblByb2dyZXNzLmV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWU7CiAgICAgICAgd29ya0luUHJvZ3Jlc3MuY2hpbGQgPSBjdXJyZW50LmNoaWxkOwogICAgICAgIHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHMgPSBjdXJyZW50Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICB3b3JrSW5Qcm9ncmVzcy51cGRhdGVRdWV1ZSA9IGN1cnJlbnQudXBkYXRlUXVldWU7CiAgICAgICAgd29ya0luUHJvZ3Jlc3Muc2libGluZyA9IGN1cnJlbnQuc2libGluZzsKICAgICAgICB3b3JrSW5Qcm9ncmVzcy5pbmRleCA9IGN1cnJlbnQuaW5kZXg7CiAgICAgICAgd29ya0luUHJvZ3Jlc3MucmVmID0gY3VycmVudC5yZWY7CiAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjcmVhdGVIb3N0Um9vdEZpYmVyKCkgewogICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RSb290LCBudWxsLCBOb0NvbnRleHQpOwogICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRWxlbWVudChlbGVtZW50LCBpbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgdmFyIG93bmVyID0gbnVsbDsKICAgICAgICB7CiAgICAgICAgICBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgIH0KICAgICAgICB2YXIgZmliZXIgPSB2b2lkIDA7CiAgICAgICAgdmFyIHR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBlbGVtZW50LnByb3BzOwoKICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGZpYmVyID0gc2hvdWxkQ29uc3RydWN0KHR5cGUpID8gY3JlYXRlRmliZXIoQ2xhc3NDb21wb25lbnQsIHBlbmRpbmdQcm9wcywga2V5LCBpbnRlcm5hbENvbnRleHRUYWcpIDogY3JlYXRlRmliZXIoSW5kZXRlcm1pbmF0ZUNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIGludGVybmFsQ29udGV4dFRhZyk7CiAgICAgICAgICBmaWJlci50eXBlID0gdHlwZTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0Q29tcG9uZW50LCBwZW5kaW5nUHJvcHMsIGtleSwgaW50ZXJuYWxDb250ZXh0VGFnKTsKICAgICAgICAgIGZpYmVyLnR5cGUgPSB0eXBlOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgdHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgZmliZXIgPSB0eXBlOwogICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gcGVuZGluZ1Byb3BzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsICYmIE9iamVjdC5rZXlzKHR5cGUpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgIGluZm8gKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSAiICsgIml0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgb3duZXJOYW1lID0gb3duZXIgPyBnZXRDb21wb25lbnROYW1lKG93bmVyKSA6IG51bGw7CgogICAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgICAgaW5mbyArPSAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaW52YXJpYW50KGZhbHNlLCAiRWxlbWVudCB0eXBlIGlzIGludmFsaWQ6IGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgIiArICJvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpIGJ1dCBnb3Q6ICVzLiVzIiwgdHlwZSA9PSBudWxsID8gdHlwZSA6IHR5cGVvZiB0eXBlLCBpbmZvKTsKICAgICAgICB9CgogICAgICAgIHsKICAgICAgICAgIGZpYmVyLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgfQogICAgICAgIGZpYmVyLmV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWU7CiAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21GcmFnbWVudChlbGVtZW50cywgaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSwga2V5KSB7CiAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoRnJhZ21lbnQsIGVsZW1lbnRzLCBrZXksIGludGVybmFsQ29udGV4dFRhZyk7CiAgICAgICAgZmliZXIuZXhwaXJhdGlvblRpbWUgPSBleHBpcmF0aW9uVGltZTsKICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVRleHQoY29udGVudCwgaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSkgewogICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RUZXh0LCBjb250ZW50LCBudWxsLCBpbnRlcm5hbENvbnRleHRUYWcpOwogICAgICAgIGZpYmVyLmV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWU7CiAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Ib3N0SW5zdGFuY2VGb3JEZWxldGlvbigpIHsKICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0Q29tcG9uZW50LCBudWxsLCBudWxsLCBOb0NvbnRleHQpOwogICAgICAgIGZpYmVyLnR5cGUgPSAiREVMRVRFRCI7CiAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21DYWxsKGNhbGwsIGludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpIHsKICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihDYWxsQ29tcG9uZW50LCBjYWxsLCBjYWxsLmtleSwgaW50ZXJuYWxDb250ZXh0VGFnKTsKICAgICAgICBmaWJlci50eXBlID0gY2FsbC5oYW5kbGVyOwogICAgICAgIGZpYmVyLmV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWU7CiAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21SZXR1cm4ocmV0dXJuTm9kZSwgaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSkgewogICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFJldHVybkNvbXBvbmVudCwgbnVsbCwgbnVsbCwgaW50ZXJuYWxDb250ZXh0VGFnKTsKICAgICAgICBmaWJlci5leHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lOwogICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSkgewogICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBwb3J0YWwuY2hpbGRyZW4gIT09IG51bGwgPyBwb3J0YWwuY2hpbGRyZW4gOiBbXTsKICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0UG9ydGFsLCBwZW5kaW5nUHJvcHMsIHBvcnRhbC5rZXksIGludGVybmFsQ29udGV4dFRhZyk7CiAgICAgICAgZmliZXIuZXhwaXJhdGlvblRpbWUgPSBleHBpcmF0aW9uVGltZTsKICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSB7CiAgICAgICAgICBjb250YWluZXJJbmZvOiBwb3J0YWwuY29udGFpbmVySW5mbywKICAgICAgICAgIHBlbmRpbmdDaGlsZHJlbjogbnVsbCwKICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBwb3J0YWwuaW1wbGVtZW50YXRpb24KICAgICAgICB9OwogICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJSb290KGNvbnRhaW5lckluZm8sIGh5ZHJhdGUpIHsKICAgICAgICB2YXIgdW5pbml0aWFsaXplZEZpYmVyID0gY3JlYXRlSG9zdFJvb3RGaWJlcigpOwogICAgICAgIHZhciByb290ID0gewogICAgICAgICAgY3VycmVudDogdW5pbml0aWFsaXplZEZpYmVyLAogICAgICAgICAgY29udGFpbmVySW5mbzogY29udGFpbmVySW5mbywKICAgICAgICAgIHBlbmRpbmdDaGlsZHJlbjogbnVsbCwKICAgICAgICAgIHJlbWFpbmluZ0V4cGlyYXRpb25UaW1lOiBOb1dvcmssCiAgICAgICAgICBpc1JlYWR5Rm9yQ29tbWl0OiBmYWxzZSwKICAgICAgICAgIGZpbmlzaGVkV29yazogbnVsbCwKICAgICAgICAgIGNvbnRleHQ6IG51bGwsCiAgICAgICAgICBwZW5kaW5nQ29udGV4dDogbnVsbCwKICAgICAgICAgIGh5ZHJhdGU6IGh5ZHJhdGUsCiAgICAgICAgICBmaXJzdEJhdGNoOiBudWxsLAogICAgICAgICAgbmV4dFNjaGVkdWxlZFJvb3Q6IG51bGwKICAgICAgICB9OwogICAgICAgIHVuaW5pdGlhbGl6ZWRGaWJlci5zdGF0ZU5vZGUgPSByb290OwogICAgICAgIHJldHVybiByb290OwogICAgICB9CgogICAgICB2YXIgb25Db21taXRGaWJlclJvb3QgPSBudWxsOwogICAgICB2YXIgb25Db21taXRGaWJlclVubW91bnQgPSBudWxsOwogICAgICB2YXIgaGFzTG9nZ2VkRXJyb3IgPSBmYWxzZTsKCiAgICAgIGZ1bmN0aW9uIGNhdGNoRXJyb3JzKGZuKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBmbihhcmcpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmICh0cnVlICYmICFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAiUmVhY3QgRGV2VG9vbHMgZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGluamVjdEludGVybmFscyhpbnRlcm5hbHMpIHsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciBob29rID0gX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fOwoKICAgICAgICBpZiAoaG9vay5pc0Rpc2FibGVkKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICghaG9vay5zdXBwb3J0c0ZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICJUaGUgaW5zdGFsbGVkIHZlcnNpb24gb2YgUmVhY3QgRGV2VG9vbHMgaXMgdG9vIG9sZCBhbmQgd2lsbCBub3Qgd29yayAiICsgIndpdGggdGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBSZWFjdC4gUGxlYXNlIHVwZGF0ZSBSZWFjdCBEZXZUb29scy4gIiArICJodHRwczovL2ZiLm1lL3JlYWN0LWRldnRvb2xzIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcmVuZGVyZXJJRCA9IGhvb2suaW5qZWN0KGludGVybmFscyk7CiAgICAgICAgICBvbkNvbW1pdEZpYmVyUm9vdCA9IGNhdGNoRXJyb3JzKGZ1bmN0aW9uIChyb290KSB7CiAgICAgICAgICAgIHJldHVybiBob29rLm9uQ29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QpOwogICAgICAgICAgfSk7CiAgICAgICAgICBvbkNvbW1pdEZpYmVyVW5tb3VudCA9IGNhdGNoRXJyb3JzKGZ1bmN0aW9uIChmaWJlcikgewogICAgICAgICAgICByZXR1cm4gaG9vay5vbkNvbW1pdEZpYmVyVW5tb3VudChyZW5kZXJlcklELCBmaWJlcik7CiAgICAgICAgICB9KTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgd2FybmluZyhmYWxzZSwgIlJlYWN0IERldlRvb2xzIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcy4iLCBlcnIpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0Um9vdChyb290KSB7CiAgICAgICAgaWYgKHR5cGVvZiBvbkNvbW1pdEZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgb25Db21taXRGaWJlclJvb3Qocm9vdCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBvbkNvbW1pdFVubW91bnQoZmliZXIpIHsKICAgICAgICBpZiAodHlwZW9mIG9uQ29tbWl0RmliZXJVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBvbkNvbW1pdEZpYmVyVW5tb3VudChmaWJlcik7CiAgICAgICAgfQogICAgICB9CgogICAgICB7CiAgICAgICAgdmFyIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUgPSBmYWxzZTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY3JlYXRlVXBkYXRlUXVldWUoYmFzZVN0YXRlKSB7CiAgICAgICAgdmFyIHF1ZXVlID0gewogICAgICAgICAgYmFzZVN0YXRlOiBiYXNlU3RhdGUsCiAgICAgICAgICBleHBpcmF0aW9uVGltZTogTm9Xb3JrLAogICAgICAgICAgZmlyc3Q6IG51bGwsCiAgICAgICAgICBsYXN0OiBudWxsLAogICAgICAgICAgY2FsbGJhY2tMaXN0OiBudWxsLAogICAgICAgICAgaGFzRm9yY2VVcGRhdGU6IGZhbHNlLAogICAgICAgICAgaXNJbml0aWFsaXplZDogZmFsc2UKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHF1ZXVlLmlzUHJvY2Vzc2luZyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcXVldWU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGluc2VydFVwZGF0ZUludG9RdWV1ZShxdWV1ZSwgdXBkYXRlKSB7CiAgICAgICAgaWYgKHF1ZXVlLmxhc3QgPT09IG51bGwpIHsKICAgICAgICAgIHF1ZXVlLmZpcnN0ID0gcXVldWUubGFzdCA9IHVwZGF0ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcXVldWUubGFzdC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgcXVldWUubGFzdCA9IHVwZGF0ZTsKICAgICAgICB9CgogICAgICAgIGlmIChxdWV1ZS5leHBpcmF0aW9uVGltZSA9PT0gTm9Xb3JrIHx8IHF1ZXVlLmV4cGlyYXRpb25UaW1lID4gdXBkYXRlLmV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICBxdWV1ZS5leHBpcmF0aW9uVGltZSA9IHVwZGF0ZS5leHBpcmF0aW9uVGltZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGluc2VydFVwZGF0ZUludG9GaWJlcihmaWJlciwgdXBkYXRlKSB7CiAgICAgICAgdmFyIGFsdGVybmF0ZUZpYmVyID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgIHZhciBxdWV1ZTEgPSBmaWJlci51cGRhdGVRdWV1ZTsKCiAgICAgICAgaWYgKHF1ZXVlMSA9PT0gbnVsbCkgewogICAgICAgICAgcXVldWUxID0gZmliZXIudXBkYXRlUXVldWUgPSBjcmVhdGVVcGRhdGVRdWV1ZShudWxsKTsKICAgICAgICB9CgogICAgICAgIHZhciBxdWV1ZTIgPSB2b2lkIDA7CgogICAgICAgIGlmIChhbHRlcm5hdGVGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgcXVldWUyID0gYWx0ZXJuYXRlRmliZXIudXBkYXRlUXVldWU7CgogICAgICAgICAgaWYgKHF1ZXVlMiA9PT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZTIgPSBhbHRlcm5hdGVGaWJlci51cGRhdGVRdWV1ZSA9IGNyZWF0ZVVwZGF0ZVF1ZXVlKG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBxdWV1ZTIgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgcXVldWUyID0gcXVldWUyICE9PSBxdWV1ZTEgPyBxdWV1ZTIgOiBudWxsOwogICAgICAgIHsKICAgICAgICAgIGlmICgocXVldWUxLmlzUHJvY2Vzc2luZyB8fCBxdWV1ZTIgIT09IG51bGwgJiYgcXVldWUyLmlzUHJvY2Vzc2luZykgJiYgIWRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUpIHsKICAgICAgICAgICAgd2FybmluZyhmYWxzZSwgIkFuIHVwZGF0ZSAoc2V0U3RhdGUsIHJlcGxhY2VTdGF0ZSwgb3IgZm9yY2VVcGRhdGUpIHdhcyBzY2hlZHVsZWQgIiArICJmcm9tIGluc2lkZSBhbiB1cGRhdGUgZnVuY3Rpb24uIFVwZGF0ZSBmdW5jdGlvbnMgc2hvdWxkIGJlIHB1cmUsICIgKyAid2l0aCB6ZXJvIHNpZGUtZWZmZWN0cy4gQ29uc2lkZXIgdXNpbmcgY29tcG9uZW50RGlkVXBkYXRlIG9yIGEgIiArICJjYWxsYmFjay4iKTsKICAgICAgICAgICAgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAocXVldWUyID09PSBudWxsKSB7CiAgICAgICAgICBpbnNlcnRVcGRhdGVJbnRvUXVldWUocXVldWUxLCB1cGRhdGUpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHF1ZXVlMS5sYXN0ID09PSBudWxsIHx8IHF1ZXVlMi5sYXN0ID09PSBudWxsKSB7CiAgICAgICAgICBpbnNlcnRVcGRhdGVJbnRvUXVldWUocXVldWUxLCB1cGRhdGUpOwogICAgICAgICAgaW5zZXJ0VXBkYXRlSW50b1F1ZXVlKHF1ZXVlMiwgdXBkYXRlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGluc2VydFVwZGF0ZUludG9RdWV1ZShxdWV1ZTEsIHVwZGF0ZSk7CiAgICAgICAgcXVldWUyLmxhc3QgPSB1cGRhdGU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGdldFVwZGF0ZUV4cGlyYXRpb25UaW1lKGZpYmVyKSB7CiAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQgJiYgZmliZXIudGFnICE9PSBIb3N0Um9vdCkgewogICAgICAgICAgcmV0dXJuIE5vV29yazsKICAgICAgICB9CgogICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwoKICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBOb1dvcms7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdXBkYXRlUXVldWUuZXhwaXJhdGlvblRpbWU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGdldFN0YXRlRnJvbVVwZGF0ZSh1cGRhdGUsIGluc3RhbmNlLCBwcmV2U3RhdGUsIHByb3BzKSB7CiAgICAgICAgdmFyIHBhcnRpYWxTdGF0ZSA9IHVwZGF0ZS5wYXJ0aWFsU3RhdGU7CgogICAgICAgIGlmICh0eXBlb2YgcGFydGlhbFN0YXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICB2YXIgdXBkYXRlRm4gPSBwYXJ0aWFsU3RhdGU7CgogICAgICAgICAgaWYgKGRlYnVnUmVuZGVyUGhhc2VTaWRlRWZmZWN0cykgewogICAgICAgICAgICB1cGRhdGVGbi5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIHByb3BzKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdXBkYXRlRm4uY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBwcm9wcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBwYXJ0aWFsU3RhdGU7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBwcm9jZXNzVXBkYXRlUXVldWUoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHF1ZXVlLCBpbnN0YW5jZSwgcHJvcHMsIHJlbmRlckV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwgJiYgY3VycmVudC51cGRhdGVRdWV1ZSA9PT0gcXVldWUpIHsKICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBxdWV1ZTsKICAgICAgICAgIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MudXBkYXRlUXVldWUgPSB7CiAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudFF1ZXVlLmJhc2VTdGF0ZSwKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWU6IGN1cnJlbnRRdWV1ZS5leHBpcmF0aW9uVGltZSwKICAgICAgICAgICAgZmlyc3Q6IGN1cnJlbnRRdWV1ZS5maXJzdCwKICAgICAgICAgICAgbGFzdDogY3VycmVudFF1ZXVlLmxhc3QsCiAgICAgICAgICAgIGlzSW5pdGlhbGl6ZWQ6IGN1cnJlbnRRdWV1ZS5pc0luaXRpYWxpemVkLAogICAgICAgICAgICBjYWxsYmFja0xpc3Q6IG51bGwsCiAgICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHsKICAgICAgICAgIHF1ZXVlLmlzUHJvY2Vzc2luZyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHF1ZXVlLmV4cGlyYXRpb25UaW1lID0gTm9Xb3JrOwogICAgICAgIHZhciBzdGF0ZSA9IHZvaWQgMDsKCiAgICAgICAgaWYgKHF1ZXVlLmlzSW5pdGlhbGl6ZWQpIHsKICAgICAgICAgIHN0YXRlID0gcXVldWUuYmFzZVN0YXRlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGF0ZSA9IHF1ZXVlLmJhc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBxdWV1ZS5pc0luaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHZhciBkb250TXV0YXRlUHJldlN0YXRlID0gdHJ1ZTsKICAgICAgICB2YXIgdXBkYXRlID0gcXVldWUuZmlyc3Q7CiAgICAgICAgdmFyIGRpZFNraXAgPSBmYWxzZTsKCiAgICAgICAgd2hpbGUgKHVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgdmFyIHVwZGF0ZUV4cGlyYXRpb25UaW1lID0gdXBkYXRlLmV4cGlyYXRpb25UaW1lOwoKICAgICAgICAgIGlmICh1cGRhdGVFeHBpcmF0aW9uVGltZSA+IHJlbmRlckV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICAgIHZhciByZW1haW5pbmdFeHBpcmF0aW9uVGltZSA9IHF1ZXVlLmV4cGlyYXRpb25UaW1lOwoKICAgICAgICAgICAgaWYgKHJlbWFpbmluZ0V4cGlyYXRpb25UaW1lID09PSBOb1dvcmsgfHwgcmVtYWluaW5nRXhwaXJhdGlvblRpbWUgPiB1cGRhdGVFeHBpcmF0aW9uVGltZSkgewogICAgICAgICAgICAgIHF1ZXVlLmV4cGlyYXRpb25UaW1lID0gdXBkYXRlRXhwaXJhdGlvblRpbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghZGlkU2tpcCkgewogICAgICAgICAgICAgIGRpZFNraXAgPSB0cnVlOwogICAgICAgICAgICAgIHF1ZXVlLmJhc2VTdGF0ZSA9IHN0YXRlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFkaWRTa2lwKSB7CiAgICAgICAgICAgIHF1ZXVlLmZpcnN0ID0gdXBkYXRlLm5leHQ7CgogICAgICAgICAgICBpZiAocXVldWUuZmlyc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBxdWV1ZS5sYXN0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHZhciBfcGFydGlhbFN0YXRlID0gdm9pZCAwOwoKICAgICAgICAgIGlmICh1cGRhdGUuaXNSZXBsYWNlKSB7CiAgICAgICAgICAgIHN0YXRlID0gZ2V0U3RhdGVGcm9tVXBkYXRlKHVwZGF0ZSwgaW5zdGFuY2UsIHN0YXRlLCBwcm9wcyk7CiAgICAgICAgICAgIGRvbnRNdXRhdGVQcmV2U3RhdGUgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX3BhcnRpYWxTdGF0ZSA9IGdldFN0YXRlRnJvbVVwZGF0ZSh1cGRhdGUsIGluc3RhbmNlLCBzdGF0ZSwgcHJvcHMpOwoKICAgICAgICAgICAgaWYgKF9wYXJ0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBpZiAoZG9udE11dGF0ZVByZXZTdGF0ZSkgewogICAgICAgICAgICAgICAgc3RhdGUgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgc3RhdGUsIF9wYXJ0aWFsU3RhdGUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdGF0ZSA9IGJhYmVsSGVscGVycy5leHRlbmRzKHN0YXRlLCBfcGFydGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGRvbnRNdXRhdGVQcmV2U3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmICh1cGRhdGUuaXNGb3JjZWQpIHsKICAgICAgICAgICAgcXVldWUuaGFzRm9yY2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh1cGRhdGUuY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIF9jYWxsYmFja0xpc3QgPSBxdWV1ZS5jYWxsYmFja0xpc3Q7CgogICAgICAgICAgICBpZiAoX2NhbGxiYWNrTGlzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIF9jYWxsYmFja0xpc3QgPSBxdWV1ZS5jYWxsYmFja0xpc3QgPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NhbGxiYWNrTGlzdC5wdXNoKHVwZGF0ZSk7CiAgICAgICAgICB9CgogICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgfQoKICAgICAgICBpZiAocXVldWUuY2FsbGJhY2tMaXN0ICE9PSBudWxsKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5lZmZlY3RUYWcgfD0gQ2FsbGJhY2s7CiAgICAgICAgfSBlbHNlIGlmIChxdWV1ZS5maXJzdCA9PT0gbnVsbCAmJiAhcXVldWUuaGFzRm9yY2VVcGRhdGUpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmICghZGlkU2tpcCkgewogICAgICAgICAgZGlkU2tpcCA9IHRydWU7CiAgICAgICAgICBxdWV1ZS5iYXNlU3RhdGUgPSBzdGF0ZTsKICAgICAgICB9CgogICAgICAgIHsKICAgICAgICAgIHF1ZXVlLmlzUHJvY2Vzc2luZyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNvbW1pdENhbGxiYWNrcyhxdWV1ZSwgY29udGV4dCkgewogICAgICAgIHZhciBjYWxsYmFja0xpc3QgPSBxdWV1ZS5jYWxsYmFja0xpc3Q7CgogICAgICAgIGlmIChjYWxsYmFja0xpc3QgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHF1ZXVlLmNhbGxiYWNrTGlzdCA9IG51bGw7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2FsbGJhY2tMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY2FsbGJhY2tMaXN0W2ldOwogICAgICAgICAgdmFyIF9jYWxsYmFjayA9IHVwZGF0ZS5jYWxsYmFjazsKICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgICBpbnZhcmlhbnQodHlwZW9mIF9jYWxsYmFjayA9PT0gImZ1bmN0aW9uIiwgIkludmFsaWQgYXJndW1lbnQgcGFzc2VkIGFzIGNhbGxiYWNrLiBFeHBlY3RlZCBhIGZ1bmN0aW9uLiBJbnN0ZWFkICIgKyAicmVjZWl2ZWQ6ICVzIiwgX2NhbGxiYWNrKTsKCiAgICAgICAgICBfY2FsbGJhY2suY2FsbChjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBmYWtlSW50ZXJuYWxJbnN0YW5jZSA9IHt9OwogICAgICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7CiAgICAgIHsKICAgICAgICB2YXIgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50ID0ge307CgogICAgICAgIHZhciB3YXJuT25JbnZhbGlkQ2FsbGJhY2sgPSBmdW5jdGlvbiB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgIHdhcm5pbmcoY2FsbGJhY2sgPT09IG51bGwgfHwgdHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iLCAiJXMoLi4uKTogRXhwZWN0ZWQgdGhlIGxhc3Qgb3B0aW9uYWwgYGNhbGxiYWNrYCBhcmd1bWVudCB0byBiZSBhICIgKyAiZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxlck5hbWUsIGNhbGxiYWNrKTsKICAgICAgICB9OwoKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmFrZUludGVybmFsSW5zdGFuY2UsICJfcHJvY2Vzc0NoaWxkQ29udGV4dCIsIHsKICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICBpbnZhcmlhbnQoZmFsc2UsICJfcHJvY2Vzc0NoaWxkQ29udGV4dCBpcyBub3QgYXZhaWxhYmxlIGluIFJlYWN0IDE2Ky4gVGhpcyBsaWtlbHkgIiArICJtZWFucyB5b3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgYW5kIGFyZSBhdHRlbXB0aW5nIHRvIG5lc3QgIiArICJhIFJlYWN0IDE1IHRyZWUgaW5zaWRlIGEgUmVhY3QgMTYgdHJlZSB1c2luZyAiICsgInVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyLCB3aGljaCBpc24ndCBzdXBwb3J0ZWQuIFRyeSAiICsgInRvIG1ha2Ugc3VyZSB5b3UgaGF2ZSBvbmx5IG9uZSBjb3B5IG9mIFJlYWN0IChhbmQgaWRlYWxseSwgc3dpdGNoICIgKyAidG8gUmVhY3RET00uY3JlYXRlUG9ydGFsKS4iKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBPYmplY3QuZnJlZXplKGZha2VJbnRlcm5hbEluc3RhbmNlKTsKICAgICAgfQoKICAgICAgdmFyIFJlYWN0RmliZXJDbGFzc0NvbXBvbmVudCA9IGZ1bmN0aW9uIFJlYWN0RmliZXJDbGFzc0NvbXBvbmVudChzY2hlZHVsZVdvcmssIGNvbXB1dGVFeHBpcmF0aW9uRm9yRmliZXIsIG1lbW9pemVQcm9wcywgbWVtb2l6ZVN0YXRlKSB7CiAgICAgICAgdmFyIHVwZGF0ZXIgPSB7CiAgICAgICAgICBpc01vdW50ZWQ6IGlzTW91bnRlZCwKICAgICAgICAgIGVucXVldWVTZXRTdGF0ZTogZnVuY3Rpb24gZW5xdWV1ZVNldFN0YXRlKGluc3RhbmNlLCBwYXJ0aWFsU3RhdGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldChpbnN0YW5jZSk7CiAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPT09IHVuZGVmaW5lZCA/IG51bGwgOiBjYWxsYmFjazsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gY29tcHV0ZUV4cGlyYXRpb25Gb3JGaWJlcihmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSB7CiAgICAgICAgICAgICAgZXhwaXJhdGlvblRpbWU6IGV4cGlyYXRpb25UaW1lLAogICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZTogcGFydGlhbFN0YXRlLAogICAgICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICAgICAgICBpc1JlcGxhY2U6IGZhbHNlLAogICAgICAgICAgICAgIGlzRm9yY2VkOiBmYWxzZSwKICAgICAgICAgICAgICBuZXh0Q2FsbGJhY2s6IG51bGwsCiAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBpbnNlcnRVcGRhdGVJbnRvRmliZXIoZmliZXIsIHVwZGF0ZSk7CiAgICAgICAgICAgIHNjaGVkdWxlV29yayhmaWJlciwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfSwKICAgICAgICAgIGVucXVldWVSZXBsYWNlU3RhdGU6IGZ1bmN0aW9uIGVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIHN0YXRlLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQoaW5zdGFuY2UpOwogICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrID09PSB1bmRlZmluZWQgPyBudWxsIDogY2FsbGJhY2s7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJyZXBsYWNlU3RhdGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWUgPSBjb21wdXRlRXhwaXJhdGlvbkZvckZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgICBleHBpcmF0aW9uVGltZTogZXhwaXJhdGlvblRpbWUsCiAgICAgICAgICAgICAgcGFydGlhbFN0YXRlOiBzdGF0ZSwKICAgICAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgICAgICAgaXNSZXBsYWNlOiB0cnVlLAogICAgICAgICAgICAgIGlzRm9yY2VkOiBmYWxzZSwKICAgICAgICAgICAgICBuZXh0Q2FsbGJhY2s6IG51bGwsCiAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBpbnNlcnRVcGRhdGVJbnRvRmliZXIoZmliZXIsIHVwZGF0ZSk7CiAgICAgICAgICAgIHNjaGVkdWxlV29yayhmaWJlciwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfSwKICAgICAgICAgIGVucXVldWVGb3JjZVVwZGF0ZTogZnVuY3Rpb24gZW5xdWV1ZUZvcmNlVXBkYXRlKGluc3RhbmNlLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQoaW5zdGFuY2UpOwogICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrID09PSB1bmRlZmluZWQgPyBudWxsIDogY2FsbGJhY2s7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZSA9IGNvbXB1dGVFeHBpcmF0aW9uRm9yRmliZXIoZmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gewogICAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lOiBleHBpcmF0aW9uVGltZSwKICAgICAgICAgICAgICBwYXJ0aWFsU3RhdGU6IG51bGwsCiAgICAgICAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgICAgICAgIGlzUmVwbGFjZTogZmFsc2UsCiAgICAgICAgICAgICAgaXNGb3JjZWQ6IHRydWUsCiAgICAgICAgICAgICAgbmV4dENhbGxiYWNrOiBudWxsLAogICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaW5zZXJ0VXBkYXRlSW50b0ZpYmVyKGZpYmVyLCB1cGRhdGUpOwogICAgICAgICAgICBzY2hlZHVsZVdvcmsoZmliZXIsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBjaGVja1Nob3VsZENvbXBvbmVudFVwZGF0ZSh3b3JrSW5Qcm9ncmVzcywgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5ld0NvbnRleHQpIHsKICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbnVsbCB8fCB3b3JrSW5Qcm9ncmVzcy51cGRhdGVRdWV1ZSAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzcy51cGRhdGVRdWV1ZS5oYXNGb3JjZVVwZGF0ZSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzLnR5cGU7CgogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgc3RhcnRQaGFzZVRpbWVyKHdvcmtJblByb2dyZXNzLCAic2hvdWxkQ29tcG9uZW50VXBkYXRlIik7CiAgICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXdDb250ZXh0KTsKICAgICAgICAgICAgc3RvcFBoYXNlVGltZXIoKTsKCiAgICAgICAgICAgIGlmIChkZWJ1Z1JlbmRlclBoYXNlU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXdDb250ZXh0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdhcm5pbmcoc2hvdWxkVXBkYXRlICE9PSB1bmRlZmluZWQsICIlcy5zaG91bGRDb21wb25lbnRVcGRhdGUoKTogUmV0dXJuZWQgdW5kZWZpbmVkIGluc3RlYWQgb2YgYSAiICsgImJvb2xlYW4gdmFsdWUuIE1ha2Ugc3VyZSB0byByZXR1cm4gdHJ1ZSBvciBmYWxzZS4iLCBnZXRDb21wb25lbnROYW1lKHdvcmtJblByb2dyZXNzKSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHR5cGUucHJvdG90eXBlICYmIHR5cGUucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybiAhc2hhbGxvd0VxdWFsKG9sZFByb3BzLCBuZXdQcm9wcykgfHwgIXNoYWxsb3dFcXVhbChvbGRTdGF0ZSwgbmV3U3RhdGUpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2hlY2tDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzLnR5cGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZSh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgIHZhciByZW5kZXJQcmVzZW50ID0gaW5zdGFuY2UucmVuZGVyOwoKICAgICAgICAgICAgaWYgKCFyZW5kZXJQcmVzZW50KSB7CiAgICAgICAgICAgICAgaWYgKHR5cGUucHJvdG90eXBlICYmIHR5cGVvZiB0eXBlLnByb3RvdHlwZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICIlcyguLi4pOiBObyBgcmVuZGVyYCBtZXRob2QgZm91bmQgb24gdGhlIHJldHVybmVkIGNvbXBvbmVudCAiICsgImluc3RhbmNlOiBkaWQgeW91IGFjY2lkZW50YWxseSByZXR1cm4gYW4gb2JqZWN0IGZyb20gdGhlIGNvbnN0cnVjdG9yPyIsIG5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAiJXMoLi4uKTogTm8gYHJlbmRlcmAgbWV0aG9kIGZvdW5kIG9uIHRoZSByZXR1cm5lZCBjb21wb25lbnQgIiArICJpbnN0YW5jZTogeW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBkZWZpbmUgYHJlbmRlcmAuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbm9HZXRJbml0aWFsU3RhdGVPbkVTNiA9ICFpbnN0YW5jZS5nZXRJbml0aWFsU3RhdGUgfHwgaW5zdGFuY2UuZ2V0SW5pdGlhbFN0YXRlLmlzUmVhY3RDbGFzc0FwcHJvdmVkIHx8IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgICB3YXJuaW5nKG5vR2V0SW5pdGlhbFN0YXRlT25FUzYsICJnZXRJbml0aWFsU3RhdGUgd2FzIGRlZmluZWQgb24gJXMsIGEgcGxhaW4gSmF2YVNjcmlwdCBjbGFzcy4gIiArICJUaGlzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBjbGFzc2VzIGNyZWF0ZWQgdXNpbmcgUmVhY3QuY3JlYXRlQ2xhc3MuICIgKyAiRGlkIHlvdSBtZWFuIHRvIGRlZmluZSBhIHN0YXRlIHByb3BlcnR5IGluc3RlYWQ/IiwgbmFtZSk7CiAgICAgICAgICAgIHZhciBub0dldERlZmF1bHRQcm9wc09uRVM2ID0gIWluc3RhbmNlLmdldERlZmF1bHRQcm9wcyB8fCBpbnN0YW5jZS5nZXREZWZhdWx0UHJvcHMuaXNSZWFjdENsYXNzQXBwcm92ZWQ7CiAgICAgICAgICAgIHdhcm5pbmcobm9HZXREZWZhdWx0UHJvcHNPbkVTNiwgImdldERlZmF1bHRQcm9wcyB3YXMgZGVmaW5lZCBvbiAlcywgYSBwbGFpbiBKYXZhU2NyaXB0IGNsYXNzLiAiICsgIlRoaXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGNsYXNzZXMgY3JlYXRlZCB1c2luZyBSZWFjdC5jcmVhdGVDbGFzcy4gIiArICJVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGRlZmF1bHRQcm9wcyBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICB2YXIgbm9JbnN0YW5jZVByb3BUeXBlcyA9ICFpbnN0YW5jZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIHdhcm5pbmcobm9JbnN0YW5jZVByb3BUeXBlcywgInByb3BUeXBlcyB3YXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcy4gVXNlIGEgc3RhdGljICIgKyAicHJvcGVydHkgdG8gZGVmaW5lIHByb3BUeXBlcyBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICB2YXIgbm9JbnN0YW5jZUNvbnRleHRUeXBlcyA9ICFpbnN0YW5jZS5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgIHdhcm5pbmcobm9JbnN0YW5jZUNvbnRleHRUeXBlcywgImNvbnRleHRUeXBlcyB3YXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcy4gVXNlIGEgc3RhdGljICIgKyAicHJvcGVydHkgdG8gZGVmaW5lIGNvbnRleHRUeXBlcyBpbnN0ZWFkLiIsIG5hbWUpOwogICAgICAgICAgICB2YXIgbm9Db21wb25lbnRTaG91bGRVcGRhdGUgPSB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50U2hvdWxkVXBkYXRlICE9PSAiZnVuY3Rpb24iOwogICAgICAgICAgICB3YXJuaW5nKG5vQ29tcG9uZW50U2hvdWxkVXBkYXRlLCAiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCAiICsgImNvbXBvbmVudFNob3VsZFVwZGF0ZSgpLiBEaWQgeW91IG1lYW4gc2hvdWxkQ29tcG9uZW50VXBkYXRlKCk/ICIgKyAiVGhlIG5hbWUgaXMgcGhyYXNlZCBhcyBhIHF1ZXN0aW9uIGJlY2F1c2UgdGhlIGZ1bmN0aW9uIGlzICIgKyAiZXhwZWN0ZWQgdG8gcmV0dXJuIGEgdmFsdWUuIiwgbmFtZSk7CgogICAgICAgICAgICBpZiAodHlwZS5wcm90b3R5cGUgJiYgdHlwZS5wcm90b3R5cGUuaXNQdXJlUmVhY3RDb21wb25lbnQgJiYgdHlwZW9mIGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBzaG91bGRDb21wb25lbnRVcGRhdGUoKS4gIiArICJzaG91bGRDb21wb25lbnRVcGRhdGUgc2hvdWxkIG5vdCBiZSB1c2VkIHdoZW4gZXh0ZW5kaW5nIFJlYWN0LlB1cmVDb21wb25lbnQuICIgKyAiUGxlYXNlIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaWYgc2hvdWxkQ29tcG9uZW50VXBkYXRlIGlzIHVzZWQuIiwgZ2V0Q29tcG9uZW50TmFtZSh3b3JrSW5Qcm9ncmVzcykgfHwgIkEgcHVyZSBjb21wb25lbnQiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG5vQ29tcG9uZW50RGlkVW5tb3VudCA9IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVbm1vdW50ICE9PSAiZnVuY3Rpb24iOwogICAgICAgICAgICB3YXJuaW5nKG5vQ29tcG9uZW50RGlkVW5tb3VudCwgIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgIiArICJjb21wb25lbnREaWRVbm1vdW50KCkuIEJ1dCB0aGVyZSBpcyBubyBzdWNoIGxpZmVjeWNsZSBtZXRob2QuICIgKyAiRGlkIHlvdSBtZWFuIGNvbXBvbmVudFdpbGxVbm1vdW50KCk/IiwgbmFtZSk7CiAgICAgICAgICAgIHZhciBub0NvbXBvbmVudERpZFJlY2VpdmVQcm9wcyA9IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRSZWNlaXZlUHJvcHMgIT09ICJmdW5jdGlvbiI7CiAgICAgICAgICAgIHdhcm5pbmcobm9Db21wb25lbnREaWRSZWNlaXZlUHJvcHMsICIlcyBoYXMgYSBtZXRob2QgY2FsbGVkICIgKyAiY29tcG9uZW50RGlkUmVjZWl2ZVByb3BzKCkuIEJ1dCB0aGVyZSBpcyBubyBzdWNoIGxpZmVjeWNsZSBtZXRob2QuICIgKyAiSWYgeW91IG1lYW50IHRvIHVwZGF0ZSB0aGUgc3RhdGUgaW4gcmVzcG9uc2UgdG8gY2hhbmdpbmcgcHJvcHMsICIgKyAidXNlIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKS4gSWYgeW91IG1lYW50IHRvIGZldGNoIGRhdGEgb3IgIiArICJydW4gc2lkZS1lZmZlY3RzIG9yIG11dGF0aW9ucyBhZnRlciBSZWFjdCBoYXMgdXBkYXRlZCB0aGUgVUksIHVzZSBjb21wb25lbnREaWRVcGRhdGUoKS4iLCBuYW1lKTsKICAgICAgICAgICAgdmFyIG5vQ29tcG9uZW50V2lsbFJlY2lldmVQcm9wcyA9IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzICE9PSAiZnVuY3Rpb24iOwogICAgICAgICAgICB3YXJuaW5nKG5vQ29tcG9uZW50V2lsbFJlY2lldmVQcm9wcywgIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgIiArICJjb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzKCkuIERpZCB5b3UgbWVhbiBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCk/IiwgbmFtZSk7CiAgICAgICAgICAgIHZhciBoYXNNdXRhdGVkUHJvcHMgPSBpbnN0YW5jZS5wcm9wcyAhPT0gd29ya0luUHJvZ3Jlc3MucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB3YXJuaW5nKGluc3RhbmNlLnByb3BzID09PSB1bmRlZmluZWQgfHwgIWhhc011dGF0ZWRQcm9wcywgIiVzKC4uLik6IFdoZW4gY2FsbGluZyBzdXBlcigpIGluIGAlc2AsIG1ha2Ugc3VyZSB0byBwYXNzICIgKyAidXAgdGhlIHNhbWUgcHJvcHMgdGhhdCB5b3VyIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yIHdhcyBwYXNzZWQuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIHZhciBub0luc3RhbmNlRGVmYXVsdFByb3BzID0gIWluc3RhbmNlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgd2FybmluZyhub0luc3RhbmNlRGVmYXVsdFByb3BzLCAiU2V0dGluZyBkZWZhdWx0UHJvcHMgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiIgKyAiIEluc3RlYWQsIGRlZmluZSBkZWZhdWx0UHJvcHMgYXMgYSBzdGF0aWMgcHJvcGVydHkgb24gJXMuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKCiAgICAgICAgICBpZiAoc3RhdGUgJiYgKHR5cGVvZiBzdGF0ZSAhPT0gIm9iamVjdCIgfHwgaXNBcnJheShzdGF0ZSkpKSB7CiAgICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICIlcy5zdGF0ZTogbXVzdCBiZSBzZXQgdG8gYW4gb2JqZWN0IG9yIG51bGwiLCBnZXRDb21wb25lbnROYW1lKHdvcmtJblByb2dyZXNzKSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgd2FybmluZyh0eXBlb2Ygd29ya0luUHJvZ3Jlc3MudHlwZS5jaGlsZENvbnRleHRUeXBlcyA9PT0gIm9iamVjdCIsICIlcy5nZXRDaGlsZENvbnRleHQoKTogY2hpbGRDb250ZXh0VHlwZXMgbXVzdCBiZSBkZWZpbmVkIGluIG9yZGVyIHRvICIgKyAidXNlIGdldENoaWxkQ29udGV4dCgpLiIsIGdldENvbXBvbmVudE5hbWUod29ya0luUHJvZ3Jlc3MpKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlc2V0SW5wdXRQb2ludGVycyh3b3JrSW5Qcm9ncmVzcywgaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRTdGF0ZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzcywgaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZXIgPSB1cGRhdGVyOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlID0gaW5zdGFuY2U7CiAgICAgICAgICBzZXQoaW5zdGFuY2UsIHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaW5zdGFuY2UuX3JlYWN0SW50ZXJuYWxJbnN0YW5jZSA9IGZha2VJbnRlcm5hbEluc3RhbmNlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzcywgcHJvcHMpIHsKICAgICAgICAgIHZhciBjdG9yID0gd29ya0luUHJvZ3Jlc3MudHlwZTsKICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgdmFyIG5lZWRzQ29udGV4dCA9IGlzQ29udGV4dENvbnN1bWVyKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIHZhciBjb250ZXh0ID0gbmVlZHNDb250ZXh0ID8gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzcywgdW5tYXNrZWRDb250ZXh0KSA6IGVtcHR5T2JqZWN0OwogICAgICAgICAgdmFyIGluc3RhbmNlID0gbmV3IGN0b3IocHJvcHMsIGNvbnRleHQpOwogICAgICAgICAgYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzLCBpbnN0YW5jZSk7CgogICAgICAgICAgaWYgKG5lZWRzQ29udGV4dCkgewogICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MsIHVubWFza2VkQ29udGV4dCwgY29udGV4dCk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxNb3VudCh3b3JrSW5Qcm9ncmVzcywgaW5zdGFuY2UpIHsKICAgICAgICAgIHN0YXJ0UGhhc2VUaW1lcih3b3JrSW5Qcm9ncmVzcywgImNvbXBvbmVudFdpbGxNb3VudCIpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgIHN0b3BQaGFzZVRpbWVyKCk7CgogICAgICAgICAgaWYgKGRlYnVnUmVuZGVyUGhhc2VTaWRlRWZmZWN0cykgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAob2xkU3RhdGUgIT09IGluc3RhbmNlLnN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAiJXMuY29tcG9uZW50V2lsbE1vdW50KCk6IEFzc2lnbmluZyBkaXJlY3RseSB0byB0aGlzLnN0YXRlIGlzICIgKyAiZGVwcmVjYXRlZCAoZXhjZXB0IGluc2lkZSBhIGNvbXBvbmVudCdzICIgKyAiY29uc3RydWN0b3IpLiBVc2Ugc2V0U3RhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lKHdvcmtJblByb2dyZXNzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlci5lbnF1ZXVlUmVwbGFjZVN0YXRlKGluc3RhbmNlLCBpbnN0YW5jZS5zdGF0ZSwgbnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzcywgaW5zdGFuY2UsIG5ld1Byb3BzLCBuZXdDb250ZXh0KSB7CiAgICAgICAgICBzdGFydFBoYXNlVGltZXIod29ya0luUHJvZ3Jlc3MsICJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIik7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV3UHJvcHMsIG5ld0NvbnRleHQpOwogICAgICAgICAgc3RvcFBoYXNlVGltZXIoKTsKCiAgICAgICAgICBpZiAoZGVidWdSZW5kZXJQaGFzZVNpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV3UHJvcHMsIG5ld0NvbnRleHQpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gb2xkU3RhdGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZSh3b3JrSW5Qcm9ncmVzcykgfHwgIkNvbXBvbmVudCI7CgogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAiJXMuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpOiBBc3NpZ25pbmcgZGlyZWN0bHkgdG8gIiArICJ0aGlzLnN0YXRlIGlzIGRlcHJlY2F0ZWQgKGV4Y2VwdCBpbnNpZGUgYSBjb21wb25lbnQncyAiICsgImNvbnN0cnVjdG9yKS4gVXNlIHNldFN0YXRlIGluc3RlYWQuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdGF0ZUFzc2lnbm1lbnRGb3JDb21wb25lbnRbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzcywgcmVuZGVyRXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIHZhciBjdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MuYWx0ZXJuYXRlOwogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHN0YXRlID0gaW5zdGFuY2Uuc3RhdGUgfHwgbnVsbDsKICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBwcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRTdGF0ZSA9IHN0YXRlOwogICAgICAgICAgaW5zdGFuY2UucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MsIHVubWFza2VkQ29udGV4dCk7CgogICAgICAgICAgaWYgKGVuYWJsZUFzeW5jU3VidHJlZUFQSSAmJiB3b3JrSW5Qcm9ncmVzcy50eXBlICE9IG51bGwgJiYgd29ya0luUHJvZ3Jlc3MudHlwZS5wcm90b3R5cGUgIT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzcy50eXBlLnByb3RvdHlwZS51bnN0YWJsZV9pc0FzeW5jUmVhY3RDb21wb25lbnQgPT09IHRydWUpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MuaW50ZXJuYWxDb250ZXh0VGFnIHw9IEFzeW5jVXBkYXRlczsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbE1vdW50KHdvcmtJblByb2dyZXNzLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IHdvcmtJblByb2dyZXNzLnVwZGF0ZVF1ZXVlOwoKICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBwcm9jZXNzVXBkYXRlUXVldWUoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHVwZGF0ZVF1ZXVlLCBpbnN0YW5jZSwgcHJvcHMsIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MuZWZmZWN0VGFnIHw9IFVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzSW5zdGFuY2UoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGU7CiAgICAgICAgICByZXNldElucHV0UG9pbnRlcnMod29ya0luUHJvZ3Jlc3MsIGluc3RhbmNlKTsKICAgICAgICAgIHZhciBvbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzcy5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgb2xkQ29udGV4dCA9IGluc3RhbmNlLmNvbnRleHQ7CiAgICAgICAgICB2YXIgbmV3VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIHZhciBuZXdDb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzcywgbmV3VW5tYXNrZWRDb250ZXh0KTsKCiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgKG9sZFByb3BzICE9PSBuZXdQcm9wcyB8fCBvbGRDb250ZXh0ICE9PSBuZXdDb250ZXh0KSkgewogICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzcywgaW5zdGFuY2UsIG5ld1Byb3BzLCBuZXdDb250ZXh0KTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIG5ld1N0YXRlID0gdm9pZCAwOwoKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcy51cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBuZXdTdGF0ZSA9IHByb2Nlc3NVcGRhdGVRdWV1ZShjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgd29ya0luUHJvZ3Jlc3MudXBkYXRlUXVldWUsIGluc3RhbmNlLCBuZXdQcm9wcywgcmVuZGVyRXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV3U3RhdGUgPSBvbGRTdGF0ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAob2xkUHJvcHMgPT09IG5ld1Byb3BzICYmIG9sZFN0YXRlID09PSBuZXdTdGF0ZSAmJiAhaGFzQ29udGV4dENoYW5nZWQoKSAmJiAhKHdvcmtJblByb2dyZXNzLnVwZGF0ZVF1ZXVlICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzLnVwZGF0ZVF1ZXVlLmhhc0ZvcmNlVXBkYXRlKSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gY3VycmVudC5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50Lm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV3Q29udGV4dCk7CgogICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBzdGFydFBoYXNlVGltZXIod29ya0luUHJvZ3Jlc3MsICJjb21wb25lbnRXaWxsVXBkYXRlIik7CiAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5ld0NvbnRleHQpOwogICAgICAgICAgICAgIHN0b3BQaGFzZVRpbWVyKCk7CgogICAgICAgICAgICAgIGlmIChkZWJ1Z1JlbmRlclBoYXNlU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXdDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MuZWZmZWN0VGFnIHw9IFVwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IGN1cnJlbnQubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudC5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5lZmZlY3RUYWcgfD0gVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWVtb2l6ZVByb3BzKHdvcmtJblByb2dyZXNzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG1lbW9pemVTdGF0ZSh3b3JrSW5Qcm9ncmVzcywgbmV3U3RhdGUpOwogICAgICAgICAgfQoKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IG5ld0NvbnRleHQ7CiAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZTogYWRvcHRDbGFzc0luc3RhbmNlLAogICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZTogY29uc3RydWN0Q2xhc3NJbnN0YW5jZSwKICAgICAgICAgIG1vdW50Q2xhc3NJbnN0YW5jZTogbW91bnRDbGFzc0luc3RhbmNlLAogICAgICAgICAgdXBkYXRlQ2xhc3NJbnN0YW5jZTogdXBkYXRlQ2xhc3NJbnN0YW5jZQogICAgICAgIH07CiAgICAgIH07CgogICAgICB2YXIgZ2V0Q3VycmVudEZpYmVyU3RhY2tBZGRlbmR1bSQxID0gUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5nZXRDdXJyZW50RmliZXJTdGFja0FkZGVuZHVtOwogICAgICB7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICB2YXIgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgdmFyIG93bmVySGFzRnVuY3Rpb25UeXBlV2FybmluZyA9IHt9OwoKICAgICAgICB2YXIgd2FybkZvck1pc3NpbmdLZXkgPSBmdW5jdGlvbiB3YXJuRm9yTWlzc2luZ0tleShjaGlsZCkgewogICAgICAgICAgaWYgKGNoaWxkID09PSBudWxsIHx8IHR5cGVvZiBjaGlsZCAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghY2hpbGQuX3N0b3JlIHx8IGNoaWxkLl9zdG9yZS52YWxpZGF0ZWQgfHwgY2hpbGQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGludmFyaWFudCh0eXBlb2YgY2hpbGQuX3N0b3JlID09PSAib2JqZWN0IiwgIlJlYWN0IENvbXBvbmVudCBpbiB3YXJuRm9yTWlzc2luZ0tleSBzaG91bGQgaGF2ZSBhIF9zdG9yZS4gIiArICJUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgY2hpbGQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICB2YXIgY3VycmVudENvbXBvbmVudEVycm9ySW5mbyA9ICJFYWNoIGNoaWxkIGluIGFuIGFycmF5IG9yIGl0ZXJhdG9yIHNob3VsZCBoYXZlIGEgdW5pcXVlICIgKyAnImtleSIgcHJvcC4gU2VlIGh0dHBzOi8vZmIubWUvcmVhY3Qtd2FybmluZy1rZXlzIGZvciAnICsgIm1vcmUgaW5mb3JtYXRpb24uIiArIChnZXRDdXJyZW50RmliZXJTdGFja0FkZGVuZHVtJDEoKSB8fCAiIik7CgogICAgICAgICAgaWYgKG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dID0gdHJ1ZTsKICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICJFYWNoIGNoaWxkIGluIGFuIGFycmF5IG9yIGl0ZXJhdG9yIHNob3VsZCBoYXZlIGEgdW5pcXVlICIgKyAnImtleSIgcHJvcC4gU2VlIGh0dHBzOi8vZmIubWUvcmVhY3Qtd2FybmluZy1rZXlzIGZvciAnICsgIm1vcmUgaW5mb3JtYXRpb24uJXMiLCBnZXRDdXJyZW50RmliZXJTdGFja0FkZGVuZHVtJDEoKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICB2YXIgaXNBcnJheSQxID0gQXJyYXkuaXNBcnJheTsKCiAgICAgIGZ1bmN0aW9uIGNvZXJjZVJlZihjdXJyZW50LCBlbGVtZW50KSB7CiAgICAgICAgdmFyIG1peGVkUmVmID0gZWxlbWVudC5yZWY7CgogICAgICAgIGlmIChtaXhlZFJlZiAhPT0gbnVsbCAmJiB0eXBlb2YgbWl4ZWRSZWYgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGlmIChlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgdmFyIGluc3QgPSB2b2lkIDA7CgogICAgICAgICAgICBpZiAob3duZXIpIHsKICAgICAgICAgICAgICB2YXIgb3duZXJGaWJlciA9IG93bmVyOwogICAgICAgICAgICAgIGludmFyaWFudChvd25lckZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQsICJTdGF0ZWxlc3MgZnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgaGF2ZSByZWZzLiIpOwogICAgICAgICAgICAgIGluc3QgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaW52YXJpYW50KGluc3QsICJNaXNzaW5nIG93bmVyIGZvciBzdHJpbmcgcmVmICVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSAiICsgImJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgbWl4ZWRSZWYpOwogICAgICAgICAgICB2YXIgc3RyaW5nUmVmID0gIiIgKyBtaXhlZFJlZjsKCiAgICAgICAgICAgIGlmIChjdXJyZW50ICE9PSBudWxsICYmIGN1cnJlbnQucmVmICE9PSBudWxsICYmIGN1cnJlbnQucmVmLl9zdHJpbmdSZWYgPT09IHN0cmluZ1JlZikgewogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50LnJlZjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uIHJlZih2YWx1ZSkgewogICAgICAgICAgICAgIHZhciByZWZzID0gaW5zdC5yZWZzID09PSBlbXB0eU9iamVjdCA/IGluc3QucmVmcyA9IHt9IDogaW5zdC5yZWZzOwoKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSByZWZzW3N0cmluZ1JlZl07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlZnNbc3RyaW5nUmVmXSA9IHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJlZi5fc3RyaW5nUmVmID0gc3RyaW5nUmVmOwogICAgICAgICAgICByZXR1cm4gcmVmOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW52YXJpYW50KHR5cGVvZiBtaXhlZFJlZiA9PT0gInN0cmluZyIsICJFeHBlY3RlZCByZWYgdG8gYmUgYSBmdW5jdGlvbiBvciBhIHN0cmluZy4iKTsKICAgICAgICAgICAgaW52YXJpYW50KGVsZW1lbnQuX293bmVyLCAiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoJXMpIGJ1dCBubyBvd25lciB3YXMgIiArICJzZXQuIFlvdSBtYXkgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgbG9hZGVkLiAiICsgIihkZXRhaWxzOiBodHRwczovL2ZiLm1lL3JlYWN0LXJlZnMtbXVzdC1oYXZlLW93bmVyKS4iLCBtaXhlZFJlZik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbWl4ZWRSZWY7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpIHsKICAgICAgICBpZiAocmV0dXJuRmliZXIudHlwZSAhPT0gInRleHRhcmVhIikgewogICAgICAgICAgdmFyIGFkZGVuZHVtID0gIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGFkZGVuZHVtID0gIiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgY29sbGVjdGlvbiBvZiBjaGlsZHJlbiwgdXNlIGFuIGFycmF5ICIgKyAiaW5zdGVhZC4iICsgKGdldEN1cnJlbnRGaWJlclN0YWNrQWRkZW5kdW0kMSgpIHx8ICIiKTsKICAgICAgICAgIH0KICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogJXMpLiVzIiwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG5ld0NoaWxkKSA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKG5ld0NoaWxkKS5qb2luKCIsICIpICsgIn0iIDogbmV3Q2hpbGQsIGFkZGVuZHVtKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHdhcm5PbkZ1bmN0aW9uVHlwZSgpIHsKICAgICAgICB2YXIgY3VycmVudENvbXBvbmVudEVycm9ySW5mbyA9ICJGdW5jdGlvbnMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkLiBUaGlzIG1heSBoYXBwZW4gaWYgIiArICJ5b3UgcmV0dXJuIGEgQ29tcG9uZW50IGluc3RlYWQgb2YgPENvbXBvbmVudCAvPiBmcm9tIHJlbmRlci4gIiArICJPciBtYXliZSB5b3UgbWVhbnQgdG8gY2FsbCB0aGlzIGZ1bmN0aW9uIHJhdGhlciB0aGFuIHJldHVybiBpdC4iICsgKGdldEN1cnJlbnRGaWJlclN0YWNrQWRkZW5kdW0kMSgpIHx8ICIiKTsKCiAgICAgICAgaWYgKG93bmVySGFzRnVuY3Rpb25UeXBlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dID0gdHJ1ZTsKICAgICAgICB3YXJuaW5nKGZhbHNlLCAiRnVuY3Rpb25zIGFyZSBub3QgdmFsaWQgYXMgYSBSZWFjdCBjaGlsZC4gVGhpcyBtYXkgaGFwcGVuIGlmICIgKyAieW91IHJldHVybiBhIENvbXBvbmVudCBpbnN0ZWFkIG9mIDxDb21wb25lbnQgLz4gZnJvbSByZW5kZXIuICIgKyAiT3IgbWF5YmUgeW91IG1lYW50IHRvIGNhbGwgdGhpcyBmdW5jdGlvbiByYXRoZXIgdGhhbiByZXR1cm4gaXQuJXMiLCBnZXRDdXJyZW50RmliZXJTdGFja0FkZGVuZHVtJDEoKSB8fCAiIik7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIENoaWxkUmVjb25jaWxlcihzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgZnVuY3Rpb24gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpIHsKICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGxhc3QgPSByZXR1cm5GaWJlci5sYXN0RWZmZWN0OwoKICAgICAgICAgIGlmIChsYXN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGxhc3QubmV4dEVmZmVjdCA9IGNoaWxkVG9EZWxldGU7CiAgICAgICAgICAgIHJldHVybkZpYmVyLmxhc3RFZmZlY3QgPSBjaGlsZFRvRGVsZXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuRmliZXIuZmlyc3RFZmZlY3QgPSByZXR1cm5GaWJlci5sYXN0RWZmZWN0ID0gY2hpbGRUb0RlbGV0ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBjaGlsZFRvRGVsZXRlLm5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZS5lZmZlY3RUYWcgPSBEZWxldGlvbjsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCkgewogICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gY3VycmVudEZpcnN0Q2hpbGQ7CgogICAgICAgICAgd2hpbGUgKGNoaWxkVG9EZWxldGUgIT09IG51bGwpIHsKICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICBjaGlsZFRvRGVsZXRlID0gY2hpbGRUb0RlbGV0ZS5zaWJsaW5nOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZHJlbiA9IG5ldyBNYXAoKTsKICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CgogICAgICAgICAgd2hpbGUgKGV4aXN0aW5nQ2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2hpbGQua2V5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5rZXksIGV4aXN0aW5nQ2hpbGQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uc2V0KGV4aXN0aW5nQ2hpbGQuaW5kZXgsIGV4aXN0aW5nQ2hpbGQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBleGlzdGluZ0NoaWxkID0gZXhpc3RpbmdDaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBleGlzdGluZ0NoaWxkcmVuOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdXNlRmliZXIoZmliZXIsIHBlbmRpbmdQcm9wcywgZXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIHZhciBjbG9uZSA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGZpYmVyLCBwZW5kaW5nUHJvcHMsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgIGNsb25lLmluZGV4ID0gMDsKICAgICAgICAgIGNsb25lLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgcmV0dXJuIGNsb25lOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJbmRleCkgewogICAgICAgICAgbmV3RmliZXIuaW5kZXggPSBuZXdJbmRleDsKCiAgICAgICAgICBpZiAoIXNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgcmV0dXJuIGxhc3RQbGFjZWRJbmRleDsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgY3VycmVudCA9IG5ld0ZpYmVyLmFsdGVybmF0ZTsKCiAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb2xkSW5kZXggPSBjdXJyZW50LmluZGV4OwoKICAgICAgICAgICAgaWYgKG9sZEluZGV4IDwgbGFzdFBsYWNlZEluZGV4KSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZWZmZWN0VGFnID0gUGxhY2VtZW50OwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG9sZEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdGaWJlci5lZmZlY3RUYWcgPSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwbGFjZVNpbmdsZUNoaWxkKG5ld0ZpYmVyKSB7CiAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cyAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgbmV3RmliZXIuZWZmZWN0VGFnID0gUGxhY2VtZW50OwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBuZXdGaWJlcjsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50LCB0ZXh0Q29udGVudCwgZXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIGlmIChjdXJyZW50ID09PSBudWxsIHx8IGN1cnJlbnQudGFnICE9PSBIb3N0VGV4dCkgewogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQodGV4dENvbnRlbnQsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICBjcmVhdGVkWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQsIHRleHRDb250ZW50LCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgIGV4aXN0aW5nWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50LCBlbGVtZW50LCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwgJiYgY3VycmVudC50eXBlID09PSBlbGVtZW50LnR5cGUpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudCwgZWxlbWVudC5wcm9wcywgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICBleGlzdGluZy5yZWYgPSBjb2VyY2VSZWYoY3VycmVudCwgZWxlbWVudCk7CiAgICAgICAgICAgIGV4aXN0aW5nWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgIGV4aXN0aW5nLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICBjcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihjdXJyZW50LCBlbGVtZW50KTsKICAgICAgICAgICAgY3JlYXRlZFsicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDYWxsKHJldHVybkZpYmVyLCBjdXJyZW50LCBjYWxsLCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgaWYgKGN1cnJlbnQgPT09IG51bGwgfHwgY3VycmVudC50YWcgIT09IENhbGxDb21wb25lbnQpIHsKICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21DYWxsKGNhbGwsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICBjcmVhdGVkWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQsIGNhbGwsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgZXhpc3RpbmdbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJldHVybihyZXR1cm5GaWJlciwgY3VycmVudCwgcmV0dXJuTm9kZSwgZXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIGlmIChjdXJyZW50ID09PSBudWxsIHx8IGN1cnJlbnQudGFnICE9PSBSZXR1cm5Db21wb25lbnQpIHsKICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21SZXR1cm4ocmV0dXJuTm9kZSwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgIGNyZWF0ZWQudHlwZSA9IHJldHVybk5vZGUudmFsdWU7CiAgICAgICAgICAgIGNyZWF0ZWRbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudCwgbnVsbCwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICBleGlzdGluZy50eXBlID0gcmV0dXJuTm9kZS52YWx1ZTsKICAgICAgICAgICAgZXhpc3RpbmdbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudCwgcG9ydGFsLCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgaWYgKGN1cnJlbnQgPT09IG51bGwgfHwgY3VycmVudC50YWcgIT09IEhvc3RQb3J0YWwgfHwgY3VycmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyAhPT0gcG9ydGFsLmNvbnRhaW5lckluZm8gfHwgY3VycmVudC5zdGF0ZU5vZGUuaW1wbGVtZW50YXRpb24gIT09IHBvcnRhbC5pbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICBjcmVhdGVkWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQsIHBvcnRhbC5jaGlsZHJlbiB8fCBbXSwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICBleGlzdGluZ1sicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQocmV0dXJuRmliZXIsIGN1cnJlbnQsIGZyYWdtZW50LCBleHBpcmF0aW9uVGltZSwga2V5KSB7CiAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCB8fCBjdXJyZW50LnRhZyAhPT0gRnJhZ21lbnQpIHsKICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmcmFnbWVudCwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSwga2V5KTsKICAgICAgICAgICAgY3JlYXRlZFsicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50LCBmcmFnbWVudCwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICBleGlzdGluZ1sicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIG5ld0NoaWxkLCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQoIiIgKyBuZXdDaGlsZCwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgIGNyZWF0ZWRbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkLnR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChuZXdDaGlsZC5wcm9wcy5jaGlsZHJlbiwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSwgbmV3Q2hpbGQua2V5KTsKCiAgICAgICAgICAgICAgICAgICAgX2NyZWF0ZWRbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDIgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KG5ld0NoaWxkLCByZXR1cm5GaWJlci5pbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQyLnJlZiA9IGNvZXJjZVJlZihudWxsLCBuZXdDaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQyWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DQUxMX1RZUEU6CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDMgPSBjcmVhdGVGaWJlckZyb21DYWxsKG5ld0NoaWxkLCByZXR1cm5GaWJlci5pbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkM1sicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkMzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9SRVRVUk5fVFlQRToKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIF9jcmVhdGVkNCA9IGNyZWF0ZUZpYmVyRnJvbVJldHVybihuZXdDaGlsZCwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSk7CgogICAgICAgICAgICAgICAgICBfY3JlYXRlZDQudHlwZSA9IG5ld0NoaWxkLnZhbHVlOwogICAgICAgICAgICAgICAgICBfY3JlYXRlZDRbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDUgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwobmV3Q2hpbGQsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpOwoKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQ1WyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQ1OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNBcnJheSQxKG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgIHZhciBfY3JlYXRlZDYgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChuZXdDaGlsZCwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSwgbnVsbCk7CgogICAgICAgICAgICAgIF9jcmVhdGVkNlsicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQ2OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgIH0KCiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICB2YXIga2V5ID0gb2xkRmliZXIgIT09IG51bGwgPyBvbGRGaWJlci5rZXkgOiBudWxsOwoKICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG9sZEZpYmVyLCAiIiArIG5ld0NoaWxkLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQucHJvcHMuY2hpbGRyZW4sIGV4cGlyYXRpb25UaW1lLCBrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVsZW1lbnQocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ0FMTF9UWVBFOgogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2FsbChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9SRVRVUk5fVFlQRToKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZXR1cm4ocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXdDaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0FycmF5JDEobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJhZ21lbnQocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUsIG51bGwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgIH0KCiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIG5ld0NoaWxkLCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICB2YXIgbWF0Y2hlZEZpYmVyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3SWR4KSB8fCBudWxsOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG1hdGNoZWRGaWJlciwgIiIgKyBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdDaGlsZC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGw7CgogICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudChyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlciwgbmV3Q2hpbGQucHJvcHMuY2hpbGRyZW4sIGV4cGlyYXRpb25UaW1lLCBuZXdDaGlsZC5rZXkpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlciwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DQUxMX1RZUEU6CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyMiA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0NoaWxkLmtleSA9PT0gbnVsbCA/IG5ld0lkeCA6IG5ld0NoaWxkLmtleSkgfHwgbnVsbDsKCiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsKHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyMiwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9SRVRVUk5fVFlQRToKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIzID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3SWR4KSB8fCBudWxsOwoKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJldHVybihyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlcjMsIG5ld0NoaWxkLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyNCA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0NoaWxkLmtleSA9PT0gbnVsbCA/IG5ld0lkeCA6IG5ld0NoaWxkLmtleSkgfHwgbnVsbDsKCiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIF9tYXRjaGVkRmliZXI0LCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNBcnJheSQxKG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyNSA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0lkeCkgfHwgbnVsbDsKCiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50KHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyNSwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lLCBudWxsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICB9CgogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gd2Fybk9uSW52YWxpZEtleShjaGlsZCwga25vd25LZXlzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiIHx8IGNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGtub3duS2V5czsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dpdGNoIChjaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ0FMTF9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICB3YXJuRm9yTWlzc2luZ0tleShjaGlsZCk7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gY2hpbGQua2V5OwoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoa25vd25LZXlzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAga25vd25LZXlzLmFkZChrZXkpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIWtub3duS2V5cy5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICJFbmNvdW50ZXJlZCB0d28gY2hpbGRyZW4gd2l0aCB0aGUgc2FtZSBrZXksIGAlc2AuICIgKyAiS2V5cyBzaG91bGQgYmUgdW5pcXVlIHNvIHRoYXQgY29tcG9uZW50cyBtYWludGFpbiB0aGVpciBpZGVudGl0eSAiICsgImFjcm9zcyB1cGRhdGVzLiBOb24tdW5pcXVlIGtleXMgbWF5IGNhdXNlIGNoaWxkcmVuIHRvIGJlICIgKyAiZHVwbGljYXRlZCBhbmQvb3Igb21pdHRlZCDigJQgdGhlIGJlaGF2aW9yIGlzIHVuc3VwcG9ydGVkIGFuZCAiICsgImNvdWxkIGNoYW5nZSBpbiBhIGZ1dHVyZSB2ZXJzaW9uLiVzIiwga2V5LCBnZXRDdXJyZW50RmliZXJTdGFja0FkZGVuZHVtJDEoKSk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4ga25vd25LZXlzOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5BcnJheShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuLCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIga25vd25LZXlzID0gbnVsbDsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBuZXdDaGlsZHJlbltpXTsKICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgICB2YXIgcHJldmlvdXNOZXdGaWJlciA9IG51bGw7CiAgICAgICAgICB2YXIgb2xkRmliZXIgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgIHZhciBsYXN0UGxhY2VkSW5kZXggPSAwOwogICAgICAgICAgdmFyIG5ld0lkeCA9IDA7CiAgICAgICAgICB2YXIgbmV4dE9sZEZpYmVyID0gbnVsbDsKCiAgICAgICAgICBmb3IgKDsgb2xkRmliZXIgIT09IG51bGwgJiYgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICBpZiAob2xkRmliZXIuaW5kZXggPiBuZXdJZHgpIHsKICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICAgIGlmIChuZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpZiAob2xkRmliZXIgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwoKICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG5ld0lkeCA9PT0gbmV3Q2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKDsgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgIHZhciBfbmV3RmliZXIgPSBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgbmV3Q2hpbGRyZW5bbmV3SWR4XSwgZXhwaXJhdGlvblRpbWUpOwoKICAgICAgICAgICAgICBpZiAoIV9uZXdGaWJlcikgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwoKICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwoKICAgICAgICAgIGZvciAoOyBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgIHZhciBfbmV3RmliZXIyID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBuZXdDaGlsZHJlbltuZXdJZHhdLCBleHBpcmF0aW9uVGltZSk7CgogICAgICAgICAgICBpZiAoX25ld0ZpYmVyMikgewogICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMi5hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlblsiZGVsZXRlIl0oX25ld0ZpYmVyMi5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBfbmV3RmliZXIyLmtleSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKCiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuSXRlcmFibGUsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICBpbnZhcmlhbnQodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIsICJBbiBvYmplY3QgaXMgbm90IGFuIGl0ZXJhYmxlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gIiArICJSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGRyZW5JdGVyYWJsZS5lbnRyaWVzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHBvc3NpYmxlTWFwID0gbmV3Q2hpbGRyZW5JdGVyYWJsZTsKCiAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlTWFwLmVudHJpZXMgPT09IGl0ZXJhdG9yRm4pIHsKICAgICAgICAgICAgICAgIHdhcm5pbmcoZGlkV2FybkFib3V0TWFwcywgIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgdW5zdXBwb3J0ZWQgYW5kIHdpbGwgbGlrZWx5IHlpZWxkICIgKyAidW5leHBlY3RlZCByZXN1bHRzLiBDb252ZXJ0IGl0IHRvIGEgc2VxdWVuY2UvaXRlcmFibGUgb2Yga2V5ZWQgIiArICJSZWFjdEVsZW1lbnRzIGluc3RlYWQuJXMiLCBnZXRDdXJyZW50RmliZXJTdGFja0FkZGVuZHVtJDEoKSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNYXBzID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBfbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CgogICAgICAgICAgICBpZiAoX25ld0NoaWxkcmVuKSB7CiAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CgogICAgICAgICAgICAgIHZhciBfc3RlcCA9IF9uZXdDaGlsZHJlbi5uZXh0KCk7CgogICAgICAgICAgICAgIGZvciAoOyAhX3N0ZXAuZG9uZTsgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBfc3RlcC52YWx1ZTsKICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICBpbnZhcmlhbnQobmV3Q2hpbGRyZW4gIT0gbnVsbCwgIkFuIGl0ZXJhYmxlIG9iamVjdCBwcm92aWRlZCBubyBpdGVyYXRvci4iKTsKICAgICAgICAgIHZhciByZXN1bHRpbmdGaXJzdENoaWxkID0gbnVsbDsKICAgICAgICAgIHZhciBwcmV2aW91c05ld0ZpYmVyID0gbnVsbDsKICAgICAgICAgIHZhciBvbGRGaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgdmFyIGxhc3RQbGFjZWRJbmRleCA9IDA7CiAgICAgICAgICB2YXIgbmV3SWR4ID0gMDsKICAgICAgICAgIHZhciBuZXh0T2xkRmliZXIgPSBudWxsOwogICAgICAgICAgdmFyIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCk7CgogICAgICAgICAgZm9yICg7IG9sZEZpYmVyICE9PSBudWxsICYmICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyOwogICAgICAgICAgICAgIG9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlci5zaWJsaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbmV3RmliZXIgPSB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgc3RlcC52YWx1ZSwgZXhwaXJhdGlvblRpbWUpOwoKICAgICAgICAgICAgaWYgKG5ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKCFvbGRGaWJlcikgewogICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpZiAob2xkRmliZXIgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwoKICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHN0ZXAuZG9uZSkgewogICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlcjMgPSBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgc3RlcC52YWx1ZSwgZXhwaXJhdGlvblRpbWUpOwoKICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjMsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKCiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXIzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXIzOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKCiAgICAgICAgICBmb3IgKDsgIXN0ZXAuZG9uZTsgbmV3SWR4KyssIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgdmFyIF9uZXdGaWJlcjQgPSB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIHN0ZXAudmFsdWUsIGV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICAgIGlmIChfbmV3RmliZXI0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXI0LmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuWyJkZWxldGUiXShfbmV3RmliZXI0LmtleSA9PT0gbnVsbCA/IG5ld0lkeCA6IF9uZXdGaWJlcjQua2V5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyNCwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwoKICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyNDsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgICByZXR1cm4gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50LCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgaWYgKGN1cnJlbnRGaXJzdENoaWxkICE9PSBudWxsICYmIGN1cnJlbnRGaXJzdENoaWxkLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50Rmlyc3RDaGlsZCwgdGV4dENvbnRlbnQsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgZXhpc3RpbmdbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgIH0KCiAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5pbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgIGNyZWF0ZWRbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZVNpbmdsZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBlbGVtZW50LCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CgogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEZyYWdtZW50ID8gZWxlbWVudC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFIDogY2hpbGQudHlwZSA9PT0gZWxlbWVudC50eXBlKSB7CiAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgZWxlbWVudC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFID8gZWxlbWVudC5wcm9wcy5jaGlsZHJlbiA6IGVsZW1lbnQucHJvcHMsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJlZiA9IGNvZXJjZVJlZihjaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICBleGlzdGluZ1sicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZWxlbWVudC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudC5wcm9wcy5jaGlsZHJlbiwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSwgZWxlbWVudC5rZXkpOwogICAgICAgICAgICBjcmVhdGVkWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBfY3JlYXRlZDcgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpOwoKICAgICAgICAgICAgX2NyZWF0ZWQ3LnJlZiA9IGNvZXJjZVJlZihjdXJyZW50Rmlyc3RDaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgIF9jcmVhdGVkN1sicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkNzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZVNpbmdsZUNhbGwocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBjYWxsLCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgdmFyIGtleSA9IGNhbGwua2V5OwogICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CgogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IENhbGxDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBjYWxsLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICBleGlzdGluZ1sicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21DYWxsKGNhbGwsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgY3JlYXRlZFsicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlUmV0dXJuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgcmV0dXJuTm9kZSwgZXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwoKICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoY2hpbGQudGFnID09PSBSZXR1cm5Db21wb25lbnQpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIG51bGwsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgICBleGlzdGluZy50eXBlID0gcmV0dXJuTm9kZS52YWx1ZTsKICAgICAgICAgICAgICBleGlzdGluZ1sicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tUmV0dXJuKHJldHVybk5vZGUsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgY3JlYXRlZC50eXBlID0gcmV0dXJuTm9kZS52YWx1ZTsKICAgICAgICAgIGNyZWF0ZWRbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHBvcnRhbCwgZXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIHZhciBrZXkgPSBwb3J0YWwua2V5OwogICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CgogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEhvc3RQb3J0YWwgJiYgY2hpbGQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gPT09IHBvcnRhbC5jb250YWluZXJJbmZvICYmIGNoaWxkLnN0YXRlTm9kZS5pbXBsZW1lbnRhdGlvbiA9PT0gcG9ydGFsLmltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgcG9ydGFsLmNoaWxkcmVuIHx8IFtdLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICBleGlzdGluZ1sicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCByZXR1cm5GaWJlci5pbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgIGNyZWF0ZWRbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkRmliZXJzKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCAmJiBuZXdDaGlsZC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFICYmIG5ld0NoaWxkLmtleSA9PT0gbnVsbCkgewogICAgICAgICAgICBuZXdDaGlsZCA9IG5ld0NoaWxkLnByb3BzLmNoaWxkcmVuOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBpc09iamVjdCA9IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGw7CgogICAgICAgICAgaWYgKGlzT2JqZWN0KSB7CiAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpKTsKCiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DQUxMX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVDYWxsKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKSk7CgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUkVUVVJOX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVSZXR1cm4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpKTsKCiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBleHBpcmF0aW9uVGltZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsICIiICsgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGlzQXJyYXkkMShuZXdDaGlsZCkpIHsKICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkcmVuQXJyYXkocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGlzT2JqZWN0KSB7CiAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgfQoKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgc3dpdGNoIChyZXR1cm5GaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucmVuZGVyLl9pc01vY2tGdW5jdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25hbENvbXBvbmVudDoKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IHJldHVybkZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIiVzKC4uLik6IE5vdGhpbmcgd2FzIHJldHVybmVkIGZyb20gcmVuZGVyLiBUaGlzIHVzdWFsbHkgbWVhbnMgYSAiICsgInJldHVybiBzdGF0ZW1lbnQgaXMgbWlzc2luZy4gT3IsIHRvIHJlbmRlciBub3RoaW5nLCAiICsgInJldHVybiBudWxsLiIsIENvbXBvbmVudC5kaXNwbGF5TmFtZSB8fCBDb21wb25lbnQubmFtZSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZEZpYmVyczsKICAgICAgfQoKICAgICAgdmFyIHJlY29uY2lsZUNoaWxkRmliZXJzID0gQ2hpbGRSZWNvbmNpbGVyKHRydWUpOwogICAgICB2YXIgbW91bnRDaGlsZEZpYmVycyA9IENoaWxkUmVjb25jaWxlcihmYWxzZSk7CgogICAgICBmdW5jdGlvbiBjbG9uZUNoaWxkRmliZXJzKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgaW52YXJpYW50KGN1cnJlbnQgPT09IG51bGwgfHwgd29ya0luUHJvZ3Jlc3MuY2hpbGQgPT09IGN1cnJlbnQuY2hpbGQsICJSZXN1bWluZyB3b3JrIG5vdCB5ZXQgaW1wbGVtZW50ZWQuIik7CgogICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcy5jaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IHdvcmtJblByb2dyZXNzLmNoaWxkOwogICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgY3VycmVudENoaWxkLnBlbmRpbmdQcm9wcywgY3VycmVudENoaWxkLmV4cGlyYXRpb25UaW1lKTsKICAgICAgICB3b3JrSW5Qcm9ncmVzcy5jaGlsZCA9IG5ld0NoaWxkOwogICAgICAgIG5ld0NoaWxkWyJyZXR1cm4iXSA9IHdvcmtJblByb2dyZXNzOwoKICAgICAgICB3aGlsZSAoY3VycmVudENoaWxkLnNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnRDaGlsZC5zaWJsaW5nOwogICAgICAgICAgbmV3Q2hpbGQgPSBuZXdDaGlsZC5zaWJsaW5nID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBjdXJyZW50Q2hpbGQucGVuZGluZ1Byb3BzLCBjdXJyZW50Q2hpbGQuZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgbmV3Q2hpbGRbInJldHVybiJdID0gd29ya0luUHJvZ3Jlc3M7CiAgICAgICAgfQoKICAgICAgICBuZXdDaGlsZC5zaWJsaW5nID0gbnVsbDsKICAgICAgfQoKICAgICAgewogICAgICAgIHZhciB3YXJuZWRBYm91dFN0YXRlbGVzc1JlZnMgPSB7fTsKICAgICAgfQoKICAgICAgdmFyIFJlYWN0RmliZXJCZWdpbldvcmsgPSBmdW5jdGlvbiBSZWFjdEZpYmVyQmVnaW5Xb3JrKGNvbmZpZywgaG9zdENvbnRleHQsIGh5ZHJhdGlvbkNvbnRleHQsIHNjaGVkdWxlV29yaywgY29tcHV0ZUV4cGlyYXRpb25Gb3JGaWJlcikgewogICAgICAgIHZhciBzaG91bGRTZXRUZXh0Q29udGVudCA9IGNvbmZpZy5zaG91bGRTZXRUZXh0Q29udGVudCwKICAgICAgICAgICAgdXNlU3luY1NjaGVkdWxpbmcgPSBjb25maWcudXNlU3luY1NjaGVkdWxpbmcsCiAgICAgICAgICAgIHNob3VsZERlcHJpb3JpdGl6ZVN1YnRyZWUgPSBjb25maWcuc2hvdWxkRGVwcmlvcml0aXplU3VidHJlZTsKICAgICAgICB2YXIgcHVzaEhvc3RDb250ZXh0ID0gaG9zdENvbnRleHQucHVzaEhvc3RDb250ZXh0LAogICAgICAgICAgICBwdXNoSG9zdENvbnRhaW5lciA9IGhvc3RDb250ZXh0LnB1c2hIb3N0Q29udGFpbmVyOwogICAgICAgIHZhciBlbnRlckh5ZHJhdGlvblN0YXRlID0gaHlkcmF0aW9uQ29udGV4dC5lbnRlckh5ZHJhdGlvblN0YXRlLAogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlID0gaHlkcmF0aW9uQ29udGV4dC5yZXNldEh5ZHJhdGlvblN0YXRlLAogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGh5ZHJhdGlvbkNvbnRleHQudHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CgogICAgICAgIHZhciBfUmVhY3RGaWJlckNsYXNzQ29tcG8gPSBSZWFjdEZpYmVyQ2xhc3NDb21wb25lbnQoc2NoZWR1bGVXb3JrLCBjb21wdXRlRXhwaXJhdGlvbkZvckZpYmVyLCBtZW1vaXplUHJvcHMsIG1lbW9pemVTdGF0ZSksCiAgICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSA9IF9SZWFjdEZpYmVyQ2xhc3NDb21wby5hZG9wdENsYXNzSW5zdGFuY2UsCiAgICAgICAgICAgIGNvbnN0cnVjdENsYXNzSW5zdGFuY2UgPSBfUmVhY3RGaWJlckNsYXNzQ29tcG8uY29uc3RydWN0Q2xhc3NJbnN0YW5jZSwKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlID0gX1JlYWN0RmliZXJDbGFzc0NvbXBvLm1vdW50Q2xhc3NJbnN0YW5jZSwKICAgICAgICAgICAgdXBkYXRlQ2xhc3NJbnN0YW5jZSA9IF9SZWFjdEZpYmVyQ2xhc3NDb21wby51cGRhdGVDbGFzc0luc3RhbmNlOwoKICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgbmV4dENoaWxkcmVuKSB7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbkF0RXhwaXJhdGlvblRpbWUoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIG5leHRDaGlsZHJlbiwgd29ya0luUHJvZ3Jlc3MuZXhwaXJhdGlvblRpbWUpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5BdEV4cGlyYXRpb25UaW1lKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5jaGlsZCA9IG1vdW50Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyRXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzcywgY3VycmVudC5jaGlsZCwgbmV4dENoaWxkcmVuLCByZW5kZXJFeHBpcmF0aW9uVGltZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcmFnbWVudChjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcykgewogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IHdvcmtJblByb2dyZXNzLnBlbmRpbmdQcm9wczsKCiAgICAgICAgICBpZiAoaGFzQ29udGV4dENoYW5nZWQoKSkge30gZWxzZSBpZiAobmV4dENoaWxkcmVuID09PSBudWxsIHx8IHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHMgPT09IG5leHRDaGlsZHJlbikgewogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CgogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIG5leHRDaGlsZHJlbik7CiAgICAgICAgICBtZW1vaXplUHJvcHMod29ya0luUHJvZ3Jlc3MsIG5leHRDaGlsZHJlbik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MuY2hpbGQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBtYXJrUmVmKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB2YXIgcmVmID0gd29ya0luUHJvZ3Jlc3MucmVmOwoKICAgICAgICAgIGlmIChyZWYgIT09IG51bGwgJiYgKCFjdXJyZW50IHx8IGN1cnJlbnQucmVmICE9PSByZWYpKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyB8PSBSZWY7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVGdW5jdGlvbmFsQ29tcG9uZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB2YXIgZm4gPSB3b3JrSW5Qcm9ncmVzcy50eXBlOwogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzLnBlbmRpbmdQcm9wczsKCiAgICAgICAgICBpZiAoaGFzQ29udGV4dENoYW5nZWQoKSkge30gZWxzZSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFByb3BzID09PSBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIHZhciBjb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzcywgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5zZXRDdXJyZW50UGhhc2UoInJlbmRlciIpOwogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBmbihuZXh0UHJvcHMsIGNvbnRleHQpOwogICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZpYmVyLnNldEN1cnJlbnRQaGFzZShudWxsKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIG5leHRDaGlsZHJlbik7CiAgICAgICAgICBtZW1vaXplUHJvcHMod29ya0luUHJvZ3Jlc3MsIG5leHRQcm9wcyk7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MuY2hpbGQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc0NvbXBvbmVudChjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgcmVuZGVyRXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIHZhciBoYXNDb250ZXh0ID0gcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gdm9pZCAwOwoKICAgICAgICAgIGlmIChjdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgIGlmICghd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlKSB7CiAgICAgICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzcywgd29ya0luUHJvZ3Jlc3MucGVuZGluZ1Byb3BzKTsKICAgICAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgICBzaG91bGRVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIlJlc3VtaW5nIHdvcmsgbm90IHlldCBpbXBsZW1lbnRlZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdXBkYXRlQ2xhc3NJbnN0YW5jZShjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgcmVuZGVyRXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBmaW5pc2hDbGFzc0NvbXBvbmVudChjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgc2hvdWxkVXBkYXRlLCBoYXNDb250ZXh0KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBzaG91bGRVcGRhdGUsIGhhc0NvbnRleHQpIHsKICAgICAgICAgIG1hcmtSZWYoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MpOwoKICAgICAgICAgIGlmICghc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgIGlmIChoYXNDb250ZXh0KSB7CiAgICAgICAgICAgICAgaW52YWxpZGF0ZUNvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzcywgZmFsc2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlOwogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IHZvaWQgMDsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5zZXRDdXJyZW50UGhhc2UoInJlbmRlciIpOwogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBpbnN0YW5jZS5yZW5kZXIoKTsKCiAgICAgICAgICAgIGlmIChkZWJ1Z1JlbmRlclBoYXNlU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5zZXRDdXJyZW50UGhhc2UobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5lZmZlY3RUYWcgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBuZXh0Q2hpbGRyZW4pOwogICAgICAgICAgbWVtb2l6ZVN0YXRlKHdvcmtJblByb2dyZXNzLCBpbnN0YW5jZS5zdGF0ZSk7CiAgICAgICAgICBtZW1vaXplUHJvcHMod29ya0luUHJvZ3Jlc3MsIGluc3RhbmNlLnByb3BzKTsKCiAgICAgICAgICBpZiAoaGFzQ29udGV4dCkgewogICAgICAgICAgICBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzLCB0cnVlKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MuY2hpbGQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB2YXIgcm9vdCA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZTsKCiAgICAgICAgICBpZiAocm9vdC5wZW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KHdvcmtJblByb2dyZXNzLCByb290LnBlbmRpbmdDb250ZXh0LCByb290LnBlbmRpbmdDb250ZXh0ICE9PSByb290LmNvbnRleHQpOwogICAgICAgICAgfSBlbHNlIGlmIChyb290LmNvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzcywgcm9vdC5jb250ZXh0LCBmYWxzZSk7CiAgICAgICAgICB9CgogICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MsIHJvb3QuY29udGFpbmVySW5mbyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0Um9vdChjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgcmVuZGVyRXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gd29ya0luUHJvZ3Jlc3MudXBkYXRlUXVldWU7CgogICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB2YXIgc3RhdGUgPSBwcm9jZXNzVXBkYXRlUXVldWUoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHVwZGF0ZVF1ZXVlLCBudWxsLCBudWxsLCByZW5kZXJFeHBpcmF0aW9uVGltZSk7CgogICAgICAgICAgICBpZiAocHJldlN0YXRlID09PSBzdGF0ZSkgewogICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gc3RhdGUuZWxlbWVudDsKICAgICAgICAgICAgdmFyIHJvb3QgPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGU7CgogICAgICAgICAgICBpZiAoKGN1cnJlbnQgPT09IG51bGwgfHwgY3VycmVudC5jaGlsZCA9PT0gbnVsbCkgJiYgcm9vdC5oeWRyYXRlICYmIGVudGVySHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MuZWZmZWN0VGFnIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5jaGlsZCA9IG1vdW50Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MsIG51bGwsIGVsZW1lbnQsIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIGVsZW1lbnQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtZW1vaXplU3RhdGUod29ya0luUHJvZ3Jlc3MsIHN0YXRlKTsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzLmNoaWxkOwogICAgICAgICAgfQoKICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RDb21wb25lbnQoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICBwdXNoSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MpOwoKICAgICAgICAgIGlmIChjdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzLnR5cGU7CiAgICAgICAgICB2YXIgbWVtb2l6ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQgIT09IG51bGwgPyBjdXJyZW50Lm1lbW9pemVkUHJvcHMgOiBudWxsOwoKICAgICAgICAgIGlmIChoYXNDb250ZXh0Q2hhbmdlZCgpKSB7fSBlbHNlIGlmIChtZW1vaXplZFByb3BzID09PSBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YXIgaXNEaXJlY3RUZXh0Q2hpbGQgPSBzaG91bGRTZXRUZXh0Q29udGVudCh0eXBlLCBuZXh0UHJvcHMpOwoKICAgICAgICAgIGlmIChpc0RpcmVjdFRleHRDaGlsZCkgewogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfSBlbHNlIGlmIChwcmV2UHJvcHMgJiYgc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgcHJldlByb3BzKSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5lZmZlY3RUYWcgfD0gQ29udGVudFJlc2V0OwogICAgICAgICAgfQoKICAgICAgICAgIG1hcmtSZWYoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MpOwoKICAgICAgICAgIGlmIChyZW5kZXJFeHBpcmF0aW9uVGltZSAhPT0gTmV2ZXIgJiYgIXVzZVN5bmNTY2hlZHVsaW5nICYmIHNob3VsZERlcHJpb3JpdGl6ZVN1YnRyZWUodHlwZSwgbmV4dFByb3BzKSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5leHBpcmF0aW9uVGltZSA9IE5ldmVyOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgbmV4dENoaWxkcmVuKTsKICAgICAgICAgIG1lbW9pemVQcm9wcyh3b3JrSW5Qcm9ncmVzcywgbmV4dFByb3BzKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzcy5jaGlsZDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RUZXh0KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzLnBlbmRpbmdQcm9wczsKICAgICAgICAgIG1lbW9pemVQcm9wcyh3b3JrSW5Qcm9ncmVzcywgbmV4dFByb3BzKTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmRldGVybWluYXRlQ29tcG9uZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCByZW5kZXJFeHBpcmF0aW9uVGltZSkgewogICAgICAgICAgaW52YXJpYW50KGN1cnJlbnQgPT09IG51bGwsICJBbiBpbmRldGVybWluYXRlIGNvbXBvbmVudCBzaG91bGQgbmV2ZXIgaGF2ZSBtb3VudGVkLiBUaGlzIGVycm9yIGlzICIgKyAibGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB2YXIgZm4gPSB3b3JrSW5Qcm9ncmVzcy50eXBlOwogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB2YXIgY29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB2YXIgdmFsdWU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChmbi5wcm90b3R5cGUgJiYgdHlwZW9mIGZuLnByb3RvdHlwZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWUod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICJUaGUgPCVzIC8+IGNvbXBvbmVudCBhcHBlYXJzIHRvIGhhdmUgYSByZW5kZXIgbWV0aG9kLCBidXQgZG9lc24ndCBleHRlbmQgUmVhY3QuQ29tcG9uZW50LiAiICsgIlRoaXMgaXMgbGlrZWx5IHRvIGNhdXNlIGVycm9ycy4gQ2hhbmdlICVzIHRvIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgICB2YWx1ZSA9IGZuKHByb3BzLCBjb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyB8PSBQZXJmb3JtZWRXb3JrOwoKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MudGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgIHZhciBoYXNDb250ZXh0ID0gcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzcywgdmFsdWUpOwogICAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgcmV0dXJuIGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCB0cnVlLCBoYXNDb250ZXh0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzLnRhZyA9IEZ1bmN0aW9uYWxDb21wb25lbnQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MudHlwZTsKCiAgICAgICAgICAgICAgaWYgKENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgd2FybmluZyghQ29tcG9uZW50LmNoaWxkQ29udGV4dFR5cGVzLCAiJXMoLi4uKTogY2hpbGRDb250ZXh0VHlwZXMgY2Fubm90IGJlIGRlZmluZWQgb24gYSBmdW5jdGlvbmFsIGNvbXBvbmVudC4iLCBDb21wb25lbnQuZGlzcGxheU5hbWUgfHwgQ29tcG9uZW50Lm5hbWUgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzLnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBSZWFjdERlYnVnQ3VycmVudEZpYmVyLmdldEN1cnJlbnRGaWJlck93bmVyTmFtZSgpOwoKICAgICAgICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgICAgICAgaW5mbyArPSAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG93bmVyTmFtZSB8fCB3b3JrSW5Qcm9ncmVzcy5fZGVidWdJRCB8fCAiIjsKICAgICAgICAgICAgICAgIHZhciBkZWJ1Z1NvdXJjZSA9IHdvcmtJblByb2dyZXNzLl9kZWJ1Z1NvdXJjZTsKCiAgICAgICAgICAgICAgICBpZiAoZGVidWdTb3VyY2UpIHsKICAgICAgICAgICAgICAgICAgd2FybmluZ0tleSA9IGRlYnVnU291cmNlLmZpbGVOYW1lICsgIjoiICsgZGVidWdTb3VyY2UubGluZU51bWJlcjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIXdhcm5lZEFib3V0U3RhdGVsZXNzUmVmc1t3YXJuaW5nS2V5XSkgewogICAgICAgICAgICAgICAgICB3YXJuZWRBYm91dFN0YXRlbGVzc1JlZnNbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAiU3RhdGVsZXNzIGZ1bmN0aW9uIGNvbXBvbmVudHMgY2Fubm90IGJlIGdpdmVuIHJlZnMuICIgKyAiQXR0ZW1wdHMgdG8gYWNjZXNzIHRoaXMgcmVmIHdpbGwgZmFpbC4lcyVzIiwgaW5mbywgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5nZXRDdXJyZW50RmliZXJTdGFja0FkZGVuZHVtKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgdmFsdWUpOwogICAgICAgICAgICBtZW1vaXplUHJvcHMod29ya0luUHJvZ3Jlc3MsIHByb3BzKTsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzLmNoaWxkOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2FsbENvbXBvbmVudChjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgcmVuZGVyRXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIHZhciBuZXh0Q2FsbCA9IHdvcmtJblByb2dyZXNzLnBlbmRpbmdQcm9wczsKCiAgICAgICAgICBpZiAoaGFzQ29udGV4dENoYW5nZWQoKSkge30gZWxzZSBpZiAod29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRQcm9wcyA9PT0gbmV4dENhbGwpIHsKICAgICAgICAgICAgbmV4dENhbGwgPSB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFByb3BzOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0Q2FsbC5jaGlsZHJlbjsKCiAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUgPSBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzLCB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUsIG5leHRDaGlsZHJlbiwgcmVuZGVyRXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MsIHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZSwgbmV4dENoaWxkcmVuLCByZW5kZXJFeHBpcmF0aW9uVGltZSk7CiAgICAgICAgICB9CgogICAgICAgICAgbWVtb2l6ZVByb3BzKHdvcmtJblByb2dyZXNzLCBuZXh0Q2FsbCk7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUG9ydGFsQ29tcG9uZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCByZW5kZXJFeHBpcmF0aW9uVGltZSkgewogICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MsIHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzcy5wZW5kaW5nUHJvcHM7CgogICAgICAgICAgaWYgKGhhc0NvbnRleHRDaGFuZ2VkKCkpIHt9IGVsc2UgaWYgKHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHMgPT09IG5leHRDaGlsZHJlbikgewogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzcywgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJFeHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgIG1lbW9pemVQcm9wcyh3b3JrSW5Qcm9ncmVzcywgbmV4dENoaWxkcmVuKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBuZXh0Q2hpbGRyZW4pOwogICAgICAgICAgICBtZW1vaXplUHJvcHMod29ya0luUHJvZ3Jlc3MsIG5leHRDaGlsZHJlbik7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzLmNoaWxkOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcykgewogICAgICAgICAgY2FuY2VsV29ya1RpbWVyKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIGNsb25lQ2hpbGRGaWJlcnMoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzLmNoaWxkOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYmFpbG91dE9uTG93UHJpb3JpdHkoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgIGNhbmNlbFdvcmtUaW1lcih3b3JrSW5Qcm9ncmVzcyk7CgogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzcy50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MsIHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG1lbW9pemVQcm9wcyh3b3JrSW5Qcm9ncmVzcywgbmV4dFByb3BzKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFByb3BzID0gbmV4dFByb3BzOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbWVtb2l6ZVN0YXRlKHdvcmtJblByb2dyZXNzLCBuZXh0U3RhdGUpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzLm1lbW9pemVkU3RhdGUgPSBuZXh0U3RhdGU7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBiZWdpbldvcmsoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MuZXhwaXJhdGlvblRpbWUgPT09IE5vV29yayB8fCB3b3JrSW5Qcm9ncmVzcy5leHBpcmF0aW9uVGltZSA+IHJlbmRlckV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25Mb3dQcmlvcml0eShjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CgogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzcy50YWcpIHsKICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBtb3VudEluZGV0ZXJtaW5hdGVDb21wb25lbnQoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25hbENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnVuY3Rpb25hbENvbXBvbmVudChjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyk7CgogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDbGFzc0NvbXBvbmVudChjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgcmVuZGVyRXhwaXJhdGlvblRpbWUpOwoKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdFJvb3QoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgcmVuZGVyRXhwaXJhdGlvblRpbWUpOwoKICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdFRleHQoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MpOwoKICAgICAgICAgICAgY2FzZSBDYWxsSGFuZGxlclBoYXNlOgogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzLnRhZyA9IENhbGxDb21wb25lbnQ7CgogICAgICAgICAgICBjYXNlIENhbGxDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxDb21wb25lbnQoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICAgIGNhc2UgUmV0dXJuQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwoKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWxDb21wb25lbnQoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzKTsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaW52YXJpYW50KGZhbHNlLCAiVW5rbm93biB1bml0IG9mIHdvcmsgdGFnLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gIiArICJSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBiZWdpbkZhaWxlZFdvcmsoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzLnRhZykgewogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaW52YXJpYW50KGZhbHNlLCAiSW52YWxpZCB0eXBlIG9mIHdvcmsuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gIiArICJQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KCiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5lZmZlY3RUYWcgfD0gRXJyOwoKICAgICAgICAgIGlmIChjdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzLmNoaWxkID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSBpZiAod29ya0luUHJvZ3Jlc3MuY2hpbGQgIT09IGN1cnJlbnQuY2hpbGQpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MuY2hpbGQgPSBjdXJyZW50LmNoaWxkOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcy5leHBpcmF0aW9uVGltZSA9PT0gTm9Xb3JrIHx8IHdvcmtJblByb2dyZXNzLmV4cGlyYXRpb25UaW1lID4gcmVuZGVyRXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkxvd1ByaW9yaXR5KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KCiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5maXJzdEVmZmVjdCA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5sYXN0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW5BdEV4cGlyYXRpb25UaW1lKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHMgPSBpbnN0YW5jZS5wcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzcy5jaGlsZDsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBiZWdpbldvcms6IGJlZ2luV29yaywKICAgICAgICAgIGJlZ2luRmFpbGVkV29yazogYmVnaW5GYWlsZWRXb3JrCiAgICAgICAgfTsKICAgICAgfTsKCiAgICAgIHZhciBSZWFjdEZpYmVyQ29tcGxldGVXb3JrID0gZnVuY3Rpb24gUmVhY3RGaWJlckNvbXBsZXRlV29yayhjb25maWcsIGhvc3RDb250ZXh0LCBoeWRyYXRpb25Db250ZXh0KSB7CiAgICAgICAgdmFyIGNyZWF0ZUluc3RhbmNlID0gY29uZmlnLmNyZWF0ZUluc3RhbmNlLAogICAgICAgICAgICBjcmVhdGVUZXh0SW5zdGFuY2UgPSBjb25maWcuY3JlYXRlVGV4dEluc3RhbmNlLAogICAgICAgICAgICBhcHBlbmRJbml0aWFsQ2hpbGQgPSBjb25maWcuYXBwZW5kSW5pdGlhbENoaWxkLAogICAgICAgICAgICBmaW5hbGl6ZUluaXRpYWxDaGlsZHJlbiA9IGNvbmZpZy5maW5hbGl6ZUluaXRpYWxDaGlsZHJlbiwKICAgICAgICAgICAgcHJlcGFyZVVwZGF0ZSA9IGNvbmZpZy5wcmVwYXJlVXBkYXRlLAogICAgICAgICAgICBtdXRhdGlvbiA9IGNvbmZpZy5tdXRhdGlvbiwKICAgICAgICAgICAgcGVyc2lzdGVuY2UgPSBjb25maWcucGVyc2lzdGVuY2U7CiAgICAgICAgdmFyIGdldFJvb3RIb3N0Q29udGFpbmVyID0gaG9zdENvbnRleHQuZ2V0Um9vdEhvc3RDb250YWluZXIsCiAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0ID0gaG9zdENvbnRleHQucG9wSG9zdENvbnRleHQsCiAgICAgICAgICAgIGdldEhvc3RDb250ZXh0ID0gaG9zdENvbnRleHQuZ2V0SG9zdENvbnRleHQsCiAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIgPSBob3N0Q29udGV4dC5wb3BIb3N0Q29udGFpbmVyOwogICAgICAgIHZhciBwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlID0gaHlkcmF0aW9uQ29udGV4dC5wcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlLAogICAgICAgICAgICBwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZSA9IGh5ZHJhdGlvbkNvbnRleHQucHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2UsCiAgICAgICAgICAgIHBvcEh5ZHJhdGlvblN0YXRlID0gaHlkcmF0aW9uQ29udGV4dC5wb3BIeWRyYXRpb25TdGF0ZTsKCiAgICAgICAgZnVuY3Rpb24gbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzcykgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MuZWZmZWN0VGFnIHw9IFVwZGF0ZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG1hcmtSZWYod29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyB8PSBSZWY7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhcHBlbmRBbGxSZXR1cm5zKHJldHVybnMsIHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZTsKCiAgICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBub2RlWyJyZXR1cm4iXSA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgfQoKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gSG9zdFRleHQgfHwgbm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICBpbnZhcmlhbnQoZmFsc2UsICJBIGNhbGwgY2Fubm90IGhhdmUgaG9zdCBjb21wb25lbnQgY2hpbGRyZW4uIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IFJldHVybkNvbXBvbmVudCkgewogICAgICAgICAgICAgIHJldHVybnMucHVzaChub2RlLnR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkWyJyZXR1cm4iXSA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZVsicmV0dXJuIl0gPT09IG51bGwgfHwgbm9kZVsicmV0dXJuIl0gPT09IHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBub2RlID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vZGUuc2libGluZ1sicmV0dXJuIl0gPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG1vdmVDYWxsVG9IYW5kbGVyUGhhc2UoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICB2YXIgY2FsbCA9IHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICBpbnZhcmlhbnQoY2FsbCwgIlNob3VsZCBiZSByZXNvbHZlZCBieSBub3cuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiAiICsgIlJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzLnRhZyA9IENhbGxIYW5kbGVyUGhhc2U7CiAgICAgICAgICB2YXIgcmV0dXJucyA9IFtdOwogICAgICAgICAgYXBwZW5kQWxsUmV0dXJucyhyZXR1cm5zLCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB2YXIgZm4gPSBjYWxsLmhhbmRsZXI7CiAgICAgICAgICB2YXIgcHJvcHMgPSBjYWxsLnByb3BzOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IGZuKHByb3BzLCByZXR1cm5zKTsKICAgICAgICAgIHZhciBjdXJyZW50Rmlyc3RDaGlsZCA9IGN1cnJlbnQgIT09IG51bGwgPyBjdXJyZW50LmNoaWxkIDogbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzcy5jaGlsZDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGFwcGVuZEFsbENoaWxkcmVuKHBhcmVudCwgd29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgIHZhciBub2RlID0gd29ya0luUHJvZ3Jlc3MuY2hpbGQ7CgogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgIGFwcGVuZEluaXRpYWxDaGlsZChwYXJlbnQsIG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnRhZyA9PT0gSG9zdFBvcnRhbCkge30gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGRbInJldHVybiJdID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGVbInJldHVybiJdID09PSBudWxsIHx8IG5vZGVbInJldHVybiJdID09PSB3b3JrSW5Qcm9ncmVzcykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgbm9kZSA9IG5vZGVbInJldHVybiJdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBub2RlLnNpYmxpbmdbInJldHVybiJdID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbnRhaW5lciA9IHZvaWQgMDsKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbXBvbmVudCA9IHZvaWQgMDsKICAgICAgICB2YXIgdXBkYXRlSG9zdFRleHQgPSB2b2lkIDA7CgogICAgICAgIGlmIChtdXRhdGlvbikgewogICAgICAgICAgaWYgKGVuYWJsZU11dGF0aW5nUmVjb25jaWxlcikgewogICAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyID0gZnVuY3Rpb24gdXBkYXRlSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzcykge307CgogICAgICAgICAgICB1cGRhdGVIb3N0Q29tcG9uZW50ID0gZnVuY3Rpb24gdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgdXBkYXRlUGF5bG9hZCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy51cGRhdGVRdWV1ZSA9IHVwZGF0ZVBheWxvYWQ7CgogICAgICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB1cGRhdGVIb3N0VGV4dCA9IGZ1bmN0aW9uIHVwZGF0ZUhvc3RUZXh0KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBvbGRUZXh0LCBuZXdUZXh0KSB7CiAgICAgICAgICAgICAgaWYgKG9sZFRleHQgIT09IG5ld1RleHQpIHsKICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIk11dGF0aW5nIHJlY29uY2lsZXIgaXMgZGlzYWJsZWQuIik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChwZXJzaXN0ZW5jZSkgewogICAgICAgICAgaWYgKGVuYWJsZVBlcnNpc3RlbnRSZWNvbmNpbGVyKSB7CiAgICAgICAgICAgIHZhciBjbG9uZUluc3RhbmNlID0gcGVyc2lzdGVuY2UuY2xvbmVJbnN0YW5jZSwKICAgICAgICAgICAgICAgIGNyZWF0ZUNvbnRhaW5lckNoaWxkU2V0ID0gcGVyc2lzdGVuY2UuY3JlYXRlQ29udGFpbmVyQ2hpbGRTZXQsCiAgICAgICAgICAgICAgICBhcHBlbmRDaGlsZFRvQ29udGFpbmVyQ2hpbGRTZXQgPSBwZXJzaXN0ZW5jZS5hcHBlbmRDaGlsZFRvQ29udGFpbmVyQ2hpbGRTZXQsCiAgICAgICAgICAgICAgICBmaW5hbGl6ZUNvbnRhaW5lckNoaWxkcmVuID0gcGVyc2lzdGVuY2UuZmluYWxpemVDb250YWluZXJDaGlsZHJlbjsKCiAgICAgICAgICAgIHZhciBhcHBlbmRBbGxDaGlsZHJlblRvQ29udGFpbmVyID0gZnVuY3Rpb24gYXBwZW5kQWxsQ2hpbGRyZW5Ub0NvbnRhaW5lcihjb250YWluZXJDaGlsZFNldCwgd29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHdvcmtJblByb2dyZXNzLmNoaWxkOwoKICAgICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgICBhcHBlbmRDaGlsZFRvQ29udGFpbmVyQ2hpbGRTZXQoY29udGFpbmVyQ2hpbGRTZXQsIG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIHt9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5jaGlsZFsicmV0dXJuIl0gPSBub2RlOwogICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGlmIChub2RlWyJyZXR1cm4iXSA9PT0gbnVsbCB8fCBub2RlWyJyZXR1cm4iXSA9PT0gd29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBub2RlLnNpYmxpbmdbInJldHVybiJdID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHVwZGF0ZUhvc3RDb250YWluZXIgPSBmdW5jdGlvbiB1cGRhdGVIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgdmFyIHBvcnRhbE9yUm9vdCA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgY2hpbGRyZW5VbmNoYW5nZWQgPSB3b3JrSW5Qcm9ncmVzcy5maXJzdEVmZmVjdCA9PT0gbnVsbDsKCiAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuVW5jaGFuZ2VkKSB7fSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBwb3J0YWxPclJvb3QuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgIHZhciBuZXdDaGlsZFNldCA9IGNyZWF0ZUNvbnRhaW5lckNoaWxkU2V0KGNvbnRhaW5lcik7CgogICAgICAgICAgICAgICAgaWYgKGZpbmFsaXplQ29udGFpbmVyQ2hpbGRyZW4oY29udGFpbmVyLCBuZXdDaGlsZFNldCkpIHsKICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcG9ydGFsT3JSb290LnBlbmRpbmdDaGlsZHJlbiA9IG5ld0NoaWxkU2V0OwogICAgICAgICAgICAgICAgYXBwZW5kQWxsQ2hpbGRyZW5Ub0NvbnRhaW5lcihuZXdDaGlsZFNldCwgd29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdXBkYXRlSG9zdENvbXBvbmVudCA9IGZ1bmN0aW9uIHVwZGF0ZUhvc3RDb21wb25lbnQoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuVW5jaGFuZ2VkID0gd29ya0luUHJvZ3Jlc3MuZmlyc3RFZmZlY3QgPT09IG51bGw7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRJbnN0YW5jZSA9IGN1cnJlbnQuc3RhdGVOb2RlOwoKICAgICAgICAgICAgICBpZiAoY2hpbGRyZW5VbmNoYW5nZWQgJiYgdXBkYXRlUGF5bG9hZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlID0gY3VycmVudEluc3RhbmNlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgcmVjeWNsYWJsZUluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIG5ld0luc3RhbmNlID0gY2xvbmVJbnN0YW5jZShjdXJyZW50SW5zdGFuY2UsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgd29ya0luUHJvZ3Jlc3MsIGNoaWxkcmVuVW5jaGFuZ2VkLCByZWN5Y2xhYmxlSW5zdGFuY2UpOwoKICAgICAgICAgICAgICAgIGlmIChmaW5hbGl6ZUluaXRpYWxDaGlsZHJlbihuZXdJbnN0YW5jZSwgdHlwZSwgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlID0gbmV3SW5zdGFuY2U7CgogICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuVW5jaGFuZ2VkKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgYXBwZW5kQWxsQ2hpbGRyZW4obmV3SW5zdGFuY2UsIHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB1cGRhdGVIb3N0VGV4dCA9IGZ1bmN0aW9uIHVwZGF0ZUhvc3RUZXh0KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBvbGRUZXh0LCBuZXdUZXh0KSB7CiAgICAgICAgICAgICAgaWYgKG9sZFRleHQgIT09IG5ld1RleHQpIHsKICAgICAgICAgICAgICAgIHZhciByb290Q29udGFpbmVySW5zdGFuY2UgPSBnZXRSb290SG9zdENvbnRhaW5lcigpOwogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUgPSBjcmVhdGVUZXh0SW5zdGFuY2UobmV3VGV4dCwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIlBlcnNpc3RlbnQgcmVjb25jaWxlciBpcyBkaXNhYmxlZC4iKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGVuYWJsZU5vb3BSZWNvbmNpbGVyKSB7CiAgICAgICAgICAgIHVwZGF0ZUhvc3RDb250YWluZXIgPSBmdW5jdGlvbiB1cGRhdGVIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzKSB7fTsKCiAgICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQgPSBmdW5jdGlvbiB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSkge307CgogICAgICAgICAgICB1cGRhdGVIb3N0VGV4dCA9IGZ1bmN0aW9uIHVwZGF0ZUhvc3RUZXh0KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBvbGRUZXh0LCBuZXdUZXh0KSB7fTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIk5vb3AgcmVjb25jaWxlciBpcyBkaXNhYmxlZC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgcmVuZGVyRXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzLnBlbmRpbmdQcm9wczsKCiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uYWxDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgcG9wVG9wTGV2ZWxDb250ZXh0T2JqZWN0KHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgICAgIHZhciBmaWJlclJvb3QgPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGU7CgogICAgICAgICAgICAgICAgaWYgKGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICAgICAgICBmaWJlclJvb3QuY29udGV4dCA9IGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dDsKICAgICAgICAgICAgICAgICAgZmliZXJSb290LnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCB8fCBjdXJyZW50LmNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MuZWZmZWN0VGFnICY9IH5QbGFjZW1lbnQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcG9wSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgdmFyIHJvb3RDb250YWluZXJJbnN0YW5jZSA9IGdldFJvb3RIb3N0Q29udGFpbmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzLnR5cGU7CgogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwgJiYgd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50SG9zdENvbnRleHQgPSBnZXRIb3N0Q29udGV4dCgpOwogICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IHByZXBhcmVVcGRhdGUoaW5zdGFuY2UsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQpOwogICAgICAgICAgICAgICAgICB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CgogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudC5yZWYgIT09IHdvcmtJblByb2dyZXNzLnJlZikgewogICAgICAgICAgICAgICAgICAgIG1hcmtSZWYod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoIW5ld1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgaW52YXJpYW50KHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZSAhPT0gbnVsbCwgIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5ICIgKyAiY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgdmFyIF9jdXJyZW50SG9zdENvbnRleHQgPSBnZXRIb3N0Q29udGV4dCgpOwoKICAgICAgICAgICAgICAgICAgdmFyIHdhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MpOwoKICAgICAgICAgICAgICAgICAgaWYgKHdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgX2N1cnJlbnRIb3N0Q29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlID0gY3JlYXRlSW5zdGFuY2UodHlwZSwgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgX2N1cnJlbnRIb3N0Q29udGV4dCwgd29ya0luUHJvZ3Jlc3MpOwoKICAgICAgICAgICAgICAgICAgICBhcHBlbmRBbGxDaGlsZHJlbihfaW5zdGFuY2UsIHdvcmtJblByb2dyZXNzKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKF9pbnN0YW5jZSwgdHlwZSwgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlID0gX2luc3RhbmNlOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MucmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1JlZih3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuZXdUZXh0ID0gbmV3UHJvcHM7CgogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgJiYgd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIG9sZFRleHQgPSBjdXJyZW50Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RUZXh0KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBvbGRUZXh0LCBuZXdUZXh0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3VGV4dCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBpbnZhcmlhbnQod29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlICE9PSBudWxsLCAiV2UgbXVzdCBoYXZlIG5ldyBwcm9wcyBmb3IgbmV3IG1vdW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgIiArICJjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICB2YXIgX3Jvb3RDb250YWluZXJJbnN0YW5jZSA9IGdldFJvb3RIb3N0Q29udGFpbmVyKCk7CgogICAgICAgICAgICAgICAgICB2YXIgX2N1cnJlbnRIb3N0Q29udGV4dDIgPSBnZXRIb3N0Q29udGV4dCgpOwoKICAgICAgICAgICAgICAgICAgdmFyIF93YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzKTsKCiAgICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MpKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlID0gY3JlYXRlVGV4dEluc3RhbmNlKG5ld1RleHQsIF9yb290Q29udGFpbmVySW5zdGFuY2UsIF9jdXJyZW50SG9zdENvbnRleHQyLCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICBjYXNlIENhbGxDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIG1vdmVDYWxsVG9IYW5kbGVyUGhhc2UoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICAgIGNhc2UgQ2FsbEhhbmRsZXJQaGFzZToKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy50YWcgPSBDYWxsQ29tcG9uZW50OwogICAgICAgICAgICAgIHJldHVybiBudWxsOwoKICAgICAgICAgICAgY2FzZSBSZXR1cm5Db21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgICAgICBjYXNlIEZyYWdtZW50OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwoKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwoKICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIkFuIGluZGV0ZXJtaW5hdGUgY29tcG9uZW50IHNob3VsZCBoYXZlIGJlY29tZSBkZXRlcm1pbmF0ZSBiZWZvcmUgIiArICJjb21wbGV0aW5nLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSAiICsgImZpbGUgYW4gaXNzdWUuIik7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluICIgKyAiUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNvbXBsZXRlV29yazogY29tcGxldGVXb3JrCiAgICAgICAgfTsKICAgICAgfTsKCiAgICAgIHZhciBpbnZva2VHdWFyZGVkQ2FsbGJhY2skMiA9IFJlYWN0RXJyb3JVdGlscy5pbnZva2VHdWFyZGVkQ2FsbGJhY2s7CiAgICAgIHZhciBoYXNDYXVnaHRFcnJvciQxID0gUmVhY3RFcnJvclV0aWxzLmhhc0NhdWdodEVycm9yOwogICAgICB2YXIgY2xlYXJDYXVnaHRFcnJvciQxID0gUmVhY3RFcnJvclV0aWxzLmNsZWFyQ2F1Z2h0RXJyb3I7CgogICAgICB2YXIgUmVhY3RGaWJlckNvbW1pdFdvcmsgPSBmdW5jdGlvbiBSZWFjdEZpYmVyQ29tbWl0V29yayhjb25maWcsIGNhcHR1cmVFcnJvcikgewogICAgICAgIHZhciBnZXRQdWJsaWNJbnN0YW5jZSA9IGNvbmZpZy5nZXRQdWJsaWNJbnN0YW5jZSwKICAgICAgICAgICAgbXV0YXRpb24gPSBjb25maWcubXV0YXRpb24sCiAgICAgICAgICAgIHBlcnNpc3RlbmNlID0gY29uZmlnLnBlcnNpc3RlbmNlOwoKICAgICAgICB2YXIgY2FsbENvbXBvbmVudFdpbGxVbm1vdW50V2l0aFRpbWVyID0gZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxVbm1vdW50V2l0aFRpbWVyKGN1cnJlbnQsIGluc3RhbmNlKSB7CiAgICAgICAgICBzdGFydFBoYXNlVGltZXIoY3VycmVudCwgImNvbXBvbmVudFdpbGxVbm1vdW50Iik7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IGN1cnJlbnQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gY3VycmVudC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgIHN0b3BQaGFzZVRpbWVyKCk7CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGN1cnJlbnQsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayQyKG51bGwsIGNhbGxDb21wb25lbnRXaWxsVW5tb3VudFdpdGhUaW1lciwgbnVsbCwgY3VycmVudCwgaW5zdGFuY2UpOwoKICAgICAgICAgICAgaWYgKGhhc0NhdWdodEVycm9yJDEoKSkgewogICAgICAgICAgICAgIHZhciB1bm1vdW50RXJyb3IgPSBjbGVhckNhdWdodEVycm9yJDEoKTsKICAgICAgICAgICAgICBjYXB0dXJlRXJyb3IoY3VycmVudCwgdW5tb3VudEVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQpIHsKICAgICAgICAgIHZhciByZWYgPSBjdXJyZW50LnJlZjsKCiAgICAgICAgICBpZiAocmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpbnZva2VHdWFyZGVkQ2FsbGJhY2skMihudWxsLCByZWYsIG51bGwsIG51bGwpOwoKICAgICAgICAgICAgICBpZiAoaGFzQ2F1Z2h0RXJyb3IkMSgpKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVmRXJyb3IgPSBjbGVhckNhdWdodEVycm9yJDEoKTsKICAgICAgICAgICAgICAgIGNhcHR1cmVFcnJvcihjdXJyZW50LCByZWZFcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjb21taXRMaWZlQ3ljbGVzKGN1cnJlbnQsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKCiAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmVmZmVjdFRhZyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0UGhhc2VUaW1lcihmaW5pc2hlZFdvcmssICJjb21wb25lbnREaWRNb3VudCIpOwogICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgICAgIHN0b3BQaGFzZVRpbWVyKCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgIHN0YXJ0UGhhc2VUaW1lcihmaW5pc2hlZFdvcmssICJjb21wb25lbnREaWRVcGRhdGUiKTsKICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcywgcHJldlN0YXRlKTsKICAgICAgICAgICAgICAgICAgICBzdG9wUGhhc2VUaW1lcigpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwoKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb21taXRDYWxsYmFja3ModXBkYXRlUXVldWUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgX3VwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwoKICAgICAgICAgICAgICAgIGlmIChfdXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZSA9IGZpbmlzaGVkV29yay5jaGlsZCAhPT0gbnVsbCA/IGZpbmlzaGVkV29yay5jaGlsZC5zdGF0ZU5vZGUgOiBudWxsOwoKICAgICAgICAgICAgICAgICAgY29tbWl0Q2FsbGJhY2tzKF91cGRhdGVRdWV1ZSwgX2luc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UyID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKCiAgICAgICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCAmJiBmaW5pc2hlZFdvcmsuZWZmZWN0VGFnICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmluaXNoZWRXb3JrLnR5cGU7CiAgICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICBjb21taXRNb3VudChfaW5zdGFuY2UyLCB0eXBlLCBwcm9wcywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIlRoaXMgdW5pdCBvZiB3b3JrIHRhZyBzaG91bGQgbm90IGhhdmUgc2lkZS1lZmZlY3RzLiBUaGlzIGVycm9yIGlzICIgKyAibGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29tbWl0QXR0YWNoUmVmKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHJlZiA9IGZpbmlzaGVkV29yay5yZWY7CgogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwoKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgcmVmKGdldFB1YmxpY0luc3RhbmNlKGluc3RhbmNlKSk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJlZihpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERldGFjaFJlZihjdXJyZW50KSB7CiAgICAgICAgICB2YXIgY3VycmVudFJlZiA9IGN1cnJlbnQucmVmOwoKICAgICAgICAgIGlmIChjdXJyZW50UmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgIGN1cnJlbnRSZWYobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjb21taXRVbm1vdW50KGN1cnJlbnQpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygb25Db21taXRVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIG9uQ29tbWl0VW5tb3VudChjdXJyZW50KTsKICAgICAgICAgIH0KCiAgICAgICAgICBzd2l0Y2ggKGN1cnJlbnQudGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gY3VycmVudC5zdGF0ZU5vZGU7CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoY3VycmVudCwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNhc2UgQ2FsbENvbXBvbmVudDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb21taXROZXN0ZWRVbm1vdW50cyhjdXJyZW50LnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChlbmFibGVNdXRhdGluZ1JlY29uY2lsZXIgJiYgbXV0YXRpb24pIHsKICAgICAgICAgICAgICAgICAgdW5tb3VudEhvc3RDb21wb25lbnRzKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbmFibGVQZXJzaXN0ZW50UmVjb25jaWxlciAmJiBwZXJzaXN0ZW5jZSkgewogICAgICAgICAgICAgICAgICBlbXB0eVBvcnRhbENvbnRhaW5lcihjdXJyZW50KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29tbWl0TmVzdGVkVW5tb3VudHMocm9vdCkgewogICAgICAgICAgdmFyIG5vZGUgPSByb290OwoKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGNvbW1pdFVubW91bnQobm9kZSk7CgogICAgICAgICAgICBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCAmJiAoIW11dGF0aW9uIHx8IG5vZGUudGFnICE9PSBIb3N0UG9ydGFsKSkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGRbInJldHVybiJdID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG5vZGUgPT09IHJvb3QpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZVsicmV0dXJuIl0gPT09IG51bGwgfHwgbm9kZVsicmV0dXJuIl0gPT09IHJvb3QpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIG5vZGUgPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbm9kZS5zaWJsaW5nWyJyZXR1cm4iXSA9IG5vZGVbInJldHVybiJdOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRmliZXIoY3VycmVudCkgewogICAgICAgICAgY3VycmVudFsicmV0dXJuIl0gPSBudWxsOwogICAgICAgICAgY3VycmVudC5jaGlsZCA9IG51bGw7CgogICAgICAgICAgaWYgKGN1cnJlbnQuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgIGN1cnJlbnQuYWx0ZXJuYXRlLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgY3VycmVudC5hbHRlcm5hdGVbInJldHVybiJdID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghbXV0YXRpb24pIHsKICAgICAgICAgIHZhciBjb21taXRDb250YWluZXIgPSB2b2lkIDA7CgogICAgICAgICAgaWYgKHBlcnNpc3RlbmNlKSB7CiAgICAgICAgICAgIHZhciByZXBsYWNlQ29udGFpbmVyQ2hpbGRyZW4gPSBwZXJzaXN0ZW5jZS5yZXBsYWNlQ29udGFpbmVyQ2hpbGRyZW4sCiAgICAgICAgICAgICAgICBjcmVhdGVDb250YWluZXJDaGlsZFNldCA9IHBlcnNpc3RlbmNlLmNyZWF0ZUNvbnRhaW5lckNoaWxkU2V0OwoKICAgICAgICAgICAgdmFyIGVtcHR5UG9ydGFsQ29udGFpbmVyID0gZnVuY3Rpb24gZW1wdHlQb3J0YWxDb250YWluZXIoY3VycmVudCkgewogICAgICAgICAgICAgIHZhciBwb3J0YWwgPSBjdXJyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgY29udGFpbmVySW5mbyA9IHBvcnRhbC5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgIHZhciBlbXB0eUNoaWxkU2V0ID0gY3JlYXRlQ29udGFpbmVyQ2hpbGRTZXQoY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgcmVwbGFjZUNvbnRhaW5lckNoaWxkcmVuKGNvbnRhaW5lckluZm8sIGVtcHR5Q2hpbGRTZXQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY29tbWl0Q29udGFpbmVyID0gZnVuY3Rpb24gY29tbWl0Q29udGFpbmVyKGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBvcnRhbE9yUm9vdCA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lckluZm8gPSBwb3J0YWxPclJvb3QuY29udGFpbmVySW5mbywKICAgICAgICAgICAgICAgICAgICAgICAgX3BlbmRpbmdDaGlsZHJlbiA9IHBvcnRhbE9yUm9vdC5wZW5kaW5nQ2hpbGRyZW47CiAgICAgICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRhaW5lckNoaWxkcmVuKGNvbnRhaW5lckluZm8sIF9wZW5kaW5nQ2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpbnZhcmlhbnQoZmFsc2UsICJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyAiICsgImxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29tbWl0Q29udGFpbmVyID0gZnVuY3Rpb24gY29tbWl0Q29udGFpbmVyKGZpbmlzaGVkV29yaykge307CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGVuYWJsZVBlcnNpc3RlbnRSZWNvbmNpbGVyIHx8IGVuYWJsZU5vb3BSZWNvbmNpbGVyKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgY29tbWl0UmVzZXRUZXh0Q29udGVudDogZnVuY3Rpb24gY29tbWl0UmVzZXRUZXh0Q29udGVudChmaW5pc2hlZFdvcmspIHt9LAogICAgICAgICAgICAgIGNvbW1pdFBsYWNlbWVudDogZnVuY3Rpb24gY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yaykge30sCiAgICAgICAgICAgICAgY29tbWl0RGVsZXRpb246IGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uKGN1cnJlbnQpIHsKICAgICAgICAgICAgICAgIGNvbW1pdE5lc3RlZFVubW91bnRzKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgZGV0YWNoRmliZXIoY3VycmVudCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjb21taXRXb3JrOiBmdW5jdGlvbiBjb21taXRXb3JrKGN1cnJlbnQsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgY29tbWl0Q29udGFpbmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjb21taXRMaWZlQ3ljbGVzOiBjb21taXRMaWZlQ3ljbGVzLAogICAgICAgICAgICAgIGNvbW1pdEF0dGFjaFJlZjogY29tbWl0QXR0YWNoUmVmLAogICAgICAgICAgICAgIGNvbW1pdERldGFjaFJlZjogY29tbWl0RGV0YWNoUmVmCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKHBlcnNpc3RlbmNlKSB7CiAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIlBlcnNpc3RlbnQgcmVjb25jaWxlciBpcyBkaXNhYmxlZC4iKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIk5vb3AgcmVjb25jaWxlciBpcyBkaXNhYmxlZC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBjb21taXRNb3VudCA9IG11dGF0aW9uLmNvbW1pdE1vdW50LAogICAgICAgICAgICBjb21taXRVcGRhdGUgPSBtdXRhdGlvbi5jb21taXRVcGRhdGUsCiAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQgPSBtdXRhdGlvbi5yZXNldFRleHRDb250ZW50LAogICAgICAgICAgICBjb21taXRUZXh0VXBkYXRlID0gbXV0YXRpb24uY29tbWl0VGV4dFVwZGF0ZSwKICAgICAgICAgICAgYXBwZW5kQ2hpbGQgPSBtdXRhdGlvbi5hcHBlbmRDaGlsZCwKICAgICAgICAgICAgYXBwZW5kQ2hpbGRUb0NvbnRhaW5lciA9IG11dGF0aW9uLmFwcGVuZENoaWxkVG9Db250YWluZXIsCiAgICAgICAgICAgIGluc2VydEJlZm9yZSA9IG11dGF0aW9uLmluc2VydEJlZm9yZSwKICAgICAgICAgICAgaW5zZXJ0SW5Db250YWluZXJCZWZvcmUgPSBtdXRhdGlvbi5pbnNlcnRJbkNvbnRhaW5lckJlZm9yZSwKICAgICAgICAgICAgcmVtb3ZlQ2hpbGQgPSBtdXRhdGlvbi5yZW1vdmVDaGlsZCwKICAgICAgICAgICAgcmVtb3ZlQ2hpbGRGcm9tQ29udGFpbmVyID0gbXV0YXRpb24ucmVtb3ZlQ2hpbGRGcm9tQ29udGFpbmVyOwoKICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UGFyZW50RmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnQgPSBmaWJlclsicmV0dXJuIl07CgogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaXNIb3N0UGFyZW50KHBhcmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcGFyZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnRbInJldHVybiJdOwogICAgICAgICAgfQoKICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIkV4cGVjdGVkIHRvIGZpbmQgYSBob3N0IHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnICIgKyAiaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaXNIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZmliZXIudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgfHwgZmliZXIudGFnID09PSBIb3N0UG9ydGFsOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFNpYmxpbmcoZmliZXIpIHsKICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CgogICAgICAgICAgc2libGluZ3M6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZVsicmV0dXJuIl0gPT09IG51bGwgfHwgaXNIb3N0UGFyZW50KG5vZGVbInJldHVybiJdKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBub2RlID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vZGUuc2libGluZ1sicmV0dXJuIl0gPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKCiAgICAgICAgICAgIHdoaWxlIChub2RlLnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiBub2RlLnRhZyAhPT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5lZmZlY3RUYWcgJiBQbGFjZW1lbnQpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlIHNpYmxpbmdzOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGQgPT09IG51bGwgfHwgbm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlIHNpYmxpbmdzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkWyJyZXR1cm4iXSA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghKG5vZGUuZWZmZWN0VGFnICYgUGxhY2VtZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZ2V0SG9zdFBhcmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICB2YXIgcGFyZW50ID0gdm9pZCAwOwogICAgICAgICAgdmFyIGlzQ29udGFpbmVyID0gdm9pZCAwOwoKICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgaXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgIGlzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaW52YXJpYW50KGZhbHNlLCAiSW52YWxpZCBob3N0IHBhcmVudCBmaWJlci4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnICIgKyAiaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5lZmZlY3RUYWcgJiBDb250ZW50UmVzZXQpIHsKICAgICAgICAgICAgcmVzZXRUZXh0Q29udGVudChwYXJlbnQpOwogICAgICAgICAgICBwYXJlbnRGaWJlci5lZmZlY3RUYWcgJj0gfkNvbnRlbnRSZXNldDsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgYmVmb3JlID0gZ2V0SG9zdFNpYmxpbmcoZmluaXNoZWRXb3JrKTsKICAgICAgICAgIHZhciBub2RlID0gZmluaXNoZWRXb3JrOwoKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgaW5zZXJ0SW5Db250YWluZXJCZWZvcmUocGFyZW50LCBub2RlLnN0YXRlTm9kZSwgYmVmb3JlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGluc2VydEJlZm9yZShwYXJlbnQsIG5vZGUuc3RhdGVOb2RlLCBiZWZvcmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoaXNDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcihwYXJlbnQsIG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGFwcGVuZENoaWxkKHBhcmVudCwgbm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnRhZyA9PT0gSG9zdFBvcnRhbCkge30gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGRbInJldHVybiJdID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlWyJyZXR1cm4iXSA9PT0gbnVsbCB8fCBub2RlWyJyZXR1cm4iXSA9PT0gZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBub2RlID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vZGUuc2libGluZ1sicmV0dXJuIl0gPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVubW91bnRIb3N0Q29tcG9uZW50cyhjdXJyZW50KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGN1cnJlbnQ7CiAgICAgICAgICB2YXIgY3VycmVudFBhcmVudElzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gdm9pZCAwOwogICAgICAgICAgdmFyIGN1cnJlbnRQYXJlbnRJc0NvbnRhaW5lciA9IHZvaWQgMDsKCiAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICBpZiAoIWN1cnJlbnRQYXJlbnRJc1ZhbGlkKSB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IG5vZGVbInJldHVybiJdOwoKICAgICAgICAgICAgICBmaW5kUGFyZW50OiB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaW52YXJpYW50KHBhcmVudCAhPT0gbnVsbCwgIkV4cGVjdGVkIHRvIGZpbmQgYSBob3N0IHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5ICIgKyAiYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwoKICAgICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50LnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKCiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CgogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50WyJyZXR1cm4iXTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGN1cnJlbnRQYXJlbnRJc1ZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgIGNvbW1pdE5lc3RlZFVubW91bnRzKG5vZGUpOwoKICAgICAgICAgICAgICBpZiAoY3VycmVudFBhcmVudElzQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICByZW1vdmVDaGlsZEZyb21Db250YWluZXIoY3VycmVudFBhcmVudCwgbm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZW1vdmVDaGlsZChjdXJyZW50UGFyZW50LCBub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgY3VycmVudFBhcmVudCA9IG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CgogICAgICAgICAgICAgIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkWyJyZXR1cm4iXSA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRVbm1vdW50KG5vZGUpOwoKICAgICAgICAgICAgICBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZFsicmV0dXJuIl0gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChub2RlID09PSBjdXJyZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGVbInJldHVybiJdID09PSBudWxsIHx8IG5vZGVbInJldHVybiJdID09PSBjdXJyZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBub2RlID0gbm9kZVsicmV0dXJuIl07CgogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgY3VycmVudFBhcmVudElzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vZGUuc2libGluZ1sicmV0dXJuIl0gPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uKGN1cnJlbnQpIHsKICAgICAgICAgIHVubW91bnRIb3N0Q29tcG9uZW50cyhjdXJyZW50KTsKICAgICAgICAgIGRldGFjaEZpYmVyKGN1cnJlbnQpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29tbWl0V29yayhjdXJyZW50LCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKCiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudCAhPT0gbnVsbCA/IGN1cnJlbnQubWVtb2l6ZWRQcm9wcyA6IG5ld1Byb3BzOwogICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpbmlzaGVkV29yay50eXBlOwogICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlKGluc3RhbmNlLCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpbnZhcmlhbnQoZmluaXNoZWRXb3JrLnN0YXRlTm9kZSAhPT0gbnVsbCwgIlRoaXMgc2hvdWxkIGhhdmUgYSB0ZXh0IG5vZGUgaW5pdGlhbGl6ZWQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5ICIgKyAiY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIHZhciB0ZXh0SW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gY3VycmVudCAhPT0gbnVsbCA/IGN1cnJlbnQubWVtb2l6ZWRQcm9wcyA6IG5ld1RleHQ7CiAgICAgICAgICAgICAgICBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpbnZhcmlhbnQoZmFsc2UsICJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyAiICsgImxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFJlc2V0VGV4dENvbnRlbnQoY3VycmVudCkgewogICAgICAgICAgcmVzZXRUZXh0Q29udGVudChjdXJyZW50LnN0YXRlTm9kZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoZW5hYmxlTXV0YXRpbmdSZWNvbmNpbGVyKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBjb21taXRSZXNldFRleHRDb250ZW50OiBjb21taXRSZXNldFRleHRDb250ZW50LAogICAgICAgICAgICBjb21taXRQbGFjZW1lbnQ6IGNvbW1pdFBsYWNlbWVudCwKICAgICAgICAgICAgY29tbWl0RGVsZXRpb246IGNvbW1pdERlbGV0aW9uLAogICAgICAgICAgICBjb21taXRXb3JrOiBjb21taXRXb3JrLAogICAgICAgICAgICBjb21taXRMaWZlQ3ljbGVzOiBjb21taXRMaWZlQ3ljbGVzLAogICAgICAgICAgICBjb21taXRBdHRhY2hSZWY6IGNvbW1pdEF0dGFjaFJlZiwKICAgICAgICAgICAgY29tbWl0RGV0YWNoUmVmOiBjb21taXREZXRhY2hSZWYKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIk11dGF0aW5nIHJlY29uY2lsZXIgaXMgZGlzYWJsZWQuIik7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIE5PX0NPTlRFWFQgPSB7fTsKCiAgICAgIHZhciBSZWFjdEZpYmVySG9zdENvbnRleHQgPSBmdW5jdGlvbiBSZWFjdEZpYmVySG9zdENvbnRleHQoY29uZmlnKSB7CiAgICAgICAgdmFyIGdldENoaWxkSG9zdENvbnRleHQgPSBjb25maWcuZ2V0Q2hpbGRIb3N0Q29udGV4dCwKICAgICAgICAgICAgZ2V0Um9vdEhvc3RDb250ZXh0ID0gY29uZmlnLmdldFJvb3RIb3N0Q29udGV4dDsKICAgICAgICB2YXIgY29udGV4dFN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIHZhciBjb250ZXh0RmliZXJTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICB2YXIgcm9vdEluc3RhbmNlU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CgogICAgICAgIGZ1bmN0aW9uIHJlcXVpcmVkQ29udGV4dChjKSB7CiAgICAgICAgICBpbnZhcmlhbnQoYyAhPT0gTk9fQ09OVEVYVCwgIkV4cGVjdGVkIGhvc3QgY29udGV4dCB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnICIgKyAiaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRSb290SG9zdENvbnRhaW5lcigpIHsKICAgICAgICAgIHZhciByb290SW5zdGFuY2UgPSByZXF1aXJlZENvbnRleHQocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICByZXR1cm4gcm9vdEluc3RhbmNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RDb250YWluZXIoZmliZXIsIG5leHRSb290SW5zdGFuY2UpIHsKICAgICAgICAgIHB1c2gocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IsIG5leHRSb290SW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICAgIHZhciBuZXh0Um9vdENvbnRleHQgPSBnZXRSb290SG9zdENvbnRleHQobmV4dFJvb3RJbnN0YW5jZSk7CiAgICAgICAgICBwdXNoKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlciwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIG5leHRSb290Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcG9wSG9zdENvbnRhaW5lcihmaWJlcikgewogICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgcG9wKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICBwb3Aocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RDb250ZXh0KCkgewogICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIHZhciByb290SW5zdGFuY2UgPSByZXF1aXJlZENvbnRleHQocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHJlcXVpcmVkQ29udGV4dChjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBnZXRDaGlsZEhvc3RDb250ZXh0KGNvbnRleHQsIGZpYmVyLnR5cGUsIHJvb3RJbnN0YW5jZSk7CgogICAgICAgICAgaWYgKGNvbnRleHQgPT09IG5leHRDb250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBwdXNoKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlciwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIG5leHRDb250ZXh0LCBmaWJlcik7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwb3BIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgICAgaWYgKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICBwb3AoY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlc2V0SG9zdENvbnRhaW5lcigpIHsKICAgICAgICAgIGNvbnRleHRTdGFja0N1cnNvci5jdXJyZW50ID0gTk9fQ09OVEVYVDsKICAgICAgICAgIHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLmN1cnJlbnQgPSBOT19DT05URVhUOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGdldEhvc3RDb250ZXh0OiBnZXRIb3N0Q29udGV4dCwKICAgICAgICAgIGdldFJvb3RIb3N0Q29udGFpbmVyOiBnZXRSb290SG9zdENvbnRhaW5lciwKICAgICAgICAgIHBvcEhvc3RDb250YWluZXI6IHBvcEhvc3RDb250YWluZXIsCiAgICAgICAgICBwb3BIb3N0Q29udGV4dDogcG9wSG9zdENvbnRleHQsCiAgICAgICAgICBwdXNoSG9zdENvbnRhaW5lcjogcHVzaEhvc3RDb250YWluZXIsCiAgICAgICAgICBwdXNoSG9zdENvbnRleHQ6IHB1c2hIb3N0Q29udGV4dCwKICAgICAgICAgIHJlc2V0SG9zdENvbnRhaW5lcjogcmVzZXRIb3N0Q29udGFpbmVyCiAgICAgICAgfTsKICAgICAgfTsKCiAgICAgIHZhciBSZWFjdEZpYmVySHlkcmF0aW9uQ29udGV4dCA9IGZ1bmN0aW9uIFJlYWN0RmliZXJIeWRyYXRpb25Db250ZXh0KGNvbmZpZykgewogICAgICAgIHZhciBzaG91bGRTZXRUZXh0Q29udGVudCA9IGNvbmZpZy5zaG91bGRTZXRUZXh0Q29udGVudCwKICAgICAgICAgICAgaHlkcmF0aW9uID0gY29uZmlnLmh5ZHJhdGlvbjsKCiAgICAgICAgaWYgKCFoeWRyYXRpb24pIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGVudGVySHlkcmF0aW9uU3RhdGU6IGZ1bmN0aW9uIGVudGVySHlkcmF0aW9uU3RhdGUoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlOiBmdW5jdGlvbiByZXNldEh5ZHJhdGlvblN0YXRlKCkge30sCiAgICAgICAgICAgIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlOiBmdW5jdGlvbiB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSgpIHt9LAogICAgICAgICAgICBwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlOiBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKCkgewogICAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIkV4cGVjdGVkIHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2UoKSB0byBuZXZlciBiZSBjYWxsZWQuICIgKyAiVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2U6IGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKCkgewogICAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIkV4cGVjdGVkIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKCkgdG8gbmV2ZXIgYmUgY2FsbGVkLiAiICsgIlRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBvcEh5ZHJhdGlvblN0YXRlOiBmdW5jdGlvbiBwb3BIeWRyYXRpb25TdGF0ZShmaWJlcikgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHZhciBjYW5IeWRyYXRlSW5zdGFuY2UgPSBoeWRyYXRpb24uY2FuSHlkcmF0ZUluc3RhbmNlLAogICAgICAgICAgICBjYW5IeWRyYXRlVGV4dEluc3RhbmNlID0gaHlkcmF0aW9uLmNhbkh5ZHJhdGVUZXh0SW5zdGFuY2UsCiAgICAgICAgICAgIGdldE5leHRIeWRyYXRhYmxlU2libGluZyA9IGh5ZHJhdGlvbi5nZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcsCiAgICAgICAgICAgIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkID0gaHlkcmF0aW9uLmdldEZpcnN0SHlkcmF0YWJsZUNoaWxkLAogICAgICAgICAgICBoeWRyYXRlSW5zdGFuY2UgPSBoeWRyYXRpb24uaHlkcmF0ZUluc3RhbmNlLAogICAgICAgICAgICBoeWRyYXRlVGV4dEluc3RhbmNlID0gaHlkcmF0aW9uLmh5ZHJhdGVUZXh0SW5zdGFuY2UsCiAgICAgICAgICAgIGRpZE5vdE1hdGNoSHlkcmF0ZWRDb250YWluZXJUZXh0SW5zdGFuY2UgPSBoeWRyYXRpb24uZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZSwKICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZFRleHRJbnN0YW5jZSA9IGh5ZHJhdGlvbi5kaWROb3RNYXRjaEh5ZHJhdGVkVGV4dEluc3RhbmNlLAogICAgICAgICAgICBkaWROb3RIeWRyYXRlQ29udGFpbmVySW5zdGFuY2UgPSBoeWRyYXRpb24uZGlkTm90SHlkcmF0ZUNvbnRhaW5lckluc3RhbmNlLAogICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2UgPSBoeWRyYXRpb24uZGlkTm90SHlkcmF0ZUluc3RhbmNlLAogICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUNvbnRhaW5lckluc3RhbmNlID0gaHlkcmF0aW9uLmRpZE5vdEZpbmRIeWRyYXRhYmxlQ29udGFpbmVySW5zdGFuY2UsCiAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlQ29udGFpbmVyVGV4dEluc3RhbmNlID0gaHlkcmF0aW9uLmRpZE5vdEZpbmRIeWRyYXRhYmxlQ29udGFpbmVyVGV4dEluc3RhbmNlLAogICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlID0gaHlkcmF0aW9uLmRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2UsCiAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlID0gaHlkcmF0aW9uLmRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlOwogICAgICAgIHZhciBoeWRyYXRpb25QYXJlbnRGaWJlciA9IG51bGw7CiAgICAgICAgdmFyIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBudWxsOwogICAgICAgIHZhciBpc0h5ZHJhdGluZyA9IGZhbHNlOwoKICAgICAgICBmdW5jdGlvbiBlbnRlckh5ZHJhdGlvblN0YXRlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50SW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChwYXJlbnRJbnN0YW5jZSk7CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkZWxldGVIeWRyYXRhYmxlSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgIGRpZE5vdEh5ZHJhdGVDb250YWluZXJJbnN0YW5jZShyZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbywgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZShyZXR1cm5GaWJlci50eXBlLCByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzLCByZXR1cm5GaWJlci5zdGF0ZU5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCk7CiAgICAgICAgICBjaGlsZFRvRGVsZXRlLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZVsicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgICAgIGNoaWxkVG9EZWxldGUuZWZmZWN0VGFnID0gRGVsZXRpb247CgogICAgICAgICAgaWYgKHJldHVybkZpYmVyLmxhc3RFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuRmliZXIubGFzdEVmZmVjdC5uZXh0RWZmZWN0ID0gY2hpbGRUb0RlbGV0ZTsKICAgICAgICAgICAgcmV0dXJuRmliZXIubGFzdEVmZmVjdCA9IGNoaWxkVG9EZWxldGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm5GaWJlci5maXJzdEVmZmVjdCA9IHJldHVybkZpYmVyLmxhc3RFZmZlY3QgPSBjaGlsZFRvRGVsZXRlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpIHsKICAgICAgICAgIGZpYmVyLmVmZmVjdFRhZyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudENvbnRhaW5lciA9IHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwoKICAgICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUNvbnRhaW5lckluc3RhbmNlKHBhcmVudENvbnRhaW5lciwgdHlwZSwgcHJvcHMpOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlQ29udGFpbmVyVGV4dEluc3RhbmNlKHBhcmVudENvbnRhaW5lciwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFR5cGUgPSByZXR1cm5GaWJlci50eXBlOwogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50UHJvcHMgPSByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50SW5zdGFuY2UgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGU7CgogICAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICAgIHZhciBfdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgX3Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIF90eXBlLCBfcHJvcHMpOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgICAgICAgICB2YXIgX3RleHQgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIF90ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgICAgdmFyIHByb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gY2FuSHlkcmF0ZUluc3RhbmNlKG5leHRJbnN0YW5jZSwgdHlwZSwgcHJvcHMpOwoKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRleHQgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShuZXh0SW5zdGFuY2UsIHRleHQpOwoKICAgICAgICAgICAgICAgIGlmICh0ZXh0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gdGV4dEluc3RhbmNlOwogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CgogICAgICAgICAgaWYgKCFuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwoKICAgICAgICAgICAgaWYgKCFuZXh0SW5zdGFuY2UgfHwgIXRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBuZXh0SHlkcmF0YWJsZUluc3RhbmNlKTsKICAgICAgICAgIH0KCiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkKG5leHRJbnN0YW5jZSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKGZpYmVyLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgZmliZXIudHlwZSwgZmliZXIubWVtb2l6ZWRQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgZmliZXIpOwogICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSB1cGRhdGVQYXlsb2FkOwoKICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gZmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBoeWRyYXRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dENvbnRlbnQsIGZpYmVyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGh5ZHJhdGlvblBhcmVudEZpYmVyOwoKICAgICAgICAgICAgICBpZiAocmV0dXJuRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudENvbnRhaW5lciA9IHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZShwYXJlbnRDb250YWluZXIsIHRleHRJbnN0YW5jZSwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUeXBlID0gcmV0dXJuRmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRQcm9wcyA9IHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50SW5zdGFuY2UgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICBkaWROb3RNYXRjaEh5ZHJhdGVkVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dEluc3RhbmNlLCB0ZXh0Q29udGVudCk7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcG9wVG9OZXh0SG9zdFBhcmVudChmaWJlcikgewogICAgICAgICAgdmFyIHBhcmVudCA9IGZpYmVyWyJyZXR1cm4iXTsKCiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsICYmIHBhcmVudC50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgcGFyZW50LnRhZyAhPT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50WyJyZXR1cm4iXTsKICAgICAgICAgIH0KCiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IHBhcmVudDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHBvcEh5ZHJhdGlvblN0YXRlKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIgIT09IGh5ZHJhdGlvblBhcmVudEZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIHBvcFRvTmV4dEhvc3RQYXJlbnQoZmliZXIpOwogICAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgdHlwZSA9IGZpYmVyLnR5cGU7CgogICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gSG9zdENvbXBvbmVudCB8fCB0eXBlICE9PSAiaGVhZCIgJiYgdHlwZSAhPT0gImJvZHkiICYmICFzaG91bGRTZXRUZXh0Q29udGVudCh0eXBlLCBmaWJlci5tZW1vaXplZFByb3BzKSkgewogICAgICAgICAgICB2YXIgbmV4dEluc3RhbmNlID0gbmV4dEh5ZHJhdGFibGVJbnN0YW5jZTsKCiAgICAgICAgICAgIHdoaWxlIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICBkZWxldGVIeWRyYXRhYmxlSW5zdGFuY2UoZmliZXIsIG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBoeWRyYXRpb25QYXJlbnRGaWJlciA/IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhmaWJlci5zdGF0ZU5vZGUpIDogbnVsbDsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVzZXRIeWRyYXRpb25TdGF0ZSgpIHsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gbnVsbDsKICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBlbnRlckh5ZHJhdGlvblN0YXRlOiBlbnRlckh5ZHJhdGlvblN0YXRlLAogICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZTogcmVzZXRIeWRyYXRpb25TdGF0ZSwKICAgICAgICAgIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlOiB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSwKICAgICAgICAgIHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2U6IHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2UsCiAgICAgICAgICBwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZTogcHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2UsCiAgICAgICAgICBwb3BIeWRyYXRpb25TdGF0ZTogcG9wSHlkcmF0aW9uU3RhdGUKICAgICAgICB9OwogICAgICB9OwoKICAgICAgdmFyIFJlYWN0RmliZXJJbnN0cnVtZW50YXRpb24gPSB7CiAgICAgICAgZGVidWdUb29sOiBudWxsCiAgICAgIH07CiAgICAgIHZhciBSZWFjdEZpYmVySW5zdHJ1bWVudGF0aW9uXzEgPSBSZWFjdEZpYmVySW5zdHJ1bWVudGF0aW9uOwogICAgICB2YXIgaW52b2tlR3VhcmRlZENhbGxiYWNrJDEgPSBSZWFjdEVycm9yVXRpbHMuaW52b2tlR3VhcmRlZENhbGxiYWNrOwogICAgICB2YXIgaGFzQ2F1Z2h0RXJyb3IgPSBSZWFjdEVycm9yVXRpbHMuaGFzQ2F1Z2h0RXJyb3I7CiAgICAgIHZhciBjbGVhckNhdWdodEVycm9yID0gUmVhY3RFcnJvclV0aWxzLmNsZWFyQ2F1Z2h0RXJyb3I7CiAgICAgIHsKICAgICAgICB2YXIgZGlkV2FybkFib3V0U3RhdGVUcmFuc2l0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5TZXRTdGF0ZUNoaWxkQ29udGV4dCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnQgPSB7fTsKCiAgICAgICAgdmFyIHdhcm5BYm91dFVwZGF0ZU9uVW5tb3VudGVkID0gZnVuY3Rpb24gd2FybkFib3V0VXBkYXRlT25Vbm1vdW50ZWQoZmliZXIpIHsKICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZShmaWJlcikgfHwgIlJlYWN0Q2xhc3MiOwoKICAgICAgICAgIGlmIChkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICJDYW4gb25seSB1cGRhdGUgYSBtb3VudGVkIG9yIG1vdW50aW5nICIgKyAiY29tcG9uZW50LiBUaGlzIHVzdWFsbHkgbWVhbnMgeW91IGNhbGxlZCBzZXRTdGF0ZSwgcmVwbGFjZVN0YXRlLCAiICsgIm9yIGZvcmNlVXBkYXRlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIFRoaXMgaXMgYSBuby1vcC5cblxuUGxlYXNlICIgKyAiY2hlY2sgdGhlIGNvZGUgZm9yIHRoZSAlcyBjb21wb25lbnQuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgIH07CgogICAgICAgIHZhciB3YXJuQWJvdXRJbnZhbGlkVXBkYXRlcyA9IGZ1bmN0aW9uIHdhcm5BYm91dEludmFsaWRVcGRhdGVzKGluc3RhbmNlKSB7CiAgICAgICAgICBzd2l0Y2ggKFJlYWN0RGVidWdDdXJyZW50RmliZXIucGhhc2UpIHsKICAgICAgICAgICAgY2FzZSAiZ2V0Q2hpbGRDb250ZXh0IjoKICAgICAgICAgICAgICBpZiAoZGlkV2FyblNldFN0YXRlQ2hpbGRDb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAic2V0U3RhdGUoLi4uKTogQ2Fubm90IGNhbGwgc2V0U3RhdGUoKSBpbnNpZGUgZ2V0Q2hpbGRDb250ZXh0KCkiKTsKICAgICAgICAgICAgICBkaWRXYXJuU2V0U3RhdGVDaGlsZENvbnRleHQgPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAicmVuZGVyIjoKICAgICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0U3RhdGVUcmFuc2l0aW9uKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAiQ2Fubm90IHVwZGF0ZSBkdXJpbmcgYW4gZXhpc3Rpbmcgc3RhdGUgdHJhbnNpdGlvbiAoc3VjaCBhcyB3aXRoaW4gIiArICJgcmVuZGVyYCBvciBhbm90aGVyIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yKS4gUmVuZGVyIG1ldGhvZHMgc2hvdWxkICIgKyAiYmUgYSBwdXJlIGZ1bmN0aW9uIG9mIHByb3BzIGFuZCBzdGF0ZTsgY29uc3RydWN0b3Igc2lkZS1lZmZlY3RzIGFyZSAiICsgImFuIGFudGktcGF0dGVybiwgYnV0IGNhbiBiZSBtb3ZlZCB0byBgY29tcG9uZW50V2lsbE1vdW50YC4iKTsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdGF0ZVRyYW5zaXRpb24gPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHZhciBSZWFjdEZpYmVyU2NoZWR1bGVyID0gZnVuY3Rpb24gUmVhY3RGaWJlclNjaGVkdWxlcihjb25maWcpIHsKICAgICAgICB2YXIgaG9zdENvbnRleHQgPSBSZWFjdEZpYmVySG9zdENvbnRleHQoY29uZmlnKTsKICAgICAgICB2YXIgaHlkcmF0aW9uQ29udGV4dCA9IFJlYWN0RmliZXJIeWRyYXRpb25Db250ZXh0KGNvbmZpZyk7CiAgICAgICAgdmFyIHBvcEhvc3RDb250YWluZXIgPSBob3N0Q29udGV4dC5wb3BIb3N0Q29udGFpbmVyLAogICAgICAgICAgICBwb3BIb3N0Q29udGV4dCA9IGhvc3RDb250ZXh0LnBvcEhvc3RDb250ZXh0LAogICAgICAgICAgICByZXNldEhvc3RDb250YWluZXIgPSBob3N0Q29udGV4dC5yZXNldEhvc3RDb250YWluZXI7CgogICAgICAgIHZhciBfUmVhY3RGaWJlckJlZ2luV29yayA9IFJlYWN0RmliZXJCZWdpbldvcmsoY29uZmlnLCBob3N0Q29udGV4dCwgaHlkcmF0aW9uQ29udGV4dCwgc2NoZWR1bGVXb3JrLCBjb21wdXRlRXhwaXJhdGlvbkZvckZpYmVyKSwKICAgICAgICAgICAgYmVnaW5Xb3JrID0gX1JlYWN0RmliZXJCZWdpbldvcmsuYmVnaW5Xb3JrLAogICAgICAgICAgICBiZWdpbkZhaWxlZFdvcmsgPSBfUmVhY3RGaWJlckJlZ2luV29yay5iZWdpbkZhaWxlZFdvcms7CgogICAgICAgIHZhciBfUmVhY3RGaWJlckNvbXBsZXRlV28gPSBSZWFjdEZpYmVyQ29tcGxldGVXb3JrKGNvbmZpZywgaG9zdENvbnRleHQsIGh5ZHJhdGlvbkNvbnRleHQpLAogICAgICAgICAgICBjb21wbGV0ZVdvcmsgPSBfUmVhY3RGaWJlckNvbXBsZXRlV28uY29tcGxldGVXb3JrOwoKICAgICAgICB2YXIgX1JlYWN0RmliZXJDb21taXRXb3JrID0gUmVhY3RGaWJlckNvbW1pdFdvcmsoY29uZmlnLCBjYXB0dXJlRXJyb3IpLAogICAgICAgICAgICBjb21taXRSZXNldFRleHRDb250ZW50ID0gX1JlYWN0RmliZXJDb21taXRXb3JrLmNvbW1pdFJlc2V0VGV4dENvbnRlbnQsCiAgICAgICAgICAgIGNvbW1pdFBsYWNlbWVudCA9IF9SZWFjdEZpYmVyQ29tbWl0V29yay5jb21taXRQbGFjZW1lbnQsCiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uID0gX1JlYWN0RmliZXJDb21taXRXb3JrLmNvbW1pdERlbGV0aW9uLAogICAgICAgICAgICBjb21taXRXb3JrID0gX1JlYWN0RmliZXJDb21taXRXb3JrLmNvbW1pdFdvcmssCiAgICAgICAgICAgIGNvbW1pdExpZmVDeWNsZXMgPSBfUmVhY3RGaWJlckNvbW1pdFdvcmsuY29tbWl0TGlmZUN5Y2xlcywKICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmID0gX1JlYWN0RmliZXJDb21taXRXb3JrLmNvbW1pdEF0dGFjaFJlZiwKICAgICAgICAgICAgY29tbWl0RGV0YWNoUmVmID0gX1JlYWN0RmliZXJDb21taXRXb3JrLmNvbW1pdERldGFjaFJlZjsKCiAgICAgICAgdmFyIG5vdyA9IGNvbmZpZy5ub3csCiAgICAgICAgICAgIHNjaGVkdWxlRGVmZXJyZWRDYWxsYmFjayA9IGNvbmZpZy5zY2hlZHVsZURlZmVycmVkQ2FsbGJhY2ssCiAgICAgICAgICAgIGNhbmNlbERlZmVycmVkQ2FsbGJhY2sgPSBjb25maWcuY2FuY2VsRGVmZXJyZWRDYWxsYmFjaywKICAgICAgICAgICAgdXNlU3luY1NjaGVkdWxpbmcgPSBjb25maWcudXNlU3luY1NjaGVkdWxpbmcsCiAgICAgICAgICAgIHByZXBhcmVGb3JDb21taXQgPSBjb25maWcucHJlcGFyZUZvckNvbW1pdCwKICAgICAgICAgICAgcmVzZXRBZnRlckNvbW1pdCA9IGNvbmZpZy5yZXNldEFmdGVyQ29tbWl0OwogICAgICAgIHZhciBzdGFydFRpbWUgPSBub3coKTsKICAgICAgICB2YXIgbW9zdFJlY2VudEN1cnJlbnRUaW1lID0gbXNUb0V4cGlyYXRpb25UaW1lKDApOwogICAgICAgIHZhciBsYXN0VW5pcXVlQXN5bmNFeHBpcmF0aW9uID0gMDsKICAgICAgICB2YXIgZXhwaXJhdGlvbkNvbnRleHQgPSBOb1dvcms7CiAgICAgICAgdmFyIGlzV29ya2luZyA9IGZhbHNlOwogICAgICAgIHZhciBuZXh0VW5pdE9mV29yayA9IG51bGw7CiAgICAgICAgdmFyIG5leHRSb290ID0gbnVsbDsKICAgICAgICB2YXIgbmV4dFJlbmRlckV4cGlyYXRpb25UaW1lID0gTm9Xb3JrOwogICAgICAgIHZhciBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICB2YXIgY2FwdHVyZWRFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciBmYWlsZWRCb3VuZGFyaWVzID0gbnVsbDsKICAgICAgICB2YXIgY29tbWl0UGhhc2VCb3VuZGFyaWVzID0gbnVsbDsKICAgICAgICB2YXIgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgZGlkRmF0YWwgPSBmYWxzZTsKICAgICAgICB2YXIgaXNDb21taXR0aW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGlzVW5tb3VudGluZyA9IGZhbHNlOwogICAgICAgIHZhciBpbnRlcnJ1cHRlZEJ5ID0gbnVsbDsKCiAgICAgICAgZnVuY3Rpb24gcmVzZXRDb250ZXh0U3RhY2soKSB7CiAgICAgICAgICByZXNldCgpOwogICAgICAgICAgcmVzZXRDb250ZXh0KCk7CiAgICAgICAgICByZXNldEhvc3RDb250YWluZXIoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEFsbEhvc3RFZmZlY3RzKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RmliZXIuc2V0Q3VycmVudEZpYmVyKG5leHRFZmZlY3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlY29yZEVmZmVjdCgpOwogICAgICAgICAgICB2YXIgZWZmZWN0VGFnID0gbmV4dEVmZmVjdC5lZmZlY3RUYWc7CgogICAgICAgICAgICBpZiAoZWZmZWN0VGFnICYgQ29udGVudFJlc2V0KSB7CiAgICAgICAgICAgICAgY29tbWl0UmVzZXRUZXh0Q29udGVudChuZXh0RWZmZWN0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGVmZmVjdFRhZyAmIFJlZikgewogICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gbmV4dEVmZmVjdC5hbHRlcm5hdGU7CgogICAgICAgICAgICAgIGlmIChjdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjb21taXREZXRhY2hSZWYoY3VycmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcHJpbWFyeUVmZmVjdFRhZyA9IGVmZmVjdFRhZyAmIH4oQ2FsbGJhY2sgfCBFcnIgfCBDb250ZW50UmVzZXQgfCBSZWYgfCBQZXJmb3JtZWRXb3JrKTsKCiAgICAgICAgICAgIHN3aXRjaCAocHJpbWFyeUVmZmVjdFRhZykgewogICAgICAgICAgICAgIGNhc2UgUGxhY2VtZW50OgogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjb21taXRQbGFjZW1lbnQobmV4dEVmZmVjdCk7CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QuZWZmZWN0VGFnICY9IH5QbGFjZW1lbnQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjYXNlIFBsYWNlbWVudEFuZFVwZGF0ZToKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgY29tbWl0UGxhY2VtZW50KG5leHRFZmZlY3QpOwogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0LmVmZmVjdFRhZyAmPSB+UGxhY2VtZW50OwogICAgICAgICAgICAgICAgICB2YXIgX2N1cnJlbnQgPSBuZXh0RWZmZWN0LmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgY29tbWl0V29yayhfY3VycmVudCwgbmV4dEVmZmVjdCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjYXNlIFVwZGF0ZToKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIF9jdXJyZW50MiA9IG5leHRFZmZlY3QuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBjb21taXRXb3JrKF9jdXJyZW50MiwgbmV4dEVmZmVjdCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjYXNlIERlbGV0aW9uOgogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpc1VubW91bnRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICBjb21taXREZWxldGlvbihuZXh0RWZmZWN0KTsKICAgICAgICAgICAgICAgICAgaXNVbm1vdW50aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXh0RWZmZWN0ID0gbmV4dEVmZmVjdC5uZXh0RWZmZWN0OwogICAgICAgICAgfQoKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5yZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29tbWl0QWxsTGlmZUN5Y2xlcygpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBlZmZlY3RUYWcgPSBuZXh0RWZmZWN0LmVmZmVjdFRhZzsKCiAgICAgICAgICAgIGlmIChlZmZlY3RUYWcgJiAoVXBkYXRlIHwgQ2FsbGJhY2spKSB7CiAgICAgICAgICAgICAgcmVjb3JkRWZmZWN0KCk7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBuZXh0RWZmZWN0LmFsdGVybmF0ZTsKICAgICAgICAgICAgICBjb21taXRMaWZlQ3ljbGVzKGN1cnJlbnQsIG5leHRFZmZlY3QpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZWZmZWN0VGFnICYgUmVmKSB7CiAgICAgICAgICAgICAgcmVjb3JkRWZmZWN0KCk7CiAgICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKG5leHRFZmZlY3QpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZWZmZWN0VGFnICYgRXJyKSB7CiAgICAgICAgICAgICAgcmVjb3JkRWZmZWN0KCk7CiAgICAgICAgICAgICAgY29tbWl0RXJyb3JIYW5kbGluZyhuZXh0RWZmZWN0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG5leHQgPSBuZXh0RWZmZWN0Lm5leHRFZmZlY3Q7CiAgICAgICAgICAgIG5leHRFZmZlY3QubmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29tbWl0Um9vdChmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIGlzV29ya2luZyA9IHRydWU7CiAgICAgICAgICBpc0NvbW1pdHRpbmcgPSB0cnVlOwogICAgICAgICAgc3RhcnRDb21taXRUaW1lcigpOwogICAgICAgICAgdmFyIHJvb3QgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgaW52YXJpYW50KHJvb3QuY3VycmVudCAhPT0gZmluaXNoZWRXb3JrLCAiQ2Fubm90IGNvbW1pdCB0aGUgc2FtZSB0cmVlIGFzIGJlZm9yZS4gVGhpcyBpcyBwcm9iYWJseSBhIGJ1ZyAiICsgInJlbGF0ZWQgdG8gdGhlIHJldHVybiBmaWVsZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnICIgKyAiaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgcm9vdC5pc1JlYWR5Rm9yQ29tbWl0ID0gZmFsc2U7CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IHZvaWQgMDsKCiAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmVmZmVjdFRhZyA+IFBlcmZvcm1lZFdvcmspIHsKICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5sYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmluaXNoZWRXb3JrLmxhc3RFZmZlY3QubmV4dEVmZmVjdCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICBmaXJzdEVmZmVjdCA9IGZpbmlzaGVkV29yay5maXJzdEVmZmVjdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBmaXJzdEVmZmVjdCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmlyc3RFZmZlY3QgPSBmaW5pc2hlZFdvcmsuZmlyc3RFZmZlY3Q7CiAgICAgICAgICB9CgogICAgICAgICAgcHJlcGFyZUZvckNvbW1pdCgpOwogICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgc3RhcnRDb21taXRIb3N0RWZmZWN0c1RpbWVyKCk7CgogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGRpZEVycm9yID0gZmFsc2U7CgogICAgICAgICAgICB2YXIgX2Vycm9yID0gdm9pZCAwOwoKICAgICAgICAgICAgewogICAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayQxKG51bGwsIGNvbW1pdEFsbEhvc3RFZmZlY3RzLCBudWxsKTsKCiAgICAgICAgICAgICAgaWYgKGhhc0NhdWdodEVycm9yKCkpIHsKICAgICAgICAgICAgICAgIGRpZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgIF9lcnJvciA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaWRFcnJvcikgewogICAgICAgICAgICAgIGludmFyaWFudChuZXh0RWZmZWN0ICE9PSBudWxsLCAiU2hvdWxkIGhhdmUgbmV4dCBlZmZlY3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyAiICsgImluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICBjYXB0dXJlRXJyb3IobmV4dEVmZmVjdCwgX2Vycm9yKTsKCiAgICAgICAgICAgICAgaWYgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBuZXh0RWZmZWN0Lm5leHRFZmZlY3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgc3RvcENvbW1pdEhvc3RFZmZlY3RzVGltZXIoKTsKICAgICAgICAgIHJlc2V0QWZ0ZXJDb21taXQoKTsKICAgICAgICAgIHJvb3QuY3VycmVudCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgIHN0YXJ0Q29tbWl0TGlmZUN5Y2xlc1RpbWVyKCk7CgogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIF9kaWRFcnJvciA9IGZhbHNlOwoKICAgICAgICAgICAgdmFyIF9lcnJvcjIgPSB2b2lkIDA7CgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrJDEobnVsbCwgY29tbWl0QWxsTGlmZUN5Y2xlcywgbnVsbCk7CgogICAgICAgICAgICAgIGlmIChoYXNDYXVnaHRFcnJvcigpKSB7CiAgICAgICAgICAgICAgICBfZGlkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgX2Vycm9yMiA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfZGlkRXJyb3IpIHsKICAgICAgICAgICAgICBpbnZhcmlhbnQobmV4dEVmZmVjdCAhPT0gbnVsbCwgIlNob3VsZCBoYXZlIG5leHQgZWZmZWN0LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgIiArICJpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgY2FwdHVyZUVycm9yKG5leHRFZmZlY3QsIF9lcnJvcjIpOwoKICAgICAgICAgICAgICBpZiAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG5leHRFZmZlY3QubmV4dEVmZmVjdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpc0NvbW1pdHRpbmcgPSBmYWxzZTsKICAgICAgICAgIGlzV29ya2luZyA9IGZhbHNlOwogICAgICAgICAgc3RvcENvbW1pdExpZmVDeWNsZXNUaW1lcigpOwogICAgICAgICAgc3RvcENvbW1pdFRpbWVyKCk7CgogICAgICAgICAgaWYgKHR5cGVvZiBvbkNvbW1pdFJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgb25Db21taXRSb290KGZpbmlzaGVkV29yay5zdGF0ZU5vZGUpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0cnVlICYmIFJlYWN0RmliZXJJbnN0cnVtZW50YXRpb25fMS5kZWJ1Z1Rvb2wpIHsKICAgICAgICAgICAgUmVhY3RGaWJlckluc3RydW1lbnRhdGlvbl8xLmRlYnVnVG9vbC5vbkNvbW1pdFdvcmsoZmluaXNoZWRXb3JrKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY29tbWl0UGhhc2VCb3VuZGFyaWVzKSB7CiAgICAgICAgICAgIGNvbW1pdFBoYXNlQm91bmRhcmllcy5mb3JFYWNoKHNjaGVkdWxlRXJyb3JSZWNvdmVyeSk7CiAgICAgICAgICAgIGNvbW1pdFBoYXNlQm91bmRhcmllcyA9IG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGZpcnN0VW5jYXVnaHRFcnJvciAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgX2Vycm9yMyA9IGZpcnN0VW5jYXVnaHRFcnJvcjsKICAgICAgICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgb25VbmNhdWdodEVycm9yKF9lcnJvcjMpOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciByZW1haW5pbmdUaW1lID0gcm9vdC5jdXJyZW50LmV4cGlyYXRpb25UaW1lOwoKICAgICAgICAgIGlmIChyZW1haW5pbmdUaW1lID09PSBOb1dvcmspIHsKICAgICAgICAgICAgY2FwdHVyZWRFcnJvcnMgPSBudWxsOwogICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzID0gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gcmVtYWluaW5nVGltZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlc2V0RXhwaXJhdGlvblRpbWUod29ya0luUHJvZ3Jlc3MsIHJlbmRlclRpbWUpIHsKICAgICAgICAgIGlmIChyZW5kZXJUaW1lICE9PSBOZXZlciAmJiB3b3JrSW5Qcm9ncmVzcy5leHBpcmF0aW9uVGltZSA9PT0gTmV2ZXIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBuZXdFeHBpcmF0aW9uVGltZSA9IGdldFVwZGF0ZUV4cGlyYXRpb25UaW1lKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIHZhciBjaGlsZCA9IHdvcmtJblByb2dyZXNzLmNoaWxkOwoKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoY2hpbGQuZXhwaXJhdGlvblRpbWUgIT09IE5vV29yayAmJiAobmV3RXhwaXJhdGlvblRpbWUgPT09IE5vV29yayB8fCBuZXdFeHBpcmF0aW9uVGltZSA+IGNoaWxkLmV4cGlyYXRpb25UaW1lKSkgewogICAgICAgICAgICAgIG5ld0V4cGlyYXRpb25UaW1lID0gY2hpbGQuZXhwaXJhdGlvblRpbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KCiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5leHBpcmF0aW9uVGltZSA9IG5ld0V4cGlyYXRpb25UaW1lOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVVbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICB2YXIgY3VycmVudCA9IHdvcmtJblByb2dyZXNzLmFsdGVybmF0ZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RmliZXIuc2V0Q3VycmVudEZpYmVyKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dCA9IGNvbXBsZXRlV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgbmV4dFJlbmRlckV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RmliZXIucmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSB3b3JrSW5Qcm9ncmVzc1sicmV0dXJuIl07CiAgICAgICAgICAgIHZhciBzaWJsaW5nRmliZXIgPSB3b3JrSW5Qcm9ncmVzcy5zaWJsaW5nOwogICAgICAgICAgICByZXNldEV4cGlyYXRpb25UaW1lKHdvcmtJblByb2dyZXNzLCBuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWUpOwoKICAgICAgICAgICAgaWYgKG5leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzdG9wV29ya1RpbWVyKHdvcmtJblByb2dyZXNzKTsKCiAgICAgICAgICAgICAgaWYgKHRydWUgJiYgUmVhY3RGaWJlckluc3RydW1lbnRhdGlvbl8xLmRlYnVnVG9vbCkgewogICAgICAgICAgICAgICAgUmVhY3RGaWJlckluc3RydW1lbnRhdGlvbl8xLmRlYnVnVG9vbC5vbkNvbXBsZXRlV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyLmZpcnN0RWZmZWN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5maXJzdEVmZmVjdCA9IHdvcmtJblByb2dyZXNzLmZpcnN0RWZmZWN0OwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzLmxhc3RFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlci5sYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmxhc3RFZmZlY3QubmV4dEVmZmVjdCA9IHdvcmtJblByb2dyZXNzLmZpcnN0RWZmZWN0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmxhc3RFZmZlY3QgPSB3b3JrSW5Qcm9ncmVzcy5sYXN0RWZmZWN0OwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgdmFyIGVmZmVjdFRhZyA9IHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZzsKCiAgICAgICAgICAgICAgaWYgKGVmZmVjdFRhZyA+IFBlcmZvcm1lZFdvcmspIHsKICAgICAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlci5sYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmxhc3RFZmZlY3QubmV4dEVmZmVjdCA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmlyc3RFZmZlY3QgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5sYXN0RWZmZWN0ID0gd29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBzdG9wV29ya1RpbWVyKHdvcmtJblByb2dyZXNzKTsKCiAgICAgICAgICAgIGlmICh0cnVlICYmIFJlYWN0RmliZXJJbnN0cnVtZW50YXRpb25fMS5kZWJ1Z1Rvb2wpIHsKICAgICAgICAgICAgICBSZWFjdEZpYmVySW5zdHJ1bWVudGF0aW9uXzEuZGVidWdUb29sLm9uQ29tcGxldGVXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNpYmxpbmdGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBzaWJsaW5nRmliZXI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmV0dXJuRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByb290ID0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlOwogICAgICAgICAgICAgIHJvb3QuaXNSZWFkeUZvckNvbW1pdCA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB2YXIgY3VycmVudCA9IHdvcmtJblByb2dyZXNzLmFsdGVybmF0ZTsKICAgICAgICAgIHN0YXJ0V29ya1RpbWVyKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5zZXRDdXJyZW50RmliZXIod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHQgPSBiZWdpbldvcmsoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIG5leHRSZW5kZXJFeHBpcmF0aW9uVGltZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RmliZXIucmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodHJ1ZSAmJiBSZWFjdEZpYmVySW5zdHJ1bWVudGF0aW9uXzEuZGVidWdUb29sKSB7CiAgICAgICAgICAgIFJlYWN0RmliZXJJbnN0cnVtZW50YXRpb25fMS5kZWJ1Z1Rvb2wub25CZWdpbldvcmsod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChuZXh0ID09PSBudWxsKSB7CiAgICAgICAgICAgIG5leHQgPSBjb21wbGV0ZVVuaXRPZldvcmsod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgfQoKICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgcmV0dXJuIG5leHQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZXJmb3JtRmFpbGVkVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcykgewogICAgICAgICAgdmFyIGN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzcy5hbHRlcm5hdGU7CiAgICAgICAgICBzdGFydFdvcmtUaW1lcih3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RmliZXIuc2V0Q3VycmVudEZpYmVyKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0ID0gYmVnaW5GYWlsZWRXb3JrKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgewogICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZpYmVyLnJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHRydWUgJiYgUmVhY3RGaWJlckluc3RydW1lbnRhdGlvbl8xLmRlYnVnVG9vbCkgewogICAgICAgICAgICBSZWFjdEZpYmVySW5zdHJ1bWVudGF0aW9uXzEuZGVidWdUb29sLm9uQmVnaW5Xb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAobmV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBuZXh0ID0gY29tcGxldGVVbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KCiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgIHJldHVybiBuZXh0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3AoZXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIGlmIChjYXB0dXJlZEVycm9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICBzbG93V29ya0xvb3BUaGF0Q2hlY2tzRm9yRmFpbGVkV29yayhleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAobmV4dFJlbmRlckV4cGlyYXRpb25UaW1lID09PSBOb1dvcmsgfHwgbmV4dFJlbmRlckV4cGlyYXRpb25UaW1lID4gZXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWUgPD0gbW9zdFJlY2VudEN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgIHdoaWxlIChuZXh0VW5pdE9mV29yayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRVbml0T2ZXb3JrID0gcGVyZm9ybVVuaXRPZldvcmsobmV4dFVuaXRPZldvcmspOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aGlsZSAobmV4dFVuaXRPZldvcmsgIT09IG51bGwgJiYgIXNob3VsZFlpZWxkKCkpIHsKICAgICAgICAgICAgICBuZXh0VW5pdE9mV29yayA9IHBlcmZvcm1Vbml0T2ZXb3JrKG5leHRVbml0T2ZXb3JrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2xvd1dvcmtMb29wVGhhdENoZWNrc0ZvckZhaWxlZFdvcmsoZXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIGlmIChuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWUgPT09IE5vV29yayB8fCBuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWUgPiBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG5leHRSZW5kZXJFeHBpcmF0aW9uVGltZSA8PSBtb3N0UmVjZW50Q3VycmVudFRpbWUpIHsKICAgICAgICAgICAgd2hpbGUgKG5leHRVbml0T2ZXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGhhc0NhcHR1cmVkRXJyb3IobmV4dFVuaXRPZldvcmspKSB7CiAgICAgICAgICAgICAgICBuZXh0VW5pdE9mV29yayA9IHBlcmZvcm1GYWlsZWRVbml0T2ZXb3JrKG5leHRVbml0T2ZXb3JrKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dFVuaXRPZldvcmsgPSBwZXJmb3JtVW5pdE9mV29yayhuZXh0VW5pdE9mV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aGlsZSAobmV4dFVuaXRPZldvcmsgIT09IG51bGwgJiYgIXNob3VsZFlpZWxkKCkpIHsKICAgICAgICAgICAgICBpZiAoaGFzQ2FwdHVyZWRFcnJvcihuZXh0VW5pdE9mV29yaykpIHsKICAgICAgICAgICAgICAgIG5leHRVbml0T2ZXb3JrID0gcGVyZm9ybUZhaWxlZFVuaXRPZldvcmsobmV4dFVuaXRPZldvcmspOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXh0VW5pdE9mV29yayA9IHBlcmZvcm1Vbml0T2ZXb3JrKG5leHRVbml0T2ZXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlbmRlclJvb3RDYXRjaEJsb2NrKHJvb3QsIGZhaWxlZFdvcmssIGJvdW5kYXJ5LCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgdW53aW5kQ29udGV4dHMoZmFpbGVkV29yaywgYm91bmRhcnkpOwogICAgICAgICAgbmV4dFVuaXRPZldvcmsgPSBwZXJmb3JtRmFpbGVkVW5pdE9mV29yayhib3VuZGFyeSk7CiAgICAgICAgICB3b3JrTG9vcChleHBpcmF0aW9uVGltZSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZW5kZXJSb290KHJvb3QsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICBpbnZhcmlhbnQoIWlzV29ya2luZywgInJlbmRlclJvb3Qgd2FzIGNhbGxlZCByZWN1cnNpdmVseS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkICIgKyAiYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgaXNXb3JraW5nID0gdHJ1ZTsKICAgICAgICAgIHJvb3QuaXNSZWFkeUZvckNvbW1pdCA9IGZhbHNlOwoKICAgICAgICAgIGlmIChyb290ICE9PSBuZXh0Um9vdCB8fCBleHBpcmF0aW9uVGltZSAhPT0gbmV4dFJlbmRlckV4cGlyYXRpb25UaW1lIHx8IG5leHRVbml0T2ZXb3JrID09PSBudWxsKSB7CiAgICAgICAgICAgIHJlc2V0Q29udGV4dFN0YWNrKCk7CiAgICAgICAgICAgIG5leHRSb290ID0gcm9vdDsKICAgICAgICAgICAgbmV4dFJlbmRlckV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWU7CiAgICAgICAgICAgIG5leHRVbml0T2ZXb3JrID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MobmV4dFJvb3QuY3VycmVudCwgbnVsbCwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfQoKICAgICAgICAgIHN0YXJ0V29ya0xvb3BUaW1lcihuZXh0VW5pdE9mV29yayk7CiAgICAgICAgICB2YXIgZGlkRXJyb3IgPSBmYWxzZTsKICAgICAgICAgIHZhciBlcnJvciA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayQxKG51bGwsIHdvcmtMb29wLCBudWxsLCBleHBpcmF0aW9uVGltZSk7CgogICAgICAgICAgICBpZiAoaGFzQ2F1Z2h0RXJyb3IoKSkgewogICAgICAgICAgICAgIGRpZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvciA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHdoaWxlIChkaWRFcnJvcikgewogICAgICAgICAgICBpZiAoZGlkRmF0YWwpIHsKICAgICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBlcnJvcjsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGZhaWxlZFdvcmsgPSBuZXh0VW5pdE9mV29yazsKCiAgICAgICAgICAgIGlmIChmYWlsZWRXb3JrID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZGlkRmF0YWwgPSB0cnVlOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgYm91bmRhcnkgPSBjYXB0dXJlRXJyb3IoZmFpbGVkV29yaywgZXJyb3IpOwogICAgICAgICAgICBpbnZhcmlhbnQoYm91bmRhcnkgIT09IG51bGwsICJTaG91bGQgaGF2ZSBmb3VuZCBhbiBlcnJvciBib3VuZGFyeS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgIiArICJjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwoKICAgICAgICAgICAgaWYgKGRpZEZhdGFsKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRpZEVycm9yID0gZmFsc2U7CiAgICAgICAgICAgIGVycm9yID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayQxKG51bGwsIHJlbmRlclJvb3RDYXRjaEJsb2NrLCBudWxsLCByb290LCBmYWlsZWRXb3JrLCBib3VuZGFyeSwgZXhwaXJhdGlvblRpbWUpOwoKICAgICAgICAgICAgICBpZiAoaGFzQ2F1Z2h0RXJyb3IoKSkgewogICAgICAgICAgICAgICAgZGlkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IgPSBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHVuY2F1Z2h0RXJyb3IgPSBmaXJzdFVuY2F1Z2h0RXJyb3I7CiAgICAgICAgICBzdG9wV29ya0xvb3BUaW1lcihpbnRlcnJ1cHRlZEJ5KTsKICAgICAgICAgIGludGVycnVwdGVkQnkgPSBudWxsOwogICAgICAgICAgaXNXb3JraW5nID0gZmFsc2U7CiAgICAgICAgICBkaWRGYXRhbCA9IGZhbHNlOwogICAgICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbDsKCiAgICAgICAgICBpZiAodW5jYXVnaHRFcnJvciAhPT0gbnVsbCkgewogICAgICAgICAgICBvblVuY2F1Z2h0RXJyb3IodW5jYXVnaHRFcnJvcik7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHJvb3QuaXNSZWFkeUZvckNvbW1pdCA/IHJvb3QuY3VycmVudC5hbHRlcm5hdGUgOiBudWxsOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUVycm9yKGZhaWxlZFdvcmssIGVycm9yKSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5yZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGJvdW5kYXJ5ID0gbnVsbDsKICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5Rm91bmQgPSBmYWxzZTsKICAgICAgICAgIHZhciB3aWxsUmV0cnkgPSBmYWxzZTsKICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TmFtZSA9IG51bGw7CgogICAgICAgICAgaWYgKGZhaWxlZFdvcmsudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICBib3VuZGFyeSA9IGZhaWxlZFdvcms7CgogICAgICAgICAgICBpZiAoaXNGYWlsZWRCb3VuZGFyeShmYWlsZWRXb3JrKSkgewogICAgICAgICAgICAgIGRpZEZhdGFsID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBmYWlsZWRXb3JrWyJyZXR1cm4iXTsKCiAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsICYmIGJvdW5kYXJ5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRDYXRjaCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBlcnJvckJvdW5kYXJ5Rm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvckJvdW5kYXJ5TmFtZSA9IGdldENvbXBvbmVudE5hbWUobm9kZSk7CiAgICAgICAgICAgICAgICAgIGJvdW5kYXJ5ID0gbm9kZTsKICAgICAgICAgICAgICAgICAgd2lsbFJldHJ5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgYm91bmRhcnkgPSBub2RlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKGlzRmFpbGVkQm91bmRhcnkobm9kZSkpIHsKICAgICAgICAgICAgICAgIGlmIChpc1VubW91bnRpbmcpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGNvbW1pdFBoYXNlQm91bmRhcmllcyAhPT0gbnVsbCAmJiAoY29tbWl0UGhhc2VCb3VuZGFyaWVzLmhhcyhub2RlKSB8fCBub2RlLmFsdGVybmF0ZSAhPT0gbnVsbCAmJiBjb21taXRQaGFzZUJvdW5kYXJpZXMuaGFzKG5vZGUuYWx0ZXJuYXRlKSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYm91bmRhcnkgPSBudWxsOwogICAgICAgICAgICAgICAgd2lsbFJldHJ5ID0gZmFsc2U7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBub2RlID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoYm91bmRhcnkgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzID0gbmV3IFNldCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzLmFkZChib3VuZGFyeSk7CgogICAgICAgICAgICB2YXIgX2NvbXBvbmVudFN0YWNrID0gZ2V0U3RhY2tBZGRlbmR1bUJ5V29ya0luUHJvZ3Jlc3NGaWJlcihmYWlsZWRXb3JrKTsKCiAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWUoZmFpbGVkV29yayk7CgogICAgICAgICAgICBpZiAoY2FwdHVyZWRFcnJvcnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjYXB0dXJlZEVycm9ycyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNhcHR1cmVkRXJyb3IgPSB7CiAgICAgICAgICAgICAgY29tcG9uZW50TmFtZTogX2NvbXBvbmVudE5hbWUsCiAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2s6IF9jb21wb25lbnRTdGFjaywKICAgICAgICAgICAgICBlcnJvcjogZXJyb3IsCiAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeTogZXJyb3JCb3VuZGFyeUZvdW5kID8gYm91bmRhcnkuc3RhdGVOb2RlIDogbnVsbCwKICAgICAgICAgICAgICBlcnJvckJvdW5kYXJ5Rm91bmQ6IGVycm9yQm91bmRhcnlGb3VuZCwKICAgICAgICAgICAgICBlcnJvckJvdW5kYXJ5TmFtZTogZXJyb3JCb3VuZGFyeU5hbWUsCiAgICAgICAgICAgICAgd2lsbFJldHJ5OiB3aWxsUmV0cnkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY2FwdHVyZWRFcnJvcnMuc2V0KGJvdW5kYXJ5LCBjYXB0dXJlZEVycm9yKTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihjYXB0dXJlZEVycm9yKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHZhciBzdXBwcmVzc0xvZ2dpbmcgPSBlICYmIGUuc3VwcHJlc3NSZWFjdEVycm9yTG9nZ2luZzsKCiAgICAgICAgICAgICAgaWYgKCFzdXBwcmVzc0xvZ2dpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNDb21taXR0aW5nKSB7CiAgICAgICAgICAgICAgaWYgKGNvbW1pdFBoYXNlQm91bmRhcmllcyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29tbWl0UGhhc2VCb3VuZGFyaWVzID0gbmV3IFNldCgpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY29tbWl0UGhhc2VCb3VuZGFyaWVzLmFkZChib3VuZGFyeSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVFcnJvclJlY292ZXJ5KGJvdW5kYXJ5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGJvdW5kYXJ5OwogICAgICAgICAgfSBlbHNlIGlmIChmaXJzdFVuY2F1Z2h0RXJyb3IgPT09IG51bGwpIHsKICAgICAgICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gZXJyb3I7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBoYXNDYXB0dXJlZEVycm9yKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gY2FwdHVyZWRFcnJvcnMgIT09IG51bGwgJiYgKGNhcHR1cmVkRXJyb3JzLmhhcyhmaWJlcikgfHwgZmliZXIuYWx0ZXJuYXRlICE9PSBudWxsICYmIGNhcHR1cmVkRXJyb3JzLmhhcyhmaWJlci5hbHRlcm5hdGUpKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzRmFpbGVkQm91bmRhcnkoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmYWlsZWRCb3VuZGFyaWVzICE9PSBudWxsICYmIChmYWlsZWRCb3VuZGFyaWVzLmhhcyhmaWJlcikgfHwgZmliZXIuYWx0ZXJuYXRlICE9PSBudWxsICYmIGZhaWxlZEJvdW5kYXJpZXMuaGFzKGZpYmVyLmFsdGVybmF0ZSkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29tbWl0RXJyb3JIYW5kbGluZyhlZmZlY3RmdWxGaWJlcikgewogICAgICAgICAgdmFyIGNhcHR1cmVkRXJyb3IgPSB2b2lkIDA7CgogICAgICAgICAgaWYgKGNhcHR1cmVkRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNhcHR1cmVkRXJyb3IgPSBjYXB0dXJlZEVycm9ycy5nZXQoZWZmZWN0ZnVsRmliZXIpOwogICAgICAgICAgICBjYXB0dXJlZEVycm9yc1siZGVsZXRlIl0oZWZmZWN0ZnVsRmliZXIpOwoKICAgICAgICAgICAgaWYgKGNhcHR1cmVkRXJyb3IgPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChlZmZlY3RmdWxGaWJlci5hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVmZmVjdGZ1bEZpYmVyID0gZWZmZWN0ZnVsRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgY2FwdHVyZWRFcnJvciA9IGNhcHR1cmVkRXJyb3JzLmdldChlZmZlY3RmdWxGaWJlcik7CiAgICAgICAgICAgICAgICBjYXB0dXJlZEVycm9yc1siZGVsZXRlIl0oZWZmZWN0ZnVsRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGludmFyaWFudChjYXB0dXJlZEVycm9yICE9IG51bGwsICJObyBlcnJvciBmb3IgZ2l2ZW4gdW5pdCBvZiB3b3JrLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSAiICsgImJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CgogICAgICAgICAgc3dpdGNoIChlZmZlY3RmdWxGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBlZmZlY3RmdWxGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgdmFyIGluZm8gPSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRTdGFjazogY2FwdHVyZWRFcnJvci5jb21wb25lbnRTdGFjawogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2goY2FwdHVyZWRFcnJvci5lcnJvciwgaW5mbyk7CiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICBpZiAoZmlyc3RVbmNhdWdodEVycm9yID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBjYXB0dXJlZEVycm9yLmVycm9yOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBpbnZhcmlhbnQoZmFsc2UsICJJbnZhbGlkIHR5cGUgb2Ygd29yay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluICIgKyAiUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdW53aW5kQ29udGV4dHMoZnJvbSwgdG8pIHsKICAgICAgICAgIHZhciBub2RlID0gZnJvbTsKCiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHBvcENvbnRleHRQcm92aWRlcihub2RlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dChub2RlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcihub2RlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKG5vZGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChub2RlID09PSB0byB8fCBub2RlLmFsdGVybmF0ZSA9PT0gdG8pIHsKICAgICAgICAgICAgICBzdG9wRmFpbGVkV29ya1RpbWVyKG5vZGUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0b3BXb3JrVGltZXIobm9kZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vZGUgPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbXB1dGVBc3luY0V4cGlyYXRpb24oKSB7CiAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSByZWNhbGN1bGF0ZUN1cnJlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgZXhwaXJhdGlvbk1zID0gMTAwMDsKICAgICAgICAgIHZhciBidWNrZXRTaXplTXMgPSAyMDA7CiAgICAgICAgICByZXR1cm4gY29tcHV0ZUV4cGlyYXRpb25CdWNrZXQoY3VycmVudFRpbWUsIGV4cGlyYXRpb25NcywgYnVja2V0U2l6ZU1zKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbXB1dGVVbmlxdWVBc3luY0V4cGlyYXRpb24oKSB7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gY29tcHV0ZUFzeW5jRXhwaXJhdGlvbigpOwoKICAgICAgICAgIGlmIChyZXN1bHQgPD0gbGFzdFVuaXF1ZUFzeW5jRXhwaXJhdGlvbikgewogICAgICAgICAgICByZXN1bHQgPSBsYXN0VW5pcXVlQXN5bmNFeHBpcmF0aW9uICsgMTsKICAgICAgICAgIH0KCiAgICAgICAgICBsYXN0VW5pcXVlQXN5bmNFeHBpcmF0aW9uID0gcmVzdWx0OwogICAgICAgICAgcmV0dXJuIGxhc3RVbmlxdWVBc3luY0V4cGlyYXRpb247CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjb21wdXRlRXhwaXJhdGlvbkZvckZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWUgPSB2b2lkIDA7CgogICAgICAgICAgaWYgKGV4cGlyYXRpb25Db250ZXh0ICE9PSBOb1dvcmspIHsKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUgPSBleHBpcmF0aW9uQ29udGV4dDsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNXb3JraW5nKSB7CiAgICAgICAgICAgIGlmIChpc0NvbW1pdHRpbmcpIHsKICAgICAgICAgICAgICBleHBpcmF0aW9uVGltZSA9IFN5bmM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUgPSBuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh1c2VTeW5jU2NoZWR1bGluZyAmJiAhKGZpYmVyLmludGVybmFsQ29udGV4dFRhZyAmIEFzeW5jVXBkYXRlcykpIHsKICAgICAgICAgICAgICBleHBpcmF0aW9uVGltZSA9IFN5bmM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUgPSBjb21wdXRlQXN5bmNFeHBpcmF0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZXhwaXJhdGlvblRpbWU7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVdvcmsoZmliZXIsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICByZXR1cm4gc2NoZWR1bGVXb3JrSW1wbChmaWJlciwgZXhwaXJhdGlvblRpbWUsIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNoZWNrUm9vdE5lZWRzQ2xlYXJpbmcocm9vdCwgZmliZXIsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICBpZiAoIWlzV29ya2luZyAmJiByb290ID09PSBuZXh0Um9vdCAmJiBleHBpcmF0aW9uVGltZSA8IG5leHRSZW5kZXJFeHBpcmF0aW9uVGltZSkgewogICAgICAgICAgICBpZiAobmV4dFVuaXRPZldvcmsgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnRlcnJ1cHRlZEJ5ID0gZmliZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5leHRSb290ID0gbnVsbDsKICAgICAgICAgICAgbmV4dFVuaXRPZldvcmsgPSBudWxsOwogICAgICAgICAgICBuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWUgPSBOb1dvcms7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVdvcmtJbXBsKGZpYmVyLCBleHBpcmF0aW9uVGltZSwgaXNFcnJvclJlY292ZXJ5KSB7CiAgICAgICAgICByZWNvcmRTY2hlZHVsZVVwZGF0ZSgpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRXJyb3JSZWNvdmVyeSAmJiBmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHdhcm5BYm91dEludmFsaWRVcGRhdGVzKGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKCiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobm9kZS5leHBpcmF0aW9uVGltZSA9PT0gTm9Xb3JrIHx8IG5vZGUuZXhwaXJhdGlvblRpbWUgPiBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgICAgIG5vZGUuZXhwaXJhdGlvblRpbWUgPSBleHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUuYWx0ZXJuYXRlLmV4cGlyYXRpb25UaW1lID09PSBOb1dvcmsgfHwgbm9kZS5hbHRlcm5hdGUuZXhwaXJhdGlvblRpbWUgPiBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgICAgICAgbm9kZS5hbHRlcm5hdGUuZXhwaXJhdGlvblRpbWUgPSBleHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChub2RlWyJyZXR1cm4iXSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIHZhciByb290ID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBjaGVja1Jvb3ROZWVkc0NsZWFyaW5nKHJvb3QsIGZpYmVyLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICByZXF1ZXN0V29yayhyb290LCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICBjaGVja1Jvb3ROZWVkc0NsZWFyaW5nKHJvb3QsIGZpYmVyLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKCFpc0Vycm9yUmVjb3ZlcnkgJiYgZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIHdhcm5BYm91dFVwZGF0ZU9uVW5tb3VudGVkKGZpYmVyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbm9kZSA9IG5vZGVbInJldHVybiJdOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVFcnJvclJlY292ZXJ5KGZpYmVyKSB7CiAgICAgICAgICBzY2hlZHVsZVdvcmtJbXBsKGZpYmVyLCBTeW5jLCB0cnVlKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlY2FsY3VsYXRlQ3VycmVudFRpbWUoKSB7CiAgICAgICAgICB2YXIgbXMgPSBub3coKSAtIHN0YXJ0VGltZTsKICAgICAgICAgIG1vc3RSZWNlbnRDdXJyZW50VGltZSA9IG1zVG9FeHBpcmF0aW9uVGltZShtcyk7CiAgICAgICAgICByZXR1cm4gbW9zdFJlY2VudEN1cnJlbnRUaW1lOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZGVmZXJyZWRVcGRhdGVzKGZuKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNFeHBpcmF0aW9uQ29udGV4dCA9IGV4cGlyYXRpb25Db250ZXh0OwogICAgICAgICAgZXhwaXJhdGlvbkNvbnRleHQgPSBjb21wdXRlQXN5bmNFeHBpcmF0aW9uKCk7CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBleHBpcmF0aW9uQ29udGV4dCA9IHByZXZpb3VzRXhwaXJhdGlvbkNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzeW5jVXBkYXRlcyhmbikgewogICAgICAgICAgdmFyIHByZXZpb3VzRXhwaXJhdGlvbkNvbnRleHQgPSBleHBpcmF0aW9uQ29udGV4dDsKICAgICAgICAgIGV4cGlyYXRpb25Db250ZXh0ID0gU3luYzsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGV4cGlyYXRpb25Db250ZXh0ID0gcHJldmlvdXNFeHBpcmF0aW9uQ29udGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBmaXJzdFNjaGVkdWxlZFJvb3QgPSBudWxsOwogICAgICAgIHZhciBsYXN0U2NoZWR1bGVkUm9vdCA9IG51bGw7CiAgICAgICAgdmFyIGNhbGxiYWNrRXhwaXJhdGlvblRpbWUgPSBOb1dvcms7CiAgICAgICAgdmFyIGNhbGxiYWNrSUQgPSAtMTsKICAgICAgICB2YXIgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgbmV4dEZsdXNoZWRSb290ID0gbnVsbDsKICAgICAgICB2YXIgbmV4dEZsdXNoZWRFeHBpcmF0aW9uVGltZSA9IE5vV29yazsKICAgICAgICB2YXIgZGVhZGxpbmVEaWRFeHBpcmUgPSBmYWxzZTsKICAgICAgICB2YXIgaGFzVW5oYW5kbGVkRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgdW5oYW5kbGVkRXJyb3IgPSBudWxsOwogICAgICAgIHZhciBkZWFkbGluZSA9IG51bGw7CiAgICAgICAgdmFyIGlzQmF0Y2hpbmdVcGRhdGVzID0gZmFsc2U7CiAgICAgICAgdmFyIGlzVW5iYXRjaGluZ1VwZGF0ZXMgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcGxldGVkQmF0Y2hlcyA9IG51bGw7CiAgICAgICAgdmFyIE5FU1RFRF9VUERBVEVfTElNSVQgPSAxMDAwOwogICAgICAgIHZhciBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHRpbWVIZXVyaXN0aWNGb3JVbml0T2ZXb3JrID0gMTsKCiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsYmFja1dpdGhFeHBpcmF0aW9uKGV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2tFeHBpcmF0aW9uVGltZSAhPT0gTm9Xb3JrKSB7CiAgICAgICAgICAgIGlmIChleHBpcmF0aW9uVGltZSA+IGNhbGxiYWNrRXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2FuY2VsRGVmZXJyZWRDYWxsYmFjayhjYWxsYmFja0lEKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnRSZXF1ZXN0Q2FsbGJhY2tUaW1lcigpOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBjdXJyZW50TXMgPSBub3coKSAtIHN0YXJ0VGltZTsKICAgICAgICAgIHZhciBleHBpcmF0aW9uTXMgPSBleHBpcmF0aW9uVGltZVRvTXMoZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgdmFyIHRpbWVvdXQgPSBleHBpcmF0aW9uTXMgLSBjdXJyZW50TXM7CiAgICAgICAgICBjYWxsYmFja0V4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWU7CiAgICAgICAgICBjYWxsYmFja0lEID0gc2NoZWR1bGVEZWZlcnJlZENhbGxiYWNrKHBlcmZvcm1Bc3luY1dvcmssIHsKICAgICAgICAgICAgdGltZW91dDogdGltZW91dAogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZXF1ZXN0V29yayhyb290LCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgaWYgKG5lc3RlZFVwZGF0ZUNvdW50ID4gTkVTVEVEX1VQREFURV9MSU1JVCkgewogICAgICAgICAgICBpbnZhcmlhbnQoZmFsc2UsICJNYXhpbXVtIHVwZGF0ZSBkZXB0aCBleGNlZWRlZC4gVGhpcyBjYW4gaGFwcGVuIHdoZW4gYSAiICsgImNvbXBvbmVudCByZXBlYXRlZGx5IGNhbGxzIHNldFN0YXRlIGluc2lkZSBjb21wb25lbnRXaWxsVXBkYXRlIG9yICIgKyAiY29tcG9uZW50RGlkVXBkYXRlLiBSZWFjdCBsaW1pdHMgdGhlIG51bWJlciBvZiBuZXN0ZWQgdXBkYXRlcyB0byAiICsgInByZXZlbnQgaW5maW5pdGUgbG9vcHMuIik7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHJvb3QubmV4dFNjaGVkdWxlZFJvb3QgPT09IG51bGwpIHsKICAgICAgICAgICAgcm9vdC5yZW1haW5pbmdFeHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lOwoKICAgICAgICAgICAgaWYgKGxhc3RTY2hlZHVsZWRSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RTY2hlZHVsZWRSb290ID0gbGFzdFNjaGVkdWxlZFJvb3QgPSByb290OwogICAgICAgICAgICAgIHJvb3QubmV4dFNjaGVkdWxlZFJvb3QgPSByb290OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RTY2hlZHVsZWRSb290Lm5leHRTY2hlZHVsZWRSb290ID0gcm9vdDsKICAgICAgICAgICAgICBsYXN0U2NoZWR1bGVkUm9vdCA9IHJvb3Q7CiAgICAgICAgICAgICAgbGFzdFNjaGVkdWxlZFJvb3QubmV4dFNjaGVkdWxlZFJvb3QgPSBmaXJzdFNjaGVkdWxlZFJvb3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciByZW1haW5pbmdFeHBpcmF0aW9uVGltZSA9IHJvb3QucmVtYWluaW5nRXhwaXJhdGlvblRpbWU7CgogICAgICAgICAgICBpZiAocmVtYWluaW5nRXhwaXJhdGlvblRpbWUgPT09IE5vV29yayB8fCBleHBpcmF0aW9uVGltZSA8IHJlbWFpbmluZ0V4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICAgICAgcm9vdC5yZW1haW5pbmdFeHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGlzUmVuZGVyaW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaXNCYXRjaGluZ1VwZGF0ZXMpIHsKICAgICAgICAgICAgaWYgKGlzVW5iYXRjaGluZ1VwZGF0ZXMpIHsKICAgICAgICAgICAgICBuZXh0Rmx1c2hlZFJvb3QgPSByb290OwogICAgICAgICAgICAgIG5leHRGbHVzaGVkRXhwaXJhdGlvblRpbWUgPSBTeW5jOwogICAgICAgICAgICAgIHBlcmZvcm1Xb3JrT25Sb290KHJvb3QsIFN5bmMsIHJlY2FsY3VsYXRlQ3VycmVudFRpbWUoKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZXhwaXJhdGlvblRpbWUgPT09IFN5bmMpIHsKICAgICAgICAgICAgcGVyZm9ybVdvcmsoU3luYywgbnVsbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrV2l0aEV4cGlyYXRpb24oZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmluZEhpZ2hlc3RQcmlvcml0eVJvb3QoKSB7CiAgICAgICAgICB2YXIgaGlnaGVzdFByaW9yaXR5V29yayA9IE5vV29yazsKICAgICAgICAgIHZhciBoaWdoZXN0UHJpb3JpdHlSb290ID0gbnVsbDsKCiAgICAgICAgICBpZiAobGFzdFNjaGVkdWxlZFJvb3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHByZXZpb3VzU2NoZWR1bGVkUm9vdCA9IGxhc3RTY2hlZHVsZWRSb290OwogICAgICAgICAgICB2YXIgcm9vdCA9IGZpcnN0U2NoZWR1bGVkUm9vdDsKCiAgICAgICAgICAgIHdoaWxlIChyb290ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHJlbWFpbmluZ0V4cGlyYXRpb25UaW1lID0gcm9vdC5yZW1haW5pbmdFeHBpcmF0aW9uVGltZTsKCiAgICAgICAgICAgICAgaWYgKHJlbWFpbmluZ0V4cGlyYXRpb25UaW1lID09PSBOb1dvcmspIHsKICAgICAgICAgICAgICAgIGludmFyaWFudChwcmV2aW91c1NjaGVkdWxlZFJvb3QgIT09IG51bGwgJiYgbGFzdFNjaGVkdWxlZFJvb3QgIT09IG51bGwsICJTaG91bGQgaGF2ZSBhIHByZXZpb3VzIGFuZCBsYXN0IHJvb3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5ICIgKyAiY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKCiAgICAgICAgICAgICAgICBpZiAocm9vdCA9PT0gcm9vdC5uZXh0U2NoZWR1bGVkUm9vdCkgewogICAgICAgICAgICAgICAgICByb290Lm5leHRTY2hlZHVsZWRSb290ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgZmlyc3RTY2hlZHVsZWRSb290ID0gbGFzdFNjaGVkdWxlZFJvb3QgPSBudWxsOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocm9vdCA9PT0gZmlyc3RTY2hlZHVsZWRSb290KSB7CiAgICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gcm9vdC5uZXh0U2NoZWR1bGVkUm9vdDsKICAgICAgICAgICAgICAgICAgZmlyc3RTY2hlZHVsZWRSb290ID0gbmV4dDsKICAgICAgICAgICAgICAgICAgbGFzdFNjaGVkdWxlZFJvb3QubmV4dFNjaGVkdWxlZFJvb3QgPSBuZXh0OwogICAgICAgICAgICAgICAgICByb290Lm5leHRTY2hlZHVsZWRSb290ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocm9vdCA9PT0gbGFzdFNjaGVkdWxlZFJvb3QpIHsKICAgICAgICAgICAgICAgICAgbGFzdFNjaGVkdWxlZFJvb3QgPSBwcmV2aW91c1NjaGVkdWxlZFJvb3Q7CiAgICAgICAgICAgICAgICAgIGxhc3RTY2hlZHVsZWRSb290Lm5leHRTY2hlZHVsZWRSb290ID0gZmlyc3RTY2hlZHVsZWRSb290OwogICAgICAgICAgICAgICAgICByb290Lm5leHRTY2hlZHVsZWRSb290ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c1NjaGVkdWxlZFJvb3QubmV4dFNjaGVkdWxlZFJvb3QgPSByb290Lm5leHRTY2hlZHVsZWRSb290OwogICAgICAgICAgICAgICAgICByb290Lm5leHRTY2hlZHVsZWRSb290ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByb290ID0gcHJldmlvdXNTY2hlZHVsZWRSb290Lm5leHRTY2hlZHVsZWRSb290OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoaGlnaGVzdFByaW9yaXR5V29yayA9PT0gTm9Xb3JrIHx8IHJlbWFpbmluZ0V4cGlyYXRpb25UaW1lIDwgaGlnaGVzdFByaW9yaXR5V29yaykgewogICAgICAgICAgICAgICAgICBoaWdoZXN0UHJpb3JpdHlXb3JrID0gcmVtYWluaW5nRXhwaXJhdGlvblRpbWU7CiAgICAgICAgICAgICAgICAgIGhpZ2hlc3RQcmlvcml0eVJvb3QgPSByb290OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChyb290ID09PSBsYXN0U2NoZWR1bGVkUm9vdCkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBwcmV2aW91c1NjaGVkdWxlZFJvb3QgPSByb290OwogICAgICAgICAgICAgICAgcm9vdCA9IHJvb3QubmV4dFNjaGVkdWxlZFJvb3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHByZXZpb3VzRmx1c2hlZFJvb3QgPSBuZXh0Rmx1c2hlZFJvb3Q7CgogICAgICAgICAgaWYgKHByZXZpb3VzRmx1c2hlZFJvb3QgIT09IG51bGwgJiYgcHJldmlvdXNGbHVzaGVkUm9vdCA9PT0gaGlnaGVzdFByaW9yaXR5Um9vdCkgewogICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCsrOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgfQoKICAgICAgICAgIG5leHRGbHVzaGVkUm9vdCA9IGhpZ2hlc3RQcmlvcml0eVJvb3Q7CiAgICAgICAgICBuZXh0Rmx1c2hlZEV4cGlyYXRpb25UaW1lID0gaGlnaGVzdFByaW9yaXR5V29yazsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1Bc3luY1dvcmsoZGwpIHsKICAgICAgICAgIHBlcmZvcm1Xb3JrKE5vV29yaywgZGwpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybVdvcmsobWluRXhwaXJhdGlvblRpbWUsIGRsKSB7CiAgICAgICAgICBkZWFkbGluZSA9IGRsOwogICAgICAgICAgZmluZEhpZ2hlc3RQcmlvcml0eVJvb3QoKTsKCiAgICAgICAgICBpZiAoZW5hYmxlVXNlclRpbWluZ0FQSSAmJiBkZWFkbGluZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZGlkRXhwaXJlID0gbmV4dEZsdXNoZWRFeHBpcmF0aW9uVGltZSA8IHJlY2FsY3VsYXRlQ3VycmVudFRpbWUoKTsKICAgICAgICAgICAgc3RvcFJlcXVlc3RDYWxsYmFja1RpbWVyKGRpZEV4cGlyZSk7CiAgICAgICAgICB9CgogICAgICAgICAgd2hpbGUgKG5leHRGbHVzaGVkUm9vdCAhPT0gbnVsbCAmJiBuZXh0Rmx1c2hlZEV4cGlyYXRpb25UaW1lICE9PSBOb1dvcmsgJiYgKG1pbkV4cGlyYXRpb25UaW1lID09PSBOb1dvcmsgfHwgbmV4dEZsdXNoZWRFeHBpcmF0aW9uVGltZSA8PSBtaW5FeHBpcmF0aW9uVGltZSkgJiYgIWRlYWRsaW5lRGlkRXhwaXJlKSB7CiAgICAgICAgICAgIHBlcmZvcm1Xb3JrT25Sb290KG5leHRGbHVzaGVkUm9vdCwgbmV4dEZsdXNoZWRFeHBpcmF0aW9uVGltZSwgcmVjYWxjdWxhdGVDdXJyZW50VGltZSgpKTsKICAgICAgICAgICAgZmluZEhpZ2hlc3RQcmlvcml0eVJvb3QoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZGVhZGxpbmUgIT09IG51bGwpIHsKICAgICAgICAgICAgY2FsbGJhY2tFeHBpcmF0aW9uVGltZSA9IE5vV29yazsKICAgICAgICAgICAgY2FsbGJhY2tJRCA9IC0xOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChuZXh0Rmx1c2hlZEV4cGlyYXRpb25UaW1lICE9PSBOb1dvcmspIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja1dpdGhFeHBpcmF0aW9uKG5leHRGbHVzaGVkRXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfQoKICAgICAgICAgIGRlYWRsaW5lID0gbnVsbDsKICAgICAgICAgIGRlYWRsaW5lRGlkRXhwaXJlID0gZmFsc2U7CiAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICBmaW5pc2hSZW5kZXJpbmcoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZsdXNoUm9vdChyb290LCBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgaW52YXJpYW50KCFpc1JlbmRlcmluZywgIndvcmsuY29tbWl0KCk6IENhbm5vdCBjb21taXQgd2hpbGUgYWxyZWFkeSByZW5kZXJpbmcuIFRoaXMgbGlrZWx5ICIgKyAibWVhbnMgeW91IGF0dGVtcHRlZCB0byBjb21taXQgZnJvbSBpbnNpZGUgYSBsaWZlY3ljbGUgbWV0aG9kLiIpOwogICAgICAgICAgcGVyZm9ybVdvcmtPblJvb3Qocm9vdCwgZXhwaXJhdGlvblRpbWUsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgIGZpbmlzaFJlbmRlcmluZygpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmluaXNoUmVuZGVyaW5nKCkgewogICAgICAgICAgaWYgKGNvbXBsZXRlZEJhdGNoZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGJhdGNoZXMgPSBjb21wbGV0ZWRCYXRjaGVzOwogICAgICAgICAgICBjb21wbGV0ZWRCYXRjaGVzID0gbnVsbDsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYmF0Y2hlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBiYXRjaCA9IGJhdGNoZXNbaV07CgogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBiYXRjaC5fb25Db21wbGV0ZSgpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc1VuaGFuZGxlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc1VuaGFuZGxlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdW5oYW5kbGVkRXJyb3IgPSBlcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaGFzVW5oYW5kbGVkRXJyb3IpIHsKICAgICAgICAgICAgdmFyIF9lcnJvcjQgPSB1bmhhbmRsZWRFcnJvcjsKICAgICAgICAgICAgdW5oYW5kbGVkRXJyb3IgPSBudWxsOwogICAgICAgICAgICBoYXNVbmhhbmRsZWRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICB0aHJvdyBfZXJyb3I0OwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybVdvcmtPblJvb3Qocm9vdCwgZXhwaXJhdGlvblRpbWUsIGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICBpbnZhcmlhbnQoIWlzUmVuZGVyaW5nLCAicGVyZm9ybVdvcmtPblJvb3Qgd2FzIGNhbGxlZCByZWN1cnNpdmVseS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkICIgKyAiYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgaXNSZW5kZXJpbmcgPSB0cnVlOwoKICAgICAgICAgIGlmIChleHBpcmF0aW9uVGltZSA8PSBjdXJyZW50VGltZSkgewogICAgICAgICAgICB2YXIgZmluaXNoZWRXb3JrID0gcm9vdC5maW5pc2hlZFdvcms7CgogICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY29tcGxldGVSb290KHJvb3QsIGZpbmlzaGVkV29yaywgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJvb3QuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgICAgICBmaW5pc2hlZFdvcmsgPSByZW5kZXJSb290KHJvb3QsIGV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29tcGxldGVSb290KHJvb3QsIGZpbmlzaGVkV29yaywgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF9maW5pc2hlZFdvcmsgPSByb290LmZpbmlzaGVkV29yazsKCiAgICAgICAgICAgIGlmIChfZmluaXNoZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY29tcGxldGVSb290KHJvb3QsIF9maW5pc2hlZFdvcmssIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByb290LmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICAgICAgX2ZpbmlzaGVkV29yayA9IHJlbmRlclJvb3Qocm9vdCwgZXhwaXJhdGlvblRpbWUpOwoKICAgICAgICAgICAgICBpZiAoX2ZpbmlzaGVkV29yayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCFzaG91bGRZaWVsZCgpKSB7CiAgICAgICAgICAgICAgICAgIGNvbXBsZXRlUm9vdChyb290LCBfZmluaXNoZWRXb3JrLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByb290LmZpbmlzaGVkV29yayA9IF9maW5pc2hlZFdvcms7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlUm9vdChyb290LCBmaW5pc2hlZFdvcmssIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICB2YXIgZmlyc3RCYXRjaCA9IHJvb3QuZmlyc3RCYXRjaDsKCiAgICAgICAgICBpZiAoZmlyc3RCYXRjaCAhPT0gbnVsbCAmJiBmaXJzdEJhdGNoLl9leHBpcmF0aW9uVGltZSA8PSBleHBpcmF0aW9uVGltZSkgewogICAgICAgICAgICBpZiAoY29tcGxldGVkQmF0Y2hlcyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbXBsZXRlZEJhdGNoZXMgPSBbZmlyc3RCYXRjaF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tcGxldGVkQmF0Y2hlcy5wdXNoKGZpcnN0QmF0Y2gpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZmlyc3RCYXRjaC5fZGVmZXIpIHsKICAgICAgICAgICAgICByb290LmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICByb290LnJlbWFpbmluZ0V4cGlyYXRpb25UaW1lID0gTm9Xb3JrOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJvb3QuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QucmVtYWluaW5nRXhwaXJhdGlvblRpbWUgPSBjb21taXRSb290KGZpbmlzaGVkV29yayk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzaG91bGRZaWVsZCgpIHsKICAgICAgICAgIGlmIChkZWFkbGluZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGRlYWRsaW5lLnRpbWVSZW1haW5pbmcoKSA+IHRpbWVIZXVyaXN0aWNGb3JVbml0T2ZXb3JrKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBkZWFkbGluZURpZEV4cGlyZSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9uVW5jYXVnaHRFcnJvcihlcnJvcikgewogICAgICAgICAgaW52YXJpYW50KG5leHRGbHVzaGVkUm9vdCAhPT0gbnVsbCwgIlNob3VsZCBiZSB3b3JraW5nIG9uIGEgcm9vdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluICIgKyAiUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgbmV4dEZsdXNoZWRSb290LnJlbWFpbmluZ0V4cGlyYXRpb25UaW1lID0gTm9Xb3JrOwoKICAgICAgICAgIGlmICghaGFzVW5oYW5kbGVkRXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5oYW5kbGVkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICB1bmhhbmRsZWRFcnJvciA9IGVycm9yOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMoZm4sIGEpIHsKICAgICAgICAgIHZhciBwcmV2aW91c0lzQmF0Y2hpbmdVcGRhdGVzID0gaXNCYXRjaGluZ1VwZGF0ZXM7CiAgICAgICAgICBpc0JhdGNoaW5nVXBkYXRlcyA9IHRydWU7CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGZuKGEpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgaXNCYXRjaGluZ1VwZGF0ZXMgPSBwcmV2aW91c0lzQmF0Y2hpbmdVcGRhdGVzOwoKICAgICAgICAgICAgaWYgKCFpc0JhdGNoaW5nVXBkYXRlcyAmJiAhaXNSZW5kZXJpbmcpIHsKICAgICAgICAgICAgICBwZXJmb3JtV29yayhTeW5jLCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdW5iYXRjaGVkVXBkYXRlcyhmbikgewogICAgICAgICAgaWYgKGlzQmF0Y2hpbmdVcGRhdGVzICYmICFpc1VuYmF0Y2hpbmdVcGRhdGVzKSB7CiAgICAgICAgICAgIGlzVW5iYXRjaGluZ1VwZGF0ZXMgPSB0cnVlOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpc1VuYmF0Y2hpbmdVcGRhdGVzID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luYyhmbikgewogICAgICAgICAgdmFyIHByZXZpb3VzSXNCYXRjaGluZ1VwZGF0ZXMgPSBpc0JhdGNoaW5nVXBkYXRlczsKICAgICAgICAgIGlzQmF0Y2hpbmdVcGRhdGVzID0gdHJ1ZTsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gc3luY1VwZGF0ZXMoZm4pOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgaXNCYXRjaGluZ1VwZGF0ZXMgPSBwcmV2aW91c0lzQmF0Y2hpbmdVcGRhdGVzOwogICAgICAgICAgICBpbnZhcmlhbnQoIWlzUmVuZGVyaW5nLCAiZmx1c2hTeW5jIHdhcyBjYWxsZWQgZnJvbSBpbnNpZGUgYSBsaWZlY3ljbGUgbWV0aG9kLiBJdCBjYW5ub3QgYmUgIiArICJjYWxsZWQgd2hlbiBSZWFjdCBpcyBhbHJlYWR5IHJlbmRlcmluZy4iKTsKICAgICAgICAgICAgcGVyZm9ybVdvcmsoU3luYywgbnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgY29tcHV0ZUFzeW5jRXhwaXJhdGlvbjogY29tcHV0ZUFzeW5jRXhwaXJhdGlvbiwKICAgICAgICAgIGNvbXB1dGVFeHBpcmF0aW9uRm9yRmliZXI6IGNvbXB1dGVFeHBpcmF0aW9uRm9yRmliZXIsCiAgICAgICAgICBzY2hlZHVsZVdvcms6IHNjaGVkdWxlV29yaywKICAgICAgICAgIHJlcXVlc3RXb3JrOiByZXF1ZXN0V29yaywKICAgICAgICAgIGZsdXNoUm9vdDogZmx1c2hSb290LAogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXM6IGJhdGNoZWRVcGRhdGVzLAogICAgICAgICAgdW5iYXRjaGVkVXBkYXRlczogdW5iYXRjaGVkVXBkYXRlcywKICAgICAgICAgIGZsdXNoU3luYzogZmx1c2hTeW5jLAogICAgICAgICAgZGVmZXJyZWRVcGRhdGVzOiBkZWZlcnJlZFVwZGF0ZXMsCiAgICAgICAgICBjb21wdXRlVW5pcXVlQXN5bmNFeHBpcmF0aW9uOiBjb21wdXRlVW5pcXVlQXN5bmNFeHBpcmF0aW9uCiAgICAgICAgfTsKICAgICAgfTsKCiAgICAgIHsKICAgICAgICB2YXIgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IGZhbHNlOwogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXRDb250ZXh0Rm9yU3VidHJlZShwYXJlbnRDb21wb25lbnQpIHsKICAgICAgICBpZiAoIXBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgcmV0dXJuIGVtcHR5T2JqZWN0OwogICAgICAgIH0KCiAgICAgICAgdmFyIGZpYmVyID0gZ2V0KHBhcmVudENvbXBvbmVudCk7CiAgICAgICAgdmFyIHBhcmVudENvbnRleHQgPSBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcik7CiAgICAgICAgcmV0dXJuIGlzQ29udGV4dFByb3ZpZGVyKGZpYmVyKSA/IHByb2Nlc3NDaGlsZENvbnRleHQoZmliZXIsIHBhcmVudENvbnRleHQpIDogcGFyZW50Q29udGV4dDsKICAgICAgfQoKICAgICAgdmFyIFJlYWN0RmliZXJSZWNvbmNpbGVyJDEgPSBmdW5jdGlvbiBSZWFjdEZpYmVyUmVjb25jaWxlciQxKGNvbmZpZykgewogICAgICAgIHZhciBnZXRQdWJsaWNJbnN0YW5jZSA9IGNvbmZpZy5nZXRQdWJsaWNJbnN0YW5jZTsKCiAgICAgICAgdmFyIF9SZWFjdEZpYmVyU2NoZWR1bGVyID0gUmVhY3RGaWJlclNjaGVkdWxlcihjb25maWcpLAogICAgICAgICAgICBjb21wdXRlQXN5bmNFeHBpcmF0aW9uID0gX1JlYWN0RmliZXJTY2hlZHVsZXIuY29tcHV0ZUFzeW5jRXhwaXJhdGlvbiwKICAgICAgICAgICAgY29tcHV0ZVVuaXF1ZUFzeW5jRXhwaXJhdGlvbiA9IF9SZWFjdEZpYmVyU2NoZWR1bGVyLmNvbXB1dGVVbmlxdWVBc3luY0V4cGlyYXRpb24sCiAgICAgICAgICAgIGNvbXB1dGVFeHBpcmF0aW9uRm9yRmliZXIgPSBfUmVhY3RGaWJlclNjaGVkdWxlci5jb21wdXRlRXhwaXJhdGlvbkZvckZpYmVyLAogICAgICAgICAgICBzY2hlZHVsZVdvcmsgPSBfUmVhY3RGaWJlclNjaGVkdWxlci5zY2hlZHVsZVdvcmssCiAgICAgICAgICAgIHJlcXVlc3RXb3JrID0gX1JlYWN0RmliZXJTY2hlZHVsZXIucmVxdWVzdFdvcmssCiAgICAgICAgICAgIGZsdXNoUm9vdCA9IF9SZWFjdEZpYmVyU2NoZWR1bGVyLmZsdXNoUm9vdCwKICAgICAgICAgICAgYmF0Y2hlZFVwZGF0ZXMgPSBfUmVhY3RGaWJlclNjaGVkdWxlci5iYXRjaGVkVXBkYXRlcywKICAgICAgICAgICAgdW5iYXRjaGVkVXBkYXRlcyA9IF9SZWFjdEZpYmVyU2NoZWR1bGVyLnVuYmF0Y2hlZFVwZGF0ZXMsCiAgICAgICAgICAgIGZsdXNoU3luYyA9IF9SZWFjdEZpYmVyU2NoZWR1bGVyLmZsdXNoU3luYywKICAgICAgICAgICAgZGVmZXJyZWRVcGRhdGVzID0gX1JlYWN0RmliZXJTY2hlZHVsZXIuZGVmZXJyZWRVcGRhdGVzOwoKICAgICAgICBmdW5jdGlvbiBjb21wdXRlUm9vdEV4cGlyYXRpb25UaW1lKGN1cnJlbnQsIGVsZW1lbnQpIHsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZSA9IHZvaWQgMDsKCiAgICAgICAgICBpZiAoZW5hYmxlQXN5bmNTdWJ0cmVlQVBJICYmIGVsZW1lbnQgIT0gbnVsbCAmJiBlbGVtZW50LnR5cGUgIT0gbnVsbCAmJiBlbGVtZW50LnR5cGUucHJvdG90eXBlICE9IG51bGwgJiYgZWxlbWVudC50eXBlLnByb3RvdHlwZS51bnN0YWJsZV9pc0FzeW5jUmVhY3RDb21wb25lbnQgPT09IHRydWUpIHsKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUgPSBjb21wdXRlQXN5bmNFeHBpcmF0aW9uKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBleHBpcmF0aW9uVGltZSA9IGNvbXB1dGVFeHBpcmF0aW9uRm9yRmliZXIoY3VycmVudCk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGV4cGlyYXRpb25UaW1lOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVSb290VXBkYXRlKGN1cnJlbnQsIGVsZW1lbnQsIGV4cGlyYXRpb25UaW1lLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5waGFzZSA9PT0gInJlbmRlciIgJiYgUmVhY3REZWJ1Z0N1cnJlbnRGaWJlci5jdXJyZW50ICE9PSBudWxsICYmICFkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IHRydWU7CiAgICAgICAgICAgICAgd2FybmluZyhmYWxzZSwgIlJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlOyAiICsgInRyaWdnZXJpbmcgbmVzdGVkIGNvbXBvbmVudCB1cGRhdGVzIGZyb20gcmVuZGVyIGlzIG5vdCBhbGxvd2VkLiAiICsgIklmIG5lY2Vzc2FyeSwgdHJpZ2dlciBuZXN0ZWQgdXBkYXRlcyBpbiBjb21wb25lbnREaWRVcGRhdGUuXG5cbiIgKyAiQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgJXMuIiwgZ2V0Q29tcG9uZW50TmFtZShSZWFjdERlYnVnQ3VycmVudEZpYmVyLmN1cnJlbnQpIHx8ICJVbmtub3duIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPT09IHVuZGVmaW5lZCA/IG51bGwgOiBjYWxsYmFjazsKICAgICAgICAgIHsKICAgICAgICAgICAgd2FybmluZyhjYWxsYmFjayA9PT0gbnVsbCB8fCB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIsICJyZW5kZXIoLi4uKTogRXhwZWN0ZWQgdGhlIGxhc3Qgb3B0aW9uYWwgYGNhbGxiYWNrYCBhcmd1bWVudCB0byBiZSBhICIgKyAiZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGUgPSB7CiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lOiBleHBpcmF0aW9uVGltZSwKICAgICAgICAgICAgcGFydGlhbFN0YXRlOiB7CiAgICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudAogICAgICAgICAgICB9LAogICAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgICAgIGlzUmVwbGFjZTogZmFsc2UsCiAgICAgICAgICAgIGlzRm9yY2VkOiBmYWxzZSwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGluc2VydFVwZGF0ZUludG9GaWJlcihjdXJyZW50LCB1cGRhdGUpOwogICAgICAgICAgc2NoZWR1bGVXb3JrKGN1cnJlbnQsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgIHJldHVybiBleHBpcmF0aW9uVGltZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNvbnRhaW5lckF0RXhwaXJhdGlvblRpbWUoZWxlbWVudCwgY29udGFpbmVyLCBwYXJlbnRDb21wb25lbnQsIGV4cGlyYXRpb25UaW1lLCBjYWxsYmFjaykgewogICAgICAgICAgdmFyIGN1cnJlbnQgPSBjb250YWluZXIuY3VycmVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKFJlYWN0RmliZXJJbnN0cnVtZW50YXRpb25fMS5kZWJ1Z1Rvb2wpIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudC5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0RmliZXJJbnN0cnVtZW50YXRpb25fMS5kZWJ1Z1Rvb2wub25Nb3VudENvbnRhaW5lcihjb250YWluZXIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbWVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmVhY3RGaWJlckluc3RydW1lbnRhdGlvbl8xLmRlYnVnVG9vbC5vblVubW91bnRDb250YWluZXIoY29udGFpbmVyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgUmVhY3RGaWJlckluc3RydW1lbnRhdGlvbl8xLmRlYnVnVG9vbC5vblVwZGF0ZUNvbnRhaW5lcihjb250YWluZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQgPSBnZXRDb250ZXh0Rm9yU3VidHJlZShwYXJlbnRDb21wb25lbnQpOwoKICAgICAgICAgIGlmIChjb250YWluZXIuY29udGV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBjb250YWluZXIuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250YWluZXIucGVuZGluZ0NvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBzY2hlZHVsZVJvb3RVcGRhdGUoY3VycmVudCwgZWxlbWVudCwgZXhwaXJhdGlvblRpbWUsIGNhbGxiYWNrKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2UoZmliZXIpIHsKICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcihmaWJlcik7CgogICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBjcmVhdGVDb250YWluZXI6IGZ1bmN0aW9uIGNyZWF0ZUNvbnRhaW5lcihjb250YWluZXJJbmZvLCBoeWRyYXRlKSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgaHlkcmF0ZSk7CiAgICAgICAgICB9LAogICAgICAgICAgdXBkYXRlQ29udGFpbmVyOiBmdW5jdGlvbiB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgY29udGFpbmVyLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gY29udGFpbmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZSA9IGNvbXB1dGVSb290RXhwaXJhdGlvblRpbWUoY3VycmVudCwgZWxlbWVudCk7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVDb250YWluZXJBdEV4cGlyYXRpb25UaW1lKGVsZW1lbnQsIGNvbnRhaW5lciwgcGFyZW50Q29tcG9uZW50LCBleHBpcmF0aW9uVGltZSwgY2FsbGJhY2spOwogICAgICAgICAgfSwKICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lckF0RXhwaXJhdGlvblRpbWU6IHVwZGF0ZUNvbnRhaW5lckF0RXhwaXJhdGlvblRpbWUsCiAgICAgICAgICBmbHVzaFJvb3Q6IGZsdXNoUm9vdCwKICAgICAgICAgIHJlcXVlc3RXb3JrOiByZXF1ZXN0V29yaywKICAgICAgICAgIGNvbXB1dGVVbmlxdWVBc3luY0V4cGlyYXRpb246IGNvbXB1dGVVbmlxdWVBc3luY0V4cGlyYXRpb24sCiAgICAgICAgICBiYXRjaGVkVXBkYXRlczogYmF0Y2hlZFVwZGF0ZXMsCiAgICAgICAgICB1bmJhdGNoZWRVcGRhdGVzOiB1bmJhdGNoZWRVcGRhdGVzLAogICAgICAgICAgZGVmZXJyZWRVcGRhdGVzOiBkZWZlcnJlZFVwZGF0ZXMsCiAgICAgICAgICBmbHVzaFN5bmM6IGZsdXNoU3luYywKICAgICAgICAgIGdldFB1YmxpY1Jvb3RJbnN0YW5jZTogZnVuY3Rpb24gZ2V0UHVibGljUm9vdEluc3RhbmNlKGNvbnRhaW5lcikgewogICAgICAgICAgICB2YXIgY29udGFpbmVyRmliZXIgPSBjb250YWluZXIuY3VycmVudDsKCiAgICAgICAgICAgIGlmICghY29udGFpbmVyRmliZXIuY2hpbGQpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dpdGNoIChjb250YWluZXJGaWJlci5jaGlsZC50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0UHVibGljSW5zdGFuY2UoY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlKTsKCiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiBjb250YWluZXJGaWJlci5jaGlsZC5zdGF0ZU5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlOiBmaW5kSG9zdEluc3RhbmNlLAogICAgICAgICAgZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHM6IGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VXaXRoTm9Qb3J0YWxzKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcldpdGhOb1BvcnRhbHMoZmliZXIpOwoKICAgICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIH0sCiAgICAgICAgICBpbmplY3RJbnRvRGV2VG9vbHM6IGZ1bmN0aW9uIGluamVjdEludG9EZXZUb29scyhkZXZUb29sc0NvbmZpZykgewogICAgICAgICAgICB2YXIgX2ZpbmRGaWJlckJ5SG9zdEluc3RhbmNlID0gZGV2VG9vbHNDb25maWcuZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U7CiAgICAgICAgICAgIHJldHVybiBpbmplY3RJbnRlcm5hbHMoYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIGRldlRvb2xzQ29uZmlnLCB7CiAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZUJ5RmliZXI6IGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmluZEhvc3RJbnN0YW5jZShmaWJlcik7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZnVuY3Rpb24gZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgIGlmICghX2ZpbmRGaWJlckJ5SG9zdEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH07CgogICAgICB2YXIgUmVhY3RGaWJlclJlY29uY2lsZXIkMiA9IE9iamVjdC5mcmVlemUoewogICAgICAgIGRlZmF1bHQ6IFJlYWN0RmliZXJSZWNvbmNpbGVyJDEKICAgICAgfSk7CiAgICAgIHZhciBSZWFjdEZpYmVyUmVjb25jaWxlciQzID0gUmVhY3RGaWJlclJlY29uY2lsZXIkMiAmJiBSZWFjdEZpYmVyUmVjb25jaWxlciQxIHx8IFJlYWN0RmliZXJSZWNvbmNpbGVyJDI7CiAgICAgIHZhciByZWFjdFJlY29uY2lsZXIgPSBSZWFjdEZpYmVyUmVjb25jaWxlciQzWyJkZWZhdWx0Il0gPyBSZWFjdEZpYmVyUmVjb25jaWxlciQzWyJkZWZhdWx0Il0gOiBSZWFjdEZpYmVyUmVjb25jaWxlciQzOwogICAgICB2YXIgdmlld0NvbmZpZ0NhbGxiYWNrcyA9IG5ldyBNYXAoKTsKICAgICAgdmFyIHZpZXdDb25maWdzID0gbmV3IE1hcCgpOwoKICAgICAgZnVuY3Rpb24gcmVnaXN0ZXIobmFtZSwgY2FsbGJhY2spIHsKICAgICAgICBpbnZhcmlhbnQoIXZpZXdDb25maWdDYWxsYmFja3MuaGFzKG5hbWUpLCAiVHJpZWQgdG8gcmVnaXN0ZXIgdHdvIHZpZXdzIHdpdGggdGhlIHNhbWUgbmFtZSAlcyIsIG5hbWUpOwogICAgICAgIHZpZXdDb25maWdDYWxsYmFja3Muc2V0KG5hbWUsIGNhbGxiYWNrKTsKICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0JDEobmFtZSkgewogICAgICAgIHZhciB2aWV3Q29uZmlnID0gdm9pZCAwOwoKICAgICAgICBpZiAoIXZpZXdDb25maWdzLmhhcyhuYW1lKSkgewogICAgICAgICAgdmFyIGNhbGxiYWNrID0gdmlld0NvbmZpZ0NhbGxiYWNrcy5nZXQobmFtZSk7CiAgICAgICAgICBpbnZhcmlhbnQodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iLCAiVmlldyBjb25maWcgbm90IGZvdW5kIGZvciBuYW1lICVzIiwgbmFtZSk7CiAgICAgICAgICB2aWV3Q29uZmlnQ2FsbGJhY2tzLnNldChuYW1lLCBudWxsKTsKICAgICAgICAgIHZpZXdDb25maWcgPSBjYWxsYmFjaygpOwogICAgICAgICAgdmlld0NvbmZpZ3Muc2V0KG5hbWUsIHZpZXdDb25maWcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2aWV3Q29uZmlnID0gdmlld0NvbmZpZ3MuZ2V0KG5hbWUpOwogICAgICAgIH0KCiAgICAgICAgaW52YXJpYW50KHZpZXdDb25maWcsICJWaWV3IGNvbmZpZyBub3QgZm91bmQgZm9yIG5hbWUgJXMiLCBuYW1lKTsKICAgICAgICByZXR1cm4gdmlld0NvbmZpZzsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrJDEoaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7CiAgICAgICAgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIFJlYWN0TmF0aXZlRmliZXJIb3N0Q29tcG9uZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFJlYWN0TmF0aXZlRmliZXJIb3N0Q29tcG9uZW50KHRhZywgdmlld0NvbmZpZykgewogICAgICAgICAgX2NsYXNzQ2FsbENoZWNrJDEodGhpcywgUmVhY3ROYXRpdmVGaWJlckhvc3RDb21wb25lbnQpOwoKICAgICAgICAgIHRoaXMuX25hdGl2ZVRhZyA9IHRhZzsKICAgICAgICAgIHRoaXMuX2NoaWxkcmVuID0gW107CiAgICAgICAgICB0aGlzLnZpZXdDb25maWcgPSB2aWV3Q29uZmlnOwogICAgICAgIH0KCiAgICAgICAgUmVhY3ROYXRpdmVGaWJlckhvc3RDb21wb25lbnQucHJvdG90eXBlLmJsdXIgPSBmdW5jdGlvbiBibHVyKCkgewogICAgICAgICAgVGV4dElucHV0U3RhdGUuYmx1clRleHRJbnB1dCh0aGlzLl9uYXRpdmVUYWcpOwogICAgICAgIH07CgogICAgICAgIFJlYWN0TmF0aXZlRmliZXJIb3N0Q29tcG9uZW50LnByb3RvdHlwZS5mb2N1cyA9IGZ1bmN0aW9uIGZvY3VzKCkgewogICAgICAgICAgVGV4dElucHV0U3RhdGUuZm9jdXNUZXh0SW5wdXQodGhpcy5fbmF0aXZlVGFnKTsKICAgICAgICB9OwoKICAgICAgICBSZWFjdE5hdGl2ZUZpYmVySG9zdENvbXBvbmVudC5wcm90b3R5cGUubWVhc3VyZSA9IGZ1bmN0aW9uIG1lYXN1cmUoY2FsbGJhY2spIHsKICAgICAgICAgIFVJTWFuYWdlci5tZWFzdXJlKHRoaXMuX25hdGl2ZVRhZywgbW91bnRTYWZlQ2FsbGJhY2sodGhpcywgY2FsbGJhY2spKTsKICAgICAgICB9OwoKICAgICAgICBSZWFjdE5hdGl2ZUZpYmVySG9zdENvbXBvbmVudC5wcm90b3R5cGUubWVhc3VyZUluV2luZG93ID0gZnVuY3Rpb24gbWVhc3VyZUluV2luZG93KGNhbGxiYWNrKSB7CiAgICAgICAgICBVSU1hbmFnZXIubWVhc3VyZUluV2luZG93KHRoaXMuX25hdGl2ZVRhZywgbW91bnRTYWZlQ2FsbGJhY2sodGhpcywgY2FsbGJhY2spKTsKICAgICAgICB9OwoKICAgICAgICBSZWFjdE5hdGl2ZUZpYmVySG9zdENvbXBvbmVudC5wcm90b3R5cGUubWVhc3VyZUxheW91dCA9IGZ1bmN0aW9uIG1lYXN1cmVMYXlvdXQocmVsYXRpdmVUb05hdGl2ZU5vZGUsIG9uU3VjY2Vzcywgb25GYWlsKSB7CiAgICAgICAgICBVSU1hbmFnZXIubWVhc3VyZUxheW91dCh0aGlzLl9uYXRpdmVUYWcsIHJlbGF0aXZlVG9OYXRpdmVOb2RlLCBtb3VudFNhZmVDYWxsYmFjayh0aGlzLCBvbkZhaWwpLCBtb3VudFNhZmVDYWxsYmFjayh0aGlzLCBvblN1Y2Nlc3MpKTsKICAgICAgICB9OwoKICAgICAgICBSZWFjdE5hdGl2ZUZpYmVySG9zdENvbXBvbmVudC5wcm90b3R5cGUuc2V0TmF0aXZlUHJvcHMgPSBmdW5jdGlvbiBzZXROYXRpdmVQcm9wcyhuYXRpdmVQcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9yU3R5bGVQcm9wcyhuYXRpdmVQcm9wcywgdGhpcy52aWV3Q29uZmlnLnZhbGlkQXR0cmlidXRlcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGNyZWF0ZShuYXRpdmVQcm9wcywgdGhpcy52aWV3Q29uZmlnLnZhbGlkQXR0cmlidXRlcyk7CgogICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT0gbnVsbCkgewogICAgICAgICAgICBVSU1hbmFnZXIudXBkYXRlVmlldyh0aGlzLl9uYXRpdmVUYWcsIHRoaXMudmlld0NvbmZpZy51aVZpZXdDbGFzc05hbWUsIHVwZGF0ZVBheWxvYWQpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBSZWFjdE5hdGl2ZUZpYmVySG9zdENvbXBvbmVudDsKICAgICAgfSgpOwoKICAgICAgdmFyIGhhc05hdGl2ZVBlcmZvcm1hbmNlTm93ID0gdHlwZW9mIHBlcmZvcm1hbmNlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAiZnVuY3Rpb24iOwogICAgICB2YXIgbm93ID0gaGFzTmF0aXZlUGVyZm9ybWFuY2VOb3cgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9IDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBEYXRlLm5vdygpOwogICAgICB9OwogICAgICB2YXIgc2NoZWR1bGVkQ2FsbGJhY2sgPSBudWxsOwogICAgICB2YXIgZnJhbWVEZWFkbGluZSA9IDA7CiAgICAgIHZhciBmcmFtZURlYWRsaW5lT2JqZWN0ID0gewogICAgICAgIHRpbWVSZW1haW5pbmc6IGZ1bmN0aW9uIHRpbWVSZW1haW5pbmcoKSB7CiAgICAgICAgICByZXR1cm4gZnJhbWVEZWFkbGluZSAtIG5vdygpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIHNldFRpbWVvdXRDYWxsYmFjaygpIHsKICAgICAgICBmcmFtZURlYWRsaW5lID0gbm93KCkgKyA1OwogICAgICAgIHZhciBjYWxsYmFjayA9IHNjaGVkdWxlZENhbGxiYWNrOwogICAgICAgIHNjaGVkdWxlZENhbGxiYWNrID0gbnVsbDsKCiAgICAgICAgaWYgKGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICBjYWxsYmFjayhmcmFtZURlYWRsaW5lT2JqZWN0KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlRGVmZXJyZWRDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgIHNjaGVkdWxlZENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoc2V0VGltZW91dENhbGxiYWNrLCAxKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY2FuY2VsRGVmZXJyZWRDYWxsYmFjayhjYWxsYmFja0lEKSB7CiAgICAgICAgc2NoZWR1bGVkQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIGNsZWFyVGltZW91dChjYWxsYmFja0lEKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlVbmNhY2hlRmliZXJOb2RlKG5vZGUpIHsKICAgICAgICBpZiAodHlwZW9mIG5vZGUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICB1bmNhY2hlRmliZXJOb2RlKG5vZGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB1bmNhY2hlRmliZXJOb2RlKG5vZGUuX25hdGl2ZVRhZyk7CgogICAgICAgICAgbm9kZS5fY2hpbGRyZW4uZm9yRWFjaChyZWN1cnNpdmVseVVuY2FjaGVGaWJlck5vZGUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIE5hdGl2ZVJlbmRlcmVyID0gcmVhY3RSZWNvbmNpbGVyKHsKICAgICAgICBhcHBlbmRJbml0aWFsQ2hpbGQ6IGZ1bmN0aW9uIGFwcGVuZEluaXRpYWxDaGlsZChwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICAgIHBhcmVudEluc3RhbmNlLl9jaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgICAgICB9LAogICAgICAgIGNyZWF0ZUluc3RhbmNlOiBmdW5jdGlvbiBjcmVhdGVJbnN0YW5jZSh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgdmFyIHRhZyA9IFJlYWN0TmF0aXZlVGFnSGFuZGxlcy5hbGxvY2F0ZVRhZygpOwogICAgICAgICAgdmFyIHZpZXdDb25maWcgPSBnZXQkMSh0eXBlKTsKICAgICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHZpZXdDb25maWcudmFsaWRBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIGRlZXBGcmVlemVBbmRUaHJvd09uTXV0YXRpb25JbkRldihwcm9wc1trZXldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gY3JlYXRlKHByb3BzLCB2aWV3Q29uZmlnLnZhbGlkQXR0cmlidXRlcyk7CiAgICAgICAgICBVSU1hbmFnZXIuY3JlYXRlVmlldyh0YWcsIHZpZXdDb25maWcudWlWaWV3Q2xhc3NOYW1lLCByb290Q29udGFpbmVySW5zdGFuY2UsIHVwZGF0ZVBheWxvYWQpOwogICAgICAgICAgdmFyIGNvbXBvbmVudCA9IG5ldyBSZWFjdE5hdGl2ZUZpYmVySG9zdENvbXBvbmVudCh0YWcsIHZpZXdDb25maWcpOwogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgdGFnKTsKICAgICAgICAgIHVwZGF0ZUZpYmVyUHJvcHModGFnLCBwcm9wcyk7CiAgICAgICAgICByZXR1cm4gY29tcG9uZW50OwogICAgICAgIH0sCiAgICAgICAgY3JlYXRlVGV4dEluc3RhbmNlOiBmdW5jdGlvbiBjcmVhdGVUZXh0SW5zdGFuY2UodGV4dCwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgdmFyIHRhZyA9IFJlYWN0TmF0aXZlVGFnSGFuZGxlcy5hbGxvY2F0ZVRhZygpOwogICAgICAgICAgVUlNYW5hZ2VyLmNyZWF0ZVZpZXcodGFnLCAiUkNUUmF3VGV4dCIsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgewogICAgICAgICAgICB0ZXh0OiB0ZXh0CiAgICAgICAgICB9KTsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHRhZyk7CiAgICAgICAgICByZXR1cm4gdGFnOwogICAgICAgIH0sCiAgICAgICAgZmluYWxpemVJbml0aWFsQ2hpbGRyZW46IGZ1bmN0aW9uIGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKHBhcmVudEluc3RhbmNlLCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICBpZiAocGFyZW50SW5zdGFuY2UuX2NoaWxkcmVuLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG5hdGl2ZVRhZ3MgPSBwYXJlbnRJbnN0YW5jZS5fY2hpbGRyZW4ubWFwKGZ1bmN0aW9uIChjaGlsZCkgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIGNoaWxkID09PSAibnVtYmVyIiA/IGNoaWxkIDogY2hpbGQuX25hdGl2ZVRhZzsKICAgICAgICAgIH0pOwoKICAgICAgICAgIFVJTWFuYWdlci5zZXRDaGlsZHJlbihwYXJlbnRJbnN0YW5jZS5fbmF0aXZlVGFnLCBuYXRpdmVUYWdzKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAogICAgICAgIGdldFJvb3RIb3N0Q29udGV4dDogZnVuY3Rpb24gZ2V0Um9vdEhvc3RDb250ZXh0KCkgewogICAgICAgICAgcmV0dXJuIGVtcHR5T2JqZWN0OwogICAgICAgIH0sCiAgICAgICAgZ2V0Q2hpbGRIb3N0Q29udGV4dDogZnVuY3Rpb24gZ2V0Q2hpbGRIb3N0Q29udGV4dCgpIHsKICAgICAgICAgIHJldHVybiBlbXB0eU9iamVjdDsKICAgICAgICB9LAogICAgICAgIGdldFB1YmxpY0luc3RhbmNlOiBmdW5jdGlvbiBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0sCiAgICAgICAgbm93OiBub3csCiAgICAgICAgcHJlcGFyZUZvckNvbW1pdDogZnVuY3Rpb24gcHJlcGFyZUZvckNvbW1pdCgpIHt9LAogICAgICAgIHByZXBhcmVVcGRhdGU6IGZ1bmN0aW9uIHByZXBhcmVVcGRhdGUoaW5zdGFuY2UsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgcmV0dXJuIGVtcHR5T2JqZWN0OwogICAgICAgIH0sCiAgICAgICAgcmVzZXRBZnRlckNvbW1pdDogZnVuY3Rpb24gcmVzZXRBZnRlckNvbW1pdCgpIHt9LAogICAgICAgIHNjaGVkdWxlRGVmZXJyZWRDYWxsYmFjazogc2NoZWR1bGVEZWZlcnJlZENhbGxiYWNrLAogICAgICAgIGNhbmNlbERlZmVycmVkQ2FsbGJhY2s6IGNhbmNlbERlZmVycmVkQ2FsbGJhY2ssCiAgICAgICAgc2hvdWxkRGVwcmlvcml0aXplU3VidHJlZTogZnVuY3Rpb24gc2hvdWxkRGVwcmlvcml0aXplU3VidHJlZSh0eXBlLCBwcm9wcykgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgc2hvdWxkU2V0VGV4dENvbnRlbnQ6IGZ1bmN0aW9uIHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIHByb3BzKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICB1c2VTeW5jU2NoZWR1bGluZzogdHJ1ZSwKICAgICAgICBtdXRhdGlvbjogewogICAgICAgICAgYXBwZW5kQ2hpbGQ6IGZ1bmN0aW9uIGFwcGVuZENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgICB2YXIgY2hpbGRUYWcgPSB0eXBlb2YgY2hpbGQgPT09ICJudW1iZXIiID8gY2hpbGQgOiBjaGlsZC5fbmF0aXZlVGFnOwogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBwYXJlbnRJbnN0YW5jZS5fY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBpbmRleCA9IGNoaWxkcmVuLmluZGV4T2YoY2hpbGQpOwoKICAgICAgICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICAgICAgICBjaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgICAgICAgICAgIFVJTWFuYWdlci5tYW5hZ2VDaGlsZHJlbihwYXJlbnRJbnN0YW5jZS5fbmF0aXZlVGFnLCBbaW5kZXhdLCBbY2hpbGRyZW4ubGVuZ3RoIC0gMV0sIFtdLCBbXSwgW10pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgICAgICAgICAgIFVJTWFuYWdlci5tYW5hZ2VDaGlsZHJlbihwYXJlbnRJbnN0YW5jZS5fbmF0aXZlVGFnLCBbXSwgW10sIFtjaGlsZFRhZ10sIFtjaGlsZHJlbi5sZW5ndGggLSAxXSwgW10pOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcjogZnVuY3Rpb24gYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcihwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICAgICAgdmFyIGNoaWxkVGFnID0gdHlwZW9mIGNoaWxkID09PSAibnVtYmVyIiA/IGNoaWxkIDogY2hpbGQuX25hdGl2ZVRhZzsKICAgICAgICAgICAgVUlNYW5hZ2VyLnNldENoaWxkcmVuKHBhcmVudEluc3RhbmNlLCBbY2hpbGRUYWddKTsKICAgICAgICAgIH0sCiAgICAgICAgICBjb21taXRUZXh0VXBkYXRlOiBmdW5jdGlvbiBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgICBVSU1hbmFnZXIudXBkYXRlVmlldyh0ZXh0SW5zdGFuY2UsICJSQ1RSYXdUZXh0IiwgewogICAgICAgICAgICAgIHRleHQ6IG5ld1RleHQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgY29tbWl0TW91bnQ6IGZ1bmN0aW9uIGNvbW1pdE1vdW50KGluc3RhbmNlLCB0eXBlLCBuZXdQcm9wcywgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkge30sCiAgICAgICAgICBjb21taXRVcGRhdGU6IGZ1bmN0aW9uIGNvbW1pdFVwZGF0ZShpbnN0YW5jZSwgdXBkYXRlUGF5bG9hZFRPRE8sIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgICB2YXIgdmlld0NvbmZpZyA9IGluc3RhbmNlLnZpZXdDb25maWc7CiAgICAgICAgICAgIHVwZGF0ZUZpYmVyUHJvcHMoaW5zdGFuY2UuX25hdGl2ZVRhZywgbmV3UHJvcHMpOwogICAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGRpZmYob2xkUHJvcHMsIG5ld1Byb3BzLCB2aWV3Q29uZmlnLnZhbGlkQXR0cmlidXRlcyk7CgogICAgICAgICAgICBpZiAodXBkYXRlUGF5bG9hZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgVUlNYW5hZ2VyLnVwZGF0ZVZpZXcoaW5zdGFuY2UuX25hdGl2ZVRhZywgdmlld0NvbmZpZy51aVZpZXdDbGFzc05hbWUsIHVwZGF0ZVBheWxvYWQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgaW5zZXJ0QmVmb3JlOiBmdW5jdGlvbiBpbnNlcnRCZWZvcmUocGFyZW50SW5zdGFuY2UsIGNoaWxkLCBiZWZvcmVDaGlsZCkgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBwYXJlbnRJbnN0YW5jZS5fY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBpbmRleCA9IGNoaWxkcmVuLmluZGV4T2YoY2hpbGQpOwoKICAgICAgICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICAgICAgICBjaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICAgIHZhciBiZWZvcmVDaGlsZEluZGV4ID0gY2hpbGRyZW4uaW5kZXhPZihiZWZvcmVDaGlsZCk7CiAgICAgICAgICAgICAgY2hpbGRyZW4uc3BsaWNlKGJlZm9yZUNoaWxkSW5kZXgsIDAsIGNoaWxkKTsKICAgICAgICAgICAgICBVSU1hbmFnZXIubWFuYWdlQ2hpbGRyZW4ocGFyZW50SW5zdGFuY2UuX25hdGl2ZVRhZywgW2luZGV4XSwgW2JlZm9yZUNoaWxkSW5kZXhdLCBbXSwgW10sIFtdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2JlZm9yZUNoaWxkSW5kZXggPSBjaGlsZHJlbi5pbmRleE9mKGJlZm9yZUNoaWxkKTsKCiAgICAgICAgICAgICAgY2hpbGRyZW4uc3BsaWNlKF9iZWZvcmVDaGlsZEluZGV4LCAwLCBjaGlsZCk7CiAgICAgICAgICAgICAgdmFyIGNoaWxkVGFnID0gdHlwZW9mIGNoaWxkID09PSAibnVtYmVyIiA/IGNoaWxkIDogY2hpbGQuX25hdGl2ZVRhZzsKICAgICAgICAgICAgICBVSU1hbmFnZXIubWFuYWdlQ2hpbGRyZW4ocGFyZW50SW5zdGFuY2UuX25hdGl2ZVRhZywgW10sIFtdLCBbY2hpbGRUYWddLCBbX2JlZm9yZUNoaWxkSW5kZXhdLCBbXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBpbnNlcnRJbkNvbnRhaW5lckJlZm9yZTogZnVuY3Rpb24gaW5zZXJ0SW5Db250YWluZXJCZWZvcmUocGFyZW50SW5zdGFuY2UsIGNoaWxkLCBiZWZvcmVDaGlsZCkgewogICAgICAgICAgICBpbnZhcmlhbnQodHlwZW9mIHBhcmVudEluc3RhbmNlICE9PSAibnVtYmVyIiwgIkNvbnRhaW5lciBkb2VzIG5vdCBzdXBwb3J0IGluc2VydEJlZm9yZSBvcGVyYXRpb24iKTsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmVDaGlsZDogZnVuY3Rpb24gcmVtb3ZlQ2hpbGQocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VW5jYWNoZUZpYmVyTm9kZShjaGlsZCk7CiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IHBhcmVudEluc3RhbmNlLl9jaGlsZHJlbjsKICAgICAgICAgICAgdmFyIGluZGV4ID0gY2hpbGRyZW4uaW5kZXhPZihjaGlsZCk7CiAgICAgICAgICAgIGNoaWxkcmVuLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIFVJTWFuYWdlci5tYW5hZ2VDaGlsZHJlbihwYXJlbnRJbnN0YW5jZS5fbmF0aXZlVGFnLCBbXSwgW10sIFtdLCBbXSwgW2luZGV4XSk7CiAgICAgICAgICB9LAogICAgICAgICAgcmVtb3ZlQ2hpbGRGcm9tQ29udGFpbmVyOiBmdW5jdGlvbiByZW1vdmVDaGlsZEZyb21Db250YWluZXIocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VW5jYWNoZUZpYmVyTm9kZShjaGlsZCk7CiAgICAgICAgICAgIFVJTWFuYWdlci5tYW5hZ2VDaGlsZHJlbihwYXJlbnRJbnN0YW5jZSwgW10sIFtdLCBbXSwgW10sIFswXSk7CiAgICAgICAgICB9LAogICAgICAgICAgcmVzZXRUZXh0Q29udGVudDogZnVuY3Rpb24gcmVzZXRUZXh0Q29udGVudChpbnN0YW5jZSkge30KICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgZnVuY3Rpb24gZmluZE5vZGVIYW5kbGUoY29tcG9uZW50T3JIYW5kbGUpIHsKICAgICAgICB7CiAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50OwoKICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci5zdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgd2FybmluZyhvd25lci5zdGF0ZU5vZGUuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyLCAiJXMgaXMgYWNjZXNzaW5nIGZpbmROb2RlSGFuZGxlIGluc2lkZSBpdHMgcmVuZGVyKCkuICIgKyAicmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCAiICsgIm5ldmVyIGFjY2VzcyBzb21ldGhpbmcgdGhhdCByZXF1aXJlcyBzdGFsZSBkYXRhIGZyb20gdGhlIHByZXZpb3VzICIgKyAicmVuZGVyLCBzdWNoIGFzIHJlZnMuIE1vdmUgdGhpcyBsb2dpYyB0byBjb21wb25lbnREaWRNb3VudCBhbmQgIiArICJjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lKG93bmVyKSB8fCAiQSBjb21wb25lbnQiKTsKICAgICAgICAgICAgb3duZXIuc3RhdGVOb2RlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlciA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tcG9uZW50T3JIYW5kbGUgPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGNvbXBvbmVudE9ySGFuZGxlID09PSAibnVtYmVyIikgewogICAgICAgICAgcmV0dXJuIGNvbXBvbmVudE9ySGFuZGxlOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNvbXBvbmVudCA9IGNvbXBvbmVudE9ySGFuZGxlOwogICAgICAgIHZhciBpbnRlcm5hbEluc3RhbmNlID0gZ2V0KGNvbXBvbmVudCk7CgogICAgICAgIGlmIChpbnRlcm5hbEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gTmF0aXZlUmVuZGVyZXIuZmluZEhvc3RJbnN0YW5jZShpbnRlcm5hbEluc3RhbmNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm4gY29tcG9uZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW52YXJpYW50KHR5cGVvZiBjb21wb25lbnQgPT09ICJvYmplY3QiICYmICJfbmF0aXZlVGFnIiBpbiBjb21wb25lbnQgfHwgY29tcG9uZW50LnJlbmRlciAhPSBudWxsICYmIHR5cGVvZiBjb21wb25lbnQucmVuZGVyID09PSAiZnVuY3Rpb24iLCAiZmluZE5vZGVIYW5kbGUoLi4uKTogQXJndW1lbnQgaXMgbm90IGEgY29tcG9uZW50ICIgKyAiKHR5cGU6ICVzLCBrZXlzOiAlcykiLCB0eXBlb2YgY29tcG9uZW50LCBPYmplY3Qua2V5cyhjb21wb25lbnQpKTsKICAgICAgICAgICAgaW52YXJpYW50KGZhbHNlLCAiZmluZE5vZGVIYW5kbGUoLi4uKTogVW5hYmxlIHRvIGZpbmQgbm9kZSBoYW5kbGUgZm9yIHVubW91bnRlZCAiICsgImNvbXBvbmVudC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGZpbmROdW1lcmljTm9kZUhhbmRsZUZpYmVyKGNvbXBvbmVudE9ySGFuZGxlKSB7CiAgICAgICAgdmFyIGluc3RhbmNlID0gZmluZE5vZGVIYW5kbGUoY29tcG9uZW50T3JIYW5kbGUpOwoKICAgICAgICBpZiAoaW5zdGFuY2UgPT0gbnVsbCB8fCB0eXBlb2YgaW5zdGFuY2UgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaW5zdGFuY2UuX25hdGl2ZVRhZzsKICAgICAgfQoKICAgICAgdmFyIE5hdGl2ZU1ldGhvZHNNaXhpbiA9IHsKICAgICAgICBtZWFzdXJlOiBmdW5jdGlvbiBtZWFzdXJlKGNhbGxiYWNrKSB7CiAgICAgICAgICBVSU1hbmFnZXIubWVhc3VyZShmaW5kTnVtZXJpY05vZGVIYW5kbGVGaWJlcih0aGlzKSwgbW91bnRTYWZlQ2FsbGJhY2sodGhpcywgY2FsbGJhY2spKTsKICAgICAgICB9LAogICAgICAgIG1lYXN1cmVJbldpbmRvdzogZnVuY3Rpb24gbWVhc3VyZUluV2luZG93KGNhbGxiYWNrKSB7CiAgICAgICAgICBVSU1hbmFnZXIubWVhc3VyZUluV2luZG93KGZpbmROdW1lcmljTm9kZUhhbmRsZUZpYmVyKHRoaXMpLCBtb3VudFNhZmVDYWxsYmFjayh0aGlzLCBjYWxsYmFjaykpOwogICAgICAgIH0sCiAgICAgICAgbWVhc3VyZUxheW91dDogZnVuY3Rpb24gbWVhc3VyZUxheW91dChyZWxhdGl2ZVRvTmF0aXZlTm9kZSwgb25TdWNjZXNzLCBvbkZhaWwpIHsKICAgICAgICAgIFVJTWFuYWdlci5tZWFzdXJlTGF5b3V0KGZpbmROdW1lcmljTm9kZUhhbmRsZUZpYmVyKHRoaXMpLCByZWxhdGl2ZVRvTmF0aXZlTm9kZSwgbW91bnRTYWZlQ2FsbGJhY2sodGhpcywgb25GYWlsKSwgbW91bnRTYWZlQ2FsbGJhY2sodGhpcywgb25TdWNjZXNzKSk7CiAgICAgICAgfSwKICAgICAgICBzZXROYXRpdmVQcm9wczogZnVuY3Rpb24gc2V0TmF0aXZlUHJvcHMobmF0aXZlUHJvcHMpIHsKICAgICAgICAgIHZhciBtYXliZUluc3RhbmNlID0gdm9pZCAwOwoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIG1heWJlSW5zdGFuY2UgPSBmaW5kTm9kZUhhbmRsZSh0aGlzKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7fQoKICAgICAgICAgIGlmIChtYXliZUluc3RhbmNlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciB2aWV3Q29uZmlnID0gbWF5YmVJbnN0YW5jZS52aWV3Q29uZmlnOwogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9yU3R5bGVQcm9wcyhuYXRpdmVQcm9wcywgdmlld0NvbmZpZy52YWxpZEF0dHJpYnV0ZXMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBjcmVhdGUobmF0aXZlUHJvcHMsIHZpZXdDb25maWcudmFsaWRBdHRyaWJ1dGVzKTsKCiAgICAgICAgICBpZiAodXBkYXRlUGF5bG9hZCAhPSBudWxsKSB7CiAgICAgICAgICAgIFVJTWFuYWdlci51cGRhdGVWaWV3KG1heWJlSW5zdGFuY2UuX25hdGl2ZVRhZywgdmlld0NvbmZpZy51aVZpZXdDbGFzc05hbWUsIHVwZGF0ZVBheWxvYWQpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uIGZvY3VzKCkgewogICAgICAgICAgVGV4dElucHV0U3RhdGUuZm9jdXNUZXh0SW5wdXQoZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIodGhpcykpOwogICAgICAgIH0sCiAgICAgICAgYmx1cjogZnVuY3Rpb24gYmx1cigpIHsKICAgICAgICAgIFRleHRJbnB1dFN0YXRlLmJsdXJUZXh0SW5wdXQoZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIodGhpcykpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgewogICAgICAgIHZhciBOYXRpdmVNZXRob2RzTWl4aW5fREVWID0gTmF0aXZlTWV0aG9kc01peGluOwogICAgICAgIGludmFyaWFudCghTmF0aXZlTWV0aG9kc01peGluX0RFVi5jb21wb25lbnRXaWxsTW91bnQgJiYgIU5hdGl2ZU1ldGhvZHNNaXhpbl9ERVYuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcywgIkRvIG5vdCBvdmVycmlkZSBleGlzdGluZyBmdW5jdGlvbnMuIik7CgogICAgICAgIE5hdGl2ZU1ldGhvZHNNaXhpbl9ERVYuY29tcG9uZW50V2lsbE1vdW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgdGhyb3dPblN0eWxlc1Byb3AodGhpcywgdGhpcy5wcm9wcyk7CiAgICAgICAgfTsKCiAgICAgICAgTmF0aXZlTWV0aG9kc01peGluX0RFVi5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID0gZnVuY3Rpb24gKG5ld1Byb3BzKSB7CiAgICAgICAgICB0aHJvd09uU3R5bGVzUHJvcCh0aGlzLCBuZXdQcm9wcyk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrJDIoaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7CiAgICAgICAgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gX3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4oc2VsZiwgY2FsbCkgewogICAgICAgIGlmICghc2VsZikgewogICAgICAgICAgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJ0aGlzIGhhc24ndCBiZWVuIGluaXRpYWxpc2VkIC0gc3VwZXIoKSBoYXNuJ3QgYmVlbiBjYWxsZWQiKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBjYWxsICYmICh0eXBlb2YgY2FsbCA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGNhbGwgPT09ICJmdW5jdGlvbiIpID8gY2FsbCA6IHNlbGY7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgewogICAgICAgIGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gImZ1bmN0aW9uIiAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICIgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7CiAgICAgICAgfQoKICAgICAgICBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsKICAgICAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgICAgIHZhbHVlOiBzdWJDbGFzcywKICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7CiAgICAgIH0KCiAgICAgIHZhciBSZWFjdE5hdGl2ZUNvbXBvbmVudCA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50KSB7CiAgICAgICAgX2luaGVyaXRzKFJlYWN0TmF0aXZlQ29tcG9uZW50LCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICAgICAgZnVuY3Rpb24gUmVhY3ROYXRpdmVDb21wb25lbnQoKSB7CiAgICAgICAgICBfY2xhc3NDYWxsQ2hlY2skMih0aGlzLCBSZWFjdE5hdGl2ZUNvbXBvbmVudCk7CgogICAgICAgICAgcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIF9SZWFjdCRDb21wb25lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgfQoKICAgICAgICBSZWFjdE5hdGl2ZUNvbXBvbmVudC5wcm90b3R5cGUuYmx1ciA9IGZ1bmN0aW9uIGJsdXIoKSB7CiAgICAgICAgICBUZXh0SW5wdXRTdGF0ZS5ibHVyVGV4dElucHV0KGZpbmROdW1lcmljTm9kZUhhbmRsZUZpYmVyKHRoaXMpKTsKICAgICAgICB9OwoKICAgICAgICBSZWFjdE5hdGl2ZUNvbXBvbmVudC5wcm90b3R5cGUuZm9jdXMgPSBmdW5jdGlvbiBmb2N1cygpIHsKICAgICAgICAgIFRleHRJbnB1dFN0YXRlLmZvY3VzVGV4dElucHV0KGZpbmROdW1lcmljTm9kZUhhbmRsZUZpYmVyKHRoaXMpKTsKICAgICAgICB9OwoKICAgICAgICBSZWFjdE5hdGl2ZUNvbXBvbmVudC5wcm90b3R5cGUubWVhc3VyZSA9IGZ1bmN0aW9uIG1lYXN1cmUoY2FsbGJhY2spIHsKICAgICAgICAgIFVJTWFuYWdlci5tZWFzdXJlKGZpbmROdW1lcmljTm9kZUhhbmRsZUZpYmVyKHRoaXMpLCBtb3VudFNhZmVDYWxsYmFjayh0aGlzLCBjYWxsYmFjaykpOwogICAgICAgIH07CgogICAgICAgIFJlYWN0TmF0aXZlQ29tcG9uZW50LnByb3RvdHlwZS5tZWFzdXJlSW5XaW5kb3cgPSBmdW5jdGlvbiBtZWFzdXJlSW5XaW5kb3coY2FsbGJhY2spIHsKICAgICAgICAgIFVJTWFuYWdlci5tZWFzdXJlSW5XaW5kb3coZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIodGhpcyksIG1vdW50U2FmZUNhbGxiYWNrKHRoaXMsIGNhbGxiYWNrKSk7CiAgICAgICAgfTsKCiAgICAgICAgUmVhY3ROYXRpdmVDb21wb25lbnQucHJvdG90eXBlLm1lYXN1cmVMYXlvdXQgPSBmdW5jdGlvbiBtZWFzdXJlTGF5b3V0KHJlbGF0aXZlVG9OYXRpdmVOb2RlLCBvblN1Y2Nlc3MsIG9uRmFpbCkgewogICAgICAgICAgVUlNYW5hZ2VyLm1lYXN1cmVMYXlvdXQoZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIodGhpcyksIHJlbGF0aXZlVG9OYXRpdmVOb2RlLCBtb3VudFNhZmVDYWxsYmFjayh0aGlzLCBvbkZhaWwpLCBtb3VudFNhZmVDYWxsYmFjayh0aGlzLCBvblN1Y2Nlc3MpKTsKICAgICAgICB9OwoKICAgICAgICBSZWFjdE5hdGl2ZUNvbXBvbmVudC5wcm90b3R5cGUuc2V0TmF0aXZlUHJvcHMgPSBmdW5jdGlvbiBzZXROYXRpdmVQcm9wcyhuYXRpdmVQcm9wcykgewogICAgICAgICAgdmFyIG1heWJlSW5zdGFuY2UgPSB2b2lkIDA7CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbWF5YmVJbnN0YW5jZSA9IGZpbmROb2RlSGFuZGxlKHRoaXMpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHt9CgogICAgICAgICAgaWYgKG1heWJlSW5zdGFuY2UgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHZpZXdDb25maWcgPSBtYXliZUluc3RhbmNlLnZpZXdDb25maWc7CiAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGNyZWF0ZShuYXRpdmVQcm9wcywgdmlld0NvbmZpZy52YWxpZEF0dHJpYnV0ZXMpOwoKICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkICE9IG51bGwpIHsKICAgICAgICAgICAgVUlNYW5hZ2VyLnVwZGF0ZVZpZXcobWF5YmVJbnN0YW5jZS5fbmF0aXZlVGFnLCB2aWV3Q29uZmlnLnVpVmlld0NsYXNzTmFtZSwgdXBkYXRlUGF5bG9hZCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFJlYWN0TmF0aXZlQ29tcG9uZW50OwogICAgICB9KFJlYWN0LkNvbXBvbmVudCk7CgogICAgICB2YXIgZ2V0SW5zcGVjdG9yRGF0YUZvclZpZXdUYWcgPSB2b2lkIDA7CiAgICAgIHsKICAgICAgICB2YXIgdHJhdmVyc2VPd25lclRyZWVVcCA9IGZ1bmN0aW9uIHRyYXZlcnNlT3duZXJUcmVlVXAoaGllcmFyY2h5LCBpbnN0YW5jZSkgewogICAgICAgICAgaWYgKGluc3RhbmNlKSB7CiAgICAgICAgICAgIGhpZXJhcmNoeS51bnNoaWZ0KGluc3RhbmNlKTsKICAgICAgICAgICAgdHJhdmVyc2VPd25lclRyZWVVcChoaWVyYXJjaHksIGluc3RhbmNlLl9kZWJ1Z093bmVyKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgZ2V0T3duZXJIaWVyYXJjaHkgPSBmdW5jdGlvbiBnZXRPd25lckhpZXJhcmNoeShpbnN0YW5jZSkgewogICAgICAgICAgdmFyIGhpZXJhcmNoeSA9IFtdOwogICAgICAgICAgdHJhdmVyc2VPd25lclRyZWVVcChoaWVyYXJjaHksIGluc3RhbmNlKTsKICAgICAgICAgIHJldHVybiBoaWVyYXJjaHk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIGxhc3ROb25Ib3N0SW5zdGFuY2UgPSBmdW5jdGlvbiBsYXN0Tm9uSG9zdEluc3RhbmNlKGhpZXJhcmNoeSkgewogICAgICAgICAgZm9yICh2YXIgaSA9IGhpZXJhcmNoeS5sZW5ndGggLSAxOyBpID4gMTsgaS0tKSB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGhpZXJhcmNoeVtpXTsKCiAgICAgICAgICAgIGlmIChpbnN0YW5jZS50YWcgIT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gaGllcmFyY2h5WzBdOwogICAgICAgIH07CgogICAgICAgIHZhciBnZXRIb3N0UHJvcHMgPSBmdW5jdGlvbiBnZXRIb3N0UHJvcHMoZmliZXIpIHsKICAgICAgICAgIHZhciBob3N0ID0gZmluZEN1cnJlbnRIb3N0RmliZXIoZmliZXIpOwoKICAgICAgICAgIGlmIChob3N0KSB7CiAgICAgICAgICAgIHJldHVybiBob3N0Lm1lbW9pemVkUHJvcHMgfHwgZW1wdHlPYmplY3Q7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGVtcHR5T2JqZWN0OwogICAgICAgIH07CgogICAgICAgIHZhciBnZXRIb3N0Tm9kZSA9IGZ1bmN0aW9uIGdldEhvc3ROb2RlKGZpYmVyLCBmaW5kTm9kZUhhbmRsZSkgewogICAgICAgICAgdmFyIGhvc3ROb2RlID0gdm9pZCAwOwoKICAgICAgICAgIHdoaWxlIChmaWJlcikgewogICAgICAgICAgICBpZiAoZmliZXIuc3RhdGVOb2RlICE9PSBudWxsICYmIGZpYmVyLnRhZyA9PT0gSG9zdENvbXBvbmVudCkgewogICAgICAgICAgICAgIGhvc3ROb2RlID0gZmluZE5vZGVIYW5kbGUoZmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGhvc3ROb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGhvc3ROb2RlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmaWJlciA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CgogICAgICAgIHZhciBjcmVhdGVIaWVyYXJjaHkgPSBmdW5jdGlvbiBjcmVhdGVIaWVyYXJjaHkoZmliZXJIaWVyYXJjaHkpIHsKICAgICAgICAgIHJldHVybiBmaWJlckhpZXJhcmNoeS5tYXAoZnVuY3Rpb24gKGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZTogZ2V0Q29tcG9uZW50TmFtZShmaWJlciksCiAgICAgICAgICAgICAgZ2V0SW5zcGVjdG9yRGF0YTogZnVuY3Rpb24gZ2V0SW5zcGVjdG9yRGF0YShmaW5kTm9kZUhhbmRsZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgbWVhc3VyZTogZnVuY3Rpb24gbWVhc3VyZShjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBVSU1hbmFnZXIubWVhc3VyZShnZXRIb3N0Tm9kZShmaWJlciwgZmluZE5vZGVIYW5kbGUpLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHByb3BzOiBnZXRIb3N0UHJvcHMoZmliZXIpLAogICAgICAgICAgICAgICAgICBzb3VyY2U6IGZpYmVyLl9kZWJ1Z1NvdXJjZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBnZXRJbnNwZWN0b3JEYXRhRm9yVmlld1RhZyA9IGZ1bmN0aW9uIGdldEluc3BlY3RvckRhdGFGb3JWaWV3VGFnKHZpZXdUYWcpIHsKICAgICAgICAgIHZhciBjbG9zZXN0SW5zdGFuY2UgPSBnZXRJbnN0YW5jZUZyb21UYWcodmlld1RhZyk7CgogICAgICAgICAgaWYgKCFjbG9zZXN0SW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBoaWVyYXJjaHk6IFtdLAogICAgICAgICAgICAgIHByb3BzOiBlbXB0eU9iamVjdCwKICAgICAgICAgICAgICBzZWxlY3Rpb246IG51bGwsCiAgICAgICAgICAgICAgc291cmNlOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGZpYmVyID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgoY2xvc2VzdEluc3RhbmNlKTsKICAgICAgICAgIHZhciBmaWJlckhpZXJhcmNoeSA9IGdldE93bmVySGllcmFyY2h5KGZpYmVyKTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGxhc3ROb25Ib3N0SW5zdGFuY2UoZmliZXJIaWVyYXJjaHkpOwogICAgICAgICAgdmFyIGhpZXJhcmNoeSA9IGNyZWF0ZUhpZXJhcmNoeShmaWJlckhpZXJhcmNoeSk7CiAgICAgICAgICB2YXIgcHJvcHMgPSBnZXRIb3N0UHJvcHMoaW5zdGFuY2UpOwogICAgICAgICAgdmFyIHNvdXJjZSA9IGluc3RhbmNlLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSBmaWJlckhpZXJhcmNoeS5pbmRleE9mKGluc3RhbmNlKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGhpZXJhcmNoeTogaGllcmFyY2h5LAogICAgICAgICAgICBwcm9wczogcHJvcHMsCiAgICAgICAgICAgIHNlbGVjdGlvbjogc2VsZWN0aW9uLAogICAgICAgICAgICBzb3VyY2U6IHNvdXJjZQogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICB9CgogICAgICB2YXIgY3JlYXRlUmVhY3ROYXRpdmVDb21wb25lbnRDbGFzcyA9IGZ1bmN0aW9uIGNyZWF0ZVJlYWN0TmF0aXZlQ29tcG9uZW50Q2xhc3MobmFtZSwgY2FsbGJhY2spIHsKICAgICAgICByZXR1cm4gcmVnaXN0ZXIobmFtZSwgY2FsbGJhY2spOwogICAgICB9OwoKICAgICAgZnVuY3Rpb24gdGFrZVNuYXBzaG90KHZpZXcsIG9wdGlvbnMpIHsKICAgICAgICBpZiAodHlwZW9mIHZpZXcgIT09ICJudW1iZXIiICYmIHZpZXcgIT09ICJ3aW5kb3ciKSB7CiAgICAgICAgICB2aWV3ID0gZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIodmlldykgfHwgIndpbmRvdyI7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gVUlNYW5hZ2VyLl9fdGFrZVNuYXBzaG90KHZpZXcsIG9wdGlvbnMpOwogICAgICB9CgogICAgICBpbmplY3Rpb24kMi5pbmplY3RGaWJlckJhdGNoZWRVcGRhdGVzKE5hdGl2ZVJlbmRlcmVyLmJhdGNoZWRVcGRhdGVzKTsKICAgICAgdmFyIHJvb3RzID0gbmV3IE1hcCgpOwogICAgICBpbmplY3Rpb24kNC5pbmplY3REaWFsb2coc2hvd0RpYWxvZyQxKTsKICAgICAgdmFyIFJlYWN0TmF0aXZlUmVuZGVyZXIgPSB7CiAgICAgICAgTmF0aXZlQ29tcG9uZW50OiBSZWFjdE5hdGl2ZUNvbXBvbmVudCwKICAgICAgICBmaW5kTm9kZUhhbmRsZTogZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIsCiAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoZWxlbWVudCwgY29udGFpbmVyVGFnLCBjYWxsYmFjaykgewogICAgICAgICAgdmFyIHJvb3QgPSByb290cy5nZXQoY29udGFpbmVyVGFnKTsKCiAgICAgICAgICBpZiAoIXJvb3QpIHsKICAgICAgICAgICAgcm9vdCA9IE5hdGl2ZVJlbmRlcmVyLmNyZWF0ZUNvbnRhaW5lcihjb250YWluZXJUYWcsIGZhbHNlKTsKICAgICAgICAgICAgcm9vdHMuc2V0KGNvbnRhaW5lclRhZywgcm9vdCk7CiAgICAgICAgICB9CgogICAgICAgICAgTmF0aXZlUmVuZGVyZXIudXBkYXRlQ29udGFpbmVyKGVsZW1lbnQsIHJvb3QsIG51bGwsIGNhbGxiYWNrKTsKICAgICAgICAgIHJldHVybiBOYXRpdmVSZW5kZXJlci5nZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdCk7CiAgICAgICAgfSwKICAgICAgICB1bm1vdW50Q29tcG9uZW50QXROb2RlOiBmdW5jdGlvbiB1bm1vdW50Q29tcG9uZW50QXROb2RlKGNvbnRhaW5lclRhZykgewogICAgICAgICAgdmFyIHJvb3QgPSByb290cy5nZXQoY29udGFpbmVyVGFnKTsKCiAgICAgICAgICBpZiAocm9vdCkgewogICAgICAgICAgICBOYXRpdmVSZW5kZXJlci51cGRhdGVDb250YWluZXIobnVsbCwgcm9vdCwgbnVsbCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJvb3RzWyJkZWxldGUiXShjb250YWluZXJUYWcpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHVubW91bnRDb21wb25lbnRBdE5vZGVBbmRSZW1vdmVDb250YWluZXI6IGZ1bmN0aW9uIHVubW91bnRDb21wb25lbnRBdE5vZGVBbmRSZW1vdmVDb250YWluZXIoY29udGFpbmVyVGFnKSB7CiAgICAgICAgICBSZWFjdE5hdGl2ZVJlbmRlcmVyLnVubW91bnRDb21wb25lbnRBdE5vZGUoY29udGFpbmVyVGFnKTsKICAgICAgICAgIFVJTWFuYWdlci5yZW1vdmVSb290Vmlldyhjb250YWluZXJUYWcpOwogICAgICAgIH0sCiAgICAgICAgY3JlYXRlUG9ydGFsOiBmdW5jdGlvbiBjcmVhdGVQb3J0YWwoY2hpbGRyZW4sIGNvbnRhaW5lclRhZykgewogICAgICAgICAgdmFyIGtleSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogbnVsbDsKICAgICAgICAgIHJldHVybiBfY3JlYXRlUG9ydGFsKGNoaWxkcmVuLCBjb250YWluZXJUYWcsIG51bGwsIGtleSk7CiAgICAgICAgfSwKICAgICAgICB1bnN0YWJsZV9iYXRjaGVkVXBkYXRlczogYmF0Y2hlZFVwZGF0ZXMsCiAgICAgICAgZmx1c2hTeW5jOiBOYXRpdmVSZW5kZXJlci5mbHVzaFN5bmMsCiAgICAgICAgX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ6IHsKICAgICAgICAgIE5hdGl2ZU1ldGhvZHNNaXhpbjogTmF0aXZlTWV0aG9kc01peGluLAogICAgICAgICAgUmVhY3ROYXRpdmVCcmlkZ2VFdmVudFBsdWdpbjogUmVhY3ROYXRpdmVCcmlkZ2VFdmVudFBsdWdpbiwKICAgICAgICAgIFJlYWN0R2xvYmFsU2hhcmVkU3RhdGU6IFJlYWN0R2xvYmFsU2hhcmVkU3RhdGUsCiAgICAgICAgICBSZWFjdE5hdGl2ZUNvbXBvbmVudFRyZWU6IFJlYWN0TmF0aXZlQ29tcG9uZW50VHJlZSwKICAgICAgICAgIFJlYWN0TmF0aXZlUHJvcFJlZ2lzdHJ5OiBSZWFjdE5hdGl2ZVByb3BSZWdpc3RyeSwKICAgICAgICAgIFRvdWNoSGlzdG9yeU1hdGg6IFRvdWNoSGlzdG9yeU1hdGgsCiAgICAgICAgICBjcmVhdGVSZWFjdE5hdGl2ZUNvbXBvbmVudENsYXNzOiBjcmVhdGVSZWFjdE5hdGl2ZUNvbXBvbmVudENsYXNzLAogICAgICAgICAgdGFrZVNuYXBzaG90OiB0YWtlU25hcHNob3QKICAgICAgICB9CiAgICAgIH07CiAgICAgIHsKICAgICAgICBiYWJlbEhlbHBlcnMuZXh0ZW5kcyhSZWFjdE5hdGl2ZVJlbmRlcmVyLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVELCB7CiAgICAgICAgICBSZWFjdERlYnVnVG9vbDogewogICAgICAgICAgICBhZGRIb29rOiBmdW5jdGlvbiBhZGRIb29rKCkge30sCiAgICAgICAgICAgIHJlbW92ZUhvb2s6IGZ1bmN0aW9uIHJlbW92ZUhvb2soKSB7fQogICAgICAgICAgfSwKICAgICAgICAgIFJlYWN0UGVyZjogewogICAgICAgICAgICBzdGFydDogZnVuY3Rpb24gc3RhcnQoKSB7fSwKICAgICAgICAgICAgc3RvcDogZnVuY3Rpb24gc3RvcCgpIHt9LAogICAgICAgICAgICBwcmludEluY2x1c2l2ZTogZnVuY3Rpb24gcHJpbnRJbmNsdXNpdmUoKSB7fSwKICAgICAgICAgICAgcHJpbnRXYXN0ZWQ6IGZ1bmN0aW9uIHByaW50V2FzdGVkKCkge30KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICBOYXRpdmVSZW5kZXJlci5pbmplY3RJbnRvRGV2VG9vbHMoewogICAgICAgIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlOiBnZXRJbnN0YW5jZUZyb21UYWcsCiAgICAgICAgZ2V0SW5zcGVjdG9yRGF0YUZvclZpZXdUYWc6IGdldEluc3BlY3RvckRhdGFGb3JWaWV3VGFnLAogICAgICAgIGJ1bmRsZVR5cGU6IDEsCiAgICAgICAgdmVyc2lvbjogUmVhY3RWZXJzaW9uLAogICAgICAgIHJlbmRlcmVyUGFja2FnZU5hbWU6ICJyZWFjdC1uYXRpdmUtcmVuZGVyZXIiCiAgICAgIH0pOwogICAgICB2YXIgUmVhY3ROYXRpdmVSZW5kZXJlciQyID0gT2JqZWN0LmZyZWV6ZSh7CiAgICAgICAgZGVmYXVsdDogUmVhY3ROYXRpdmVSZW5kZXJlcgogICAgICB9KTsKICAgICAgdmFyIFJlYWN0TmF0aXZlUmVuZGVyZXIkMyA9IFJlYWN0TmF0aXZlUmVuZGVyZXIkMiAmJiBSZWFjdE5hdGl2ZVJlbmRlcmVyIHx8IFJlYWN0TmF0aXZlUmVuZGVyZXIkMjsKICAgICAgdmFyIHJlYWN0TmF0aXZlUmVuZGVyZXIgPSBSZWFjdE5hdGl2ZVJlbmRlcmVyJDNbImRlZmF1bHQiXSA/IFJlYWN0TmF0aXZlUmVuZGVyZXIkM1siZGVmYXVsdCJdIDogUmVhY3ROYXRpdmVSZW5kZXJlciQzOwogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlYWN0TmF0aXZlUmVuZGVyZXI7CiAgICB9KSgpOwogIH0KfSwyMixbMjMsMTMsNTYsNTcsMTA2LDEwNywxMDgsMzEsMTE1LDExNiwxMDEsMTExLDExMywxMTcsMTE4LDExOV0sIlJlYWN0TmF0aXZlUmVuZGVyZXItZGV2Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBpZiAoZ2xvYmFsLkdMT0JBTCA9PT0gdW5kZWZpbmVkKSB7CiAgICBnbG9iYWwuR0xPQkFMID0gZ2xvYmFsOwogIH0KCiAgaWYgKGdsb2JhbC53aW5kb3cgPT09IHVuZGVmaW5lZCkgewogICAgZ2xvYmFsLndpbmRvdyA9IGdsb2JhbDsKICB9CgogIHZhciBkZWZpbmVMYXp5T2JqZWN0UHJvcGVydHkgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiZGVmaW5lTGF6eU9iamVjdFByb3BlcnR5Iik7CgogIHZhciBfc2hvdWxkUG9seWZpbGxDb2xsZWN0aW9uID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIl9zaG91bGRQb2x5ZmlsbEVTNkNvbGxlY3Rpb24iKTsKCiAgaWYgKF9zaG91bGRQb2x5ZmlsbENvbGxlY3Rpb24oJ01hcCcpKSB7CiAgICBwb2x5ZmlsbEdsb2JhbCgnTWFwJywgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIk1hcCIpOwogICAgfSk7CiAgfQoKICBpZiAoX3Nob3VsZFBvbHlmaWxsQ29sbGVjdGlvbignU2V0JykpIHsKICAgIHBvbHlmaWxsR2xvYmFsKCdTZXQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiU2V0Iik7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGRlZmluZUxhenlQcm9wZXJ0eShvYmplY3QsIG5hbWUsIGdldFZhbHVlKSB7CiAgICB2YXIgZGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBuYW1lKTsKCiAgICBpZiAoX19ERVZfXyAmJiBkZXNjcmlwdG9yKSB7CiAgICAgIHZhciBiYWNrdXBOYW1lID0gIm9yaWdpbmFsIiArIG5hbWVbMF0udG9VcHBlckNhc2UoKSArIG5hbWUuc3Vic3RyKDEpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqZWN0LCBiYWNrdXBOYW1lLCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgZGVzY3JpcHRvciwgewogICAgICAgIHZhbHVlOiBvYmplY3RbbmFtZV0KICAgICAgfSkpOwogICAgfQoKICAgIHZhciBfcmVmID0gZGVzY3JpcHRvciB8fCB7fSwKICAgICAgICBlbnVtZXJhYmxlID0gX3JlZi5lbnVtZXJhYmxlLAogICAgICAgIHdyaXRhYmxlID0gX3JlZi53cml0YWJsZSwKICAgICAgICBjb25maWd1cmFibGUgPSBfcmVmLmNvbmZpZ3VyYWJsZTsKCiAgICBpZiAoZGVzY3JpcHRvciAmJiAhY29uZmlndXJhYmxlKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzZXQgcG9seWZpbGwuICcgKyBuYW1lICsgJyBpcyBub3QgY29uZmlndXJhYmxlLicpOwogICAgICByZXR1cm47CiAgICB9CgogICAgZGVmaW5lTGF6eU9iamVjdFByb3BlcnR5KG9iamVjdCwgbmFtZSwgewogICAgICBnZXQ6IGdldFZhbHVlLAogICAgICBlbnVtZXJhYmxlOiBlbnVtZXJhYmxlICE9PSBmYWxzZSwKICAgICAgd3JpdGFibGU6IHdyaXRhYmxlICE9PSBmYWxzZQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBwb2x5ZmlsbEdsb2JhbChuYW1lLCBnZXRWYWx1ZSkgewogICAgZGVmaW5lTGF6eVByb3BlcnR5KGdsb2JhbCwgbmFtZSwgZ2V0VmFsdWUpOwogIH0KCiAgZ2xvYmFsLnByb2Nlc3MgPSBnbG9iYWwucHJvY2VzcyB8fCB7fTsKICBnbG9iYWwucHJvY2Vzcy5lbnYgPSBnbG9iYWwucHJvY2Vzcy5lbnYgfHwge307CgogIGlmICghZ2xvYmFsLnByb2Nlc3MuZW52Lk5PREVfRU5WKSB7CiAgICBnbG9iYWwucHJvY2Vzcy5lbnYuTk9ERV9FTlYgPSBfX0RFVl9fID8gJ2RldmVsb3BtZW50JyA6ICdwcm9kdWN0aW9uJzsKICB9CgogIGlmIChnbG9iYWwuX19SQ1RQcm9maWxlSXNQcm9maWxpbmcpIHsKICAgIHZhciBTeXN0cmFjZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJTeXN0cmFjZSIpOwoKICAgIFN5c3RyYWNlLmluc3RhbGxSZWFjdEhvb2sodHJ1ZSk7CiAgICBTeXN0cmFjZS5zZXRFbmFibGVkKHRydWUpOwogIH0KCiAgdmFyIEV4Y2VwdGlvbnNNYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgIkV4Y2VwdGlvbnNNYW5hZ2VyIik7CgogIEV4Y2VwdGlvbnNNYW5hZ2VyLmluc3RhbGxDb25zb2xlRXJyb3JSZXBvcnRlcigpOwoKICBpZiAoIWdsb2JhbC5fX2ZiRGlzYWJsZUV4Y2VwdGlvbnNNYW5hZ2VyKSB7CiAgICB2YXIgaGFuZGxlRXJyb3IgPSBmdW5jdGlvbiBoYW5kbGVFcnJvcihlLCBpc0ZhdGFsKSB7CiAgICAgIHRyeSB7CiAgICAgICAgRXhjZXB0aW9uc01hbmFnZXIuaGFuZGxlRXhjZXB0aW9uKGUsIGlzRmF0YWwpOwogICAgICB9IGNhdGNoIChlZSkgewogICAgICAgIGNvbnNvbGUubG9nKCdGYWlsZWQgdG8gcHJpbnQgZXJyb3I6ICcsIGVlLm1lc3NhZ2UpOwogICAgICAgIHRocm93IGU7CiAgICAgIH0KICAgIH07CgogICAgdmFyIEVycm9yVXRpbHMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAiRXJyb3JVdGlscyIpOwoKICAgIEVycm9yVXRpbHMuc2V0R2xvYmFsSGFuZGxlcihoYW5kbGVFcnJvcik7CiAgfQoKICB2YXIgUmVhY3ROYXRpdmVWZXJzaW9uQ2hlY2sgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiUmVhY3ROYXRpdmVWZXJzaW9uQ2hlY2siKTsKCiAgUmVhY3ROYXRpdmVWZXJzaW9uQ2hlY2suY2hlY2tWZXJzaW9ucygpOwogIHBvbHlmaWxsR2xvYmFsKCdQcm9taXNlJywgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJQcm9taXNlIik7CiAgfSk7CiAgcG9seWZpbGxHbG9iYWwoJ3JlZ2VuZXJhdG9yUnVudGltZScsIGZ1bmN0aW9uICgpIHsKICAgIGRlbGV0ZSBnbG9iYWwucmVnZW5lcmF0b3JSdW50aW1lOwoKICAgIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOV0sICJyZWdlbmVyYXRvci1ydW50aW1lL3J1bnRpbWUiKTsKCiAgICByZXR1cm4gZ2xvYmFsLnJlZ2VuZXJhdG9yUnVudGltZTsKICB9KTsKCiAgdmFyIGRlZmluZUxhenlUaW1lciA9IGZ1bmN0aW9uIGRlZmluZUxhenlUaW1lcihuYW1lKSB7CiAgICBwb2x5ZmlsbEdsb2JhbChuYW1lLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEwXSwgIkpTVGltZXJzIilbbmFtZV07CiAgICB9KTsKICB9OwoKICBkZWZpbmVMYXp5VGltZXIoJ3NldFRpbWVvdXQnKTsKICBkZWZpbmVMYXp5VGltZXIoJ3NldEludGVydmFsJyk7CiAgZGVmaW5lTGF6eVRpbWVyKCdzZXRJbW1lZGlhdGUnKTsKICBkZWZpbmVMYXp5VGltZXIoJ2NsZWFyVGltZW91dCcpOwogIGRlZmluZUxhenlUaW1lcignY2xlYXJJbnRlcnZhbCcpOwogIGRlZmluZUxhenlUaW1lcignY2xlYXJJbW1lZGlhdGUnKTsKICBkZWZpbmVMYXp5VGltZXIoJ3JlcXVlc3RBbmltYXRpb25GcmFtZScpOwogIGRlZmluZUxhenlUaW1lcignY2FuY2VsQW5pbWF0aW9uRnJhbWUnKTsKICBkZWZpbmVMYXp5VGltZXIoJ3JlcXVlc3RJZGxlQ2FsbGJhY2snKTsKICBkZWZpbmVMYXp5VGltZXIoJ2NhbmNlbElkbGVDYWxsYmFjaycpOwogIHBvbHlmaWxsR2xvYmFsKCdYTUxIdHRwUmVxdWVzdCcsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzExXSwgIlhNTEh0dHBSZXF1ZXN0Iik7CiAgfSk7CiAgcG9seWZpbGxHbG9iYWwoJ0Zvcm1EYXRhJywgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTJdLCAiRm9ybURhdGEiKTsKICB9KTsKICBwb2x5ZmlsbEdsb2JhbCgnZmV0Y2gnLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxM10sICJmZXRjaCIpLmZldGNoOwogIH0pOwogIHBvbHlmaWxsR2xvYmFsKCdIZWFkZXJzJywgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTNdLCAiZmV0Y2giKS5IZWFkZXJzOwogIH0pOwogIHBvbHlmaWxsR2xvYmFsKCdSZXF1ZXN0JywgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTNdLCAiZmV0Y2giKS5SZXF1ZXN0OwogIH0pOwogIHBvbHlmaWxsR2xvYmFsKCdSZXNwb25zZScsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEzXSwgImZldGNoIikuUmVzcG9uc2U7CiAgfSk7CiAgcG9seWZpbGxHbG9iYWwoJ1dlYlNvY2tldCcsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE0XSwgIldlYlNvY2tldCIpOwogIH0pOwogIHBvbHlmaWxsR2xvYmFsKCdCbG9iJywgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTVdLCAiQmxvYiIpOwogIH0pOwogIHBvbHlmaWxsR2xvYmFsKCdVUkwnLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxNl0sICJVUkwiKTsKICB9KTsKCiAgaWYgKCFnbG9iYWwuYWxlcnQpIHsKICAgIGdsb2JhbC5hbGVydCA9IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTddLCAiQWxlcnQiKS5hbGVydCgnQWxlcnQnLCAnJyArIHRleHQpOwogICAgfTsKICB9CgogIHZhciBuYXZpZ2F0b3IgPSBnbG9iYWwubmF2aWdhdG9yOwoKICBpZiAobmF2aWdhdG9yID09PSB1bmRlZmluZWQpIHsKICAgIGdsb2JhbC5uYXZpZ2F0b3IgPSBuYXZpZ2F0b3IgPSB7fTsKICB9CgogIGRlZmluZUxhenlQcm9wZXJ0eShuYXZpZ2F0b3IsICdwcm9kdWN0JywgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICdSZWFjdE5hdGl2ZSc7CiAgfSk7CiAgZGVmaW5lTGF6eVByb3BlcnR5KG5hdmlnYXRvciwgJ2dlb2xvY2F0aW9uJywgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMThdLCAiR2VvbG9jYXRpb24iKTsKICB9KTsKCiAgdmFyIEJhdGNoZWRCcmlkZ2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE5XSwgIkJhdGNoZWRCcmlkZ2UiKTsKCiAgQmF0Y2hlZEJyaWRnZS5yZWdpc3RlckxhenlDYWxsYWJsZU1vZHVsZSgnU3lzdHJhY2UnLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlN5c3RyYWNlIik7CiAgfSk7CiAgQmF0Y2hlZEJyaWRnZS5yZWdpc3RlckxhenlDYWxsYWJsZU1vZHVsZSgnSlNUaW1lcnMnLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMF0sICJKU1RpbWVycyIpOwogIH0pOwogIEJhdGNoZWRCcmlkZ2UucmVnaXN0ZXJMYXp5Q2FsbGFibGVNb2R1bGUoJ0hlYXBDYXB0dXJlJywgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMjBdLCAiSGVhcENhcHR1cmUiKTsKICB9KTsKICBCYXRjaGVkQnJpZGdlLnJlZ2lzdGVyTGF6eUNhbGxhYmxlTW9kdWxlKCdTYW1wbGluZ1Byb2ZpbGVyJywgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMjFdLCAiU2FtcGxpbmdQcm9maWxlciIpOwogIH0pOwogIEJhdGNoZWRCcmlkZ2UucmVnaXN0ZXJMYXp5Q2FsbGFibGVNb2R1bGUoJ1JDVExvZycsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzIyXSwgIlJDVExvZyIpOwogIH0pOwogIEJhdGNoZWRCcmlkZ2UucmVnaXN0ZXJMYXp5Q2FsbGFibGVNb2R1bGUoJ1JDVERldmljZUV2ZW50RW1pdHRlcicsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzIzXSwgIlJDVERldmljZUV2ZW50RW1pdHRlciIpOwogIH0pOwogIEJhdGNoZWRCcmlkZ2UucmVnaXN0ZXJMYXp5Q2FsbGFibGVNb2R1bGUoJ1JDVE5hdGl2ZUFwcEV2ZW50RW1pdHRlcicsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzI0XSwgIlJDVE5hdGl2ZUFwcEV2ZW50RW1pdHRlciIpOwogIH0pOwogIEJhdGNoZWRCcmlkZ2UucmVnaXN0ZXJMYXp5Q2FsbGFibGVNb2R1bGUoJ1BlcmZvcm1hbmNlTG9nZ2VyJywgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMjVdLCAiUGVyZm9ybWFuY2VMb2dnZXIiKTsKICB9KTsKCiAgZ2xvYmFsLmZldGNoU2VnbWVudCA9IGZ1bmN0aW9uIChzZWdtZW50SWQsIGNhbGxiYWNrKSB7CiAgICB2YXIgX3JlcXVpcmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzI2XSwgIk5hdGl2ZU1vZHVsZXMiKSwKICAgICAgICBTZWdtZW50RmV0Y2hlciA9IF9yZXF1aXJlLlNlZ21lbnRGZXRjaGVyOwoKICAgIGlmICghU2VnbWVudEZldGNoZXIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdTZWdtZW50RmV0Y2hlciBpcyBtaXNzaW5nLiBQbGVhc2UgZW5zdXJlIHRoYXQgaXQgaXMgJyArICdpbmNsdWRlZCBhcyBhIE5hdGl2ZU1vZHVsZS4nKTsKICAgIH0KCiAgICBTZWdtZW50RmV0Y2hlci5mZXRjaFNlZ21lbnQoc2VnbWVudElkLCBmdW5jdGlvbiAoZXJyb3JPYmplY3QpIHsKICAgICAgaWYgKGVycm9yT2JqZWN0KSB7CiAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKGVycm9yT2JqZWN0Lm1lc3NhZ2UpOwogICAgICAgIGVycm9yLmNvZGUgPSBlcnJvck9iamVjdC5jb2RlOwogICAgICAgIGNhbGxiYWNrKGVycm9yKTsKICAgICAgfQoKICAgICAgY2FsbGJhY2sobnVsbCk7CiAgICB9KTsKICB9OwoKICBpZiAoX19ERVZfXykgewogICAgaWYgKCFnbG9iYWwuX19SQ1RQcm9maWxlSXNQcm9maWxpbmcpIHsKICAgICAgQmF0Y2hlZEJyaWRnZS5yZWdpc3RlckNhbGxhYmxlTW9kdWxlKCdITVJDbGllbnQnLCByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzI3XSwgIkhNUkNsaWVudCIpKTsKCiAgICAgIGlmICghd2luZG93LmRvY3VtZW50KSB7CiAgICAgICAgcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyOF0sICJzZXR1cERldnRvb2xzIik7CiAgICAgIH0KCiAgICAgIHZhciBKU0luc3BlY3RvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMjldLCAiSlNJbnNwZWN0b3IiKTsKCiAgICAgIEpTSW5zcGVjdG9yLnJlZ2lzdGVyQWdlbnQocmVxdWlyZShfZGVwZW5kZW5jeU1hcFszMF0sICJOZXR3b3JrQWdlbnQiKSk7CiAgICB9CiAgfQp9LDIzLFsyNCwyNSwyNiwzMCwxOSwzMSwxOCw0MCw0Miw1MCw1MSw1OCw3NCwzNyw3NSw3Niw4Myw4NCw4NiwxNiw4OSw5MCw5MSw3MCw5Miw5MywxNSw5NSw5OCwxMDMsMTA0XSwiSW5pdGlhbGl6ZUNvcmUiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIGZ1bmN0aW9uIGRlZmluZUxhenlPYmplY3RQcm9wZXJ0eShvYmplY3QsIG5hbWUsIGRlc2NyaXB0b3IpIHsKICAgIHZhciBnZXQgPSBkZXNjcmlwdG9yLmdldDsKICAgIHZhciBlbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlICE9PSBmYWxzZTsKICAgIHZhciB3cml0YWJsZSA9IGRlc2NyaXB0b3Iud3JpdGFibGUgIT09IGZhbHNlOwogICAgdmFyIHZhbHVlID0gdm9pZCAwOwogICAgdmFyIHZhbHVlU2V0ID0gZmFsc2U7CgogICAgZnVuY3Rpb24gZ2V0VmFsdWUoKSB7CiAgICAgIGlmICghdmFsdWVTZXQpIHsKICAgICAgICB2YWx1ZVNldCA9IHRydWU7CiAgICAgICAgc2V0VmFsdWUoZ2V0KCkpOwogICAgICB9CgogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0VmFsdWUobmV3VmFsdWUpIHsKICAgICAgdmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgdmFsdWVTZXQgPSB0cnVlOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqZWN0LCBuYW1lLCB7CiAgICAgICAgdmFsdWU6IG5ld1ZhbHVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBlbnVtZXJhYmxlLAogICAgICAgIHdyaXRhYmxlOiB3cml0YWJsZQogICAgICB9KTsKICAgIH0KCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqZWN0LCBuYW1lLCB7CiAgICAgIGdldDogZ2V0VmFsdWUsCiAgICAgIHNldDogc2V0VmFsdWUsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgZW51bWVyYWJsZTogZW51bWVyYWJsZQogICAgfSk7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGRlZmluZUxhenlPYmplY3RQcm9wZXJ0eTsKfSwyNCxbXSwiZGVmaW5lTGF6eU9iamVjdFByb3BlcnR5Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBfc2hvdWxkQWN0dWFsbHlQb2x5ZmlsbEVTNkNvbGxlY3Rpb24oY29sbGVjdGlvbk5hbWUpIHsKICAgIHZhciBDb2xsZWN0aW9uID0gZ2xvYmFsW2NvbGxlY3Rpb25OYW1lXTsKCiAgICBpZiAoQ29sbGVjdGlvbiA9PSBudWxsKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGlmICh0eXBlb2YgZ2xvYmFsLlN5bWJvbCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICB2YXIgcHJvdG8gPSBDb2xsZWN0aW9uLnByb3RvdHlwZTsKICAgIHJldHVybiBDb2xsZWN0aW9uID09IG51bGwgfHwgdHlwZW9mIENvbGxlY3Rpb24gIT09ICdmdW5jdGlvbicgfHwgdHlwZW9mIHByb3RvLmNsZWFyICE9PSAnZnVuY3Rpb24nIHx8IG5ldyBDb2xsZWN0aW9uKCkuc2l6ZSAhPT0gMCB8fCB0eXBlb2YgcHJvdG8ua2V5cyAhPT0gJ2Z1bmN0aW9uJyB8fCB0eXBlb2YgcHJvdG8uZm9yRWFjaCAhPT0gJ2Z1bmN0aW9uJzsKICB9CgogIHZhciBjYWNoZSA9IHt9OwoKICBmdW5jdGlvbiBfc2hvdWxkUG9seWZpbGxFUzZDb2xsZWN0aW9uKGNvbGxlY3Rpb25OYW1lKSB7CiAgICB2YXIgcmVzdWx0ID0gY2FjaGVbY29sbGVjdGlvbk5hbWVdOwoKICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIHJlc3VsdCA9IF9zaG91bGRBY3R1YWxseVBvbHlmaWxsRVM2Q29sbGVjdGlvbihjb2xsZWN0aW9uTmFtZSk7CiAgICBjYWNoZVtjb2xsZWN0aW9uTmFtZV0gPSByZXN1bHQ7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBfc2hvdWxkUG9seWZpbGxFUzZDb2xsZWN0aW9uOwp9LDI1LFtdLCJfc2hvdWxkUG9seWZpbGxFUzZDb2xsZWN0aW9uIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX3Nob3VsZFBvbHlmaWxsRVM2Q29sbGVjdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJfc2hvdWxkUG9seWZpbGxFUzZDb2xsZWN0aW9uIik7CgogIHZhciBndWlkID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImd1aWQiKTsKCiAgdmFyIGlzTm9kZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJmYmpzL2xpYi9pc05vZGUiKTsKCiAgdmFyIHRvSXRlcmF0b3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAidG9JdGVyYXRvciIpOwoKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChnbG9iYWwsIHVuZGVmaW5lZCkgewogICAgaWYgKCFfc2hvdWxkUG9seWZpbGxFUzZDb2xsZWN0aW9uKCdNYXAnKSkgewogICAgICByZXR1cm4gZ2xvYmFsLk1hcDsKICAgIH0KCiAgICB2YXIgS0lORF9LRVkgPSAna2V5JzsKICAgIHZhciBLSU5EX1ZBTFVFID0gJ3ZhbHVlJzsKICAgIHZhciBLSU5EX0tFWV9WQUxVRSA9ICdrZXkrdmFsdWUnOwogICAgdmFyIEtFWV9QUkVGSVggPSAnJG1hcF8nOwogICAgdmFyIFNFQ1JFVF9TSVpFX1BST1A7CgogICAgaWYgKF9fREVWX18pIHsKICAgICAgU0VDUkVUX1NJWkVfUFJPUCA9ICckc2l6ZScgKyBndWlkKCk7CiAgICB9CgogICAgdmFyIE9MRF9JRV9IQVNIX1BSRUZJWCA9ICdJRV9IQVNIXyc7CgogICAgdmFyIE1hcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gTWFwKGl0ZXJhYmxlKSB7CiAgICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIE1hcCk7CgogICAgICAgIGlmICghaXNPYmplY3QodGhpcykpIHsKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1dyb25nIG1hcCBvYmplY3QgdHlwZS4nKTsKICAgICAgICB9CgogICAgICAgIGluaXRNYXAodGhpcyk7CgogICAgICAgIGlmIChpdGVyYWJsZSAhPSBudWxsKSB7CiAgICAgICAgICB2YXIgaXQgPSB0b0l0ZXJhdG9yKGl0ZXJhYmxlKTsKICAgICAgICAgIHZhciBuZXh0OwoKICAgICAgICAgIHdoaWxlICghKG5leHQgPSBpdC5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgaWYgKCFpc09iamVjdChuZXh0LnZhbHVlKSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0V4cGVjdGVkIGl0ZXJhYmxlIGl0ZW1zIHRvIGJlIHBhaXIgb2JqZWN0cy4nKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zZXQobmV4dC52YWx1ZVswXSwgbmV4dC52YWx1ZVsxXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoTWFwLCBbewogICAgICAgIGtleTogImNsZWFyIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgICAgICBpbml0TWFwKHRoaXMpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogImhhcyIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGhhcyhrZXkpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGdldEluZGV4KHRoaXMsIGtleSk7CiAgICAgICAgICByZXR1cm4gISEoaW5kZXggIT0gbnVsbCAmJiB0aGlzLl9tYXBEYXRhW2luZGV4XSk7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAic2V0IiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0KGtleSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGdldEluZGV4KHRoaXMsIGtleSk7CgogICAgICAgICAgaWYgKGluZGV4ICE9IG51bGwgJiYgdGhpcy5fbWFwRGF0YVtpbmRleF0pIHsKICAgICAgICAgICAgdGhpcy5fbWFwRGF0YVtpbmRleF1bMV0gPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluZGV4ID0gdGhpcy5fbWFwRGF0YS5wdXNoKFtrZXksIHZhbHVlXSkgLSAxOwogICAgICAgICAgICBzZXRJbmRleCh0aGlzLCBrZXksIGluZGV4KTsKCiAgICAgICAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgICAgICAgdGhpc1tTRUNSRVRfU0laRV9QUk9QXSArPSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuc2l6ZSArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAiZ2V0IiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgdmFyIGluZGV4ID0gZ2V0SW5kZXgodGhpcywga2V5KTsKCiAgICAgICAgICBpZiAoaW5kZXggPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21hcERhdGFbaW5kZXhdWzFdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogImRlbGV0ZSIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9kZWxldGUoa2V5KSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBnZXRJbmRleCh0aGlzLCBrZXkpOwoKICAgICAgICAgIGlmIChpbmRleCAhPSBudWxsICYmIHRoaXMuX21hcERhdGFbaW5kZXhdKSB7CiAgICAgICAgICAgIHNldEluZGV4KHRoaXMsIGtleSwgdW5kZWZpbmVkKTsKICAgICAgICAgICAgdGhpcy5fbWFwRGF0YVtpbmRleF0gPSB1bmRlZmluZWQ7CgogICAgICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgICAgIHRoaXNbU0VDUkVUX1NJWkVfUFJPUF0gLT0gMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLnNpemUgLT0gMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAiZW50cmllcyIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGVudHJpZXMoKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hcEl0ZXJhdG9yKHRoaXMsIEtJTkRfS0VZX1ZBTFVFKTsKICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBrZXk6ICJrZXlzIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24ga2V5cygpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWFwSXRlcmF0b3IodGhpcywgS0lORF9LRVkpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogInZhbHVlcyIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlcygpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWFwSXRlcmF0b3IodGhpcywgS0lORF9WQUxVRSk7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAiZm9yRWFjaCIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGZvckVhY2goY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2FsbGJhY2sgbXVzdCBiZSBjYWxsYWJsZS4nKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgYm91bmRDYWxsYmFjayA9IGNhbGxiYWNrLmJpbmQodGhpc0FyZyB8fCB1bmRlZmluZWQpOwogICAgICAgICAgdmFyIG1hcERhdGEgPSB0aGlzLl9tYXBEYXRhOwoKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWFwRGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgZW50cnkgPSBtYXBEYXRhW2ldOwoKICAgICAgICAgICAgaWYgKGVudHJ5ICE9IG51bGwpIHsKICAgICAgICAgICAgICBib3VuZENhbGxiYWNrKGVudHJ5WzFdLCBlbnRyeVswXSwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH1dKTsKICAgICAgcmV0dXJuIE1hcDsKICAgIH0oKTsKCiAgICBNYXAucHJvdG90eXBlW3RvSXRlcmF0b3IuSVRFUkFUT1JfU1lNQk9MXSA9IE1hcC5wcm90b3R5cGUuZW50cmllczsKCiAgICB2YXIgTWFwSXRlcmF0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGZ1bmN0aW9uIE1hcEl0ZXJhdG9yKG1hcCwga2luZCkgewogICAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBNYXBJdGVyYXRvcik7CgogICAgICAgIGlmICghKGlzT2JqZWN0KG1hcCkgJiYgbWFwLl9tYXBEYXRhKSkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignT2JqZWN0IGlzIG5vdCBhIG1hcC4nKTsKICAgICAgICB9CgogICAgICAgIGlmIChbS0lORF9LRVksIEtJTkRfS0VZX1ZBTFVFLCBLSU5EX1ZBTFVFXS5pbmRleE9mKGtpbmQpID09PSAtMSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGl0ZXJhdGlvbiBraW5kLicpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fbWFwID0gbWFwOwogICAgICAgIHRoaXMuX25leHRJbmRleCA9IDA7CiAgICAgICAgdGhpcy5fa2luZCA9IGtpbmQ7CiAgICAgIH0KCiAgICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhNYXBJdGVyYXRvciwgW3sKICAgICAgICBrZXk6ICJuZXh0IiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICAgIGlmICghdGhpcyBpbnN0YW5jZW9mIE1hcCkgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdFeHBlY3RlZCB0byBiZSBjYWxsZWQgb24gYSBNYXBJdGVyYXRvci4nKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgbWFwID0gdGhpcy5fbWFwOwogICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5fbmV4dEluZGV4OwogICAgICAgICAgdmFyIGtpbmQgPSB0aGlzLl9raW5kOwoKICAgICAgICAgIGlmIChtYXAgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gY3JlYXRlSXRlclJlc3VsdE9iamVjdCh1bmRlZmluZWQsIHRydWUpOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBlbnRyaWVzID0gbWFwLl9tYXBEYXRhOwoKICAgICAgICAgIHdoaWxlIChpbmRleCA8IGVudHJpZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciByZWNvcmQgPSBlbnRyaWVzW2luZGV4XTsKICAgICAgICAgICAgaW5kZXggKz0gMTsKICAgICAgICAgICAgdGhpcy5fbmV4dEluZGV4ID0gaW5kZXg7CgogICAgICAgICAgICBpZiAocmVjb3JkKSB7CiAgICAgICAgICAgICAgaWYgKGtpbmQgPT09IEtJTkRfS0VZKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlSXRlclJlc3VsdE9iamVjdChyZWNvcmRbMF0sIGZhbHNlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtpbmQgPT09IEtJTkRfVkFMVUUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVJdGVyUmVzdWx0T2JqZWN0KHJlY29yZFsxXSwgZmFsc2UpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2luZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUl0ZXJSZXN1bHRPYmplY3QocmVjb3JkLCBmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5fbWFwID0gdW5kZWZpbmVkOwogICAgICAgICAgcmV0dXJuIGNyZWF0ZUl0ZXJSZXN1bHRPYmplY3QodW5kZWZpbmVkLCB0cnVlKTsKICAgICAgICB9CiAgICAgIH1dKTsKICAgICAgcmV0dXJuIE1hcEl0ZXJhdG9yOwogICAgfSgpOwoKICAgIE1hcEl0ZXJhdG9yLnByb3RvdHlwZVt0b0l0ZXJhdG9yLklURVJBVE9SX1NZTUJPTF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICBmdW5jdGlvbiBnZXRJbmRleChtYXAsIGtleSkgewogICAgICBpZiAoaXNPYmplY3Qoa2V5KSkgewogICAgICAgIHZhciBoYXNoID0gZ2V0SGFzaChrZXkpOwogICAgICAgIHJldHVybiBtYXAuX29iamVjdEluZGV4W2hhc2hdOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBwcmVmaXhlZEtleSA9IEtFWV9QUkVGSVggKyBrZXk7CgogICAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIG1hcC5fc3RyaW5nSW5kZXhbcHJlZml4ZWRLZXldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbWFwLl9vdGhlckluZGV4W3ByZWZpeGVkS2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzZXRJbmRleChtYXAsIGtleSwgaW5kZXgpIHsKICAgICAgdmFyIHNob3VsZERlbGV0ZSA9IGluZGV4ID09IG51bGw7CgogICAgICBpZiAoaXNPYmplY3Qoa2V5KSkgewogICAgICAgIHZhciBoYXNoID0gZ2V0SGFzaChrZXkpOwoKICAgICAgICBpZiAoc2hvdWxkRGVsZXRlKSB7CiAgICAgICAgICBkZWxldGUgbWFwLl9vYmplY3RJbmRleFtoYXNoXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWFwLl9vYmplY3RJbmRleFtoYXNoXSA9IGluZGV4OwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcHJlZml4ZWRLZXkgPSBLRVlfUFJFRklYICsga2V5OwoKICAgICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGlmIChzaG91bGREZWxldGUpIHsKICAgICAgICAgICAgZGVsZXRlIG1hcC5fc3RyaW5nSW5kZXhbcHJlZml4ZWRLZXldOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWFwLl9zdHJpbmdJbmRleFtwcmVmaXhlZEtleV0gPSBpbmRleDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHNob3VsZERlbGV0ZSkgewogICAgICAgICAgICBkZWxldGUgbWFwLl9vdGhlckluZGV4W3ByZWZpeGVkS2V5XTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1hcC5fb3RoZXJJbmRleFtwcmVmaXhlZEtleV0gPSBpbmRleDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpbml0TWFwKG1hcCkgewogICAgICBtYXAuX21hcERhdGEgPSBbXTsKICAgICAgbWFwLl9vYmplY3RJbmRleCA9IHt9OwogICAgICBtYXAuX3N0cmluZ0luZGV4ID0ge307CiAgICAgIG1hcC5fb3RoZXJJbmRleCA9IHt9OwoKICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICBpZiAoaXNFUzUpIHsKICAgICAgICAgIGlmIChtYXAuaGFzT3duUHJvcGVydHkoU0VDUkVUX1NJWkVfUFJPUCkpIHsKICAgICAgICAgICAgbWFwW1NFQ1JFVF9TSVpFX1BST1BdID0gMDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShtYXAsIFNFQ1JFVF9TSVpFX1BST1AsIHsKICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG1hcCwgJ3NpemUnLCB7CiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodikgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignUExFQVNFIEZJWCBNRTogWW91IGFyZSBjaGFuZ2luZyB0aGUgbWFwIHNpemUgcHJvcGVydHkgd2hpY2ggJyArICdzaG91bGQgbm90IGJlIHdyaXRhYmxlIGFuZCB3aWxsIGJyZWFrIGluIHByb2R1Y3Rpb24uJyk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtYXAgc2l6ZSBwcm9wZXJ0eSBpcyBub3Qgd3JpdGFibGUuJyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYXBbU0VDUkVUX1NJWkVfUFJPUF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CgogICAgICBtYXAuc2l6ZSA9IDA7CiAgICB9CgogICAgZnVuY3Rpb24gaXNPYmplY3QobykgewogICAgICByZXR1cm4gbyAhPSBudWxsICYmICh0eXBlb2YgbyA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIG8gPT09ICdmdW5jdGlvbicpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUl0ZXJSZXN1bHRPYmplY3QodmFsdWUsIGRvbmUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgZG9uZTogZG9uZQogICAgICB9OwogICAgfQoKICAgIHZhciBpc0VTNSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdHJ5IHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoe30sICd4Jywge30pOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9KCk7CgogICAgZnVuY3Rpb24gaXNFeHRlbnNpYmxlKG8pIHsKICAgICAgaWYgKCFpc0VTNSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBPYmplY3QuaXNFeHRlbnNpYmxlKG8pOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0SUVOb2RlSGFzaChub2RlKSB7CiAgICAgIHZhciB1bmlxdWVJRDsKCiAgICAgIHN3aXRjaCAobm9kZS5ub2RlVHlwZSkgewogICAgICAgIGNhc2UgMToKICAgICAgICAgIHVuaXF1ZUlEID0gbm9kZS51bmlxdWVJRDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIDk6CiAgICAgICAgICB1bmlxdWVJRCA9IG5vZGUuZG9jdW1lbnRFbGVtZW50LnVuaXF1ZUlEOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgaWYgKHVuaXF1ZUlEKSB7CiAgICAgICAgcmV0dXJuIE9MRF9JRV9IQVNIX1BSRUZJWCArIHVuaXF1ZUlEOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9CgogICAgdmFyIGdldEhhc2ggPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBwcm9wSXNFbnVtZXJhYmxlID0gT2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZTsKICAgICAgdmFyIGhhc2hQcm9wZXJ0eSA9IGd1aWQoKTsKICAgICAgdmFyIGhhc2hDb3VudGVyID0gMDsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGdldEhhc2gobykgewogICAgICAgIGlmIChvW2hhc2hQcm9wZXJ0eV0pIHsKICAgICAgICAgIHJldHVybiBvW2hhc2hQcm9wZXJ0eV07CiAgICAgICAgfSBlbHNlIGlmICghaXNFUzUgJiYgby5wcm9wZXJ0eUlzRW51bWVyYWJsZSAmJiBvLnByb3BlcnR5SXNFbnVtZXJhYmxlW2hhc2hQcm9wZXJ0eV0pIHsKICAgICAgICAgIHJldHVybiBvLnByb3BlcnR5SXNFbnVtZXJhYmxlW2hhc2hQcm9wZXJ0eV07CiAgICAgICAgfSBlbHNlIGlmICghaXNFUzUgJiYgaXNOb2RlKG8pICYmIGdldElFTm9kZUhhc2gobykpIHsKICAgICAgICAgIHJldHVybiBnZXRJRU5vZGVIYXNoKG8pOwogICAgICAgIH0gZWxzZSBpZiAoIWlzRVM1ICYmIG9baGFzaFByb3BlcnR5XSkgewogICAgICAgICAgcmV0dXJuIG9baGFzaFByb3BlcnR5XTsKICAgICAgICB9CgogICAgICAgIGlmIChpc0V4dGVuc2libGUobykpIHsKICAgICAgICAgIGhhc2hDb3VudGVyICs9IDE7CgogICAgICAgICAgaWYgKGlzRVM1KSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCBoYXNoUHJvcGVydHksIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogaGFzaENvdW50ZXIKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgaWYgKG8ucHJvcGVydHlJc0VudW1lcmFibGUpIHsKICAgICAgICAgICAgby5wcm9wZXJ0eUlzRW51bWVyYWJsZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJvcElzRW51bWVyYWJsZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgby5wcm9wZXJ0eUlzRW51bWVyYWJsZVtoYXNoUHJvcGVydHldID0gaGFzaENvdW50ZXI7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzTm9kZShvKSkgewogICAgICAgICAgICBvW2hhc2hQcm9wZXJ0eV0gPSBoYXNoQ291bnRlcjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5hYmxlIHRvIHNldCBhIG5vbi1lbnVtZXJhYmxlIHByb3BlcnR5IG9uIG9iamVjdC4nKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gaGFzaENvdW50ZXI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm9uLWV4dGVuc2libGUgb2JqZWN0cyBhcmUgbm90IGFsbG93ZWQgYXMga2V5cy4nKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KCk7CgogICAgcmV0dXJuIE1hcDsKICB9KEZ1bmN0aW9uKCdyZXR1cm4gdGhpcycpKCkpOwp9LDI2LFsyNSwyNywyOCwyOV0sIk1hcCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZnVuY3Rpb24gZ3VpZCgpIHsKICAgIHJldHVybiAnZicgKyAoTWF0aC5yYW5kb20oKSAqICgxIDw8IDMwKSkudG9TdHJpbmcoMTYpLnJlcGxhY2UoJy4nLCAnJyk7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGd1aWQ7Cn0sMjcsW10sImd1aWQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIGZ1bmN0aW9uIGlzTm9kZShvYmplY3QpIHsKICAgIHZhciBkb2MgPSBvYmplY3QgPyBvYmplY3Qub3duZXJEb2N1bWVudCB8fCBvYmplY3QgOiBkb2N1bWVudDsKICAgIHZhciBkZWZhdWx0VmlldyA9IGRvYy5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICByZXR1cm4gISEob2JqZWN0ICYmICh0eXBlb2YgZGVmYXVsdFZpZXcuTm9kZSA9PT0gJ2Z1bmN0aW9uJyA/IG9iamVjdCBpbnN0YW5jZW9mIGRlZmF1bHRWaWV3Lk5vZGUgOiB0eXBlb2Ygb2JqZWN0ID09PSAnb2JqZWN0JyAmJiB0eXBlb2Ygb2JqZWN0Lm5vZGVUeXBlID09PSAnbnVtYmVyJyAmJiB0eXBlb2Ygb2JqZWN0Lm5vZGVOYW1lID09PSAnc3RyaW5nJykpOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBpc05vZGU7Cn0sMjgsW10sImZianMvbGliL2lzTm9kZS5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEtJTkRfS0VZID0gJ2tleSc7CiAgdmFyIEtJTkRfVkFMVUUgPSAndmFsdWUnOwogIHZhciBLSU5EX0tFWV9WQUwgPSAna2V5K3ZhbHVlJzsKICB2YXIgSVRFUkFUT1JfU1lNQk9MID0gdHlwZW9mIFN5bWJvbCA9PT0gJ2Z1bmN0aW9uJyA/IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciIgOiAnQEBpdGVyYXRvcic7CgogIHZhciB0b0l0ZXJhdG9yID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCEoQXJyYXkucHJvdG90eXBlW0lURVJBVE9SX1NZTUJPTF0gJiYgU3RyaW5nLnByb3RvdHlwZVtJVEVSQVRPUl9TWU1CT0xdKSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBBcnJheUl0ZXJhdG9yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgZnVuY3Rpb24gQXJyYXlJdGVyYXRvcihhcnJheSwga2luZCkgewogICAgICAgICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQXJyYXlJdGVyYXRvcik7CgogICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoYXJyYXkpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignT2JqZWN0IGlzIG5vdCBhbiBBcnJheScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9pdGVyYXRlZE9iamVjdCA9IGFycmF5OwogICAgICAgICAgICB0aGlzLl9raW5kID0ga2luZDsKICAgICAgICAgICAgdGhpcy5fbmV4dEluZGV4ID0gMDsKICAgICAgICAgIH0KCiAgICAgICAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQXJyYXlJdGVyYXRvciwgW3sKICAgICAgICAgICAga2V5OiAibmV4dCIsCiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBuZXh0KCkgewogICAgICAgICAgICAgIGlmICghdGhpcyBpbnN0YW5jZW9mIEFycmF5SXRlcmF0b3IpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ09iamVjdCBpcyBub3QgYW4gQXJyYXlJdGVyYXRvcicpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKHRoaXMuX2l0ZXJhdGVkT2JqZWN0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVJdGVyUmVzdWx0T2JqZWN0KHVuZGVmaW5lZCwgdHJ1ZSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2YXIgYXJyYXkgPSB0aGlzLl9pdGVyYXRlZE9iamVjdDsKICAgICAgICAgICAgICB2YXIgbGVuID0gdGhpcy5faXRlcmF0ZWRPYmplY3QubGVuZ3RoOwogICAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuX25leHRJbmRleDsKICAgICAgICAgICAgICB2YXIga2luZCA9IHRoaXMuX2tpbmQ7CgogICAgICAgICAgICAgIGlmIChpbmRleCA+PSBsZW4pIHsKICAgICAgICAgICAgICAgIHRoaXMuX2l0ZXJhdGVkT2JqZWN0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUl0ZXJSZXN1bHRPYmplY3QodW5kZWZpbmVkLCB0cnVlKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHRoaXMuX25leHRJbmRleCA9IGluZGV4ICsgMTsKCiAgICAgICAgICAgICAgaWYgKGtpbmQgPT09IEtJTkRfS0VZKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlSXRlclJlc3VsdE9iamVjdChpbmRleCwgZmFsc2UpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2luZCA9PT0gS0lORF9WQUxVRSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUl0ZXJSZXN1bHRPYmplY3QoYXJyYXlbaW5kZXhdLCBmYWxzZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChraW5kID09PSBLSU5EX0tFWV9WQUwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVJdGVyUmVzdWx0T2JqZWN0KFtpbmRleCwgYXJyYXlbaW5kZXhdXSwgZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwgewogICAgICAgICAgICBrZXk6ICdAQGl0ZXJhdG9yJywKICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGl0ZXJhdG9yKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICB9XSk7CiAgICAgICAgICByZXR1cm4gQXJyYXlJdGVyYXRvcjsKICAgICAgICB9KCk7CgogICAgICAgIHZhciBTdHJpbmdJdGVyYXRvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGZ1bmN0aW9uIFN0cmluZ0l0ZXJhdG9yKHN0cmluZykgewogICAgICAgICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgU3RyaW5nSXRlcmF0b3IpOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignT2JqZWN0IGlzIG5vdCBhIHN0cmluZycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9pdGVyYXRlZFN0cmluZyA9IHN0cmluZzsKICAgICAgICAgICAgdGhpcy5fbmV4dEluZGV4ID0gMDsKICAgICAgICAgIH0KCiAgICAgICAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoU3RyaW5nSXRlcmF0b3IsIFt7CiAgICAgICAgICAgIGtleTogIm5leHQiLAogICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICAgICAgICBpZiAoIXRoaXMgaW5zdGFuY2VvZiBTdHJpbmdJdGVyYXRvcikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignT2JqZWN0IGlzIG5vdCBhIFN0cmluZ0l0ZXJhdG9yJyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAodGhpcy5faXRlcmF0ZWRTdHJpbmcgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUl0ZXJSZXN1bHRPYmplY3QodW5kZWZpbmVkLCB0cnVlKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuX25leHRJbmRleDsKICAgICAgICAgICAgICB2YXIgcyA9IHRoaXMuX2l0ZXJhdGVkU3RyaW5nOwogICAgICAgICAgICAgIHZhciBsZW4gPSBzLmxlbmd0aDsKCiAgICAgICAgICAgICAgaWYgKGluZGV4ID49IGxlbikgewogICAgICAgICAgICAgICAgdGhpcy5faXRlcmF0ZWRTdHJpbmcgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlSXRlclJlc3VsdE9iamVjdCh1bmRlZmluZWQsIHRydWUpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgdmFyIHJldDsKICAgICAgICAgICAgICB2YXIgZmlyc3QgPSBzLmNoYXJDb2RlQXQoaW5kZXgpOwoKICAgICAgICAgICAgICBpZiAoZmlyc3QgPCAweEQ4MDAgfHwgZmlyc3QgPiAweERCRkYgfHwgaW5kZXggKyAxID09PSBsZW4pIHsKICAgICAgICAgICAgICAgIHJldCA9IHNbaW5kZXhdOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgc2Vjb25kID0gcy5jaGFyQ29kZUF0KGluZGV4ICsgMSk7CgogICAgICAgICAgICAgICAgaWYgKHNlY29uZCA8IDB4REMwMCB8fCBzZWNvbmQgPiAweERGRkYpIHsKICAgICAgICAgICAgICAgICAgcmV0ID0gc1tpbmRleF07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXQgPSBzW2luZGV4XSArIHNbaW5kZXggKyAxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHRoaXMuX25leHRJbmRleCA9IGluZGV4ICsgcmV0Lmxlbmd0aDsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlSXRlclJlc3VsdE9iamVjdChyZXQsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgewogICAgICAgICAgICBrZXk6ICdAQGl0ZXJhdG9yJywKICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGl0ZXJhdG9yKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICB9XSk7CiAgICAgICAgICByZXR1cm4gU3RyaW5nSXRlcmF0b3I7CiAgICAgICAgfSgpOwoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVJdGVyUmVzdWx0T2JqZWN0KHZhbHVlLCBkb25lKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgIGRvbmU6IGRvbmUKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG9iamVjdCwga2luZCkgewogICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgU3RyaW5nSXRlcmF0b3Iob2JqZWN0KTsKICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShvYmplY3QpKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQXJyYXlJdGVyYXRvcihvYmplY3QsIGtpbmQgfHwgS0lORF9WQUxVRSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gb2JqZWN0W0lURVJBVE9SX1NZTUJPTF0oKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9KCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZnVuY3Rpb24gKG9iamVjdCkgewogICAgICAgIHJldHVybiBvYmplY3RbSVRFUkFUT1JfU1lNQk9MXSgpOwogICAgICB9OwogICAgfQogIH0oKTsKCiAgYmFiZWxIZWxwZXJzLmV4dGVuZHModG9JdGVyYXRvciwgewogICAgS0lORF9LRVk6IEtJTkRfS0VZLAogICAgS0lORF9WQUxVRTogS0lORF9WQUxVRSwKICAgIEtJTkRfS0VZX1ZBTDogS0lORF9LRVlfVkFMLAogICAgSVRFUkFUT1JfU1lNQk9MOiBJVEVSQVRPUl9TWU1CT0wKICB9KTsKICBtb2R1bGUuZXhwb3J0cyA9IHRvSXRlcmF0b3I7Cn0sMjksW10sInRvSXRlcmF0b3IiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBNYXAgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTWFwIik7CgogIHZhciBfc2hvdWxkUG9seWZpbGxFUzZDb2xsZWN0aW9uID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIl9zaG91bGRQb2x5ZmlsbEVTNkNvbGxlY3Rpb24iKTsKCiAgdmFyIHRvSXRlcmF0b3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAidG9JdGVyYXRvciIpOwoKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChnbG9iYWwpIHsKICAgIGlmICghX3Nob3VsZFBvbHlmaWxsRVM2Q29sbGVjdGlvbignU2V0JykpIHsKICAgICAgcmV0dXJuIGdsb2JhbC5TZXQ7CiAgICB9CgogICAgdmFyIFNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gU2V0KGl0ZXJhYmxlKSB7CiAgICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFNldCk7CgogICAgICAgIGlmICh0aGlzID09IG51bGwgfHwgdHlwZW9mIHRoaXMgIT09ICdvYmplY3QnICYmIHR5cGVvZiB0aGlzICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdXcm9uZyBzZXQgb2JqZWN0IHR5cGUuJyk7CiAgICAgICAgfQoKICAgICAgICBpbml0U2V0KHRoaXMpOwoKICAgICAgICBpZiAoaXRlcmFibGUgIT0gbnVsbCkgewogICAgICAgICAgdmFyIGl0ID0gdG9JdGVyYXRvcihpdGVyYWJsZSk7CiAgICAgICAgICB2YXIgbmV4dDsKCiAgICAgICAgICB3aGlsZSAoIShuZXh0ID0gaXQubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICAgIHRoaXMuYWRkKG5leHQudmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFNldCwgW3sKICAgICAgICBrZXk6ICJhZGQiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGQodmFsdWUpIHsKICAgICAgICAgIHRoaXMuX21hcC5zZXQodmFsdWUsIHZhbHVlKTsKCiAgICAgICAgICB0aGlzLnNpemUgPSB0aGlzLl9tYXAuc2l6ZTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogImNsZWFyIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgICAgICBpbml0U2V0KHRoaXMpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogImRlbGV0ZSIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9kZWxldGUodmFsdWUpIHsKICAgICAgICAgIHZhciByZXQgPSB0aGlzLl9tYXAuZGVsZXRlKHZhbHVlKTsKCiAgICAgICAgICB0aGlzLnNpemUgPSB0aGlzLl9tYXAuc2l6ZTsKICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAiZW50cmllcyIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGVudHJpZXMoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fbWFwLmVudHJpZXMoKTsKICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBrZXk6ICJmb3JFYWNoIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZm9yRWFjaChjYWxsYmFjaykgewogICAgICAgICAgdmFyIHRoaXNBcmcgPSBhcmd1bWVudHNbMV07CgogICAgICAgICAgdmFyIGl0ID0gdGhpcy5fbWFwLmtleXMoKTsKCiAgICAgICAgICB2YXIgbmV4dDsKCiAgICAgICAgICB3aGlsZSAoIShuZXh0ID0gaXQubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc0FyZywgbmV4dC52YWx1ZSwgbmV4dC52YWx1ZSwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAiaGFzIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gaGFzKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fbWFwLmhhcyh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAidmFsdWVzIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWVzKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX21hcC52YWx1ZXMoKTsKICAgICAgICB9CiAgICAgIH1dKTsKICAgICAgcmV0dXJuIFNldDsKICAgIH0oKTsKCiAgICBTZXQucHJvdG90eXBlW3RvSXRlcmF0b3IuSVRFUkFUT1JfU1lNQk9MXSA9IFNldC5wcm90b3R5cGUudmFsdWVzOwogICAgU2V0LnByb3RvdHlwZS5rZXlzID0gU2V0LnByb3RvdHlwZS52YWx1ZXM7CgogICAgZnVuY3Rpb24gaW5pdFNldChzZXQpIHsKICAgICAgc2V0Ll9tYXAgPSBuZXcgTWFwKCk7CiAgICAgIHNldC5zaXplID0gc2V0Ll9tYXAuc2l6ZTsKICAgIH0KCiAgICByZXR1cm4gU2V0OwogIH0oRnVuY3Rpb24oJ3JldHVybiB0aGlzJykoKSk7Cn0sMzAsWzI2LDI1LDI5XSwiU2V0Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgZXhjZXB0aW9uSUQgPSAwOwoKICBmdW5jdGlvbiByZXBvcnRFeGNlcHRpb24oZSwgaXNGYXRhbCkgewogICAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIk5hdGl2ZU1vZHVsZXMiKSwKICAgICAgICBFeGNlcHRpb25zTWFuYWdlciA9IF9yZXF1aXJlLkV4Y2VwdGlvbnNNYW5hZ2VyOwoKICAgIGlmIChFeGNlcHRpb25zTWFuYWdlcikgewogICAgICB2YXIgcGFyc2VFcnJvclN0YWNrID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgInBhcnNlRXJyb3JTdGFjayIpOwoKICAgICAgdmFyIHN0YWNrID0gcGFyc2VFcnJvclN0YWNrKGUpOwogICAgICB2YXIgY3VycmVudEV4Y2VwdGlvbklEID0gKytleGNlcHRpb25JRDsKCiAgICAgIGlmIChpc0ZhdGFsKSB7CiAgICAgICAgRXhjZXB0aW9uc01hbmFnZXIucmVwb3J0RmF0YWxFeGNlcHRpb24oZS5tZXNzYWdlLCBzdGFjaywgY3VycmVudEV4Y2VwdGlvbklEKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBFeGNlcHRpb25zTWFuYWdlci5yZXBvcnRTb2Z0RXhjZXB0aW9uKGUubWVzc2FnZSwgc3RhY2ssIGN1cnJlbnRFeGNlcHRpb25JRCk7CiAgICAgIH0KCiAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgdmFyIHN5bWJvbGljYXRlU3RhY2tUcmFjZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJzeW1ib2xpY2F0ZVN0YWNrVHJhY2UiKTsKCiAgICAgICAgc3ltYm9saWNhdGVTdGFja1RyYWNlKHN0YWNrKS50aGVuKGZ1bmN0aW9uIChwcmV0dHlTdGFjaykgewogICAgICAgICAgaWYgKHByZXR0eVN0YWNrKSB7CiAgICAgICAgICAgIEV4Y2VwdGlvbnNNYW5hZ2VyLnVwZGF0ZUV4Y2VwdGlvbk1lc3NhZ2UoZS5tZXNzYWdlLCBwcmV0dHlTdGFjaywgY3VycmVudEV4Y2VwdGlvbklEKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIHN0YWNrIGlzIG51bGwnKTsKICAgICAgICAgIH0KICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIHJldHVybiBjb25zb2xlLndhcm4oJ1VuYWJsZSB0byBzeW1ib2xpY2F0ZSBzdGFjayB0cmFjZTogJyArIGVycm9yLm1lc3NhZ2UpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVFeGNlcHRpb24oZSwgaXNGYXRhbCkgewogICAgaWYgKCFlLm1lc3NhZ2UpIHsKICAgICAgZSA9IG5ldyBFcnJvcihlKTsKICAgIH0KCiAgICBpZiAoY29uc29sZS5fZXJyb3JPcmlnaW5hbCkgewogICAgICBjb25zb2xlLl9lcnJvck9yaWdpbmFsKGUubWVzc2FnZSk7CiAgICB9IGVsc2UgewogICAgICBjb25zb2xlLmVycm9yKGUubWVzc2FnZSk7CiAgICB9CgogICAgcmVwb3J0RXhjZXB0aW9uKGUsIGlzRmF0YWwpOwogIH0KCiAgZnVuY3Rpb24gcmVhY3RDb25zb2xlRXJyb3JIYW5kbGVyKCkgewogICAgY29uc29sZS5fZXJyb3JPcmlnaW5hbC5hcHBseShjb25zb2xlLCBhcmd1bWVudHMpOwoKICAgIGlmICghY29uc29sZS5yZXBvcnRFcnJvcnNBc0V4Y2VwdGlvbnMpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChhcmd1bWVudHNbMF0gJiYgYXJndW1lbnRzWzBdLnN0YWNrKSB7CiAgICAgIHJlcG9ydEV4Y2VwdGlvbihhcmd1bWVudHNbMF0sIGZhbHNlKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBzdHJpbmdpZnlTYWZlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgInN0cmluZ2lmeVNhZmUiKTsKCiAgICAgIHZhciBzdHIgPSBBcnJheS5wcm90b3R5cGUubWFwLmNhbGwoYXJndW1lbnRzLCBzdHJpbmdpZnlTYWZlKS5qb2luKCcsICcpOwoKICAgICAgaWYgKHN0ci5zbGljZSgwLCAxMCkgPT09ICciV2FybmluZzogJykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCdjb25zb2xlLmVycm9yOiAnICsgc3RyKTsKICAgICAgZXJyb3IuZnJhbWVzVG9Qb3AgPSAxOwogICAgICByZXBvcnRFeGNlcHRpb24oZXJyb3IsIGZhbHNlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGluc3RhbGxDb25zb2xlRXJyb3JSZXBvcnRlcigpIHsKICAgIGlmIChjb25zb2xlLl9lcnJvck9yaWdpbmFsKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBjb25zb2xlLl9lcnJvck9yaWdpbmFsID0gY29uc29sZS5lcnJvci5iaW5kKGNvbnNvbGUpOwogICAgY29uc29sZS5lcnJvciA9IHJlYWN0Q29uc29sZUVycm9ySGFuZGxlcjsKCiAgICBpZiAoY29uc29sZS5yZXBvcnRFcnJvcnNBc0V4Y2VwdGlvbnMgPT09IHVuZGVmaW5lZCkgewogICAgICBjb25zb2xlLnJlcG9ydEVycm9yc0FzRXhjZXB0aW9ucyA9IHRydWU7CiAgICB9CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGhhbmRsZUV4Y2VwdGlvbjogaGFuZGxlRXhjZXB0aW9uLAogICAgaW5zdGFsbENvbnNvbGVFcnJvclJlcG9ydGVyOiBpbnN0YWxsQ29uc29sZUVycm9yUmVwb3J0ZXIKICB9Owp9LDMxLFsxNSwzMiwzNSwzOV0sIkV4Y2VwdGlvbnNNYW5hZ2VyIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBwYXJzZUVycm9yU3RhY2soZSkgewogICAgaWYgKCFlIHx8ICFlLnN0YWNrKSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KCiAgICB2YXIgc3RhY2t0cmFjZVBhcnNlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJzdGFja3RyYWNlLXBhcnNlciIpOwoKICAgIHZhciBzdGFjayA9IEFycmF5LmlzQXJyYXkoZS5zdGFjaykgPyBlLnN0YWNrIDogc3RhY2t0cmFjZVBhcnNlci5wYXJzZShlLnN0YWNrKTsKICAgIHZhciBmcmFtZXNUb1BvcCA9IHR5cGVvZiBlLmZyYW1lc1RvUG9wID09PSAnbnVtYmVyJyA/IGUuZnJhbWVzVG9Qb3AgOiAwOwoKICAgIHdoaWxlIChmcmFtZXNUb1BvcC0tKSB7CiAgICAgIHN0YWNrLnNoaWZ0KCk7CiAgICB9CgogICAgcmV0dXJuIHN0YWNrOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBwYXJzZUVycm9yU3RhY2s7Cn0sMzIsWzMzXSwicGFyc2VFcnJvclN0YWNrIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9saWIvc3RhY2t0cmFjZS1wYXJzZXIuanMnKTsKfSwzMyxbMzRdLCJzdGFja3RyYWNlLXBhcnNlci9pbmRleC5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICAgdmFyIFVOS05PV05fRlVOQ1RJT04gPSAnPHVua25vd24+JzsKICAgIHZhciBTdGFja1RyYWNlUGFyc2VyID0gewogICAgICAgIHBhcnNlOiBmdW5jdGlvbiBwYXJzZShzdGFja1N0cmluZykgewogICAgICAgICAgICB2YXIgY2hyb21lID0gL15ccyphdCAoPzooPzooPzpBbm9ueW1vdXMgZnVuY3Rpb24pP3woKD86XFtvYmplY3Qgb2JqZWN0XF0pP1xTKyg/OiBcW2FzIFxTK1xdKT8pKSApP1woPygoPzpmaWxlfGh0dHB8aHR0cHMpOi4qPyk6KFxkKykoPzo6KFxkKykpP1wpP1xzKiQvaSwKICAgICAgICAgICAgICAgIGdlY2tvID0gL14oPzpccyooW15AXSopKD86XCgoLio/KVwpKT9AKT8oXFMuKj8pOihcZCspKD86OihcZCspKT9ccyokL2ksCiAgICAgICAgICAgICAgICBub2RlID0gL15ccyphdCAoPzooKD86XFtvYmplY3Qgb2JqZWN0XF0pP1xTKyg/OiBcW2FzIFxTK1xdKT8pICk/XCg/KC4qPyk6KFxkKykoPzo6KFxkKykpP1wpP1xzKiQvaSwKICAgICAgICAgICAgICAgIGxpbmVzID0gc3RhY2tTdHJpbmcuc3BsaXQoJ1xuJyksCiAgICAgICAgICAgICAgICBzdGFjayA9IFtdLAogICAgICAgICAgICAgICAgcGFydHMsCiAgICAgICAgICAgICAgICBlbGVtZW50OwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBsaW5lcy5sZW5ndGg7IGkgPCBqOyArK2kpIHsKICAgICAgICAgICAgICAgIGlmIChwYXJ0cyA9IGdlY2tvLmV4ZWMobGluZXNbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2ZpbGUnOiBwYXJ0c1szXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ21ldGhvZE5hbWUnOiBwYXJ0c1sxXSB8fCBVTktOT1dOX0ZVTkNUSU9OLAogICAgICAgICAgICAgICAgICAgICAgICAnbGluZU51bWJlcic6ICtwYXJ0c1s0XSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2NvbHVtbic6IHBhcnRzWzVdID8gK3BhcnRzWzVdIDogbnVsbAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHBhcnRzID0gY2hyb21lLmV4ZWMobGluZXNbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2ZpbGUnOiBwYXJ0c1syXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ21ldGhvZE5hbWUnOiBwYXJ0c1sxXSB8fCBVTktOT1dOX0ZVTkNUSU9OLAogICAgICAgICAgICAgICAgICAgICAgICAnbGluZU51bWJlcic6ICtwYXJ0c1szXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2NvbHVtbic6IHBhcnRzWzRdID8gK3BhcnRzWzRdIDogbnVsbAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHBhcnRzID0gbm9kZS5leGVjKGxpbmVzW2ldKSkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICdmaWxlJzogcGFydHNbMl0sCiAgICAgICAgICAgICAgICAgICAgICAgICdtZXRob2ROYW1lJzogcGFydHNbMV0gfHwgVU5LTk9XTl9GVU5DVElPTiwKICAgICAgICAgICAgICAgICAgICAgICAgJ2xpbmVOdW1iZXInOiArcGFydHNbM10sCiAgICAgICAgICAgICAgICAgICAgICAgICdjb2x1bW4nOiBwYXJ0c1s0XSA/ICtwYXJ0c1s0XSA6IG51bGwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKGVsZW1lbnQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gc3RhY2s7CiAgICAgICAgfQogICAgfTsKICAgIG1vZHVsZS5leHBvcnRzID0gU3RhY2tUcmFjZVBhcnNlcjsKfSwzNCxbXSwic3RhY2t0cmFjZS1wYXJzZXIvbGliL3N0YWNrdHJhY2UtcGFyc2VyLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgZ2V0RGV2U2VydmVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgImdldERldlNlcnZlciIpOwoKICB2YXIgX3JlcXVpcmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiTmF0aXZlTW9kdWxlcyIpLAogICAgICBTb3VyY2VDb2RlID0gX3JlcXVpcmUuU291cmNlQ29kZTsKCiAgdmFyIGZldGNoID0gdm9pZCAwOwoKICBmdW5jdGlvbiBpc1NvdXJjZWRGcm9tRGlzayhzb3VyY2VQYXRoKSB7CiAgICByZXR1cm4gIS9eaHR0cC8udGVzdChzb3VyY2VQYXRoKSAmJiAvW1xcL10vLnRlc3Qoc291cmNlUGF0aCk7CiAgfQoKICBmdW5jdGlvbiBzeW1ib2xpY2F0ZVN0YWNrVHJhY2Uoc3RhY2spIHsKICAgIHZhciBkZXZTZXJ2ZXIsIHN0YWNrQ29weSwgZm91bmRJbnRlcm5hbFNvdXJjZSwgcmVzcG9uc2UsIGpzb247CiAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmFzeW5jKGZ1bmN0aW9uIHN5bWJvbGljYXRlU3RhY2tUcmFjZSQoX2NvbnRleHQpIHsKICAgICAgd2hpbGUgKDEpIHsKICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIGlmICghZmV0Y2gpIHsKICAgICAgICAgICAgICBmZXRjaCA9IGdsb2JhbC5mZXRjaCB8fCByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiZmV0Y2giKS5mZXRjaDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGV2U2VydmVyID0gZ2V0RGV2U2VydmVyKCk7CgogICAgICAgICAgICBpZiAoZGV2U2VydmVyLmJ1bmRsZUxvYWRlZEZyb21TZXJ2ZXIpIHsKICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gNDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCdW5kbGUgd2FzIG5vdCBsb2FkZWQgZnJvbSB0aGUgcGFja2FnZXInKTsKCiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHN0YWNrQ29weSA9IHN0YWNrOwoKICAgICAgICAgICAgaWYgKFNvdXJjZUNvZGUuc2NyaXB0VVJMKSB7CiAgICAgICAgICAgICAgZm91bmRJbnRlcm5hbFNvdXJjZSA9IGZhbHNlOwogICAgICAgICAgICAgIHN0YWNrQ29weSA9IHN0YWNrLm1hcChmdW5jdGlvbiAoZnJhbWUpIHsKICAgICAgICAgICAgICAgIGlmICghZm91bmRJbnRlcm5hbFNvdXJjZSAmJiBpc1NvdXJjZWRGcm9tRGlzayhmcmFtZS5maWxlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIGZyYW1lLCB7CiAgICAgICAgICAgICAgICAgICAgZmlsZTogU291cmNlQ29kZS5zY3JpcHRVUkwKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm91bmRJbnRlcm5hbFNvdXJjZSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZnJhbWU7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSA4OwogICAgICAgICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmF3cmFwKGZldGNoKGRldlNlcnZlci51cmwgKyAnc3ltYm9saWNhdGUnLCB7CiAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgc3RhY2s6IHN0YWNrQ29weQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIHJlc3BvbnNlID0gX2NvbnRleHQuc2VudDsKICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDExOwogICAgICAgICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmF3cmFwKHJlc3BvbnNlLmpzb24oKSk7CgogICAgICAgICAgY2FzZSAxMToKICAgICAgICAgICAganNvbiA9IF9jb250ZXh0LnNlbnQ7CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsIGpzb24uc3RhY2spOwoKICAgICAgICAgIGNhc2UgMTM6CiAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgbnVsbCwgdGhpcyk7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IHN5bWJvbGljYXRlU3RhY2tUcmFjZTsKfSwzNSxbMzYsMTUsMzddLCJzeW1ib2xpY2F0ZVN0YWNrVHJhY2UiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfcmVxdWlyZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIiksCiAgICAgIFNvdXJjZUNvZGUgPSBfcmVxdWlyZS5Tb3VyY2VDb2RlOwoKICB2YXIgX2NhY2hlZERldlNlcnZlclVSTCA9IHZvaWQgMDsKCiAgdmFyIEZBTExCQUNLID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6ODA4MS8nOwoKICBmdW5jdGlvbiBnZXREZXZTZXJ2ZXIoKSB7CiAgICBpZiAoX2NhY2hlZERldlNlcnZlclVSTCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhciBtYXRjaCA9IFNvdXJjZUNvZGUuc2NyaXB0VVJMICYmIFNvdXJjZUNvZGUuc2NyaXB0VVJMLm1hdGNoKC9eaHR0cHM/OlwvXC8uKj9cLy8pOwogICAgICBfY2FjaGVkRGV2U2VydmVyVVJMID0gbWF0Y2ggPyBtYXRjaFswXSA6IG51bGw7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgdXJsOiBfY2FjaGVkRGV2U2VydmVyVVJMIHx8IEZBTExCQUNLLAogICAgICBidW5kbGVMb2FkZWRGcm9tU2VydmVyOiBfY2FjaGVkRGV2U2VydmVyVVJMICE9PSBudWxsCiAgICB9OwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBnZXREZXZTZXJ2ZXI7Cn0sMzYsWzE1XSwiZ2V0RGV2U2VydmVyIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX3doYXR3Z0ZldGNoID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIndoYXR3Zy1mZXRjaCIpOwoKICB2YXIgX3doYXR3Z0ZldGNoMiA9IGJhYmVsSGVscGVycy5pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3doYXR3Z0ZldGNoKTsKCiAgaWYgKF93aGF0d2dGZXRjaDIuZGVmYXVsdCAmJiBfd2hhdHdnRmV0Y2gyLmRlZmF1bHQuZmV0Y2gpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gX3doYXR3Z0ZldGNoMi5kZWZhdWx0OwogIH0gZWxzZSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZmV0Y2g6IGZldGNoLAogICAgICBIZWFkZXJzOiBIZWFkZXJzLAogICAgICBSZXF1ZXN0OiBSZXF1ZXN0LAogICAgICBSZXNwb25zZTogUmVzcG9uc2UKICAgIH07CiAgfQp9LDM3LFszOF0sImZldGNoIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgKGZ1bmN0aW9uIChzZWxmKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgaWYgKHNlbGYuZmV0Y2gpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBzdXBwb3J0ID0gewogICAgICBzZWFyY2hQYXJhbXM6ICdVUkxTZWFyY2hQYXJhbXMnIGluIHNlbGYsCiAgICAgIGl0ZXJhYmxlOiAnU3ltYm9sJyBpbiBzZWxmICYmICdpdGVyYXRvcicgaW4gU3ltYm9sLAogICAgICBibG9iOiAnRmlsZVJlYWRlcicgaW4gc2VsZiAmJiAnQmxvYicgaW4gc2VsZiAmJiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIG5ldyBCbG9iKCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9KCksCiAgICAgIGZvcm1EYXRhOiAnRm9ybURhdGEnIGluIHNlbGYsCiAgICAgIGFycmF5QnVmZmVyOiAnQXJyYXlCdWZmZXInIGluIHNlbGYKICAgIH07CgogICAgaWYgKHN1cHBvcnQuYXJyYXlCdWZmZXIpIHsKICAgICAgdmFyIHZpZXdDbGFzc2VzID0gWydbb2JqZWN0IEludDhBcnJheV0nLCAnW29iamVjdCBVaW50OEFycmF5XScsICdbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XScsICdbb2JqZWN0IEludDE2QXJyYXldJywgJ1tvYmplY3QgVWludDE2QXJyYXldJywgJ1tvYmplY3QgSW50MzJBcnJheV0nLCAnW29iamVjdCBVaW50MzJBcnJheV0nLCAnW29iamVjdCBGbG9hdDMyQXJyYXldJywgJ1tvYmplY3QgRmxvYXQ2NEFycmF5XSddOwoKICAgICAgdmFyIGlzRGF0YVZpZXcgPSBmdW5jdGlvbiBpc0RhdGFWaWV3KG9iaikgewogICAgICAgIHJldHVybiBvYmogJiYgRGF0YVZpZXcucHJvdG90eXBlLmlzUHJvdG90eXBlT2Yob2JqKTsKICAgICAgfTsKCiAgICAgIHZhciBpc0FycmF5QnVmZmVyVmlldyA9IEFycmF5QnVmZmVyLmlzVmlldyB8fCBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiAmJiB2aWV3Q2xhc3Nlcy5pbmRleE9mKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopKSA+IC0xOwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZU5hbWUobmFtZSkgewogICAgICBpZiAodHlwZW9mIG5hbWUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgbmFtZSA9IFN0cmluZyhuYW1lKTsKICAgICAgfQoKICAgICAgaWYgKC9bXmEtejAtOVwtIyQlJicqKy5cXl9gfH5dL2kudGVzdChuYW1lKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgY2hhcmFjdGVyIGluIGhlYWRlciBmaWVsZCBuYW1lJyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gbm9ybWFsaXplVmFsdWUodmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBpdGVyYXRvckZvcihpdGVtcykgewogICAgICB2YXIgaXRlcmF0b3IgPSB7CiAgICAgICAgbmV4dDogZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IGl0ZW1zLnNoaWZ0KCk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBkb25lOiB2YWx1ZSA9PT0gdW5kZWZpbmVkLAogICAgICAgICAgICB2YWx1ZTogdmFsdWUKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaWYgKHN1cHBvcnQuaXRlcmFibGUpIHsKICAgICAgICBpdGVyYXRvclt0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLml0ZXJhdG9yIDogIkBAaXRlcmF0b3IiXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBpdGVyYXRvcjsKICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gaXRlcmF0b3I7CiAgICB9CgogICAgZnVuY3Rpb24gSGVhZGVycyhoZWFkZXJzKSB7CiAgICAgIHRoaXMubWFwID0ge307CgogICAgICBpZiAoaGVhZGVycyBpbnN0YW5jZW9mIEhlYWRlcnMpIHsKICAgICAgICBoZWFkZXJzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBuYW1lKSB7CiAgICAgICAgICB0aGlzLmFwcGVuZChuYW1lLCB2YWx1ZSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0gZWxzZSBpZiAoaGVhZGVycykgewogICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGhlYWRlcnMpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgIHRoaXMuYXBwZW5kKG5hbWUsIGhlYWRlcnNbbmFtZV0pOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9CiAgICB9CgogICAgSGVhZGVycy5wcm90b3R5cGUuYXBwZW5kID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgIG5hbWUgPSBub3JtYWxpemVOYW1lKG5hbWUpOwogICAgICB2YWx1ZSA9IG5vcm1hbGl6ZVZhbHVlKHZhbHVlKTsKICAgICAgdmFyIGxpc3QgPSB0aGlzLm1hcFtuYW1lXTsKCiAgICAgIGlmICghbGlzdCkgewogICAgICAgIGxpc3QgPSBbXTsKICAgICAgICB0aGlzLm1hcFtuYW1lXSA9IGxpc3Q7CiAgICAgIH0KCiAgICAgIGxpc3QucHVzaCh2YWx1ZSk7CiAgICB9OwoKICAgIEhlYWRlcnMucHJvdG90eXBlWydkZWxldGUnXSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIGRlbGV0ZSB0aGlzLm1hcFtub3JtYWxpemVOYW1lKG5hbWUpXTsKICAgIH07CgogICAgSGVhZGVycy5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdmFyIHZhbHVlcyA9IHRoaXMubWFwW25vcm1hbGl6ZU5hbWUobmFtZSldOwogICAgICByZXR1cm4gdmFsdWVzID8gdmFsdWVzWzBdIDogbnVsbDsKICAgIH07CgogICAgSGVhZGVycy5wcm90b3R5cGUuZ2V0QWxsID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMubWFwW25vcm1hbGl6ZU5hbWUobmFtZSldIHx8IFtdOwogICAgfTsKCiAgICBIZWFkZXJzLnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICByZXR1cm4gdGhpcy5tYXAuaGFzT3duUHJvcGVydHkobm9ybWFsaXplTmFtZShuYW1lKSk7CiAgICB9OwoKICAgIEhlYWRlcnMucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICB0aGlzLm1hcFtub3JtYWxpemVOYW1lKG5hbWUpXSA9IFtub3JtYWxpemVWYWx1ZSh2YWx1ZSldOwogICAgfTsKCiAgICBIZWFkZXJzLnByb3RvdHlwZS5mb3JFYWNoID0gZnVuY3Rpb24gKGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRoaXMubWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgdGhpcy5tYXBbbmFtZV0uZm9yRWFjaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc0FyZywgdmFsdWUsIG5hbWUsIHRoaXMpOwogICAgICAgIH0sIHRoaXMpOwogICAgICB9LCB0aGlzKTsKICAgIH07CgogICAgSGVhZGVycy5wcm90b3R5cGUua2V5cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIG5hbWUpIHsKICAgICAgICBpdGVtcy5wdXNoKG5hbWUpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGl0ZXJhdG9yRm9yKGl0ZW1zKTsKICAgIH07CgogICAgSGVhZGVycy5wcm90b3R5cGUudmFsdWVzID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgaXRlbXMgPSBbXTsKICAgICAgdGhpcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGl0ZW1zLnB1c2godmFsdWUpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGl0ZXJhdG9yRm9yKGl0ZW1zKTsKICAgIH07CgogICAgSGVhZGVycy5wcm90b3R5cGUuZW50cmllcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIG5hbWUpIHsKICAgICAgICBpdGVtcy5wdXNoKFtuYW1lLCB2YWx1ZV0pOwogICAgICB9KTsKICAgICAgcmV0dXJuIGl0ZXJhdG9yRm9yKGl0ZW1zKTsKICAgIH07CgogICAgaWYgKHN1cHBvcnQuaXRlcmFibGUpIHsKICAgICAgSGVhZGVycy5wcm90b3R5cGVbdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5pdGVyYXRvciA6ICJAQGl0ZXJhdG9yIl0gPSBIZWFkZXJzLnByb3RvdHlwZS5lbnRyaWVzOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbnN1bWVkKGJvZHkpIHsKICAgICAgaWYgKGJvZHkuYm9keVVzZWQpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFR5cGVFcnJvcignQWxyZWFkeSByZWFkJykpOwogICAgICB9CgogICAgICBib2R5LmJvZHlVc2VkID0gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBmaWxlUmVhZGVyUmVhZHkocmVhZGVyKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgcmVhZGVyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlc29sdmUocmVhZGVyLnJlc3VsdCk7CiAgICAgICAgfTsKCiAgICAgICAgcmVhZGVyLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZWplY3QocmVhZGVyLmVycm9yKTsKICAgICAgICB9OwogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiByZWFkQmxvYkFzQXJyYXlCdWZmZXIoYmxvYikgewogICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgdmFyIHByb21pc2UgPSBmaWxlUmVhZGVyUmVhZHkocmVhZGVyKTsKICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGJsb2IpOwogICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KCiAgICBmdW5jdGlvbiByZWFkQmxvYkFzVGV4dChibG9iKSB7CiAgICAgIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwogICAgICB2YXIgcHJvbWlzZSA9IGZpbGVSZWFkZXJSZWFkeShyZWFkZXIpOwogICAgICByZWFkZXIucmVhZEFzVGV4dChibG9iKTsKICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CgogICAgZnVuY3Rpb24gcmVhZEFycmF5QnVmZmVyQXNUZXh0KGJ1ZikgewogICAgICB2YXIgdmlldyA9IG5ldyBVaW50OEFycmF5KGJ1Zik7CiAgICAgIHZhciBjaGFycyA9IG5ldyBBcnJheSh2aWV3Lmxlbmd0aCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZpZXcubGVuZ3RoOyBpKyspIHsKICAgICAgICBjaGFyc1tpXSA9IFN0cmluZy5mcm9tQ2hhckNvZGUodmlld1tpXSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBjaGFycy5qb2luKCcnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBidWZmZXJDbG9uZShidWYpIHsKICAgICAgaWYgKGJ1Zi5zbGljZSkgewogICAgICAgIHJldHVybiBidWYuc2xpY2UoMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHZpZXcgPSBuZXcgVWludDhBcnJheShidWYuYnl0ZUxlbmd0aCk7CiAgICAgICAgdmlldy5zZXQobmV3IFVpbnQ4QXJyYXkoYnVmKSk7CiAgICAgICAgcmV0dXJuIHZpZXcuYnVmZmVyOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gQm9keSgpIHsKICAgICAgdGhpcy5ib2R5VXNlZCA9IGZhbHNlOwoKICAgICAgdGhpcy5faW5pdEJvZHkgPSBmdW5jdGlvbiAoYm9keSkgewogICAgICAgIHRoaXMuX2JvZHlJbml0ID0gYm9keTsKCiAgICAgICAgaWYgKCFib2R5KSB7CiAgICAgICAgICB0aGlzLl9ib2R5VGV4dCA9ICcnOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICB0aGlzLl9ib2R5VGV4dCA9IGJvZHk7CiAgICAgICAgfSBlbHNlIGlmIChzdXBwb3J0LmJsb2IgJiYgQmxvYi5wcm90b3R5cGUuaXNQcm90b3R5cGVPZihib2R5KSkgewogICAgICAgICAgdGhpcy5fYm9keUJsb2IgPSBib2R5OwogICAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydC5mb3JtRGF0YSAmJiBGb3JtRGF0YS5wcm90b3R5cGUuaXNQcm90b3R5cGVPZihib2R5KSkgewogICAgICAgICAgdGhpcy5fYm9keUZvcm1EYXRhID0gYm9keTsKICAgICAgICB9IGVsc2UgaWYgKHN1cHBvcnQuc2VhcmNoUGFyYW1zICYmIFVSTFNlYXJjaFBhcmFtcy5wcm90b3R5cGUuaXNQcm90b3R5cGVPZihib2R5KSkgewogICAgICAgICAgdGhpcy5fYm9keVRleHQgPSBib2R5LnRvU3RyaW5nKCk7CiAgICAgICAgfSBlbHNlIGlmIChzdXBwb3J0LmFycmF5QnVmZmVyICYmIHN1cHBvcnQuYmxvYiAmJiBpc0RhdGFWaWV3KGJvZHkpKSB7CiAgICAgICAgICB0aGlzLl9ib2R5QXJyYXlCdWZmZXIgPSBidWZmZXJDbG9uZShib2R5LmJ1ZmZlcik7CiAgICAgICAgICB0aGlzLl9ib2R5SW5pdCA9IG5ldyBCbG9iKFt0aGlzLl9ib2R5QXJyYXlCdWZmZXJdKTsKICAgICAgICB9IGVsc2UgaWYgKHN1cHBvcnQuYXJyYXlCdWZmZXIgJiYgKEFycmF5QnVmZmVyLnByb3RvdHlwZS5pc1Byb3RvdHlwZU9mKGJvZHkpIHx8IGlzQXJyYXlCdWZmZXJWaWV3KGJvZHkpKSkgewogICAgICAgICAgdGhpcy5fYm9keUFycmF5QnVmZmVyID0gYnVmZmVyQ2xvbmUoYm9keSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigndW5zdXBwb3J0ZWQgQm9keUluaXQgdHlwZScpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLmhlYWRlcnMuZ2V0KCdjb250ZW50LXR5cGUnKSkgewogICAgICAgICAgaWYgKHR5cGVvZiBib2R5ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICB0aGlzLmhlYWRlcnMuc2V0KCdjb250ZW50LXR5cGUnLCAndGV4dC9wbGFpbjtjaGFyc2V0PVVURi04Jyk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2JvZHlCbG9iICYmIHRoaXMuX2JvZHlCbG9iLnR5cGUpIHsKICAgICAgICAgICAgdGhpcy5oZWFkZXJzLnNldCgnY29udGVudC10eXBlJywgdGhpcy5fYm9keUJsb2IudHlwZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHN1cHBvcnQuc2VhcmNoUGFyYW1zICYmIFVSTFNlYXJjaFBhcmFtcy5wcm90b3R5cGUuaXNQcm90b3R5cGVPZihib2R5KSkgewogICAgICAgICAgICB0aGlzLmhlYWRlcnMuc2V0KCdjb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkO2NoYXJzZXQ9VVRGLTgnKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAoc3VwcG9ydC5ibG9iKSB7CiAgICAgICAgdGhpcy5ibG9iID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIHJlamVjdGVkID0gY29uc3VtZWQodGhpcyk7CgogICAgICAgICAgaWYgKHJlamVjdGVkKSB7CiAgICAgICAgICAgIHJldHVybiByZWplY3RlZDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodGhpcy5fYm9keUJsb2IpIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLl9ib2R5QmxvYik7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2JvZHlBcnJheUJ1ZmZlcikgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5ldyBCbG9iKFt0aGlzLl9ib2R5QXJyYXlCdWZmZXJdKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2JvZHlGb3JtRGF0YSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCByZWFkIEZvcm1EYXRhIGJvZHkgYXMgYmxvYicpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShuZXcgQmxvYihbdGhpcy5fYm9keVRleHRdKSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5hcnJheUJ1ZmZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzLl9ib2R5QXJyYXlCdWZmZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnN1bWVkKHRoaXMpIHx8IFByb21pc2UucmVzb2x2ZSh0aGlzLl9ib2R5QXJyYXlCdWZmZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmxvYigpLnRoZW4ocmVhZEJsb2JBc0FycmF5QnVmZmVyKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CgogICAgICB0aGlzLnRleHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJlamVjdGVkID0gY29uc3VtZWQodGhpcyk7CgogICAgICAgIGlmIChyZWplY3RlZCkgewogICAgICAgICAgcmV0dXJuIHJlamVjdGVkOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2JvZHlCbG9iKSB7CiAgICAgICAgICByZXR1cm4gcmVhZEJsb2JBc1RleHQodGhpcy5fYm9keUJsb2IpOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5fYm9keUFycmF5QnVmZmVyKSB7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlYWRBcnJheUJ1ZmZlckFzVGV4dCh0aGlzLl9ib2R5QXJyYXlCdWZmZXIpKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2JvZHlGb3JtRGF0YSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgcmVhZCBGb3JtRGF0YSBib2R5IGFzIHRleHQnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLl9ib2R5VGV4dCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaWYgKHN1cHBvcnQuZm9ybURhdGEpIHsKICAgICAgICB0aGlzLmZvcm1EYXRhID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMudGV4dCgpLnRoZW4oZGVjb2RlKTsKICAgICAgICB9OwogICAgICB9CgogICAgICB0aGlzLmpzb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudGV4dCgpLnRoZW4oSlNPTi5wYXJzZSk7CiAgICAgIH07CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICB2YXIgbWV0aG9kcyA9IFsnREVMRVRFJywgJ0dFVCcsICdIRUFEJywgJ09QVElPTlMnLCAnUE9TVCcsICdQVVQnXTsKCiAgICBmdW5jdGlvbiBub3JtYWxpemVNZXRob2QobWV0aG9kKSB7CiAgICAgIHZhciB1cGNhc2VkID0gbWV0aG9kLnRvVXBwZXJDYXNlKCk7CiAgICAgIHJldHVybiBtZXRob2RzLmluZGV4T2YodXBjYXNlZCkgPiAtMSA/IHVwY2FzZWQgOiBtZXRob2Q7CiAgICB9CgogICAgZnVuY3Rpb24gUmVxdWVzdChpbnB1dCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIGJvZHkgPSBvcHRpb25zLmJvZHk7CgogICAgICBpZiAodHlwZW9mIGlucHV0ID09PSAnc3RyaW5nJykgewogICAgICAgIHRoaXMudXJsID0gaW5wdXQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlucHV0LmJvZHlVc2VkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBbHJlYWR5IHJlYWQnKTsKICAgICAgICB9CgogICAgICAgIHRoaXMudXJsID0gaW5wdXQudXJsOwogICAgICAgIHRoaXMuY3JlZGVudGlhbHMgPSBpbnB1dC5jcmVkZW50aWFsczsKCiAgICAgICAgaWYgKCFvcHRpb25zLmhlYWRlcnMpIHsKICAgICAgICAgIHRoaXMuaGVhZGVycyA9IG5ldyBIZWFkZXJzKGlucHV0LmhlYWRlcnMpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5tZXRob2QgPSBpbnB1dC5tZXRob2Q7CiAgICAgICAgdGhpcy5tb2RlID0gaW5wdXQubW9kZTsKCiAgICAgICAgaWYgKCFib2R5ICYmIGlucHV0Ll9ib2R5SW5pdCAhPSBudWxsKSB7CiAgICAgICAgICBib2R5ID0gaW5wdXQuX2JvZHlJbml0OwogICAgICAgICAgaW5wdXQuYm9keVVzZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5jcmVkZW50aWFscyA9IG9wdGlvbnMuY3JlZGVudGlhbHMgfHwgdGhpcy5jcmVkZW50aWFscyB8fCAnb21pdCc7CgogICAgICBpZiAob3B0aW9ucy5oZWFkZXJzIHx8ICF0aGlzLmhlYWRlcnMpIHsKICAgICAgICB0aGlzLmhlYWRlcnMgPSBuZXcgSGVhZGVycyhvcHRpb25zLmhlYWRlcnMpOwogICAgICB9CgogICAgICB0aGlzLm1ldGhvZCA9IG5vcm1hbGl6ZU1ldGhvZChvcHRpb25zLm1ldGhvZCB8fCB0aGlzLm1ldGhvZCB8fCAnR0VUJyk7CiAgICAgIHRoaXMubW9kZSA9IG9wdGlvbnMubW9kZSB8fCB0aGlzLm1vZGUgfHwgbnVsbDsKICAgICAgdGhpcy5yZWZlcnJlciA9IG51bGw7CgogICAgICBpZiAoKHRoaXMubWV0aG9kID09PSAnR0VUJyB8fCB0aGlzLm1ldGhvZCA9PT0gJ0hFQUQnKSAmJiBib2R5KSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQm9keSBub3QgYWxsb3dlZCBmb3IgR0VUIG9yIEhFQUQgcmVxdWVzdHMnKTsKICAgICAgfQoKICAgICAgdGhpcy5faW5pdEJvZHkoYm9keSk7CiAgICB9CgogICAgUmVxdWVzdC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgUmVxdWVzdCh0aGlzLCB7CiAgICAgICAgYm9keTogdGhpcy5fYm9keUluaXQKICAgICAgfSk7CiAgICB9OwoKICAgIGZ1bmN0aW9uIGRlY29kZShib2R5KSB7CiAgICAgIHZhciBmb3JtID0gbmV3IEZvcm1EYXRhKCk7CiAgICAgIGJvZHkudHJpbSgpLnNwbGl0KCcmJykuZm9yRWFjaChmdW5jdGlvbiAoYnl0ZXMpIHsKICAgICAgICBpZiAoYnl0ZXMpIHsKICAgICAgICAgIHZhciBzcGxpdCA9IGJ5dGVzLnNwbGl0KCc9Jyk7CiAgICAgICAgICB2YXIgbmFtZSA9IHNwbGl0LnNoaWZ0KCkucmVwbGFjZSgvXCsvZywgJyAnKTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHNwbGl0LmpvaW4oJz0nKS5yZXBsYWNlKC9cKy9nLCAnICcpOwogICAgICAgICAgZm9ybS5hcHBlbmQoZGVjb2RlVVJJQ29tcG9uZW50KG5hbWUpLCBkZWNvZGVVUklDb21wb25lbnQodmFsdWUpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gZm9ybTsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZUhlYWRlcnMocmF3SGVhZGVycykgewogICAgICB2YXIgaGVhZGVycyA9IG5ldyBIZWFkZXJzKCk7CiAgICAgIHJhd0hlYWRlcnMuc3BsaXQoJ1xyXG4nKS5mb3JFYWNoKGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbGluZS5zcGxpdCgnOicpOwogICAgICAgIHZhciBrZXkgPSBwYXJ0cy5zaGlmdCgpLnRyaW0oKTsKCiAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgdmFyIHZhbHVlID0gcGFydHMuam9pbignOicpLnRyaW0oKTsKICAgICAgICAgIGhlYWRlcnMuYXBwZW5kKGtleSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBoZWFkZXJzOwogICAgfQoKICAgIEJvZHkuY2FsbChSZXF1ZXN0LnByb3RvdHlwZSk7CgogICAgZnVuY3Rpb24gUmVzcG9uc2UoYm9keUluaXQsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLnR5cGUgPSAnZGVmYXVsdCc7CiAgICAgIHRoaXMuc3RhdHVzID0gJ3N0YXR1cycgaW4gb3B0aW9ucyA/IG9wdGlvbnMuc3RhdHVzIDogMjAwOwogICAgICB0aGlzLm9rID0gdGhpcy5zdGF0dXMgPj0gMjAwICYmIHRoaXMuc3RhdHVzIDwgMzAwOwogICAgICB0aGlzLnN0YXR1c1RleHQgPSAnc3RhdHVzVGV4dCcgaW4gb3B0aW9ucyA/IG9wdGlvbnMuc3RhdHVzVGV4dCA6ICdPSyc7CiAgICAgIHRoaXMuaGVhZGVycyA9IG5ldyBIZWFkZXJzKG9wdGlvbnMuaGVhZGVycyk7CiAgICAgIHRoaXMudXJsID0gb3B0aW9ucy51cmwgfHwgJyc7CgogICAgICB0aGlzLl9pbml0Qm9keShib2R5SW5pdCk7CiAgICB9CgogICAgQm9keS5jYWxsKFJlc3BvbnNlLnByb3RvdHlwZSk7CgogICAgUmVzcG9uc2UucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gbmV3IFJlc3BvbnNlKHRoaXMuX2JvZHlJbml0LCB7CiAgICAgICAgc3RhdHVzOiB0aGlzLnN0YXR1cywKICAgICAgICBzdGF0dXNUZXh0OiB0aGlzLnN0YXR1c1RleHQsCiAgICAgICAgaGVhZGVyczogbmV3IEhlYWRlcnModGhpcy5oZWFkZXJzKSwKICAgICAgICB1cmw6IHRoaXMudXJsCiAgICAgIH0pOwogICAgfTsKCiAgICBSZXNwb25zZS5lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHJlc3BvbnNlID0gbmV3IFJlc3BvbnNlKG51bGwsIHsKICAgICAgICBzdGF0dXM6IDAsCiAgICAgICAgc3RhdHVzVGV4dDogJycKICAgICAgfSk7CiAgICAgIHJlc3BvbnNlLnR5cGUgPSAnZXJyb3InOwogICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICB9OwoKICAgIHZhciByZWRpcmVjdFN0YXR1c2VzID0gWzMwMSwgMzAyLCAzMDMsIDMwNywgMzA4XTsKCiAgICBSZXNwb25zZS5yZWRpcmVjdCA9IGZ1bmN0aW9uICh1cmwsIHN0YXR1cykgewogICAgICBpZiAocmVkaXJlY3RTdGF0dXNlcy5pbmRleE9mKHN0YXR1cykgPT09IC0xKSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0ludmFsaWQgc3RhdHVzIGNvZGUnKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBSZXNwb25zZShudWxsLCB7CiAgICAgICAgc3RhdHVzOiBzdGF0dXMsCiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgbG9jYXRpb246IHVybAogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwoKICAgIHNlbGYuSGVhZGVycyA9IEhlYWRlcnM7CiAgICBzZWxmLlJlcXVlc3QgPSBSZXF1ZXN0OwogICAgc2VsZi5SZXNwb25zZSA9IFJlc3BvbnNlOwoKICAgIHNlbGYuZmV0Y2ggPSBmdW5jdGlvbiAoaW5wdXQsIGluaXQpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICB2YXIgcmVxdWVzdCA9IG5ldyBSZXF1ZXN0KGlucHV0LCBpbml0KTsKICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CgogICAgICAgIHhoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICAgICAgc3RhdHVzOiB4aHIuc3RhdHVzLAogICAgICAgICAgICBzdGF0dXNUZXh0OiB4aHIuc3RhdHVzVGV4dCwKICAgICAgICAgICAgaGVhZGVyczogcGFyc2VIZWFkZXJzKHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSB8fCAnJykKICAgICAgICAgIH07CiAgICAgICAgICBvcHRpb25zLnVybCA9ICdyZXNwb25zZVVSTCcgaW4geGhyID8geGhyLnJlc3BvbnNlVVJMIDogb3B0aW9ucy5oZWFkZXJzLmdldCgnWC1SZXF1ZXN0LVVSTCcpOwogICAgICAgICAgdmFyIGJvZHkgPSAncmVzcG9uc2UnIGluIHhociA/IHhoci5yZXNwb25zZSA6IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICByZXNvbHZlKG5ldyBSZXNwb25zZShib2R5LCBvcHRpb25zKSk7CiAgICAgICAgfTsKCiAgICAgICAgeGhyLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZWplY3QobmV3IFR5cGVFcnJvcignTmV0d29yayByZXF1ZXN0IGZhaWxlZCcpKTsKICAgICAgICB9OwoKICAgICAgICB4aHIub250aW1lb3V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgcmVqZWN0KG5ldyBUeXBlRXJyb3IoJ05ldHdvcmsgcmVxdWVzdCBmYWlsZWQnKSk7CiAgICAgICAgfTsKCiAgICAgICAgeGhyLm9wZW4ocmVxdWVzdC5tZXRob2QsIHJlcXVlc3QudXJsLCB0cnVlKTsKCiAgICAgICAgaWYgKHJlcXVlc3QuY3JlZGVudGlhbHMgPT09ICdpbmNsdWRlJykgewogICAgICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoJ3Jlc3BvbnNlVHlwZScgaW4geGhyICYmIHN1cHBvcnQuYmxvYikgewogICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9ICdibG9iJzsKICAgICAgICB9CgogICAgICAgIHJlcXVlc3QuaGVhZGVycy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwgbmFtZSkgewogICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIobmFtZSwgdmFsdWUpOwogICAgICAgIH0pOwogICAgICAgIHhoci5zZW5kKHR5cGVvZiByZXF1ZXN0Ll9ib2R5SW5pdCA9PT0gJ3VuZGVmaW5lZCcgPyBudWxsIDogcmVxdWVzdC5fYm9keUluaXQpOwogICAgICB9KTsKICAgIH07CgogICAgc2VsZi5mZXRjaC5wb2x5ZmlsbCA9IHRydWU7CiAgfSkodHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnID8gc2VsZiA6IHRoaXMpOwp9LDM4LFtdLCJ3aGF0d2ctZmV0Y2gvZmV0Y2guanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIGZ1bmN0aW9uIHN0cmluZ2lmeVNhZmUoYXJnKSB7CiAgICB2YXIgcmV0OwogICAgdmFyIHR5cGUgPSB0eXBlb2YgYXJnOwoKICAgIGlmIChhcmcgPT09IHVuZGVmaW5lZCkgewogICAgICByZXQgPSAndW5kZWZpbmVkJzsKICAgIH0gZWxzZSBpZiAoYXJnID09PSBudWxsKSB7CiAgICAgIHJldCA9ICdudWxsJzsKICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgcmV0ID0gJyInICsgYXJnICsgJyInOwogICAgfSBlbHNlIGlmICh0eXBlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0ID0gYXJnLnRvU3RyaW5nKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXQgPSAnW2Z1bmN0aW9uIHVua25vd25dJzsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdHJ5IHsKICAgICAgICByZXQgPSBKU09OLnN0cmluZ2lmeShhcmcpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBhcmcudG9TdHJpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldCA9IGFyZy50b1N0cmluZygpOwogICAgICAgICAgfSBjYXRjaCAoRSkge30KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmV0IHx8ICdbIicgKyB0eXBlICsgJyIgZmFpbGVkIHRvIHN0cmluZ2lmeV0nOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBzdHJpbmdpZnlTYWZlOwp9LDM5LFtdLCJzdHJpbmdpZnlTYWZlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX3JlcXVpcmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTmF0aXZlTW9kdWxlcyIpLAogICAgICBQbGF0Zm9ybUNvbnN0YW50cyA9IF9yZXF1aXJlLlBsYXRmb3JtQ29uc3RhbnRzOwoKICB2YXIgUmVhY3ROYXRpdmVWZXJzaW9uID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlJlYWN0TmF0aXZlVmVyc2lvbiIpOwoKICBleHBvcnRzLmNoZWNrVmVyc2lvbnMgPSBmdW5jdGlvbiBjaGVja1ZlcnNpb25zKCkgewogICAgaWYgKCFQbGF0Zm9ybUNvbnN0YW50cykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIG5hdGl2ZVZlcnNpb24gPSBQbGF0Zm9ybUNvbnN0YW50cy5yZWFjdE5hdGl2ZVZlcnNpb247CgogICAgaWYgKFJlYWN0TmF0aXZlVmVyc2lvbi52ZXJzaW9uLm1ham9yICE9PSBuYXRpdmVWZXJzaW9uLm1ham9yIHx8IFJlYWN0TmF0aXZlVmVyc2lvbi52ZXJzaW9uLm1pbm9yICE9PSBuYXRpdmVWZXJzaW9uLm1pbm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIlJlYWN0IE5hdGl2ZSB2ZXJzaW9uIG1pc21hdGNoLlxuXG5KYXZhU2NyaXB0IHZlcnNpb246ICIgKyBfZm9ybWF0VmVyc2lvbihSZWFjdE5hdGl2ZVZlcnNpb24udmVyc2lvbikgKyAiXG4iICsgKCJOYXRpdmUgdmVyc2lvbjogIiArIF9mb3JtYXRWZXJzaW9uKG5hdGl2ZVZlcnNpb24pICsgIlxuXG4iKSArICdNYWtlIHN1cmUgdGhhdCB5b3UgaGF2ZSByZWJ1aWx0IHRoZSBuYXRpdmUgY29kZS4gSWYgdGhlIHByb2JsZW0gJyArICdwZXJzaXN0cyB0cnkgY2xlYXJpbmcgdGhlIFdhdGNobWFuIGFuZCBwYWNrYWdlciBjYWNoZXMgd2l0aCAnICsgJ2B3YXRjaG1hbiB3YXRjaC1kZWwtYWxsICYmIHJlYWN0LW5hdGl2ZSBzdGFydCAtLXJlc2V0LWNhY2hlYC4nKTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiBfZm9ybWF0VmVyc2lvbih2ZXJzaW9uKSB7CiAgICByZXR1cm4gdmVyc2lvbi5tYWpvciArICIuIiArIHZlcnNpb24ubWlub3IgKyAiLiIgKyB2ZXJzaW9uLnBhdGNoICsgKHZlcnNpb24ucHJlcmVsZWFzZSAhPT0gbnVsbCA/ICItIiArIHZlcnNpb24ucHJlcmVsZWFzZSA6ICcnKTsKICB9Cn0sNDAsWzE1LDQxXSwiUmVhY3ROYXRpdmVWZXJzaW9uQ2hlY2siKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICBleHBvcnRzLnZlcnNpb24gPSB7CiAgICBtYWpvcjogMCwKICAgIG1pbm9yOiA1MiwKICAgIHBhdGNoOiAwLAogICAgcHJlcmVsZWFzZTogbnVsbAogIH07Cn0sNDEsW10sIlJlYWN0TmF0aXZlVmVyc2lvbiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFByb21pc2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiZmJqcy9saWIvUHJvbWlzZS5uYXRpdmUiKTsKCiAgaWYgKF9fREVWX18pIHsKICAgIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJwcm9taXNlL3NldGltbWVkaWF0ZS9yZWplY3Rpb24tdHJhY2tpbmciKS5lbmFibGUoewogICAgICBhbGxSZWplY3Rpb25zOiB0cnVlLAogICAgICBvblVuaGFuZGxlZDogZnVuY3Rpb24gb25VbmhhbmRsZWQoaWQpIHsKICAgICAgICB2YXIgZXJyb3IgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHt9OwogICAgICAgIHZhciBtZXNzYWdlID0gdm9pZCAwOwogICAgICAgIHZhciBzdGFjayA9IHZvaWQgMDsKICAgICAgICB2YXIgc3RyaW5nVmFsdWUgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZXJyb3IpOwoKICAgICAgICBpZiAoc3RyaW5nVmFsdWUgPT09ICdbb2JqZWN0IEVycm9yXScpIHsKICAgICAgICAgIG1lc3NhZ2UgPSBFcnJvci5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChlcnJvcik7CiAgICAgICAgICBzdGFjayA9IGVycm9yLnN0YWNrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtZXNzYWdlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgInByZXR0eS1mb3JtYXQiKShlcnJvcik7CiAgICAgICAgfQoKICAgICAgICB2YXIgd2FybmluZyA9ICJQb3NzaWJsZSBVbmhhbmRsZWQgUHJvbWlzZSBSZWplY3Rpb24gKGlkOiAiICsgaWQgKyAiKTpcbiIgKyAobWVzc2FnZSArICJcbiIpICsgKHN0YWNrID09IG51bGwgPyAnJyA6IHN0YWNrKTsKICAgICAgICBjb25zb2xlLndhcm4od2FybmluZyk7CiAgICAgIH0sCiAgICAgIG9uSGFuZGxlZDogZnVuY3Rpb24gb25IYW5kbGVkKGlkKSB7CiAgICAgICAgdmFyIHdhcm5pbmcgPSAiUHJvbWlzZSBSZWplY3Rpb24gSGFuZGxlZCAoaWQ6ICIgKyBpZCArICIpXG4iICsgJ1RoaXMgbWVhbnMgeW91IGNhbiBpZ25vcmUgYW55IHByZXZpb3VzIG1lc3NhZ2VzIG9mIHRoZSBmb3JtICcgKyAoIlwiUG9zc2libGUgVW5oYW5kbGVkIFByb21pc2UgUmVqZWN0aW9uIChpZDogIiArIGlkICsgIik6XCIiKTsKICAgICAgICBjb25zb2xlLndhcm4od2FybmluZyk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBQcm9taXNlOwp9LDQyLFs0Myw0Nyw0OF0sIlByb21pc2UiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBQcm9taXNlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgInByb21pc2Uvc2V0aW1tZWRpYXRlL2VzNi1leHRlbnNpb25zIik7CgogIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJwcm9taXNlL3NldGltbWVkaWF0ZS9kb25lIik7CgogIFByb21pc2UucHJvdG90eXBlWydmaW5hbGx5J10gPSBmdW5jdGlvbiAob25TZXR0bGVkKSB7CiAgICByZXR1cm4gdGhpcy50aGVuKG9uU2V0dGxlZCwgb25TZXR0bGVkKTsKICB9OwoKICBtb2R1bGUuZXhwb3J0cyA9IFByb21pc2U7Cn0sNDMsWzQ0LDQ2XSwiZmJqcy9saWIvUHJvbWlzZS5uYXRpdmUuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBQcm9taXNlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgJy4vY29yZS5qcycpOwoKICBtb2R1bGUuZXhwb3J0cyA9IFByb21pc2U7CiAgdmFyIFRSVUUgPSB2YWx1ZVByb21pc2UodHJ1ZSk7CiAgdmFyIEZBTFNFID0gdmFsdWVQcm9taXNlKGZhbHNlKTsKICB2YXIgTlVMTCA9IHZhbHVlUHJvbWlzZShudWxsKTsKICB2YXIgVU5ERUZJTkVEID0gdmFsdWVQcm9taXNlKHVuZGVmaW5lZCk7CiAgdmFyIFpFUk8gPSB2YWx1ZVByb21pc2UoMCk7CiAgdmFyIEVNUFRZU1RSSU5HID0gdmFsdWVQcm9taXNlKCcnKTsKCiAgZnVuY3Rpb24gdmFsdWVQcm9taXNlKHZhbHVlKSB7CiAgICB2YXIgcCA9IG5ldyBQcm9taXNlKFByb21pc2UuXzYxKTsKICAgIHAuXzY1ID0gMTsKICAgIHAuXzU1ID0gdmFsdWU7CiAgICByZXR1cm4gcDsKICB9CgogIFByb21pc2UucmVzb2x2ZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgUHJvbWlzZSkgcmV0dXJuIHZhbHVlOwogICAgaWYgKHZhbHVlID09PSBudWxsKSByZXR1cm4gTlVMTDsKICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gVU5ERUZJTkVEOwogICAgaWYgKHZhbHVlID09PSB0cnVlKSByZXR1cm4gVFJVRTsKICAgIGlmICh2YWx1ZSA9PT0gZmFsc2UpIHJldHVybiBGQUxTRTsKICAgIGlmICh2YWx1ZSA9PT0gMCkgcmV0dXJuIFpFUk87CiAgICBpZiAodmFsdWUgPT09ICcnKSByZXR1cm4gRU1QVFlTVFJJTkc7CgogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHRoZW4gPSB2YWx1ZS50aGVuOwoKICAgICAgICBpZiAodHlwZW9mIHRoZW4gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSh0aGVuLmJpbmQodmFsdWUpKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIHJlamVjdChleCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdmFsdWVQcm9taXNlKHZhbHVlKTsKICB9OwoKICBQcm9taXNlLmFsbCA9IGZ1bmN0aW9uIChhcnIpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJyKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHJlc29sdmUoW10pOwogICAgICB2YXIgcmVtYWluaW5nID0gYXJncy5sZW5ndGg7CgogICAgICBmdW5jdGlvbiByZXMoaSwgdmFsKSB7CiAgICAgICAgaWYgKHZhbCAmJiAodHlwZW9mIHZhbCA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIHZhbCA9PT0gJ2Z1bmN0aW9uJykpIHsKICAgICAgICAgIGlmICh2YWwgaW5zdGFuY2VvZiBQcm9taXNlICYmIHZhbC50aGVuID09PSBQcm9taXNlLnByb3RvdHlwZS50aGVuKSB7CiAgICAgICAgICAgIHdoaWxlICh2YWwuXzY1ID09PSAzKSB7CiAgICAgICAgICAgICAgdmFsID0gdmFsLl81NTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHZhbC5fNjUgPT09IDEpIHJldHVybiByZXMoaSwgdmFsLl81NSk7CiAgICAgICAgICAgIGlmICh2YWwuXzY1ID09PSAyKSByZWplY3QodmFsLl81NSk7CiAgICAgICAgICAgIHZhbC50aGVuKGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICByZXMoaSwgdmFsKTsKICAgICAgICAgICAgfSwgcmVqZWN0KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHRoZW4gPSB2YWwudGhlbjsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdGhlbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgIHZhciBwID0gbmV3IFByb21pc2UodGhlbi5iaW5kKHZhbCkpOwogICAgICAgICAgICAgIHAudGhlbihmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgICAgICByZXMoaSwgdmFsKTsKICAgICAgICAgICAgICB9LCByZWplY3QpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXJnc1tpXSA9IHZhbDsKCiAgICAgICAgaWYgKC0tcmVtYWluaW5nID09PSAwKSB7CiAgICAgICAgICByZXNvbHZlKGFyZ3MpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzKGksIGFyZ3NbaV0pOwogICAgICB9CiAgICB9KTsKICB9OwoKICBQcm9taXNlLnJlamVjdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgcmVqZWN0KHZhbHVlKTsKICAgIH0pOwogIH07CgogIFByb21pc2UucmFjZSA9IGZ1bmN0aW9uICh2YWx1ZXMpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHZhbHVlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSh2YWx1ZSkudGhlbihyZXNvbHZlLCByZWplY3QpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFByb21pc2UucHJvdG90eXBlWydjYXRjaCddID0gZnVuY3Rpb24gKG9uUmVqZWN0ZWQpIHsKICAgIHJldHVybiB0aGlzLnRoZW4obnVsbCwgb25SZWplY3RlZCk7CiAgfTsKfSw0NCxbNDVdLCJwcm9taXNlL3NldGltbWVkaWF0ZS9lczYtZXh0ZW5zaW9ucy5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZnVuY3Rpb24gbm9vcCgpIHt9CgogIHZhciBMQVNUX0VSUk9SID0gbnVsbDsKICB2YXIgSVNfRVJST1IgPSB7fTsKCiAgZnVuY3Rpb24gZ2V0VGhlbihvYmopIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBvYmoudGhlbjsKICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgIExBU1RfRVJST1IgPSBleDsKICAgICAgcmV0dXJuIElTX0VSUk9SOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdHJ5Q2FsbE9uZShmbiwgYSkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGZuKGEpOwogICAgfSBjYXRjaCAoZXgpIHsKICAgICAgTEFTVF9FUlJPUiA9IGV4OwogICAgICByZXR1cm4gSVNfRVJST1I7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0cnlDYWxsVHdvKGZuLCBhLCBiKSB7CiAgICB0cnkgewogICAgICBmbihhLCBiKTsKICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgIExBU1RfRVJST1IgPSBleDsKICAgICAgcmV0dXJuIElTX0VSUk9SOwogICAgfQogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBQcm9taXNlOwoKICBmdW5jdGlvbiBQcm9taXNlKGZuKSB7CiAgICBpZiAodHlwZW9mIHRoaXMgIT09ICdvYmplY3QnKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Byb21pc2VzIG11c3QgYmUgY29uc3RydWN0ZWQgdmlhIG5ldycpOwogICAgfQoKICAgIGlmICh0eXBlb2YgZm4gIT09ICdmdW5jdGlvbicpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignUHJvbWlzZSBjb25zdHJ1Y3RvclwncyBhcmd1bWVudCBpcyBub3QgYSBmdW5jdGlvbicpOwogICAgfQoKICAgIHRoaXMuXzQwID0gMDsKICAgIHRoaXMuXzY1ID0gMDsKICAgIHRoaXMuXzU1ID0gbnVsbDsKICAgIHRoaXMuXzcyID0gbnVsbDsKICAgIGlmIChmbiA9PT0gbm9vcCkgcmV0dXJuOwogICAgZG9SZXNvbHZlKGZuLCB0aGlzKTsKICB9CgogIFByb21pc2UuXzM3ID0gbnVsbDsKICBQcm9taXNlLl84NyA9IG51bGw7CiAgUHJvbWlzZS5fNjEgPSBub29wOwoKICBQcm9taXNlLnByb3RvdHlwZS50aGVuID0gZnVuY3Rpb24gKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKSB7CiAgICBpZiAodGhpcy5jb25zdHJ1Y3RvciAhPT0gUHJvbWlzZSkgewogICAgICByZXR1cm4gc2FmZVRoZW4odGhpcywgb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQpOwogICAgfQoKICAgIHZhciByZXMgPSBuZXcgUHJvbWlzZShub29wKTsKICAgIGhhbmRsZSh0aGlzLCBuZXcgSGFuZGxlcihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgcmVzKSk7CiAgICByZXR1cm4gcmVzOwogIH07CgogIGZ1bmN0aW9uIHNhZmVUaGVuKHNlbGYsIG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKSB7CiAgICByZXR1cm4gbmV3IHNlbGYuY29uc3RydWN0b3IoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICB2YXIgcmVzID0gbmV3IFByb21pc2Uobm9vcCk7CiAgICAgIHJlcy50aGVuKHJlc29sdmUsIHJlamVjdCk7CiAgICAgIGhhbmRsZShzZWxmLCBuZXcgSGFuZGxlcihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgcmVzKSk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGhhbmRsZShzZWxmLCBkZWZlcnJlZCkgewogICAgd2hpbGUgKHNlbGYuXzY1ID09PSAzKSB7CiAgICAgIHNlbGYgPSBzZWxmLl81NTsKICAgIH0KCiAgICBpZiAoUHJvbWlzZS5fMzcpIHsKICAgICAgUHJvbWlzZS5fMzcoc2VsZik7CiAgICB9CgogICAgaWYgKHNlbGYuXzY1ID09PSAwKSB7CiAgICAgIGlmIChzZWxmLl80MCA9PT0gMCkgewogICAgICAgIHNlbGYuXzQwID0gMTsKICAgICAgICBzZWxmLl83MiA9IGRlZmVycmVkOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHNlbGYuXzQwID09PSAxKSB7CiAgICAgICAgc2VsZi5fNDAgPSAyOwogICAgICAgIHNlbGYuXzcyID0gW3NlbGYuXzcyLCBkZWZlcnJlZF07CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBzZWxmLl83Mi5wdXNoKGRlZmVycmVkKTsKCiAgICAgIHJldHVybjsKICAgIH0KCiAgICBoYW5kbGVSZXNvbHZlZChzZWxmLCBkZWZlcnJlZCk7CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVSZXNvbHZlZChzZWxmLCBkZWZlcnJlZCkgewogICAgc2V0SW1tZWRpYXRlKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNiID0gc2VsZi5fNjUgPT09IDEgPyBkZWZlcnJlZC5vbkZ1bGZpbGxlZCA6IGRlZmVycmVkLm9uUmVqZWN0ZWQ7CgogICAgICBpZiAoY2IgPT09IG51bGwpIHsKICAgICAgICBpZiAoc2VsZi5fNjUgPT09IDEpIHsKICAgICAgICAgIHJlc29sdmUoZGVmZXJyZWQucHJvbWlzZSwgc2VsZi5fNTUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZWplY3QoZGVmZXJyZWQucHJvbWlzZSwgc2VsZi5fNTUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcmV0ID0gdHJ5Q2FsbE9uZShjYiwgc2VsZi5fNTUpOwoKICAgICAgaWYgKHJldCA9PT0gSVNfRVJST1IpIHsKICAgICAgICByZWplY3QoZGVmZXJyZWQucHJvbWlzZSwgTEFTVF9FUlJPUik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzb2x2ZShkZWZlcnJlZC5wcm9taXNlLCByZXQpOwogICAgICB9CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHJlc29sdmUoc2VsZiwgbmV3VmFsdWUpIHsKICAgIGlmIChuZXdWYWx1ZSA9PT0gc2VsZikgewogICAgICByZXR1cm4gcmVqZWN0KHNlbGYsIG5ldyBUeXBlRXJyb3IoJ0EgcHJvbWlzZSBjYW5ub3QgYmUgcmVzb2x2ZWQgd2l0aCBpdHNlbGYuJykpOwogICAgfQoKICAgIGlmIChuZXdWYWx1ZSAmJiAodHlwZW9mIG5ld1ZhbHVlID09PSAnb2JqZWN0JyB8fCB0eXBlb2YgbmV3VmFsdWUgPT09ICdmdW5jdGlvbicpKSB7CiAgICAgIHZhciB0aGVuID0gZ2V0VGhlbihuZXdWYWx1ZSk7CgogICAgICBpZiAodGhlbiA9PT0gSVNfRVJST1IpIHsKICAgICAgICByZXR1cm4gcmVqZWN0KHNlbGYsIExBU1RfRVJST1IpOwogICAgICB9CgogICAgICBpZiAodGhlbiA9PT0gc2VsZi50aGVuICYmIG5ld1ZhbHVlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgIHNlbGYuXzY1ID0gMzsKICAgICAgICBzZWxmLl81NSA9IG5ld1ZhbHVlOwogICAgICAgIGZpbmFsZShzZWxmKTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRoZW4gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBkb1Jlc29sdmUodGhlbi5iaW5kKG5ld1ZhbHVlKSwgc2VsZik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CgogICAgc2VsZi5fNjUgPSAxOwogICAgc2VsZi5fNTUgPSBuZXdWYWx1ZTsKICAgIGZpbmFsZShzZWxmKTsKICB9CgogIGZ1bmN0aW9uIHJlamVjdChzZWxmLCBuZXdWYWx1ZSkgewogICAgc2VsZi5fNjUgPSAyOwogICAgc2VsZi5fNTUgPSBuZXdWYWx1ZTsKCiAgICBpZiAoUHJvbWlzZS5fODcpIHsKICAgICAgUHJvbWlzZS5fODcoc2VsZiwgbmV3VmFsdWUpOwogICAgfQoKICAgIGZpbmFsZShzZWxmKTsKICB9CgogIGZ1bmN0aW9uIGZpbmFsZShzZWxmKSB7CiAgICBpZiAoc2VsZi5fNDAgPT09IDEpIHsKICAgICAgaGFuZGxlKHNlbGYsIHNlbGYuXzcyKTsKICAgICAgc2VsZi5fNzIgPSBudWxsOwogICAgfQoKICAgIGlmIChzZWxmLl80MCA9PT0gMikgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlbGYuXzcyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaGFuZGxlKHNlbGYsIHNlbGYuXzcyW2ldKTsKICAgICAgfQoKICAgICAgc2VsZi5fNzIgPSBudWxsOwogICAgfQogIH0KCiAgZnVuY3Rpb24gSGFuZGxlcihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgcHJvbWlzZSkgewogICAgdGhpcy5vbkZ1bGZpbGxlZCA9IHR5cGVvZiBvbkZ1bGZpbGxlZCA9PT0gJ2Z1bmN0aW9uJyA/IG9uRnVsZmlsbGVkIDogbnVsbDsKICAgIHRoaXMub25SZWplY3RlZCA9IHR5cGVvZiBvblJlamVjdGVkID09PSAnZnVuY3Rpb24nID8gb25SZWplY3RlZCA6IG51bGw7CiAgICB0aGlzLnByb21pc2UgPSBwcm9taXNlOwogIH0KCiAgZnVuY3Rpb24gZG9SZXNvbHZlKGZuLCBwcm9taXNlKSB7CiAgICB2YXIgZG9uZSA9IGZhbHNlOwogICAgdmFyIHJlcyA9IHRyeUNhbGxUd28oZm4sIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICBpZiAoZG9uZSkgcmV0dXJuOwogICAgICBkb25lID0gdHJ1ZTsKICAgICAgcmVzb2x2ZShwcm9taXNlLCB2YWx1ZSk7CiAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgIGRvbmUgPSB0cnVlOwogICAgICByZWplY3QocHJvbWlzZSwgcmVhc29uKTsKICAgIH0pOwoKICAgIGlmICghZG9uZSAmJiByZXMgPT09IElTX0VSUk9SKSB7CiAgICAgIGRvbmUgPSB0cnVlOwogICAgICByZWplY3QocHJvbWlzZSwgTEFTVF9FUlJPUik7CiAgICB9CiAgfQp9LDQ1LFtdLCJwcm9taXNlL3NldGltbWVkaWF0ZS9jb3JlLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgUHJvbWlzZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL2NvcmUuanMnKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBQcm9taXNlOwoKICBQcm9taXNlLnByb3RvdHlwZS5kb25lID0gZnVuY3Rpb24gKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKSB7CiAgICB2YXIgc2VsZiA9IGFyZ3VtZW50cy5sZW5ndGggPyB0aGlzLnRoZW4uYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IHRoaXM7CiAgICBzZWxmLnRoZW4obnVsbCwgZnVuY3Rpb24gKGVycikgewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICB0aHJvdyBlcnI7CiAgICAgIH0sIDApOwogICAgfSk7CiAgfTsKfSw0NixbNDVdLCJwcm9taXNlL3NldGltbWVkaWF0ZS9kb25lLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgUHJvbWlzZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL2NvcmUnKTsKCiAgdmFyIERFRkFVTFRfV0hJVEVMSVNUID0gW1JlZmVyZW5jZUVycm9yLCBUeXBlRXJyb3IsIFJhbmdlRXJyb3JdOwogIHZhciBlbmFibGVkID0gZmFsc2U7CiAgZXhwb3J0cy5kaXNhYmxlID0gZGlzYWJsZTsKCiAgZnVuY3Rpb24gZGlzYWJsZSgpIHsKICAgIGVuYWJsZWQgPSBmYWxzZTsKICAgIFByb21pc2UuXzM3ID0gbnVsbDsKICAgIFByb21pc2UuXzg3ID0gbnVsbDsKICB9CgogIGV4cG9ydHMuZW5hYmxlID0gZW5hYmxlOwoKICBmdW5jdGlvbiBlbmFibGUob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBpZiAoZW5hYmxlZCkgZGlzYWJsZSgpOwogICAgZW5hYmxlZCA9IHRydWU7CiAgICB2YXIgaWQgPSAwOwogICAgdmFyIGRpc3BsYXlJZCA9IDA7CiAgICB2YXIgcmVqZWN0aW9ucyA9IHt9OwoKICAgIFByb21pc2UuXzM3ID0gZnVuY3Rpb24gKHByb21pc2UpIHsKICAgICAgaWYgKHByb21pc2UuXzY1ID09PSAyICYmIHJlamVjdGlvbnNbcHJvbWlzZS5fNTFdKSB7CiAgICAgICAgaWYgKHJlamVjdGlvbnNbcHJvbWlzZS5fNTFdLmxvZ2dlZCkgewogICAgICAgICAgb25IYW5kbGVkKHByb21pc2UuXzUxKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHJlamVjdGlvbnNbcHJvbWlzZS5fNTFdLnRpbWVvdXQpOwogICAgICAgIH0KCiAgICAgICAgZGVsZXRlIHJlamVjdGlvbnNbcHJvbWlzZS5fNTFdOwogICAgICB9CiAgICB9OwoKICAgIFByb21pc2UuXzg3ID0gZnVuY3Rpb24gKHByb21pc2UsIGVycikgewogICAgICBpZiAocHJvbWlzZS5fNDAgPT09IDApIHsKICAgICAgICBwcm9taXNlLl81MSA9IGlkKys7CiAgICAgICAgcmVqZWN0aW9uc1twcm9taXNlLl81MV0gPSB7CiAgICAgICAgICBkaXNwbGF5SWQ6IG51bGwsCiAgICAgICAgICBlcnJvcjogZXJyLAogICAgICAgICAgdGltZW91dDogc2V0VGltZW91dChvblVuaGFuZGxlZC5iaW5kKG51bGwsIHByb21pc2UuXzUxKSwgbWF0Y2hXaGl0ZWxpc3QoZXJyLCBERUZBVUxUX1dISVRFTElTVCkgPyAxMDAgOiAyMDAwKSwKICAgICAgICAgIGxvZ2dlZDogZmFsc2UKICAgICAgICB9OwogICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIG9uVW5oYW5kbGVkKGlkKSB7CiAgICAgIGlmIChvcHRpb25zLmFsbFJlamVjdGlvbnMgfHwgbWF0Y2hXaGl0ZWxpc3QocmVqZWN0aW9uc1tpZF0uZXJyb3IsIG9wdGlvbnMud2hpdGVsaXN0IHx8IERFRkFVTFRfV0hJVEVMSVNUKSkgewogICAgICAgIHJlamVjdGlvbnNbaWRdLmRpc3BsYXlJZCA9IGRpc3BsYXlJZCsrOwoKICAgICAgICBpZiAob3B0aW9ucy5vblVuaGFuZGxlZCkgewogICAgICAgICAgcmVqZWN0aW9uc1tpZF0ubG9nZ2VkID0gdHJ1ZTsKICAgICAgICAgIG9wdGlvbnMub25VbmhhbmRsZWQocmVqZWN0aW9uc1tpZF0uZGlzcGxheUlkLCByZWplY3Rpb25zW2lkXS5lcnJvcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlamVjdGlvbnNbaWRdLmxvZ2dlZCA9IHRydWU7CiAgICAgICAgICBsb2dFcnJvcihyZWplY3Rpb25zW2lkXS5kaXNwbGF5SWQsIHJlamVjdGlvbnNbaWRdLmVycm9yKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBvbkhhbmRsZWQoaWQpIHsKICAgICAgaWYgKHJlamVjdGlvbnNbaWRdLmxvZ2dlZCkgewogICAgICAgIGlmIChvcHRpb25zLm9uSGFuZGxlZCkgewogICAgICAgICAgb3B0aW9ucy5vbkhhbmRsZWQocmVqZWN0aW9uc1tpZF0uZGlzcGxheUlkLCByZWplY3Rpb25zW2lkXS5lcnJvcik7CiAgICAgICAgfSBlbHNlIGlmICghcmVqZWN0aW9uc1tpZF0ub25VbmhhbmRsZWQpIHsKICAgICAgICAgIGNvbnNvbGUud2FybignUHJvbWlzZSBSZWplY3Rpb24gSGFuZGxlZCAoaWQ6ICcgKyByZWplY3Rpb25zW2lkXS5kaXNwbGF5SWQgKyAnKTonKTsKICAgICAgICAgIGNvbnNvbGUud2FybignICBUaGlzIG1lYW5zIHlvdSBjYW4gaWdub3JlIGFueSBwcmV2aW91cyBtZXNzYWdlcyBvZiB0aGUgZm9ybSAiUG9zc2libGUgVW5oYW5kbGVkIFByb21pc2UgUmVqZWN0aW9uIiB3aXRoIGlkICcgKyByZWplY3Rpb25zW2lkXS5kaXNwbGF5SWQgKyAnLicpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gbG9nRXJyb3IoaWQsIGVycm9yKSB7CiAgICBjb25zb2xlLndhcm4oJ1Bvc3NpYmxlIFVuaGFuZGxlZCBQcm9taXNlIFJlamVjdGlvbiAoaWQ6ICcgKyBpZCArICcpOicpOwogICAgdmFyIGVyclN0ciA9IChlcnJvciAmJiAoZXJyb3Iuc3RhY2sgfHwgZXJyb3IpKSArICcnOwogICAgZXJyU3RyLnNwbGl0KCdcbicpLmZvckVhY2goZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgY29uc29sZS53YXJuKCcgICcgKyBsaW5lKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gbWF0Y2hXaGl0ZWxpc3QoZXJyb3IsIGxpc3QpIHsKICAgIHJldHVybiBsaXN0LnNvbWUoZnVuY3Rpb24gKGNscykgewogICAgICByZXR1cm4gZXJyb3IgaW5zdGFuY2VvZiBjbHM7CiAgICB9KTsKICB9Cn0sNDcsWzQ1XSwicHJvbWlzZS9zZXRpbW1lZGlhdGUvcmVqZWN0aW9uLXRyYWNraW5nLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgcHJpbnRTdHJpbmcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9wcmludFN0cmluZycpOwoKICB2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogIHZhciB0b0lTT1N0cmluZyA9IERhdGUucHJvdG90eXBlLnRvSVNPU3RyaW5nOwogIHZhciBlcnJvclRvU3RyaW5nID0gRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nOwogIHZhciByZWdFeHBUb1N0cmluZyA9IFJlZ0V4cC5wcm90b3R5cGUudG9TdHJpbmc7CiAgdmFyIHN5bWJvbFRvU3RyaW5nID0gKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wucHJvdG90eXBlIDogIkBAcHJvdG90eXBlIikudG9TdHJpbmc7CiAgdmFyIFNZTUJPTF9SRUdFWFAgPSAvXlN5bWJvbFwoKC4qKVwpKC4qKSQvOwogIHZhciBORVdMSU5FX1JFR0VYUCA9IC9cbi9pZzsKCiAgdmFyIGdldFN5bWJvbHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzIHx8IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBbXTsKICB9OwoKICBmdW5jdGlvbiBpc1RvU3RyaW5nZWRBcnJheVR5cGUodG9TdHJpbmdlZCkgewogICAgcmV0dXJuIHRvU3RyaW5nZWQgPT09ICdbb2JqZWN0IEFycmF5XScgfHwgdG9TdHJpbmdlZCA9PT0gJ1tvYmplY3QgQXJyYXlCdWZmZXJdJyB8fCB0b1N0cmluZ2VkID09PSAnW29iamVjdCBEYXRhVmlld10nIHx8IHRvU3RyaW5nZWQgPT09ICdbb2JqZWN0IEZsb2F0MzJBcnJheV0nIHx8IHRvU3RyaW5nZWQgPT09ICdbb2JqZWN0IEZsb2F0NjRBcnJheV0nIHx8IHRvU3RyaW5nZWQgPT09ICdbb2JqZWN0IEludDhBcnJheV0nIHx8IHRvU3RyaW5nZWQgPT09ICdbb2JqZWN0IEludDE2QXJyYXldJyB8fCB0b1N0cmluZ2VkID09PSAnW29iamVjdCBJbnQzMkFycmF5XScgfHwgdG9TdHJpbmdlZCA9PT0gJ1tvYmplY3QgVWludDhBcnJheV0nIHx8IHRvU3RyaW5nZWQgPT09ICdbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XScgfHwgdG9TdHJpbmdlZCA9PT0gJ1tvYmplY3QgVWludDE2QXJyYXldJyB8fCB0b1N0cmluZ2VkID09PSAnW29iamVjdCBVaW50MzJBcnJheV0nOwogIH0KCiAgZnVuY3Rpb24gcHJpbnROdW1iZXIodmFsKSB7CiAgICBpZiAodmFsICE9ICt2YWwpIHJldHVybiAnTmFOJzsKICAgIHZhciBpc05lZ2F0aXZlWmVybyA9IHZhbCA9PT0gMCAmJiAxIC8gdmFsIDwgMDsKICAgIHJldHVybiBpc05lZ2F0aXZlWmVybyA/ICctMCcgOiAnJyArIHZhbDsKICB9CgogIGZ1bmN0aW9uIHByaW50RnVuY3Rpb24odmFsLCBwcmludEZ1bmN0aW9uTmFtZSkgewogICAgaWYgKCFwcmludEZ1bmN0aW9uTmFtZSkgewogICAgICByZXR1cm4gJ1tGdW5jdGlvbl0nOwogICAgfSBlbHNlIGlmICh2YWwubmFtZSA9PT0gJycpIHsKICAgICAgcmV0dXJuICdbRnVuY3Rpb24gYW5vbnltb3VzXSc7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gJ1tGdW5jdGlvbiAnICsgdmFsLm5hbWUgKyAnXSc7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwcmludFN5bWJvbCh2YWwpIHsKICAgIHJldHVybiBzeW1ib2xUb1N0cmluZy5jYWxsKHZhbCkucmVwbGFjZShTWU1CT0xfUkVHRVhQLCAnU3ltYm9sKCQxKScpOwogIH0KCiAgZnVuY3Rpb24gcHJpbnRFcnJvcih2YWwpIHsKICAgIHJldHVybiAnWycgKyBlcnJvclRvU3RyaW5nLmNhbGwodmFsKSArICddJzsKICB9CgogIGZ1bmN0aW9uIHByaW50QmFzaWNWYWx1ZSh2YWwsIHByaW50RnVuY3Rpb25OYW1lLCBlc2NhcGVSZWdleCkgewogICAgaWYgKHZhbCA9PT0gdHJ1ZSB8fCB2YWwgPT09IGZhbHNlKSByZXR1cm4gJycgKyB2YWw7CiAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHJldHVybiAndW5kZWZpbmVkJzsKICAgIGlmICh2YWwgPT09IG51bGwpIHJldHVybiAnbnVsbCc7CiAgICB2YXIgdHlwZU9mID0gdHlwZW9mIHZhbDsKICAgIGlmICh0eXBlT2YgPT09ICdudW1iZXInKSByZXR1cm4gcHJpbnROdW1iZXIodmFsKTsKICAgIGlmICh0eXBlT2YgPT09ICdzdHJpbmcnKSByZXR1cm4gJyInICsgcHJpbnRTdHJpbmcodmFsKSArICciJzsKICAgIGlmICh0eXBlT2YgPT09ICdmdW5jdGlvbicpIHJldHVybiBwcmludEZ1bmN0aW9uKHZhbCwgcHJpbnRGdW5jdGlvbk5hbWUpOwogICAgaWYgKHR5cGVPZiA9PT0gJ3N5bWJvbCcpIHJldHVybiBwcmludFN5bWJvbCh2YWwpOwogICAgdmFyIHRvU3RyaW5nZWQgPSB0b1N0cmluZy5jYWxsKHZhbCk7CiAgICBpZiAodG9TdHJpbmdlZCA9PT0gJ1tvYmplY3QgV2Vha01hcF0nKSByZXR1cm4gJ1dlYWtNYXAge30nOwogICAgaWYgKHRvU3RyaW5nZWQgPT09ICdbb2JqZWN0IFdlYWtTZXRdJykgcmV0dXJuICdXZWFrU2V0IHt9JzsKICAgIGlmICh0b1N0cmluZ2VkID09PSAnW29iamVjdCBGdW5jdGlvbl0nIHx8IHRvU3RyaW5nZWQgPT09ICdbb2JqZWN0IEdlbmVyYXRvckZ1bmN0aW9uXScpIHJldHVybiBwcmludEZ1bmN0aW9uKHZhbCwgcHJpbnRGdW5jdGlvbk5hbWUpOwogICAgaWYgKHRvU3RyaW5nZWQgPT09ICdbb2JqZWN0IFN5bWJvbF0nKSByZXR1cm4gcHJpbnRTeW1ib2wodmFsKTsKICAgIGlmICh0b1N0cmluZ2VkID09PSAnW29iamVjdCBEYXRlXScpIHJldHVybiB0b0lTT1N0cmluZy5jYWxsKHZhbCk7CiAgICBpZiAodG9TdHJpbmdlZCA9PT0gJ1tvYmplY3QgRXJyb3JdJykgcmV0dXJuIHByaW50RXJyb3IodmFsKTsKCiAgICBpZiAodG9TdHJpbmdlZCA9PT0gJ1tvYmplY3QgUmVnRXhwXScpIHsKICAgICAgaWYgKGVzY2FwZVJlZ2V4KSB7CiAgICAgICAgcmV0dXJuIHByaW50U3RyaW5nKHJlZ0V4cFRvU3RyaW5nLmNhbGwodmFsKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZWdFeHBUb1N0cmluZy5jYWxsKHZhbCk7CiAgICB9CgogICAgOwogICAgaWYgKHRvU3RyaW5nZWQgPT09ICdbb2JqZWN0IEFyZ3VtZW50c10nICYmIHZhbC5sZW5ndGggPT09IDApIHJldHVybiAnQXJndW1lbnRzIFtdJzsKICAgIGlmIChpc1RvU3RyaW5nZWRBcnJheVR5cGUodG9TdHJpbmdlZCkgJiYgdmFsLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHZhbC5jb25zdHJ1Y3Rvci5uYW1lICsgJyBbXSc7CiAgICBpZiAodmFsIGluc3RhbmNlb2YgRXJyb3IpIHJldHVybiBwcmludEVycm9yKHZhbCk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBwcmludExpc3QobGlzdCwgaW5kZW50LCBwcmV2SW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpIHsKICAgIHZhciBib2R5ID0gJyc7CgogICAgaWYgKGxpc3QubGVuZ3RoKSB7CiAgICAgIGJvZHkgKz0gZWRnZVNwYWNpbmc7CiAgICAgIHZhciBpbm5lckluZGVudCA9IHByZXZJbmRlbnQgKyBpbmRlbnQ7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICBib2R5ICs9IGlubmVySW5kZW50ICsgcHJpbnQobGlzdFtpXSwgaW5kZW50LCBpbm5lckluZGVudCwgc3BhY2luZywgZWRnZVNwYWNpbmcsIHJlZnMsIG1heERlcHRoLCBjdXJyZW50RGVwdGgsIHBsdWdpbnMsIG1pbiwgY2FsbFRvSlNPTiwgcHJpbnRGdW5jdGlvbk5hbWUsIGVzY2FwZVJlZ2V4KTsKCiAgICAgICAgaWYgKGkgPCBsaXN0Lmxlbmd0aCAtIDEpIHsKICAgICAgICAgIGJvZHkgKz0gJywnICsgc3BhY2luZzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGJvZHkgKz0gKG1pbiA/ICcnIDogJywnKSArIGVkZ2VTcGFjaW5nICsgcHJldkluZGVudDsKICAgIH0KCiAgICByZXR1cm4gJ1snICsgYm9keSArICddJzsKICB9CgogIGZ1bmN0aW9uIHByaW50QXJndW1lbnRzKHZhbCwgaW5kZW50LCBwcmV2SW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpIHsKICAgIHJldHVybiAobWluID8gJycgOiAnQXJndW1lbnRzICcpICsgcHJpbnRMaXN0KHZhbCwgaW5kZW50LCBwcmV2SW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpOwogIH0KCiAgZnVuY3Rpb24gcHJpbnRBcnJheSh2YWwsIGluZGVudCwgcHJldkluZGVudCwgc3BhY2luZywgZWRnZVNwYWNpbmcsIHJlZnMsIG1heERlcHRoLCBjdXJyZW50RGVwdGgsIHBsdWdpbnMsIG1pbiwgY2FsbFRvSlNPTiwgcHJpbnRGdW5jdGlvbk5hbWUsIGVzY2FwZVJlZ2V4KSB7CiAgICByZXR1cm4gKG1pbiA/ICcnIDogdmFsLmNvbnN0cnVjdG9yLm5hbWUgKyAnICcpICsgcHJpbnRMaXN0KHZhbCwgaW5kZW50LCBwcmV2SW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpOwogIH0KCiAgZnVuY3Rpb24gcHJpbnRNYXAodmFsLCBpbmRlbnQsIHByZXZJbmRlbnQsIHNwYWNpbmcsIGVkZ2VTcGFjaW5nLCByZWZzLCBtYXhEZXB0aCwgY3VycmVudERlcHRoLCBwbHVnaW5zLCBtaW4sIGNhbGxUb0pTT04sIHByaW50RnVuY3Rpb25OYW1lLCBlc2NhcGVSZWdleCkgewogICAgdmFyIHJlc3VsdCA9ICdNYXAgeyc7CiAgICB2YXIgaXRlcmF0b3IgPSB2YWwuZW50cmllcygpOwogICAgdmFyIGN1cnJlbnQgPSBpdGVyYXRvci5uZXh0KCk7CgogICAgaWYgKCFjdXJyZW50LmRvbmUpIHsKICAgICAgcmVzdWx0ICs9IGVkZ2VTcGFjaW5nOwogICAgICB2YXIgaW5uZXJJbmRlbnQgPSBwcmV2SW5kZW50ICsgaW5kZW50OwoKICAgICAgd2hpbGUgKCFjdXJyZW50LmRvbmUpIHsKICAgICAgICB2YXIga2V5ID0gcHJpbnQoY3VycmVudC52YWx1ZVswXSwgaW5kZW50LCBpbm5lckluZGVudCwgc3BhY2luZywgZWRnZVNwYWNpbmcsIHJlZnMsIG1heERlcHRoLCBjdXJyZW50RGVwdGgsIHBsdWdpbnMsIG1pbiwgY2FsbFRvSlNPTiwgcHJpbnRGdW5jdGlvbk5hbWUsIGVzY2FwZVJlZ2V4KTsKICAgICAgICB2YXIgdmFsdWUgPSBwcmludChjdXJyZW50LnZhbHVlWzFdLCBpbmRlbnQsIGlubmVySW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpOwogICAgICAgIHJlc3VsdCArPSBpbm5lckluZGVudCArIGtleSArICcgPT4gJyArIHZhbHVlOwogICAgICAgIGN1cnJlbnQgPSBpdGVyYXRvci5uZXh0KCk7CgogICAgICAgIGlmICghY3VycmVudC5kb25lKSB7CiAgICAgICAgICByZXN1bHQgKz0gJywnICsgc3BhY2luZzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJlc3VsdCArPSAobWluID8gJycgOiAnLCcpICsgZWRnZVNwYWNpbmcgKyBwcmV2SW5kZW50OwogICAgfQoKICAgIHJldHVybiByZXN1bHQgKyAnfSc7CiAgfQoKICBmdW5jdGlvbiBwcmludE9iamVjdCh2YWwsIGluZGVudCwgcHJldkluZGVudCwgc3BhY2luZywgZWRnZVNwYWNpbmcsIHJlZnMsIG1heERlcHRoLCBjdXJyZW50RGVwdGgsIHBsdWdpbnMsIG1pbiwgY2FsbFRvSlNPTiwgcHJpbnRGdW5jdGlvbk5hbWUsIGVzY2FwZVJlZ2V4KSB7CiAgICB2YXIgY29uc3RydWN0b3IgPSBtaW4gPyAnJyA6IHZhbC5jb25zdHJ1Y3RvciA/IHZhbC5jb25zdHJ1Y3Rvci5uYW1lICsgJyAnIDogJ09iamVjdCAnOwogICAgdmFyIHJlc3VsdCA9IGNvbnN0cnVjdG9yICsgJ3snOwogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh2YWwpLnNvcnQoKTsKICAgIHZhciBzeW1ib2xzID0gZ2V0U3ltYm9scyh2YWwpOwoKICAgIGlmIChzeW1ib2xzLmxlbmd0aCkgewogICAgICBrZXlzID0ga2V5cy5maWx0ZXIoZnVuY3Rpb24gKGtleSkgewogICAgICAgIHJldHVybiAhKHR5cGVvZiBrZXkgPT09ICdzeW1ib2wnIHx8IHRvU3RyaW5nLmNhbGwoa2V5KSA9PT0gJ1tvYmplY3QgU3ltYm9sXScpOwogICAgICB9KS5jb25jYXQoc3ltYm9scyk7CiAgICB9CgogICAgaWYgKGtleXMubGVuZ3RoKSB7CiAgICAgIHJlc3VsdCArPSBlZGdlU3BhY2luZzsKICAgICAgdmFyIGlubmVySW5kZW50ID0gcHJldkluZGVudCArIGluZGVudDsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgIHZhciBuYW1lID0gcHJpbnQoa2V5LCBpbmRlbnQsIGlubmVySW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpOwogICAgICAgIHZhciB2YWx1ZSA9IHByaW50KHZhbFtrZXldLCBpbmRlbnQsIGlubmVySW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpOwogICAgICAgIHJlc3VsdCArPSBpbm5lckluZGVudCArIG5hbWUgKyAnOiAnICsgdmFsdWU7CgogICAgICAgIGlmIChpIDwga2V5cy5sZW5ndGggLSAxKSB7CiAgICAgICAgICByZXN1bHQgKz0gJywnICsgc3BhY2luZzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJlc3VsdCArPSAobWluID8gJycgOiAnLCcpICsgZWRnZVNwYWNpbmcgKyBwcmV2SW5kZW50OwogICAgfQoKICAgIHJldHVybiByZXN1bHQgKyAnfSc7CiAgfQoKICBmdW5jdGlvbiBwcmludFNldCh2YWwsIGluZGVudCwgcHJldkluZGVudCwgc3BhY2luZywgZWRnZVNwYWNpbmcsIHJlZnMsIG1heERlcHRoLCBjdXJyZW50RGVwdGgsIHBsdWdpbnMsIG1pbiwgY2FsbFRvSlNPTiwgcHJpbnRGdW5jdGlvbk5hbWUsIGVzY2FwZVJlZ2V4KSB7CiAgICB2YXIgcmVzdWx0ID0gJ1NldCB7JzsKICAgIHZhciBpdGVyYXRvciA9IHZhbC5lbnRyaWVzKCk7CiAgICB2YXIgY3VycmVudCA9IGl0ZXJhdG9yLm5leHQoKTsKCiAgICBpZiAoIWN1cnJlbnQuZG9uZSkgewogICAgICByZXN1bHQgKz0gZWRnZVNwYWNpbmc7CiAgICAgIHZhciBpbm5lckluZGVudCA9IHByZXZJbmRlbnQgKyBpbmRlbnQ7CgogICAgICB3aGlsZSAoIWN1cnJlbnQuZG9uZSkgewogICAgICAgIHJlc3VsdCArPSBpbm5lckluZGVudCArIHByaW50KGN1cnJlbnQudmFsdWVbMV0sIGluZGVudCwgaW5uZXJJbmRlbnQsIHNwYWNpbmcsIGVkZ2VTcGFjaW5nLCByZWZzLCBtYXhEZXB0aCwgY3VycmVudERlcHRoLCBwbHVnaW5zLCBtaW4sIGNhbGxUb0pTT04sIHByaW50RnVuY3Rpb25OYW1lLCBlc2NhcGVSZWdleCk7CiAgICAgICAgY3VycmVudCA9IGl0ZXJhdG9yLm5leHQoKTsKCiAgICAgICAgaWYgKCFjdXJyZW50LmRvbmUpIHsKICAgICAgICAgIHJlc3VsdCArPSAnLCcgKyBzcGFjaW5nOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmVzdWx0ICs9IChtaW4gPyAnJyA6ICcsJykgKyBlZGdlU3BhY2luZyArIHByZXZJbmRlbnQ7CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdCArICd9JzsKICB9CgogIGZ1bmN0aW9uIHByaW50Q29tcGxleFZhbHVlKHZhbCwgaW5kZW50LCBwcmV2SW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpIHsKICAgIHJlZnMgPSByZWZzLnNsaWNlKCk7CgogICAgaWYgKHJlZnMuaW5kZXhPZih2YWwpID4gLTEpIHsKICAgICAgcmV0dXJuICdbQ2lyY3VsYXJdJzsKICAgIH0gZWxzZSB7CiAgICAgIHJlZnMucHVzaCh2YWwpOwogICAgfQoKICAgIGN1cnJlbnREZXB0aCsrOwogICAgdmFyIGhpdE1heERlcHRoID0gY3VycmVudERlcHRoID4gbWF4RGVwdGg7CgogICAgaWYgKGNhbGxUb0pTT04gJiYgIWhpdE1heERlcHRoICYmIHZhbC50b0pTT04gJiYgdHlwZW9mIHZhbC50b0pTT04gPT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIHByaW50KHZhbC50b0pTT04oKSwgaW5kZW50LCBwcmV2SW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpOwogICAgfQoKICAgIHZhciB0b1N0cmluZ2VkID0gdG9TdHJpbmcuY2FsbCh2YWwpOwoKICAgIGlmICh0b1N0cmluZ2VkID09PSAnW29iamVjdCBBcmd1bWVudHNdJykgewogICAgICByZXR1cm4gaGl0TWF4RGVwdGggPyAnW0FyZ3VtZW50c10nIDogcHJpbnRBcmd1bWVudHModmFsLCBpbmRlbnQsIHByZXZJbmRlbnQsIHNwYWNpbmcsIGVkZ2VTcGFjaW5nLCByZWZzLCBtYXhEZXB0aCwgY3VycmVudERlcHRoLCBwbHVnaW5zLCBtaW4sIGNhbGxUb0pTT04sIHByaW50RnVuY3Rpb25OYW1lLCBlc2NhcGVSZWdleCk7CiAgICB9IGVsc2UgaWYgKGlzVG9TdHJpbmdlZEFycmF5VHlwZSh0b1N0cmluZ2VkKSkgewogICAgICByZXR1cm4gaGl0TWF4RGVwdGggPyAnW0FycmF5XScgOiBwcmludEFycmF5KHZhbCwgaW5kZW50LCBwcmV2SW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpOwogICAgfSBlbHNlIGlmICh0b1N0cmluZ2VkID09PSAnW29iamVjdCBNYXBdJykgewogICAgICByZXR1cm4gaGl0TWF4RGVwdGggPyAnW01hcF0nIDogcHJpbnRNYXAodmFsLCBpbmRlbnQsIHByZXZJbmRlbnQsIHNwYWNpbmcsIGVkZ2VTcGFjaW5nLCByZWZzLCBtYXhEZXB0aCwgY3VycmVudERlcHRoLCBwbHVnaW5zLCBtaW4sIGNhbGxUb0pTT04sIHByaW50RnVuY3Rpb25OYW1lLCBlc2NhcGVSZWdleCk7CiAgICB9IGVsc2UgaWYgKHRvU3RyaW5nZWQgPT09ICdbb2JqZWN0IFNldF0nKSB7CiAgICAgIHJldHVybiBoaXRNYXhEZXB0aCA/ICdbU2V0XScgOiBwcmludFNldCh2YWwsIGluZGVudCwgcHJldkluZGVudCwgc3BhY2luZywgZWRnZVNwYWNpbmcsIHJlZnMsIG1heERlcHRoLCBjdXJyZW50RGVwdGgsIHBsdWdpbnMsIG1pbiwgY2FsbFRvSlNPTiwgcHJpbnRGdW5jdGlvbk5hbWUsIGVzY2FwZVJlZ2V4KTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ29iamVjdCcpIHsKICAgICAgcmV0dXJuIGhpdE1heERlcHRoID8gJ1tPYmplY3RdJyA6IHByaW50T2JqZWN0KHZhbCwgaW5kZW50LCBwcmV2SW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcHJpbnRQbHVnaW4odmFsLCBpbmRlbnQsIHByZXZJbmRlbnQsIHNwYWNpbmcsIGVkZ2VTcGFjaW5nLCByZWZzLCBtYXhEZXB0aCwgY3VycmVudERlcHRoLCBwbHVnaW5zLCBtaW4sIGNhbGxUb0pTT04sIHByaW50RnVuY3Rpb25OYW1lLCBlc2NhcGVSZWdleCkgewogICAgdmFyIG1hdGNoID0gZmFsc2U7CiAgICB2YXIgcGx1Z2luID0gdm9pZCAwOwoKICAgIGZvciAodmFyIHAgPSAwOyBwIDwgcGx1Z2lucy5sZW5ndGg7IHArKykgewogICAgICBwbHVnaW4gPSBwbHVnaW5zW3BdOwoKICAgICAgaWYgKHBsdWdpbi50ZXN0KHZhbCkpIHsKICAgICAgICBtYXRjaCA9IHRydWU7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoIW1hdGNoKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBib3VuZFByaW50KHZhbCkgewogICAgICByZXR1cm4gcHJpbnQodmFsLCBpbmRlbnQsIHByZXZJbmRlbnQsIHNwYWNpbmcsIGVkZ2VTcGFjaW5nLCByZWZzLCBtYXhEZXB0aCwgY3VycmVudERlcHRoLCBwbHVnaW5zLCBtaW4sIGNhbGxUb0pTT04sIHByaW50RnVuY3Rpb25OYW1lLCBlc2NhcGVSZWdleCk7CiAgICB9CgogICAgZnVuY3Rpb24gYm91bmRJbmRlbnQoc3RyKSB7CiAgICAgIHZhciBpbmRlbnRhdGlvbiA9IHByZXZJbmRlbnQgKyBpbmRlbnQ7CiAgICAgIHJldHVybiBpbmRlbnRhdGlvbiArIHN0ci5yZXBsYWNlKE5FV0xJTkVfUkVHRVhQLCAnXG4nICsgaW5kZW50YXRpb24pOwogICAgfQoKICAgIHJldHVybiBwbHVnaW4ucHJpbnQodmFsLCBib3VuZFByaW50LCBib3VuZEluZGVudCwgewogICAgICBlZGdlU3BhY2luZzogZWRnZVNwYWNpbmcsCiAgICAgIHNwYWNpbmc6IHNwYWNpbmcKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gcHJpbnQodmFsLCBpbmRlbnQsIHByZXZJbmRlbnQsIHNwYWNpbmcsIGVkZ2VTcGFjaW5nLCByZWZzLCBtYXhEZXB0aCwgY3VycmVudERlcHRoLCBwbHVnaW5zLCBtaW4sIGNhbGxUb0pTT04sIHByaW50RnVuY3Rpb25OYW1lLCBlc2NhcGVSZWdleCkgewogICAgdmFyIGJhc2ljID0gcHJpbnRCYXNpY1ZhbHVlKHZhbCwgcHJpbnRGdW5jdGlvbk5hbWUsIGVzY2FwZVJlZ2V4KTsKICAgIGlmIChiYXNpYykgcmV0dXJuIGJhc2ljOwogICAgdmFyIHBsdWdpbiA9IHByaW50UGx1Z2luKHZhbCwgaW5kZW50LCBwcmV2SW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgbWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgcGx1Z2lucywgbWluLCBjYWxsVG9KU09OLCBwcmludEZ1bmN0aW9uTmFtZSwgZXNjYXBlUmVnZXgpOwogICAgaWYgKHBsdWdpbikgcmV0dXJuIHBsdWdpbjsKICAgIHJldHVybiBwcmludENvbXBsZXhWYWx1ZSh2YWwsIGluZGVudCwgcHJldkluZGVudCwgc3BhY2luZywgZWRnZVNwYWNpbmcsIHJlZnMsIG1heERlcHRoLCBjdXJyZW50RGVwdGgsIHBsdWdpbnMsIG1pbiwgY2FsbFRvSlNPTiwgcHJpbnRGdW5jdGlvbk5hbWUsIGVzY2FwZVJlZ2V4KTsKICB9CgogIHZhciBERUZBVUxUUyA9IHsKICAgIGNhbGxUb0pTT046IHRydWUsCiAgICBpbmRlbnQ6IDIsCiAgICBtYXhEZXB0aDogSW5maW5pdHksCiAgICBtaW46IGZhbHNlLAogICAgcGx1Z2luczogW10sCiAgICBwcmludEZ1bmN0aW9uTmFtZTogdHJ1ZSwKICAgIGVzY2FwZVJlZ2V4OiBmYWxzZQogIH07CgogIGZ1bmN0aW9uIHZhbGlkYXRlT3B0aW9ucyhvcHRzKSB7CiAgICBPYmplY3Qua2V5cyhvcHRzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKCFERUZBVUxUUy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwcmV0dHlGb3JtYXQ6IEludmFsaWQgb3B0aW9uOiAnICsga2V5KTsKICAgICAgfQogICAgfSk7CgogICAgaWYgKG9wdHMubWluICYmIG9wdHMuaW5kZW50ICE9PSB1bmRlZmluZWQgJiYgb3B0cy5pbmRlbnQgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdwcmV0dHlGb3JtYXQ6IENhbm5vdCBydW4gd2l0aCBtaW4gb3B0aW9uIGFuZCBpbmRlbnQnKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG5vcm1hbGl6ZU9wdGlvbnMob3B0cykgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgT2JqZWN0LmtleXMoREVGQVVMVFMpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICByZXR1cm4gcmVzdWx0W2tleV0gPSBvcHRzLmhhc093blByb3BlcnR5KGtleSkgPyBvcHRzW2tleV0gOiBERUZBVUxUU1trZXldOwogICAgfSk7CgogICAgaWYgKHJlc3VsdC5taW4pIHsKICAgICAgcmVzdWx0LmluZGVudCA9IDA7CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUluZGVudChpbmRlbnQpIHsKICAgIHJldHVybiBuZXcgQXJyYXkoaW5kZW50ICsgMSkuam9pbignICcpOwogIH0KCiAgZnVuY3Rpb24gcHJldHR5Rm9ybWF0KHZhbCwgb3B0cykgewogICAgaWYgKCFvcHRzKSB7CiAgICAgIG9wdHMgPSBERUZBVUxUUzsKICAgIH0gZWxzZSB7CiAgICAgIHZhbGlkYXRlT3B0aW9ucyhvcHRzKTsKICAgICAgb3B0cyA9IG5vcm1hbGl6ZU9wdGlvbnMob3B0cyk7CiAgICB9CgogICAgdmFyIGluZGVudCA9IHZvaWQgMDsKICAgIHZhciByZWZzID0gdm9pZCAwOwogICAgdmFyIHByZXZJbmRlbnQgPSAnJzsKICAgIHZhciBjdXJyZW50RGVwdGggPSAwOwogICAgdmFyIHNwYWNpbmcgPSBvcHRzLm1pbiA/ICcgJyA6ICdcbic7CiAgICB2YXIgZWRnZVNwYWNpbmcgPSBvcHRzLm1pbiA/ICcnIDogJ1xuJzsKCiAgICBpZiAob3B0cyAmJiBvcHRzLnBsdWdpbnMubGVuZ3RoKSB7CiAgICAgIGluZGVudCA9IGNyZWF0ZUluZGVudChvcHRzLmluZGVudCk7CiAgICAgIHJlZnMgPSBbXTsKICAgICAgdmFyIHBsdWdpbnNSZXN1bHQgPSBwcmludFBsdWdpbih2YWwsIGluZGVudCwgcHJldkluZGVudCwgc3BhY2luZywgZWRnZVNwYWNpbmcsIHJlZnMsIG9wdHMubWF4RGVwdGgsIGN1cnJlbnREZXB0aCwgb3B0cy5wbHVnaW5zLCBvcHRzLm1pbiwgb3B0cy5jYWxsVG9KU09OLCBvcHRzLnByaW50RnVuY3Rpb25OYW1lLCBvcHRzLmVzY2FwZVJlZ2V4KTsKICAgICAgaWYgKHBsdWdpbnNSZXN1bHQpIHJldHVybiBwbHVnaW5zUmVzdWx0OwogICAgfQoKICAgIHZhciBiYXNpY1Jlc3VsdCA9IHByaW50QmFzaWNWYWx1ZSh2YWwsIG9wdHMucHJpbnRGdW5jdGlvbk5hbWUsIG9wdHMuZXNjYXBlUmVnZXgpOwogICAgaWYgKGJhc2ljUmVzdWx0KSByZXR1cm4gYmFzaWNSZXN1bHQ7CiAgICBpZiAoIWluZGVudCkgaW5kZW50ID0gY3JlYXRlSW5kZW50KG9wdHMuaW5kZW50KTsKICAgIGlmICghcmVmcykgcmVmcyA9IFtdOwogICAgcmV0dXJuIHByaW50Q29tcGxleFZhbHVlKHZhbCwgaW5kZW50LCBwcmV2SW5kZW50LCBzcGFjaW5nLCBlZGdlU3BhY2luZywgcmVmcywgb3B0cy5tYXhEZXB0aCwgY3VycmVudERlcHRoLCBvcHRzLnBsdWdpbnMsIG9wdHMubWluLCBvcHRzLmNhbGxUb0pTT04sIG9wdHMucHJpbnRGdW5jdGlvbk5hbWUsIG9wdHMuZXNjYXBlUmVnZXgpOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBwcmV0dHlGb3JtYXQ7Cn0sNDgsWzQ5XSwicHJldHR5LWZvcm1hdC9pbmRleC5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEVTQ0FQRURfQ0hBUkFDVEVSUyA9IC8oXFx8XCJ8XCcpL2c7CgogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gcHJpbnRTdHJpbmcodmFsKSB7CiAgICByZXR1cm4gdmFsLnJlcGxhY2UoRVNDQVBFRF9DSEFSQUNURVJTLCAnXFwkMScpOwogIH07Cn0sNDksW10sInByZXR0eS1mb3JtYXQvcHJpbnRTdHJpbmcuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAhZnVuY3Rpb24gKGdsb2JhbCkgewogICAgInVzZSBzdHJpY3QiOwoKICAgIHZhciBPcCA9IE9iamVjdC5wcm90b3R5cGU7CiAgICB2YXIgaGFzT3duID0gT3AuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgdW5kZWZpbmVkOwogICAgdmFyICRTeW1ib2wgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sIDoge307CiAgICB2YXIgaXRlcmF0b3JTeW1ib2wgPSAkU3ltYm9sLml0ZXJhdG9yIHx8ICJAQGl0ZXJhdG9yIjsKICAgIHZhciBhc3luY0l0ZXJhdG9yU3ltYm9sID0gJFN5bWJvbC5hc3luY0l0ZXJhdG9yIHx8ICJAQGFzeW5jSXRlcmF0b3IiOwogICAgdmFyIHRvU3RyaW5nVGFnU3ltYm9sID0gJFN5bWJvbC50b1N0cmluZ1RhZyB8fCAiQEB0b1N0cmluZ1RhZyI7CiAgICB2YXIgaW5Nb2R1bGUgPSB0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IjsKICAgIHZhciBydW50aW1lID0gZ2xvYmFsLnJlZ2VuZXJhdG9yUnVudGltZTsKCiAgICBpZiAocnVudGltZSkgewogICAgICBpZiAoaW5Nb2R1bGUpIHsKICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IHJ1bnRpbWU7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0KCiAgICBydW50aW1lID0gZ2xvYmFsLnJlZ2VuZXJhdG9yUnVudGltZSA9IGluTW9kdWxlID8gbW9kdWxlLmV4cG9ydHMgOiB7fTsKCiAgICBmdW5jdGlvbiB3cmFwKGlubmVyRm4sIG91dGVyRm4sIHNlbGYsIHRyeUxvY3NMaXN0KSB7CiAgICAgIHZhciBwcm90b0dlbmVyYXRvciA9IG91dGVyRm4gJiYgb3V0ZXJGbi5wcm90b3R5cGUgaW5zdGFuY2VvZiBHZW5lcmF0b3IgPyBvdXRlckZuIDogR2VuZXJhdG9yOwogICAgICB2YXIgZ2VuZXJhdG9yID0gT2JqZWN0LmNyZWF0ZShwcm90b0dlbmVyYXRvci5wcm90b3R5cGUpOwogICAgICB2YXIgY29udGV4dCA9IG5ldyBDb250ZXh0KHRyeUxvY3NMaXN0IHx8IFtdKTsKICAgICAgZ2VuZXJhdG9yLl9pbnZva2UgPSBtYWtlSW52b2tlTWV0aG9kKGlubmVyRm4sIHNlbGYsIGNvbnRleHQpOwogICAgICByZXR1cm4gZ2VuZXJhdG9yOwogICAgfQoKICAgIHJ1bnRpbWUud3JhcCA9IHdyYXA7CgogICAgZnVuY3Rpb24gdHJ5Q2F0Y2goZm4sIG9iaiwgYXJnKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICJub3JtYWwiLAogICAgICAgICAgYXJnOiBmbi5jYWxsKG9iaiwgYXJnKQogICAgICAgIH07CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAidGhyb3ciLAogICAgICAgICAgYXJnOiBlcnIKICAgICAgICB9OwogICAgICB9CiAgICB9CgogICAgdmFyIEdlblN0YXRlU3VzcGVuZGVkU3RhcnQgPSAic3VzcGVuZGVkU3RhcnQiOwogICAgdmFyIEdlblN0YXRlU3VzcGVuZGVkWWllbGQgPSAic3VzcGVuZGVkWWllbGQiOwogICAgdmFyIEdlblN0YXRlRXhlY3V0aW5nID0gImV4ZWN1dGluZyI7CiAgICB2YXIgR2VuU3RhdGVDb21wbGV0ZWQgPSAiY29tcGxldGVkIjsKICAgIHZhciBDb250aW51ZVNlbnRpbmVsID0ge307CgogICAgZnVuY3Rpb24gR2VuZXJhdG9yKCkge30KCiAgICBmdW5jdGlvbiBHZW5lcmF0b3JGdW5jdGlvbigpIHt9CgogICAgZnVuY3Rpb24gR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGUoKSB7fQoKICAgIHZhciBJdGVyYXRvclByb3RvdHlwZSA9IHt9OwoKICAgIEl0ZXJhdG9yUHJvdG90eXBlW2l0ZXJhdG9yU3ltYm9sXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIHZhciBnZXRQcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKICAgIHZhciBOYXRpdmVJdGVyYXRvclByb3RvdHlwZSA9IGdldFByb3RvICYmIGdldFByb3RvKGdldFByb3RvKHZhbHVlcyhbXSkpKTsKCiAgICBpZiAoTmF0aXZlSXRlcmF0b3JQcm90b3R5cGUgJiYgTmF0aXZlSXRlcmF0b3JQcm90b3R5cGUgIT09IE9wICYmIGhhc093bi5jYWxsKE5hdGl2ZUl0ZXJhdG9yUHJvdG90eXBlLCBpdGVyYXRvclN5bWJvbCkpIHsKICAgICAgSXRlcmF0b3JQcm90b3R5cGUgPSBOYXRpdmVJdGVyYXRvclByb3RvdHlwZTsKICAgIH0KCiAgICB2YXIgR3AgPSBHZW5lcmF0b3JGdW5jdGlvblByb3RvdHlwZS5wcm90b3R5cGUgPSBHZW5lcmF0b3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShJdGVyYXRvclByb3RvdHlwZSk7CiAgICBHZW5lcmF0b3JGdW5jdGlvbi5wcm90b3R5cGUgPSBHcC5jb25zdHJ1Y3RvciA9IEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlOwogICAgR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGUuY29uc3RydWN0b3IgPSBHZW5lcmF0b3JGdW5jdGlvbjsKICAgIEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlW3RvU3RyaW5nVGFnU3ltYm9sXSA9IEdlbmVyYXRvckZ1bmN0aW9uLmRpc3BsYXlOYW1lID0gIkdlbmVyYXRvckZ1bmN0aW9uIjsKCiAgICBmdW5jdGlvbiBkZWZpbmVJdGVyYXRvck1ldGhvZHMocHJvdG90eXBlKSB7CiAgICAgIFsibmV4dCIsICJ0aHJvdyIsICJyZXR1cm4iXS5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICBwcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9pbnZva2UobWV0aG9kLCBhcmcpOwogICAgICAgIH07CiAgICAgIH0pOwogICAgfQoKICAgIHJ1bnRpbWUuaXNHZW5lcmF0b3JGdW5jdGlvbiA9IGZ1bmN0aW9uIChnZW5GdW4pIHsKICAgICAgdmFyIGN0b3IgPSB0eXBlb2YgZ2VuRnVuID09PSAiZnVuY3Rpb24iICYmIGdlbkZ1bi5jb25zdHJ1Y3RvcjsKICAgICAgcmV0dXJuIGN0b3IgPyBjdG9yID09PSBHZW5lcmF0b3JGdW5jdGlvbiB8fCAoY3Rvci5kaXNwbGF5TmFtZSB8fCBjdG9yLm5hbWUpID09PSAiR2VuZXJhdG9yRnVuY3Rpb24iIDogZmFsc2U7CiAgICB9OwoKICAgIHJ1bnRpbWUubWFyayA9IGZ1bmN0aW9uIChnZW5GdW4pIHsKICAgICAgaWYgKE9iamVjdC5zZXRQcm90b3R5cGVPZikgewogICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihnZW5GdW4sIEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBnZW5GdW4uX19wcm90b19fID0gR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGU7CgogICAgICAgIGlmICghKHRvU3RyaW5nVGFnU3ltYm9sIGluIGdlbkZ1bikpIHsKICAgICAgICAgIGdlbkZ1blt0b1N0cmluZ1RhZ1N5bWJvbF0gPSAiR2VuZXJhdG9yRnVuY3Rpb24iOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZ2VuRnVuLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoR3ApOwogICAgICByZXR1cm4gZ2VuRnVuOwogICAgfTsKCiAgICBydW50aW1lLmF3cmFwID0gZnVuY3Rpb24gKGFyZykgewogICAgICByZXR1cm4gewogICAgICAgIF9fYXdhaXQ6IGFyZwogICAgICB9OwogICAgfTsKCiAgICBmdW5jdGlvbiBBc3luY0l0ZXJhdG9yKGdlbmVyYXRvcikgewogICAgICBmdW5jdGlvbiBpbnZva2UobWV0aG9kLCBhcmcsIHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIHZhciByZWNvcmQgPSB0cnlDYXRjaChnZW5lcmF0b3JbbWV0aG9kXSwgZ2VuZXJhdG9yLCBhcmcpOwoKICAgICAgICBpZiAocmVjb3JkLnR5cGUgPT09ICJ0aHJvdyIpIHsKICAgICAgICAgIHJlamVjdChyZWNvcmQuYXJnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHJlc3VsdCA9IHJlY29yZC5hcmc7CiAgICAgICAgICB2YXIgdmFsdWUgPSByZXN1bHQudmFsdWU7CgogICAgICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgaGFzT3duLmNhbGwodmFsdWUsICJfX2F3YWl0IikpIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh2YWx1ZS5fX2F3YWl0KS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgIGludm9rZSgibmV4dCIsIHZhbHVlLCByZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgaW52b2tlKCJ0aHJvdyIsIGVyciwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh2YWx1ZSkudGhlbihmdW5jdGlvbiAodW53cmFwcGVkKSB7CiAgICAgICAgICAgIHJlc3VsdC52YWx1ZSA9IHVud3JhcHBlZDsKICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpOwogICAgICAgICAgfSwgcmVqZWN0KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBwcmV2aW91c1Byb21pc2U7CgogICAgICBmdW5jdGlvbiBlbnF1ZXVlKG1ldGhvZCwgYXJnKSB7CiAgICAgICAgZnVuY3Rpb24gY2FsbEludm9rZVdpdGhNZXRob2RBbmRBcmcoKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICBpbnZva2UobWV0aG9kLCBhcmcsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBwcmV2aW91c1Byb21pc2UgPSBwcmV2aW91c1Byb21pc2UgPyBwcmV2aW91c1Byb21pc2UudGhlbihjYWxsSW52b2tlV2l0aE1ldGhvZEFuZEFyZywgY2FsbEludm9rZVdpdGhNZXRob2RBbmRBcmcpIDogY2FsbEludm9rZVdpdGhNZXRob2RBbmRBcmcoKTsKICAgICAgfQoKICAgICAgdGhpcy5faW52b2tlID0gZW5xdWV1ZTsKICAgIH0KCiAgICBkZWZpbmVJdGVyYXRvck1ldGhvZHMoQXN5bmNJdGVyYXRvci5wcm90b3R5cGUpOwoKICAgIEFzeW5jSXRlcmF0b3IucHJvdG90eXBlW2FzeW5jSXRlcmF0b3JTeW1ib2xdID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgcnVudGltZS5Bc3luY0l0ZXJhdG9yID0gQXN5bmNJdGVyYXRvcjsKCiAgICBydW50aW1lLmFzeW5jID0gZnVuY3Rpb24gKGlubmVyRm4sIG91dGVyRm4sIHNlbGYsIHRyeUxvY3NMaXN0KSB7CiAgICAgIHZhciBpdGVyID0gbmV3IEFzeW5jSXRlcmF0b3Iod3JhcChpbm5lckZuLCBvdXRlckZuLCBzZWxmLCB0cnlMb2NzTGlzdCkpOwogICAgICByZXR1cm4gcnVudGltZS5pc0dlbmVyYXRvckZ1bmN0aW9uKG91dGVyRm4pID8gaXRlciA6IGl0ZXIubmV4dCgpLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgIHJldHVybiByZXN1bHQuZG9uZSA/IHJlc3VsdC52YWx1ZSA6IGl0ZXIubmV4dCgpOwogICAgICB9KTsKICAgIH07CgogICAgZnVuY3Rpb24gbWFrZUludm9rZU1ldGhvZChpbm5lckZuLCBzZWxmLCBjb250ZXh0KSB7CiAgICAgIHZhciBzdGF0ZSA9IEdlblN0YXRlU3VzcGVuZGVkU3RhcnQ7CiAgICAgIHJldHVybiBmdW5jdGlvbiBpbnZva2UobWV0aG9kLCBhcmcpIHsKICAgICAgICBpZiAoc3RhdGUgPT09IEdlblN0YXRlRXhlY3V0aW5nKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkdlbmVyYXRvciBpcyBhbHJlYWR5IHJ1bm5pbmciKTsKICAgICAgICB9CgogICAgICAgIGlmIChzdGF0ZSA9PT0gR2VuU3RhdGVDb21wbGV0ZWQpIHsKICAgICAgICAgIGlmIChtZXRob2QgPT09ICJ0aHJvdyIpIHsKICAgICAgICAgICAgdGhyb3cgYXJnOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBkb25lUmVzdWx0KCk7CiAgICAgICAgfQoKICAgICAgICBjb250ZXh0Lm1ldGhvZCA9IG1ldGhvZDsKICAgICAgICBjb250ZXh0LmFyZyA9IGFyZzsKCiAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgIHZhciBkZWxlZ2F0ZSA9IGNvbnRleHQuZGVsZWdhdGU7CgogICAgICAgICAgaWYgKGRlbGVnYXRlKSB7CiAgICAgICAgICAgIHZhciBkZWxlZ2F0ZVJlc3VsdCA9IG1heWJlSW52b2tlRGVsZWdhdGUoZGVsZWdhdGUsIGNvbnRleHQpOwoKICAgICAgICAgICAgaWYgKGRlbGVnYXRlUmVzdWx0KSB7CiAgICAgICAgICAgICAgaWYgKGRlbGVnYXRlUmVzdWx0ID09PSBDb250aW51ZVNlbnRpbmVsKSBjb250aW51ZTsKICAgICAgICAgICAgICByZXR1cm4gZGVsZWdhdGVSZXN1bHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY29udGV4dC5tZXRob2QgPT09ICJuZXh0IikgewogICAgICAgICAgICBjb250ZXh0LnNlbnQgPSBjb250ZXh0Ll9zZW50ID0gY29udGV4dC5hcmc7CiAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHQubWV0aG9kID09PSAidGhyb3ciKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gR2VuU3RhdGVTdXNwZW5kZWRTdGFydCkgewogICAgICAgICAgICAgIHN0YXRlID0gR2VuU3RhdGVDb21wbGV0ZWQ7CiAgICAgICAgICAgICAgdGhyb3cgY29udGV4dC5hcmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRleHQuZGlzcGF0Y2hFeGNlcHRpb24oY29udGV4dC5hcmcpOwogICAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0Lm1ldGhvZCA9PT0gInJldHVybiIpIHsKICAgICAgICAgICAgY29udGV4dC5hYnJ1cHQoInJldHVybiIsIGNvbnRleHQuYXJnKTsKICAgICAgICAgIH0KCiAgICAgICAgICBzdGF0ZSA9IEdlblN0YXRlRXhlY3V0aW5nOwogICAgICAgICAgdmFyIHJlY29yZCA9IHRyeUNhdGNoKGlubmVyRm4sIHNlbGYsIGNvbnRleHQpOwoKICAgICAgICAgIGlmIChyZWNvcmQudHlwZSA9PT0gIm5vcm1hbCIpIHsKICAgICAgICAgICAgc3RhdGUgPSBjb250ZXh0LmRvbmUgPyBHZW5TdGF0ZUNvbXBsZXRlZCA6IEdlblN0YXRlU3VzcGVuZGVkWWllbGQ7CgogICAgICAgICAgICBpZiAocmVjb3JkLmFyZyA9PT0gQ29udGludWVTZW50aW5lbCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHZhbHVlOiByZWNvcmQuYXJnLAogICAgICAgICAgICAgIGRvbmU6IGNvbnRleHQuZG9uZQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChyZWNvcmQudHlwZSA9PT0gInRocm93IikgewogICAgICAgICAgICBzdGF0ZSA9IEdlblN0YXRlQ29tcGxldGVkOwogICAgICAgICAgICBjb250ZXh0Lm1ldGhvZCA9ICJ0aHJvdyI7CiAgICAgICAgICAgIGNvbnRleHQuYXJnID0gcmVjb3JkLmFyZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gbWF5YmVJbnZva2VEZWxlZ2F0ZShkZWxlZ2F0ZSwgY29udGV4dCkgewogICAgICB2YXIgbWV0aG9kID0gZGVsZWdhdGUuaXRlcmF0b3JbY29udGV4dC5tZXRob2RdOwoKICAgICAgaWYgKG1ldGhvZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY29udGV4dC5kZWxlZ2F0ZSA9IG51bGw7CgogICAgICAgIGlmIChjb250ZXh0Lm1ldGhvZCA9PT0gInRocm93IikgewogICAgICAgICAgaWYgKGRlbGVnYXRlLml0ZXJhdG9yLnJldHVybikgewogICAgICAgICAgICBjb250ZXh0Lm1ldGhvZCA9ICJyZXR1cm4iOwogICAgICAgICAgICBjb250ZXh0LmFyZyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgbWF5YmVJbnZva2VEZWxlZ2F0ZShkZWxlZ2F0ZSwgY29udGV4dCk7CgogICAgICAgICAgICBpZiAoY29udGV4dC5tZXRob2QgPT09ICJ0aHJvdyIpIHsKICAgICAgICAgICAgICByZXR1cm4gQ29udGludWVTZW50aW5lbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGNvbnRleHQubWV0aG9kID0gInRocm93IjsKICAgICAgICAgIGNvbnRleHQuYXJnID0gbmV3IFR5cGVFcnJvcigiVGhlIGl0ZXJhdG9yIGRvZXMgbm90IHByb3ZpZGUgYSAndGhyb3cnIG1ldGhvZCIpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIENvbnRpbnVlU2VudGluZWw7CiAgICAgIH0KCiAgICAgIHZhciByZWNvcmQgPSB0cnlDYXRjaChtZXRob2QsIGRlbGVnYXRlLml0ZXJhdG9yLCBjb250ZXh0LmFyZyk7CgogICAgICBpZiAocmVjb3JkLnR5cGUgPT09ICJ0aHJvdyIpIHsKICAgICAgICBjb250ZXh0Lm1ldGhvZCA9ICJ0aHJvdyI7CiAgICAgICAgY29udGV4dC5hcmcgPSByZWNvcmQuYXJnOwogICAgICAgIGNvbnRleHQuZGVsZWdhdGUgPSBudWxsOwogICAgICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsOwogICAgICB9CgogICAgICB2YXIgaW5mbyA9IHJlY29yZC5hcmc7CgogICAgICBpZiAoIWluZm8pIHsKICAgICAgICBjb250ZXh0Lm1ldGhvZCA9ICJ0aHJvdyI7CiAgICAgICAgY29udGV4dC5hcmcgPSBuZXcgVHlwZUVycm9yKCJpdGVyYXRvciByZXN1bHQgaXMgbm90IGFuIG9iamVjdCIpOwogICAgICAgIGNvbnRleHQuZGVsZWdhdGUgPSBudWxsOwogICAgICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsOwogICAgICB9CgogICAgICBpZiAoaW5mby5kb25lKSB7CiAgICAgICAgY29udGV4dFtkZWxlZ2F0ZS5yZXN1bHROYW1lXSA9IGluZm8udmFsdWU7CiAgICAgICAgY29udGV4dC5uZXh0ID0gZGVsZWdhdGUubmV4dExvYzsKCiAgICAgICAgaWYgKGNvbnRleHQubWV0aG9kICE9PSAicmV0dXJuIikgewogICAgICAgICAgY29udGV4dC5tZXRob2QgPSAibmV4dCI7CiAgICAgICAgICBjb250ZXh0LmFyZyA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGluZm87CiAgICAgIH0KCiAgICAgIGNvbnRleHQuZGVsZWdhdGUgPSBudWxsOwogICAgICByZXR1cm4gQ29udGludWVTZW50aW5lbDsKICAgIH0KCiAgICBkZWZpbmVJdGVyYXRvck1ldGhvZHMoR3ApOwogICAgR3BbdG9TdHJpbmdUYWdTeW1ib2xdID0gIkdlbmVyYXRvciI7CgogICAgR3BbaXRlcmF0b3JTeW1ib2xdID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgR3AudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAiW29iamVjdCBHZW5lcmF0b3JdIjsKICAgIH07CgogICAgZnVuY3Rpb24gcHVzaFRyeUVudHJ5KGxvY3MpIHsKICAgICAgdmFyIGVudHJ5ID0gewogICAgICAgIHRyeUxvYzogbG9jc1swXQogICAgICB9OwoKICAgICAgaWYgKDEgaW4gbG9jcykgewogICAgICAgIGVudHJ5LmNhdGNoTG9jID0gbG9jc1sxXTsKICAgICAgfQoKICAgICAgaWYgKDIgaW4gbG9jcykgewogICAgICAgIGVudHJ5LmZpbmFsbHlMb2MgPSBsb2NzWzJdOwogICAgICAgIGVudHJ5LmFmdGVyTG9jID0gbG9jc1szXTsKICAgICAgfQoKICAgICAgdGhpcy50cnlFbnRyaWVzLnB1c2goZW50cnkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlc2V0VHJ5RW50cnkoZW50cnkpIHsKICAgICAgdmFyIHJlY29yZCA9IGVudHJ5LmNvbXBsZXRpb24gfHwge307CiAgICAgIHJlY29yZC50eXBlID0gIm5vcm1hbCI7CiAgICAgIGRlbGV0ZSByZWNvcmQuYXJnOwogICAgICBlbnRyeS5jb21wbGV0aW9uID0gcmVjb3JkOwogICAgfQoKICAgIGZ1bmN0aW9uIENvbnRleHQodHJ5TG9jc0xpc3QpIHsKICAgICAgdGhpcy50cnlFbnRyaWVzID0gW3sKICAgICAgICB0cnlMb2M6ICJyb290IgogICAgICB9XTsKICAgICAgdHJ5TG9jc0xpc3QuZm9yRWFjaChwdXNoVHJ5RW50cnksIHRoaXMpOwogICAgICB0aGlzLnJlc2V0KHRydWUpOwogICAgfQoKICAgIHJ1bnRpbWUua2V5cyA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgdmFyIGtleXMgPSBbXTsKCiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgfQoKICAgICAga2V5cy5yZXZlcnNlKCk7CiAgICAgIHJldHVybiBmdW5jdGlvbiBuZXh0KCkgewogICAgICAgIHdoaWxlIChrZXlzLmxlbmd0aCkgewogICAgICAgICAgdmFyIGtleSA9IGtleXMucG9wKCk7CgogICAgICAgICAgaWYgKGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgbmV4dC52YWx1ZSA9IGtleTsKICAgICAgICAgICAgbmV4dC5kb25lID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiBuZXh0OwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbmV4dC5kb25lID0gdHJ1ZTsKICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgfTsKICAgIH07CgogICAgZnVuY3Rpb24gdmFsdWVzKGl0ZXJhYmxlKSB7CiAgICAgIGlmIChpdGVyYWJsZSkgewogICAgICAgIHZhciBpdGVyYXRvck1ldGhvZCA9IGl0ZXJhYmxlW2l0ZXJhdG9yU3ltYm9sXTsKCiAgICAgICAgaWYgKGl0ZXJhdG9yTWV0aG9kKSB7CiAgICAgICAgICByZXR1cm4gaXRlcmF0b3JNZXRob2QuY2FsbChpdGVyYWJsZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGl0ZXJhYmxlLm5leHQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHJldHVybiBpdGVyYWJsZTsKICAgICAgICB9CgogICAgICAgIGlmICghaXNOYU4oaXRlcmFibGUubGVuZ3RoKSkgewogICAgICAgICAgdmFyIGkgPSAtMSwKICAgICAgICAgICAgICBuZXh0ID0gZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICAgICAgd2hpbGUgKCsraSA8IGl0ZXJhYmxlLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChpdGVyYWJsZSwgaSkpIHsKICAgICAgICAgICAgICAgIG5leHQudmFsdWUgPSBpdGVyYWJsZVtpXTsKICAgICAgICAgICAgICAgIG5leHQuZG9uZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuIG5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXh0LnZhbHVlID0gdW5kZWZpbmVkOwogICAgICAgICAgICBuZXh0LmRvbmUgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICAgIH07CgogICAgICAgICAgcmV0dXJuIG5leHQubmV4dCA9IG5leHQ7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIG5leHQ6IGRvbmVSZXN1bHQKICAgICAgfTsKICAgIH0KCiAgICBydW50aW1lLnZhbHVlcyA9IHZhbHVlczsKCiAgICBmdW5jdGlvbiBkb25lUmVzdWx0KCkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiB1bmRlZmluZWQsCiAgICAgICAgZG9uZTogdHJ1ZQogICAgICB9OwogICAgfQoKICAgIENvbnRleHQucHJvdG90eXBlID0gewogICAgICBjb25zdHJ1Y3RvcjogQ29udGV4dCwKICAgICAgcmVzZXQ6IGZ1bmN0aW9uIHJlc2V0KHNraXBUZW1wUmVzZXQpIHsKICAgICAgICB0aGlzLnByZXYgPSAwOwogICAgICAgIHRoaXMubmV4dCA9IDA7CiAgICAgICAgdGhpcy5zZW50ID0gdGhpcy5fc2VudCA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICB0aGlzLmRlbGVnYXRlID0gbnVsbDsKICAgICAgICB0aGlzLm1ldGhvZCA9ICJuZXh0IjsKICAgICAgICB0aGlzLmFyZyA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnRyeUVudHJpZXMuZm9yRWFjaChyZXNldFRyeUVudHJ5KTsKCiAgICAgICAgaWYgKCFza2lwVGVtcFJlc2V0KSB7CiAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIHRoaXMpIHsKICAgICAgICAgICAgaWYgKG5hbWUuY2hhckF0KDApID09PSAidCIgJiYgaGFzT3duLmNhbGwodGhpcywgbmFtZSkgJiYgIWlzTmFOKCtuYW1lLnNsaWNlKDEpKSkgewogICAgICAgICAgICAgIHRoaXNbbmFtZV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIHN0b3A6IGZ1bmN0aW9uIHN0b3AoKSB7CiAgICAgICAgdGhpcy5kb25lID0gdHJ1ZTsKICAgICAgICB2YXIgcm9vdEVudHJ5ID0gdGhpcy50cnlFbnRyaWVzWzBdOwogICAgICAgIHZhciByb290UmVjb3JkID0gcm9vdEVudHJ5LmNvbXBsZXRpb247CgogICAgICAgIGlmIChyb290UmVjb3JkLnR5cGUgPT09ICJ0aHJvdyIpIHsKICAgICAgICAgIHRocm93IHJvb3RSZWNvcmQuYXJnOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMucnZhbDsKICAgICAgfSwKICAgICAgZGlzcGF0Y2hFeGNlcHRpb246IGZ1bmN0aW9uIGRpc3BhdGNoRXhjZXB0aW9uKGV4Y2VwdGlvbikgewogICAgICAgIGlmICh0aGlzLmRvbmUpIHsKICAgICAgICAgIHRocm93IGV4Y2VwdGlvbjsKICAgICAgICB9CgogICAgICAgIHZhciBjb250ZXh0ID0gdGhpczsKCiAgICAgICAgZnVuY3Rpb24gaGFuZGxlKGxvYywgY2F1Z2h0KSB7CiAgICAgICAgICByZWNvcmQudHlwZSA9ICJ0aHJvdyI7CiAgICAgICAgICByZWNvcmQuYXJnID0gZXhjZXB0aW9uOwogICAgICAgICAgY29udGV4dC5uZXh0ID0gbG9jOwoKICAgICAgICAgIGlmIChjYXVnaHQpIHsKICAgICAgICAgICAgY29udGV4dC5tZXRob2QgPSAibmV4dCI7CiAgICAgICAgICAgIGNvbnRleHQuYXJnID0gdW5kZWZpbmVkOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiAhIWNhdWdodDsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLnRyeUVudHJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgIHZhciBlbnRyeSA9IHRoaXMudHJ5RW50cmllc1tpXTsKICAgICAgICAgIHZhciByZWNvcmQgPSBlbnRyeS5jb21wbGV0aW9uOwoKICAgICAgICAgIGlmIChlbnRyeS50cnlMb2MgPT09ICJyb290IikgewogICAgICAgICAgICByZXR1cm4gaGFuZGxlKCJlbmQiKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZW50cnkudHJ5TG9jIDw9IHRoaXMucHJldikgewogICAgICAgICAgICB2YXIgaGFzQ2F0Y2ggPSBoYXNPd24uY2FsbChlbnRyeSwgImNhdGNoTG9jIik7CiAgICAgICAgICAgIHZhciBoYXNGaW5hbGx5ID0gaGFzT3duLmNhbGwoZW50cnksICJmaW5hbGx5TG9jIik7CgogICAgICAgICAgICBpZiAoaGFzQ2F0Y2ggJiYgaGFzRmluYWxseSkgewogICAgICAgICAgICAgIGlmICh0aGlzLnByZXYgPCBlbnRyeS5jYXRjaExvYykgewogICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZShlbnRyeS5jYXRjaExvYywgdHJ1ZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnByZXYgPCBlbnRyeS5maW5hbGx5TG9jKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlKGVudHJ5LmZpbmFsbHlMb2MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNDYXRjaCkgewogICAgICAgICAgICAgIGlmICh0aGlzLnByZXYgPCBlbnRyeS5jYXRjaExvYykgewogICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZShlbnRyeS5jYXRjaExvYywgdHJ1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGhhc0ZpbmFsbHkpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5wcmV2IDwgZW50cnkuZmluYWxseUxvYykgewogICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZShlbnRyeS5maW5hbGx5TG9jKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ0cnkgc3RhdGVtZW50IHdpdGhvdXQgY2F0Y2ggb3IgZmluYWxseSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBhYnJ1cHQ6IGZ1bmN0aW9uIGFicnVwdCh0eXBlLCBhcmcpIHsKICAgICAgICBmb3IgKHZhciBpID0gdGhpcy50cnlFbnRyaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICB2YXIgZW50cnkgPSB0aGlzLnRyeUVudHJpZXNbaV07CgogICAgICAgICAgaWYgKGVudHJ5LnRyeUxvYyA8PSB0aGlzLnByZXYgJiYgaGFzT3duLmNhbGwoZW50cnksICJmaW5hbGx5TG9jIikgJiYgdGhpcy5wcmV2IDwgZW50cnkuZmluYWxseUxvYykgewogICAgICAgICAgICB2YXIgZmluYWxseUVudHJ5ID0gZW50cnk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGZpbmFsbHlFbnRyeSAmJiAodHlwZSA9PT0gImJyZWFrIiB8fCB0eXBlID09PSAiY29udGludWUiKSAmJiBmaW5hbGx5RW50cnkudHJ5TG9jIDw9IGFyZyAmJiBhcmcgPD0gZmluYWxseUVudHJ5LmZpbmFsbHlMb2MpIHsKICAgICAgICAgIGZpbmFsbHlFbnRyeSA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVjb3JkID0gZmluYWxseUVudHJ5ID8gZmluYWxseUVudHJ5LmNvbXBsZXRpb24gOiB7fTsKICAgICAgICByZWNvcmQudHlwZSA9IHR5cGU7CiAgICAgICAgcmVjb3JkLmFyZyA9IGFyZzsKCiAgICAgICAgaWYgKGZpbmFsbHlFbnRyeSkgewogICAgICAgICAgdGhpcy5tZXRob2QgPSAibmV4dCI7CiAgICAgICAgICB0aGlzLm5leHQgPSBmaW5hbGx5RW50cnkuZmluYWxseUxvYzsKICAgICAgICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuY29tcGxldGUocmVjb3JkKTsKICAgICAgfSwKICAgICAgY29tcGxldGU6IGZ1bmN0aW9uIGNvbXBsZXRlKHJlY29yZCwgYWZ0ZXJMb2MpIHsKICAgICAgICBpZiAocmVjb3JkLnR5cGUgPT09ICJ0aHJvdyIpIHsKICAgICAgICAgIHRocm93IHJlY29yZC5hcmc7CiAgICAgICAgfQoKICAgICAgICBpZiAocmVjb3JkLnR5cGUgPT09ICJicmVhayIgfHwgcmVjb3JkLnR5cGUgPT09ICJjb250aW51ZSIpIHsKICAgICAgICAgIHRoaXMubmV4dCA9IHJlY29yZC5hcmc7CiAgICAgICAgfSBlbHNlIGlmIChyZWNvcmQudHlwZSA9PT0gInJldHVybiIpIHsKICAgICAgICAgIHRoaXMucnZhbCA9IHRoaXMuYXJnID0gcmVjb3JkLmFyZzsKICAgICAgICAgIHRoaXMubWV0aG9kID0gInJldHVybiI7CiAgICAgICAgICB0aGlzLm5leHQgPSAiZW5kIjsKICAgICAgICB9IGVsc2UgaWYgKHJlY29yZC50eXBlID09PSAibm9ybWFsIiAmJiBhZnRlckxvYykgewogICAgICAgICAgdGhpcy5uZXh0ID0gYWZ0ZXJMb2M7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gQ29udGludWVTZW50aW5lbDsKICAgICAgfSwKICAgICAgZmluaXNoOiBmdW5jdGlvbiBmaW5pc2goZmluYWxseUxvYykgewogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLnRyeUVudHJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgIHZhciBlbnRyeSA9IHRoaXMudHJ5RW50cmllc1tpXTsKCiAgICAgICAgICBpZiAoZW50cnkuZmluYWxseUxvYyA9PT0gZmluYWxseUxvYykgewogICAgICAgICAgICB0aGlzLmNvbXBsZXRlKGVudHJ5LmNvbXBsZXRpb24sIGVudHJ5LmFmdGVyTG9jKTsKICAgICAgICAgICAgcmVzZXRUcnlFbnRyeShlbnRyeSk7CiAgICAgICAgICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgImNhdGNoIjogZnVuY3Rpb24gX2NhdGNoKHRyeUxvYykgewogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLnRyeUVudHJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgIHZhciBlbnRyeSA9IHRoaXMudHJ5RW50cmllc1tpXTsKCiAgICAgICAgICBpZiAoZW50cnkudHJ5TG9jID09PSB0cnlMb2MpIHsKICAgICAgICAgICAgdmFyIHJlY29yZCA9IGVudHJ5LmNvbXBsZXRpb247CgogICAgICAgICAgICBpZiAocmVjb3JkLnR5cGUgPT09ICJ0aHJvdyIpIHsKICAgICAgICAgICAgICB2YXIgdGhyb3duID0gcmVjb3JkLmFyZzsKICAgICAgICAgICAgICByZXNldFRyeUVudHJ5KGVudHJ5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRocm93bjsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaWxsZWdhbCBjYXRjaCBhdHRlbXB0Iik7CiAgICAgIH0sCiAgICAgIGRlbGVnYXRlWWllbGQ6IGZ1bmN0aW9uIGRlbGVnYXRlWWllbGQoaXRlcmFibGUsIHJlc3VsdE5hbWUsIG5leHRMb2MpIHsKICAgICAgICB0aGlzLmRlbGVnYXRlID0gewogICAgICAgICAgaXRlcmF0b3I6IHZhbHVlcyhpdGVyYWJsZSksCiAgICAgICAgICByZXN1bHROYW1lOiByZXN1bHROYW1lLAogICAgICAgICAgbmV4dExvYzogbmV4dExvYwogICAgICAgIH07CgogICAgICAgIGlmICh0aGlzLm1ldGhvZCA9PT0gIm5leHQiKSB7CiAgICAgICAgICB0aGlzLmFyZyA9IHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsOwogICAgICB9CiAgICB9OwogIH0oZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXM7CiAgfSgpIHx8IEZ1bmN0aW9uKCJyZXR1cm4gdGhpcyIpKCkpOwp9LDUwLFtdLCJyZWdlbmVyYXRvci1ydW50aW1lL3J1bnRpbWUuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJQbGF0Zm9ybSIpOwoKICB2YXIgU3lzdHJhY2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiU3lzdHJhY2UiKTsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIk5hdGl2ZU1vZHVsZXMiKSwKICAgICAgVGltaW5nID0gX3JlcXVpcmUuVGltaW5nOwoKICB2YXIgX3BlcmZvcm1hbmNlTm93ID0gbnVsbDsKCiAgZnVuY3Rpb24gcGVyZm9ybWFuY2VOb3coKSB7CiAgICBpZiAoIV9wZXJmb3JtYW5jZU5vdykgewogICAgICBfcGVyZm9ybWFuY2VOb3cgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiZmJqcy9saWIvcGVyZm9ybWFuY2VOb3ciKTsKICAgIH0KCiAgICByZXR1cm4gX3BlcmZvcm1hbmNlTm93KCk7CiAgfQoKICB2YXIgRlJBTUVfRFVSQVRJT04gPSAxMDAwIC8gNjA7CiAgdmFyIElETEVfQ0FMTEJBQ0tfRlJBTUVfREVBRExJTkUgPSAxOwogIHZhciBNQVhfVElNRVJfRFVSQVRJT05fTVMgPSA2MCAqIDEwMDA7CiAgdmFyIElTX0FORFJPSUQgPSBQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnOwogIHZhciBBTkRST0lEX0xPTkdfVElNRVJfTUVTU0FHRSA9ICdTZXR0aW5nIGEgdGltZXIgZm9yIGEgbG9uZyBwZXJpb2Qgb2YgdGltZSwgaS5lLiBtdWx0aXBsZSBtaW51dGVzLCBpcyBhICcgKyAncGVyZm9ybWFuY2UgYW5kIGNvcnJlY3RuZXNzIGlzc3VlIG9uIEFuZHJvaWQgYXMgaXQga2VlcHMgdGhlIHRpbWVyICcgKyAnbW9kdWxlIGF3YWtlLCBhbmQgdGltZXJzIGNhbiBvbmx5IGJlIGNhbGxlZCB3aGVuIHRoZSBhcHAgaXMgaW4gdGhlIGZvcmVncm91bmQuICcgKyAnU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC1uYXRpdmUvaXNzdWVzLzEyOTgxIGZvciBtb3JlIGluZm8uJzsKICB2YXIgY2FsbGJhY2tzID0gW107CiAgdmFyIHR5cGVzID0gW107CiAgdmFyIHRpbWVySURzID0gW107CiAgdmFyIGltbWVkaWF0ZXMgPSBbXTsKICB2YXIgcmVxdWVzdElkbGVDYWxsYmFja3MgPSBbXTsKICB2YXIgcmVxdWVzdElkbGVDYWxsYmFja1RpbWVvdXRzID0ge307CiAgdmFyIGlkZW50aWZpZXJzID0gW107CiAgdmFyIEdVSUQgPSAxOwogIHZhciBlcnJvcnMgPSBudWxsOwogIHZhciBoYXNFbWl0dGVkVGltZURyaWZ0V2FybmluZyA9IGZhbHNlOwoKICBmdW5jdGlvbiBfZ2V0RnJlZUluZGV4KCkgewogICAgdmFyIGZyZWVJbmRleCA9IHRpbWVySURzLmluZGV4T2YobnVsbCk7CgogICAgaWYgKGZyZWVJbmRleCA9PT0gLTEpIHsKICAgICAgZnJlZUluZGV4ID0gdGltZXJJRHMubGVuZ3RoOwogICAgfQoKICAgIHJldHVybiBmcmVlSW5kZXg7CiAgfQoKICBmdW5jdGlvbiBfYWxsb2NhdGVDYWxsYmFjayhmdW5jLCB0eXBlKSB7CiAgICB2YXIgaWQgPSBHVUlEKys7CgogICAgdmFyIGZyZWVJbmRleCA9IF9nZXRGcmVlSW5kZXgoKTsKCiAgICB0aW1lcklEc1tmcmVlSW5kZXhdID0gaWQ7CiAgICBjYWxsYmFja3NbZnJlZUluZGV4XSA9IGZ1bmM7CiAgICB0eXBlc1tmcmVlSW5kZXhdID0gdHlwZTsKCiAgICBpZiAoX19ERVZfXykgewogICAgICB2YXIgcGFyc2VFcnJvclN0YWNrID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgInBhcnNlRXJyb3JTdGFjayIpOwoKICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCk7CiAgICAgIGVycm9yLmZyYW1lc1RvUG9wID0gMTsKICAgICAgdmFyIHN0YWNrID0gcGFyc2VFcnJvclN0YWNrKGVycm9yKTsKCiAgICAgIGlmIChzdGFjaykgewogICAgICAgIGlkZW50aWZpZXJzW2ZyZWVJbmRleF0gPSBzdGFjay5zaGlmdCgpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGlkOwogIH0KCiAgZnVuY3Rpb24gX2NhbGxUaW1lcih0aW1lcklELCBmcmFtZVRpbWUsIGRpZFRpbWVvdXQpIHsKICAgIHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJmYmpzL2xpYi93YXJuaW5nIikodGltZXJJRCA8PSBHVUlELCAnVHJpZWQgdG8gY2FsbCB0aW1lciB3aXRoIElEICVzIGJ1dCBubyBzdWNoIHRpbWVyIGV4aXN0cy4nLCB0aW1lcklEKTsKCiAgICB2YXIgdGltZXJJbmRleCA9IHRpbWVySURzLmluZGV4T2YodGltZXJJRCk7CgogICAgaWYgKHRpbWVySW5kZXggPT09IC0xKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgdHlwZSA9IHR5cGVzW3RpbWVySW5kZXhdOwogICAgdmFyIGNhbGxiYWNrID0gY2FsbGJhY2tzW3RpbWVySW5kZXhdOwoKICAgIGlmICghY2FsbGJhY2sgfHwgIXR5cGUpIHsKICAgICAgY29uc29sZS5lcnJvcignTm8gY2FsbGJhY2sgZm91bmQgZm9yIHRpbWVySUQgJyArIHRpbWVySUQpOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKF9fREVWX18pIHsKICAgICAgdmFyIGlkZW50aWZpZXIgPSBpZGVudGlmaWVyc1t0aW1lckluZGV4XSB8fCB7fTsKICAgICAgU3lzdHJhY2UuYmVnaW5FdmVudCgnU3lzdHJhY2UuY2FsbFRpbWVyOiAnICsgaWRlbnRpZmllci5tZXRob2ROYW1lKTsKICAgIH0KCiAgICBpZiAodHlwZSA9PT0gJ3NldFRpbWVvdXQnIHx8IHR5cGUgPT09ICdzZXRJbW1lZGlhdGUnIHx8IHR5cGUgPT09ICdyZXF1ZXN0QW5pbWF0aW9uRnJhbWUnIHx8IHR5cGUgPT09ICdyZXF1ZXN0SWRsZUNhbGxiYWNrJykgewogICAgICBfY2xlYXJJbmRleCh0aW1lckluZGV4KTsKICAgIH0KCiAgICB0cnkgewogICAgICBpZiAodHlwZSA9PT0gJ3NldFRpbWVvdXQnIHx8IHR5cGUgPT09ICdzZXRJbnRlcnZhbCcgfHwgdHlwZSA9PT0gJ3NldEltbWVkaWF0ZScpIHsKICAgICAgICBjYWxsYmFjaygpOwogICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdyZXF1ZXN0QW5pbWF0aW9uRnJhbWUnKSB7CiAgICAgICAgY2FsbGJhY2socGVyZm9ybWFuY2VOb3coKSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3JlcXVlc3RJZGxlQ2FsbGJhY2snKSB7CiAgICAgICAgY2FsbGJhY2soewogICAgICAgICAgdGltZVJlbWFpbmluZzogZnVuY3Rpb24gdGltZVJlbWFpbmluZygpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWF4KDAsIEZSQU1FX0RVUkFUSU9OIC0gKHBlcmZvcm1hbmNlTm93KCkgLSBmcmFtZVRpbWUpKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkaWRUaW1lb3V0OiAhIWRpZFRpbWVvdXQKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdUcmllZCB0byBjYWxsIGEgY2FsbGJhY2sgd2l0aCBpbnZhbGlkIHR5cGU6ICcgKyB0eXBlKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBpZiAoIWVycm9ycykgewogICAgICAgIGVycm9ycyA9IFtlXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlcnJvcnMucHVzaChlKTsKICAgICAgfQogICAgfQoKICAgIGlmIChfX0RFVl9fKSB7CiAgICAgIFN5c3RyYWNlLmVuZEV2ZW50KCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBfY2FsbEltbWVkaWF0ZXNQYXNzKCkgewogICAgaWYgKF9fREVWX18pIHsKICAgICAgU3lzdHJhY2UuYmVnaW5FdmVudCgnY2FsbEltbWVkaWF0ZXNQYXNzKCknKTsKICAgIH0KCiAgICBpZiAoaW1tZWRpYXRlcy5sZW5ndGggPiAwKSB7CiAgICAgIHZhciBwYXNzSW1tZWRpYXRlcyA9IGltbWVkaWF0ZXMuc2xpY2UoKTsKICAgICAgaW1tZWRpYXRlcyA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXNzSW1tZWRpYXRlcy5sZW5ndGg7ICsraSkgewogICAgICAgIF9jYWxsVGltZXIocGFzc0ltbWVkaWF0ZXNbaV0sIDApOwogICAgICB9CiAgICB9CgogICAgaWYgKF9fREVWX18pIHsKICAgICAgU3lzdHJhY2UuZW5kRXZlbnQoKTsKICAgIH0KCiAgICByZXR1cm4gaW1tZWRpYXRlcy5sZW5ndGggPiAwOwogIH0KCiAgZnVuY3Rpb24gX2NsZWFySW5kZXgoaSkgewogICAgdGltZXJJRHNbaV0gPSBudWxsOwogICAgY2FsbGJhY2tzW2ldID0gbnVsbDsKICAgIHR5cGVzW2ldID0gbnVsbDsKICAgIGlkZW50aWZpZXJzW2ldID0gbnVsbDsKICB9CgogIGZ1bmN0aW9uIF9mcmVlQ2FsbGJhY2sodGltZXJJRCkgewogICAgaWYgKHRpbWVySUQgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGluZGV4ID0gdGltZXJJRHMuaW5kZXhPZih0aW1lcklEKTsKCiAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgIF9jbGVhckluZGV4KGluZGV4KTsKCiAgICAgIHZhciB0eXBlID0gdHlwZXNbaW5kZXhdOwoKICAgICAgaWYgKHR5cGUgIT09ICdzZXRJbW1lZGlhdGUnICYmIHR5cGUgIT09ICdyZXF1ZXN0SWRsZUNhbGxiYWNrJykgewogICAgICAgIFRpbWluZy5kZWxldGVUaW1lcih0aW1lcklEKTsKICAgICAgfQogICAgfQogIH0KCiAgdmFyIEpTVGltZXJzID0gewogICAgc2V0VGltZW91dDogZnVuY3Rpb24gc2V0VGltZW91dChmdW5jLCBkdXJhdGlvbikgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4gPiAyID8gX2xlbiAtIDIgOiAwKSwgX2tleSA9IDI7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXkgLSAyXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgfQoKICAgICAgaWYgKF9fREVWX18gJiYgSVNfQU5EUk9JRCAmJiBkdXJhdGlvbiA+IE1BWF9USU1FUl9EVVJBVElPTl9NUykgewogICAgICAgIGNvbnNvbGUud2FybihBTkRST0lEX0xPTkdfVElNRVJfTUVTU0FHRSArICdcbicgKyAnKFNhdyBzZXRUaW1lb3V0IHdpdGggZHVyYXRpb24gJyArIGR1cmF0aW9uICsgJ21zKScpOwogICAgICB9CgogICAgICB2YXIgaWQgPSBfYWxsb2NhdGVDYWxsYmFjayhmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsKICAgICAgfSwgJ3NldFRpbWVvdXQnKTsKCiAgICAgIFRpbWluZy5jcmVhdGVUaW1lcihpZCwgZHVyYXRpb24gfHwgMCwgRGF0ZS5ub3coKSwgZmFsc2UpOwogICAgICByZXR1cm4gaWQ7CiAgICB9LAogICAgc2V0SW50ZXJ2YWw6IGZ1bmN0aW9uIHNldEludGVydmFsKGZ1bmMsIGR1cmF0aW9uKSB7CiAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4yID4gMiA/IF9sZW4yIC0gMiA6IDApLCBfa2V5MiA9IDI7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICBhcmdzW19rZXkyIC0gMl0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICB9CgogICAgICBpZiAoX19ERVZfXyAmJiBJU19BTkRST0lEICYmIGR1cmF0aW9uID4gTUFYX1RJTUVSX0RVUkFUSU9OX01TKSB7CiAgICAgICAgY29uc29sZS53YXJuKEFORFJPSURfTE9OR19USU1FUl9NRVNTQUdFICsgJ1xuJyArICcoU2F3IHNldEludGVydmFsIHdpdGggZHVyYXRpb24gJyArIGR1cmF0aW9uICsgJ21zKScpOwogICAgICB9CgogICAgICB2YXIgaWQgPSBfYWxsb2NhdGVDYWxsYmFjayhmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsKICAgICAgfSwgJ3NldEludGVydmFsJyk7CgogICAgICBUaW1pbmcuY3JlYXRlVGltZXIoaWQsIGR1cmF0aW9uIHx8IDAsIERhdGUubm93KCksIHRydWUpOwogICAgICByZXR1cm4gaWQ7CiAgICB9LAogICAgc2V0SW1tZWRpYXRlOiBmdW5jdGlvbiBzZXRJbW1lZGlhdGUoZnVuYykgewogICAgICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMyA+IDEgPyBfbGVuMyAtIDEgOiAwKSwgX2tleTMgPSAxOyBfa2V5MyA8IF9sZW4zOyBfa2V5MysrKSB7CiAgICAgICAgYXJnc1tfa2V5MyAtIDFdID0gYXJndW1lbnRzW19rZXkzXTsKICAgICAgfQoKICAgICAgdmFyIGlkID0gX2FsbG9jYXRlQ2FsbGJhY2soZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7CiAgICAgIH0sICdzZXRJbW1lZGlhdGUnKTsKCiAgICAgIGltbWVkaWF0ZXMucHVzaChpZCk7CiAgICAgIHJldHVybiBpZDsKICAgIH0sCiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWU6IGZ1bmN0aW9uIHJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jKSB7CiAgICAgIHZhciBpZCA9IF9hbGxvY2F0ZUNhbGxiYWNrKGZ1bmMsICdyZXF1ZXN0QW5pbWF0aW9uRnJhbWUnKTsKCiAgICAgIFRpbWluZy5jcmVhdGVUaW1lcihpZCwgMSwgRGF0ZS5ub3coKSwgZmFsc2UpOwogICAgICByZXR1cm4gaWQ7CiAgICB9LAogICAgcmVxdWVzdElkbGVDYWxsYmFjazogZnVuY3Rpb24gcmVxdWVzdElkbGVDYWxsYmFjayhmdW5jLCBvcHRpb25zKSB7CiAgICAgIGlmIChyZXF1ZXN0SWRsZUNhbGxiYWNrcy5sZW5ndGggPT09IDApIHsKICAgICAgICBUaW1pbmcuc2V0U2VuZElkbGVFdmVudHModHJ1ZSk7CiAgICAgIH0KCiAgICAgIHZhciB0aW1lb3V0ID0gb3B0aW9ucyAmJiBvcHRpb25zLnRpbWVvdXQ7CgogICAgICB2YXIgaWQgPSBfYWxsb2NhdGVDYWxsYmFjayh0aW1lb3V0ICE9IG51bGwgPyBmdW5jdGlvbiAoZGVhZGxpbmUpIHsKICAgICAgICB2YXIgdGltZW91dElkID0gcmVxdWVzdElkbGVDYWxsYmFja1RpbWVvdXRzW2lkXTsKCiAgICAgICAgaWYgKHRpbWVvdXRJZCkgewogICAgICAgICAgSlNUaW1lcnMuY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgICBkZWxldGUgcmVxdWVzdElkbGVDYWxsYmFja1RpbWVvdXRzW2lkXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmdW5jKGRlYWRsaW5lKTsKICAgICAgfSA6IGZ1bmMsICdyZXF1ZXN0SWRsZUNhbGxiYWNrJyk7CgogICAgICByZXF1ZXN0SWRsZUNhbGxiYWNrcy5wdXNoKGlkKTsKCiAgICAgIGlmICh0aW1lb3V0ICE9IG51bGwpIHsKICAgICAgICB2YXIgdGltZW91dElkID0gSlNUaW1lcnMuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSByZXF1ZXN0SWRsZUNhbGxiYWNrcy5pbmRleE9mKGlkKTsKCiAgICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgICByZXF1ZXN0SWRsZUNhbGxiYWNrcy5zcGxpY2UoaW5kZXgsIDEpOwoKICAgICAgICAgICAgX2NhbGxUaW1lcihpZCwgcGVyZm9ybWFuY2VOb3coKSwgdHJ1ZSk7CiAgICAgICAgICB9CgogICAgICAgICAgZGVsZXRlIHJlcXVlc3RJZGxlQ2FsbGJhY2tUaW1lb3V0c1tpZF07CgogICAgICAgICAgaWYgKHJlcXVlc3RJZGxlQ2FsbGJhY2tzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBUaW1pbmcuc2V0U2VuZElkbGVFdmVudHMoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0sIHRpbWVvdXQpOwogICAgICAgIHJlcXVlc3RJZGxlQ2FsbGJhY2tUaW1lb3V0c1tpZF0gPSB0aW1lb3V0SWQ7CiAgICAgIH0KCiAgICAgIHJldHVybiBpZDsKICAgIH0sCiAgICBjYW5jZWxJZGxlQ2FsbGJhY2s6IGZ1bmN0aW9uIGNhbmNlbElkbGVDYWxsYmFjayh0aW1lcklEKSB7CiAgICAgIF9mcmVlQ2FsbGJhY2sodGltZXJJRCk7CgogICAgICB2YXIgaW5kZXggPSByZXF1ZXN0SWRsZUNhbGxiYWNrcy5pbmRleE9mKHRpbWVySUQpOwoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIHJlcXVlc3RJZGxlQ2FsbGJhY2tzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KCiAgICAgIHZhciB0aW1lb3V0SWQgPSByZXF1ZXN0SWRsZUNhbGxiYWNrVGltZW91dHNbdGltZXJJRF07CgogICAgICBpZiAodGltZW91dElkKSB7CiAgICAgICAgSlNUaW1lcnMuY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgZGVsZXRlIHJlcXVlc3RJZGxlQ2FsbGJhY2tUaW1lb3V0c1t0aW1lcklEXTsKICAgICAgfQoKICAgICAgaWYgKHJlcXVlc3RJZGxlQ2FsbGJhY2tzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIFRpbWluZy5zZXRTZW5kSWRsZUV2ZW50cyhmYWxzZSk7CiAgICAgIH0KICAgIH0sCiAgICBjbGVhclRpbWVvdXQ6IGZ1bmN0aW9uIGNsZWFyVGltZW91dCh0aW1lcklEKSB7CiAgICAgIF9mcmVlQ2FsbGJhY2sodGltZXJJRCk7CiAgICB9LAogICAgY2xlYXJJbnRlcnZhbDogZnVuY3Rpb24gY2xlYXJJbnRlcnZhbCh0aW1lcklEKSB7CiAgICAgIF9mcmVlQ2FsbGJhY2sodGltZXJJRCk7CiAgICB9LAogICAgY2xlYXJJbW1lZGlhdGU6IGZ1bmN0aW9uIGNsZWFySW1tZWRpYXRlKHRpbWVySUQpIHsKICAgICAgX2ZyZWVDYWxsYmFjayh0aW1lcklEKTsKCiAgICAgIHZhciBpbmRleCA9IGltbWVkaWF0ZXMuaW5kZXhPZih0aW1lcklEKTsKCiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICBpbW1lZGlhdGVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgIH0sCiAgICBjYW5jZWxBbmltYXRpb25GcmFtZTogZnVuY3Rpb24gY2FuY2VsQW5pbWF0aW9uRnJhbWUodGltZXJJRCkgewogICAgICBfZnJlZUNhbGxiYWNrKHRpbWVySUQpOwogICAgfSwKICAgIGNhbGxUaW1lcnM6IGZ1bmN0aW9uIGNhbGxUaW1lcnModGltZXJzVG9DYWxsKSB7CiAgICAgIGludmFyaWFudCh0aW1lcnNUb0NhbGwubGVuZ3RoICE9PSAwLCAnQ2Fubm90IGNhbGwgYGNhbGxUaW1lcnNgIHdpdGggYW4gZW1wdHkgbGlzdCBvZiBJRHMuJyk7CiAgICAgIGVycm9ycyA9IG51bGw7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRpbWVyc1RvQ2FsbC5sZW5ndGg7IGkrKykgewogICAgICAgIF9jYWxsVGltZXIodGltZXJzVG9DYWxsW2ldLCAwKTsKICAgICAgfQoKICAgICAgaWYgKGVycm9ycykgewogICAgICAgIHZhciBlcnJvckNvdW50ID0gZXJyb3JzLmxlbmd0aDsKCiAgICAgICAgaWYgKGVycm9yQ291bnQgPiAxKSB7CiAgICAgICAgICBmb3IgKHZhciBpaSA9IDE7IGlpIDwgZXJyb3JDb3VudDsgaWkrKykgewogICAgICAgICAgICBKU1RpbWVycy5zZXRUaW1lb3V0KGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICB9LmJpbmQobnVsbCwgZXJyb3JzW2lpXSksIDApOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhyb3cgZXJyb3JzWzBdOwogICAgICB9CiAgICB9LAogICAgY2FsbElkbGVDYWxsYmFja3M6IGZ1bmN0aW9uIGNhbGxJZGxlQ2FsbGJhY2tzKGZyYW1lVGltZSkgewogICAgICBpZiAoRlJBTUVfRFVSQVRJT04gLSAocGVyZm9ybWFuY2VOb3coKSAtIGZyYW1lVGltZSkgPCBJRExFX0NBTExCQUNLX0ZSQU1FX0RFQURMSU5FKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBlcnJvcnMgPSBudWxsOwoKICAgICAgaWYgKHJlcXVlc3RJZGxlQ2FsbGJhY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgcGFzc0lkbGVDYWxsYmFja3MgPSByZXF1ZXN0SWRsZUNhbGxiYWNrcy5zbGljZSgpOwogICAgICAgIHJlcXVlc3RJZGxlQ2FsbGJhY2tzID0gW107CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFzc0lkbGVDYWxsYmFja3MubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIF9jYWxsVGltZXIocGFzc0lkbGVDYWxsYmFja3NbaV0sIGZyYW1lVGltZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocmVxdWVzdElkbGVDYWxsYmFja3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgVGltaW5nLnNldFNlbmRJZGxlRXZlbnRzKGZhbHNlKTsKICAgICAgfQoKICAgICAgaWYgKGVycm9ycykgewogICAgICAgIGVycm9ycy5mb3JFYWNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgcmV0dXJuIEpTVGltZXJzLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgIH0sIDApOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgY2FsbEltbWVkaWF0ZXM6IGZ1bmN0aW9uIGNhbGxJbW1lZGlhdGVzKCkgewogICAgICBlcnJvcnMgPSBudWxsOwoKICAgICAgd2hpbGUgKF9jYWxsSW1tZWRpYXRlc1Bhc3MoKSkge30KCiAgICAgIGlmIChlcnJvcnMpIHsKICAgICAgICBlcnJvcnMuZm9yRWFjaChmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIHJldHVybiBKU1RpbWVycy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICB9LCAwKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIGVtaXRUaW1lRHJpZnRXYXJuaW5nOiBmdW5jdGlvbiBlbWl0VGltZURyaWZ0V2FybmluZyh3YXJuaW5nTWVzc2FnZSkgewogICAgICBpZiAoaGFzRW1pdHRlZFRpbWVEcmlmdFdhcm5pbmcpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGhhc0VtaXR0ZWRUaW1lRHJpZnRXYXJuaW5nID0gdHJ1ZTsKICAgICAgY29uc29sZS53YXJuKHdhcm5pbmdNZXNzYWdlKTsKICAgIH0KICB9OwoKICBpZiAoIVRpbWluZykgewogICAgY29uc29sZS53YXJuKCJUaW1pbmcgbmF0aXZlIG1vZHVsZSBpcyBub3QgYXZhaWxhYmxlLCBjYW4ndCBzZXQgdGltZXJzLiIpOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGNhbGxJbW1lZGlhdGVzOiBKU1RpbWVycy5jYWxsSW1tZWRpYXRlcywKICAgICAgc2V0SW1tZWRpYXRlOiBKU1RpbWVycy5zZXRJbW1lZGlhdGUKICAgIH07CiAgfSBlbHNlIHsKICAgIG1vZHVsZS5leHBvcnRzID0gSlNUaW1lcnM7CiAgfQp9LDUxLFs1MiwxOSwxMywxNSw1MywzMiw1Nl0sIkpTVGltZXJzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgTmF0aXZlTW9kdWxlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIik7CgogIHZhciBQbGF0Zm9ybSA9IHsKICAgIE9TOiAnYW5kcm9pZCcsCgogICAgZ2V0IFZlcnNpb24oKSB7CiAgICAgIHZhciBjb25zdGFudHMgPSBOYXRpdmVNb2R1bGVzLlBsYXRmb3JtQ29uc3RhbnRzOwogICAgICByZXR1cm4gY29uc3RhbnRzICYmIGNvbnN0YW50cy5WZXJzaW9uOwogICAgfSwKCiAgICBnZXQgaXNUZXN0aW5nKCkgewogICAgICB2YXIgY29uc3RhbnRzID0gTmF0aXZlTW9kdWxlcy5QbGF0Zm9ybUNvbnN0YW50czsKICAgICAgcmV0dXJuIGNvbnN0YW50cyAmJiBjb25zdGFudHMuaXNUZXN0aW5nOwogICAgfSwKCiAgICBzZWxlY3Q6IGZ1bmN0aW9uIHNlbGVjdChvYmopIHsKICAgICAgcmV0dXJuICdhbmRyb2lkJyBpbiBvYmogPyBvYmouYW5kcm9pZCA6IG9iai5kZWZhdWx0OwogICAgfQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBQbGF0Zm9ybTsKfSw1MixbMTVdLCJQbGF0Zm9ybSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIHBlcmZvcm1hbmNlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgJy4vcGVyZm9ybWFuY2UnKTsKCiAgdmFyIHBlcmZvcm1hbmNlTm93OwoKICBpZiAocGVyZm9ybWFuY2Uubm93KSB7CiAgICBwZXJmb3JtYW5jZU5vdyA9IGZ1bmN0aW9uIHBlcmZvcm1hbmNlTm93KCkgewogICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICB9OwogIH0gZWxzZSB7CiAgICBwZXJmb3JtYW5jZU5vdyA9IGZ1bmN0aW9uIHBlcmZvcm1hbmNlTm93KCkgewogICAgICByZXR1cm4gRGF0ZS5ub3coKTsKICAgIH07CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IHBlcmZvcm1hbmNlTm93Owp9LDUzLFs1NF0sImZianMvbGliL3BlcmZvcm1hbmNlTm93LmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgRXhlY3V0aW9uRW52aXJvbm1lbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9FeGVjdXRpb25FbnZpcm9ubWVudCcpOwoKICB2YXIgcGVyZm9ybWFuY2U7CgogIGlmIChFeGVjdXRpb25FbnZpcm9ubWVudC5jYW5Vc2VET00pIHsKICAgIHBlcmZvcm1hbmNlID0gd2luZG93LnBlcmZvcm1hbmNlIHx8IHdpbmRvdy5tc1BlcmZvcm1hbmNlIHx8IHdpbmRvdy53ZWJraXRQZXJmb3JtYW5jZTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gcGVyZm9ybWFuY2UgfHwge307Cn0sNTQsWzU1XSwiZmJqcy9saWIvcGVyZm9ybWFuY2UuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBjYW5Vc2VET00gPSAhISh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuZG9jdW1lbnQgJiYgd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQpOwogIHZhciBFeGVjdXRpb25FbnZpcm9ubWVudCA9IHsKICAgIGNhblVzZURPTTogY2FuVXNlRE9NLAogICAgY2FuVXNlV29ya2VyczogdHlwZW9mIFdvcmtlciAhPT0gJ3VuZGVmaW5lZCcsCiAgICBjYW5Vc2VFdmVudExpc3RlbmVyczogY2FuVXNlRE9NICYmICEhKHdpbmRvdy5hZGRFdmVudExpc3RlbmVyIHx8IHdpbmRvdy5hdHRhY2hFdmVudCksCiAgICBjYW5Vc2VWaWV3cG9ydDogY2FuVXNlRE9NICYmICEhd2luZG93LnNjcmVlbiwKICAgIGlzSW5Xb3JrZXI6ICFjYW5Vc2VET00KICB9OwogIG1vZHVsZS5leHBvcnRzID0gRXhlY3V0aW9uRW52aXJvbm1lbnQ7Cn0sNTUsW10sImZianMvbGliL0V4ZWN1dGlvbkVudmlyb25tZW50LmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgZW1wdHlGdW5jdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL2VtcHR5RnVuY3Rpb24nKTsKCiAgdmFyIHdhcm5pbmcgPSBlbXB0eUZ1bmN0aW9uOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgdmFyIHByaW50V2FybmluZyA9IGZ1bmN0aW9uIHByaW50V2FybmluZyhmb3JtYXQpIHsKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHZhciBhcmdJbmRleCA9IDA7CiAgICAgIHZhciBtZXNzYWdlID0gJ1dhcm5pbmc6ICcgKyBmb3JtYXQucmVwbGFjZSgvJXMvZywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBhcmdzW2FyZ0luZGV4KytdOwogICAgICB9KTsKCiAgICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpOwogICAgICB9CgogICAgICB0cnkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTsKICAgICAgfSBjYXRjaCAoeCkge30KICAgIH07CgogICAgd2FybmluZyA9IGZ1bmN0aW9uIHdhcm5pbmcoY29uZGl0aW9uLCBmb3JtYXQpIHsKICAgICAgaWYgKGZvcm1hdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdgd2FybmluZyhjb25kaXRpb24sIGZvcm1hdCwgLi4uYXJncylgIHJlcXVpcmVzIGEgd2FybmluZyAnICsgJ21lc3NhZ2UgYXJndW1lbnQnKTsKICAgICAgfQoKICAgICAgaWYgKGZvcm1hdC5pbmRleE9mKCdGYWlsZWQgQ29tcG9zaXRlIHByb3BUeXBlOiAnKSA9PT0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCFjb25kaXRpb24pIHsKICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMiA+IDIgPyBfbGVuMiAtIDIgOiAwKSwgX2tleTIgPSAyOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICBhcmdzW19rZXkyIC0gMl0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgIH0KCiAgICAgICAgcHJpbnRXYXJuaW5nLmFwcGx5KHVuZGVmaW5lZCwgW2Zvcm1hdF0uY29uY2F0KGFyZ3MpKTsKICAgICAgfQogICAgfTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gd2FybmluZzsKfSw1NixbNTddLCJmYmpzL2xpYi93YXJuaW5nLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgInVzZSBzdHJpY3QiOwoKICBmdW5jdGlvbiBtYWtlRW1wdHlGdW5jdGlvbihhcmcpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBhcmc7CiAgICB9OwogIH0KCiAgdmFyIGVtcHR5RnVuY3Rpb24gPSBmdW5jdGlvbiBlbXB0eUZ1bmN0aW9uKCkge307CgogIGVtcHR5RnVuY3Rpb24udGhhdFJldHVybnMgPSBtYWtlRW1wdHlGdW5jdGlvbjsKICBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zRmFsc2UgPSBtYWtlRW1wdHlGdW5jdGlvbihmYWxzZSk7CiAgZW1wdHlGdW5jdGlvbi50aGF0UmV0dXJuc1RydWUgPSBtYWtlRW1wdHlGdW5jdGlvbih0cnVlKTsKICBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zTnVsbCA9IG1ha2VFbXB0eUZ1bmN0aW9uKG51bGwpOwoKICBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zVGhpcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzOwogIH07CgogIGVtcHR5RnVuY3Rpb24udGhhdFJldHVybnNBcmd1bWVudCA9IGZ1bmN0aW9uIChhcmcpIHsKICAgIHJldHVybiBhcmc7CiAgfTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBlbXB0eUZ1bmN0aW9uOwp9LDU3LFtdLCJmYmpzL2xpYi9lbXB0eUZ1bmN0aW9uLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2NsYXNzMiwgX3RlbXA7CgogIHZhciBFdmVudFRhcmdldCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJldmVudC10YXJnZXQtc2hpbSIpOwoKICB2YXIgUkNUTmV0d29ya2luZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJSQ1ROZXR3b3JraW5nIik7CgogIHZhciBiYXNlNjQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiYmFzZTY0LWpzIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciB3YXJuaW5nID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgImZianMvbGliL3dhcm5pbmciKTsKCiAgdmFyIFVOU0VOVCA9IDA7CiAgdmFyIE9QRU5FRCA9IDE7CiAgdmFyIEhFQURFUlNfUkVDRUlWRUQgPSAyOwogIHZhciBMT0FESU5HID0gMzsKICB2YXIgRE9ORSA9IDQ7CiAgdmFyIFNVUFBPUlRFRF9SRVNQT05TRV9UWVBFUyA9IHsKICAgIGFycmF5YnVmZmVyOiB0eXBlb2YgZ2xvYmFsLkFycmF5QnVmZmVyID09PSAnZnVuY3Rpb24nLAogICAgYmxvYjogdHlwZW9mIGdsb2JhbC5CbG9iID09PSAnZnVuY3Rpb24nLAogICAgZG9jdW1lbnQ6IGZhbHNlLAogICAganNvbjogdHJ1ZSwKICAgIHRleHQ6IHRydWUsCiAgICAnJzogdHJ1ZQogIH07CiAgdmFyIFJFUVVFU1RfRVZFTlRTID0gWydhYm9ydCcsICdlcnJvcicsICdsb2FkJywgJ2xvYWRzdGFydCcsICdwcm9ncmVzcycsICd0aW1lb3V0JywgJ2xvYWRlbmQnXTsKICB2YXIgWEhSX0VWRU5UUyA9IFJFUVVFU1RfRVZFTlRTLmNvbmNhdCgncmVhZHlzdGF0ZWNoYW5nZScpOwoKICB2YXIgWE1MSHR0cFJlcXVlc3RFdmVudFRhcmdldCA9IGZ1bmN0aW9uIChfRXZlbnRUYXJnZXQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhYTUxIdHRwUmVxdWVzdEV2ZW50VGFyZ2V0LCBfRXZlbnRUYXJnZXQpOwoKICAgIGZ1bmN0aW9uIFhNTEh0dHBSZXF1ZXN0RXZlbnRUYXJnZXQoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBYTUxIdHRwUmVxdWVzdEV2ZW50VGFyZ2V0KTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChYTUxIdHRwUmVxdWVzdEV2ZW50VGFyZ2V0Ll9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoWE1MSHR0cFJlcXVlc3RFdmVudFRhcmdldCkpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfQoKICAgIHJldHVybiBYTUxIdHRwUmVxdWVzdEV2ZW50VGFyZ2V0OwogIH0oRXZlbnRUYXJnZXQuYXBwbHkodW5kZWZpbmVkLCBSRVFVRVNUX0VWRU5UUykpOwoKICB2YXIgWE1MSHR0cFJlcXVlc3QgPSAoX3RlbXAgPSBfY2xhc3MyID0gZnVuY3Rpb24gKF9FdmVudFRhcmdldDIpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhYTUxIdHRwUmVxdWVzdCwgX0V2ZW50VGFyZ2V0Mik7CiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoWE1MSHR0cFJlcXVlc3QsIG51bGwsIFt7CiAgICAgIGtleTogInNldEludGVyY2VwdG9yIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldEludGVyY2VwdG9yKGludGVyY2VwdG9yKSB7CiAgICAgICAgWE1MSHR0cFJlcXVlc3QuX2ludGVyY2VwdG9yID0gaW50ZXJjZXB0b3I7CiAgICAgIH0KICAgIH1dKTsKCiAgICBmdW5jdGlvbiBYTUxIdHRwUmVxdWVzdCgpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFhNTEh0dHBSZXF1ZXN0KTsKCiAgICAgIHZhciBfdGhpczIgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoWE1MSHR0cFJlcXVlc3QuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihYTUxIdHRwUmVxdWVzdCkpLmNhbGwodGhpcykpOwoKICAgICAgX3RoaXMyLlVOU0VOVCA9IFVOU0VOVDsKICAgICAgX3RoaXMyLk9QRU5FRCA9IE9QRU5FRDsKICAgICAgX3RoaXMyLkhFQURFUlNfUkVDRUlWRUQgPSBIRUFERVJTX1JFQ0VJVkVEOwogICAgICBfdGhpczIuTE9BRElORyA9IExPQURJTkc7CiAgICAgIF90aGlzMi5ET05FID0gRE9ORTsKICAgICAgX3RoaXMyLnJlYWR5U3RhdGUgPSBVTlNFTlQ7CiAgICAgIF90aGlzMi5zdGF0dXMgPSAwOwogICAgICBfdGhpczIudGltZW91dCA9IDA7CiAgICAgIF90aGlzMi53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICBfdGhpczIudXBsb2FkID0gbmV3IFhNTEh0dHBSZXF1ZXN0RXZlbnRUYXJnZXQoKTsKICAgICAgX3RoaXMyLl9hYm9ydGVkID0gZmFsc2U7CiAgICAgIF90aGlzMi5faGFzRXJyb3IgPSBmYWxzZTsKICAgICAgX3RoaXMyLl9tZXRob2QgPSBudWxsOwogICAgICBfdGhpczIuX3Jlc3BvbnNlID0gJyc7CiAgICAgIF90aGlzMi5fdXJsID0gbnVsbDsKICAgICAgX3RoaXMyLl90aW1lZE91dCA9IGZhbHNlOwogICAgICBfdGhpczIuX3RyYWNraW5nTmFtZSA9ICd1bmtub3duJzsKICAgICAgX3RoaXMyLl9pbmNyZW1lbnRhbEV2ZW50cyA9IGZhbHNlOwoKICAgICAgX3RoaXMyLl9yZXNldCgpOwoKICAgICAgcmV0dXJuIF90aGlzMjsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoWE1MSHR0cFJlcXVlc3QsIFt7CiAgICAgIGtleTogIl9yZXNldCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfcmVzZXQoKSB7CiAgICAgICAgdGhpcy5yZWFkeVN0YXRlID0gdGhpcy5VTlNFTlQ7CiAgICAgICAgdGhpcy5yZXNwb25zZUhlYWRlcnMgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5zdGF0dXMgPSAwOwogICAgICAgIGRlbGV0ZSB0aGlzLnJlc3BvbnNlVVJMOwogICAgICAgIHRoaXMuX3JlcXVlc3RJZCA9IG51bGw7CiAgICAgICAgdGhpcy5fY2FjaGVkUmVzcG9uc2UgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5faGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICB0aGlzLl9oZWFkZXJzID0ge307CiAgICAgICAgdGhpcy5fcmVzcG9uc2UgPSAnJzsKICAgICAgICB0aGlzLl9yZXNwb25zZVR5cGUgPSAnJzsKICAgICAgICB0aGlzLl9zZW50ID0gZmFsc2U7CiAgICAgICAgdGhpcy5fbG93ZXJDYXNlUmVzcG9uc2VIZWFkZXJzID0ge307CgogICAgICAgIHRoaXMuX2NsZWFyU3Vic2NyaXB0aW9ucygpOwoKICAgICAgICB0aGlzLl90aW1lZE91dCA9IGZhbHNlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZGlkQ3JlYXRlUmVxdWVzdCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2RpZENyZWF0ZVJlcXVlc3QocmVxdWVzdElkKSB7CiAgICAgICAgdGhpcy5fcmVxdWVzdElkID0gcmVxdWVzdElkOwogICAgICAgIFhNTEh0dHBSZXF1ZXN0Ll9pbnRlcmNlcHRvciAmJiBYTUxIdHRwUmVxdWVzdC5faW50ZXJjZXB0b3IucmVxdWVzdFNlbnQocmVxdWVzdElkLCB0aGlzLl91cmwgfHwgJycsIHRoaXMuX21ldGhvZCB8fCAnR0VUJywgdGhpcy5faGVhZGVycyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19kaWRVcGxvYWRQcm9ncmVzcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2RpZFVwbG9hZFByb2dyZXNzKHJlcXVlc3RJZCwgcHJvZ3Jlc3MsIHRvdGFsKSB7CiAgICAgICAgaWYgKHJlcXVlc3RJZCA9PT0gdGhpcy5fcmVxdWVzdElkKSB7CiAgICAgICAgICB0aGlzLnVwbG9hZC5kaXNwYXRjaEV2ZW50KHsKICAgICAgICAgICAgdHlwZTogJ3Byb2dyZXNzJywKICAgICAgICAgICAgbGVuZ3RoQ29tcHV0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgbG9hZGVkOiBwcm9ncmVzcywKICAgICAgICAgICAgdG90YWw6IHRvdGFsCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19kaWRSZWNlaXZlUmVzcG9uc2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19kaWRSZWNlaXZlUmVzcG9uc2UocmVxdWVzdElkLCBzdGF0dXMsIHJlc3BvbnNlSGVhZGVycywgcmVzcG9uc2VVUkwpIHsKICAgICAgICBpZiAocmVxdWVzdElkID09PSB0aGlzLl9yZXF1ZXN0SWQpIHsKICAgICAgICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgICAgICAgdGhpcy5zZXRSZXNwb25zZUhlYWRlcnMocmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgIHRoaXMuc2V0UmVhZHlTdGF0ZSh0aGlzLkhFQURFUlNfUkVDRUlWRUQpOwoKICAgICAgICAgIGlmIChyZXNwb25zZVVSTCB8fCByZXNwb25zZVVSTCA9PT0gJycpIHsKICAgICAgICAgICAgdGhpcy5yZXNwb25zZVVSTCA9IHJlc3BvbnNlVVJMOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMucmVzcG9uc2VVUkw7CiAgICAgICAgICB9CgogICAgICAgICAgWE1MSHR0cFJlcXVlc3QuX2ludGVyY2VwdG9yICYmIFhNTEh0dHBSZXF1ZXN0Ll9pbnRlcmNlcHRvci5yZXNwb25zZVJlY2VpdmVkKHJlcXVlc3RJZCwgcmVzcG9uc2VVUkwgfHwgdGhpcy5fdXJsIHx8ICcnLCBzdGF0dXMsIHJlc3BvbnNlSGVhZGVycyB8fCB7fSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZGlkUmVjZWl2ZURhdGEiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19kaWRSZWNlaXZlRGF0YShyZXF1ZXN0SWQsIHJlc3BvbnNlKSB7CiAgICAgICAgaWYgKHJlcXVlc3RJZCAhPT0gdGhpcy5fcmVxdWVzdElkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9yZXNwb25zZSA9IHJlc3BvbnNlOwogICAgICAgIHRoaXMuX2NhY2hlZFJlc3BvbnNlID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMuc2V0UmVhZHlTdGF0ZSh0aGlzLkxPQURJTkcpOwogICAgICAgIFhNTEh0dHBSZXF1ZXN0Ll9pbnRlcmNlcHRvciAmJiBYTUxIdHRwUmVxdWVzdC5faW50ZXJjZXB0b3IuZGF0YVJlY2VpdmVkKHJlcXVlc3RJZCwgcmVzcG9uc2UpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZGlkUmVjZWl2ZUluY3JlbWVudGFsRGF0YSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2RpZFJlY2VpdmVJbmNyZW1lbnRhbERhdGEocmVxdWVzdElkLCByZXNwb25zZVRleHQsIHByb2dyZXNzLCB0b3RhbCkgewogICAgICAgIGlmIChyZXF1ZXN0SWQgIT09IHRoaXMuX3JlcXVlc3RJZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLl9yZXNwb25zZSkgewogICAgICAgICAgdGhpcy5fcmVzcG9uc2UgPSByZXNwb25zZVRleHQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX3Jlc3BvbnNlICs9IHJlc3BvbnNlVGV4dDsKICAgICAgICB9CgogICAgICAgIFhNTEh0dHBSZXF1ZXN0Ll9pbnRlcmNlcHRvciAmJiBYTUxIdHRwUmVxdWVzdC5faW50ZXJjZXB0b3IuZGF0YVJlY2VpdmVkKHJlcXVlc3RJZCwgcmVzcG9uc2VUZXh0KTsKICAgICAgICB0aGlzLnNldFJlYWR5U3RhdGUodGhpcy5MT0FESU5HKTsKCiAgICAgICAgdGhpcy5fX2RpZFJlY2VpdmVEYXRhUHJvZ3Jlc3MocmVxdWVzdElkLCBwcm9ncmVzcywgdG90YWwpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZGlkUmVjZWl2ZURhdGFQcm9ncmVzcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2RpZFJlY2VpdmVEYXRhUHJvZ3Jlc3MocmVxdWVzdElkLCBsb2FkZWQsIHRvdGFsKSB7CiAgICAgICAgaWYgKHJlcXVlc3RJZCAhPT0gdGhpcy5fcmVxdWVzdElkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoewogICAgICAgICAgdHlwZTogJ3Byb2dyZXNzJywKICAgICAgICAgIGxlbmd0aENvbXB1dGFibGU6IHRvdGFsID49IDAsCiAgICAgICAgICBsb2FkZWQ6IGxvYWRlZCwKICAgICAgICAgIHRvdGFsOiB0b3RhbAogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZGlkQ29tcGxldGVSZXNwb25zZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2RpZENvbXBsZXRlUmVzcG9uc2UocmVxdWVzdElkLCBlcnJvciwgdGltZU91dEVycm9yKSB7CiAgICAgICAgaWYgKHJlcXVlc3RJZCA9PT0gdGhpcy5fcmVxdWVzdElkKSB7CiAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3Jlc3BvbnNlVHlwZSA9PT0gJycgfHwgdGhpcy5fcmVzcG9uc2VUeXBlID09PSAndGV4dCcpIHsKICAgICAgICAgICAgICB0aGlzLl9yZXNwb25zZSA9IGVycm9yOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9oYXNFcnJvciA9IHRydWU7CgogICAgICAgICAgICBpZiAodGltZU91dEVycm9yKSB7CiAgICAgICAgICAgICAgdGhpcy5fdGltZWRPdXQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5fY2xlYXJTdWJzY3JpcHRpb25zKCk7CgogICAgICAgICAgdGhpcy5fcmVxdWVzdElkID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2V0UmVhZHlTdGF0ZSh0aGlzLkRPTkUpOwoKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICBYTUxIdHRwUmVxdWVzdC5faW50ZXJjZXB0b3IgJiYgWE1MSHR0cFJlcXVlc3QuX2ludGVyY2VwdG9yLmxvYWRpbmdGYWlsZWQocmVxdWVzdElkLCBlcnJvcik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBYTUxIdHRwUmVxdWVzdC5faW50ZXJjZXB0b3IgJiYgWE1MSHR0cFJlcXVlc3QuX2ludGVyY2VwdG9yLmxvYWRpbmdGaW5pc2hlZChyZXF1ZXN0SWQsIHRoaXMuX3Jlc3BvbnNlLmxlbmd0aCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9jbGVhclN1YnNjcmlwdGlvbnMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2NsZWFyU3Vic2NyaXB0aW9ucygpIHsKICAgICAgICAodGhpcy5fc3Vic2NyaXB0aW9ucyB8fCBbXSkuZm9yRWFjaChmdW5jdGlvbiAoc3ViKSB7CiAgICAgICAgICBpZiAoc3ViKSB7CiAgICAgICAgICAgIHN1Yi5yZW1vdmUoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zID0gW107CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0QWxsUmVzcG9uc2VIZWFkZXJzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldEFsbFJlc3BvbnNlSGVhZGVycygpIHsKICAgICAgICBpZiAoIXRoaXMucmVzcG9uc2VIZWFkZXJzKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHZhciBoZWFkZXJzID0gdGhpcy5yZXNwb25zZUhlYWRlcnMgfHwge307CiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGhlYWRlcnMpLm1hcChmdW5jdGlvbiAoaGVhZGVyTmFtZSkgewogICAgICAgICAgcmV0dXJuIGhlYWRlck5hbWUgKyAnOiAnICsgaGVhZGVyc1toZWFkZXJOYW1lXTsKICAgICAgICB9KS5qb2luKCdcclxuJyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0UmVzcG9uc2VIZWFkZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0UmVzcG9uc2VIZWFkZXIoaGVhZGVyKSB7CiAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5fbG93ZXJDYXNlUmVzcG9uc2VIZWFkZXJzW2hlYWRlci50b0xvd2VyQ2FzZSgpXTsKCiAgICAgICAgcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPyB2YWx1ZSA6IG51bGw7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2V0UmVxdWVzdEhlYWRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRSZXF1ZXN0SGVhZGVyKGhlYWRlciwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlICE9PSB0aGlzLk9QRU5FRCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGhhcyBub3QgYmVlbiBvcGVuZWQnKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2hlYWRlcnNbaGVhZGVyLnRvTG93ZXJDYXNlKCldID0gU3RyaW5nKHZhbHVlKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzZXRUcmFja2luZ05hbWUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0VHJhY2tpbmdOYW1lKHRyYWNraW5nTmFtZSkgewogICAgICAgIHRoaXMuX3RyYWNraW5nTmFtZSA9IHRyYWNraW5nTmFtZTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJvcGVuIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIG9wZW4obWV0aG9kLCB1cmwsIGFzeW5jKSB7CiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSAhPT0gdGhpcy5VTlNFTlQpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IG9wZW4sIGFscmVhZHkgc2VuZGluZycpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGFzeW5jICE9PSB1bmRlZmluZWQgJiYgIWFzeW5jKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N5bmNocm9ub3VzIGh0dHAgcmVxdWVzdHMgYXJlIG5vdCBzdXBwb3J0ZWQnKTsKICAgICAgICB9CgogICAgICAgIGlmICghdXJsKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2FkIGFuIGVtcHR5IHVybCcpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fbWV0aG9kID0gbWV0aG9kLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgdGhpcy5fdXJsID0gdXJsOwogICAgICAgIHRoaXMuX2Fib3J0ZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLnNldFJlYWR5U3RhdGUodGhpcy5PUEVORUQpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNlbmQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2VuZChkYXRhKSB7CiAgICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgIT09IHRoaXMuT1BFTkVEKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgaGFzIG5vdCBiZWVuIG9wZW5lZCcpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX3NlbnQpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBoYXMgYWxyZWFkeSBiZWVuIHNlbnQnKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3NlbnQgPSB0cnVlOwogICAgICAgIHZhciBpbmNyZW1lbnRhbEV2ZW50cyA9IHRoaXMuX2luY3JlbWVudGFsRXZlbnRzIHx8ICEhdGhpcy5vbnJlYWR5c3RhdGVjaGFuZ2UgfHwgISF0aGlzLm9ucHJvZ3Jlc3M7CgogICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMucHVzaChSQ1ROZXR3b3JraW5nLmFkZExpc3RlbmVyKCdkaWRTZW5kTmV0d29ya0RhdGEnLCBmdW5jdGlvbiAoYXJncykgewogICAgICAgICAgcmV0dXJuIF90aGlzMy5fX2RpZFVwbG9hZFByb2dyZXNzLmFwcGx5KF90aGlzMywgYmFiZWxIZWxwZXJzLnRvQ29uc3VtYWJsZUFycmF5KGFyZ3MpKTsKICAgICAgICB9KSk7CgogICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMucHVzaChSQ1ROZXR3b3JraW5nLmFkZExpc3RlbmVyKCdkaWRSZWNlaXZlTmV0d29ya1Jlc3BvbnNlJywgZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICAgIHJldHVybiBfdGhpczMuX19kaWRSZWNlaXZlUmVzcG9uc2UuYXBwbHkoX3RoaXMzLCBiYWJlbEhlbHBlcnMudG9Db25zdW1hYmxlQXJyYXkoYXJncykpOwogICAgICAgIH0pKTsKCiAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5wdXNoKFJDVE5ldHdvcmtpbmcuYWRkTGlzdGVuZXIoJ2RpZFJlY2VpdmVOZXR3b3JrRGF0YScsIGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgICAgICByZXR1cm4gX3RoaXMzLl9fZGlkUmVjZWl2ZURhdGEuYXBwbHkoX3RoaXMzLCBiYWJlbEhlbHBlcnMudG9Db25zdW1hYmxlQXJyYXkoYXJncykpOwogICAgICAgIH0pKTsKCiAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5wdXNoKFJDVE5ldHdvcmtpbmcuYWRkTGlzdGVuZXIoJ2RpZFJlY2VpdmVOZXR3b3JrSW5jcmVtZW50YWxEYXRhJywgZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICAgIHJldHVybiBfdGhpczMuX19kaWRSZWNlaXZlSW5jcmVtZW50YWxEYXRhLmFwcGx5KF90aGlzMywgYmFiZWxIZWxwZXJzLnRvQ29uc3VtYWJsZUFycmF5KGFyZ3MpKTsKICAgICAgICB9KSk7CgogICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMucHVzaChSQ1ROZXR3b3JraW5nLmFkZExpc3RlbmVyKCdkaWRSZWNlaXZlTmV0d29ya0RhdGFQcm9ncmVzcycsIGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgICAgICByZXR1cm4gX3RoaXMzLl9fZGlkUmVjZWl2ZURhdGFQcm9ncmVzcy5hcHBseShfdGhpczMsIGJhYmVsSGVscGVycy50b0NvbnN1bWFibGVBcnJheShhcmdzKSk7CiAgICAgICAgfSkpOwoKICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zLnB1c2goUkNUTmV0d29ya2luZy5hZGRMaXN0ZW5lcignZGlkQ29tcGxldGVOZXR3b3JrUmVzcG9uc2UnLCBmdW5jdGlvbiAoYXJncykgewogICAgICAgICAgcmV0dXJuIF90aGlzMy5fX2RpZENvbXBsZXRlUmVzcG9uc2UuYXBwbHkoX3RoaXMzLCBiYWJlbEhlbHBlcnMudG9Db25zdW1hYmxlQXJyYXkoYXJncykpOwogICAgICAgIH0pKTsKCiAgICAgICAgdmFyIG5hdGl2ZVJlc3BvbnNlVHlwZSA9ICd0ZXh0JzsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3BvbnNlVHlwZSA9PT0gJ2FycmF5YnVmZmVyJyB8fCB0aGlzLl9yZXNwb25zZVR5cGUgPT09ICdibG9iJykgewogICAgICAgICAgbmF0aXZlUmVzcG9uc2VUeXBlID0gJ2Jhc2U2NCc7CiAgICAgICAgfQoKICAgICAgICBpbnZhcmlhbnQodGhpcy5fbWV0aG9kLCAnUmVxdWVzdCBtZXRob2QgbmVlZHMgdG8gYmUgZGVmaW5lZC4nKTsKICAgICAgICBpbnZhcmlhbnQodGhpcy5fdXJsLCAnUmVxdWVzdCBVUkwgbmVlZHMgdG8gYmUgZGVmaW5lZC4nKTsKICAgICAgICBSQ1ROZXR3b3JraW5nLnNlbmRSZXF1ZXN0KHRoaXMuX21ldGhvZCwgdGhpcy5fdHJhY2tpbmdOYW1lLCB0aGlzLl91cmwsIHRoaXMuX2hlYWRlcnMsIGRhdGEsIG5hdGl2ZVJlc3BvbnNlVHlwZSwgaW5jcmVtZW50YWxFdmVudHMsIHRoaXMudGltZW91dCwgdGhpcy5fX2RpZENyZWF0ZVJlcXVlc3QuYmluZCh0aGlzKSwgdGhpcy53aXRoQ3JlZGVudGlhbHMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImFib3J0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGFib3J0KCkgewogICAgICAgIHRoaXMuX2Fib3J0ZWQgPSB0cnVlOwoKICAgICAgICBpZiAodGhpcy5fcmVxdWVzdElkKSB7CiAgICAgICAgICBSQ1ROZXR3b3JraW5nLmFib3J0UmVxdWVzdCh0aGlzLl9yZXF1ZXN0SWQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCEodGhpcy5yZWFkeVN0YXRlID09PSB0aGlzLlVOU0VOVCB8fCB0aGlzLnJlYWR5U3RhdGUgPT09IHRoaXMuT1BFTkVEICYmICF0aGlzLl9zZW50IHx8IHRoaXMucmVhZHlTdGF0ZSA9PT0gdGhpcy5ET05FKSkgewogICAgICAgICAgdGhpcy5fcmVzZXQoKTsKCiAgICAgICAgICB0aGlzLnNldFJlYWR5U3RhdGUodGhpcy5ET05FKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2V0UmVzcG9uc2VIZWFkZXJzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldFJlc3BvbnNlSGVhZGVycyhyZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICB0aGlzLnJlc3BvbnNlSGVhZGVycyA9IHJlc3BvbnNlSGVhZGVycyB8fCBudWxsOwogICAgICAgIHZhciBoZWFkZXJzID0gcmVzcG9uc2VIZWFkZXJzIHx8IHt9OwogICAgICAgIHRoaXMuX2xvd2VyQ2FzZVJlc3BvbnNlSGVhZGVycyA9IE9iamVjdC5rZXlzKGhlYWRlcnMpLnJlZHVjZShmdW5jdGlvbiAobGNhc2VIZWFkZXJzLCBoZWFkZXJOYW1lKSB7CiAgICAgICAgICBsY2FzZUhlYWRlcnNbaGVhZGVyTmFtZS50b0xvd2VyQ2FzZSgpXSA9IGhlYWRlcnNbaGVhZGVyTmFtZV07CiAgICAgICAgICByZXR1cm4gbGNhc2VIZWFkZXJzOwogICAgICAgIH0sIHt9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzZXRSZWFkeVN0YXRlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldFJlYWR5U3RhdGUobmV3U3RhdGUpIHsKICAgICAgICB0aGlzLnJlYWR5U3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoewogICAgICAgICAgdHlwZTogJ3JlYWR5c3RhdGVjaGFuZ2UnCiAgICAgICAgfSk7CgogICAgICAgIGlmIChuZXdTdGF0ZSA9PT0gdGhpcy5ET05FKSB7CiAgICAgICAgICBpZiAodGhpcy5fYWJvcnRlZCkgewogICAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoewogICAgICAgICAgICAgIHR5cGU6ICdhYm9ydCcKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2hhc0Vycm9yKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl90aW1lZE91dCkgewogICAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudCh7CiAgICAgICAgICAgICAgICB0eXBlOiAndGltZW91dCcKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoewogICAgICAgICAgICAgICAgdHlwZTogJ2Vycm9yJwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoewogICAgICAgICAgICAgIHR5cGU6ICdsb2FkJwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoewogICAgICAgICAgICB0eXBlOiAnbG9hZGVuZCcKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJhZGRFdmVudExpc3RlbmVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGFkZEV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpIHsKICAgICAgICBpZiAodHlwZSA9PT0gJ3JlYWR5c3RhdGVjaGFuZ2UnIHx8IHR5cGUgPT09ICdwcm9ncmVzcycpIHsKICAgICAgICAgIHRoaXMuX2luY3JlbWVudGFsRXZlbnRzID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGJhYmVsSGVscGVycy5nZXQoWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlKSwgImFkZEV2ZW50TGlzdGVuZXIiLCB0aGlzKS5jYWxsKHRoaXMsIHR5cGUsIGxpc3RlbmVyKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZXNwb25zZVR5cGUiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVzcG9uc2VUeXBlOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChyZXNwb25zZVR5cGUpIHsKICAgICAgICBpZiAodGhpcy5fc2VudCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gc2V0IHRoZSBcJ3Jlc3BvbnNlVHlwZVwnIHByb3BlcnR5IG9uIFwnWE1MSHR0cFJlcXVlc3RcJzogVGhlICcgKyAncmVzcG9uc2UgdHlwZSBjYW5ub3QgYmUgc2V0IGFmdGVyIHRoZSByZXF1ZXN0IGhhcyBiZWVuIHNlbnQuJyk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIVNVUFBPUlRFRF9SRVNQT05TRV9UWVBFUy5oYXNPd25Qcm9wZXJ0eShyZXNwb25zZVR5cGUpKSB7CiAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAiVGhlIHByb3ZpZGVkIHZhbHVlICciICsgcmVzcG9uc2VUeXBlICsgIicgaXMgbm90IGEgdmFsaWQgJ3Jlc3BvbnNlVHlwZScuIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpbnZhcmlhbnQoU1VQUE9SVEVEX1JFU1BPTlNFX1RZUEVTW3Jlc3BvbnNlVHlwZV0gfHwgcmVzcG9uc2VUeXBlID09PSAnZG9jdW1lbnQnLCAiVGhlIHByb3ZpZGVkIHZhbHVlICciICsgcmVzcG9uc2VUeXBlICsgIicgaXMgdW5zdXBwb3J0ZWQgaW4gdGhpcyBlbnZpcm9ubWVudC4iKTsKICAgICAgICB0aGlzLl9yZXNwb25zZVR5cGUgPSByZXNwb25zZVR5cGU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVzcG9uc2VUZXh0IiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX3Jlc3BvbnNlVHlwZSAhPT0gJycgJiYgdGhpcy5fcmVzcG9uc2VUeXBlICE9PSAndGV4dCcpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlICdyZXNwb25zZVRleHQnIHByb3BlcnR5IGlzIG9ubHkgYXZhaWxhYmxlIGlmICdyZXNwb25zZVR5cGUnICIgKyAoImlzIHNldCB0byAnJyBvciAndGV4dCcsIGJ1dCBpdCBpcyAnIiArIHRoaXMuX3Jlc3BvbnNlVHlwZSArICInLiIpKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPCBMT0FESU5HKSB7CiAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5fcmVzcG9uc2U7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVzcG9uc2UiLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICB2YXIgcmVzcG9uc2VUeXBlID0gdGhpcy5yZXNwb25zZVR5cGU7CgogICAgICAgIGlmIChyZXNwb25zZVR5cGUgPT09ICcnIHx8IHJlc3BvbnNlVHlwZSA9PT0gJ3RleHQnKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5yZWFkeVN0YXRlIDwgTE9BRElORyB8fCB0aGlzLl9oYXNFcnJvciA/ICcnIDogdGhpcy5fcmVzcG9uc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlICE9PSBET05FKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9jYWNoZWRSZXNwb25zZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fY2FjaGVkUmVzcG9uc2U7CiAgICAgICAgfQoKICAgICAgICBzd2l0Y2ggKHJlc3BvbnNlVHlwZSkgewogICAgICAgICAgY2FzZSAnZG9jdW1lbnQnOgogICAgICAgICAgICB0aGlzLl9jYWNoZWRSZXNwb25zZSA9IG51bGw7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgJ2FycmF5YnVmZmVyJzoKICAgICAgICAgICAgdGhpcy5fY2FjaGVkUmVzcG9uc2UgPSBiYXNlNjQudG9CeXRlQXJyYXkodGhpcy5fcmVzcG9uc2UpLmJ1ZmZlcjsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAnYmxvYic6CiAgICAgICAgICAgIHRoaXMuX2NhY2hlZFJlc3BvbnNlID0gbmV3IGdsb2JhbC5CbG9iKFtiYXNlNjQudG9CeXRlQXJyYXkodGhpcy5fcmVzcG9uc2UpLmJ1ZmZlcl0sIHsKICAgICAgICAgICAgICB0eXBlOiB0aGlzLmdldFJlc3BvbnNlSGVhZGVyKCdjb250ZW50LXR5cGUnKSB8fCAnJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAnanNvbic6CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGhpcy5fY2FjaGVkUmVzcG9uc2UgPSBKU09OLnBhcnNlKHRoaXMuX3Jlc3BvbnNlKTsKICAgICAgICAgICAgfSBjYXRjaCAoXykgewogICAgICAgICAgICAgIHRoaXMuX2NhY2hlZFJlc3BvbnNlID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhpcy5fY2FjaGVkUmVzcG9uc2UgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuX2NhY2hlZFJlc3BvbnNlOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gWE1MSHR0cFJlcXVlc3Q7CiAgfShFdmVudFRhcmdldC5hcHBseSh1bmRlZmluZWQsIGJhYmVsSGVscGVycy50b0NvbnN1bWFibGVBcnJheShYSFJfRVZFTlRTKSkpLCBfY2xhc3MyLlVOU0VOVCA9IFVOU0VOVCwgX2NsYXNzMi5PUEVORUQgPSBPUEVORUQsIF9jbGFzczIuSEVBREVSU19SRUNFSVZFRCA9IEhFQURFUlNfUkVDRUlWRUQsIF9jbGFzczIuTE9BRElORyA9IExPQURJTkcsIF9jbGFzczIuRE9ORSA9IERPTkUsIF9jbGFzczIuX2ludGVyY2VwdG9yID0gbnVsbCwgX3RlbXApOwogIG1vZHVsZS5leHBvcnRzID0gWE1MSHR0cFJlcXVlc3Q7Cn0sNTgsWzU5LDYzLDczLDEzLDU2XSwiWE1MSHR0cFJlcXVlc3QiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgQ29tbW9ucyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICIuL2NvbW1vbnMiKTsKCiAgICB2YXIgQ3VzdG9tRXZlbnRUYXJnZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiLi9jdXN0b20tZXZlbnQtdGFyZ2V0Iik7CgogICAgdmFyIEV2ZW50V3JhcHBlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICIuL2V2ZW50LXdyYXBwZXIiKTsKCiAgICB2YXIgTElTVEVORVJTID0gQ29tbW9ucy5MSVNURU5FUlM7CiAgICB2YXIgQ0FQVFVSRSA9IENvbW1vbnMuQ0FQVFVSRTsKICAgIHZhciBCVUJCTEUgPSBDb21tb25zLkJVQkJMRTsKICAgIHZhciBBVFRSSUJVVEUgPSBDb21tb25zLkFUVFJJQlVURTsKICAgIHZhciBuZXdOb2RlID0gQ29tbW9ucy5uZXdOb2RlOwogICAgdmFyIGRlZmluZUN1c3RvbUV2ZW50VGFyZ2V0ID0gQ3VzdG9tRXZlbnRUYXJnZXQuZGVmaW5lQ3VzdG9tRXZlbnRUYXJnZXQ7CiAgICB2YXIgY3JlYXRlRXZlbnRXcmFwcGVyID0gRXZlbnRXcmFwcGVyLmNyZWF0ZUV2ZW50V3JhcHBlcjsKICAgIHZhciBTVE9QX0lNTUVESUFURV9QUk9QQUdBVElPTl9GTEFHID0gRXZlbnRXcmFwcGVyLlNUT1BfSU1NRURJQVRFX1BST1BBR0FUSU9OX0ZMQUc7CiAgICB2YXIgSEFTX0VWRU5UVEFSR0VUX0lOVEVSRkFDRSA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiB3aW5kb3cuRXZlbnRUYXJnZXQgIT09ICJ1bmRlZmluZWQiOwoKICAgIHZhciBFdmVudFRhcmdldCA9IG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gRXZlbnRUYXJnZXQoKSB7CiAgICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBFdmVudFRhcmdldCkgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgTElTVEVORVJTLCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogT2JqZWN0LmNyZWF0ZShudWxsKQogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgQXJyYXkuaXNBcnJheShhcmd1bWVudHNbMF0pKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZpbmVDdXN0b21FdmVudFRhcmdldChFdmVudFRhcmdldCwgYXJndW1lbnRzWzBdKTsKICAgICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciB0eXBlcyA9IEFycmF5KGFyZ3VtZW50cy5sZW5ndGgpOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHR5cGVzW2ldID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZGVmaW5lQ3VzdG9tRXZlbnRUYXJnZXQoRXZlbnRUYXJnZXQsIHR5cGVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsKICAgICAgICB9CiAgICB9OwoKICAgIEV2ZW50VGFyZ2V0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoKEhBU19FVkVOVFRBUkdFVF9JTlRFUkZBQ0UgPyB3aW5kb3cuRXZlbnRUYXJnZXQgOiBPYmplY3QpLnByb3RvdHlwZSwgewogICAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgICAgIHZhbHVlOiBFdmVudFRhcmdldCwKICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcjogewogICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lciwgY2FwdHVyZSkgewogICAgICAgICAgICAgICAgaWYgKGxpc3RlbmVyID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsaXN0ZW5lciAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgbGlzdGVuZXIgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiXCJsaXN0ZW5lclwiIGlzIG5vdCBhbiBvYmplY3QuIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIGtpbmQgPSBjYXB0dXJlID8gQ0FQVFVSRSA6IEJVQkJMRTsKICAgICAgICAgICAgICAgIHZhciBub2RlID0gdGhpc1tMSVNURU5FUlNdW3R5cGVdOwoKICAgICAgICAgICAgICAgIGlmIChub2RlID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzW0xJU1RFTkVSU11bdHlwZV0gPSBuZXdOb2RlKGxpc3RlbmVyLCBraW5kKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgcHJldiA9IG51bGw7CgogICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmxpc3RlbmVyID09PSBsaXN0ZW5lciAmJiBub2RlLmtpbmQgPT09IGtpbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcHJldiA9IG5vZGU7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUubmV4dDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBwcmV2Lm5leHQgPSBuZXdOb2RlKGxpc3RlbmVyLCBraW5kKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgfSwKICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyOiB7CiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyLCBjYXB0dXJlKSB7CiAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXIgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIga2luZCA9IGNhcHR1cmUgPyBDQVBUVVJFIDogQlVCQkxFOwogICAgICAgICAgICAgICAgdmFyIHByZXYgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzW0xJU1RFTkVSU11bdHlwZV07CgogICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmxpc3RlbmVyID09PSBsaXN0ZW5lciAmJiBub2RlLmtpbmQgPT09IGtpbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXYgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tMSVNURU5FUlNdW3R5cGVdID0gbm9kZS5uZXh0OwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldi5uZXh0ID0gbm9kZS5uZXh0OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHByZXYgPSBub2RlOwogICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLm5leHQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgfSwKICAgICAgICBkaXNwYXRjaEV2ZW50OiB7CiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50KGV2ZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXNbTElTVEVORVJTXVtldmVudC50eXBlXTsKCiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHdyYXBwZWQgPSBjcmVhdGVFdmVudFdyYXBwZXIoZXZlbnQsIHRoaXMpOwoKICAgICAgICAgICAgICAgIHdoaWxlIChub2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5vZGUubGlzdGVuZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5saXN0ZW5lci5jYWxsKHRoaXMsIHdyYXBwZWQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5raW5kICE9PSBBVFRSSUJVVEUgJiYgdHlwZW9mIG5vZGUubGlzdGVuZXIuaGFuZGxlRXZlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5saXN0ZW5lci5oYW5kbGVFdmVudCh3cmFwcGVkKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh3cmFwcGVkW1NUT1BfSU1NRURJQVRFX1BST1BBR0FUSU9OX0ZMQUddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUubmV4dDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gIXdyYXBwZWQuZGVmYXVsdFByZXZlbnRlZDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgIH0KICAgIH0pOwp9LDU5LFs2MCw2MSw2Ml0sImV2ZW50LXRhcmdldC1zaGltL2xpYi9ldmVudC10YXJnZXQuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAidXNlIHN0cmljdCI7CgogIHZhciBjcmVhdGVVbmlxdWVLZXkgPSBleHBvcnRzLmNyZWF0ZVVuaXF1ZUtleSA9IHR5cGVvZiBTeW1ib2wgIT09ICJ1bmRlZmluZWQiID8gU3ltYm9sIDogZnVuY3Rpb24gY3JlYXRlVW5pcXVlS2V5KG5hbWUpIHsKICAgIHJldHVybiAiW1siICsgbmFtZSArICJfIiArIE1hdGgucmFuZG9tKCkudG9GaXhlZCg4KS5zbGljZSgyKSArICJdXSI7CiAgfTsKICBleHBvcnRzLkxJU1RFTkVSUyA9IGNyZWF0ZVVuaXF1ZUtleSgibGlzdGVuZXJzIik7CiAgZXhwb3J0cy5DQVBUVVJFID0gMTsKICBleHBvcnRzLkJVQkJMRSA9IDI7CiAgZXhwb3J0cy5BVFRSSUJVVEUgPSAzOwoKICBleHBvcnRzLm5ld05vZGUgPSBmdW5jdGlvbiBuZXdOb2RlKGxpc3RlbmVyLCBraW5kKSB7CiAgICByZXR1cm4gewogICAgICBsaXN0ZW5lcjogbGlzdGVuZXIsCiAgICAgIGtpbmQ6IGtpbmQsCiAgICAgIG5leHQ6IG51bGwKICAgIH07CiAgfTsKfSw2MCxbXSwiZXZlbnQtdGFyZ2V0LXNoaW0vbGliL2NvbW1vbnMuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgQ29tbW9ucyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICIuL2NvbW1vbnMiKTsKCiAgICB2YXIgTElTVEVORVJTID0gQ29tbW9ucy5MSVNURU5FUlM7CiAgICB2YXIgQVRUUklCVVRFID0gQ29tbW9ucy5BVFRSSUJVVEU7CiAgICB2YXIgbmV3Tm9kZSA9IENvbW1vbnMubmV3Tm9kZTsKCiAgICBmdW5jdGlvbiBnZXRBdHRyaWJ1dGVMaXN0ZW5lcihldmVudFRhcmdldCwgdHlwZSkgewogICAgICAgIHZhciBub2RlID0gZXZlbnRUYXJnZXRbTElTVEVORVJTXVt0eXBlXTsKCiAgICAgICAgd2hpbGUgKG5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAobm9kZS5raW5kID09PSBBVFRSSUJVVEUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmxpc3RlbmVyOwogICAgICAgICAgICB9CgogICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0QXR0cmlidXRlTGlzdGVuZXIoZXZlbnRUYXJnZXQsIHR5cGUsIGxpc3RlbmVyKSB7CiAgICAgICAgaWYgKHR5cGVvZiBsaXN0ZW5lciAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgbGlzdGVuZXIgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGxpc3RlbmVyID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHZhciBwcmV2ID0gbnVsbDsKICAgICAgICB2YXIgbm9kZSA9IGV2ZW50VGFyZ2V0W0xJU1RFTkVSU11bdHlwZV07CgogICAgICAgIHdoaWxlIChub2RlICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5vZGUua2luZCA9PT0gQVRUUklCVVRFKSB7CiAgICAgICAgICAgICAgICBpZiAocHJldiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRUYXJnZXRbTElTVEVORVJTXVt0eXBlXSA9IG5vZGUubmV4dDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcHJldi5uZXh0ID0gbm9kZS5uZXh0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldiA9IG5vZGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vZGUgPSBub2RlLm5leHQ7CiAgICAgICAgfQoKICAgICAgICBpZiAobGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAocHJldiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBldmVudFRhcmdldFtMSVNURU5FUlNdW3R5cGVdID0gbmV3Tm9kZShsaXN0ZW5lciwgQVRUUklCVVRFKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXYubmV4dCA9IG5ld05vZGUobGlzdGVuZXIsIEFUVFJJQlVURSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZXhwb3J0cy5kZWZpbmVDdXN0b21FdmVudFRhcmdldCA9IGZ1bmN0aW9uIChFdmVudFRhcmdldEJhc2UsIHR5cGVzKSB7CiAgICAgICAgZnVuY3Rpb24gRXZlbnRUYXJnZXQoKSB7CiAgICAgICAgICAgIEV2ZW50VGFyZ2V0QmFzZS5jYWxsKHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRlc2NyaXB0ZXIgPSB7CiAgICAgICAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgICAgICAgICB2YWx1ZTogRXZlbnRUYXJnZXQsCiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB0eXBlcy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgIGRlc2NyaXB0ZXJbIm9uIiArIHR5cGVdID0gewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEF0dHJpYnV0ZUxpc3RlbmVyKHRoaXMsIHR5cGUpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gc2V0KGxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0QXR0cmlidXRlTGlzdGVuZXIodGhpcywgdHlwZSwgbGlzdGVuZXIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICAgICBFdmVudFRhcmdldC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEV2ZW50VGFyZ2V0QmFzZS5wcm90b3R5cGUsIGRlc2NyaXB0ZXIpOwogICAgICAgIHJldHVybiBFdmVudFRhcmdldDsKICAgIH07Cn0sNjEsWzYwXSwiZXZlbnQtdGFyZ2V0LXNoaW0vbGliL2N1c3RvbS1ldmVudC10YXJnZXQuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgY3JlYXRlVW5pcXVlS2V5ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIi4vY29tbW9ucyIpLmNyZWF0ZVVuaXF1ZUtleTsKCiAgICB2YXIgU1RPUF9JTU1FRElBVEVfUFJPUEFHQVRJT05fRkxBRyA9IGNyZWF0ZVVuaXF1ZUtleSgic3RvcF9pbW1lZGlhdGVfcHJvcGFnYXRpb25fZmxhZyIpOwogICAgdmFyIENBTkNFTEVEX0ZMQUcgPSBjcmVhdGVVbmlxdWVLZXkoImNhbmNlbGVkX2ZsYWciKTsKICAgIHZhciBPUklHSU5BTF9FVkVOVCA9IGNyZWF0ZVVuaXF1ZUtleSgib3JpZ2luYWxfZXZlbnQiKTsKICAgIHZhciB3cmFwcGVyUHJvdG90eXBlRGVmaW5pdGlvbiA9IE9iamVjdC5mcmVlemUoewogICAgICAgIHN0b3BQcm9wYWdhdGlvbjogT2JqZWN0LmZyZWV6ZSh7CiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBzdG9wUHJvcGFnYXRpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgZSA9IHRoaXNbT1JJR0lOQUxfRVZFTlRdOwoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZS5zdG9wUHJvcGFnYXRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgfSksCiAgICAgICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBPYmplY3QuZnJlZXplKHsKICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoaXNbU1RPUF9JTU1FRElBVEVfUFJPUEFHQVRJT05fRkxBR10gPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIGUgPSB0aGlzW09SSUdJTkFMX0VWRU5UXTsKCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgIH0pLAogICAgICAgIHByZXZlbnREZWZhdWx0OiBPYmplY3QuZnJlZXplKHsKICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHByZXZlbnREZWZhdWx0KCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FuY2VsYWJsZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXNbQ0FOQ0VMRURfRkxBR10gPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBlID0gdGhpc1tPUklHSU5BTF9FVkVOVF07CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlLnByZXZlbnREZWZhdWx0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgfSksCiAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogT2JqZWN0LmZyZWV6ZSh7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gZGVmYXVsdFByZXZlbnRlZCgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW0NBTkNFTEVEX0ZMQUddOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICB9KQogICAgfSk7CiAgICBleHBvcnRzLlNUT1BfSU1NRURJQVRFX1BST1BBR0FUSU9OX0ZMQUcgPSBTVE9QX0lNTUVESUFURV9QUk9QQUdBVElPTl9GTEFHOwoKICAgIGV4cG9ydHMuY3JlYXRlRXZlbnRXcmFwcGVyID0gZnVuY3Rpb24gY3JlYXRlRXZlbnRXcmFwcGVyKGV2ZW50LCBldmVudFRhcmdldCkgewogICAgICAgIHZhciB0aW1lU3RhbXAgPSB0eXBlb2YgZXZlbnQudGltZVN0YW1wID09PSAibnVtYmVyIiA/IGV2ZW50LnRpbWVTdGFtcCA6IERhdGUubm93KCk7CiAgICAgICAgdmFyIHByb3BlcnR5RGVmaW5pdGlvbiA9IHsKICAgICAgICAgICAgdHlwZTogewogICAgICAgICAgICAgICAgdmFsdWU6IGV2ZW50LnR5cGUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRhcmdldDogewogICAgICAgICAgICAgICAgdmFsdWU6IGV2ZW50VGFyZ2V0LAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgICAgICB9LAogICAgICAgICAgICBjdXJyZW50VGFyZ2V0OiB7CiAgICAgICAgICAgICAgICB2YWx1ZTogZXZlbnRUYXJnZXQsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGV2ZW50UGhhc2U6IHsKICAgICAgICAgICAgICAgIHZhbHVlOiAyLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgICAgICB9LAogICAgICAgICAgICBidWJibGVzOiB7CiAgICAgICAgICAgICAgICB2YWx1ZTogQm9vbGVhbihldmVudC5idWJibGVzKSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2FuY2VsYWJsZTogewogICAgICAgICAgICAgICAgdmFsdWU6IEJvb2xlYW4oZXZlbnQuY2FuY2VsYWJsZSksCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRpbWVTdGFtcDogewogICAgICAgICAgICAgICAgdmFsdWU6IHRpbWVTdGFtcCwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNUcnVzdGVkOiB7CiAgICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHByb3BlcnR5RGVmaW5pdGlvbltTVE9QX0lNTUVESUFURV9QUk9QQUdBVElPTl9GTEFHXSA9IHsKICAgICAgICAgICAgdmFsdWU6IGZhbHNlLAogICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgIH07CiAgICAgICAgcHJvcGVydHlEZWZpbml0aW9uW0NBTkNFTEVEX0ZMQUddID0gewogICAgICAgICAgICB2YWx1ZTogZmFsc2UsCiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBwcm9wZXJ0eURlZmluaXRpb25bT1JJR0lOQUxfRVZFTlRdID0gewogICAgICAgICAgICB2YWx1ZTogZXZlbnQKICAgICAgICB9OwoKICAgICAgICBpZiAodHlwZW9mIGV2ZW50LmRldGFpbCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcHJvcGVydHlEZWZpbml0aW9uLmRldGFpbCA9IHsKICAgICAgICAgICAgICAgIHZhbHVlOiBldmVudC5kZXRhaWwsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gT2JqZWN0LmNyZWF0ZShPYmplY3QuY3JlYXRlKGV2ZW50LCB3cmFwcGVyUHJvdG90eXBlRGVmaW5pdGlvbiksIHByb3BlcnR5RGVmaW5pdGlvbik7CiAgICB9Owp9LDYyLFs2MF0sImV2ZW50LXRhcmdldC1zaGltL2xpYi9ldmVudC13cmFwcGVyLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgTWlzc2luZ05hdGl2ZUV2ZW50RW1pdHRlclNoaW0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTWlzc2luZ05hdGl2ZUV2ZW50RW1pdHRlclNoaW0iKTsKCiAgdmFyIE5hdGl2ZUV2ZW50RW1pdHRlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJOYXRpdmVFdmVudEVtaXR0ZXIiKTsKCiAgdmFyIFJDVE5ldHdvcmtpbmdOYXRpdmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiTmF0aXZlTW9kdWxlcyIpLk5ldHdvcmtpbmc7CgogIHZhciBjb252ZXJ0UmVxdWVzdEJvZHkgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiY29udmVydFJlcXVlc3RCb2R5Iik7CgogIGZ1bmN0aW9uIGNvbnZlcnRIZWFkZXJzTWFwVG9BcnJheShoZWFkZXJzKSB7CiAgICB2YXIgaGVhZGVyQXJyYXkgPSBbXTsKCiAgICBmb3IgKHZhciBuYW1lIGluIGhlYWRlcnMpIHsKICAgICAgaGVhZGVyQXJyYXkucHVzaChbbmFtZSwgaGVhZGVyc1tuYW1lXV0pOwogICAgfQoKICAgIHJldHVybiBoZWFkZXJBcnJheTsKICB9CgogIHZhciBfcmVxdWVzdElkID0gMTsKCiAgZnVuY3Rpb24gZ2VuZXJhdGVSZXF1ZXN0SWQoKSB7CiAgICByZXR1cm4gX3JlcXVlc3RJZCsrOwogIH0KCiAgdmFyIFJDVE5ldHdvcmtpbmcgPSBmdW5jdGlvbiAoX05hdGl2ZUV2ZW50RW1pdHRlcikgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKFJDVE5ldHdvcmtpbmcsIF9OYXRpdmVFdmVudEVtaXR0ZXIpOwoKICAgIGZ1bmN0aW9uIFJDVE5ldHdvcmtpbmcoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBSQ1ROZXR3b3JraW5nKTsKCiAgICAgIHZhciBfdGhpcyA9IGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChSQ1ROZXR3b3JraW5nLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoUkNUTmV0d29ya2luZykpLmNhbGwodGhpcywgUkNUTmV0d29ya2luZ05hdGl2ZSkpOwoKICAgICAgX3RoaXMuaXNBdmFpbGFibGUgPSB0cnVlOwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFJDVE5ldHdvcmtpbmcsIFt7CiAgICAgIGtleTogInNlbmRSZXF1ZXN0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNlbmRSZXF1ZXN0KG1ldGhvZCwgdHJhY2tpbmdOYW1lLCB1cmwsIGhlYWRlcnMsIGRhdGEsIHJlc3BvbnNlVHlwZSwgaW5jcmVtZW50YWxVcGRhdGVzLCB0aW1lb3V0LCBjYWxsYmFjaywgd2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgdmFyIGJvZHkgPSBjb252ZXJ0UmVxdWVzdEJvZHkoZGF0YSk7CgogICAgICAgIGlmIChib2R5ICYmIGJvZHkuZm9ybURhdGEpIHsKICAgICAgICAgIGJvZHkuZm9ybURhdGEgPSBib2R5LmZvcm1EYXRhLm1hcChmdW5jdGlvbiAocGFydCkgewogICAgICAgICAgICByZXR1cm4gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHBhcnQsIHsKICAgICAgICAgICAgICBoZWFkZXJzOiBjb252ZXJ0SGVhZGVyc01hcFRvQXJyYXkocGFydC5oZWFkZXJzKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdmFyIHJlcXVlc3RJZCA9IGdlbmVyYXRlUmVxdWVzdElkKCk7CiAgICAgICAgUkNUTmV0d29ya2luZ05hdGl2ZS5zZW5kUmVxdWVzdChtZXRob2QsIHVybCwgcmVxdWVzdElkLCBjb252ZXJ0SGVhZGVyc01hcFRvQXJyYXkoaGVhZGVycyksIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBib2R5LCB7CiAgICAgICAgICB0cmFja2luZ05hbWU6IHRyYWNraW5nTmFtZQogICAgICAgIH0pLCByZXNwb25zZVR5cGUsIGluY3JlbWVudGFsVXBkYXRlcywgdGltZW91dCwgd2l0aENyZWRlbnRpYWxzKTsKICAgICAgICBjYWxsYmFjayhyZXF1ZXN0SWQpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImFib3J0UmVxdWVzdCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhYm9ydFJlcXVlc3QocmVxdWVzdElkKSB7CiAgICAgICAgUkNUTmV0d29ya2luZ05hdGl2ZS5hYm9ydFJlcXVlc3QocmVxdWVzdElkKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjbGVhckNvb2tpZXMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY2xlYXJDb29raWVzKGNhbGxiYWNrKSB7CiAgICAgICAgUkNUTmV0d29ya2luZ05hdGl2ZS5jbGVhckNvb2tpZXMoY2FsbGJhY2spOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gUkNUTmV0d29ya2luZzsKICB9KE5hdGl2ZUV2ZW50RW1pdHRlcik7CgogIGlmIChfX0RFVl9fICYmICFSQ1ROZXR3b3JraW5nTmF0aXZlKSB7CiAgICB2YXIgTWlzc2luZ05hdGl2ZVJDVE5ldHdvcmtpbmdTaGltID0gZnVuY3Rpb24gKF9NaXNzaW5nTmF0aXZlRXZlbnRFbSkgewogICAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoTWlzc2luZ05hdGl2ZVJDVE5ldHdvcmtpbmdTaGltLCBfTWlzc2luZ05hdGl2ZUV2ZW50RW0pOwoKICAgICAgZnVuY3Rpb24gTWlzc2luZ05hdGl2ZVJDVE5ldHdvcmtpbmdTaGltKCkgewogICAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBNaXNzaW5nTmF0aXZlUkNUTmV0d29ya2luZ1NoaW0pOwogICAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoTWlzc2luZ05hdGl2ZVJDVE5ldHdvcmtpbmdTaGltLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoTWlzc2luZ05hdGl2ZVJDVE5ldHdvcmtpbmdTaGltKSkuY2FsbCh0aGlzLCAnUkNUTmV0d29ya2luZycsICdOZXR3b3JraW5nJykpOwogICAgICB9CgogICAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoTWlzc2luZ05hdGl2ZVJDVE5ldHdvcmtpbmdTaGltLCBbewogICAgICAgIGtleTogInNlbmRSZXF1ZXN0IiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gc2VuZFJlcXVlc3QoKSB7CiAgICAgICAgICB0aGlzLnRocm93TWlzc2luZ05hdGl2ZU1vZHVsZSgpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogImFib3J0UmVxdWVzdCIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGFib3J0UmVxdWVzdCgpIHsKICAgICAgICAgIHRoaXMudGhyb3dNaXNzaW5nTmF0aXZlTW9kdWxlKCk7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAiY2xlYXJDb29raWVzIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY2xlYXJDb29raWVzKCkgewogICAgICAgICAgdGhpcy50aHJvd01pc3NpbmdOYXRpdmVNb2R1bGUoKTsKICAgICAgICB9CiAgICAgIH1dKTsKICAgICAgcmV0dXJuIE1pc3NpbmdOYXRpdmVSQ1ROZXR3b3JraW5nU2hpbTsKICAgIH0oTWlzc2luZ05hdGl2ZUV2ZW50RW1pdHRlclNoaW0pOwoKICAgIFJDVE5ldHdvcmtpbmcgPSBuZXcgTWlzc2luZ05hdGl2ZVJDVE5ldHdvcmtpbmdTaGltKCk7CiAgfSBlbHNlIHsKICAgIFJDVE5ldHdvcmtpbmcgPSBuZXcgUkNUTmV0d29ya2luZygpOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBSQ1ROZXR3b3JraW5nOwp9LDYzLFs2NCw2OSwxNSw3MV0sIlJDVE5ldHdvcmtpbmciKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBFbWl0dGVyU3Vic2NyaXB0aW9uID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkVtaXR0ZXJTdWJzY3JpcHRpb24iKTsKCiAgdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJFdmVudEVtaXR0ZXIiKTsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIE1pc3NpbmdOYXRpdmVFdmVudEVtaXR0ZXJTaGltID0gZnVuY3Rpb24gKF9FdmVudEVtaXR0ZXIpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhNaXNzaW5nTmF0aXZlRXZlbnRFbWl0dGVyU2hpbSwgX0V2ZW50RW1pdHRlcik7CgogICAgZnVuY3Rpb24gTWlzc2luZ05hdGl2ZUV2ZW50RW1pdHRlclNoaW0obmF0aXZlTW9kdWxlTmFtZSwgbmF0aXZlRXZlbnRFbWl0dGVyTmFtZSkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgTWlzc2luZ05hdGl2ZUV2ZW50RW1pdHRlclNoaW0pOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKE1pc3NpbmdOYXRpdmVFdmVudEVtaXR0ZXJTaGltLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoTWlzc2luZ05hdGl2ZUV2ZW50RW1pdHRlclNoaW0pKS5jYWxsKHRoaXMsIG51bGwpKTsKCiAgICAgIF90aGlzLmlzQXZhaWxhYmxlID0gZmFsc2U7CiAgICAgIF90aGlzLl9uYXRpdmVNb2R1bGVOYW1lID0gbmF0aXZlTW9kdWxlTmFtZTsKICAgICAgX3RoaXMuX25hdGl2ZUV2ZW50RW1pdHRlck5hbWUgPSBuYXRpdmVFdmVudEVtaXR0ZXJOYW1lOwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKE1pc3NpbmdOYXRpdmVFdmVudEVtaXR0ZXJTaGltLCBbewogICAgICBrZXk6ICJ0aHJvd01pc3NpbmdOYXRpdmVNb2R1bGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gdGhyb3dNaXNzaW5nTmF0aXZlTW9kdWxlKCkgewogICAgICAgIGludmFyaWFudChmYWxzZSwgIkNhbm5vdCB1c2UgJyIgKyB0aGlzLl9uYXRpdmVFdmVudEVtaXR0ZXJOYW1lICsgIicgbW9kdWxlIHdoZW4gIiArICgibmF0aXZlICciICsgdGhpcy5fbmF0aXZlTW9kdWxlTmFtZSArICInIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYnVpbGQuICIpICsgKCJFaXRoZXIgaW5jbHVkZSBpdCwgb3IgY2hlY2sgJyIgKyB0aGlzLl9uYXRpdmVFdmVudEVtaXR0ZXJOYW1lICsgIicuaXNBdmFpbGFibGUgIikgKyAnYmVmb3JlIGNhbGxpbmcgYW55IG1ldGhvZHMuJyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYWRkTGlzdGVuZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gYWRkTGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgY29udGV4dCkgewogICAgICAgIHRoaXMudGhyb3dNaXNzaW5nTmF0aXZlTW9kdWxlKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVtb3ZlQWxsTGlzdGVuZXJzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUFsbExpc3RlbmVycyhldmVudFR5cGUpIHsKICAgICAgICB0aGlzLnRocm93TWlzc2luZ05hdGl2ZU1vZHVsZSgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZVN1YnNjcmlwdGlvbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgdGhpcy50aHJvd01pc3NpbmdOYXRpdmVNb2R1bGUoKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIE1pc3NpbmdOYXRpdmVFdmVudEVtaXR0ZXJTaGltOwogIH0oRXZlbnRFbWl0dGVyKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBNaXNzaW5nTmF0aXZlRXZlbnRFbWl0dGVyU2hpbTsKfSw2NCxbNjUsNjcsMTNdLCJNaXNzaW5nTmF0aXZlRXZlbnRFbWl0dGVyU2hpbSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEV2ZW50U3Vic2NyaXB0aW9uID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkV2ZW50U3Vic2NyaXB0aW9uIik7CgogIHZhciBFbWl0dGVyU3Vic2NyaXB0aW9uID0gZnVuY3Rpb24gKF9FdmVudFN1YnNjcmlwdGlvbikgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKEVtaXR0ZXJTdWJzY3JpcHRpb24sIF9FdmVudFN1YnNjcmlwdGlvbik7CgogICAgZnVuY3Rpb24gRW1pdHRlclN1YnNjcmlwdGlvbihlbWl0dGVyLCBzdWJzY3JpYmVyLCBsaXN0ZW5lciwgY29udGV4dCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgRW1pdHRlclN1YnNjcmlwdGlvbik7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoRW1pdHRlclN1YnNjcmlwdGlvbi5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEVtaXR0ZXJTdWJzY3JpcHRpb24pKS5jYWxsKHRoaXMsIHN1YnNjcmliZXIpKTsKCiAgICAgIF90aGlzLmVtaXR0ZXIgPSBlbWl0dGVyOwogICAgICBfdGhpcy5saXN0ZW5lciA9IGxpc3RlbmVyOwogICAgICBfdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhFbWl0dGVyU3Vic2NyaXB0aW9uLCBbewogICAgICBrZXk6ICJyZW1vdmUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlKCkgewogICAgICAgIHRoaXMuZW1pdHRlci5yZW1vdmVTdWJzY3JpcHRpb24odGhpcyk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBFbWl0dGVyU3Vic2NyaXB0aW9uOwogIH0oRXZlbnRTdWJzY3JpcHRpb24pOwoKICBtb2R1bGUuZXhwb3J0cyA9IEVtaXR0ZXJTdWJzY3JpcHRpb247Cn0sNjUsWzY2XSwiRW1pdHRlclN1YnNjcmlwdGlvbiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEV2ZW50U3Vic2NyaXB0aW9uID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRXZlbnRTdWJzY3JpcHRpb24oc3Vic2NyaWJlcikgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgRXZlbnRTdWJzY3JpcHRpb24pOwogICAgICB0aGlzLnN1YnNjcmliZXIgPSBzdWJzY3JpYmVyOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhFdmVudFN1YnNjcmlwdGlvbiwgW3sKICAgICAga2V5OiAicmVtb3ZlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZSgpIHsKICAgICAgICB0aGlzLnN1YnNjcmliZXIucmVtb3ZlU3Vic2NyaXB0aW9uKHRoaXMpOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gRXZlbnRTdWJzY3JpcHRpb247CiAgfSgpOwoKICBtb2R1bGUuZXhwb3J0cyA9IEV2ZW50U3Vic2NyaXB0aW9uOwp9LDY2LFtdLCJFdmVudFN1YnNjcmlwdGlvbiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEVtaXR0ZXJTdWJzY3JpcHRpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiRW1pdHRlclN1YnNjcmlwdGlvbiIpOwoKICB2YXIgRXZlbnRTdWJzY3JpcHRpb25WZW5kb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiRXZlbnRTdWJzY3JpcHRpb25WZW5kb3IiKTsKCiAgdmFyIGVtcHR5RnVuY3Rpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiZmJqcy9saWIvZW1wdHlGdW5jdGlvbiIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgRXZlbnRFbWl0dGVyID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRXZlbnRFbWl0dGVyKHN1YnNjcmliZXIpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEV2ZW50RW1pdHRlcik7CiAgICAgIHRoaXMuX3N1YnNjcmliZXIgPSBzdWJzY3JpYmVyIHx8IG5ldyBFdmVudFN1YnNjcmlwdGlvblZlbmRvcigpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhFdmVudEVtaXR0ZXIsIFt7CiAgICAgIGtleTogImFkZExpc3RlbmVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGFkZExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIGNvbnRleHQpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc3Vic2NyaWJlci5hZGRTdWJzY3JpcHRpb24oZXZlbnRUeXBlLCBuZXcgRW1pdHRlclN1YnNjcmlwdGlvbih0aGlzLCB0aGlzLl9zdWJzY3JpYmVyLCBsaXN0ZW5lciwgY29udGV4dCkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm9uY2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gb25jZShldmVudFR5cGUsIGxpc3RlbmVyLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgcmV0dXJuIHRoaXMuYWRkTGlzdGVuZXIoZXZlbnRUeXBlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICAgICAgfQoKICAgICAgICAgIF90aGlzLnJlbW92ZUN1cnJlbnRMaXN0ZW5lcigpOwoKICAgICAgICAgIGxpc3RlbmVyLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZUFsbExpc3RlbmVycyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVBbGxMaXN0ZW5lcnMoZXZlbnRUeXBlKSB7CiAgICAgICAgdGhpcy5fc3Vic2NyaWJlci5yZW1vdmVBbGxTdWJzY3JpcHRpb25zKGV2ZW50VHlwZSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVtb3ZlQ3VycmVudExpc3RlbmVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUN1cnJlbnRMaXN0ZW5lcigpIHsKICAgICAgICBpbnZhcmlhbnQoISF0aGlzLl9jdXJyZW50U3Vic2NyaXB0aW9uLCAnTm90IGluIGFuIGVtaXR0aW5nIGN5Y2xlOyB0aGVyZSBpcyBubyBjdXJyZW50IHN1YnNjcmlwdGlvbicpOwogICAgICAgIHRoaXMucmVtb3ZlU3Vic2NyaXB0aW9uKHRoaXMuX2N1cnJlbnRTdWJzY3JpcHRpb24pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZVN1YnNjcmlwdGlvbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgaW52YXJpYW50KHN1YnNjcmlwdGlvbi5lbWl0dGVyID09PSB0aGlzLCAnU3Vic2NyaXB0aW9uIGRvZXMgbm90IGJlbG9uZyB0byB0aGlzIGVtaXR0ZXIuJyk7CgogICAgICAgIHRoaXMuX3N1YnNjcmliZXIucmVtb3ZlU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbik7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAibGlzdGVuZXJzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGxpc3RlbmVycyhldmVudFR5cGUpIHsKICAgICAgICB2YXIgc3Vic2NyaXB0aW9ucyA9IHRoaXMuX3N1YnNjcmliZXIuZ2V0U3Vic2NyaXB0aW9uc0ZvclR5cGUoZXZlbnRUeXBlKTsKCiAgICAgICAgcmV0dXJuIHN1YnNjcmlwdGlvbnMgPyBzdWJzY3JpcHRpb25zLmZpbHRlcihlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zVHJ1ZSkubWFwKGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pIHsKICAgICAgICAgIHJldHVybiBzdWJzY3JpcHRpb24ubGlzdGVuZXI7CiAgICAgICAgfSkgOiBbXTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJlbWl0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGVtaXQoZXZlbnRUeXBlKSB7CiAgICAgICAgdmFyIHN1YnNjcmlwdGlvbnMgPSB0aGlzLl9zdWJzY3JpYmVyLmdldFN1YnNjcmlwdGlvbnNGb3JUeXBlKGV2ZW50VHlwZSk7CgogICAgICAgIGlmIChzdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHN1YnNjcmlwdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb25zW2ldOwoKICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbikgewogICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRTdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb247CiAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uLmxpc3RlbmVyLmFwcGx5KHN1YnNjcmlwdGlvbi5jb250ZXh0LCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuX2N1cnJlbnRTdWJzY3JpcHRpb24gPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW1vdmVMaXN0ZW5lciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyKSB7CiAgICAgICAgdmFyIHN1YnNjcmlwdGlvbnMgPSB0aGlzLl9zdWJzY3JpYmVyLmdldFN1YnNjcmlwdGlvbnNGb3JUeXBlKGV2ZW50VHlwZSk7CgogICAgICAgIGlmIChzdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHN1YnNjcmlwdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb25zW2ldOwoKICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbiAmJiBzdWJzY3JpcHRpb24ubGlzdGVuZXIgPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gRXZlbnRFbWl0dGVyOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXI7Cn0sNjcsWzY1LDY4LDU3LDEzXSwiRXZlbnRFbWl0dGVyIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgRXZlbnRTdWJzY3JpcHRpb25WZW5kb3IgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBFdmVudFN1YnNjcmlwdGlvblZlbmRvcigpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEV2ZW50U3Vic2NyaXB0aW9uVmVuZG9yKTsKICAgICAgdGhpcy5fc3Vic2NyaXB0aW9uc0ZvclR5cGUgPSB7fTsKICAgICAgdGhpcy5fY3VycmVudFN1YnNjcmlwdGlvbiA9IG51bGw7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEV2ZW50U3Vic2NyaXB0aW9uVmVuZG9yLCBbewogICAgICBrZXk6ICJhZGRTdWJzY3JpcHRpb24iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gYWRkU3Vic2NyaXB0aW9uKGV2ZW50VHlwZSwgc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgaW52YXJpYW50KHN1YnNjcmlwdGlvbi5zdWJzY3JpYmVyID09PSB0aGlzLCAnVGhlIHN1YnNjcmliZXIgb2YgdGhlIHN1YnNjcmlwdGlvbiBpcyBpbmNvcnJlY3RseSBzZXQuJyk7CgogICAgICAgIGlmICghdGhpcy5fc3Vic2NyaXB0aW9uc0ZvclR5cGVbZXZlbnRUeXBlXSkgewogICAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9uc0ZvclR5cGVbZXZlbnRUeXBlXSA9IFtdOwogICAgICAgIH0KCiAgICAgICAgdmFyIGtleSA9IHRoaXMuX3N1YnNjcmlwdGlvbnNGb3JUeXBlW2V2ZW50VHlwZV0ubGVuZ3RoOwoKICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zRm9yVHlwZVtldmVudFR5cGVdLnB1c2goc3Vic2NyaXB0aW9uKTsKCiAgICAgICAgc3Vic2NyaXB0aW9uLmV2ZW50VHlwZSA9IGV2ZW50VHlwZTsKICAgICAgICBzdWJzY3JpcHRpb24ua2V5ID0ga2V5OwogICAgICAgIHJldHVybiBzdWJzY3JpcHRpb247CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVtb3ZlQWxsU3Vic2NyaXB0aW9ucyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVBbGxTdWJzY3JpcHRpb25zKGV2ZW50VHlwZSkgewogICAgICAgIGlmIChldmVudFR5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9uc0ZvclR5cGUgPSB7fTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsZXRlIHRoaXMuX3N1YnNjcmlwdGlvbnNGb3JUeXBlW2V2ZW50VHlwZV07CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZVN1YnNjcmlwdGlvbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgdmFyIGV2ZW50VHlwZSA9IHN1YnNjcmlwdGlvbi5ldmVudFR5cGU7CiAgICAgICAgdmFyIGtleSA9IHN1YnNjcmlwdGlvbi5rZXk7CiAgICAgICAgdmFyIHN1YnNjcmlwdGlvbnNGb3JUeXBlID0gdGhpcy5fc3Vic2NyaXB0aW9uc0ZvclR5cGVbZXZlbnRUeXBlXTsKCiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbnNGb3JUeXBlKSB7CiAgICAgICAgICBkZWxldGUgc3Vic2NyaXB0aW9uc0ZvclR5cGVba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0U3Vic2NyaXB0aW9uc0ZvclR5cGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0U3Vic2NyaXB0aW9uc0ZvclR5cGUoZXZlbnRUeXBlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3N1YnNjcmlwdGlvbnNGb3JUeXBlW2V2ZW50VHlwZV07CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBFdmVudFN1YnNjcmlwdGlvblZlbmRvcjsKICB9KCk7CgogIG1vZHVsZS5leHBvcnRzID0gRXZlbnRTdWJzY3JpcHRpb25WZW5kb3I7Cn0sNjgsWzEzXSwiRXZlbnRTdWJzY3JpcHRpb25WZW5kb3IiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiRXZlbnRFbWl0dGVyIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJQbGF0Zm9ybSIpOwoKICB2YXIgUkNURGV2aWNlRXZlbnRFbWl0dGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlJDVERldmljZUV2ZW50RW1pdHRlciIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgTmF0aXZlRXZlbnRFbWl0dGVyID0gZnVuY3Rpb24gKF9FdmVudEVtaXR0ZXIpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhOYXRpdmVFdmVudEVtaXR0ZXIsIF9FdmVudEVtaXR0ZXIpOwoKICAgIGZ1bmN0aW9uIE5hdGl2ZUV2ZW50RW1pdHRlcihuYXRpdmVNb2R1bGUpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIE5hdGl2ZUV2ZW50RW1pdHRlcik7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoTmF0aXZlRXZlbnRFbWl0dGVyLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoTmF0aXZlRXZlbnRFbWl0dGVyKSkuY2FsbCh0aGlzLCBSQ1REZXZpY2VFdmVudEVtaXR0ZXIuc2hhcmVkU3Vic2NyaWJlcikpOwoKICAgICAgaWYgKFBsYXRmb3JtLk9TID09PSAnaW9zJykgewogICAgICAgIGludmFyaWFudChuYXRpdmVNb2R1bGUsICdOYXRpdmUgbW9kdWxlIGNhbm5vdCBiZSBudWxsLicpOwogICAgICAgIF90aGlzLl9uYXRpdmVNb2R1bGUgPSBuYXRpdmVNb2R1bGU7CiAgICAgIH0KCiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoTmF0aXZlRXZlbnRFbWl0dGVyLCBbewogICAgICBrZXk6ICJhZGRMaXN0ZW5lciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKHRoaXMuX25hdGl2ZU1vZHVsZSAhPSBudWxsKSB7CiAgICAgICAgICB0aGlzLl9uYXRpdmVNb2R1bGUuYWRkTGlzdGVuZXIoZXZlbnRUeXBlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMuZ2V0KE5hdGl2ZUV2ZW50RW1pdHRlci5wcm90b3R5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihOYXRpdmVFdmVudEVtaXR0ZXIucHJvdG90eXBlKSwgImFkZExpc3RlbmVyIiwgdGhpcykuY2FsbCh0aGlzLCBldmVudFR5cGUsIGxpc3RlbmVyLCBjb250ZXh0KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW1vdmVBbGxMaXN0ZW5lcnMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50VHlwZSkgewogICAgICAgIGludmFyaWFudChldmVudFR5cGUsICdldmVudFR5cGUgYXJndW1lbnQgaXMgcmVxdWlyZWQuJyk7CiAgICAgICAgdmFyIGNvdW50ID0gdGhpcy5saXN0ZW5lcnMoZXZlbnRUeXBlKS5sZW5ndGg7CgogICAgICAgIGlmICh0aGlzLl9uYXRpdmVNb2R1bGUgIT0gbnVsbCkgewogICAgICAgICAgdGhpcy5fbmF0aXZlTW9kdWxlLnJlbW92ZUxpc3RlbmVycyhjb3VudCk7CiAgICAgICAgfQoKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KE5hdGl2ZUV2ZW50RW1pdHRlci5wcm90b3R5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihOYXRpdmVFdmVudEVtaXR0ZXIucHJvdG90eXBlKSwgInJlbW92ZUFsbExpc3RlbmVycyIsIHRoaXMpLmNhbGwodGhpcywgZXZlbnRUeXBlKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW1vdmVTdWJzY3JpcHRpb24iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbikgewogICAgICAgIGlmICh0aGlzLl9uYXRpdmVNb2R1bGUgIT0gbnVsbCkgewogICAgICAgICAgdGhpcy5fbmF0aXZlTW9kdWxlLnJlbW92ZUxpc3RlbmVycygxKTsKICAgICAgICB9CgogICAgICAgIGJhYmVsSGVscGVycy5nZXQoTmF0aXZlRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKE5hdGl2ZUV2ZW50RW1pdHRlci5wcm90b3R5cGUpLCAicmVtb3ZlU3Vic2NyaXB0aW9uIiwgdGhpcykuY2FsbCh0aGlzLCBzdWJzY3JpcHRpb24pOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gTmF0aXZlRXZlbnRFbWl0dGVyOwogIH0oRXZlbnRFbWl0dGVyKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBOYXRpdmVFdmVudEVtaXR0ZXI7Cn0sNjksWzY3LDUyLDcwLDEzXSwiTmF0aXZlRXZlbnRFbWl0dGVyIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkV2ZW50RW1pdHRlciIpOwoKICB2YXIgRXZlbnRTdWJzY3JpcHRpb25WZW5kb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiRXZlbnRTdWJzY3JpcHRpb25WZW5kb3IiKTsKCiAgZnVuY3Rpb24gY2hlY2tOYXRpdmVFdmVudE1vZHVsZShldmVudFR5cGUpIHsKICAgIGlmIChldmVudFR5cGUpIHsKICAgICAgaWYgKGV2ZW50VHlwZS5sYXN0SW5kZXhPZignc3RhdHVzQmFyJywgMCkgPT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2AnICsgZXZlbnRUeXBlICsgJ2AgZXZlbnQgc2hvdWxkIGJlIHJlZ2lzdGVyZWQgdmlhIHRoZSBTdGF0dXNCYXJJT1MgbW9kdWxlJyk7CiAgICAgIH0KCiAgICAgIGlmIChldmVudFR5cGUubGFzdEluZGV4T2YoJ2tleWJvYXJkJywgMCkgPT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2AnICsgZXZlbnRUeXBlICsgJ2AgZXZlbnQgc2hvdWxkIGJlIHJlZ2lzdGVyZWQgdmlhIHRoZSBLZXlib2FyZCBtb2R1bGUnKTsKICAgICAgfQoKICAgICAgaWYgKGV2ZW50VHlwZSA9PT0gJ2FwcFN0YXRlRGlkQ2hhbmdlJyB8fCBldmVudFR5cGUgPT09ICdtZW1vcnlXYXJuaW5nJykgewogICAgICAgIHRocm93IG5ldyBFcnJvcignYCcgKyBldmVudFR5cGUgKyAnYCBldmVudCBzaG91bGQgYmUgcmVnaXN0ZXJlZCB2aWEgdGhlIEFwcFN0YXRlIG1vZHVsZScpOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgUkNURGV2aWNlRXZlbnRFbWl0dGVyID0gZnVuY3Rpb24gKF9FdmVudEVtaXR0ZXIpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhSQ1REZXZpY2VFdmVudEVtaXR0ZXIsIF9FdmVudEVtaXR0ZXIpOwoKICAgIGZ1bmN0aW9uIFJDVERldmljZUV2ZW50RW1pdHRlcigpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFJDVERldmljZUV2ZW50RW1pdHRlcik7CiAgICAgIHZhciBzaGFyZWRTdWJzY3JpYmVyID0gbmV3IEV2ZW50U3Vic2NyaXB0aW9uVmVuZG9yKCk7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoUkNURGV2aWNlRXZlbnRFbWl0dGVyLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoUkNURGV2aWNlRXZlbnRFbWl0dGVyKSkuY2FsbCh0aGlzLCBzaGFyZWRTdWJzY3JpYmVyKSk7CgogICAgICBfdGhpcy5zaGFyZWRTdWJzY3JpYmVyID0gc2hhcmVkU3Vic2NyaWJlcjsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhSQ1REZXZpY2VFdmVudEVtaXR0ZXIsIFt7CiAgICAgIGtleTogImFkZExpc3RlbmVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGFkZExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIGNvbnRleHQpIHsKICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgY2hlY2tOYXRpdmVFdmVudE1vZHVsZShldmVudFR5cGUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5nZXQoUkNURGV2aWNlRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKFJDVERldmljZUV2ZW50RW1pdHRlci5wcm90b3R5cGUpLCAiYWRkTGlzdGVuZXIiLCB0aGlzKS5jYWxsKHRoaXMsIGV2ZW50VHlwZSwgbGlzdGVuZXIsIGNvbnRleHQpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZUFsbExpc3RlbmVycyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVBbGxMaXN0ZW5lcnMoZXZlbnRUeXBlKSB7CiAgICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICAgIGNoZWNrTmF0aXZlRXZlbnRNb2R1bGUoZXZlbnRUeXBlKTsKICAgICAgICB9CgogICAgICAgIGJhYmVsSGVscGVycy5nZXQoUkNURGV2aWNlRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKFJDVERldmljZUV2ZW50RW1pdHRlci5wcm90b3R5cGUpLCAicmVtb3ZlQWxsTGlzdGVuZXJzIiwgdGhpcykuY2FsbCh0aGlzLCBldmVudFR5cGUpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZVN1YnNjcmlwdGlvbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi5lbWl0dGVyICE9PSB0aGlzKSB7CiAgICAgICAgICBzdWJzY3JpcHRpb24uZW1pdHRlci5yZW1vdmVTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFiZWxIZWxwZXJzLmdldChSQ1REZXZpY2VFdmVudEVtaXR0ZXIucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoUkNURGV2aWNlRXZlbnRFbWl0dGVyLnByb3RvdHlwZSksICJyZW1vdmVTdWJzY3JpcHRpb24iLCB0aGlzKS5jYWxsKHRoaXMsIHN1YnNjcmlwdGlvbik7CiAgICAgICAgfQogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gUkNURGV2aWNlRXZlbnRFbWl0dGVyOwogIH0oRXZlbnRFbWl0dGVyKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBuZXcgUkNURGV2aWNlRXZlbnRFbWl0dGVyKCk7Cn0sNzAsWzY3LDY4XSwiUkNURGV2aWNlRXZlbnRFbWl0dGVyIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgYmluYXJ5VG9CYXNlNjQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiYmluYXJ5VG9CYXNlNjQiKTsKCiAgdmFyIEZvcm1EYXRhID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkZvcm1EYXRhIik7CgogIGZ1bmN0aW9uIGNvbnZlcnRSZXF1ZXN0Qm9keShib2R5KSB7CiAgICBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgc3RyaW5nOiBib2R5CiAgICAgIH07CiAgICB9CgogICAgaWYgKGJvZHkgaW5zdGFuY2VvZiBGb3JtRGF0YSkgewogICAgICByZXR1cm4gewogICAgICAgIGZvcm1EYXRhOiBib2R5LmdldFBhcnRzKCkKICAgICAgfTsKICAgIH0KCiAgICBpZiAoYm9keSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8IEFycmF5QnVmZmVyLmlzVmlldyhib2R5KSkgewogICAgICByZXR1cm4gewogICAgICAgIGJhc2U2NDogYmluYXJ5VG9CYXNlNjQoYm9keSkKICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gYm9keTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gY29udmVydFJlcXVlc3RCb2R5Owp9LDcxLFs3Miw3NF0sImNvbnZlcnRSZXF1ZXN0Qm9keSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGJhc2U2NCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJiYXNlNjQtanMiKTsKCiAgZnVuY3Rpb24gYmluYXJ5VG9CYXNlNjQoZGF0YSkgewogICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgICBkYXRhID0gbmV3IFVpbnQ4QXJyYXkoZGF0YSk7CiAgICB9CgogICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7CiAgICAgIHJldHVybiBiYXNlNjQuZnJvbUJ5dGVBcnJheShkYXRhKTsKICAgIH0KCiAgICBpZiAoIUFycmF5QnVmZmVyLmlzVmlldyhkYXRhKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2RhdGEgbXVzdCBiZSBBcnJheUJ1ZmZlciBvciB0eXBlZCBhcnJheScpOwogICAgfQoKICAgIHZhciBfZGF0YSA9IGRhdGEsCiAgICAgICAgYnVmZmVyID0gX2RhdGEuYnVmZmVyLAogICAgICAgIGJ5dGVPZmZzZXQgPSBfZGF0YS5ieXRlT2Zmc2V0LAogICAgICAgIGJ5dGVMZW5ndGggPSBfZGF0YS5ieXRlTGVuZ3RoOwogICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgYnl0ZUxlbmd0aCkpOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBiaW5hcnlUb0Jhc2U2NDsKfSw3MixbNzNdLCJiaW5hcnlUb0Jhc2U2NCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aDsKICBleHBvcnRzLnRvQnl0ZUFycmF5ID0gdG9CeXRlQXJyYXk7CiAgZXhwb3J0cy5mcm9tQnl0ZUFycmF5ID0gZnJvbUJ5dGVBcnJheTsKICB2YXIgbG9va3VwID0gW107CiAgdmFyIHJldkxvb2t1cCA9IFtdOwogIHZhciBBcnIgPSB0eXBlb2YgVWludDhBcnJheSAhPT0gJ3VuZGVmaW5lZCcgPyBVaW50OEFycmF5IDogQXJyYXk7CiAgdmFyIGNvZGUgPSAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODkrLyc7CgogIGZvciAodmFyIGkgPSAwLCBsZW4gPSBjb2RlLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICBsb29rdXBbaV0gPSBjb2RlW2ldOwogICAgcmV2TG9va3VwW2NvZGUuY2hhckNvZGVBdChpKV0gPSBpOwogIH0KCiAgcmV2TG9va3VwWyctJy5jaGFyQ29kZUF0KDApXSA9IDYyOwogIHJldkxvb2t1cFsnXycuY2hhckNvZGVBdCgwKV0gPSA2MzsKCiAgZnVuY3Rpb24gcGxhY2VIb2xkZXJzQ291bnQoYjY0KSB7CiAgICB2YXIgbGVuID0gYjY0Lmxlbmd0aDsKCiAgICBpZiAobGVuICUgNCA+IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHN0cmluZy4gTGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0Jyk7CiAgICB9CgogICAgcmV0dXJuIGI2NFtsZW4gLSAyXSA9PT0gJz0nID8gMiA6IGI2NFtsZW4gLSAxXSA9PT0gJz0nID8gMSA6IDA7CiAgfQoKICBmdW5jdGlvbiBieXRlTGVuZ3RoKGI2NCkgewogICAgcmV0dXJuIGI2NC5sZW5ndGggKiAzIC8gNCAtIHBsYWNlSG9sZGVyc0NvdW50KGI2NCk7CiAgfQoKICBmdW5jdGlvbiB0b0J5dGVBcnJheShiNjQpIHsKICAgIHZhciBpLCBsLCB0bXAsIHBsYWNlSG9sZGVycywgYXJyOwogICAgdmFyIGxlbiA9IGI2NC5sZW5ndGg7CiAgICBwbGFjZUhvbGRlcnMgPSBwbGFjZUhvbGRlcnNDb3VudChiNjQpOwogICAgYXJyID0gbmV3IEFycihsZW4gKiAzIC8gNCAtIHBsYWNlSG9sZGVycyk7CiAgICBsID0gcGxhY2VIb2xkZXJzID4gMCA/IGxlbiAtIDQgOiBsZW47CiAgICB2YXIgTCA9IDA7CgogICAgZm9yIChpID0gMDsgaSA8IGw7IGkgKz0gNCkgewogICAgICB0bXAgPSByZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDE4IHwgcmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAxKV0gPDwgMTIgfCByZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDIpXSA8PCA2IHwgcmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAzKV07CiAgICAgIGFycltMKytdID0gdG1wID4+IDE2ICYgMHhGRjsKICAgICAgYXJyW0wrK10gPSB0bXAgPj4gOCAmIDB4RkY7CiAgICAgIGFycltMKytdID0gdG1wICYgMHhGRjsKICAgIH0KCiAgICBpZiAocGxhY2VIb2xkZXJzID09PSAyKSB7CiAgICAgIHRtcCA9IHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMiB8IHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldID4+IDQ7CiAgICAgIGFycltMKytdID0gdG1wICYgMHhGRjsKICAgIH0gZWxzZSBpZiAocGxhY2VIb2xkZXJzID09PSAxKSB7CiAgICAgIHRtcCA9IHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMTAgfCByZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA8PCA0IHwgcmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAyKV0gPj4gMjsKICAgICAgYXJyW0wrK10gPSB0bXAgPj4gOCAmIDB4RkY7CiAgICAgIGFycltMKytdID0gdG1wICYgMHhGRjsKICAgIH0KCiAgICByZXR1cm4gYXJyOwogIH0KCiAgZnVuY3Rpb24gdHJpcGxldFRvQmFzZTY0KG51bSkgewogICAgcmV0dXJuIGxvb2t1cFtudW0gPj4gMTggJiAweDNGXSArIGxvb2t1cFtudW0gPj4gMTIgJiAweDNGXSArIGxvb2t1cFtudW0gPj4gNiAmIDB4M0ZdICsgbG9va3VwW251bSAmIDB4M0ZdOwogIH0KCiAgZnVuY3Rpb24gZW5jb2RlQ2h1bmsodWludDgsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciB0bXA7CiAgICB2YXIgb3V0cHV0ID0gW107CgogICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyBpICs9IDMpIHsKICAgICAgdG1wID0gKHVpbnQ4W2ldIDw8IDE2KSArICh1aW50OFtpICsgMV0gPDwgOCkgKyB1aW50OFtpICsgMl07CiAgICAgIG91dHB1dC5wdXNoKHRyaXBsZXRUb0Jhc2U2NCh0bXApKTsKICAgIH0KCiAgICByZXR1cm4gb3V0cHV0LmpvaW4oJycpOwogIH0KCiAgZnVuY3Rpb24gZnJvbUJ5dGVBcnJheSh1aW50OCkgewogICAgdmFyIHRtcDsKICAgIHZhciBsZW4gPSB1aW50OC5sZW5ndGg7CiAgICB2YXIgZXh0cmFCeXRlcyA9IGxlbiAlIDM7CiAgICB2YXIgb3V0cHV0ID0gJyc7CiAgICB2YXIgcGFydHMgPSBbXTsKICAgIHZhciBtYXhDaHVua0xlbmd0aCA9IDE2MzgzOwoKICAgIGZvciAodmFyIGkgPSAwLCBsZW4yID0gbGVuIC0gZXh0cmFCeXRlczsgaSA8IGxlbjI7IGkgKz0gbWF4Q2h1bmtMZW5ndGgpIHsKICAgICAgcGFydHMucHVzaChlbmNvZGVDaHVuayh1aW50OCwgaSwgaSArIG1heENodW5rTGVuZ3RoID4gbGVuMiA/IGxlbjIgOiBpICsgbWF4Q2h1bmtMZW5ndGgpKTsKICAgIH0KCiAgICBpZiAoZXh0cmFCeXRlcyA9PT0gMSkgewogICAgICB0bXAgPSB1aW50OFtsZW4gLSAxXTsKICAgICAgb3V0cHV0ICs9IGxvb2t1cFt0bXAgPj4gMl07CiAgICAgIG91dHB1dCArPSBsb29rdXBbdG1wIDw8IDQgJiAweDNGXTsKICAgICAgb3V0cHV0ICs9ICc9PSc7CiAgICB9IGVsc2UgaWYgKGV4dHJhQnl0ZXMgPT09IDIpIHsKICAgICAgdG1wID0gKHVpbnQ4W2xlbiAtIDJdIDw8IDgpICsgdWludDhbbGVuIC0gMV07CiAgICAgIG91dHB1dCArPSBsb29rdXBbdG1wID4+IDEwXTsKICAgICAgb3V0cHV0ICs9IGxvb2t1cFt0bXAgPj4gNCAmIDB4M0ZdOwogICAgICBvdXRwdXQgKz0gbG9va3VwW3RtcCA8PCAyICYgMHgzRl07CiAgICAgIG91dHB1dCArPSAnPSc7CiAgICB9CgogICAgcGFydHMucHVzaChvdXRwdXQpOwogICAgcmV0dXJuIHBhcnRzLmpvaW4oJycpOwogIH0KfSw3MyxbXSwiYmFzZTY0LWpzL2luZGV4LmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgRm9ybURhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBGb3JtRGF0YSgpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEZvcm1EYXRhKTsKICAgICAgdGhpcy5fcGFydHMgPSBbXTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoRm9ybURhdGEsIFt7CiAgICAgIGtleTogImFwcGVuZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhcHBlbmQoa2V5LCB2YWx1ZSkgewogICAgICAgIHRoaXMuX3BhcnRzLnB1c2goW2tleSwgdmFsdWVdKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRQYXJ0cyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRQYXJ0cygpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcGFydHMubWFwKGZ1bmN0aW9uIChfcmVmKSB7CiAgICAgICAgICB2YXIgX3JlZjIgPSBiYWJlbEhlbHBlcnMuc2xpY2VkVG9BcnJheShfcmVmLCAyKSwKICAgICAgICAgICAgICBuYW1lID0gX3JlZjJbMF0sCiAgICAgICAgICAgICAgdmFsdWUgPSBfcmVmMlsxXTsKCiAgICAgICAgICB2YXIgY29udGVudERpc3Bvc2l0aW9uID0gJ2Zvcm0tZGF0YTsgbmFtZT0iJyArIG5hbWUgKyAnIic7CiAgICAgICAgICB2YXIgaGVhZGVycyA9IHsKICAgICAgICAgICAgJ2NvbnRlbnQtZGlzcG9zaXRpb24nOiBjb250ZW50RGlzcG9zaXRpb24KICAgICAgICAgIH07CgogICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZS5uYW1lID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgIGhlYWRlcnNbJ2NvbnRlbnQtZGlzcG9zaXRpb24nXSArPSAnOyBmaWxlbmFtZT0iJyArIHZhbHVlLm5hbWUgKyAnIic7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUudHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICBoZWFkZXJzWydjb250ZW50LXR5cGUnXSA9IHZhbHVlLnR5cGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdmFsdWUsIHsKICAgICAgICAgICAgICBoZWFkZXJzOiBoZWFkZXJzLAogICAgICAgICAgICAgIGZpZWxkTmFtZTogbmFtZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzdHJpbmc6IFN0cmluZyh2YWx1ZSksCiAgICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnMsCiAgICAgICAgICAgIGZpZWxkTmFtZTogbmFtZQogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEZvcm1EYXRhOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBGb3JtRGF0YTsKfSw3NCxbXSwiRm9ybURhdGEiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfY2xhc3MsIF90ZW1wOwoKICB2YXIgQmxvYiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJCbG9iIik7CgogIHZhciBFdmVudFRhcmdldCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJldmVudC10YXJnZXQtc2hpbSIpOwoKICB2YXIgTmF0aXZlRXZlbnRFbWl0dGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIk5hdGl2ZUV2ZW50RW1pdHRlciIpOwoKICB2YXIgTmF0aXZlTW9kdWxlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJOYXRpdmVNb2R1bGVzIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJQbGF0Zm9ybSIpOwoKICB2YXIgV2ViU29ja2V0RXZlbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiV2ViU29ja2V0RXZlbnQiKTsKCiAgdmFyIGJhc2U2NCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJiYXNlNjQtanMiKTsKCiAgdmFyIGJpbmFyeVRvQmFzZTY0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgImJpbmFyeVRvQmFzZTY0Iik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBXZWJTb2NrZXRNb2R1bGUgPSBOYXRpdmVNb2R1bGVzLldlYlNvY2tldE1vZHVsZTsKICB2YXIgQ09OTkVDVElORyA9IDA7CiAgdmFyIE9QRU4gPSAxOwogIHZhciBDTE9TSU5HID0gMjsKICB2YXIgQ0xPU0VEID0gMzsKICB2YXIgQ0xPU0VfTk9STUFMID0gMTAwMDsKICB2YXIgV0VCU09DS0VUX0VWRU5UUyA9IFsnY2xvc2UnLCAnZXJyb3InLCAnbWVzc2FnZScsICdvcGVuJ107CiAgdmFyIG5leHRXZWJTb2NrZXRJZCA9IDA7CiAgdmFyIFdlYlNvY2tldCA9IChfdGVtcCA9IF9jbGFzcyA9IGZ1bmN0aW9uIChfRXZlbnRUYXJnZXQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhXZWJTb2NrZXQsIF9FdmVudFRhcmdldCk7CgogICAgZnVuY3Rpb24gV2ViU29ja2V0KHVybCwgcHJvdG9jb2xzLCBvcHRpb25zKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBXZWJTb2NrZXQpOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKFdlYlNvY2tldC5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKFdlYlNvY2tldCkpLmNhbGwodGhpcykpOwoKICAgICAgX3RoaXMuQ09OTkVDVElORyA9IENPTk5FQ1RJTkc7CiAgICAgIF90aGlzLk9QRU4gPSBPUEVOOwogICAgICBfdGhpcy5DTE9TSU5HID0gQ0xPU0lORzsKICAgICAgX3RoaXMuQ0xPU0VEID0gQ0xPU0VEOwogICAgICBfdGhpcy5yZWFkeVN0YXRlID0gQ09OTkVDVElORzsKCiAgICAgIGlmICh0eXBlb2YgcHJvdG9jb2xzID09PSAnc3RyaW5nJykgewogICAgICAgIHByb3RvY29scyA9IFtwcm90b2NvbHNdOwogICAgICB9CgogICAgICB2YXIgX3JlZiA9IG9wdGlvbnMgfHwge30sCiAgICAgICAgICBfcmVmJGhlYWRlcnMgPSBfcmVmLmhlYWRlcnMsCiAgICAgICAgICBoZWFkZXJzID0gX3JlZiRoZWFkZXJzID09PSB1bmRlZmluZWQgPyB7fSA6IF9yZWYkaGVhZGVycywKICAgICAgICAgIHVucmVjb2duaXplZCA9IGJhYmVsSGVscGVycy5vYmplY3RXaXRob3V0UHJvcGVydGllcyhfcmVmLCBbImhlYWRlcnMiXSk7CgogICAgICBpZiAodW5yZWNvZ25pemVkICYmIHR5cGVvZiB1bnJlY29nbml6ZWQub3JpZ2luID09PSAnc3RyaW5nJykgewogICAgICAgIGNvbnNvbGUud2FybignU3BlY2lmeWluZyBgb3JpZ2luYCBhcyBhIFdlYlNvY2tldCBjb25uZWN0aW9uIG9wdGlvbiBpcyBkZXByZWNhdGVkLiBJbmNsdWRlIGl0IHVuZGVyIGBoZWFkZXJzYCBpbnN0ZWFkLicpOwogICAgICAgIGhlYWRlcnMub3JpZ2luID0gdW5yZWNvZ25pemVkLm9yaWdpbjsKICAgICAgICBkZWxldGUgdW5yZWNvZ25pemVkLm9yaWdpbjsKICAgICAgfQoKICAgICAgaWYgKE9iamVjdC5rZXlzKHVucmVjb2duaXplZCkubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnNvbGUud2FybignVW5yZWNvZ25pemVkIFdlYlNvY2tldCBjb25uZWN0aW9uIG9wdGlvbihzKSBgJyArIE9iamVjdC5rZXlzKHVucmVjb2duaXplZCkuam9pbignYCwgYCcpICsgJ2AuICcgKyAnRGlkIHlvdSBtZWFuIHRvIHB1dCB0aGVzZSB1bmRlciBgaGVhZGVyc2A/Jyk7CiAgICAgIH0KCiAgICAgIGlmICghQXJyYXkuaXNBcnJheShwcm90b2NvbHMpKSB7CiAgICAgICAgcHJvdG9jb2xzID0gbnVsbDsKICAgICAgfQoKICAgICAgaWYgKCFXZWJTb2NrZXQuaXNBdmFpbGFibGUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBpbml0aWFsaXplIFdlYlNvY2tldCBtb2R1bGUuICcgKyAnTmF0aXZlIG1vZHVsZSBXZWJTb2NrZXRNb2R1bGUgaXMgbWlzc2luZy4nKTsKICAgICAgfQoKICAgICAgX3RoaXMuX2V2ZW50RW1pdHRlciA9IG5ldyBOYXRpdmVFdmVudEVtaXR0ZXIoV2ViU29ja2V0TW9kdWxlKTsKICAgICAgX3RoaXMuX3NvY2tldElkID0gbmV4dFdlYlNvY2tldElkKys7CgogICAgICBfdGhpcy5fcmVnaXN0ZXJFdmVudHMoKTsKCiAgICAgIFdlYlNvY2tldE1vZHVsZS5jb25uZWN0KHVybCwgcHJvdG9jb2xzLCB7CiAgICAgICAgaGVhZGVyczogaGVhZGVycwogICAgICB9LCBfdGhpcy5fc29ja2V0SWQpOwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFdlYlNvY2tldCwgW3sKICAgICAga2V5OiAiY2xvc2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY2xvc2UoY29kZSwgcmVhc29uKSB7CiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gdGhpcy5DTE9TSU5HIHx8IHRoaXMucmVhZHlTdGF0ZSA9PT0gdGhpcy5DTE9TRUQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMucmVhZHlTdGF0ZSA9IHRoaXMuQ0xPU0lORzsKCiAgICAgICAgdGhpcy5fY2xvc2UoY29kZSwgcmVhc29uKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzZW5kIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNlbmQoZGF0YSkgewogICAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IHRoaXMuQ09OTkVDVElORykgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJTlZBTElEX1NUQVRFX0VSUicpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBCbG9iKSB7CiAgICAgICAgICB2YXIgQmxvYk1vZHVsZSA9IE5hdGl2ZU1vZHVsZXMuQmxvYk1vZHVsZTsKICAgICAgICAgIGludmFyaWFudChCbG9iTW9kdWxlLCAnTmF0aXZlIG1vZHVsZSBCbG9iTW9kdWxlIGlzIHJlcXVpcmVkIGZvciBibG9iIHN1cHBvcnQnKTsKICAgICAgICAgIEJsb2JNb2R1bGUuc2VuZEJsb2IoZGF0YSwgdGhpcy5fc29ja2V0SWQpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgICAgV2ViU29ja2V0TW9kdWxlLnNlbmQoZGF0YSwgdGhpcy5fc29ja2V0SWQpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciB8fCBBcnJheUJ1ZmZlci5pc1ZpZXcoZGF0YSkpIHsKICAgICAgICAgIFdlYlNvY2tldE1vZHVsZS5zZW5kQmluYXJ5KGJpbmFyeVRvQmFzZTY0KGRhdGEpLCB0aGlzLl9zb2NrZXRJZCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIGRhdGEgdHlwZScpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInBpbmciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcGluZygpIHsKICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSB0aGlzLkNPTk5FQ1RJTkcpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSU5WQUxJRF9TVEFURV9FUlInKTsKICAgICAgICB9CgogICAgICAgIFdlYlNvY2tldE1vZHVsZS5waW5nKHRoaXMuX3NvY2tldElkKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfY2xvc2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2Nsb3NlKGNvZGUsIHJlYXNvbikgewogICAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICAgICAgICB2YXIgc3RhdHVzQ29kZSA9IHR5cGVvZiBjb2RlID09PSAnbnVtYmVyJyA/IGNvZGUgOiBDTE9TRV9OT1JNQUw7CiAgICAgICAgICB2YXIgY2xvc2VSZWFzb24gPSB0eXBlb2YgcmVhc29uID09PSAnc3RyaW5nJyA/IHJlYXNvbiA6ICcnOwogICAgICAgICAgV2ViU29ja2V0TW9kdWxlLmNsb3NlKHN0YXR1c0NvZGUsIGNsb3NlUmVhc29uLCB0aGlzLl9zb2NrZXRJZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFdlYlNvY2tldE1vZHVsZS5jbG9zZSh0aGlzLl9zb2NrZXRJZCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl91bnJlZ2lzdGVyRXZlbnRzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF91bnJlZ2lzdGVyRXZlbnRzKCkgewogICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmV0dXJuIGUucmVtb3ZlKCk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSBbXTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfcmVnaXN0ZXJFdmVudHMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX3JlZ2lzdGVyRXZlbnRzKCkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zID0gW3RoaXMuX2V2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcignd2Vic29ja2V0TWVzc2FnZScsIGZ1bmN0aW9uIChldikgewogICAgICAgICAgaWYgKGV2LmlkICE9PSBfdGhpczIuX3NvY2tldElkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZGF0YSA9IGV2LmRhdGE7CgogICAgICAgICAgc3dpdGNoIChldi50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICAgICAgZGF0YSA9IGJhc2U2NC50b0J5dGVBcnJheShldi5kYXRhKS5idWZmZXI7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICdibG9iJzoKICAgICAgICAgICAgICBkYXRhID0gQmxvYi5jcmVhdGUoZXYuZGF0YSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgX3RoaXMyLmRpc3BhdGNoRXZlbnQobmV3IFdlYlNvY2tldEV2ZW50KCdtZXNzYWdlJywgewogICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICB9KSk7CiAgICAgICAgfSksIHRoaXMuX2V2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcignd2Vic29ja2V0T3BlbicsIGZ1bmN0aW9uIChldikgewogICAgICAgICAgaWYgKGV2LmlkICE9PSBfdGhpczIuX3NvY2tldElkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBfdGhpczIucmVhZHlTdGF0ZSA9IF90aGlzMi5PUEVOOwoKICAgICAgICAgIF90aGlzMi5kaXNwYXRjaEV2ZW50KG5ldyBXZWJTb2NrZXRFdmVudCgnb3BlbicpKTsKICAgICAgICB9KSwgdGhpcy5fZXZlbnRFbWl0dGVyLmFkZExpc3RlbmVyKCd3ZWJzb2NrZXRDbG9zZWQnLCBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgIGlmIChldi5pZCAhPT0gX3RoaXMyLl9zb2NrZXRJZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgX3RoaXMyLnJlYWR5U3RhdGUgPSBfdGhpczIuQ0xPU0VEOwoKICAgICAgICAgIF90aGlzMi5kaXNwYXRjaEV2ZW50KG5ldyBXZWJTb2NrZXRFdmVudCgnY2xvc2UnLCB7CiAgICAgICAgICAgIGNvZGU6IGV2LmNvZGUsCiAgICAgICAgICAgIHJlYXNvbjogZXYucmVhc29uCiAgICAgICAgICB9KSk7CgogICAgICAgICAgX3RoaXMyLl91bnJlZ2lzdGVyRXZlbnRzKCk7CgogICAgICAgICAgX3RoaXMyLmNsb3NlKCk7CiAgICAgICAgfSksIHRoaXMuX2V2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcignd2Vic29ja2V0RmFpbGVkJywgZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICBpZiAoZXYuaWQgIT09IF90aGlzMi5fc29ja2V0SWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIF90aGlzMi5yZWFkeVN0YXRlID0gX3RoaXMyLkNMT1NFRDsKCiAgICAgICAgICBfdGhpczIuZGlzcGF0Y2hFdmVudChuZXcgV2ViU29ja2V0RXZlbnQoJ2Vycm9yJywgewogICAgICAgICAgICBtZXNzYWdlOiBldi5tZXNzYWdlCiAgICAgICAgICB9KSk7CgogICAgICAgICAgX3RoaXMyLmRpc3BhdGNoRXZlbnQobmV3IFdlYlNvY2tldEV2ZW50KCdjbG9zZScsIHsKICAgICAgICAgICAgbWVzc2FnZTogZXYubWVzc2FnZQogICAgICAgICAgfSkpOwoKICAgICAgICAgIF90aGlzMi5fdW5yZWdpc3RlckV2ZW50cygpOwoKICAgICAgICAgIF90aGlzMi5jbG9zZSgpOwogICAgICAgIH0pXTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJiaW5hcnlUeXBlIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2JpbmFyeVR5cGU7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KGJpbmFyeVR5cGUpIHsKICAgICAgICBpZiAoYmluYXJ5VHlwZSAhPT0gJ2Jsb2InICYmIGJpbmFyeVR5cGUgIT09ICdhcnJheWJ1ZmZlcicpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYmluYXJ5VHlwZSBtdXN0IGJlIGVpdGhlciBcJ2Jsb2JcJyBvciBcJ2FycmF5YnVmZmVyXCcnKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9iaW5hcnlUeXBlID09PSAnYmxvYicgfHwgYmluYXJ5VHlwZSA9PT0gJ2Jsb2InKSB7CiAgICAgICAgICB2YXIgQmxvYk1vZHVsZSA9IE5hdGl2ZU1vZHVsZXMuQmxvYk1vZHVsZTsKICAgICAgICAgIGludmFyaWFudChCbG9iTW9kdWxlLCAnTmF0aXZlIG1vZHVsZSBCbG9iTW9kdWxlIGlzIHJlcXVpcmVkIGZvciBibG9iIHN1cHBvcnQnKTsKCiAgICAgICAgICBpZiAoQmxvYk1vZHVsZSkgewogICAgICAgICAgICBpZiAoYmluYXJ5VHlwZSA9PT0gJ2Jsb2InKSB7CiAgICAgICAgICAgICAgQmxvYk1vZHVsZS5lbmFibGVCbG9iU3VwcG9ydCh0aGlzLl9zb2NrZXRJZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgQmxvYk1vZHVsZS5kaXNhYmxlQmxvYlN1cHBvcnQodGhpcy5fc29ja2V0SWQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9iaW5hcnlUeXBlID0gYmluYXJ5VHlwZTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFdlYlNvY2tldDsKICB9KEV2ZW50VGFyZ2V0LmFwcGx5KHVuZGVmaW5lZCwgV0VCU09DS0VUX0VWRU5UUykpLCBfY2xhc3MuQ09OTkVDVElORyA9IENPTk5FQ1RJTkcsIF9jbGFzcy5PUEVOID0gT1BFTiwgX2NsYXNzLkNMT1NJTkcgPSBDTE9TSU5HLCBfY2xhc3MuQ0xPU0VEID0gQ0xPU0VELCBfY2xhc3MuaXNBdmFpbGFibGUgPSAhIVdlYlNvY2tldE1vZHVsZSwgX3RlbXApOwogIG1vZHVsZS5leHBvcnRzID0gV2ViU29ja2V0Owp9LDc1LFs3Niw1OSw2OSwxNSw1Miw4Miw3Myw3MiwxM10sIldlYlNvY2tldCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIHV1aWQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAidXVpZCIpOwoKICB2YXIgX3JlcXVpcmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiTmF0aXZlTW9kdWxlcyIpLAogICAgICBCbG9iTW9kdWxlID0gX3JlcXVpcmUuQmxvYk1vZHVsZTsKCiAgdmFyIEJsb2IgPSBmdW5jdGlvbiAoKSB7CiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQmxvYiwgbnVsbCwgW3sKICAgICAga2V5OiAiY3JlYXRlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZShwcm9wcykgewogICAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyhPYmplY3QuY3JlYXRlKEJsb2IucHJvdG90eXBlKSwgcHJvcHMpOwogICAgICB9CiAgICB9XSk7CgogICAgZnVuY3Rpb24gQmxvYihwYXJ0cywgb3B0aW9ucykgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQmxvYik7CiAgICAgIHZhciBibG9iSWQgPSB1dWlkKCk7CiAgICAgIHZhciBzaXplID0gMDsKICAgICAgcGFydHMuZm9yRWFjaChmdW5jdGlvbiAocGFydCkgewogICAgICAgIGludmFyaWFudChwYXJ0IGluc3RhbmNlb2YgQmxvYiwgJ0NhbiBjdXJyZW50bHkgb25seSBjcmVhdGUgYSBCbG9iIGZyb20gb3RoZXIgQmxvYnMnKTsKICAgICAgICBzaXplICs9IHBhcnQuc2l6ZTsKICAgICAgfSk7CiAgICAgIEJsb2JNb2R1bGUuY3JlYXRlRnJvbVBhcnRzKHBhcnRzLCBibG9iSWQpOwogICAgICByZXR1cm4gQmxvYi5jcmVhdGUoewogICAgICAgIGJsb2JJZDogYmxvYklkLAogICAgICAgIG9mZnNldDogMCwKICAgICAgICBzaXplOiBzaXplCiAgICAgIH0pOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhCbG9iLCBbewogICAgICBrZXk6ICJzbGljZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzbGljZShzdGFydCwgZW5kKSB7CiAgICAgICAgdmFyIG9mZnNldCA9IHRoaXMub2Zmc2V0OwogICAgICAgIHZhciBzaXplID0gdGhpcy5zaXplOwoKICAgICAgICBpZiAodHlwZW9mIHN0YXJ0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgaWYgKHN0YXJ0ID4gc2l6ZSkgewogICAgICAgICAgICBzdGFydCA9IHNpemU7CiAgICAgICAgICB9CgogICAgICAgICAgb2Zmc2V0ICs9IHN0YXJ0OwogICAgICAgICAgc2l6ZSAtPSBzdGFydDsKCiAgICAgICAgICBpZiAodHlwZW9mIGVuZCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgaWYgKGVuZCA8IDApIHsKICAgICAgICAgICAgICBlbmQgPSB0aGlzLnNpemUgKyBlbmQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNpemUgPSBlbmQgLSBzdGFydDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBCbG9iLmNyZWF0ZSh7CiAgICAgICAgICBibG9iSWQ6IHRoaXMuYmxvYklkLAogICAgICAgICAgb2Zmc2V0OiBvZmZzZXQsCiAgICAgICAgICBzaXplOiBzaXplCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY2xvc2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY2xvc2UoKSB7CiAgICAgICAgQmxvYk1vZHVsZS5yZWxlYXNlKHRoaXMuYmxvYklkKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEJsb2I7CiAgfSgpOwoKICBtb2R1bGUuZXhwb3J0cyA9IEJsb2I7Cn0sNzYsWzEzLDc3LDE1XSwiQmxvYiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogIHZhciB2MSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL3YxJyk7CgogIHZhciB2NCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICcuL3Y0Jyk7CgogIHZhciB1dWlkID0gdjQ7CiAgdXVpZC52MSA9IHYxOwogIHV1aWQudjQgPSB2NDsKICBtb2R1bGUuZXhwb3J0cyA9IHV1aWQ7Cn0sNzcsWzc4LDgxXSwidXVpZC9pbmRleC5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogIHZhciBybmcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9saWIvcm5nJyk7CgogIHZhciBieXRlc1RvVXVpZCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICcuL2xpYi9ieXRlc1RvVXVpZCcpOwoKICB2YXIgX25vZGVJZDsKCiAgdmFyIF9jbG9ja3NlcTsKCiAgdmFyIF9sYXN0TVNlY3MgPSAwOwogIHZhciBfbGFzdE5TZWNzID0gMDsKCiAgZnVuY3Rpb24gdjEob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gYnVmICYmIG9mZnNldCB8fCAwOwogICAgdmFyIGIgPSBidWYgfHwgW107CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHZhciBub2RlID0gb3B0aW9ucy5ub2RlIHx8IF9ub2RlSWQ7CiAgICB2YXIgY2xvY2tzZXEgPSBvcHRpb25zLmNsb2Nrc2VxICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNsb2Nrc2VxIDogX2Nsb2Nrc2VxOwoKICAgIGlmIChub2RlID09IG51bGwgfHwgY2xvY2tzZXEgPT0gbnVsbCkgewogICAgICB2YXIgc2VlZEJ5dGVzID0gcm5nKCk7CgogICAgICBpZiAobm9kZSA9PSBudWxsKSB7CiAgICAgICAgbm9kZSA9IF9ub2RlSWQgPSBbc2VlZEJ5dGVzWzBdIHwgMHgwMSwgc2VlZEJ5dGVzWzFdLCBzZWVkQnl0ZXNbMl0sIHNlZWRCeXRlc1szXSwgc2VlZEJ5dGVzWzRdLCBzZWVkQnl0ZXNbNV1dOwogICAgICB9CgogICAgICBpZiAoY2xvY2tzZXEgPT0gbnVsbCkgewogICAgICAgIGNsb2Nrc2VxID0gX2Nsb2Nrc2VxID0gKHNlZWRCeXRlc1s2XSA8PCA4IHwgc2VlZEJ5dGVzWzddKSAmIDB4M2ZmZjsKICAgICAgfQogICAgfQoKICAgIHZhciBtc2VjcyA9IG9wdGlvbnMubXNlY3MgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubXNlY3MgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciBuc2VjcyA9IG9wdGlvbnMubnNlY3MgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubnNlY3MgOiBfbGFzdE5TZWNzICsgMTsKICAgIHZhciBkdCA9IG1zZWNzIC0gX2xhc3RNU2VjcyArIChuc2VjcyAtIF9sYXN0TlNlY3MpIC8gMTAwMDA7CgogICAgaWYgKGR0IDwgMCAmJiBvcHRpb25zLmNsb2Nrc2VxID09PSB1bmRlZmluZWQpIHsKICAgICAgY2xvY2tzZXEgPSBjbG9ja3NlcSArIDEgJiAweDNmZmY7CiAgICB9CgogICAgaWYgKChkdCA8IDAgfHwgbXNlY3MgPiBfbGFzdE1TZWNzKSAmJiBvcHRpb25zLm5zZWNzID09PSB1bmRlZmluZWQpIHsKICAgICAgbnNlY3MgPSAwOwogICAgfQoKICAgIGlmIChuc2VjcyA+PSAxMDAwMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3V1aWQudjEoKTogQ2FuXCd0IGNyZWF0ZSBtb3JlIHRoYW4gMTBNIHV1aWRzL3NlYycpOwogICAgfQoKICAgIF9sYXN0TVNlY3MgPSBtc2VjczsKICAgIF9sYXN0TlNlY3MgPSBuc2VjczsKICAgIF9jbG9ja3NlcSA9IGNsb2Nrc2VxOwogICAgbXNlY3MgKz0gMTIyMTkyOTI4MDAwMDA7CiAgICB2YXIgdGwgPSAoKG1zZWNzICYgMHhmZmZmZmZmKSAqIDEwMDAwICsgbnNlY3MpICUgMHgxMDAwMDAwMDA7CiAgICBiW2krK10gPSB0bCA+Pj4gMjQgJiAweGZmOwogICAgYltpKytdID0gdGwgPj4+IDE2ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRsID4+PiA4ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRsICYgMHhmZjsKICAgIHZhciB0bWggPSBtc2VjcyAvIDB4MTAwMDAwMDAwICogMTAwMDAgJiAweGZmZmZmZmY7CiAgICBiW2krK10gPSB0bWggPj4+IDggJiAweGZmOwogICAgYltpKytdID0gdG1oICYgMHhmZjsKICAgIGJbaSsrXSA9IHRtaCA+Pj4gMjQgJiAweGYgfCAweDEwOwogICAgYltpKytdID0gdG1oID4+PiAxNiAmIDB4ZmY7CiAgICBiW2krK10gPSBjbG9ja3NlcSA+Pj4gOCB8IDB4ODA7CiAgICBiW2krK10gPSBjbG9ja3NlcSAmIDB4ZmY7CgogICAgZm9yICh2YXIgbiA9IDA7IG4gPCA2OyArK24pIHsKICAgICAgYltpICsgbl0gPSBub2RlW25dOwogICAgfQoKICAgIHJldHVybiBidWYgPyBidWYgOiBieXRlc1RvVXVpZChiKTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gdjE7Cn0sNzgsWzc5LDgwXSwidXVpZC92MS5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogIHZhciBnZXRSYW5kb21WYWx1ZXMgPSB0eXBlb2YgY3J5cHRvICE9ICd1bmRlZmluZWQnICYmIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMuYmluZChjcnlwdG8pIHx8IHR5cGVvZiBtc0NyeXB0byAhPSAndW5kZWZpbmVkJyAmJiBtc0NyeXB0by5nZXRSYW5kb21WYWx1ZXMuYmluZChtc0NyeXB0byk7CgogIGlmIChnZXRSYW5kb21WYWx1ZXMpIHsKICAgIHZhciBybmRzOCA9IG5ldyBVaW50OEFycmF5KDE2KTsKCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIHdoYXR3Z1JORygpIHsKICAgICAgZ2V0UmFuZG9tVmFsdWVzKHJuZHM4KTsKICAgICAgcmV0dXJuIHJuZHM4OwogICAgfTsKICB9IGVsc2UgewogICAgdmFyIHJuZHMgPSBuZXcgQXJyYXkoMTYpOwoKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gbWF0aFJORygpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIHI7IGkgPCAxNjsgaSsrKSB7CiAgICAgICAgaWYgKChpICYgMHgwMykgPT09IDApIHIgPSBNYXRoLnJhbmRvbSgpICogMHgxMDAwMDAwMDA7CiAgICAgICAgcm5kc1tpXSA9IHIgPj4+ICgoaSAmIDB4MDMpIDw8IDMpICYgMHhmZjsKICAgICAgfQoKICAgICAgcmV0dXJuIHJuZHM7CiAgICB9OwogIH0KfSw3OSxbXSwidXVpZC9saWIvcm5nLWJyb3dzZXIuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICB2YXIgYnl0ZVRvSGV4ID0gW107CgogIGZvciAodmFyIGkgPSAwOyBpIDwgMjU2OyArK2kpIHsKICAgIGJ5dGVUb0hleFtpXSA9IChpICsgMHgxMDApLnRvU3RyaW5nKDE2KS5zdWJzdHIoMSk7CiAgfQoKICBmdW5jdGlvbiBieXRlc1RvVXVpZChidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSBvZmZzZXQgfHwgMDsKICAgIHZhciBidGggPSBieXRlVG9IZXg7CiAgICByZXR1cm4gYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArICctJyArIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsgJy0nICsgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyAnLScgKyBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArICctJyArIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXSArIGJ0aFtidWZbaSsrXV0gKyBidGhbYnVmW2krK11dICsgYnRoW2J1ZltpKytdXTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gYnl0ZXNUb1V1aWQ7Cn0sODAsW10sInV1aWQvbGliL2J5dGVzVG9VdWlkLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgdmFyIHJuZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL2xpYi9ybmcnKTsKCiAgdmFyIGJ5dGVzVG9VdWlkID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vbGliL2J5dGVzVG9VdWlkJyk7CgogIGZ1bmN0aW9uIHY0KG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT0gJ3N0cmluZycpIHsKICAgICAgYnVmID0gb3B0aW9ucyA9PT0gJ2JpbmFyeScgPyBuZXcgQXJyYXkoMTYpIDogbnVsbDsKICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICB9CgogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB2YXIgcm5kcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBybmcpKCk7CiAgICBybmRzWzZdID0gcm5kc1s2XSAmIDB4MGYgfCAweDQwOwogICAgcm5kc1s4XSA9IHJuZHNbOF0gJiAweDNmIHwgMHg4MDsKCiAgICBpZiAoYnVmKSB7CiAgICAgIGZvciAodmFyIGlpID0gMDsgaWkgPCAxNjsgKytpaSkgewogICAgICAgIGJ1ZltpICsgaWldID0gcm5kc1tpaV07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYnVmIHx8IGJ5dGVzVG9VdWlkKHJuZHMpOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSB2NDsKfSw4MSxbNzksODBdLCJ1dWlkL3Y0LmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgV2ViU29ja2V0RXZlbnQgPSBmdW5jdGlvbiBXZWJTb2NrZXRFdmVudCh0eXBlLCBldmVudEluaXREaWN0KSB7CiAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgV2ViU29ja2V0RXZlbnQpOwogICAgdGhpcy50eXBlID0gdHlwZS50b1N0cmluZygpOwogICAgYmFiZWxIZWxwZXJzLmV4dGVuZHModGhpcywgZXZlbnRJbml0RGljdCk7CiAgfTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBXZWJTb2NrZXRFdmVudDsKfSw4MixbXSwiV2ViU29ja2V0RXZlbnQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBCbG9iID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkJsb2IiKTsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIk5hdGl2ZU1vZHVsZXMiKSwKICAgICAgQmxvYk1vZHVsZSA9IF9yZXF1aXJlLkJsb2JNb2R1bGU7CgogIHZhciBCTE9CX1VSTF9QUkVGSVggPSBudWxsOwoKICBpZiAoQmxvYk1vZHVsZSAmJiB0eXBlb2YgQmxvYk1vZHVsZS5CTE9CX1VSSV9TQ0hFTUUgPT09ICdzdHJpbmcnKSB7CiAgICBCTE9CX1VSTF9QUkVGSVggPSBCbG9iTW9kdWxlLkJMT0JfVVJJX1NDSEVNRSArICc6JzsKCiAgICBpZiAodHlwZW9mIEJsb2JNb2R1bGUuQkxPQl9VUklfSE9TVCA9PT0gJ3N0cmluZycpIHsKICAgICAgQkxPQl9VUkxfUFJFRklYICs9ICIvLyIgKyBCbG9iTW9kdWxlLkJMT0JfVVJJX0hPU1QgKyAiLyI7CiAgICB9CiAgfQoKICB2YXIgVVJMID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gVVJMKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgVVJMKTsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDcmVhdGluZyBCbG9iVVJMIG9iamVjdHMgaXMgbm90IHN1cHBvcnRlZCB5ZXQuJyk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFVSTCwgbnVsbCwgW3sKICAgICAga2V5OiAiY3JlYXRlT2JqZWN0VVJMIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZU9iamVjdFVSTChibG9iKSB7CiAgICAgICAgaWYgKEJMT0JfVVJMX1BSRUZJWCA9PT0gbnVsbCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgY3JlYXRlIFVSTCBmb3IgYmxvYiEnKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAiIiArIEJMT0JfVVJMX1BSRUZJWCArIGJsb2IuYmxvYklkICsgIj9vZmZzZXQ9IiArIGJsb2Iub2Zmc2V0ICsgIiZzaXplPSIgKyBibG9iLnNpemU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmV2b2tlT2JqZWN0VVJMIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJldm9rZU9iamVjdFVSTCh1cmwpIHt9CiAgICB9XSk7CiAgICByZXR1cm4gVVJMOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBVUkw7Cn0sODMsWzc2LDE1XSwiVVJMIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgQWxlcnRJT1MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQWxlcnRJT1MiKTsKCiAgdmFyIE5hdGl2ZU1vZHVsZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiTmF0aXZlTW9kdWxlcyIpOwoKICB2YXIgUGxhdGZvcm0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUGxhdGZvcm0iKTsKCiAgdmFyIEFsZXJ0ID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQWxlcnQoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBBbGVydCk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEFsZXJ0LCBudWxsLCBbewogICAgICBrZXk6ICJhbGVydCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhbGVydCh0aXRsZSwgbWVzc2FnZSwgYnV0dG9ucywgb3B0aW9ucywgdHlwZSkgewogICAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdBbGVydC5hbGVydCgpIHdpdGggYSA1dGggInR5cGUiIHBhcmFtZXRlciBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQuIFVzZSBBbGVydElPUy5wcm9tcHQoKSBpbnN0ZWFkLicpOwogICAgICAgICAgICBBbGVydElPUy5hbGVydCh0aXRsZSwgbWVzc2FnZSwgYnV0dG9ucywgdHlwZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBBbGVydElPUy5hbGVydCh0aXRsZSwgbWVzc2FnZSwgYnV0dG9ucyk7CiAgICAgICAgfSBlbHNlIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICAgICAgICBBbGVydEFuZHJvaWQuYWxlcnQodGl0bGUsIG1lc3NhZ2UsIGJ1dHRvbnMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEFsZXJ0OwogIH0oKTsKCiAgdmFyIEFsZXJ0QW5kcm9pZCA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEFsZXJ0QW5kcm9pZCgpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEFsZXJ0QW5kcm9pZCk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEFsZXJ0QW5kcm9pZCwgbnVsbCwgW3sKICAgICAga2V5OiAiYWxlcnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gYWxlcnQodGl0bGUsIG1lc3NhZ2UsIGJ1dHRvbnMsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgY29uZmlnID0gewogICAgICAgICAgdGl0bGU6IHRpdGxlIHx8ICcnLAogICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSB8fCAnJwogICAgICAgIH07CgogICAgICAgIGlmIChvcHRpb25zKSB7CiAgICAgICAgICBjb25maWcgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgY29uZmlnLCB7CiAgICAgICAgICAgIGNhbmNlbGFibGU6IG9wdGlvbnMuY2FuY2VsYWJsZQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgdmFsaWRCdXR0b25zID0gYnV0dG9ucyA/IGJ1dHRvbnMuc2xpY2UoMCwgMykgOiBbewogICAgICAgICAgdGV4dDogJ09LJwogICAgICAgIH1dOwogICAgICAgIHZhciBidXR0b25Qb3NpdGl2ZSA9IHZhbGlkQnV0dG9ucy5wb3AoKTsKICAgICAgICB2YXIgYnV0dG9uTmVnYXRpdmUgPSB2YWxpZEJ1dHRvbnMucG9wKCk7CiAgICAgICAgdmFyIGJ1dHRvbk5ldXRyYWwgPSB2YWxpZEJ1dHRvbnMucG9wKCk7CgogICAgICAgIGlmIChidXR0b25OZXV0cmFsKSB7CiAgICAgICAgICBjb25maWcgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgY29uZmlnLCB7CiAgICAgICAgICAgIGJ1dHRvbk5ldXRyYWw6IGJ1dHRvbk5ldXRyYWwudGV4dCB8fCAnJwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoYnV0dG9uTmVnYXRpdmUpIHsKICAgICAgICAgIGNvbmZpZyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBjb25maWcsIHsKICAgICAgICAgICAgYnV0dG9uTmVnYXRpdmU6IGJ1dHRvbk5lZ2F0aXZlLnRleHQgfHwgJycKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKGJ1dHRvblBvc2l0aXZlKSB7CiAgICAgICAgICBjb25maWcgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgY29uZmlnLCB7CiAgICAgICAgICAgIGJ1dHRvblBvc2l0aXZlOiBidXR0b25Qb3NpdGl2ZS50ZXh0IHx8ICcnCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIE5hdGl2ZU1vZHVsZXMuRGlhbG9nTWFuYWdlckFuZHJvaWQuc2hvd0FsZXJ0KGNvbmZpZywgZnVuY3Rpb24gKGVycm9yTWVzc2FnZSkgewogICAgICAgICAgcmV0dXJuIGNvbnNvbGUud2FybihlcnJvck1lc3NhZ2UpOwogICAgICAgIH0sIGZ1bmN0aW9uIChhY3Rpb24sIGJ1dHRvbktleSkgewogICAgICAgICAgaWYgKGFjdGlvbiA9PT0gTmF0aXZlTW9kdWxlcy5EaWFsb2dNYW5hZ2VyQW5kcm9pZC5idXR0b25DbGlja2VkKSB7CiAgICAgICAgICAgIGlmIChidXR0b25LZXkgPT09IE5hdGl2ZU1vZHVsZXMuRGlhbG9nTWFuYWdlckFuZHJvaWQuYnV0dG9uTmV1dHJhbCkgewogICAgICAgICAgICAgIGJ1dHRvbk5ldXRyYWwub25QcmVzcyAmJiBidXR0b25OZXV0cmFsLm9uUHJlc3MoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChidXR0b25LZXkgPT09IE5hdGl2ZU1vZHVsZXMuRGlhbG9nTWFuYWdlckFuZHJvaWQuYnV0dG9uTmVnYXRpdmUpIHsKICAgICAgICAgICAgICBidXR0b25OZWdhdGl2ZS5vblByZXNzICYmIGJ1dHRvbk5lZ2F0aXZlLm9uUHJlc3MoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChidXR0b25LZXkgPT09IE5hdGl2ZU1vZHVsZXMuRGlhbG9nTWFuYWdlckFuZHJvaWQuYnV0dG9uUG9zaXRpdmUpIHsKICAgICAgICAgICAgICBidXR0b25Qb3NpdGl2ZS5vblByZXNzICYmIGJ1dHRvblBvc2l0aXZlLm9uUHJlc3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09IE5hdGl2ZU1vZHVsZXMuRGlhbG9nTWFuYWdlckFuZHJvaWQuZGlzbWlzc2VkKSB7CiAgICAgICAgICAgIG9wdGlvbnMgJiYgb3B0aW9ucy5vbkRpc21pc3MgJiYgb3B0aW9ucy5vbkRpc21pc3MoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEFsZXJ0QW5kcm9pZDsKICB9KCk7CgogIG1vZHVsZS5leHBvcnRzID0gQWxlcnQ7Cn0sODQsWzg1LDE1LDUyXSwiQWxlcnQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBSQ1RBbGVydE1hbmFnZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTmF0aXZlTW9kdWxlcyIpLkFsZXJ0TWFuYWdlcjsKCiAgdmFyIEFsZXJ0SU9TID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQWxlcnRJT1MoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBBbGVydElPUyk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEFsZXJ0SU9TLCBudWxsLCBbewogICAgICBrZXk6ICJhbGVydCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhbGVydCh0aXRsZSwgbWVzc2FnZSwgY2FsbGJhY2tPckJ1dHRvbnMsIHR5cGUpIHsKICAgICAgICBpZiAodHlwZW9mIHR5cGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oJ0FsZXJ0SU9TLmFsZXJ0KCkgd2l0aCBhIDR0aCAidHlwZSIgcGFyYW1ldGVyIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZC4gVXNlIEFsZXJ0SU9TLnByb21wdCgpIGluc3RlYWQuJyk7CiAgICAgICAgICB0aGlzLnByb21wdCh0aXRsZSwgbWVzc2FnZSwgY2FsbGJhY2tPckJ1dHRvbnMsIHR5cGUpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5wcm9tcHQodGl0bGUsIG1lc3NhZ2UsIGNhbGxiYWNrT3JCdXR0b25zLCAnZGVmYXVsdCcpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInByb21wdCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBwcm9tcHQodGl0bGUsIG1lc3NhZ2UsIGNhbGxiYWNrT3JCdXR0b25zKSB7CiAgICAgICAgdmFyIHR5cGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMyAmJiBhcmd1bWVudHNbM10gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1szXSA6ICdwbGFpbi10ZXh0JzsKICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0gYXJndW1lbnRzWzRdOwogICAgICAgIHZhciBrZXlib2FyZFR5cGUgPSBhcmd1bWVudHNbNV07CgogICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgY29uc29sZS53YXJuKCdZb3UgcGFzc2VkIGEgY2FsbGJhY2sgZnVuY3Rpb24gYXMgdGhlICJ0eXBlIiBhcmd1bWVudCB0byBBbGVydElPUy5wcm9tcHQoKS4gUmVhY3QgTmF0aXZlIGlzICcgKyAnYXNzdW1pbmcgIHlvdSB3YW50IHRvIHVzZSB0aGUgZGVwcmVjYXRlZCBBbGVydElPUy5wcm9tcHQodGl0bGUsIGRlZmF1bHRWYWx1ZSwgYnV0dG9ucywgY2FsbGJhY2spICcgKyAnc2lnbmF0dXJlLiBUaGUgY3VycmVudCBzaWduYXR1cmUgaXMgQWxlcnRJT1MucHJvbXB0KHRpdGxlLCBtZXNzYWdlLCBjYWxsYmFja09yQnV0dG9ucywgdHlwZSwgZGVmYXVsdFZhbHVlLCAnICsgJ2tleWJvYXJkVHlwZSkgYW5kIHRoZSBvbGQgc3ludGF4IHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSB2ZXJzaW9uLicpOwogICAgICAgICAgdmFyIGNhbGxiYWNrID0gdHlwZTsKICAgICAgICAgIHZhciBkZWZhdWx0VmFsdWUgPSBtZXNzYWdlOwogICAgICAgICAgUkNUQWxlcnRNYW5hZ2VyLmFsZXJ0V2l0aEFyZ3MoewogICAgICAgICAgICB0aXRsZTogdGl0bGUgfHwgJycsCiAgICAgICAgICAgIHR5cGU6ICdwbGFpbi10ZXh0JywKICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiBkZWZhdWx0VmFsdWUKICAgICAgICAgIH0sIGZ1bmN0aW9uIChpZCwgdmFsdWUpIHsKICAgICAgICAgICAgY2FsbGJhY2sodmFsdWUpOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgY2FsbGJhY2tzID0gW107CiAgICAgICAgdmFyIGJ1dHRvbnMgPSBbXTsKICAgICAgICB2YXIgY2FuY2VsQnV0dG9uS2V5OwogICAgICAgIHZhciBkZXN0cnVjdGl2ZUJ1dHRvbktleTsKCiAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFja09yQnV0dG9ucyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgY2FsbGJhY2tzID0gW2NhbGxiYWNrT3JCdXR0b25zXTsKICAgICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrT3JCdXR0b25zIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgIGNhbGxiYWNrT3JCdXR0b25zLmZvckVhY2goZnVuY3Rpb24gKGJ0biwgaW5kZXgpIHsKICAgICAgICAgICAgY2FsbGJhY2tzW2luZGV4XSA9IGJ0bi5vblByZXNzOwoKICAgICAgICAgICAgaWYgKGJ0bi5zdHlsZSA9PT0gJ2NhbmNlbCcpIHsKICAgICAgICAgICAgICBjYW5jZWxCdXR0b25LZXkgPSBTdHJpbmcoaW5kZXgpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJ0bi5zdHlsZSA9PT0gJ2Rlc3RydWN0aXZlJykgewogICAgICAgICAgICAgIGRlc3RydWN0aXZlQnV0dG9uS2V5ID0gU3RyaW5nKGluZGV4KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJ0bi50ZXh0IHx8IGluZGV4IDwgKGNhbGxiYWNrT3JCdXR0b25zIHx8IFtdKS5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgdmFyIGJ0bkRlZiA9IHt9OwogICAgICAgICAgICAgIGJ0bkRlZltpbmRleF0gPSBidG4udGV4dCB8fCAnJzsKICAgICAgICAgICAgICBidXR0b25zLnB1c2goYnRuRGVmKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBSQ1RBbGVydE1hbmFnZXIuYWxlcnRXaXRoQXJncyh7CiAgICAgICAgICB0aXRsZTogdGl0bGUgfHwgJycsCiAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlIHx8IHVuZGVmaW5lZCwKICAgICAgICAgIGJ1dHRvbnM6IGJ1dHRvbnMsCiAgICAgICAgICB0eXBlOiB0eXBlIHx8IHVuZGVmaW5lZCwKICAgICAgICAgIGRlZmF1bHRWYWx1ZTogZGVmYXVsdFZhbHVlLAogICAgICAgICAgY2FuY2VsQnV0dG9uS2V5OiBjYW5jZWxCdXR0b25LZXksCiAgICAgICAgICBkZXN0cnVjdGl2ZUJ1dHRvbktleTogZGVzdHJ1Y3RpdmVCdXR0b25LZXksCiAgICAgICAgICBrZXlib2FyZFR5cGU6IGtleWJvYXJkVHlwZQogICAgICAgIH0sIGZ1bmN0aW9uIChpZCwgdmFsdWUpIHsKICAgICAgICAgIHZhciBjYiA9IGNhbGxiYWNrc1tpZF07CiAgICAgICAgICBjYiAmJiBjYih2YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBBbGVydElPUzsKICB9KCk7CgogIG1vZHVsZS5leHBvcnRzID0gQWxlcnRJT1M7Cn0sODUsWzE1XSwiQWxlcnRJT1MiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBOYXRpdmVFdmVudEVtaXR0ZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTmF0aXZlRXZlbnRFbWl0dGVyIik7CgogIHZhciBSQ1RMb2NhdGlvbk9ic2VydmVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIk5hdGl2ZU1vZHVsZXMiKS5Mb2NhdGlvbk9ic2VydmVyOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgbG9nRXJyb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAibG9nRXJyb3IiKTsKCiAgdmFyIHdhcm5pbmcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiZmJqcy9saWIvd2FybmluZyIpOwoKICB2YXIgTG9jYXRpb25FdmVudEVtaXR0ZXIgPSBuZXcgTmF0aXZlRXZlbnRFbWl0dGVyKFJDVExvY2F0aW9uT2JzZXJ2ZXIpOwoKICB2YXIgUGxhdGZvcm0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiUGxhdGZvcm0iKTsKCiAgdmFyIFBlcm1pc3Npb25zQW5kcm9pZCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJQZXJtaXNzaW9uc0FuZHJvaWQiKTsKCiAgdmFyIHN1YnNjcmlwdGlvbnMgPSBbXTsKICB2YXIgdXBkYXRlc0VuYWJsZWQgPSBmYWxzZTsKICB2YXIgR2VvbG9jYXRpb24gPSB7CiAgICBzZXRSTkNvbmZpZ3VyYXRpb246IGZ1bmN0aW9uIHNldFJOQ29uZmlndXJhdGlvbihjb25maWcpIHsKICAgICAgaWYgKFJDVExvY2F0aW9uT2JzZXJ2ZXIuc2V0Q29uZmlndXJhdGlvbikgewogICAgICAgIFJDVExvY2F0aW9uT2JzZXJ2ZXIuc2V0Q29uZmlndXJhdGlvbihjb25maWcpOwogICAgICB9CiAgICB9LAogICAgcmVxdWVzdEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIHJlcXVlc3RBdXRob3JpemF0aW9uKCkgewogICAgICBSQ1RMb2NhdGlvbk9ic2VydmVyLnJlcXVlc3RBdXRob3JpemF0aW9uKCk7CiAgICB9LAogICAgZ2V0Q3VycmVudFBvc2l0aW9uOiBmdW5jdGlvbiBnZXRDdXJyZW50UG9zaXRpb24oZ2VvX3N1Y2Nlc3MsIGdlb19lcnJvciwgZ2VvX29wdGlvbnMpIHsKICAgICAgdmFyIGhhc1Blcm1pc3Npb24sIHN0YXR1czsKICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS5hc3luYyhmdW5jdGlvbiBnZXRDdXJyZW50UG9zaXRpb24kKF9jb250ZXh0KSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIGludmFyaWFudCh0eXBlb2YgZ2VvX3N1Y2Nlc3MgPT09ICdmdW5jdGlvbicsICdNdXN0IHByb3ZpZGUgYSB2YWxpZCBnZW9fc3VjY2VzcyBjYWxsYmFjay4nKTsKICAgICAgICAgICAgICBoYXNQZXJtaXNzaW9uID0gdHJ1ZTsKCiAgICAgICAgICAgICAgaWYgKCEoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJyAmJiBQbGF0Zm9ybS5WZXJzaW9uID49IDIzKSkgewogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDExOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gNTsKICAgICAgICAgICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmF3cmFwKFBlcm1pc3Npb25zQW5kcm9pZC5jaGVjayhQZXJtaXNzaW9uc0FuZHJvaWQuUEVSTUlTU0lPTlMuQUNDRVNTX0ZJTkVfTE9DQVRJT04pKTsKCiAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICBoYXNQZXJtaXNzaW9uID0gX2NvbnRleHQuc2VudDsKCiAgICAgICAgICAgICAgaWYgKGhhc1Blcm1pc3Npb24pIHsKICAgICAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSAxMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS5hd3JhcChQZXJtaXNzaW9uc0FuZHJvaWQucmVxdWVzdChQZXJtaXNzaW9uc0FuZHJvaWQuUEVSTUlTU0lPTlMuQUNDRVNTX0ZJTkVfTE9DQVRJT04pKTsKCiAgICAgICAgICAgIGNhc2UgOToKICAgICAgICAgICAgICBzdGF0dXMgPSBfY29udGV4dC5zZW50OwogICAgICAgICAgICAgIGhhc1Blcm1pc3Npb24gPSBzdGF0dXMgPT09IFBlcm1pc3Npb25zQW5kcm9pZC5SRVNVTFRTLkdSQU5URUQ7CgogICAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICAgIGlmIChoYXNQZXJtaXNzaW9uKSB7CiAgICAgICAgICAgICAgICBSQ1RMb2NhdGlvbk9ic2VydmVyLmdldEN1cnJlbnRQb3NpdGlvbihnZW9fb3B0aW9ucyB8fCB7fSwgZ2VvX3N1Y2Nlc3MsIGdlb19lcnJvciB8fCBsb2dFcnJvcik7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FzZSAxMjoKICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgbnVsbCwgdGhpcyk7CiAgICB9LAogICAgd2F0Y2hQb3NpdGlvbjogZnVuY3Rpb24gd2F0Y2hQb3NpdGlvbihzdWNjZXNzLCBlcnJvciwgb3B0aW9ucykgewogICAgICBpZiAoIXVwZGF0ZXNFbmFibGVkKSB7CiAgICAgICAgUkNUTG9jYXRpb25PYnNlcnZlci5zdGFydE9ic2VydmluZyhvcHRpb25zIHx8IHt9KTsKICAgICAgICB1cGRhdGVzRW5hYmxlZCA9IHRydWU7CiAgICAgIH0KCiAgICAgIHZhciB3YXRjaElEID0gc3Vic2NyaXB0aW9ucy5sZW5ndGg7CiAgICAgIHN1YnNjcmlwdGlvbnMucHVzaChbTG9jYXRpb25FdmVudEVtaXR0ZXIuYWRkTGlzdGVuZXIoJ2dlb2xvY2F0aW9uRGlkQ2hhbmdlJywgc3VjY2VzcyksIGVycm9yID8gTG9jYXRpb25FdmVudEVtaXR0ZXIuYWRkTGlzdGVuZXIoJ2dlb2xvY2F0aW9uRXJyb3InLCBlcnJvcikgOiBudWxsXSk7CiAgICAgIHJldHVybiB3YXRjaElEOwogICAgfSwKICAgIGNsZWFyV2F0Y2g6IGZ1bmN0aW9uIGNsZWFyV2F0Y2god2F0Y2hJRCkgewogICAgICB2YXIgc3ViID0gc3Vic2NyaXB0aW9uc1t3YXRjaElEXTsKCiAgICAgIGlmICghc3ViKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBzdWJbMF0ucmVtb3ZlKCk7CiAgICAgIHZhciBzdWIxID0gc3ViWzFdOwogICAgICBzdWIxICYmIHN1YjEucmVtb3ZlKCk7CiAgICAgIHN1YnNjcmlwdGlvbnNbd2F0Y2hJRF0gPSB1bmRlZmluZWQ7CiAgICAgIHZhciBub1dhdGNoZXJzID0gdHJ1ZTsKCiAgICAgIGZvciAodmFyIGlpID0gMDsgaWkgPCBzdWJzY3JpcHRpb25zLmxlbmd0aDsgaWkrKykgewogICAgICAgIGlmIChzdWJzY3JpcHRpb25zW2lpXSkgewogICAgICAgICAgbm9XYXRjaGVycyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKG5vV2F0Y2hlcnMpIHsKICAgICAgICBHZW9sb2NhdGlvbi5zdG9wT2JzZXJ2aW5nKCk7CiAgICAgIH0KICAgIH0sCiAgICBzdG9wT2JzZXJ2aW5nOiBmdW5jdGlvbiBzdG9wT2JzZXJ2aW5nKCkgewogICAgICBpZiAodXBkYXRlc0VuYWJsZWQpIHsKICAgICAgICBSQ1RMb2NhdGlvbk9ic2VydmVyLnN0b3BPYnNlcnZpbmcoKTsKICAgICAgICB1cGRhdGVzRW5hYmxlZCA9IGZhbHNlOwoKICAgICAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgc3Vic2NyaXB0aW9ucy5sZW5ndGg7IGlpKyspIHsKICAgICAgICAgIHZhciBzdWIgPSBzdWJzY3JpcHRpb25zW2lpXTsKCiAgICAgICAgICBpZiAoc3ViKSB7CiAgICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICdDYWxsZWQgc3RvcE9ic2VydmluZyB3aXRoIGV4aXN0aW5nIHN1YnNjcmlwdGlvbnMuJyk7CiAgICAgICAgICAgIHN1YlswXS5yZW1vdmUoKTsKICAgICAgICAgICAgdmFyIHN1YjEgPSBzdWJbMV07CiAgICAgICAgICAgIHN1YjEgJiYgc3ViMS5yZW1vdmUoKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHN1YnNjcmlwdGlvbnMgPSBbXTsKICAgICAgfQogICAgfQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBHZW9sb2NhdGlvbjsKfSw4NixbNjksMTUsMTMsODcsNTYsNTIsODhdLCJHZW9sb2NhdGlvbiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGxvZ0Vycm9yID0gZnVuY3Rpb24gbG9nRXJyb3IoKSB7CiAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgfQoKICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMSAmJiBhcmdzWzBdIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgdmFyIGVyciA9IGFyZ3NbMF07CiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yOiAiJyArIGVyci5tZXNzYWdlICsgJyIuICBTdGFjazpcbicgKyBlcnIuc3RhY2spOwogICAgfSBlbHNlIHsKICAgICAgY29uc29sZS5lcnJvci5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgIH0KICB9OwoKICBtb2R1bGUuZXhwb3J0cyA9IGxvZ0Vycm9yOwp9LDg3LFtdLCJsb2dFcnJvciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIE5hdGl2ZU1vZHVsZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTmF0aXZlTW9kdWxlcyIpOwoKICB2YXIgUGVybWlzc2lvbnNBbmRyb2lkID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gUGVybWlzc2lvbnNBbmRyb2lkKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgUGVybWlzc2lvbnNBbmRyb2lkKTsKICAgICAgdGhpcy5QRVJNSVNTSU9OUyA9IHsKICAgICAgICBSRUFEX0NBTEVOREFSOiAnYW5kcm9pZC5wZXJtaXNzaW9uLlJFQURfQ0FMRU5EQVInLAogICAgICAgIFdSSVRFX0NBTEVOREFSOiAnYW5kcm9pZC5wZXJtaXNzaW9uLldSSVRFX0NBTEVOREFSJywKICAgICAgICBDQU1FUkE6ICdhbmRyb2lkLnBlcm1pc3Npb24uQ0FNRVJBJywKICAgICAgICBSRUFEX0NPTlRBQ1RTOiAnYW5kcm9pZC5wZXJtaXNzaW9uLlJFQURfQ09OVEFDVFMnLAogICAgICAgIFdSSVRFX0NPTlRBQ1RTOiAnYW5kcm9pZC5wZXJtaXNzaW9uLldSSVRFX0NPTlRBQ1RTJywKICAgICAgICBHRVRfQUNDT1VOVFM6ICdhbmRyb2lkLnBlcm1pc3Npb24uR0VUX0FDQ09VTlRTJywKICAgICAgICBBQ0NFU1NfRklORV9MT0NBVElPTjogJ2FuZHJvaWQucGVybWlzc2lvbi5BQ0NFU1NfRklORV9MT0NBVElPTicsCiAgICAgICAgQUNDRVNTX0NPQVJTRV9MT0NBVElPTjogJ2FuZHJvaWQucGVybWlzc2lvbi5BQ0NFU1NfQ09BUlNFX0xPQ0FUSU9OJywKICAgICAgICBSRUNPUkRfQVVESU86ICdhbmRyb2lkLnBlcm1pc3Npb24uUkVDT1JEX0FVRElPJywKICAgICAgICBSRUFEX1BIT05FX1NUQVRFOiAnYW5kcm9pZC5wZXJtaXNzaW9uLlJFQURfUEhPTkVfU1RBVEUnLAogICAgICAgIENBTExfUEhPTkU6ICdhbmRyb2lkLnBlcm1pc3Npb24uQ0FMTF9QSE9ORScsCiAgICAgICAgUkVBRF9DQUxMX0xPRzogJ2FuZHJvaWQucGVybWlzc2lvbi5SRUFEX0NBTExfTE9HJywKICAgICAgICBXUklURV9DQUxMX0xPRzogJ2FuZHJvaWQucGVybWlzc2lvbi5XUklURV9DQUxMX0xPRycsCiAgICAgICAgQUREX1ZPSUNFTUFJTDogJ2NvbS5hbmRyb2lkLnZvaWNlbWFpbC5wZXJtaXNzaW9uLkFERF9WT0lDRU1BSUwnLAogICAgICAgIFVTRV9TSVA6ICdhbmRyb2lkLnBlcm1pc3Npb24uVVNFX1NJUCcsCiAgICAgICAgUFJPQ0VTU19PVVRHT0lOR19DQUxMUzogJ2FuZHJvaWQucGVybWlzc2lvbi5QUk9DRVNTX09VVEdPSU5HX0NBTExTJywKICAgICAgICBCT0RZX1NFTlNPUlM6ICdhbmRyb2lkLnBlcm1pc3Npb24uQk9EWV9TRU5TT1JTJywKICAgICAgICBTRU5EX1NNUzogJ2FuZHJvaWQucGVybWlzc2lvbi5TRU5EX1NNUycsCiAgICAgICAgUkVDRUlWRV9TTVM6ICdhbmRyb2lkLnBlcm1pc3Npb24uUkVDRUlWRV9TTVMnLAogICAgICAgIFJFQURfU01TOiAnYW5kcm9pZC5wZXJtaXNzaW9uLlJFQURfU01TJywKICAgICAgICBSRUNFSVZFX1dBUF9QVVNIOiAnYW5kcm9pZC5wZXJtaXNzaW9uLlJFQ0VJVkVfV0FQX1BVU0gnLAogICAgICAgIFJFQ0VJVkVfTU1TOiAnYW5kcm9pZC5wZXJtaXNzaW9uLlJFQ0VJVkVfTU1TJywKICAgICAgICBSRUFEX0VYVEVSTkFMX1NUT1JBR0U6ICdhbmRyb2lkLnBlcm1pc3Npb24uUkVBRF9FWFRFUk5BTF9TVE9SQUdFJywKICAgICAgICBXUklURV9FWFRFUk5BTF9TVE9SQUdFOiAnYW5kcm9pZC5wZXJtaXNzaW9uLldSSVRFX0VYVEVSTkFMX1NUT1JBR0UnCiAgICAgIH07CiAgICAgIHRoaXMuUkVTVUxUUyA9IHsKICAgICAgICBHUkFOVEVEOiAnZ3JhbnRlZCcsCiAgICAgICAgREVOSUVEOiAnZGVuaWVkJywKICAgICAgICBORVZFUl9BU0tfQUdBSU46ICduZXZlcl9hc2tfYWdhaW4nCiAgICAgIH07CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFBlcm1pc3Npb25zQW5kcm9pZCwgW3sKICAgICAga2V5OiAiY2hlY2tQZXJtaXNzaW9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNoZWNrUGVybWlzc2lvbihwZXJtaXNzaW9uKSB7CiAgICAgICAgY29uc29sZS53YXJuKCciUGVybWlzc2lvbnNBbmRyb2lkLmNoZWNrUGVybWlzc2lvbiIgaXMgZGVwcmVjYXRlZC4gVXNlICJQZXJtaXNzaW9uc0FuZHJvaWQuY2hlY2siIGluc3RlYWQnKTsKICAgICAgICByZXR1cm4gTmF0aXZlTW9kdWxlcy5QZXJtaXNzaW9uc0FuZHJvaWQuY2hlY2tQZXJtaXNzaW9uKHBlcm1pc3Npb24pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNoZWNrIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNoZWNrKHBlcm1pc3Npb24pIHsKICAgICAgICByZXR1cm4gTmF0aXZlTW9kdWxlcy5QZXJtaXNzaW9uc0FuZHJvaWQuY2hlY2tQZXJtaXNzaW9uKHBlcm1pc3Npb24pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlcXVlc3RQZXJtaXNzaW9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlcXVlc3RQZXJtaXNzaW9uKHBlcm1pc3Npb24sIHJhdGlvbmFsZSkgewogICAgICAgIHZhciByZXNwb25zZTsKICAgICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmFzeW5jKGZ1bmN0aW9uIHJlcXVlc3RQZXJtaXNzaW9uJChfY29udGV4dCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dC5wcmV2ID0gX2NvbnRleHQubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignIlBlcm1pc3Npb25zQW5kcm9pZC5yZXF1ZXN0UGVybWlzc2lvbiIgaXMgZGVwcmVjYXRlZC4gVXNlICJQZXJtaXNzaW9uc0FuZHJvaWQucmVxdWVzdCIgaW5zdGVhZCcpOwogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDM7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmF3cmFwKHRoaXMucmVxdWVzdChwZXJtaXNzaW9uLCByYXRpb25hbGUpKTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBfY29udGV4dC5zZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LmFicnVwdCgicmV0dXJuIiwgcmVzcG9uc2UgPT09IHRoaXMuUkVTVUxUUy5HUkFOVEVEKTsKCiAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgbnVsbCwgdGhpcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVxdWVzdCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZXF1ZXN0KHBlcm1pc3Npb24sIHJhdGlvbmFsZSkgewogICAgICAgIHZhciBzaG91bGRTaG93UmF0aW9uYWxlOwogICAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUuYXN5bmMoZnVuY3Rpb24gcmVxdWVzdCQoX2NvbnRleHQyKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Mi5wcmV2ID0gX2NvbnRleHQyLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBpZiAoIXJhdGlvbmFsZSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gMzsKICAgICAgICAgICAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUuYXdyYXAoTmF0aXZlTW9kdWxlcy5QZXJtaXNzaW9uc0FuZHJvaWQuc2hvdWxkU2hvd1JlcXVlc3RQZXJtaXNzaW9uUmF0aW9uYWxlKHBlcm1pc3Npb24pKTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgc2hvdWxkU2hvd1JhdGlvbmFsZSA9IF9jb250ZXh0Mi5zZW50OwoKICAgICAgICAgICAgICAgIGlmICghc2hvdWxkU2hvd1JhdGlvbmFsZSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuYWJydXB0KCJyZXR1cm4iLCBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgIE5hdGl2ZU1vZHVsZXMuRGlhbG9nTWFuYWdlckFuZHJvaWQuc2hvd0FsZXJ0KHJhdGlvbmFsZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKCdFcnJvciBzaG93aW5nIHJhdGlvbmFsZScpKTsKICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKE5hdGl2ZU1vZHVsZXMuUGVybWlzc2lvbnNBbmRyb2lkLnJlcXVlc3RQZXJtaXNzaW9uKHBlcm1pc3Npb24pKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuYWJydXB0KCJyZXR1cm4iLCBOYXRpdmVNb2R1bGVzLlBlcm1pc3Npb25zQW5kcm9pZC5yZXF1ZXN0UGVybWlzc2lvbihwZXJtaXNzaW9uKSk7CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBudWxsLCB0aGlzKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZXF1ZXN0TXVsdGlwbGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVxdWVzdE11bHRpcGxlKHBlcm1pc3Npb25zKSB7CiAgICAgICAgcmV0dXJuIE5hdGl2ZU1vZHVsZXMuUGVybWlzc2lvbnNBbmRyb2lkLnJlcXVlc3RNdWx0aXBsZVBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFBlcm1pc3Npb25zQW5kcm9pZDsKICB9KCk7CgogIFBlcm1pc3Npb25zQW5kcm9pZCA9IG5ldyBQZXJtaXNzaW9uc0FuZHJvaWQoKTsKICBtb2R1bGUuZXhwb3J0cyA9IFBlcm1pc3Npb25zQW5kcm9pZDsKfSw4OCxbMTVdLCJQZXJtaXNzaW9uc0FuZHJvaWQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBIZWFwQ2FwdHVyZSA9IHsKICAgIGNhcHR1cmVIZWFwOiBmdW5jdGlvbiBjYXB0dXJlSGVhcChwYXRoKSB7CiAgICAgIHZhciBlcnJvciA9IG51bGw7CgogICAgICB0cnkgewogICAgICAgIGdsb2JhbC5uYXRpdmVDYXB0dXJlSGVhcChwYXRoKTsKICAgICAgICBjb25zb2xlLmxvZygnSGVhcENhcHR1cmUuY2FwdHVyZUhlYXAgc3VjY2VlZGVkOiAnICsgcGF0aCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmxvZygnSGVhcENhcHR1cmUuY2FwdHVyZUhlYXAgZXJyb3I6ICcgKyBlLnRvU3RyaW5nKCkpOwogICAgICAgIGVycm9yID0gZS50b1N0cmluZygpOwogICAgICB9CgogICAgICByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTmF0aXZlTW9kdWxlcyIpLkpTQ0hlYXBDYXB0dXJlLmNhcHR1cmVDb21wbGV0ZShwYXRoLCBlcnJvcik7CiAgICB9CiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IEhlYXBDYXB0dXJlOwp9LDg5LFsxNV0sIkhlYXBDYXB0dXJlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgU2FtcGxpbmdQcm9maWxlciA9IHsKICAgIHBva2U6IGZ1bmN0aW9uIHBva2UodG9rZW4pIHsKICAgICAgdmFyIGVycm9yID0gbnVsbDsKICAgICAgdmFyIHJlc3VsdCA9IG51bGw7CgogICAgICB0cnkgewogICAgICAgIHJlc3VsdCA9IGdsb2JhbC5wb2tlU2FtcGxpbmdQcm9maWxlcigpOwoKICAgICAgICBpZiAocmVzdWx0ID09PSBudWxsKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnVGhlIEpTQyBTYW1wbGluZyBQcm9maWxlciBoYXMgc3RhcnRlZCcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnVGhlIEpTQyBTYW1wbGluZyBQcm9maWxlciBoYXMgc3RvcHBlZCcpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUubG9nKCdFcnJvciBvY2N1cmVkIHdoZW4gcmVzdGFydGluZyBTYW1wbGluZyBQcm9maWxlcjogJyArIGUudG9TdHJpbmcoKSk7CiAgICAgICAgZXJyb3IgPSBlLnRvU3RyaW5nKCk7CiAgICAgIH0KCiAgICAgIHZhciBfcmVxdWlyZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIiksCiAgICAgICAgICBKU0NTYW1wbGluZ1Byb2ZpbGVyID0gX3JlcXVpcmUuSlNDU2FtcGxpbmdQcm9maWxlcjsKCiAgICAgIEpTQ1NhbXBsaW5nUHJvZmlsZXIub3BlcmF0aW9uQ29tcGxldGUodG9rZW4sIHJlc3VsdCwgZXJyb3IpOwogICAgfQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBTYW1wbGluZ1Byb2ZpbGVyOwp9LDkwLFsxNV0sIlNhbXBsaW5nUHJvZmlsZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBsZXZlbHNNYXAgPSB7CiAgICBsb2c6ICdsb2cnLAogICAgaW5mbzogJ2luZm8nLAogICAgd2FybjogJ3dhcm4nLAogICAgZXJyb3I6ICdlcnJvcicsCiAgICBmYXRhbDogJ2Vycm9yJwogIH07CiAgdmFyIHdhcm5pbmdIYW5kbGVyID0gbnVsbDsKICB2YXIgUkNUTG9nID0gewogICAgbG9nSWZOb05hdGl2ZUhvb2s6IGZ1bmN0aW9uIGxvZ0lmTm9OYXRpdmVIb29rKGxldmVsKSB7CiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleSAtIDFdID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICBpZiAodHlwZW9mIGdsb2JhbC5uYXRpdmVMb2dnaW5nSG9vayA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICBSQ1RMb2cubG9nVG9Db25zb2xlLmFwcGx5KFJDVExvZywgW2xldmVsXS5jb25jYXQoYmFiZWxIZWxwZXJzLnRvQ29uc3VtYWJsZUFycmF5KGFyZ3MpKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHdhcm5pbmdIYW5kbGVyICYmIGxldmVsID09PSAnd2FybicpIHsKICAgICAgICAgIHdhcm5pbmdIYW5kbGVyLmFwcGx5KHVuZGVmaW5lZCwgYmFiZWxIZWxwZXJzLnRvQ29uc3VtYWJsZUFycmF5KGFyZ3MpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBsb2dUb0NvbnNvbGU6IGZ1bmN0aW9uIGxvZ1RvQ29uc29sZShsZXZlbCkgewogICAgICB2YXIgX2NvbnNvbGU7CgogICAgICB2YXIgbG9nRm4gPSBsZXZlbHNNYXBbbGV2ZWxdOwogICAgICBpbnZhcmlhbnQobG9nRm4sICdMZXZlbCAiJyArIGxldmVsICsgJyIgbm90IG9uZSBvZiAnICsgT2JqZWN0LmtleXMobGV2ZWxzTWFwKS50b1N0cmluZygpKTsKCiAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICB9CgogICAgICAoX2NvbnNvbGUgPSBjb25zb2xlKVtsb2dGbl0uYXBwbHkoX2NvbnNvbGUsIGJhYmVsSGVscGVycy50b0NvbnN1bWFibGVBcnJheShhcmdzKSk7CiAgICB9LAogICAgc2V0V2FybmluZ0hhbmRsZXI6IGZ1bmN0aW9uIHNldFdhcm5pbmdIYW5kbGVyKGhhbmRsZXIpIHsKICAgICAgd2FybmluZ0hhbmRsZXIgPSBoYW5kbGVyOwogICAgfQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBSQ1RMb2c7Cn0sOTEsWzEzXSwiUkNUTG9nIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgUkNURGV2aWNlRXZlbnRFbWl0dGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJDVERldmljZUV2ZW50RW1pdHRlciIpOwoKICB2YXIgUkNUTmF0aXZlQXBwRXZlbnRFbWl0dGVyID0gUkNURGV2aWNlRXZlbnRFbWl0dGVyOwogIG1vZHVsZS5leHBvcnRzID0gUkNUTmF0aXZlQXBwRXZlbnRFbWl0dGVyOwp9LDkyLFs3MF0sIlJDVE5hdGl2ZUFwcEV2ZW50RW1pdHRlciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFN5c3RyYWNlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlN5c3RyYWNlIik7CgogIHZhciBpbmZvTG9nID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImluZm9Mb2ciKTsKCiAgdmFyIHBlcmZvcm1hbmNlTm93ID0gZ2xvYmFsLm5hdGl2ZVBlcmZvcm1hbmNlTm93IHx8IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJmYmpzL2xpYi9wZXJmb3JtYW5jZU5vdyIpOwoKICB2YXIgdGltZXNwYW5zID0ge307CiAgdmFyIGV4dHJhcyA9IHt9OwogIHZhciBjb29raWVzID0ge307CiAgdmFyIFBSSU5UX1RPX0NPTlNPTEUgPSBmYWxzZTsKICB2YXIgUGVyZm9ybWFuY2VMb2dnZXIgPSB7CiAgICBhZGRUaW1lc3BhbjogZnVuY3Rpb24gYWRkVGltZXNwYW4oa2V5LCBsZW5ndGhJbk1zLCBkZXNjcmlwdGlvbikgewogICAgICBpZiAodGltZXNwYW5zW2tleV0pIHsKICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgaW5mb0xvZygnUGVyZm9ybWFuY2VMb2dnZXI6IEF0dGVtcHRpbmcgdG8gYWRkIGEgdGltZXNwYW4gdGhhdCBhbHJlYWR5IGV4aXN0cyAnLCBrZXkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aW1lc3BhbnNba2V5XSA9IHsKICAgICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb24sCiAgICAgICAgdG90YWxUaW1lOiBsZW5ndGhJbk1zCiAgICAgIH07CiAgICB9LAogICAgc3RhcnRUaW1lc3BhbjogZnVuY3Rpb24gc3RhcnRUaW1lc3BhbihrZXksIGRlc2NyaXB0aW9uKSB7CiAgICAgIGlmICh0aW1lc3BhbnNba2V5XSkgewogICAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgICBpbmZvTG9nKCdQZXJmb3JtYW5jZUxvZ2dlcjogQXR0ZW1wdGluZyB0byBzdGFydCBhIHRpbWVzcGFuIHRoYXQgYWxyZWFkeSBleGlzdHMgJywga2V5KTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGltZXNwYW5zW2tleV0gPSB7CiAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLAogICAgICAgIHN0YXJ0VGltZTogcGVyZm9ybWFuY2VOb3coKQogICAgICB9OwogICAgICBjb29raWVzW2tleV0gPSBTeXN0cmFjZS5iZWdpbkFzeW5jRXZlbnQoa2V5KTsKCiAgICAgIGlmIChfX0RFVl9fICYmIFBSSU5UX1RPX0NPTlNPTEUpIHsKICAgICAgICBpbmZvTG9nKCdQZXJmb3JtYW5jZUxvZ2dlci5qcycsICdzdGFydDogJyArIGtleSk7CiAgICAgIH0KICAgIH0sCiAgICBzdG9wVGltZXNwYW46IGZ1bmN0aW9uIHN0b3BUaW1lc3BhbihrZXkpIHsKICAgICAgdmFyIHRpbWVzcGFuID0gdGltZXNwYW5zW2tleV07CgogICAgICBpZiAoIXRpbWVzcGFuIHx8ICF0aW1lc3Bhbi5zdGFydFRpbWUpIHsKICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgaW5mb0xvZygnUGVyZm9ybWFuY2VMb2dnZXI6IEF0dGVtcHRpbmcgdG8gZW5kIGEgdGltZXNwYW4gdGhhdCBoYXMgbm90IHN0YXJ0ZWQgJywga2V5KTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHRpbWVzcGFuLmVuZFRpbWUpIHsKICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgaW5mb0xvZygnUGVyZm9ybWFuY2VMb2dnZXI6IEF0dGVtcHRpbmcgdG8gZW5kIGEgdGltZXNwYW4gdGhhdCBoYXMgYWxyZWFkeSBlbmRlZCAnLCBrZXkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aW1lc3Bhbi5lbmRUaW1lID0gcGVyZm9ybWFuY2VOb3coKTsKICAgICAgdGltZXNwYW4udG90YWxUaW1lID0gdGltZXNwYW4uZW5kVGltZSAtICh0aW1lc3Bhbi5zdGFydFRpbWUgfHwgMCk7CgogICAgICBpZiAoX19ERVZfXyAmJiBQUklOVF9UT19DT05TT0xFKSB7CiAgICAgICAgaW5mb0xvZygnUGVyZm9ybWFuY2VMb2dnZXIuanMnLCAnZW5kOiAnICsga2V5KTsKICAgICAgfQoKICAgICAgU3lzdHJhY2UuZW5kQXN5bmNFdmVudChrZXksIGNvb2tpZXNba2V5XSk7CiAgICAgIGRlbGV0ZSBjb29raWVzW2tleV07CiAgICB9LAogICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICB0aW1lc3BhbnMgPSB7fTsKICAgICAgZXh0cmFzID0ge307CiAgICB9LAogICAgY2xlYXJDb21wbGV0ZWQ6IGZ1bmN0aW9uIGNsZWFyQ29tcGxldGVkKCkgewogICAgICBmb3IgKHZhciBfa2V5IGluIHRpbWVzcGFucykgewogICAgICAgIGlmICh0aW1lc3BhbnNbX2tleV0udG90YWxUaW1lKSB7CiAgICAgICAgICBkZWxldGUgdGltZXNwYW5zW19rZXldOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZXh0cmFzID0ge307CiAgICB9LAogICAgY2xlYXJFeGNlcHRUaW1lc3BhbnM6IGZ1bmN0aW9uIGNsZWFyRXhjZXB0VGltZXNwYW5zKGtleXMpIHsKICAgICAgdGltZXNwYW5zID0gT2JqZWN0LmtleXModGltZXNwYW5zKS5yZWR1Y2UoZnVuY3Rpb24gKHByZXZpb3VzLCBrZXkpIHsKICAgICAgICBpZiAoa2V5cy5pbmRleE9mKGtleSkgIT09IC0xKSB7CiAgICAgICAgICBwcmV2aW91c1trZXldID0gdGltZXNwYW5zW2tleV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcHJldmlvdXM7CiAgICAgIH0sIHt9KTsKICAgICAgZXh0cmFzID0ge307CiAgICB9LAogICAgY3VycmVudFRpbWVzdGFtcDogZnVuY3Rpb24gY3VycmVudFRpbWVzdGFtcCgpIHsKICAgICAgcmV0dXJuIHBlcmZvcm1hbmNlTm93KCk7CiAgICB9LAogICAgZ2V0VGltZXNwYW5zOiBmdW5jdGlvbiBnZXRUaW1lc3BhbnMoKSB7CiAgICAgIHJldHVybiB0aW1lc3BhbnM7CiAgICB9LAogICAgaGFzVGltZXNwYW46IGZ1bmN0aW9uIGhhc1RpbWVzcGFuKGtleSkgewogICAgICByZXR1cm4gISF0aW1lc3BhbnNba2V5XTsKICAgIH0sCiAgICBsb2dUaW1lc3BhbnM6IGZ1bmN0aW9uIGxvZ1RpbWVzcGFucygpIHsKICAgICAgZm9yICh2YXIgX2tleTIgaW4gdGltZXNwYW5zKSB7CiAgICAgICAgaWYgKHRpbWVzcGFuc1tfa2V5Ml0udG90YWxUaW1lKSB7CiAgICAgICAgICBpbmZvTG9nKF9rZXkyICsgJzogJyArIHRpbWVzcGFuc1tfa2V5Ml0udG90YWxUaW1lICsgJ21zJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgYWRkVGltZXNwYW5zOiBmdW5jdGlvbiBhZGRUaW1lc3BhbnMobmV3VGltZXNwYW5zLCBsYWJlbHMpIHsKICAgICAgZm9yICh2YXIgaWkgPSAwLCBsID0gbmV3VGltZXNwYW5zLmxlbmd0aDsgaWkgPCBsOyBpaSArPSAyKSB7CiAgICAgICAgdmFyIGxhYmVsID0gbGFiZWxzW2lpIC8gMl07CiAgICAgICAgUGVyZm9ybWFuY2VMb2dnZXIuYWRkVGltZXNwYW4obGFiZWwsIG5ld1RpbWVzcGFuc1tpaSArIDFdIC0gbmV3VGltZXNwYW5zW2lpXSwgbGFiZWwpOwogICAgICB9CiAgICB9LAogICAgc2V0RXh0cmE6IGZ1bmN0aW9uIHNldEV4dHJhKGtleSwgdmFsdWUpIHsKICAgICAgaWYgKGV4dHJhc1trZXldKSB7CiAgICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICAgIGluZm9Mb2coJ1BlcmZvcm1hbmNlTG9nZ2VyOiBBdHRlbXB0aW5nIHRvIHNldCBhbiBleHRyYSB0aGF0IGFscmVhZHkgZXhpc3RzICcsIHsKICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgIGN1cnJlbnRWYWx1ZTogZXh0cmFzW2tleV0sCiAgICAgICAgICAgIGF0dGVtcHRlZFZhbHVlOiB2YWx1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGV4dHJhc1trZXldID0gdmFsdWU7CiAgICB9LAogICAgZ2V0RXh0cmFzOiBmdW5jdGlvbiBnZXRFeHRyYXMoKSB7CiAgICAgIHJldHVybiBleHRyYXM7CiAgICB9CiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IFBlcmZvcm1hbmNlTG9nZ2VyOwp9LDkzLFsxOSw5NCw1M10sIlBlcmZvcm1hbmNlTG9nZ2VyIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBpbmZvTG9nKCkgewogICAgdmFyIF9jb25zb2xlOwoKICAgIHJldHVybiAoX2NvbnNvbGUgPSBjb25zb2xlKS5sb2cuYXBwbHkoX2NvbnNvbGUsIGFyZ3VtZW50cyk7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGluZm9Mb2c7Cn0sOTQsW10sImluZm9Mb2ciKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJQbGF0Zm9ybSIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgSE1SQ2xpZW50ID0gewogICAgZW5hYmxlOiBmdW5jdGlvbiBlbmFibGUocGxhdGZvcm0sIGJ1bmRsZUVudHJ5LCBob3N0LCBwb3J0KSB7CiAgICAgIGludmFyaWFudChwbGF0Zm9ybSwgJ01pc3NpbmcgcmVxdWlyZWQgcGFyYW1ldGVyIGBwbGF0Zm9ybWAnKTsKICAgICAgaW52YXJpYW50KGJ1bmRsZUVudHJ5LCAnTWlzc2luZyByZXF1aXJlZCBwYXJhbWVudGVyIGBidW5kbGVFbnRyeWAnKTsKICAgICAgaW52YXJpYW50KGhvc3QsICdNaXNzaW5nIHJlcXVpcmVkIHBhcmFtZW50ZXIgYGhvc3RgJyk7CgogICAgICB2YXIgV2ViU29ja2V0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIldlYlNvY2tldCIpOwoKICAgICAgdmFyIHdzSG9zdFBvcnQgPSBwb3J0ICE9PSBudWxsICYmIHBvcnQgIT09ICcnID8gaG9zdCArICI6IiArIHBvcnQgOiBob3N0OwogICAgICBidW5kbGVFbnRyeSA9IGJ1bmRsZUVudHJ5LnJlcGxhY2UoL1wuKGJ1bmRsZXxkZWx0YSkvLCAnLmpzJyk7CiAgICAgIHZhciB3c1VybCA9ICJ3czovLyIgKyB3c0hvc3RQb3J0ICsgIi9ob3Q/IiArICgicGxhdGZvcm09IiArIHBsYXRmb3JtICsgIiYiKSArICgiYnVuZGxlRW50cnk9IiArIGJ1bmRsZUVudHJ5KTsKICAgICAgdmFyIGFjdGl2ZVdTID0gbmV3IFdlYlNvY2tldCh3c1VybCk7CgogICAgICBhY3RpdmVXUy5vbmVycm9yID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICB2YXIgZXJyb3IgPSAiSG90IGxvYWRpbmcgaXNuJ3Qgd29ya2luZyBiZWNhdXNlIGl0IGNhbm5vdCBjb25uZWN0IHRvIHRoZSBkZXZlbG9wbWVudCBzZXJ2ZXIuXG5cblRyeSB0aGUgZm9sbG93aW5nIHRvIGZpeCB0aGUgaXNzdWU6XG4tIEVuc3VyZSB0aGF0IHRoZSBwYWNrYWdlciBzZXJ2ZXIgaXMgcnVubmluZyBhbmQgYXZhaWxhYmxlIG9uIHRoZSBzYW1lIG5ldHdvcmsiOwoKICAgICAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICdpb3MnKSB7CiAgICAgICAgICBlcnJvciArPSAiXG4tIEVuc3VyZSB0aGF0IHRoZSBQYWNrYWdlciBzZXJ2ZXIgVVJMIGlzIGNvcnJlY3RseSBzZXQgaW4gQXBwRGVsZWdhdGUiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlcnJvciArPSAiXG4tIEVuc3VyZSB0aGF0IHlvdXIgZGV2aWNlL2VtdWxhdG9yIGlzIGNvbm5lY3RlZCB0byB5b3VyIG1hY2hpbmUgYW5kIGhhcyBVU0IgZGVidWdnaW5nIGVuYWJsZWQgLSBydW4gJ2FkYiBkZXZpY2VzJyB0byBzZWUgYSBsaXN0IG9mIGNvbm5lY3RlZCBkZXZpY2VzXG4tIElmIHlvdSdyZSBvbiBhIHBoeXNpY2FsIGRldmljZSBjb25uZWN0ZWQgdG8gdGhlIHNhbWUgbWFjaGluZSwgcnVuICdhZGIgcmV2ZXJzZSB0Y3A6ODA4MSB0Y3A6ODA4MScgdG8gZm9yd2FyZCByZXF1ZXN0cyBmcm9tIHlvdXIgZGV2aWNlXG4tIElmIHlvdXIgZGV2aWNlIGlzIG9uIHRoZSBzYW1lIFdpLUZpIG5ldHdvcmssIHNldCAnRGVidWcgc2VydmVyIGhvc3QgJiBwb3J0IGZvciBkZXZpY2UnIGluICdEZXYgc2V0dGluZ3MnIHRvIHlvdXIgbWFjaGluZSdzIElQIGFkZHJlc3MgYW5kIHRoZSBwb3J0IG9mIHRoZSBsb2NhbCBkZXYgc2VydmVyIC0gZS5nLiAxMC4wLjEuMTo4MDgxIjsKICAgICAgICB9CgogICAgICAgIGVycm9yICs9ICJcblxuVVJMOiAiICsgaG9zdCArICI6IiArIHBvcnQgKyAiXG5cbkVycm9yOiAiICsgZS5tZXNzYWdlOwogICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvcik7CiAgICAgIH07CgogICAgICBhY3RpdmVXUy5vbm1lc3NhZ2UgPSBmdW5jdGlvbiAoX3JlZikgewogICAgICAgIHZhciBkYXRhID0gX3JlZi5kYXRhOwoKICAgICAgICB2YXIgSE1STG9hZGluZ1ZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiSE1STG9hZGluZ1ZpZXciKTsKCiAgICAgICAgZGF0YSA9IEpTT04ucGFyc2UoZGF0YSk7CgogICAgICAgIHN3aXRjaCAoZGF0YS50eXBlKSB7CiAgICAgICAgICBjYXNlICd1cGRhdGUtc3RhcnQnOgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgSE1STG9hZGluZ1ZpZXcuc2hvd01lc3NhZ2UoJ0hvdCBMb2FkaW5nLi4uJyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICBjYXNlICd1cGRhdGUnOgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9kYXRhJGJvZHkgPSBkYXRhLmJvZHksCiAgICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBfZGF0YSRib2R5Lm1vZHVsZXMsCiAgICAgICAgICAgICAgICAgIHNvdXJjZU1hcHBpbmdVUkxzID0gX2RhdGEkYm9keS5zb3VyY2VNYXBwaW5nVVJMcywKICAgICAgICAgICAgICAgICAgc291cmNlVVJMcyA9IF9kYXRhJGJvZHkuc291cmNlVVJMczsKCiAgICAgICAgICAgICAgaWYgKFBsYXRmb3JtLk9TID09PSAnaW9zJykgewogICAgICAgICAgICAgICAgdmFyIFJDVFJlZEJveCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJOYXRpdmVNb2R1bGVzIikuUmVkQm94OwoKICAgICAgICAgICAgICAgIFJDVFJlZEJveCAmJiBSQ1RSZWRCb3guZGlzbWlzcyAmJiBSQ1RSZWRCb3guZGlzbWlzcygpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgUkNURXhjZXB0aW9uc01hbmFnZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiTmF0aXZlTW9kdWxlcyIpLkV4Y2VwdGlvbnNNYW5hZ2VyOwoKICAgICAgICAgICAgICAgIFJDVEV4Y2VwdGlvbnNNYW5hZ2VyICYmIFJDVEV4Y2VwdGlvbnNNYW5hZ2VyLmRpc21pc3NSZWRib3ggJiYgUkNURXhjZXB0aW9uc01hbmFnZXIuZGlzbWlzc1JlZGJveCgpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgbW9kdWxlcy5mb3JFYWNoKGZ1bmN0aW9uIChfcmVmMiwgaSkgewogICAgICAgICAgICAgICAgdmFyIGlkID0gX3JlZjIuaWQsCiAgICAgICAgICAgICAgICAgICAgY29kZSA9IF9yZWYyLmNvZGU7CiAgICAgICAgICAgICAgICBjb2RlID0gY29kZSArICdcblxuJyArIHNvdXJjZU1hcHBpbmdVUkxzW2ldOwogICAgICAgICAgICAgICAgdmFyIGluamVjdEZ1bmN0aW9uID0gdHlwZW9mIGdsb2JhbC5uYXRpdmVJbmplY3RITVJVcGRhdGUgPT09ICdmdW5jdGlvbicgPyBnbG9iYWwubmF0aXZlSW5qZWN0SE1SVXBkYXRlIDogZXZhbDsKICAgICAgICAgICAgICAgIGluamVjdEZ1bmN0aW9uKGNvZGUsIHNvdXJjZVVSTHNbaV0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIEhNUkxvYWRpbmdWaWV3LmhpZGUoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgIGNhc2UgJ3VwZGF0ZS1kb25lJzoKICAgICAgICAgICAgewogICAgICAgICAgICAgIEhNUkxvYWRpbmdWaWV3LmhpZGUoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgIGNhc2UgJ2Vycm9yJzoKICAgICAgICAgICAgewogICAgICAgICAgICAgIEhNUkxvYWRpbmdWaWV3LmhpZGUoKTsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZGF0YS5ib2R5LnR5cGUgKyAnICcgKyBkYXRhLmJvZHkuZGVzY3JpcHRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBtZXNzYWdlOiAiICsgZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IEhNUkNsaWVudDsKfSw5NSxbNTIsMTMsNzUsOTYsMTVdLCJITVJDbGllbnQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBUb2FzdEFuZHJvaWQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiVG9hc3RBbmRyb2lkIik7CgogIHZhciBUT0FTVF9TSE9SVF9ERUxBWSA9IDIwMDA7CgogIHZhciBITVJMb2FkaW5nVmlldyA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEhNUkxvYWRpbmdWaWV3KCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgSE1STG9hZGluZ1ZpZXcpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhITVJMb2FkaW5nVmlldywgbnVsbCwgW3sKICAgICAga2V5OiAic2hvd01lc3NhZ2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2hvd01lc3NhZ2UobWVzc2FnZSkgewogICAgICAgIGlmIChITVJMb2FkaW5nVmlldy5fc2hvd2luZykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgVG9hc3RBbmRyb2lkLnNob3cobWVzc2FnZSwgVG9hc3RBbmRyb2lkLlNIT1JUKTsKICAgICAgICBITVJMb2FkaW5nVmlldy5fc2hvd2luZyA9IHRydWU7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBITVJMb2FkaW5nVmlldy5fc2hvd2luZyA9IGZhbHNlOwogICAgICAgIH0sIFRPQVNUX1NIT1JUX0RFTEFZKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJoaWRlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGhpZGUoKSB7fQogICAgfV0pOwogICAgcmV0dXJuIEhNUkxvYWRpbmdWaWV3OwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBITVJMb2FkaW5nVmlldzsKfSw5NixbOTddLCJITVJMb2FkaW5nVmlldyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFJDVFRvYXN0QW5kcm9pZCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIikuVG9hc3RBbmRyb2lkOwoKICB2YXIgVG9hc3RBbmRyb2lkID0gewogICAgU0hPUlQ6IFJDVFRvYXN0QW5kcm9pZC5TSE9SVCwKICAgIExPTkc6IFJDVFRvYXN0QW5kcm9pZC5MT05HLAogICAgVE9QOiBSQ1RUb2FzdEFuZHJvaWQuVE9QLAogICAgQk9UVE9NOiBSQ1RUb2FzdEFuZHJvaWQuQk9UVE9NLAogICAgQ0VOVEVSOiBSQ1RUb2FzdEFuZHJvaWQuQ0VOVEVSLAogICAgc2hvdzogZnVuY3Rpb24gc2hvdyhtZXNzYWdlLCBkdXJhdGlvbikgewogICAgICBSQ1RUb2FzdEFuZHJvaWQuc2hvdyhtZXNzYWdlLCBkdXJhdGlvbik7CiAgICB9LAogICAgc2hvd1dpdGhHcmF2aXR5OiBmdW5jdGlvbiBzaG93V2l0aEdyYXZpdHkobWVzc2FnZSwgZHVyYXRpb24sIGdyYXZpdHkpIHsKICAgICAgUkNUVG9hc3RBbmRyb2lkLnNob3dXaXRoR3Jhdml0eShtZXNzYWdlLCBkdXJhdGlvbiwgZ3Jhdml0eSk7CiAgICB9LAogICAgc2hvd1dpdGhHcmF2aXR5QW5kT2Zmc2V0OiBmdW5jdGlvbiBzaG93V2l0aEdyYXZpdHlBbmRPZmZzZXQobWVzc2FnZSwgZHVyYXRpb24sIGdyYXZpdHksIHhPZmZzZXQsIHlPZmZzZXQpIHsKICAgICAgUkNUVG9hc3RBbmRyb2lkLnNob3dXaXRoR3Jhdml0eUFuZE9mZnNldChtZXNzYWdlLCBkdXJhdGlvbiwgZ3Jhdml0eSwgeE9mZnNldCwgeU9mZnNldCk7CiAgICB9CiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IFRvYXN0QW5kcm9pZDsKfSw5NyxbMTVdLCJUb2FzdEFuZHJvaWQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciByZWdpc3RlciA9IGZ1bmN0aW9uIHJlZ2lzdGVyKCkge307CgogIGlmIChfX0RFVl9fKSB7CiAgICB2YXIgQXBwU3RhdGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQXBwU3RhdGUiKTsKCiAgICB2YXIgV2ViU29ja2V0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIldlYlNvY2tldCIpOwoKICAgIHZhciBfcmVxdWlyZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJOYXRpdmVNb2R1bGVzIiksCiAgICAgICAgUGxhdGZvcm1Db25zdGFudHMgPSBfcmVxdWlyZS5QbGF0Zm9ybUNvbnN0YW50czsKCiAgICB2YXIgcmVhY3REZXZUb29scyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJyZWFjdC1kZXZ0b29scy1jb3JlIik7CgogICAgaWYgKFdlYlNvY2tldC5pc0F2YWlsYWJsZSkgewogICAgICB2YXIgX2lzQXBwQWN0aXZlID0gZnVuY3Rpb24gX2lzQXBwQWN0aXZlKCkgewogICAgICAgIHJldHVybiBBcHBTdGF0ZS5jdXJyZW50U3RhdGUgIT09ICdiYWNrZ3JvdW5kJzsKICAgICAgfTsKCiAgICAgIHZhciBfaG9zdCA9IFBsYXRmb3JtQ29uc3RhbnRzICYmIFBsYXRmb3JtQ29uc3RhbnRzLlNlcnZlckhvc3QgPyBQbGF0Zm9ybUNvbnN0YW50cy5TZXJ2ZXJIb3N0LnNwbGl0KCc6JylbMF0gOiAnbG9jYWxob3N0JzsKCiAgICAgIHJlYWN0RGV2VG9vbHMuY29ubmVjdFRvRGV2VG9vbHMoewogICAgICAgIGlzQXBwQWN0aXZlOiBfaXNBcHBBY3RpdmUsCiAgICAgICAgaG9zdDogX2hvc3QsCiAgICAgICAgcG9ydDogd2luZG93Ll9fUkVBQ1RfREVWVE9PTFNfUE9SVF9fLAogICAgICAgIHJlc29sdmVSTlN0eWxlOiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiZmxhdHRlblN0eWxlIikKICAgICAgfSk7CiAgICB9CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIHJlZ2lzdGVyOiByZWdpc3RlcgogIH07Cn0sOTgsWzk5LDc1LDE1LDEwMCwxMDFdLCJzZXR1cERldnRvb2xzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgTWlzc2luZ05hdGl2ZUV2ZW50RW1pdHRlclNoaW0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTWlzc2luZ05hdGl2ZUV2ZW50RW1pdHRlclNoaW0iKTsKCiAgdmFyIE5hdGl2ZUV2ZW50RW1pdHRlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJOYXRpdmVFdmVudEVtaXR0ZXIiKTsKCiAgdmFyIE5hdGl2ZU1vZHVsZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiTmF0aXZlTW9kdWxlcyIpOwoKICB2YXIgUkNUQXBwU3RhdGUgPSBOYXRpdmVNb2R1bGVzLkFwcFN0YXRlOwoKICB2YXIgbG9nRXJyb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAibG9nRXJyb3IiKTsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIEFwcFN0YXRlID0gZnVuY3Rpb24gKF9OYXRpdmVFdmVudEVtaXR0ZXIpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhBcHBTdGF0ZSwgX05hdGl2ZUV2ZW50RW1pdHRlcik7CgogICAgZnVuY3Rpb24gQXBwU3RhdGUoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBBcHBTdGF0ZSk7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoQXBwU3RhdGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBcHBTdGF0ZSkpLmNhbGwodGhpcywgUkNUQXBwU3RhdGUpKTsKCiAgICAgIF90aGlzLmlzQXZhaWxhYmxlID0gdHJ1ZTsKICAgICAgX3RoaXMuaXNBdmFpbGFibGUgPSB0cnVlOwogICAgICBfdGhpcy5fZXZlbnRIYW5kbGVycyA9IHsKICAgICAgICBjaGFuZ2U6IG5ldyBNYXAoKSwKICAgICAgICBtZW1vcnlXYXJuaW5nOiBuZXcgTWFwKCkKICAgICAgfTsKICAgICAgX3RoaXMuY3VycmVudFN0YXRlID0gUkNUQXBwU3RhdGUuaW5pdGlhbEFwcFN0YXRlIHx8ICdhY3RpdmUnOwogICAgICB2YXIgZXZlbnRVcGRhdGVkID0gZmFsc2U7CgogICAgICBfdGhpcy5hZGRMaXN0ZW5lcignYXBwU3RhdGVEaWRDaGFuZ2UnLCBmdW5jdGlvbiAoYXBwU3RhdGVEYXRhKSB7CiAgICAgICAgZXZlbnRVcGRhdGVkID0gdHJ1ZTsKICAgICAgICBfdGhpcy5jdXJyZW50U3RhdGUgPSBhcHBTdGF0ZURhdGEuYXBwX3N0YXRlOwogICAgICB9KTsKCiAgICAgIFJDVEFwcFN0YXRlLmdldEN1cnJlbnRBcHBTdGF0ZShmdW5jdGlvbiAoYXBwU3RhdGVEYXRhKSB7CiAgICAgICAgaWYgKCFldmVudFVwZGF0ZWQpIHsKICAgICAgICAgIF90aGlzLmN1cnJlbnRTdGF0ZSA9IGFwcFN0YXRlRGF0YS5hcHBfc3RhdGU7CiAgICAgICAgfQogICAgICB9LCBsb2dFcnJvcik7CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQXBwU3RhdGUsIFt7CiAgICAgIGtleTogImFkZEV2ZW50TGlzdGVuZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBoYW5kbGVyKSB7CiAgICAgICAgaW52YXJpYW50KFsnY2hhbmdlJywgJ21lbW9yeVdhcm5pbmcnXS5pbmRleE9mKHR5cGUpICE9PSAtMSwgJ1RyeWluZyB0byBzdWJzY3JpYmUgdG8gdW5rbm93biBldmVudDogIiVzIicsIHR5cGUpOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ2NoYW5nZScpIHsKICAgICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlcnNbdHlwZV0uc2V0KGhhbmRsZXIsIHRoaXMuYWRkTGlzdGVuZXIoJ2FwcFN0YXRlRGlkQ2hhbmdlJywgZnVuY3Rpb24gKGFwcFN0YXRlRGF0YSkgewogICAgICAgICAgICBoYW5kbGVyKGFwcFN0YXRlRGF0YS5hcHBfc3RhdGUpOwogICAgICAgICAgfSkpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ21lbW9yeVdhcm5pbmcnKSB7CiAgICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXJzW3R5cGVdLnNldChoYW5kbGVyLCB0aGlzLmFkZExpc3RlbmVyKCdtZW1vcnlXYXJuaW5nJywgaGFuZGxlcikpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW1vdmVFdmVudExpc3RlbmVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgaGFuZGxlcikgewogICAgICAgIGludmFyaWFudChbJ2NoYW5nZScsICdtZW1vcnlXYXJuaW5nJ10uaW5kZXhPZih0eXBlKSAhPT0gLTEsICdUcnlpbmcgdG8gcmVtb3ZlIGxpc3RlbmVyIGZvciB1bmtub3duIGV2ZW50OiAiJXMiJywgdHlwZSk7CgogICAgICAgIGlmICghdGhpcy5fZXZlbnRIYW5kbGVyc1t0eXBlXS5oYXMoaGFuZGxlcikpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlcnNbdHlwZV0uZ2V0KGhhbmRsZXIpLnJlbW92ZSgpOwoKICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXJzW3R5cGVdLmRlbGV0ZShoYW5kbGVyKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEFwcFN0YXRlOwogIH0oTmF0aXZlRXZlbnRFbWl0dGVyKTsKCiAgaWYgKF9fREVWX18gJiYgIVJDVEFwcFN0YXRlKSB7CiAgICB2YXIgTWlzc2luZ05hdGl2ZUFwcFN0YXRlU2hpbSA9IGZ1bmN0aW9uIChfTWlzc2luZ05hdGl2ZUV2ZW50RW0pIHsKICAgICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKE1pc3NpbmdOYXRpdmVBcHBTdGF0ZVNoaW0sIF9NaXNzaW5nTmF0aXZlRXZlbnRFbSk7CgogICAgICBmdW5jdGlvbiBNaXNzaW5nTmF0aXZlQXBwU3RhdGVTaGltKCkgewogICAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBNaXNzaW5nTmF0aXZlQXBwU3RhdGVTaGltKTsKICAgICAgICByZXR1cm4gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKE1pc3NpbmdOYXRpdmVBcHBTdGF0ZVNoaW0uX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihNaXNzaW5nTmF0aXZlQXBwU3RhdGVTaGltKSkuY2FsbCh0aGlzLCAnUkNUQXBwU3RhdGUnLCAnQXBwU3RhdGUnKSk7CiAgICAgIH0KCiAgICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhNaXNzaW5nTmF0aXZlQXBwU3RhdGVTaGltLCBbewogICAgICAgIGtleTogImFkZEV2ZW50TGlzdGVuZXIiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKCkgewogICAgICAgICAgdGhpcy50aHJvd01pc3NpbmdOYXRpdmVNb2R1bGUoKTsKICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBrZXk6ICJyZW1vdmVFdmVudExpc3RlbmVyIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlRXZlbnRMaXN0ZW5lcigpIHsKICAgICAgICAgIHRoaXMudGhyb3dNaXNzaW5nTmF0aXZlTW9kdWxlKCk7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAiY3VycmVudFN0YXRlIiwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHRoaXMudGhyb3dNaXNzaW5nTmF0aXZlTW9kdWxlKCk7CiAgICAgICAgfQogICAgICB9XSk7CiAgICAgIHJldHVybiBNaXNzaW5nTmF0aXZlQXBwU3RhdGVTaGltOwogICAgfShNaXNzaW5nTmF0aXZlRXZlbnRFbWl0dGVyU2hpbSk7CgogICAgQXBwU3RhdGUgPSBuZXcgTWlzc2luZ05hdGl2ZUFwcFN0YXRlU2hpbSgpOwogIH0gZWxzZSB7CiAgICBBcHBTdGF0ZSA9IG5ldyBBcHBTdGF0ZSgpOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBBcHBTdGF0ZTsKfSw5OSxbNjQsNjksMTUsODcsMTNdLCJBcHBTdGF0ZSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICAgIWZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgICAgICAgIm9iamVjdCIgPT0gdHlwZW9mIGV4cG9ydHMgJiYgIm9iamVjdCIgPT0gdHlwZW9mIG1vZHVsZSA/IG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpIDogImZ1bmN0aW9uIiA9PSB0eXBlb2YgZGVmaW5lICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoW10sIGZhY3RvcnkpIDogIm9iamVjdCIgPT0gdHlwZW9mIGV4cG9ydHMgPyBleHBvcnRzLlJlYWN0RGV2VG9vbHNCYWNrZW5kID0gZmFjdG9yeSgpIDogcm9vdC5SZWFjdERldlRvb2xzQmFja2VuZCA9IGZhY3RvcnkoKTsKICAgIH0odGhpcywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAobW9kdWxlcykgewogICAgICAgICAgICBmdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0pIHJldHVybiBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXS5leHBvcnRzOwogICAgICAgICAgICAgICAgdmFyIG1vZHVsZSA9IGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdID0gewogICAgICAgICAgICAgICAgICAgIGV4cG9ydHM6IHt9LAogICAgICAgICAgICAgICAgICAgIGlkOiBtb2R1bGVJZCwKICAgICAgICAgICAgICAgICAgICBsb2FkZWQ6ICExCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZXNbbW9kdWxlSWRdLmNhbGwobW9kdWxlLmV4cG9ydHMsIG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pLCBtb2R1bGUubG9hZGVkID0gITAsIG1vZHVsZS5leHBvcnRzOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaW5zdGFsbGVkTW9kdWxlcyA9IHt9OwogICAgICAgICAgICByZXR1cm4gX193ZWJwYWNrX3JlcXVpcmVfXy5tID0gbW9kdWxlcywgX193ZWJwYWNrX3JlcXVpcmVfXy5jID0gaW5zdGFsbGVkTW9kdWxlcywgX193ZWJwYWNrX3JlcXVpcmVfXy5wID0gIiIsIF9fd2VicGFja19yZXF1aXJlX18oMCk7CiAgICAgICAgfShbZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBmdW5jdGlvbiBjb25uZWN0VG9EZXZUb29scyhvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVJldHJ5KCkgewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29ubmVjdFRvRGV2VG9vbHMob3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfSwgMmUzKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVDbG9zZSgpIHsKICAgICAgICAgICAgICAgICAgICBoYXNDbG9zZWQgfHwgKGhhc0Nsb3NlZCA9ICEwLCBzY2hlZHVsZVJldHJ5KCksIGNsb3NlTGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVNZXNzYWdlKGV2dCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkYXRhOwoKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gSlNPTi5wYXJzZShldnQuZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCBjb25zb2xlLmVycm9yKCJmYWlsZWQgdG8gcGFyc2UganNvbjogIiArIGV2dC5kYXRhKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VMaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBjb25zb2xlLmxvZyhkYXRhKSwgZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBfcmVmID0gb3B0aW9ucyB8fCB7fSwKICAgICAgICAgICAgICAgICAgICBfcmVmJGhvc3QgPSBfcmVmLmhvc3QsCiAgICAgICAgICAgICAgICAgICAgaG9zdCA9IHZvaWQgMCA9PT0gX3JlZiRob3N0ID8gImxvY2FsaG9zdCIgOiBfcmVmJGhvc3QsCiAgICAgICAgICAgICAgICAgICAgX3JlZiRwb3J0ID0gX3JlZi5wb3J0LAogICAgICAgICAgICAgICAgICAgIHBvcnQgPSB2b2lkIDAgPT09IF9yZWYkcG9ydCA/IDgwOTcgOiBfcmVmJHBvcnQsCiAgICAgICAgICAgICAgICAgICAgd2Vic29ja2V0ID0gX3JlZi53ZWJzb2NrZXQsCiAgICAgICAgICAgICAgICAgICAgX3JlZiRyZXNvbHZlUk5TdHlsZSA9IF9yZWYucmVzb2x2ZVJOU3R5bGUsCiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZVJOU3R5bGUgPSB2b2lkIDAgPT09IF9yZWYkcmVzb2x2ZVJOU3R5bGUgPyBudWxsIDogX3JlZiRyZXNvbHZlUk5TdHlsZSwKICAgICAgICAgICAgICAgICAgICBfcmVmJGlzQXBwQWN0aXZlID0gX3JlZi5pc0FwcEFjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBpc0FwcEFjdGl2ZSA9IHZvaWQgMCA9PT0gX3JlZiRpc0FwcEFjdGl2ZSA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gITA7CiAgICAgICAgICAgICAgICB9IDogX3JlZiRpc0FwcEFjdGl2ZTsKCiAgICAgICAgICAgICAgICBpZiAoIWlzQXBwQWN0aXZlKCkpIHJldHVybiB2b2lkIHNjaGVkdWxlUmV0cnkoKTsKICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlTGlzdGVuZXJzID0gW10sCiAgICAgICAgICAgICAgICAgICAgY2xvc2VMaXN0ZW5lcnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICB1cmkgPSAid3M6Ly8iICsgaG9zdCArICI6IiArIHBvcnQsCiAgICAgICAgICAgICAgICAgICAgd3MgPSB3ZWJzb2NrZXQgPyB3ZWJzb2NrZXQgOiBuZXcgd2luZG93LldlYlNvY2tldCh1cmkpOwogICAgICAgICAgICAgICAgd3Mub25jbG9zZSA9IGhhbmRsZUNsb3NlLCB3cy5vbmVycm9yID0gaGFuZGxlQ2xvc2UsIHdzLm9ubWVzc2FnZSA9IGhhbmRsZU1lc3NhZ2UsIHdzLm9ub3BlbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgd2FsbCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuOiBmdW5jdGlvbiBsaXN0ZW4oZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VMaXN0ZW5lcnMucHVzaChmbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xvc2U6IGZ1bmN0aW9uIG9uQ2xvc2UoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlTGlzdGVuZXJzLnB1c2goZm4pOwogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBzZW5kOiBmdW5jdGlvbiBzZW5kKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdzLnNlbmQoSlNPTi5zdHJpbmdpZnkoZGF0YSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBzZXR1cEJhY2tlbmQod2FsbCwgcmVzb2x2ZVJOU3R5bGUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHZhciBoYXNDbG9zZWQgPSAhMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gc2V0dXBCYWNrZW5kKHdhbGwsIHJlc29sdmVSTlN0eWxlKSB7CiAgICAgICAgICAgICAgICB3YWxsLm9uQ2xvc2UoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGFnZW50ICYmIGFnZW50LmVtaXQoInNodXRkb3duIiksIHdpbmRvdy5fX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18uZW1pdCgic2h1dGRvd24iKSwgYnJpZGdlID0gbnVsbCwgYWdlbnQgPSBudWxsLCBjb25zb2xlLmxvZygiY2xvc2luZyBkZXZ0b29scyIpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgYnJpZGdlID0gbmV3IEJyaWRnZSh3YWxsKSwKICAgICAgICAgICAgICAgICAgICBhZ2VudCA9IG5ldyBBZ2VudCh3aW5kb3csIHsKICAgICAgICAgICAgICAgICAgICByblN0eWxlOiAhIXJlc29sdmVSTlN0eWxlLAogICAgICAgICAgICAgICAgICAgIHJuU3R5bGVNZWFzdXJlOiAhIXJlc29sdmVSTlN0eWxlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGFnZW50LmFkZEJyaWRnZShicmlkZ2UpLCByZXNvbHZlUk5TdHlsZSAmJiBzZXR1cFJOU3R5bGUoYnJpZGdlLCBhZ2VudCwgcmVzb2x2ZVJOU3R5bGUpLCBzZXR1cFJlbGF5KGJyaWRnZSwgYWdlbnQsIHdpbmRvdy5fX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18pOwoKICAgICAgICAgICAgICAgIHZhciBfY29ubmVjdFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oInJlYWN0LWRldnRvb2xzIGFnZW50IGdvdCBubyBjb25uZWN0aW9uIik7CiAgICAgICAgICAgICAgICB9LCAyZTQpOwoKICAgICAgICAgICAgICAgIGFnZW50Lm9uY2UoImNvbm5lY3RlZCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBhZ2VudCAmJiAoaW5qZWN0KHdpbmRvdy5fX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18sIGFnZW50KSwgY2xlYXJUaW1lb3V0KF9jb25uZWN0VGltZW91dCkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBBZ2VudCA9IF9fd2VicGFja19yZXF1aXJlX18oMSksCiAgICAgICAgICAgICAgICBCcmlkZ2UgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLAogICAgICAgICAgICAgICAgaW5zdGFsbEdsb2JhbEhvb2sgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMxKSwKICAgICAgICAgICAgICAgIGluc3RhbGxSZWxheUhvb2sgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMyKSwKICAgICAgICAgICAgICAgIGluamVjdCA9IF9fd2VicGFja19yZXF1aXJlX18oMzMpLAogICAgICAgICAgICAgICAgc2V0dXBSTlN0eWxlID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0NSksCiAgICAgICAgICAgICAgICBzZXR1cFJlbGF5ID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0Nyk7CgogICAgICAgICAgICBpbnN0YWxsR2xvYmFsSG9vayh3aW5kb3cpLCBpbnN0YWxsUmVsYXlIb29rKHdpbmRvdyksIHdpbmRvdy5kb2N1bWVudCAmJiB3aW5kb3cuX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLm9uKCJyZWFjdC1kZXZ0b29scyIsIGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgICAgICAgICAgdmFyIHNldHVwSGlnaGxpZ2h0ZXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQ4KTsKCiAgICAgICAgICAgICAgICBzZXR1cEhpZ2hsaWdodGVyKGFnZW50KTsKICAgICAgICAgICAgfSksIG1vZHVsZS5leHBvcnRzID0gewogICAgICAgICAgICAgICAgY29ubmVjdFRvRGV2VG9vbHM6IGNvbm5lY3RUb0RldlRvb2xzCiAgICAgICAgICAgIH07CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHNlbGYsIGNhbGwpIHsKICAgICAgICAgICAgICAgIGlmICghc2VsZikgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJ0aGlzIGhhc24ndCBiZWVuIGluaXRpYWxpc2VkIC0gc3VwZXIoKSBoYXNuJ3QgYmVlbiBjYWxsZWQiKTsKICAgICAgICAgICAgICAgIHJldHVybiAhY2FsbCB8fCAib2JqZWN0IiAhPSB0eXBlb2YgY2FsbCAmJiAiZnVuY3Rpb24iICE9IHR5cGVvZiBjYWxsID8gc2VsZiA6IGNhbGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgewogICAgICAgICAgICAgICAgaWYgKCJmdW5jdGlvbiIgIT0gdHlwZW9mIHN1cGVyQ2xhc3MgJiYgbnVsbCAhPT0gc3VwZXJDbGFzcykgdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAiICsgdHlwZW9mIHN1cGVyQ2xhc3MpOwogICAgICAgICAgICAgICAgc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7CiAgICAgICAgICAgICAgICAgICAgY29uc3RydWN0b3I6IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN1YkNsYXNzLAogICAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiAhMSwKICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGFibGU6ICEwLAogICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6ICEwCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSksIHN1cGVyQ2xhc3MgJiYgKE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIF90eXBlb2YgPSAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgInN5bWJvbCIgPT0gdHlwZW9mICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLml0ZXJhdG9yIDogIkBAaXRlcmF0b3IiKSA/IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqOwogICAgICAgICAgICB9IDogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5wcm90b3R5cGUgOiAiQEBwcm90b3R5cGUiKSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIF9jcmVhdGVDbGFzcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8ICExLCBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9ICEwLCAidmFsdWUiIGluIGRlc2NyaXB0b3IgJiYgKGRlc2NyaXB0b3Iud3JpdGFibGUgPSAhMCksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvdG9Qcm9wcyAmJiBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyksIHN0YXRpY1Byb3BzICYmIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKSwgQ29uc3RydWN0b3I7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KCksCiAgICAgICAgICAgICAgICBfcmVxdWlyZSA9IF9fd2VicGFja19yZXF1aXJlX18oMiksCiAgICAgICAgICAgICAgICBFdmVudEVtaXR0ZXIgPSBfcmVxdWlyZS5FdmVudEVtaXR0ZXIsCiAgICAgICAgICAgICAgICBhc3NpZ24gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpLAogICAgICAgICAgICAgICAgZ3VpZCA9IF9fd2VicGFja19yZXF1aXJlX18oNCksCiAgICAgICAgICAgICAgICBnZXRJbiA9IF9fd2VicGFja19yZXF1aXJlX18oNSksCiAgICAgICAgICAgICAgICBBZ2VudCA9IGZ1bmN0aW9uIChfRXZlbnRFbWl0dGVyKSB7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBBZ2VudChnbG9iYWwsIGNhcGFiaWxpdGllcykgewogICAgICAgICAgICAgICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBBZ2VudCk7CgogICAgICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChBZ2VudC5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEFnZW50KSkuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICAgICAgICAgIF90aGlzLmdsb2JhbCA9IGdsb2JhbCwgX3RoaXMuaW50ZXJuYWxJbnN0YW5jZXNCeUlkID0gbmV3IE1hcCgpLCBfdGhpcy5pZHNCeUludGVybmFsSW5zdGFuY2VzID0gbmV3IFdlYWtNYXAoKSwgX3RoaXMucmVuZGVyZXJzID0gbmV3IE1hcCgpLCBfdGhpcy5lbGVtZW50RGF0YSA9IG5ldyBNYXAoKSwgX3RoaXMucm9vdHMgPSBuZXcgU2V0KCksIF90aGlzLnJlYWN0SW50ZXJuYWxzID0ge307CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RTZWxlY3RlZDsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5vbigic2VsZWN0ZWQiLCBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBfdGhpcy5lbGVtZW50RGF0YS5nZXQoaWQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSAmJiBkYXRhLnB1YmxpY0luc3RhbmNlICYmIF90aGlzLmdsb2JhbC4kciA9PT0gbGFzdFNlbGVjdGVkICYmIChfdGhpcy5nbG9iYWwuJHIgPSBkYXRhLnB1YmxpY0luc3RhbmNlLCBsYXN0U2VsZWN0ZWQgPSBkYXRhLnB1YmxpY0luc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICB9KSwgX3RoaXMuX3ByZXZTZWxlY3RlZCA9IG51bGwsIF90aGlzLl9zY3JvbGxVcGRhdGUgPSAhMTsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNSZWFjdERPTSA9IHdpbmRvdy5kb2N1bWVudCAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuY2FwYWJpbGl0aWVzID0gYXNzaWduKHsKICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsOiBpc1JlYWN0RE9NICYmICJmdW5jdGlvbiIgPT0gdHlwZW9mIHdpbmRvdy5kb2N1bWVudC5ib2R5LnNjcm9sbEludG9WaWV3LAogICAgICAgICAgICAgICAgICAgICAgICBkb206IGlzUmVhY3RET00sCiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRUZXh0Q29udGVudDogITEKICAgICAgICAgICAgICAgICAgICB9LCBjYXBhYmlsaXRpZXMpLCBpc1JlYWN0RE9NICYmIChfdGhpcy5fdXBkYXRlU2Nyb2xsID0gX3RoaXMuX3VwZGF0ZVNjcm9sbC5iaW5kKF90aGlzKSwgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInNjcm9sbCIsIF90aGlzLl9vblNjcm9sbC5iaW5kKF90aGlzKSwgITApLCB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBfdGhpcy5fb25DbGljay5iaW5kKF90aGlzKSwgITApLCB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibW91c2VvdmVyIiwgX3RoaXMuX29uTW91c2VPdmVyLmJpbmQoX3RoaXMpLCAhMCksIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJyZXNpemUiLCBfdGhpcy5fb25SZXNpemUuYmluZChfdGhpcyksICEwKSksIF90aGlzOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfaW5oZXJpdHMoQWdlbnQsIF9FdmVudEVtaXR0ZXIpLCBfY3JlYXRlQ2xhc3MoQWdlbnQsIFt7CiAgICAgICAgICAgICAgICAgICAga2V5OiAic3ViIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZXYsIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMub24oZXYsIGZuKSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMyLnJlbW92ZUxpc3RlbmVyKGV2LCBmbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogInNldFJlYWN0SW50ZXJuYWxzIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUocmVuZGVyZXIsIHJlYWN0SW50ZXJuYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVhY3RJbnRlcm5hbHNbcmVuZGVyZXJdID0gcmVhY3RJbnRlcm5hbHM7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogImFkZEJyaWRnZSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGJyaWRnZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGJyaWRnZS5vbigicmVxdWVzdENhcGFiaWxpdGllcyIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyaWRnZS5zZW5kKCJjYXBhYmlsaXRpZXMiLCBfdGhpczMuY2FwYWJpbGl0aWVzKSwgX3RoaXMzLmVtaXQoImNvbm5lY3RlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSwgYnJpZGdlLm9uKCJzZXRTdGF0ZSIsIHRoaXMuX3NldFN0YXRlLmJpbmQodGhpcykpLCBicmlkZ2Uub24oInNldFByb3BzIiwgdGhpcy5fc2V0UHJvcHMuYmluZCh0aGlzKSksIGJyaWRnZS5vbigic2V0Q29udGV4dCIsIHRoaXMuX3NldENvbnRleHQuYmluZCh0aGlzKSksIGJyaWRnZS5vbigibWFrZUdsb2JhbCIsIHRoaXMuX21ha2VHbG9iYWwuYmluZCh0aGlzKSksIGJyaWRnZS5vbigiaGlnaGxpZ2h0IiwgZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLmhpZ2hsaWdodChpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLCBicmlkZ2Uub24oImhpZ2hsaWdodE1hbnkiLCBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczMuaGlnaGxpZ2h0TWFueShpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLCBicmlkZ2Uub24oImhpZGVIaWdobGlnaHQiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLmVtaXQoImhpZGVIaWdobGlnaHQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSksIGJyaWRnZS5vbigic3RhcnRJbnNwZWN0aW5nIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMy5lbWl0KCJzdGFydEluc3BlY3RpbmciKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSksIGJyaWRnZS5vbigic3RvcEluc3BlY3RpbmciLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLmVtaXQoInN0b3BJbnNwZWN0aW5nIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLCBicmlkZ2Uub24oInNlbGVjdGVkIiwgZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLmVtaXQoInNlbGVjdGVkIiwgaWQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSwgYnJpZGdlLm9uKCJzZXRJbnNwZWN0RW5hYmxlZCIsIGZ1bmN0aW9uIChlbmFibGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpczMuX2luc3BlY3RFbmFibGVkID0gZW5hYmxlZCwgX3RoaXMzLmVtaXQoInN0b3BJbnNwZWN0aW5nIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLCBicmlkZ2Uub24oInNodXRkb3duIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMy5lbWl0KCJzaHV0ZG93biIpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSwgYnJpZGdlLm9uKCJjaGFuZ2VUZXh0Q29udGVudCIsIGZ1bmN0aW9uIChfcmVmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWQgPSBfcmVmLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBfcmVmLnRleHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IF90aGlzMy5nZXROb2RlRm9ySUQoaWQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgJiYgKG5vZGUudGV4dENvbnRlbnQgPSB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSksIGJyaWRnZS5vbigicHV0U2VsZWN0ZWROb2RlIiwgZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLiRub2RlID0gX3RoaXMzLmdldE5vZGVGb3JJRChpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLCBicmlkZ2Uub24oInB1dFNlbGVjdGVkSW5zdGFuY2UiLCBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gX3RoaXMzLmVsZW1lbnREYXRhLmdldChpZCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA/IHdpbmRvdy5fX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18uJHR5cGUgPSBub2RlLnR5cGUgOiB3aW5kb3cuX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLiR0eXBlID0gbnVsbCwgbm9kZSAmJiBub2RlLnB1YmxpY0luc3RhbmNlID8gd2luZG93Ll9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy4kaW5zdCA9IG5vZGUucHVibGljSW5zdGFuY2UgOiB3aW5kb3cuX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLiRpbnN0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfSksIGJyaWRnZS5vbigiY2hlY2tTZWxlY3Rpb24iLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3U2VsZWN0ZWQgPSB3aW5kb3cuX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLiQwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdTZWxlY3RlZCAhPT0gX3RoaXMzLl9wcmV2U2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpczMuX3ByZXZTZWxlY3RlZCA9IG5ld1NlbGVjdGVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzZW50U2VsZWN0ZWQgPSB3aW5kb3cuX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLiRub2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1NlbGVjdGVkICE9PSBzZW50U2VsZWN0ZWQgJiYgX3RoaXMzLnNlbGVjdEZyb21ET01Ob2RlKG5ld1NlbGVjdGVkLCAhMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLCBicmlkZ2Uub24oInNjcm9sbFRvTm9kZSIsIGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMy5zY3JvbGxUb05vZGUoaWQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSwgYnJpZGdlLm9uKCJ0cmFjZXVwZGF0ZXNzdGF0ZWNoYW5nZSIsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMy5lbWl0KCJ0cmFjZXVwZGF0ZXNzdGF0ZWNoYW5nZSIsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSksIGJyaWRnZS5vbigiY29sb3JpemVyY2hhbmdlIiwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLmVtaXQoImNvbG9yaXplcmNoYW5nZSIsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSksIHRoaXMub24oInJvb3QiLCBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBicmlkZ2Uuc2VuZCgicm9vdCIsIGlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSksIHRoaXMub24oIm1vdW50IiwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBicmlkZ2Uuc2VuZCgibW91bnQiLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSksIHRoaXMub24oInVwZGF0ZSIsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYnJpZGdlLnNlbmQoInVwZGF0ZSIsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSwgdGhpcy5vbigidW5tb3VudCIsIGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJpZGdlLnNlbmQoInVubW91bnQiLCBpZCksIGJyaWRnZS5mb3JnZXQoaWQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSwgdGhpcy5vbigic2V0U2VsZWN0aW9uIiwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBicmlkZ2Uuc2VuZCgic2VsZWN0IiwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLCB0aGlzLm9uKCJzZXRJbnNwZWN0RW5hYmxlZCIsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYnJpZGdlLnNlbmQoInNldEluc3BlY3RFbmFibGVkIiwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJzY3JvbGxUb05vZGUiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShpZCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMuZ2V0Tm9kZUZvcklEKGlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFub2RlKSByZXR1cm4gdm9pZCBjb25zb2xlLndhcm4oInVuYWJsZSB0byBnZXQgdGhlIG5vZGUgZm9yIHNjcm9sbGluZyIpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZG9tRWxlbWVudCA9IG5vZGUubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFID8gbm9kZSA6IG5vZGUucGFyZW50RWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvbUVsZW1lbnQgPyAoImZ1bmN0aW9uIiA9PSB0eXBlb2YgZG9tRWxlbWVudC5zY3JvbGxJbnRvVmlld0lmTmVlZGVkID8gZG9tRWxlbWVudC5zY3JvbGxJbnRvVmlld0lmTmVlZGVkKCkgOiAiZnVuY3Rpb24iID09IHR5cGVvZiBkb21FbGVtZW50LnNjcm9sbEludG9WaWV3ICYmIGRvbUVsZW1lbnQuc2Nyb2xsSW50b1ZpZXcoKSwgdm9pZCB0aGlzLmhpZ2hsaWdodChpZCkpIDogdm9pZCBjb25zb2xlLndhcm4oInVuYWJsZSB0byBnZXQgdGhlIGRvbUVsZW1lbnQgZm9yIHNjcm9sbGluZyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJoaWdobGlnaHQiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShpZCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZWxlbWVudERhdGEuZ2V0KGlkKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0aGlzLmdldE5vZGVGb3JJRChpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgJiYgbm9kZSAmJiB0aGlzLmVtaXQoImhpZ2hsaWdodCIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IG5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBkYXRhLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wczogZGF0YS5wcm9wcwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAiaGlnaGxpZ2h0TWFueSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGlkcykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX3RoaXM0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVzID0gW107CgogICAgICAgICAgICAgICAgICAgICAgICBpZHMuZm9yRWFjaChmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gX3RoaXM0LmdldE5vZGVGb3JJRChpZCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSAmJiBub2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSwgbm9kZXMubGVuZ3RoICYmIHRoaXMuZW1pdCgiaGlnaGxpZ2h0TWFueSIsIG5vZGVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAiZ2V0Tm9kZUZvcklEIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudCA9IHRoaXMuaW50ZXJuYWxJbnN0YW5jZXNCeUlkLmdldChpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY29tcG9uZW50KSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVyID0gdGhpcy5yZW5kZXJlcnMuZ2V0KGlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlbmRlcmVyICYmIHRoaXMucmVhY3RJbnRlcm5hbHNbcmVuZGVyZXJdLmdldE5hdGl2ZUZyb21SZWFjdEVsZW1lbnQgPyB0aGlzLnJlYWN0SW50ZXJuYWxzW3JlbmRlcmVyXS5nZXROYXRpdmVGcm9tUmVhY3RFbGVtZW50KGNvbXBvbmVudCkgOiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJzZWxlY3RGcm9tRE9NTm9kZSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKG5vZGUsIHF1aWV0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvZmZzZXRGcm9tTGVhZiA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzJdID8gYXJndW1lbnRzWzJdIDogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkID0gdGhpcy5nZXRJREZvck5vZGUobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkICYmIHRoaXMuZW1pdCgic2V0U2VsZWN0aW9uIiwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVpZXQ6IHF1aWV0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0RnJvbUxlYWY6IG9mZnNldEZyb21MZWFmCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJzZWxlY3RGcm9tUmVhY3RJbnN0YW5jZSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGluc3RhbmNlLCBxdWlldCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWQgPSB0aGlzLmdldElkKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlkID8gdm9pZCB0aGlzLmVtaXQoInNldFNlbGVjdGlvbiIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1aWV0OiBxdWlldAogICAgICAgICAgICAgICAgICAgICAgICB9KSA6IHZvaWQgY29uc29sZS5sb2coIm5vIGluc3RhbmNlIGlkIiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJnZXRJREZvck5vZGUiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5yZWFjdEludGVybmFscykgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnQ7CgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciByZW5kZXJlciBpbiB0aGlzLnJlYWN0SW50ZXJuYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudCA9IHRoaXMucmVhY3RJbnRlcm5hbHNbcmVuZGVyZXJdLmdldFJlYWN0RWxlbWVudEZyb21OYXRpdmUobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7fQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wb25lbnQpIHJldHVybiB0aGlzLmdldElkKGNvbXBvbmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJfc2V0UHJvcHMiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShfcmVmMikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWQgPSBfcmVmMi5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGggPSBfcmVmMi5wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBfcmVmMi52YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLmVsZW1lbnREYXRhLmdldChpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgJiYgZGF0YS51cGRhdGVyICYmIGRhdGEudXBkYXRlci5zZXRJblByb3BzID8gZGF0YS51cGRhdGVyLnNldEluUHJvcHMocGF0aCwgdmFsdWUpIDogY29uc29sZS53YXJuKCJ0cnlpbmcgdG8gc2V0IHByb3BzIG9uIGEgY29tcG9uZW50IHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogIl9zZXRTdGF0ZSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKF9yZWYzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IF9yZWYzLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aCA9IF9yZWYzLnBhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IF9yZWYzLnZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHRoaXMuZWxlbWVudERhdGEuZ2V0KGlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSAmJiBkYXRhLnVwZGF0ZXIgJiYgZGF0YS51cGRhdGVyLnNldEluU3RhdGUgPyBkYXRhLnVwZGF0ZXIuc2V0SW5TdGF0ZShwYXRoLCB2YWx1ZSkgOiBjb25zb2xlLndhcm4oInRyeWluZyB0byBzZXQgc3RhdGUgb24gYSBjb21wb25lbnQgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAiX3NldENvbnRleHQiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShfcmVmNCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWQgPSBfcmVmNC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGggPSBfcmVmNC5wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBfcmVmNC52YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLmVsZW1lbnREYXRhLmdldChpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgJiYgZGF0YS51cGRhdGVyICYmIGRhdGEudXBkYXRlci5zZXRJbkNvbnRleHQgPyBkYXRhLnVwZGF0ZXIuc2V0SW5Db250ZXh0KHBhdGgsIHZhbHVlKSA6IGNvbnNvbGUud2FybigidHJ5aW5nIHRvIHNldCBjb250ZXh0IG9uIGEgY29tcG9uZW50IHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogIl9tYWtlR2xvYmFsIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoX3JlZjUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gX3JlZjUuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoID0gX3JlZjUucGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLmVsZW1lbnREYXRhLmdldChpZCk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAiaW5zdGFuY2UiID09PSBwYXRoID8gZGF0YS5wdWJsaWNJbnN0YW5jZSA6IGdldEluKGRhdGEsIHBhdGgpLCB0aGlzLmdsb2JhbC4kdG1wID0gdmFsdWUsIGNvbnNvbGUubG9nKCIkdG1wID0iLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAiZ2V0SWQiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShpbnRlcm5hbEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAib2JqZWN0IiA9PT0gKCJ1bmRlZmluZWQiID09IHR5cGVvZiBpbnRlcm5hbEluc3RhbmNlID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKGludGVybmFsSW5zdGFuY2UpKSAmJiBpbnRlcm5hbEluc3RhbmNlID8gKHRoaXMuaWRzQnlJbnRlcm5hbEluc3RhbmNlcy5oYXMoaW50ZXJuYWxJbnN0YW5jZSkgfHwgKHRoaXMuaWRzQnlJbnRlcm5hbEluc3RhbmNlcy5zZXQoaW50ZXJuYWxJbnN0YW5jZSwgZ3VpZCgpKSwgdGhpcy5pbnRlcm5hbEluc3RhbmNlc0J5SWQuc2V0KHRoaXMuaWRzQnlJbnRlcm5hbEluc3RhbmNlcy5nZXQoaW50ZXJuYWxJbnN0YW5jZSksIGludGVybmFsSW5zdGFuY2UpKSwgdGhpcy5pZHNCeUludGVybmFsSW5zdGFuY2VzLmdldChpbnRlcm5hbEluc3RhbmNlKSkgOiBpbnRlcm5hbEluc3RhbmNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJhZGRSb290IiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUocmVuZGVyZXIsIGludGVybmFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gdGhpcy5nZXRJZChpbnRlcm5hbEluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb290cy5hZGQoaWQpLCB0aGlzLmVtaXQoInJvb3QiLCBpZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogIm9uTW91bnRlZCIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKHJlbmRlcmVyLCBjb21wb25lbnQsIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF90aGlzNSA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZCA9IHRoaXMuZ2V0SWQoY29tcG9uZW50KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXJzLnNldChpZCwgcmVuZGVyZXIpLCB0aGlzLmVsZW1lbnREYXRhLnNldChpZCwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzZW5kID0gYXNzaWduKHt9LCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2VuZC5jaGlsZHJlbiAmJiBzZW5kLmNoaWxkcmVuLm1hcCAmJiAoc2VuZC5jaGlsZHJlbiA9IHNlbmQuY2hpbGRyZW4ubWFwKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXM1LmdldElkKGMpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSksIHNlbmQuaWQgPSBpZCwgc2VuZC5jYW5VcGRhdGUgPSBzZW5kLnVwZGF0ZXIgJiYgISFzZW5kLnVwZGF0ZXIuZm9yY2VVcGRhdGUsIGRlbGV0ZSBzZW5kLnR5cGUsIGRlbGV0ZSBzZW5kLnVwZGF0ZXIsIHRoaXMuZW1pdCgibW91bnQiLCBzZW5kKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAib25VcGRhdGVkIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoY29tcG9uZW50LCBkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfdGhpczYgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQgPSB0aGlzLmdldElkKGNvbXBvbmVudCk7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnREYXRhLnNldChpZCwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzZW5kID0gYXNzaWduKHt9LCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2VuZC5jaGlsZHJlbiAmJiBzZW5kLmNoaWxkcmVuLm1hcCAmJiAoc2VuZC5jaGlsZHJlbiA9IHNlbmQuY2hpbGRyZW4ubWFwKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXM2LmdldElkKGMpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSksIHNlbmQuaWQgPSBpZCwgc2VuZC5jYW5VcGRhdGUgPSBzZW5kLnVwZGF0ZXIgJiYgISFzZW5kLnVwZGF0ZXIuZm9yY2VVcGRhdGUsIGRlbGV0ZSBzZW5kLnR5cGUsIGRlbGV0ZSBzZW5kLnVwZGF0ZXIsIHRoaXMuZW1pdCgidXBkYXRlIiwgc2VuZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogIm9uVW5tb3VudGVkIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoY29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IHRoaXMuZ2V0SWQoY29tcG9uZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50RGF0YVsiZGVsZXRlIl0oaWQpLCB0aGlzLnJvb3RzWyJkZWxldGUiXShpZCksIHRoaXMucmVuZGVyZXJzWyJkZWxldGUiXShpZCksIHRoaXMuZW1pdCgidW5tb3VudCIsIGlkKSwgdGhpcy5pZHNCeUludGVybmFsSW5zdGFuY2VzWyJkZWxldGUiXShjb21wb25lbnQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJfb25TY3JvbGwiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2Nyb2xsVXBkYXRlIHx8ICh0aGlzLl9zY3JvbGxVcGRhdGUgPSAhMCwgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLl91cGRhdGVTY3JvbGwpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAiX3VwZGF0ZVNjcm9sbCIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoInJlZnJlc2hNdWx0aU92ZXJsYXkiKSwgdGhpcy5lbWl0KCJzdG9wSW5zcGVjdGluZyIpLCB0aGlzLl9zY3JvbGxVcGRhdGUgPSAhMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAiX29uQ2xpY2siLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5faW5zcGVjdEVuYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IHRoaXMuZ2V0SURGb3JOb2RlKGV2ZW50LnRhcmdldCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZCAmJiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCksIGV2ZW50LnByZXZlbnREZWZhdWx0KCksIHRoaXMuZW1pdCgic2V0U2VsZWN0aW9uIiwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksIHRoaXMuZW1pdCgic2V0SW5zcGVjdEVuYWJsZWQiLCAhMSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogIl9vbk1vdXNlT3ZlciIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pbnNwZWN0RW5hYmxlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gdGhpcy5nZXRJREZvck5vZGUoZXZlbnQudGFyZ2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaWQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0KGlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJfb25SZXNpemUiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoInN0b3BJbnNwZWN0aW5nIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfV0pLCBBZ2VudDsKICAgICAgICAgICAgfShFdmVudEVtaXR0ZXIpOwoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBBZ2VudDsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2V2ZW50cyA9IHRoaXMuX2V2ZW50cyB8fCB7fSwgdGhpcy5fbWF4TGlzdGVuZXJzID0gdGhpcy5fbWF4TGlzdGVuZXJzIHx8IHZvaWQgMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiZnVuY3Rpb24iID09IHR5cGVvZiBhcmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGlzTnVtYmVyKGFyZykgewogICAgICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiID09IHR5cGVvZiBhcmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogICAgICAgICAgICAgICAgcmV0dXJuICJvYmplY3QiID09IHR5cGVvZiBhcmcgJiYgbnVsbCAhPT0gYXJnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIDAgPT09IGFyZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXIsIEV2ZW50RW1pdHRlci5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXIsIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuX2V2ZW50cyA9IHZvaWQgMCwgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fbWF4TGlzdGVuZXJzID0gdm9pZCAwLCBFdmVudEVtaXR0ZXIuZGVmYXVsdE1heExpc3RlbmVycyA9IDEwLCBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnNldE1heExpc3RlbmVycyA9IGZ1bmN0aW9uIChuKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzTnVtYmVyKG4pIHx8IG4gPCAwIHx8IGlzTmFOKG4pKSB0aHJvdyBUeXBlRXJyb3IoIm4gbXVzdCBiZSBhIHBvc2l0aXZlIG51bWJlciIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21heExpc3RlbmVycyA9IG4sIHRoaXM7CiAgICAgICAgICAgIH0sIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgZXIsIGhhbmRsZXIsIGxlbiwgYXJncywgaSwgbGlzdGVuZXJzOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9ldmVudHMgfHwgKHRoaXMuX2V2ZW50cyA9IHt9KSwgImVycm9yIiA9PT0gdHlwZSAmJiAoIXRoaXMuX2V2ZW50cy5lcnJvciB8fCBpc09iamVjdCh0aGlzLl9ldmVudHMuZXJyb3IpICYmICF0aGlzLl9ldmVudHMuZXJyb3IubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChlciA9IGFyZ3VtZW50c1sxXSwgZXIgaW5zdGFuY2VvZiBFcnJvcikgdGhyb3cgZXI7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IG5ldyBFcnJvcignVW5jYXVnaHQsIHVuc3BlY2lmaWVkICJlcnJvciIgZXZlbnQuICgnICsgZXIgKyAiKSIpOwogICAgICAgICAgICAgICAgICAgIHRocm93IGVyci5jb250ZXh0ID0gZXIsIGVycjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoaGFuZGxlciA9IHRoaXMuX2V2ZW50c1t0eXBlXSwgaXNVbmRlZmluZWQoaGFuZGxlcikpIHJldHVybiAhMTsKICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGhhbmRsZXIpKSBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgaGFuZGxlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3QoaGFuZGxlcikpIGZvciAoYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGxpc3RlbmVycyA9IGhhbmRsZXIuc2xpY2UoKSwgbGVuID0gbGlzdGVuZXJzLmxlbmd0aCwgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyc1tpXS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAhMDsKICAgICAgICAgICAgfSwgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IGZ1bmN0aW9uICh0eXBlLCBsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgdmFyIG07CiAgICAgICAgICAgICAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKSB0aHJvdyBUeXBlRXJyb3IoImxpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pLCB0aGlzLl9ldmVudHMubmV3TGlzdGVuZXIgJiYgdGhpcy5lbWl0KCJuZXdMaXN0ZW5lciIsIHR5cGUsIGlzRnVuY3Rpb24obGlzdGVuZXIubGlzdGVuZXIpID8gbGlzdGVuZXIubGlzdGVuZXIgOiBsaXN0ZW5lciksIHRoaXMuX2V2ZW50c1t0eXBlXSA/IGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkgPyB0aGlzLl9ldmVudHNbdHlwZV0ucHVzaChsaXN0ZW5lcikgOiB0aGlzLl9ldmVudHNbdHlwZV0gPSBbdGhpcy5fZXZlbnRzW3R5cGVdLCBsaXN0ZW5lcl0gOiB0aGlzLl9ldmVudHNbdHlwZV0gPSBsaXN0ZW5lciwgaXNPYmplY3QodGhpcy5fZXZlbnRzW3R5cGVdKSAmJiAhdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCAmJiAobSA9IGlzVW5kZWZpbmVkKHRoaXMuX21heExpc3RlbmVycykgPyBFdmVudEVtaXR0ZXIuZGVmYXVsdE1heExpc3RlbmVycyA6IHRoaXMuX21heExpc3RlbmVycywgbSAmJiBtID4gMCAmJiB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoID4gbSAmJiAodGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCA9ICEwLCBjb25zb2xlLmVycm9yKCIobm9kZSkgd2FybmluZzogcG9zc2libGUgRXZlbnRFbWl0dGVyIG1lbW9yeSBsZWFrIGRldGVjdGVkLiAlZCBsaXN0ZW5lcnMgYWRkZWQuIFVzZSBlbWl0dGVyLnNldE1heExpc3RlbmVycygpIHRvIGluY3JlYXNlIGxpbWl0LiIsIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGgpLCAiZnVuY3Rpb24iID09IHR5cGVvZiBjb25zb2xlLnRyYWNlICYmIGNvbnNvbGUudHJhY2UoKSkpLCB0aGlzOwogICAgICAgICAgICB9LCBFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lciwgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gKHR5cGUsIGxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnKCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgZyksIGZpcmVkIHx8IChmaXJlZCA9ICEwLCBsaXN0ZW5lci5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKSB0aHJvdyBUeXBlRXJyb3IoImxpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICAgICAgICAgICAgdmFyIGZpcmVkID0gITE7CiAgICAgICAgICAgICAgICByZXR1cm4gZy5saXN0ZW5lciA9IGxpc3RlbmVyLCB0aGlzLm9uKHR5cGUsIGcpLCB0aGlzOwogICAgICAgICAgICB9LCBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24gKHR5cGUsIGxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgbGlzdCwgcG9zaXRpb24sIGxlbmd0aCwgaTsKICAgICAgICAgICAgICAgIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpIHRocm93IFR5cGVFcnJvcigibGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhdGhpcy5fZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIGlmIChsaXN0ID0gdGhpcy5fZXZlbnRzW3R5cGVdLCBsZW5ndGggPSBsaXN0Lmxlbmd0aCwgcG9zaXRpb24gPSAtMSwgbGlzdCA9PT0gbGlzdGVuZXIgfHwgaXNGdW5jdGlvbihsaXN0Lmxpc3RlbmVyKSAmJiBsaXN0Lmxpc3RlbmVyID09PSBsaXN0ZW5lcikgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXSwgdGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyICYmIHRoaXMuZW1pdCgicmVtb3ZlTGlzdGVuZXIiLCB0eXBlLCBsaXN0ZW5lcik7ZWxzZSBpZiAoaXNPYmplY3QobGlzdCkpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSBsZW5ndGg7IGktLSA+IDA7KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaXN0W2ldID09PSBsaXN0ZW5lciB8fCBsaXN0W2ldLmxpc3RlbmVyICYmIGxpc3RbaV0ubGlzdGVuZXIgPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHBvc2l0aW9uIDwgMCkgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICAgICAgMSA9PT0gbGlzdC5sZW5ndGggPyAobGlzdC5sZW5ndGggPSAwLCBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdKSA6IGxpc3Quc3BsaWNlKHBvc2l0aW9uLCAxKSwgdGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyICYmIHRoaXMuZW1pdCgicmVtb3ZlTGlzdGVuZXIiLCB0eXBlLCBsaXN0ZW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGtleSwgbGlzdGVuZXJzOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9ldmVudHMpIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpIHJldHVybiAwID09PSBhcmd1bWVudHMubGVuZ3RoID8gdGhpcy5fZXZlbnRzID0ge30gOiB0aGlzLl9ldmVudHNbdHlwZV0gJiYgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXSwgdGhpczsKCiAgICAgICAgICAgICAgICBpZiAoMCA9PT0gYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIHRoaXMuX2V2ZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAicmVtb3ZlTGlzdGVuZXIiICE9PSBrZXkgJiYgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoa2V5KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygicmVtb3ZlTGlzdGVuZXIiKSwgdGhpcy5fZXZlbnRzID0ge30sIHRoaXM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1t0eXBlXSwgaXNGdW5jdGlvbihsaXN0ZW5lcnMpKSB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVycyk7ZWxzZSBpZiAobGlzdGVuZXJzKSBmb3IgKDsgbGlzdGVuZXJzLmxlbmd0aDspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVyc1tsaXN0ZW5lcnMubGVuZ3RoIC0gMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV0sIHRoaXM7CiAgICAgICAgICAgIH0sIEV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgICAgIHZhciByZXQ7CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0ID0gdGhpcy5fZXZlbnRzICYmIHRoaXMuX2V2ZW50c1t0eXBlXSA/IGlzRnVuY3Rpb24odGhpcy5fZXZlbnRzW3R5cGVdKSA/IFt0aGlzLl9ldmVudHNbdHlwZV1dIDogdGhpcy5fZXZlbnRzW3R5cGVdLnNsaWNlKCkgOiBbXTsKICAgICAgICAgICAgfSwgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9ldmVudHMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZsaXN0ZW5lciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihldmxpc3RlbmVyKSkgcmV0dXJuIDE7CiAgICAgICAgICAgICAgICAgICAgaWYgKGV2bGlzdGVuZXIpIHJldHVybiBldmxpc3RlbmVyLmxlbmd0aDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfSwgRXZlbnRFbWl0dGVyLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbiAoZW1pdHRlciwgdHlwZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVtaXR0ZXIubGlzdGVuZXJDb3VudCh0eXBlKTsKICAgICAgICAgICAgfTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHRvT2JqZWN0KHZhbCkgewogICAgICAgICAgICAgICAgaWYgKG51bGwgPT09IHZhbCB8fCB2b2lkIDAgPT09IHZhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcigiT2JqZWN0LmFzc2lnbiBjYW5ub3QgYmUgY2FsbGVkIHdpdGggbnVsbCBvciB1bmRlZmluZWQiKTsKICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3QodmFsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwKICAgICAgICAgICAgICAgIHByb3BJc0VudW1lcmFibGUgPSBPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlOwoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBPYmplY3QuYXNzaWduIHx8IGZ1bmN0aW9uICh0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgZnJvbSwgc3ltYm9scywgdG8gPSB0b09iamVjdCh0YXJnZXQpLCBzID0gMTsgcyA8IGFyZ3VtZW50cy5sZW5ndGg7IHMrKykgewogICAgICAgICAgICAgICAgICAgIGZyb20gPSBPYmplY3QoYXJndW1lbnRzW3NdKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGZyb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGFzT3duUHJvcGVydHkuY2FsbChmcm9tLCBrZXkpICYmICh0b1trZXldID0gZnJvbVtrZXldKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN5bWJvbHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGZyb20pOwoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzeW1ib2xzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wSXNFbnVtZXJhYmxlLmNhbGwoZnJvbSwgc3ltYm9sc1tpXSkgJiYgKHRvW3N5bWJvbHNbaV1dID0gZnJvbVtzeW1ib2xzW2ldXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHRvOwogICAgICAgICAgICB9OwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgZnVuY3Rpb24gZ3VpZCgpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiZyIgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDE2KS5zdWJzdHIoMik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZ3VpZDsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIF90b0NvbnN1bWFibGVBcnJheShhcnIpIHsKICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFycikpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgYXJyMiA9IEFycmF5KGFyci5sZW5ndGgpOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycjJbaV0gPSBhcnJbaV07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyMjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkuZnJvbShhcnIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRJbihiYXNlLCBwYXRoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGF0aC5yZWR1Y2UoZnVuY3Rpb24gKG9iaiwgYXR0cikgewogICAgICAgICAgICAgICAgICAgIGlmIChvYmopIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShhdHRyKSkgcmV0dXJuIG9ialthdHRyXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIG9ialt0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLml0ZXJhdG9yIDogIkBAaXRlcmF0b3IiXSkgcmV0dXJuIFtdLmNvbmNhdChfdG9Db25zdW1hYmxlQXJyYXkob2JqKSlbYXR0cl07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0sIGJhc2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGdldEluOwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgZnVuY3Rpb24gX3RvQ29uc3VtYWJsZUFycmF5KGFycikgewogICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBhcnIyID0gQXJyYXkoYXJyLmxlbmd0aCk7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJyMltpXSA9IGFycltpXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBhcnIyOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBBcnJheS5mcm9tKGFycik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgIGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0V2luZG93RnVuY3Rpb24obmFtZSwgcG9seWZpbGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmcod2luZG93W25hbWVdKS5pbmRleE9mKCJbbmF0aXZlIGNvZGVdIikgPT09IC0xID8gcG9seWZpbGwgOiB3aW5kb3dbbmFtZV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBfZXh0ZW5kcyA9IE9iamVjdC5hc3NpZ24gfHwgZnVuY3Rpb24gKHRhcmdldCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc291cmNlID0gYXJndW1lbnRzW2ldOwoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIGtleSkgJiYgKHRhcmdldFtrZXldID0gc291cmNlW2tleV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgX2NyZWF0ZUNsYXNzID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgITEsIGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gITAsICJ2YWx1ZSIgaW4gZGVzY3JpcHRvciAmJiAoZGVzY3JpcHRvci53cml0YWJsZSA9ICEwKSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm90b1Byb3BzICYmIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKSwgc3RhdGljUHJvcHMgJiYgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpLCBDb25zdHJ1Y3RvcjsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0oKSwKICAgICAgICAgICAgICAgIGNvbnN0cyA9IF9fd2VicGFja19yZXF1aXJlX18oNyksCiAgICAgICAgICAgICAgICBoeWRyYXRlID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNiksCiAgICAgICAgICAgICAgICBkZWh5ZHJhdGUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI3KSwKICAgICAgICAgICAgICAgIGdldEluID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KSwKICAgICAgICAgICAgICAgIHBlcmZvcm1hbmNlTm93ID0gX193ZWJwYWNrX3JlcXVpcmVfXygyOCksCiAgICAgICAgICAgICAgICBsYXN0UnVuVGltZU1TID0gNSwKICAgICAgICAgICAgICAgIGNhbmNlbElkbGVDYWxsYmFjayA9IGdldFdpbmRvd0Z1bmN0aW9uKCJjYW5jZWxJZGxlQ2FsbGJhY2siLCBjbGVhclRpbWVvdXQpLAogICAgICAgICAgICAgICAgcmVxdWVzdElkbGVDYWxsYmFjayA9IGdldFdpbmRvd0Z1bmN0aW9uKCJyZXF1ZXN0SWRsZUNhbGxiYWNrIiwgZnVuY3Rpb24gKGNiLCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVsYXlNUyA9IDNlMyAqIGxhc3RSdW5UaW1lTVM7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVsYXlNUyA+IDUwMCAmJiAoZGVsYXlNUyA9IDUwMCksIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGFydFRpbWUgPSBwZXJmb3JtYW5jZU5vdygpOwogICAgICAgICAgICAgICAgICAgIGNiKHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlkVGltZW91dDogITEsCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVSZW1haW5pbmc6IGZ1bmN0aW9uIHRpbWVSZW1haW5pbmcoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMSAvIDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2YXIgZW5kVGltZSA9IHBlcmZvcm1hbmNlTm93KCk7CiAgICAgICAgICAgICAgICAgICAgbGFzdFJ1blRpbWVNUyA9IChlbmRUaW1lIC0gc3RhcnRUaW1lKSAvIDFlMzsKICAgICAgICAgICAgICAgIH0sIGRlbGF5TVMpOwogICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIEJyaWRnZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEJyaWRnZSh3YWxsKSB7CiAgICAgICAgICAgICAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEJyaWRnZSksIHRoaXMuX2NicyA9IG5ldyBNYXAoKSwgdGhpcy5faW5zcGVjdGFibGVzID0gbmV3IE1hcCgpLCB0aGlzLl9jaWQgPSAwLCB0aGlzLl9saXN0ZW5lcnMgPSB7fSwgdGhpcy5fYnVmZmVyID0gW10sIHRoaXMuX2ZsdXNoSGFuZGxlID0gbnVsbCwgdGhpcy5fY2FsbGVycyA9IHt9LCB0aGlzLl9wYXVzZWQgPSAhMSwgdGhpcy5fd2FsbCA9IHdhbGwsIHdhbGwubGlzdGVuKHRoaXMuX2hhbmRsZU1lc3NhZ2UuYmluZCh0aGlzKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVDbGFzcyhCcmlkZ2UsIFt7CiAgICAgICAgICAgICAgICAgICAga2V5OiAiaW5zcGVjdCIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGlkLCBwYXRoLCBjYikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2NpZCA9IHRoaXMuX2NpZCsrOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2JzLnNldChfY2lkLCBmdW5jdGlvbiAoZGF0YSwgY2xlYW5lZCwgcHJvdG8sIHByb3RvY2xlYW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFuZWQubGVuZ3RoICYmIGh5ZHJhdGUoZGF0YSwgY2xlYW5lZCksIHByb3RvICYmIHByb3RvY2xlYW4ubGVuZ3RoICYmIGh5ZHJhdGUocHJvdG8sIHByb3RvY2xlYW4pLCBwcm90byAmJiAoZGF0YVtjb25zdHMucHJvdG9dID0gcHJvdG8pLCBjYihkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSksIHRoaXMuX3dhbGwuc2VuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiaW5zcGVjdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogX2NpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg6IHBhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogaWQKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogImNhbGwiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShuYW1lLCBhcmdzLCBjYikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2NpZCA9IHRoaXMuX2NpZCsrOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2JzLnNldChfY2lkLCBjYiksIHRoaXMuX3dhbGwuc2VuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiY2FsbCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogX2NpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IGFyZ3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJvbkNhbGwiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShuYW1lLCBoYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9jYWxsZXJzW25hbWVdKSB0aHJvdyBuZXcgRXJyb3IoIm9ubHkgb25lIGNhbGwgaGFuZGxlciBwZXIgY2FsbCBuYW1lIGFsbG93ZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FsbGVyc1tuYW1lXSA9IGhhbmRsZXI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogInBhdXNlIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3dhbGwuc2VuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAicGF1c2UiCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJyZXN1bWUiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2FsbC5zZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJyZXN1bWUiCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJzZXRJbnNwZWN0YWJsZSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGlkLCBkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2ID0gdGhpcy5faW5zcGVjdGFibGVzLmdldChpZCk7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJldiA/IHZvaWQgdGhpcy5faW5zcGVjdGFibGVzLnNldChpZCwgX2V4dGVuZHMoe30sIHByZXYsIGRhdGEpKSA6IHZvaWQgdGhpcy5faW5zcGVjdGFibGVzLnNldChpZCwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogInNlbmQiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShldnQsIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnVmZmVyLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZ0OiBldnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgICAgICAgICAgIH0pLCB0aGlzLnNjaGVkdWxlRmx1c2goKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAic2NoZWR1bGVGbHVzaCIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2ZsdXNoSGFuZGxlICYmIHRoaXMuX2J1ZmZlci5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aW1lb3V0ID0gdGhpcy5fcGF1c2VkID8gNWUzIDogNTAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZmx1c2hIYW5kbGUgPSByZXF1ZXN0SWRsZUNhbGxiYWNrKHRoaXMuZmx1c2hCdWZmZXJXaGlsZUlkbGUuYmluZCh0aGlzKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQ6IHRpbWVvdXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogImNhbmNlbEZsdXNoIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2ZsdXNoSGFuZGxlICYmIChjYW5jZWxJZGxlQ2FsbGJhY2sodGhpcy5fZmx1c2hIYW5kbGUpLCB0aGlzLl9mbHVzaEhhbmRsZSA9IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJmbHVzaEJ1ZmZlcldoaWxlSWRsZSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGRlYWRsaW5lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2ZsdXNoSGFuZGxlID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGNodW5rQ291bnQgPSB0aGlzLl9wYXVzZWQgPyAyMCA6IDEwLCBjaHVua1NpemUgPSBNYXRoLnJvdW5kKHRoaXMuX2J1ZmZlci5sZW5ndGggLyBjaHVua0NvdW50KSwgbWluQ2h1bmtTaXplID0gdGhpcy5fcGF1c2VkID8gNTAgOiAxMDA7IHRoaXMuX2J1ZmZlci5sZW5ndGggJiYgKGRlYWRsaW5lLnRpbWVSZW1haW5pbmcoKSA+IDAgfHwgZGVhZGxpbmUuZGlkVGltZW91dCk7KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFrZSA9IE1hdGgubWluKHRoaXMuX2J1ZmZlci5sZW5ndGgsIE1hdGgubWF4KG1pbkNodW5rU2l6ZSwgY2h1bmtTaXplKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEJ1ZmZlciA9IHRoaXMuX2J1ZmZlci5zcGxpY2UoMCwgdGFrZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mbHVzaEJ1ZmZlclNsaWNlKGN1cnJlbnRCdWZmZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWZmZXIubGVuZ3RoICYmIHRoaXMuc2NoZWR1bGVGbHVzaCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJmbHVzaEJ1ZmZlclNsaWNlIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoYnVmZmVyU2xpY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50cyA9IGJ1ZmZlclNsaWNlLm1hcChmdW5jdGlvbiAoX3JlZikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2dCA9IF9yZWYuZXZ0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBfcmVmLmRhdGEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYW5lZCA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhbiA9IGRlaHlkcmF0ZShkYXRhLCBjbGVhbmVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjbGVhbmVkLmxlbmd0aCAmJiBfdGhpcy5zZXRJbnNwZWN0YWJsZShkYXRhLmlkLCBkYXRhKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJldmVudCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZ0OiBldnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogc2FuLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFuZWQ6IGNsZWFuZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2FsbC5zZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJtYW55LWV2ZW50cyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHM6IGV2ZW50cwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAiZm9yZ2V0IiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5zcGVjdGFibGVzWyJkZWxldGUiXShpZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogIm9uIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZXZ0LCBmbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9saXN0ZW5lcnNbZXZ0XSA/IHRoaXMuX2xpc3RlbmVyc1tldnRdLnB1c2goZm4pIDogdGhpcy5fbGlzdGVuZXJzW2V2dF0gPSBbZm5dOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJvZmYiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShldnQsIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9saXN0ZW5lcnNbZXZ0XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl4ID0gdGhpcy5fbGlzdGVuZXJzW2V2dF0uaW5kZXhPZihmbik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXggIT09IC0xICYmIHRoaXMuX2xpc3RlbmVyc1tldnRdLnNwbGljZShpeCwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAib25jZSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGV2dCwgZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIgPSBmdW5jdGlvbiBsaXN0ZW5lcigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyksIHNlbGYub2ZmKGV2dCwgbGlzdGVuZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbihldnQsIGxpc3RlbmVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAiX2hhbmRsZU1lc3NhZ2UiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShwYXlsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCJyZXN1bWUiID09PSBwYXlsb2FkLnR5cGUpIHJldHVybiB0aGlzLl9wYXVzZWQgPSAhMSwgdm9pZCB0aGlzLnNjaGVkdWxlRmx1c2goKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCJwYXVzZSIgPT09IHBheWxvYWQudHlwZSkgcmV0dXJuIHRoaXMuX3BhdXNlZCA9ICEwLCB2b2lkIHRoaXMuY2FuY2VsRmx1c2goKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgiY2FsbGJhY2siID09PSBwYXlsb2FkLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHRoaXMuX2Nicy5nZXQocGF5bG9hZC5pZCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgKGNhbGxiYWNrICYmIChjYWxsYmFjay5hcHBseSh2b2lkIDAsIF90b0NvbnN1bWFibGVBcnJheShwYXlsb2FkLmFyZ3MpKSwgdGhpcy5fY2JzWyJkZWxldGUiXShwYXlsb2FkLmlkKSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoImNhbGwiID09PSBwYXlsb2FkLnR5cGUpIHJldHVybiB2b2lkIHRoaXMuX2hhbmRsZUNhbGwocGF5bG9hZC5uYW1lLCBwYXlsb2FkLmFyZ3MsIHBheWxvYWQuY2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoImluc3BlY3QiID09PSBwYXlsb2FkLnR5cGUpIHJldHVybiB2b2lkIHRoaXMuX2luc3BlY3RSZXNwb25zZShwYXlsb2FkLmlkLCBwYXlsb2FkLnBhdGgsIHBheWxvYWQuY2FsbGJhY2spOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCJldmVudCIgPT09IHBheWxvYWQudHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF5bG9hZC5jbGVhbmVkICYmIGh5ZHJhdGUocGF5bG9hZC5kYXRhLCBwYXlsb2FkLmNsZWFuZWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZucyA9IHRoaXMuX2xpc3RlbmVyc1twYXlsb2FkLmV2dF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHBheWxvYWQuZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZucyAmJiBmbnMuZm9yRWFjaChmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgIm1hbnktZXZlbnRzIiA9PT0gcGF5bG9hZC50eXBlICYmIHBheWxvYWQuZXZlbnRzLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5jbGVhbmVkICYmIGh5ZHJhdGUoZXZlbnQuZGF0YSwgZXZlbnQuY2xlYW5lZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlcnMgPSBfdGhpczIuX2xpc3RlbmVyc1tldmVudC5ldnRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMgJiYgaGFuZGxlcnMuZm9yRWFjaChmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oZXZlbnQuZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogIl9oYW5kbGVDYWxsIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUobmFtZSwgYXJncywgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9jYWxsZXJzW25hbWVdKSByZXR1cm4gdm9pZCBjb25zb2xlLndhcm4oJ3Vua25vd24gY2FsbDogIicgKyBuYW1lICsgJyInKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IEFycmF5LmlzQXJyYXkoYXJncykgPyBhcmdzIDogW2FyZ3NdOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0OwoKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMuX2NhbGxlcnNbbmFtZV0uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBjYWxsIiwgZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3dhbGwuc2VuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiY2FsbGJhY2siLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogW3Jlc3VsdF0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogIl9pbnNwZWN0UmVzcG9uc2UiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShpZCwgcGF0aCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluc3BlY3RhYmxlID0gdGhpcy5faW5zcGVjdGFibGVzLmdldChpZCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFuZWQgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvY2xlYW4gPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnNwZWN0YWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IGdldEluKGluc3BlY3RhYmxlLCBwYXRoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm90b2QgPSAhMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0ZuID0gImZ1bmN0aW9uIiA9PSB0eXBlb2YgdmFsOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWwgJiYgImZ1bmN0aW9uIiA9PSB0eXBlb2YgdmFsW3R5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciJdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZXJWYWwgPSBPYmplY3QuY3JlYXRlKHt9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQgPSAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uID0gITAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9kaWRJdGVyYXRvckVycm9yID0gITEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9pdGVyYXRvckVycm9yID0gdm9pZCAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBfc3RlcCwgX2l0ZXJhdG9yID0gdmFsW3R5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciJdKCk7ICEoX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbiA9IChfc3RlcCA9IF9pdGVyYXRvci5uZXh0KCkpLmRvbmUpOyBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uID0gITApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbnRyeSA9IF9zdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvdW50ID4gMTAwKSBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJWYWxbY291bnRdID0gZW50cnksIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2RpZEl0ZXJhdG9yRXJyb3IgPSAhMCwgX2l0ZXJhdG9yRXJyb3IgPSBlcnI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICFfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uICYmIF9pdGVyYXRvclsicmV0dXJuIl0gJiYgX2l0ZXJhdG9yWyJyZXR1cm4iXSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9kaWRJdGVyYXRvckVycm9yKSB0aHJvdyBfaXRlcmF0b3JFcnJvcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gaXRlclZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModmFsKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIl9fcHJvdG9fXyIgPT09IG5hbWUgJiYgKHByb3RvZCA9ICEwKSwgKCFpc0ZuIHx8ICJhcmd1bWVudHMiICE9PSBuYW1lICYmICJjYWxsZWUiICE9PSBuYW1lICYmICJjYWxsZXIiICE9PSBuYW1lKSAmJiAocmVzdWx0W25hbWVdID0gZGVoeWRyYXRlKHZhbFtuYW1lXSwgY2xlYW5lZCwgW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSwgIXByb3RvZCAmJiB2YWwuX19wcm90b19fICYmICJPYmplY3QiICE9PSB2YWwuY29uc3RydWN0b3IubmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdQcm90byA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwSXNGbiA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIHZhbC5fX3Byb3RvX187CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModmFsLl9fcHJvdG9fXykuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoIXBJc0ZuIHx8ICJhcmd1bWVudHMiICE9PSBuYW1lICYmICJjYWxsZWUiICE9PSBuYW1lICYmICJjYWxsZXIiICE9PSBuYW1lKSAmJiAobmV3UHJvdG9bbmFtZV0gPSBkZWh5ZHJhdGUodmFsLl9fcHJvdG9fX1tuYW1lXSwgcHJvdG9jbGVhbiwgW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksIHByb3RvID0gbmV3UHJvdG87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3dhbGwuc2VuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiY2FsbGJhY2siLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogW3Jlc3VsdCwgY2xlYW5lZCwgcHJvdG8sIHByb3RvY2xlYW5dCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH1dKSwgQnJpZGdlOwogICAgICAgICAgICB9KCk7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IEJyaWRnZTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIHZhciBfU3ltYm9sID0gX193ZWJwYWNrX3JlcXVpcmVfXyg4KTsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICAgICAgICAgICAgbmFtZTogX1N5bWJvbCgibmFtZSIpLAogICAgICAgICAgICAgICAgdHlwZTogX1N5bWJvbCgidHlwZSIpLAogICAgICAgICAgICAgICAgaW5zcGVjdGVkOiBfU3ltYm9sKCJpbnNwZWN0ZWQiKSwKICAgICAgICAgICAgICAgIG1ldGE6IF9TeW1ib2woIm1ldGEiKSwKICAgICAgICAgICAgICAgIHByb3RvOiBfU3ltYm9sKCJwcm90byIpCiAgICAgICAgICAgIH07CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IF9fd2VicGFja19yZXF1aXJlX18oOSkoKSA/IFN5bWJvbCA6IF9fd2VicGFja19yZXF1aXJlX18oMTApOwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgc3ltYm9sOwogICAgICAgICAgICAgICAgaWYgKCJmdW5jdGlvbiIgIT0gdHlwZW9mIFN5bWJvbCkgcmV0dXJuICExOwogICAgICAgICAgICAgICAgc3ltYm9sID0gU3ltYm9sKCJ0ZXN0IHN5bWJvbCIpOwoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgU3RyaW5nKHN5bWJvbCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICExOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciIpIHx8ICJvYmplY3QiID09IHR5cGVvZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5pc0NvbmNhdFNwcmVhZGFibGUgOiAiQEBpc0NvbmNhdFNwcmVhZGFibGUiKSAmJiAib2JqZWN0IiA9PSB0eXBlb2YgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciIpICYmICJvYmplY3QiID09IHR5cGVvZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC50b1ByaW1pdGl2ZSA6ICJAQHRvUHJpbWl0aXZlIikgJiYgIm9iamVjdCIgPT0gdHlwZW9mICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLnRvU3RyaW5nVGFnIDogIkBAdG9TdHJpbmdUYWciKSAmJiAib2JqZWN0IiA9PSB0eXBlb2YgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wudW5zY29wYWJsZXMgOiAiQEB1bnNjb3BhYmxlcyIpOwogICAgICAgICAgICB9OwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgdmFyIE5hdGl2ZVN5bWJvbCwKICAgICAgICAgICAgICAgIFN5bWJvbFBvbHlmaWxsLAogICAgICAgICAgICAgICAgX0hpZGRlblN5bWJvbCwKICAgICAgICAgICAgICAgIGQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDExKSwKICAgICAgICAgICAgICAgIHZhbGlkYXRlU3ltYm9sID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNCksCiAgICAgICAgICAgICAgICBjcmVhdGUgPSBPYmplY3QuY3JlYXRlLAogICAgICAgICAgICAgICAgZGVmaW5lUHJvcGVydGllcyA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzLAogICAgICAgICAgICAgICAgZGVmaW5lUHJvcGVydHkgPSBPYmplY3QuZGVmaW5lUHJvcGVydHksCiAgICAgICAgICAgICAgICBvYmpQcm90b3R5cGUgPSBPYmplY3QucHJvdG90eXBlLAogICAgICAgICAgICAgICAgZ2xvYmFsU3ltYm9scyA9IGNyZWF0ZShudWxsKTsKCiAgICAgICAgICAgICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiAoTmF0aXZlU3ltYm9sID0gU3ltYm9sKTsKCiAgICAgICAgICAgIHZhciBnZW5lcmF0ZU5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZShudWxsKTsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZGVzYykgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG5hbWUsIGllMTFCdWdXb3JrYXJvdW5kLCBwb3N0Zml4ID0gMDsgY3JlYXRlZFtkZXNjICsgKHBvc3RmaXggfHwgIiIpXTspIHsKICAgICAgICAgICAgICAgICAgICAgICAgKytwb3N0Zml4OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2MgKz0gcG9zdGZpeCB8fCAiIiwgY3JlYXRlZFtkZXNjXSA9ICEwLCBuYW1lID0gIkBAIiArIGRlc2MsIGRlZmluZVByb3BlcnR5KG9ialByb3RvdHlwZSwgbmFtZSwgZC5ncyhudWxsLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWUxMUJ1Z1dvcmthcm91bmQgfHwgKGllMTFCdWdXb3JrYXJvdW5kID0gITAsIGRlZmluZVByb3BlcnR5KHRoaXMsIG5hbWUsIGQodmFsdWUpKSwgaWUxMUJ1Z1dvcmthcm91bmQgPSAhMSk7CiAgICAgICAgICAgICAgICAgICAgfSkpLCBuYW1lOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSgpOwoKICAgICAgICAgICAgX0hpZGRlblN5bWJvbCA9IGZ1bmN0aW9uIEhpZGRlblN5bWJvbChkZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBfSGlkZGVuU3ltYm9sKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJUeXBlRXJyb3I6IFN5bWJvbCBpcyBub3QgYSBjb25zdHJ1Y3RvciIpOwogICAgICAgICAgICAgICAgcmV0dXJuIFN5bWJvbFBvbHlmaWxsKGRlc2NyaXB0aW9uKTsKICAgICAgICAgICAgfSwgbW9kdWxlLmV4cG9ydHMgPSBTeW1ib2xQb2x5ZmlsbCA9IGZ1bmN0aW9uIFN5bWJvbChkZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgdmFyIHN5bWJvbDsKICAgICAgICAgICAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgU3ltYm9sKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJUeXBlRXJyb3I6IFN5bWJvbCBpcyBub3QgYSBjb25zdHJ1Y3RvciIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHN5bWJvbCA9IGNyZWF0ZShfSGlkZGVuU3ltYm9sLnByb3RvdHlwZSksIGRlc2NyaXB0aW9uID0gdm9pZCAwID09PSBkZXNjcmlwdGlvbiA/ICIiIDogU3RyaW5nKGRlc2NyaXB0aW9uKSwgZGVmaW5lUHJvcGVydGllcyhzeW1ib2wsIHsKICAgICAgICAgICAgICAgICAgICBfX2Rlc2NyaXB0aW9uX186IGQoIiIsIGRlc2NyaXB0aW9uKSwKICAgICAgICAgICAgICAgICAgICBfX25hbWVfXzogZCgiIiwgZ2VuZXJhdGVOYW1lKGRlc2NyaXB0aW9uKSkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCBkZWZpbmVQcm9wZXJ0aWVzKFN5bWJvbFBvbHlmaWxsLCB7CiAgICAgICAgICAgICAgICAiZm9yIjogZChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdsb2JhbFN5bWJvbHNba2V5XSA/IGdsb2JhbFN5bWJvbHNba2V5XSA6IGdsb2JhbFN5bWJvbHNba2V5XSA9IFN5bWJvbFBvbHlmaWxsKFN0cmluZyhrZXkpKTsKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAga2V5Rm9yOiBkKGZ1bmN0aW9uIChzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGtleTsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZVN5bWJvbChzKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gZ2xvYmFsU3ltYm9scykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ2xvYmFsU3ltYm9sc1trZXldID09PSBzKSByZXR1cm4ga2V5OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaGFzSW5zdGFuY2U6IGQoIiIsIE5hdGl2ZVN5bWJvbCAmJiBOYXRpdmVTeW1ib2wuaGFzSW5zdGFuY2UgfHwgU3ltYm9sUG9seWZpbGwoImhhc0luc3RhbmNlIikpLAogICAgICAgICAgICAgICAgaXNDb25jYXRTcHJlYWRhYmxlOiBkKCIiLCBOYXRpdmVTeW1ib2wgJiYgTmF0aXZlU3ltYm9sLmlzQ29uY2F0U3ByZWFkYWJsZSB8fCBTeW1ib2xQb2x5ZmlsbCgiaXNDb25jYXRTcHJlYWRhYmxlIikpLAogICAgICAgICAgICAgICAgaXRlcmF0b3I6IGQoIiIsIE5hdGl2ZVN5bWJvbCAmJiBOYXRpdmVTeW1ib2wuaXRlcmF0b3IgfHwgU3ltYm9sUG9seWZpbGwoIml0ZXJhdG9yIikpLAogICAgICAgICAgICAgICAgbWF0Y2g6IGQoIiIsIE5hdGl2ZVN5bWJvbCAmJiBOYXRpdmVTeW1ib2wubWF0Y2ggfHwgU3ltYm9sUG9seWZpbGwoIm1hdGNoIikpLAogICAgICAgICAgICAgICAgcmVwbGFjZTogZCgiIiwgTmF0aXZlU3ltYm9sICYmIE5hdGl2ZVN5bWJvbC5yZXBsYWNlIHx8IFN5bWJvbFBvbHlmaWxsKCJyZXBsYWNlIikpLAogICAgICAgICAgICAgICAgc2VhcmNoOiBkKCIiLCBOYXRpdmVTeW1ib2wgJiYgTmF0aXZlU3ltYm9sLnNlYXJjaCB8fCBTeW1ib2xQb2x5ZmlsbCgic2VhcmNoIikpLAogICAgICAgICAgICAgICAgc3BlY2llczogZCgiIiwgTmF0aXZlU3ltYm9sICYmIE5hdGl2ZVN5bWJvbC5zcGVjaWVzIHx8IFN5bWJvbFBvbHlmaWxsKCJzcGVjaWVzIikpLAogICAgICAgICAgICAgICAgc3BsaXQ6IGQoIiIsIE5hdGl2ZVN5bWJvbCAmJiBOYXRpdmVTeW1ib2wuc3BsaXQgfHwgU3ltYm9sUG9seWZpbGwoInNwbGl0IikpLAogICAgICAgICAgICAgICAgdG9QcmltaXRpdmU6IGQoIiIsIE5hdGl2ZVN5bWJvbCAmJiBOYXRpdmVTeW1ib2wudG9QcmltaXRpdmUgfHwgU3ltYm9sUG9seWZpbGwoInRvUHJpbWl0aXZlIikpLAogICAgICAgICAgICAgICAgdG9TdHJpbmdUYWc6IGQoIiIsIE5hdGl2ZVN5bWJvbCAmJiBOYXRpdmVTeW1ib2wudG9TdHJpbmdUYWcgfHwgU3ltYm9sUG9seWZpbGwoInRvU3RyaW5nVGFnIikpLAogICAgICAgICAgICAgICAgdW5zY29wYWJsZXM6IGQoIiIsIE5hdGl2ZVN5bWJvbCAmJiBOYXRpdmVTeW1ib2wudW5zY29wYWJsZXMgfHwgU3ltYm9sUG9seWZpbGwoInVuc2NvcGFibGVzIikpCiAgICAgICAgICAgIH0pLCBkZWZpbmVQcm9wZXJ0aWVzKF9IaWRkZW5TeW1ib2wucHJvdG90eXBlLCB7CiAgICAgICAgICAgICAgICBjb25zdHJ1Y3RvcjogZChTeW1ib2xQb2x5ZmlsbCksCiAgICAgICAgICAgICAgICB0b1N0cmluZzogZCgiIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9fbmFtZV9fOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfSksIGRlZmluZVByb3BlcnRpZXMoU3ltYm9sUG9seWZpbGwucHJvdG90eXBlLCB7CiAgICAgICAgICAgICAgICB0b1N0cmluZzogZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJTeW1ib2wgKCIgKyB2YWxpZGF0ZVN5bWJvbCh0aGlzKS5fX2Rlc2NyaXB0aW9uX18gKyAiKSI7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHZhbHVlT2Y6IGQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWxpZGF0ZVN5bWJvbCh0aGlzKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0pLCBkZWZpbmVQcm9wZXJ0eShTeW1ib2xQb2x5ZmlsbC5wcm90b3R5cGUsIFN5bWJvbFBvbHlmaWxsLnRvUHJpbWl0aXZlLCBkKCIiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdGVTeW1ib2wodGhpcyk7CiAgICAgICAgICAgIH0pKSwgZGVmaW5lUHJvcGVydHkoU3ltYm9sUG9seWZpbGwucHJvdG90eXBlLCBTeW1ib2xQb2x5ZmlsbC50b1N0cmluZ1RhZywgZCgiYyIsICJTeW1ib2wiKSksIGRlZmluZVByb3BlcnR5KF9IaWRkZW5TeW1ib2wucHJvdG90eXBlLCBTeW1ib2xQb2x5ZmlsbC50b1N0cmluZ1RhZywgZCgiYyIsIFN5bWJvbFBvbHlmaWxsLnByb3RvdHlwZVtTeW1ib2xQb2x5ZmlsbC50b1N0cmluZ1RhZ10pKSwgZGVmaW5lUHJvcGVydHkoX0hpZGRlblN5bWJvbC5wcm90b3R5cGUsIFN5bWJvbFBvbHlmaWxsLnRvUHJpbWl0aXZlLCBkKCJjIiwgU3ltYm9sUG9seWZpbGwucHJvdG90eXBlW1N5bWJvbFBvbHlmaWxsLnRvUHJpbWl0aXZlXSkpOwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgdmFyIGQsCiAgICAgICAgICAgICAgICBhc3NpZ24gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEyKSwKICAgICAgICAgICAgICAgIG5vcm1hbGl6ZU9wdHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE5KSwKICAgICAgICAgICAgICAgIGlzQ2FsbGFibGUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIwKSwKICAgICAgICAgICAgICAgIGNvbnRhaW5zID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMSk7CgogICAgICAgICAgICBkID0gbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoZHNjciwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBjLCBlLCB3LCBvcHRpb25zLCBkZXNjOwogICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPCAyIHx8ICJzdHJpbmciICE9IHR5cGVvZiBkc2NyID8gKG9wdGlvbnMgPSB2YWx1ZSwgdmFsdWUgPSBkc2NyLCBkc2NyID0gbnVsbCkgOiBvcHRpb25zID0gYXJndW1lbnRzWzJdLCBudWxsID09IGRzY3IgPyAoYyA9IHcgPSAhMCwgZSA9ICExKSA6IChjID0gY29udGFpbnMuY2FsbChkc2NyLCAiYyIpLCBlID0gY29udGFpbnMuY2FsbChkc2NyLCAiZSIpLCB3ID0gY29udGFpbnMuY2FsbChkc2NyLCAidyIpKSwgZGVzYyA9IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBjLAogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGUsCiAgICAgICAgICAgICAgICAgICAgd3JpdGFibGU6IHcKICAgICAgICAgICAgICAgIH0sIG9wdGlvbnMgPyBhc3NpZ24obm9ybWFsaXplT3B0cyhvcHRpb25zKSwgZGVzYykgOiBkZXNjOwogICAgICAgICAgICB9LCBkLmdzID0gZnVuY3Rpb24gKGRzY3IsIGdldCwgc2V0KSB7CiAgICAgICAgICAgICAgICB2YXIgYywgZSwgb3B0aW9ucywgZGVzYzsKICAgICAgICAgICAgICAgIHJldHVybiAic3RyaW5nIiAhPSB0eXBlb2YgZHNjciA/IChvcHRpb25zID0gc2V0LCBzZXQgPSBnZXQsIGdldCA9IGRzY3IsIGRzY3IgPSBudWxsKSA6IG9wdGlvbnMgPSBhcmd1bWVudHNbM10sIG51bGwgPT0gZ2V0ID8gZ2V0ID0gdm9pZCAwIDogaXNDYWxsYWJsZShnZXQpID8gbnVsbCA9PSBzZXQgPyBzZXQgPSB2b2lkIDAgOiBpc0NhbGxhYmxlKHNldCkgfHwgKG9wdGlvbnMgPSBzZXQsIHNldCA9IHZvaWQgMCkgOiAob3B0aW9ucyA9IGdldCwgZ2V0ID0gc2V0ID0gdm9pZCAwKSwgbnVsbCA9PSBkc2NyID8gKGMgPSAhMCwgZSA9ICExKSA6IChjID0gY29udGFpbnMuY2FsbChkc2NyLCAiYyIpLCBlID0gY29udGFpbnMuY2FsbChkc2NyLCAiZSIpKSwgZGVzYyA9IHsKICAgICAgICAgICAgICAgICAgICBnZXQ6IGdldCwKICAgICAgICAgICAgICAgICAgICBzZXQ6IHNldCwKICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGMsCiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZQogICAgICAgICAgICAgICAgfSwgb3B0aW9ucyA/IGFzc2lnbihub3JtYWxpemVPcHRzKG9wdGlvbnMpLCBkZXNjKSA6IGRlc2M7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IF9fd2VicGFja19yZXF1aXJlX18oMTMpKCkgPyBPYmplY3QuYXNzaWduIDogX193ZWJwYWNrX3JlcXVpcmVfXygxNCk7CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBvYmosCiAgICAgICAgICAgICAgICAgICAgYXNzaWduID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICAgICAgICAgIHJldHVybiAiZnVuY3Rpb24iID09IHR5cGVvZiBhc3NpZ24gJiYgKG9iaiA9IHsKICAgICAgICAgICAgICAgICAgICBmb286ICJyYXoiCiAgICAgICAgICAgICAgICB9LCBhc3NpZ24ob2JqLCB7CiAgICAgICAgICAgICAgICAgICAgYmFyOiAiZHdhIgogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIHRyenk6ICJ0cnp5IgogICAgICAgICAgICAgICAgfSksIG9iai5mb28gKyBvYmouYmFyICsgb2JqLnRyenkgPT09ICJyYXpkd2F0cnp5Iik7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICB2YXIga2V5cyA9IF9fd2VicGFja19yZXF1aXJlX18oMTUpLAogICAgICAgICAgICAgICAgdmFsdWUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE4KSwKICAgICAgICAgICAgICAgIG1heCA9IE1hdGgubWF4OwoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoZGVzdCwgc3JjKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IsCiAgICAgICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgICAgICBhc3NpZ24sCiAgICAgICAgICAgICAgICAgICAgbCA9IG1heChhcmd1bWVudHMubGVuZ3RoLCAyKTsKCiAgICAgICAgICAgICAgICBmb3IgKGRlc3QgPSBPYmplY3QodmFsdWUoZGVzdCkpLCBhc3NpZ24gPSBmdW5jdGlvbiBhc3NpZ24oa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFtrZXldID0gc3JjW2tleV07CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvciB8fCAoZXJyb3IgPSBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBpID0gMTsgaSA8IGw7ICsraSkgewogICAgICAgICAgICAgICAgICAgIHNyYyA9IGFyZ3VtZW50c1tpXSwga2V5cyhzcmMpLmZvckVhY2goYXNzaWduKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBlcnJvcikgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzdDsKICAgICAgICAgICAgfTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNikoKSA/IE9iamVjdC5rZXlzIDogX193ZWJwYWNrX3JlcXVpcmVfXygxNyk7CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKCJwcmltaXRpdmUiKSwgITA7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICExOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5czsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKG9iamVjdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGtleXMobnVsbCA9PSBvYmplY3QgPyBvYmplY3QgOiBPYmplY3Qob2JqZWN0KSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKG51bGwgPT0gdmFsdWUpIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCB1c2UgbnVsbCBvciB1bmRlZmluZWQiKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIHZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2gsCiAgICAgICAgICAgICAgICBjcmVhdGUgPSBPYmplY3QuY3JlYXRlLAogICAgICAgICAgICAgICAgcHJvY2VzcyA9IGZ1bmN0aW9uIHByb2Nlc3Moc3JjLCBvYmopIHsKICAgICAgICAgICAgICAgIHZhciBrZXk7CgogICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gc3JjKSB7CiAgICAgICAgICAgICAgICAgICAgb2JqW2tleV0gPSBzcmNba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBjcmVhdGUobnVsbCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZm9yRWFjaC5jYWxsKGFyZ3VtZW50cywgZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICBudWxsICE9IG9wdGlvbnMgJiYgcHJvY2VzcyhPYmplY3Qob3B0aW9ucyksIHJlc3VsdCk7CiAgICAgICAgICAgICAgICB9KSwgcmVzdWx0OwogICAgICAgICAgICB9OwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIiA9PSB0eXBlb2Ygb2JqOwogICAgICAgICAgICB9OwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIyKSgpID8gU3RyaW5nLnByb3RvdHlwZS5jb250YWlucyA6IF9fd2VicGFja19yZXF1aXJlX18oMjMpOwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgdmFyIHN0ciA9ICJyYXpkd2F0cnp5IjsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJmdW5jdGlvbiIgPT0gdHlwZW9mIHN0ci5jb250YWlucyAmJiBzdHIuY29udGFpbnMoImR3YSIpID09PSAhMCAmJiBzdHIuY29udGFpbnMoImZvbyIpID09PSAhMTsKICAgICAgICAgICAgfTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIHZhciBpbmRleE9mID0gU3RyaW5nLnByb3RvdHlwZS5pbmRleE9mOwoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoc2VhcmNoU3RyaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKHRoaXMsIHNlYXJjaFN0cmluZywgYXJndW1lbnRzWzFdKSA+IC0xOwogICAgICAgICAgICB9OwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgdmFyIGlzU3ltYm9sID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNSk7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc1N5bWJvbCh2YWx1ZSkpIHRocm93IG5ldyBUeXBlRXJyb3IodmFsdWUgKyAiIGlzIG5vdCBhIHN5bWJvbCIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9OwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHggJiYgKCJzeW1ib2wiID09IHR5cGVvZiB4IHx8ICJTeW1ib2wiID09PSB4WyJAQHRvU3RyaW5nVGFnIl0pIHx8ICExOwogICAgICAgICAgICB9OwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZShkYXRhLCBjbGVhbmVkKSB7CiAgICAgICAgICAgICAgICBjbGVhbmVkLmZvckVhY2goZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdCA9IHBhdGgucG9wKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG9iaiA9IHBhdGgucmVkdWNlKGZ1bmN0aW9uIChvYmpfLCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmpfID8gb2JqX1thdHRyXSA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSwgZGF0YSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChvYmogJiYgb2JqW2xhc3RdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXBsYWNlID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VbY29uc3RzLm5hbWVdID0gb2JqW2xhc3RdLm5hbWUsIHJlcGxhY2VbY29uc3RzLnR5cGVdID0gb2JqW2xhc3RdLnR5cGUsIHJlcGxhY2VbY29uc3RzLm1ldGFdID0gb2JqW2xhc3RdLm1ldGEsIHJlcGxhY2VbY29uc3RzLmluc3BlY3RlZF0gPSAhMSwgb2JqW2xhc3RdID0gcmVwbGFjZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNvbnN0cyA9IF9fd2VicGFja19yZXF1aXJlX18oNyk7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGh5ZHJhdGU7CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRQcm9wVHlwZShkYXRhKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRhdGEpIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgdmFyIHR5cGUgPSAidW5kZWZpbmVkIiA9PSB0eXBlb2YgZGF0YSA/ICJ1bmRlZmluZWQiIDogX3R5cGVvZihkYXRhKTsKCiAgICAgICAgICAgICAgICBpZiAoIm9iamVjdCIgPT09IHR5cGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5fcmVhY3RGcmFnbWVudCkgcmV0dXJuICJyZWFjdF9mcmFnbWVudCI7CiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHJldHVybiAiYXJyYXkiOwogICAgICAgICAgICAgICAgICAgIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoZGF0YSkpIHJldHVybiBkYXRhIGluc3RhbmNlb2YgRGF0YVZpZXcgPyAiZGF0YV92aWV3IiA6ICJ0eXBlZF9hcnJheSI7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgcmV0dXJuICJhcnJheV9idWZmZXIiOwogICAgICAgICAgICAgICAgICAgIGlmICgiZnVuY3Rpb24iID09IHR5cGVvZiBkYXRhW3R5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciJdKSByZXR1cm4gIml0ZXJhdG9yIjsKICAgICAgICAgICAgICAgICAgICBpZiAoIltvYmplY3QgRGF0ZV0iID09PSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZGF0YSkpIHJldHVybiAiZGF0ZSI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURlaHlkcmF0ZWQodHlwZSwgZGF0YSwgY2xlYW5lZCwgcGF0aCkgewogICAgICAgICAgICAgICAgdmFyIG1ldGEgPSB7fTsKICAgICAgICAgICAgICAgIHJldHVybiAiYXJyYXkiICE9PSB0eXBlICYmICJ0eXBlZF9hcnJheSIgIT09IHR5cGUgfHwgKG1ldGEubGVuZ3RoID0gZGF0YS5sZW5ndGgpLCAiaXRlcmF0b3IiICE9PSB0eXBlICYmICJ0eXBlZF9hcnJheSIgIT09IHR5cGUgfHwgKG1ldGEucmVhZE9ubHkgPSAhMCksIGNsZWFuZWQucHVzaChwYXRoKSwgewogICAgICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgICAgICAgbWV0YTogbWV0YSwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBkYXRhLmNvbnN0cnVjdG9yICYmICJPYmplY3QiICE9PSBkYXRhLmNvbnN0cnVjdG9yLm5hbWUgPyBkYXRhLmNvbnN0cnVjdG9yLm5hbWUgOiAiIgogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gZGVoeWRyYXRlKGRhdGEsIGNsZWFuZWQpIHsKICAgICAgICAgICAgICAgIHZhciBwYXRoID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbMl0gPyBhcmd1bWVudHNbMl0gOiBbXSwKICAgICAgICAgICAgICAgICAgICBsZXZlbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzNdID8gYXJndW1lbnRzWzNdIDogMCwKICAgICAgICAgICAgICAgICAgICB0eXBlID0gZ2V0UHJvcFR5cGUoZGF0YSk7CgogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2xlYW5lZC5wdXNoKHBhdGgpLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBkYXRhLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiZnVuY3Rpb24iCiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhLmxlbmd0aCA8PSA1MDAgPyBkYXRhIDogZGF0YS5zbGljZSgwLCA1MDApICsgIi4uLiI7CgogICAgICAgICAgICAgICAgICAgIGNhc2UgInN5bWJvbCI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjbGVhbmVkLnB1c2gocGF0aCksIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJzeW1ib2wiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogZGF0YS50b1N0cmluZygpCiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGNhc2UgInJlYWN0X2ZyYWdtZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJBIFJlYWN0IEZyYWdtZW50IjsKCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiYXJyYXlfYnVmZmVyIjoKICAgICAgICAgICAgICAgICAgICBjYXNlICJkYXRhX3ZpZXciOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2xlYW5lZC5wdXNoKHBhdGgpLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogImRhdGFfdmlldyIgPT09IHR5cGUgPyAiRGF0YVZpZXciIDogIkFycmF5QnVmZmVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGE6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGg6IGRhdGEuYnl0ZUxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmluc3BlY3RhYmxlOiAhMAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBjYXNlICJhcnJheSI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsZXZlbCA+IDIgPyBjcmVhdGVEZWh5ZHJhdGVkKHR5cGUsIGRhdGEsIGNsZWFuZWQsIHBhdGgpIDogZGF0YS5tYXAoZnVuY3Rpb24gKGl0ZW0sIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWh5ZHJhdGUoaXRlbSwgY2xlYW5lZCwgcGF0aC5jb25jYXQoW2ldKSwgbGV2ZWwgKyAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIGNhc2UgInR5cGVkX2FycmF5IjoKICAgICAgICAgICAgICAgICAgICBjYXNlICJpdGVyYXRvciI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVEZWh5ZHJhdGVkKHR5cGUsIGRhdGEsIGNsZWFuZWQsIHBhdGgpOwoKICAgICAgICAgICAgICAgICAgICBjYXNlICJkYXRlIjoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsZWFuZWQucHVzaChwYXRoKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogZGF0YS50b1N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImRhdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0YTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuaW5zcGVjdGFibGU6ICEwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsZXZlbCA+IDIgfHwgZGF0YS5jb25zdHJ1Y3RvciAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBkYXRhLmNvbnN0cnVjdG9yICYmICJPYmplY3QiICE9PSBkYXRhLmNvbnN0cnVjdG9yLm5hbWUpIHJldHVybiBjcmVhdGVEZWh5ZHJhdGVkKHR5cGUsIGRhdGEsIGNsZWFuZWQsIHBhdGgpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzID0ge307CgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc1tuYW1lXSA9IGRlaHlkcmF0ZShkYXRhW25hbWVdLCBjbGVhbmVkLCBwYXRoLmNvbmNhdChbbmFtZV0pLCBsZXZlbCArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzOwoKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIF90eXBlb2YgPSAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgInN5bWJvbCIgPT0gdHlwZW9mICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLml0ZXJhdG9yIDogIkBAaXRlcmF0b3IiKSA/IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqOwogICAgICAgICAgICB9IDogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5wcm90b3R5cGUgOiAiQEBwcm90b3R5cGUiKSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZGVoeWRyYXRlOwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgdmFyIHBlcmZvcm1hbmNlTm93LAogICAgICAgICAgICAgICAgcGVyZm9ybWFuY2UgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI5KTsKCiAgICAgICAgICAgIHBlcmZvcm1hbmNlTm93ID0gcGVyZm9ybWFuY2Uubm93ID8gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBlcmZvcm1hbmNlLm5vdygpOwogICAgICAgICAgICB9IDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGUubm93KCk7CiAgICAgICAgICAgIH0sIG1vZHVsZS5leHBvcnRzID0gcGVyZm9ybWFuY2VOb3c7CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICB2YXIgcGVyZm9ybWFuY2UsCiAgICAgICAgICAgICAgICBFeGVjdXRpb25FbnZpcm9ubWVudCA9IF9fd2VicGFja19yZXF1aXJlX18oMzApOwoKICAgICAgICAgICAgRXhlY3V0aW9uRW52aXJvbm1lbnQuY2FuVXNlRE9NICYmIChwZXJmb3JtYW5jZSA9IHdpbmRvdy5wZXJmb3JtYW5jZSB8fCB3aW5kb3cubXNQZXJmb3JtYW5jZSB8fCB3aW5kb3cud2Via2l0UGVyZm9ybWFuY2UpLCBtb2R1bGUuZXhwb3J0cyA9IHBlcmZvcm1hbmNlIHx8IHt9OwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgdmFyIGNhblVzZURPTSA9ICEoInVuZGVmaW5lZCIgPT0gdHlwZW9mIHdpbmRvdyB8fCAhd2luZG93LmRvY3VtZW50IHx8ICF3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCksCiAgICAgICAgICAgICAgICBFeGVjdXRpb25FbnZpcm9ubWVudCA9IHsKICAgICAgICAgICAgICAgIGNhblVzZURPTTogY2FuVXNlRE9NLAogICAgICAgICAgICAgICAgY2FuVXNlV29ya2VyczogInVuZGVmaW5lZCIgIT0gdHlwZW9mIFdvcmtlciwKICAgICAgICAgICAgICAgIGNhblVzZUV2ZW50TGlzdGVuZXJzOiBjYW5Vc2VET00gJiYgISghd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXdpbmRvdy5hdHRhY2hFdmVudCksCiAgICAgICAgICAgICAgICBjYW5Vc2VWaWV3cG9ydDogY2FuVXNlRE9NICYmICEhd2luZG93LnNjcmVlbiwKICAgICAgICAgICAgICAgIGlzSW5Xb3JrZXI6ICFjYW5Vc2VET00KICAgICAgICAgICAgfTsKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBFeGVjdXRpb25FbnZpcm9ubWVudDsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGluc3RhbGxHbG9iYWxIb29rKHdpbmRvdykgewogICAgICAgICAgICAgICAgZnVuY3Rpb24gZGV0ZWN0UmVhY3RCdWlsZFR5cGUocmVuZGVyZXIpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIHJlbmRlcmVyLnZlcnNpb24pIHJldHVybiByZW5kZXJlci5idW5kbGVUeXBlID4gMCA/ICJkZXZlbG9wbWVudCIgOiAicHJvZHVjdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b1N0cmluZyA9IEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlci5Nb3VudCAmJiByZW5kZXJlci5Nb3VudC5fcmVuZGVyTmV3Um9vdENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlclJvb3RDb2RlID0gdG9TdHJpbmcuY2FsbChyZW5kZXJlci5Nb3VudC5fcmVuZGVyTmV3Um9vdENvbXBvbmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMCAhPT0gcmVuZGVyUm9vdENvZGUuaW5kZXhPZigiZnVuY3Rpb24iKSA/ICJwcm9kdWN0aW9uIiA6IHJlbmRlclJvb3RDb2RlLmluZGV4T2YoInN0b3JlZE1lYXN1cmUiKSAhPT0gLTEgPyAiZGV2ZWxvcG1lbnQiIDogcmVuZGVyUm9vdENvZGUuaW5kZXhPZigic2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiIpICE9PSAtMSA/IHJlbmRlclJvb3RDb2RlLmluZGV4T2YoIk5PREVfRU5WIikgIT09IC0xID8gImRldmVsb3BtZW50IiA6IHJlbmRlclJvb3RDb2RlLmluZGV4T2YoImRldmVsb3BtZW50IikgIT09IC0xID8gImRldmVsb3BtZW50IiA6IHJlbmRlclJvb3RDb2RlLmluZGV4T2YoInRydWUiKSAhPT0gLTEgPyAiZGV2ZWxvcG1lbnQiIDogcmVuZGVyUm9vdENvZGUuaW5kZXhPZigibmV4dEVsZW1lbnQiKSAhPT0gLTEgfHwgcmVuZGVyUm9vdENvZGUuaW5kZXhPZigibmV4dENvbXBvbmVudCIpICE9PSAtMSA/ICJ1bm1pbmlmaWVkIiA6ICJkZXZlbG9wbWVudCIgOiByZW5kZXJSb290Q29kZS5pbmRleE9mKCJuZXh0RWxlbWVudCIpICE9PSAtMSB8fCByZW5kZXJSb290Q29kZS5pbmRleE9mKCJuZXh0Q29tcG9uZW50IikgIT09IC0xID8gInVubWluaWZpZWQiIDogcmVuZGVyUm9vdENvZGUuaW5kZXhPZigiLl9yZWdpc3RlckNvbXBvbmVudCIpICE9PSAtMSA/ICJvdXRkYXRlZCIgOiAicHJvZHVjdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHt9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiAicHJvZHVjdGlvbiI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCF3aW5kb3cuX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhhc0RldGVjdGVkQmFkRENFID0gITEsCiAgICAgICAgICAgICAgICAgICAgICAgIGhvb2sgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9yZW5kZXJlcnM6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICBoZWxwZXJzOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tEQ0U6IGZ1bmN0aW9uIGNoZWNrRENFKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b1N0cmluZyA9IEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IHRvU3RyaW5nLmNhbGwoZm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUuaW5kZXhPZigiXl9eIikgPiAtMSAmJiAoaGFzRGV0ZWN0ZWRCYWREQ0UgPSAhMCwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QgaXMgcnVubmluZyBpbiBwcm9kdWN0aW9uIG1vZGUsIGJ1dCBkZWFkIGNvZGUgZWxpbWluYXRpb24gaGFzIG5vdCBiZWVuIGFwcGxpZWQuIFJlYWQgaG93IHRvIGNvcnJlY3RseSBjb25maWd1cmUgUmVhY3QgZm9yIHByb2R1Y3Rpb246IGh0dHBzOi8vZmIubWUvcmVhY3QtcGVyZi11c2UtdGhlLXByb2R1Y3Rpb24tYnVpbGQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHt9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGluamVjdDogZnVuY3Rpb24gaW5qZWN0KHJlbmRlcmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWQgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDE2KS5zbGljZSgyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvb2suX3JlbmRlcmVyc1tpZF0gPSByZW5kZXJlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWFjdEJ1aWxkVHlwZSA9IGhhc0RldGVjdGVkQmFkRENFID8gImRlYWRjb2RlIiA6IGRldGVjdFJlYWN0QnVpbGRUeXBlKHJlbmRlcmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBob29rLmVtaXQoInJlbmRlcmVyIiwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlcjogcmVuZGVyZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhY3RCdWlsZFR5cGU6IHJlYWN0QnVpbGRUeXBlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSwgaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIF9saXN0ZW5lcnM6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICBzdWI6IGZ1bmN0aW9uIHN1YihldnQsIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaG9vay5vbihldnQsIGZuKSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBob29rLm9mZihldnQsIGZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIG9uOiBmdW5jdGlvbiBvbihldnQsIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBob29rLl9saXN0ZW5lcnNbZXZ0XSB8fCAoaG9vay5fbGlzdGVuZXJzW2V2dF0gPSBbXSksIGhvb2suX2xpc3RlbmVyc1tldnRdLnB1c2goZm4pOwogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBvZmY6IGZ1bmN0aW9uIG9mZihldnQsIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaG9vay5fbGlzdGVuZXJzW2V2dF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXggPSBob29rLl9saXN0ZW5lcnNbZXZ0XS5pbmRleE9mKGZuKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXggIT09IC0xICYmIGhvb2suX2xpc3RlbmVyc1tldnRdLnNwbGljZShpeCwgMSksIGhvb2suX2xpc3RlbmVyc1tldnRdLmxlbmd0aCB8fCAoaG9vay5fbGlzdGVuZXJzW2V2dF0gPSBudWxsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdDogZnVuY3Rpb24gZW1pdChldnQsIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvb2suX2xpc3RlbmVyc1tldnRdICYmIGhvb2suX2xpc3RlbmVyc1tldnRdLm1hcChmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc3VwcG9ydHNGaWJlcjogITAsCiAgICAgICAgICAgICAgICAgICAgICAgIF9maWJlclJvb3RzOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgZ2V0RmliZXJSb290czogZnVuY3Rpb24gZ2V0RmliZXJSb290cyhyZW5kZXJlcklEKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdHMgPSBob29rLl9maWJlclJvb3RzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJvb3RzW3JlbmRlcmVySURdIHx8IChyb290c1tyZW5kZXJlcklEXSA9IG5ldyBTZXQoKSksIHJvb3RzW3JlbmRlcmVySURdOwogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBvbkNvbW1pdEZpYmVyVW5tb3VudDogZnVuY3Rpb24gb25Db21taXRGaWJlclVubW91bnQocmVuZGVyZXJJRCwgZmliZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvb2suaGVscGVyc1tyZW5kZXJlcklEXSAmJiBob29rLmhlbHBlcnNbcmVuZGVyZXJJRF0uaGFuZGxlQ29tbWl0RmliZXJVbm1vdW50KGZpYmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgb25Db21taXRGaWJlclJvb3Q6IGZ1bmN0aW9uIG9uQ29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb3VudGVkUm9vdHMgPSBob29rLmdldEZpYmVyUm9vdHMocmVuZGVyZXJJRCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHJvb3QuY3VycmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0tub3duUm9vdCA9IG1vdW50ZWRSb290cy5oYXMocm9vdCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNVbm1vdW50aW5nID0gbnVsbCA9PSBjdXJyZW50Lm1lbW9pemVkU3RhdGUgfHwgbnVsbCA9PSBjdXJyZW50Lm1lbW9pemVkU3RhdGUuZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzS25vd25Sb290IHx8IGlzVW5tb3VudGluZyA/IGlzS25vd25Sb290ICYmIGlzVW5tb3VudGluZyAmJiBtb3VudGVkUm9vdHNbImRlbGV0ZSJdKHJvb3QpIDogbW91bnRlZFJvb3RzLmFkZChyb290KSwgaG9vay5oZWxwZXJzW3JlbmRlcmVySURdICYmIGhvb2suaGVscGVyc1tyZW5kZXJlcklEXS5oYW5kbGVDb21taXRGaWJlclJvb3Qocm9vdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3csICJfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18iLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBob29rCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gaW5zdGFsbEdsb2JhbEhvb2s7CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBmdW5jdGlvbiBpbnN0YWxsUmVsYXlIb29rKHdpbmRvdykgewogICAgICAgICAgICAgICAgZnVuY3Rpb24gZGVjb3JhdGUob2JqLCBhdHRyLCBmbikgewogICAgICAgICAgICAgICAgICAgIHZhciBvbGQgPSBvYmpbYXR0cl07CgogICAgICAgICAgICAgICAgICAgIG9ialthdHRyXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcyA9IG9sZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKSwgcmVzOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZW1pdChuYW1lLCBkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgX2V2ZW50UXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgICAgICAgICB9KSwgX2xpc3RlbmVyICYmIF9saXN0ZW5lcihuYW1lLCBkYXRhKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzZXRSZXF1ZXN0TGlzdGVuZXIobGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoX2xpc3RlbmVyKSB0aHJvdyBuZXcgRXJyb3IoIlJlbGF5IERldnRvb2xzOiBDYWxsZWQgb25seSBjYWxsIHNldFJlcXVlc3RMaXN0ZW5lciBvbmNlLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBfbGlzdGVuZXIgPSBsaXN0ZW5lciwgX2V2ZW50UXVldWUuZm9yRWFjaChmdW5jdGlvbiAoX3JlZikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IF9yZWYubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBfcmVmLmRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyKG5hbWUsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgIH0pLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9saXN0ZW5lciA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZWNvcmRSZXF1ZXN0KHR5cGUsIHN0YXJ0LCByZXF1ZXN0LCByZXF1ZXN0TnVtYmVyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygxNikuc3Vic3RyKDIpOwogICAgICAgICAgICAgICAgICAgIHJlcXVlc3QudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdCgicmVsYXk6c3VjY2VzcyIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZDogcGVyZm9ybWFuY2VOb3coKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlOiByZXNwb25zZS5yZXNwb25zZQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZW1pdCgicmVsYXk6ZmFpbHVyZSIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZDogcGVyZm9ybWFuY2VOb3coKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvcgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgdGV4dENodW5rcyA9IFtdLCB0ZXh0ID0gcmVxdWVzdC5nZXRRdWVyeVN0cmluZygpOyB0ZXh0Lmxlbmd0aCA+IDA7KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRDaHVua3MucHVzaCh0ZXh0LnN1YnN0cigwLCBURVhUX0NIVU5LX0xFTkdUSCkpLCB0ZXh0ID0gdGV4dC5zdWJzdHIoVEVYVF9DSFVOS19MRU5HVEgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiByZXF1ZXN0LmdldERlYnVnTmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0TnVtYmVyOiByZXF1ZXN0TnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IHRleHRDaHVua3MsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlczogcmVxdWVzdC5nZXRWYXJpYWJsZXMoKQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gaW5zdHJ1bWVudFJlbGF5UmVxdWVzdHMocmVsYXlJbnRlcm5hbHMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgTmV0d29ya0xheWVyID0gcmVsYXlJbnRlcm5hbHMuTmV0d29ya0xheWVyOwogICAgICAgICAgICAgICAgICAgIGRlY29yYXRlKE5ldHdvcmtMYXllciwgInNlbmRNdXRhdGlvbiIsIGZ1bmN0aW9uIChtdXRhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0TnVtYmVyKyssIGVtaXQoInJlbGF5OnBlbmRpbmciLCBbcmVjb3JkUmVxdWVzdCgibXV0YXRpb24iLCBwZXJmb3JtYW5jZU5vdygpLCBtdXRhdGlvbiwgcmVxdWVzdE51bWJlcildKTsKICAgICAgICAgICAgICAgICAgICB9KSwgZGVjb3JhdGUoTmV0d29ya0xheWVyLCAic2VuZFF1ZXJpZXMiLCBmdW5jdGlvbiAocXVlcmllcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0TnVtYmVyKys7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IHBlcmZvcm1hbmNlTm93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVtaXQoInJlbGF5OnBlbmRpbmciLCBxdWVyaWVzLm1hcChmdW5jdGlvbiAocXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWNvcmRSZXF1ZXN0KCJxdWVyeSIsIHN0YXJ0LCBxdWVyeSwgcmVxdWVzdE51bWJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5zdHJ1bWVudGVkID0ge307CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiByZWxheUludGVybmFscykgewogICAgICAgICAgICAgICAgICAgICAgICByZWxheUludGVybmFscy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIChpbnN0cnVtZW50ZWRba2V5XSA9IHJlbGF5SW50ZXJuYWxzW2tleV0pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGluc3RydW1lbnRlZC5zZXRSZXF1ZXN0TGlzdGVuZXIgPSBzZXRSZXF1ZXN0TGlzdGVuZXIsIGluc3RydW1lbnRlZDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgcGVyZm9ybWFuY2VOb3csCiAgICAgICAgICAgICAgICAgICAgcGVyZm9ybWFuY2UgPSB3aW5kb3cucGVyZm9ybWFuY2U7CiAgICAgICAgICAgICAgICBwZXJmb3JtYW5jZU5vdyA9IHBlcmZvcm1hbmNlICYmICJmdW5jdGlvbiIgPT0gdHlwZW9mIHBlcmZvcm1hbmNlLm5vdyA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgICAgICAgICAgICB9IDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHZhciBURVhUX0NIVU5LX0xFTkdUSCA9IDUwMCwKICAgICAgICAgICAgICAgICAgICBob29rID0gd2luZG93Ll9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXzsKCiAgICAgICAgICAgICAgICBpZiAoaG9vaykgewogICAgICAgICAgICAgICAgICAgIHZhciBfZXZlbnRRdWV1ZSA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBfbGlzdGVuZXIgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0TnVtYmVyID0gMCwKICAgICAgICAgICAgICAgICAgICAgICAgX3JlbGF5SW50ZXJuYWxzID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaG9vaywgIl9yZWxheUludGVybmFscyIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiAhMCwKICAgICAgICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQocmVsYXlJbnRlcm5hbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9yZWxheUludGVybmFscyA9IGluc3RydW1lbnRSZWxheVJlcXVlc3RzKHJlbGF5SW50ZXJuYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlbGF5SW50ZXJuYWxzOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gaW5zdGFsbFJlbGF5SG9vazsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIHZhciBzZXR1cEJhY2tlbmQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM0KTsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGhvb2ssIGFnZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgc3VicyA9IFtob29rLnN1YigicmVuZGVyZXItYXR0YWNoZWQiLCBmdW5jdGlvbiAoX3JlZikgewogICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IF9yZWYuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlbHBlcnMgPSAoX3JlZi5yZW5kZXJlciwgX3JlZi5oZWxwZXJzKTsKICAgICAgICAgICAgICAgICAgICBhZ2VudC5zZXRSZWFjdEludGVybmFscyhpZCwgaGVscGVycyksIGhlbHBlcnMud2Fsa1RyZWUoYWdlbnQub25Nb3VudGVkLmJpbmQoYWdlbnQsIGlkKSwgYWdlbnQuYWRkUm9vdC5iaW5kKGFnZW50LCBpZCkpOwogICAgICAgICAgICAgICAgfSksIGhvb2suc3ViKCJyb290IiwgZnVuY3Rpb24gKF9yZWYyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVyID0gX3JlZjIucmVuZGVyZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIGludGVybmFsSW5zdGFuY2UgPSBfcmVmMi5pbnRlcm5hbEluc3RhbmNlOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBhZ2VudC5hZGRSb290KHJlbmRlcmVyLCBpbnRlcm5hbEluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0pLCBob29rLnN1YigibW91bnQiLCBmdW5jdGlvbiAoX3JlZjMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZXIgPSBfcmVmMy5yZW5kZXJlciwKICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJuYWxJbnN0YW5jZSA9IF9yZWYzLmludGVybmFsSW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBfcmVmMy5kYXRhOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBhZ2VudC5vbk1vdW50ZWQocmVuZGVyZXIsIGludGVybmFsSW5zdGFuY2UsIGRhdGEpOwogICAgICAgICAgICAgICAgfSksIGhvb2suc3ViKCJ1cGRhdGUiLCBmdW5jdGlvbiAoX3JlZjQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJuYWxJbnN0YW5jZSA9IChfcmVmNC5yZW5kZXJlciwgX3JlZjQuaW50ZXJuYWxJbnN0YW5jZSksCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBfcmVmNC5kYXRhOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBhZ2VudC5vblVwZGF0ZWQoaW50ZXJuYWxJbnN0YW5jZSwgZGF0YSk7CiAgICAgICAgICAgICAgICB9KSwgaG9vay5zdWIoInVubW91bnQiLCBmdW5jdGlvbiAoX3JlZjUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJuYWxJbnN0YW5jZSA9IChfcmVmNS5yZW5kZXJlciwgX3JlZjUuaW50ZXJuYWxJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFnZW50Lm9uVW5tb3VudGVkKGludGVybmFsSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfSldLAogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZXR1cEJhY2tlbmQoaG9vayk7CiAgICAgICAgICAgICAgICBzdWNjZXNzICYmIChob29rLmVtaXQoInJlYWN0LWRldnRvb2xzIiwgYWdlbnQpLCBob29rLnJlYWN0RGV2dG9vbHNBZ2VudCA9IGFnZW50LCBhZ2VudC5vbigic2h1dGRvd24iLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgc3Vicy5mb3JFYWNoKGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgICAgICAgICAgICB9KSwgaG9vay5yZWFjdERldnRvb2xzQWdlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9OwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgdmFyIGF0dGFjaFJlbmRlcmVyID0gX193ZWJwYWNrX3JlcXVpcmVfXygzNSk7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChob29rKSB7CiAgICAgICAgICAgICAgICB2YXIgb2xkUmVhY3QgPSB3aW5kb3cuUmVhY3QgJiYgd2luZG93LlJlYWN0Ll9faW50ZXJuYWxzOwogICAgICAgICAgICAgICAgb2xkUmVhY3QgJiYgMCA9PT0gT2JqZWN0LmtleXMoaG9vay5fcmVuZGVyZXJzKS5sZW5ndGggJiYgaG9vay5pbmplY3Qob2xkUmVhY3QpOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIHJpZCBpbiBob29rLl9yZW5kZXJlcnMpIHsKICAgICAgICAgICAgICAgICAgICBob29rLmhlbHBlcnNbcmlkXSA9IGF0dGFjaFJlbmRlcmVyKGhvb2ssIHJpZCwgaG9vay5fcmVuZGVyZXJzW3JpZF0pLCBob29rLmVtaXQoInJlbmRlcmVyLWF0dGFjaGVkIiwgewogICAgICAgICAgICAgICAgICAgICAgICBpZDogcmlkLAogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlcjogaG9vay5fcmVuZGVyZXJzW3JpZF0sCiAgICAgICAgICAgICAgICAgICAgICAgIGhlbHBlcnM6IGhvb2suaGVscGVyc1tyaWRdCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaG9vay5vbigicmVuZGVyZXIiLCBmdW5jdGlvbiAoX3JlZikgewogICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IF9yZWYuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyID0gX3JlZi5yZW5kZXJlcjsKICAgICAgICAgICAgICAgICAgICBob29rLmhlbHBlcnNbaWRdID0gYXR0YWNoUmVuZGVyZXIoaG9vaywgaWQsIHJlbmRlcmVyKSwgaG9vay5lbWl0KCJyZW5kZXJlci1hdHRhY2hlZCIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlcjogcmVuZGVyZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlbHBlcnM6IGhvb2suaGVscGVyc1tpZF0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHZhciBzaHV0ZG93biA9IGZ1bmN0aW9uIHNodXRkb3duKCkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGlkIGluIGhvb2suaGVscGVycykgewogICAgICAgICAgICAgICAgICAgICAgICBob29rLmhlbHBlcnNbaWRdLmNsZWFudXAoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGhvb2sub2ZmKCJzaHV0ZG93biIsIHNodXRkb3duKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgcmV0dXJuIGhvb2sub24oInNodXRkb3duIiwgc2h1dGRvd24pLCAhMDsKICAgICAgICAgICAgfTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGF0dGFjaFJlbmRlcmVyKGhvb2ssIHJpZCwgcmVuZGVyZXIpIHsKICAgICAgICAgICAgICAgIHZhciByb290Tm9kZUlETWFwID0gbmV3IE1hcCgpLAogICAgICAgICAgICAgICAgICAgIGV4dHJhcyA9IHt9LAogICAgICAgICAgICAgICAgICAgIGlzUHJlMDEzID0gIXJlbmRlcmVyLlJlY29uY2lsZXI7CiAgICAgICAgICAgICAgICBpZiAoImZ1bmN0aW9uIiA9PSB0eXBlb2YgcmVuZGVyZXIuZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UpIHJldHVybiBhdHRhY2hSZW5kZXJlckZpYmVyKGhvb2ssIHJpZCwgcmVuZGVyZXIpOwogICAgICAgICAgICAgICAgcmVuZGVyZXIuTW91bnQuZmluZE5vZGVIYW5kbGUgJiYgcmVuZGVyZXIuTW91bnQubmF0aXZlVGFnVG9Sb290Tm9kZUlEID8gKGV4dHJhcy5nZXROYXRpdmVGcm9tUmVhY3RFbGVtZW50ID0gZnVuY3Rpb24gKGNvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZW5kZXJlci5Nb3VudC5maW5kTm9kZUhhbmRsZShjb21wb25lbnQpOwogICAgICAgICAgICAgICAgfSwgZXh0cmFzLmdldFJlYWN0RWxlbWVudEZyb21OYXRpdmUgPSBmdW5jdGlvbiAobmF0aXZlVGFnKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gcmVuZGVyZXIuTW91bnQubmF0aXZlVGFnVG9Sb290Tm9kZUlEKG5hdGl2ZVRhZyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJvb3ROb2RlSURNYXAuZ2V0KGlkKTsKICAgICAgICAgICAgICAgIH0pIDogcmVuZGVyZXIuQ29tcG9uZW50VHJlZSA/IChleHRyYXMuZ2V0TmF0aXZlRnJvbVJlYWN0RWxlbWVudCA9IGZ1bmN0aW9uIChjb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVuZGVyZXIuQ29tcG9uZW50VHJlZS5nZXROb2RlRnJvbUluc3RhbmNlKGNvbXBvbmVudCk7CiAgICAgICAgICAgICAgICB9LCBleHRyYXMuZ2V0UmVhY3RFbGVtZW50RnJvbU5hdGl2ZSA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlbmRlcmVyLkNvbXBvbmVudFRyZWUuZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobm9kZSk7CiAgICAgICAgICAgICAgICB9KSA6IHJlbmRlcmVyLk1vdW50LmdldElEICYmIHJlbmRlcmVyLk1vdW50LmdldE5vZGUgPyAoZXh0cmFzLmdldE5hdGl2ZUZyb21SZWFjdEVsZW1lbnQgPSBmdW5jdGlvbiAoY29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlbmRlcmVyLk1vdW50LmdldE5vZGUoY29tcG9uZW50Ll9yb290Tm9kZUlEKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBleHRyYXMuZ2V0UmVhY3RFbGVtZW50RnJvbU5hdGl2ZSA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaWQgPSByZW5kZXJlci5Nb3VudC5nZXRJRChub2RlKTsgbm9kZSAmJiBub2RlLnBhcmVudE5vZGUgJiYgIWlkOykgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlLCBpZCA9IHJlbmRlcmVyLk1vdW50LmdldElEKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJvb3ROb2RlSURNYXAuZ2V0KGlkKTsKICAgICAgICAgICAgICAgIH0pIDogY29uc29sZS53YXJuKCJVbmtub3duIHJlYWN0IHZlcnNpb24gKGRvZXMgbm90IGhhdmUgZ2V0SUQpLCBwcm9iYWJseSBhbiB1bnNoaW1tZWQgUmVhY3QgTmF0aXZlIik7CiAgICAgICAgICAgICAgICB2YXIgb2xkTWV0aG9kcywgb2xkUmVuZGVyQ29tcG9uZW50LCBvbGRSZW5kZXJSb290OwogICAgICAgICAgICAgICAgcmV0dXJuIHJlbmRlcmVyLk1vdW50Ll9yZW5kZXJOZXdSb290Q29tcG9uZW50ID8gb2xkUmVuZGVyUm9vdCA9IGRlY29yYXRlUmVzdWx0KHJlbmRlcmVyLk1vdW50LCAiX3JlbmRlck5ld1Jvb3RDb21wb25lbnQiLCBmdW5jdGlvbiAoaW50ZXJuYWxJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgICAgIGhvb2suZW1pdCgicm9vdCIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZXI6IHJpZCwKICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJuYWxJbnN0YW5jZTogaW50ZXJuYWxJbnN0YW5jZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkgOiByZW5kZXJlci5Nb3VudC5yZW5kZXJDb21wb25lbnQgJiYgKG9sZFJlbmRlckNvbXBvbmVudCA9IGRlY29yYXRlUmVzdWx0KHJlbmRlcmVyLk1vdW50LCAicmVuZGVyQ29tcG9uZW50IiwgZnVuY3Rpb24gKGludGVybmFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICBob29rLmVtaXQoInJvb3QiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyOiByaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGludGVybmFsSW5zdGFuY2U6IGludGVybmFsSW5zdGFuY2UuX3JlYWN0SW50ZXJuYWxJbnN0YW5jZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkpLCByZW5kZXJlci5Db21wb25lbnQgPyAoY29uc29sZS5lcnJvcigiWW91IGFyZSB1c2luZyBhIHZlcnNpb24gb2YgUmVhY3Qgd2l0aCBsaW1pdGVkIHN1cHBvcnQgaW4gdGhpcyB2ZXJzaW9uIG9mIHRoZSBkZXZ0b29scy5cblBsZWFzZSB1cGdyYWRlIHRvIHVzZSBhdCBsZWFzdCAwLjEzLCBvciB5b3UgY2FuIGRvd25ncmFkZSB0byB1c2UgdGhlIG9sZCB2ZXJzaW9uIG9mIHRoZSBkZXZ0b29sczpcbmluc3RydWN0aW9ucyBoZXJlIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC1kZXZ0b29scy90cmVlL2RldnRvb2xzLW5leHQjaG93LWRvLWktdXNlLXRoaXMtZm9yLXJlYWN0LS0wMTMiKSwgb2xkTWV0aG9kcyA9IGRlY29yYXRlTWFueShyZW5kZXJlci5Db21wb25lbnQuTWl4aW4sIHsKICAgICAgICAgICAgICAgICAgICBtb3VudENvbXBvbmVudDogZnVuY3Rpb24gbW91bnRDb21wb25lbnQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICAgICAgICAgICAgICByb290Tm9kZUlETWFwLnNldCh0aGlzLl9yb290Tm9kZUlELCB0aGlzKSwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBob29rLmVtaXQoIm1vdW50IiwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVybmFsSW5zdGFuY2U6IF90aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGdldERhdGEwMTIoX3RoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyOiByaWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZUNvbXBvbmVudDogZnVuY3Rpb24gdXBkYXRlQ29tcG9uZW50KCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9vay5lbWl0KCJ1cGRhdGUiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJuYWxJbnN0YW5jZTogX3RoaXMyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGdldERhdGEwMTIoX3RoaXMyKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlcjogcmlkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB1bm1vdW50Q29tcG9uZW50OiBmdW5jdGlvbiB1bm1vdW50Q29tcG9uZW50KCkgewogICAgICAgICAgICAgICAgICAgICAgICBob29rLmVtaXQoInVubW91bnQiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcm5hbEluc3RhbmNlOiB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZXI6IHJpZAogICAgICAgICAgICAgICAgICAgICAgICB9KSwgcm9vdE5vZGVJRE1hcFsiZGVsZXRlIl0odGhpcy5fcm9vdE5vZGVJRCwgdGhpcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSkpIDogcmVuZGVyZXIuUmVjb25jaWxlciAmJiAob2xkTWV0aG9kcyA9IGRlY29yYXRlTWFueShyZW5kZXJlci5SZWNvbmNpbGVyLCB7CiAgICAgICAgICAgICAgICAgICAgbW91bnRDb21wb25lbnQ6IGZ1bmN0aW9uIG1vdW50Q29tcG9uZW50KGludGVybmFsSW5zdGFuY2UsIHJvb3RJRCwgdHJhbnNhY3Rpb24sIGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBnZXREYXRhKGludGVybmFsSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgICAgICByb290Tm9kZUlETWFwLnNldChpbnRlcm5hbEluc3RhbmNlLl9yb290Tm9kZUlELCBpbnRlcm5hbEluc3RhbmNlKSwgaG9vay5lbWl0KCJtb3VudCIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVybmFsSW5zdGFuY2U6IGludGVybmFsSW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZXI6IHJpZAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHBlcmZvcm1VcGRhdGVJZk5lY2Vzc2FyeTogZnVuY3Rpb24gcGVyZm9ybVVwZGF0ZUlmTmVjZXNzYXJ5KGludGVybmFsSW5zdGFuY2UsIG5leHRDaGlsZCwgdHJhbnNhY3Rpb24sIGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaG9vay5lbWl0KCJ1cGRhdGUiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcm5hbEluc3RhbmNlOiBpbnRlcm5hbEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZ2V0RGF0YShpbnRlcm5hbEluc3RhbmNlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyOiByaWQKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICByZWNlaXZlQ29tcG9uZW50OiBmdW5jdGlvbiByZWNlaXZlQ29tcG9uZW50KGludGVybmFsSW5zdGFuY2UsIG5leHRDaGlsZCwgdHJhbnNhY3Rpb24sIGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaG9vay5lbWl0KCJ1cGRhdGUiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcm5hbEluc3RhbmNlOiBpbnRlcm5hbEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZ2V0RGF0YShpbnRlcm5hbEluc3RhbmNlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyOiByaWQKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB1bm1vdW50Q29tcG9uZW50OiBmdW5jdGlvbiB1bm1vdW50Q29tcG9uZW50KGludGVybmFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaG9vay5lbWl0KCJ1bm1vdW50IiwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJuYWxJbnN0YW5jZTogaW50ZXJuYWxJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyOiByaWQKICAgICAgICAgICAgICAgICAgICAgICAgfSksIHJvb3ROb2RlSURNYXBbImRlbGV0ZSJdKGludGVybmFsSW5zdGFuY2UuX3Jvb3ROb2RlSUQsIGludGVybmFsSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pKSwgZXh0cmFzLndhbGtUcmVlID0gZnVuY3Rpb24gKHZpc2l0LCB2aXNpdFJvb3QpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb25Nb3VudCA9IGZ1bmN0aW9uIG9uTW91bnQoY29tcG9uZW50LCBkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvb3ROb2RlSURNYXAuc2V0KGNvbXBvbmVudC5fcm9vdE5vZGVJRCwgY29tcG9uZW50KSwgdmlzaXQoY29tcG9uZW50LCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICB3YWxrUm9vdHMocmVuZGVyZXIuTW91bnQuX2luc3RhbmNlc0J5UmVhY3RSb290SUQgfHwgcmVuZGVyZXIuTW91bnQuX2luc3RhbmNlc0J5Q29udGFpbmVySUQsIG9uTW91bnQsIHZpc2l0Um9vdCwgaXNQcmUwMTMpOwogICAgICAgICAgICAgICAgfSwgZXh0cmFzLmNsZWFudXAgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgb2xkTWV0aG9kcyAmJiAocmVuZGVyZXIuQ29tcG9uZW50ID8gcmVzdG9yZU1hbnkocmVuZGVyZXIuQ29tcG9uZW50Lk1peGluLCBvbGRNZXRob2RzKSA6IHJlc3RvcmVNYW55KHJlbmRlcmVyLlJlY29uY2lsZXIsIG9sZE1ldGhvZHMpKSwgb2xkUmVuZGVyUm9vdCAmJiAocmVuZGVyZXIuTW91bnQuX3JlbmRlck5ld1Jvb3RDb21wb25lbnQgPSBvbGRSZW5kZXJSb290KSwgb2xkUmVuZGVyQ29tcG9uZW50ICYmIChyZW5kZXJlci5Nb3VudC5yZW5kZXJDb21wb25lbnQgPSBvbGRSZW5kZXJDb21wb25lbnQpLCBvbGRNZXRob2RzID0gbnVsbCwgb2xkUmVuZGVyUm9vdCA9IG51bGwsIG9sZFJlbmRlckNvbXBvbmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICB9LCBleHRyYXM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHdhbGtSb290cyhyb290cywgb25Nb3VudCwgb25Sb290LCBpc1ByZTAxMykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiByb290cykgewogICAgICAgICAgICAgICAgICAgIHdhbGtOb2RlKHJvb3RzW25hbWVdLCBvbk1vdW50LCBpc1ByZTAxMyksIG9uUm9vdChyb290c1tuYW1lXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHdhbGtOb2RlKGludGVybmFsSW5zdGFuY2UsIG9uTW91bnQsIGlzUHJlMDEzKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGlzUHJlMDEzID8gZ2V0RGF0YTAxMihpbnRlcm5hbEluc3RhbmNlKSA6IGdldERhdGEoaW50ZXJuYWxJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBkYXRhLmNoaWxkcmVuICYmIEFycmF5LmlzQXJyYXkoZGF0YS5jaGlsZHJlbikgJiYgZGF0YS5jaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uIChjaGlsZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB3YWxrTm9kZShjaGlsZCwgb25Nb3VudCwgaXNQcmUwMTMpOwogICAgICAgICAgICAgICAgfSksIG9uTW91bnQoaW50ZXJuYWxJbnN0YW5jZSwgZGF0YSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29yYXRlUmVzdWx0KG9iaiwgYXR0ciwgZm4pIHsKICAgICAgICAgICAgICAgIHZhciBvbGQgPSBvYmpbYXR0cl07CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqW2F0dHJdID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcyA9IG9sZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmbihyZXMpLCByZXM7CiAgICAgICAgICAgICAgICB9LCBvbGQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29yYXRlKG9iaiwgYXR0ciwgZm4pIHsKICAgICAgICAgICAgICAgIHZhciBvbGQgPSBvYmpbYXR0cl07CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqW2F0dHJdID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcyA9IG9sZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpLCByZXM7CiAgICAgICAgICAgICAgICB9LCBvbGQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29yYXRlTWFueShzb3VyY2UsIGZucykgewogICAgICAgICAgICAgICAgdmFyIG9sZHMgPSB7fTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIGZucykgewogICAgICAgICAgICAgICAgICAgIG9sZHNbbmFtZV0gPSBkZWNvcmF0ZShzb3VyY2UsIG5hbWUsIGZuc1tuYW1lXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIG9sZHM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVNYW55KHNvdXJjZSwgb2xkcykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBvbGRzKSB7CiAgICAgICAgICAgICAgICAgICAgc291cmNlW25hbWVdID0gb2xkc1tuYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGdldERhdGEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM2KSwKICAgICAgICAgICAgICAgIGdldERhdGEwMTIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQxKSwKICAgICAgICAgICAgICAgIGF0dGFjaFJlbmRlcmVyRmliZXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQyKTsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gYXR0YWNoUmVuZGVyZXI7CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXREYXRhKGludGVybmFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgcHJvcHMgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICB1cGRhdGVyID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBuYW1lID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICB0eXBlID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBrZXkgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIHJlZiA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgc291cmNlID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBwdWJsaWNJbnN0YW5jZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgbm9kZVR5cGUgPSAiTmF0aXZlIjsKICAgICAgICAgICAgICAgIGlmICgib2JqZWN0IiAhPT0gKCJ1bmRlZmluZWQiID09IHR5cGVvZiBpbnRlcm5hbEluc3RhbmNlID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKGludGVybmFsSW5zdGFuY2UpKSkgbm9kZVR5cGUgPSAiVGV4dCIsIHRleHQgPSBpbnRlcm5hbEluc3RhbmNlICsgIiI7ZWxzZSBpZiAobnVsbCA9PT0gaW50ZXJuYWxJbnN0YW5jZS5fY3VycmVudEVsZW1lbnQgfHwgaW50ZXJuYWxJbnN0YW5jZS5fY3VycmVudEVsZW1lbnQgPT09ICExKSBub2RlVHlwZSA9ICJFbXB0eSI7ZWxzZSBpZiAoaW50ZXJuYWxJbnN0YW5jZS5fcmVuZGVyZWRDb21wb25lbnQpIG5vZGVUeXBlID0gIk5hdGl2ZVdyYXBwZXIiLCBjaGlsZHJlbiA9IFtpbnRlcm5hbEluc3RhbmNlLl9yZW5kZXJlZENvbXBvbmVudF0sIHByb3BzID0gaW50ZXJuYWxJbnN0YW5jZS5faW5zdGFuY2UucHJvcHMsIHN0YXRlID0gaW50ZXJuYWxJbnN0YW5jZS5faW5zdGFuY2Uuc3RhdGUsIGNvbnRleHQgPSBpbnRlcm5hbEluc3RhbmNlLl9pbnN0YW5jZS5jb250ZXh0LCBjb250ZXh0ICYmIDAgPT09IE9iamVjdC5rZXlzKGNvbnRleHQpLmxlbmd0aCAmJiAoY29udGV4dCA9IG51bGwpO2Vsc2UgaWYgKGludGVybmFsSW5zdGFuY2UuX3JlbmRlcmVkQ2hpbGRyZW4pIGNoaWxkcmVuID0gY2hpbGRyZW5MaXN0KGludGVybmFsSW5zdGFuY2UuX3JlbmRlcmVkQ2hpbGRyZW4pO2Vsc2UgaWYgKGludGVybmFsSW5zdGFuY2UuX2N1cnJlbnRFbGVtZW50ICYmIGludGVybmFsSW5zdGFuY2UuX2N1cnJlbnRFbGVtZW50LnByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVuZmlsdGVyZWRDaGlsZHJlbiA9IGludGVybmFsSW5zdGFuY2UuX2N1cnJlbnRFbGVtZW50LnByb3BzLmNoaWxkcmVuLAogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJlZENoaWxkcmVuID0gW107CiAgICAgICAgICAgICAgICAgICAgdHJhdmVyc2VBbGxDaGlsZHJlbkltcGwodW5maWx0ZXJlZENoaWxkcmVuLCAiIiwgZnVuY3Rpb24gKF90cmF2ZXJzZUNvbnRleHQsIGNoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZFR5cGUgPSAidW5kZWZpbmVkIiA9PSB0eXBlb2YgY2hpbGQgPyAidW5kZWZpbmVkIiA6IF90eXBlb2YoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAic3RyaW5nIiAhPT0gY2hpbGRUeXBlICYmICJudW1iZXIiICE9PSBjaGlsZFR5cGUgfHwgZmlsdGVyZWRDaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICB9KSwgY2hpbGRyZW4gPSBmaWx0ZXJlZENoaWxkcmVuLmxlbmd0aCA8PSAxID8gZmlsdGVyZWRDaGlsZHJlbi5sZW5ndGggPyBTdHJpbmcoZmlsdGVyZWRDaGlsZHJlblswXSkgOiB2b2lkIDAgOiBmaWx0ZXJlZENoaWxkcmVuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghcHJvcHMgJiYgaW50ZXJuYWxJbnN0YW5jZS5fY3VycmVudEVsZW1lbnQgJiYgaW50ZXJuYWxJbnN0YW5jZS5fY3VycmVudEVsZW1lbnQucHJvcHMgJiYgKHByb3BzID0gaW50ZXJuYWxJbnN0YW5jZS5fY3VycmVudEVsZW1lbnQucHJvcHMpLCBudWxsICE9IGludGVybmFsSW5zdGFuY2UuX2N1cnJlbnRFbGVtZW50ICYmICh0eXBlID0gaW50ZXJuYWxJbnN0YW5jZS5fY3VycmVudEVsZW1lbnQudHlwZSwgaW50ZXJuYWxJbnN0YW5jZS5fY3VycmVudEVsZW1lbnQua2V5ICYmIChrZXkgPSBTdHJpbmcoaW50ZXJuYWxJbnN0YW5jZS5fY3VycmVudEVsZW1lbnQua2V5KSksIHNvdXJjZSA9IGludGVybmFsSW5zdGFuY2UuX2N1cnJlbnRFbGVtZW50Ll9zb3VyY2UsIHJlZiA9IGludGVybmFsSW5zdGFuY2UuX2N1cnJlbnRFbGVtZW50LnJlZiwgInN0cmluZyIgPT0gdHlwZW9mIHR5cGUgPyAobmFtZSA9IHR5cGUsIG51bGwgIT0gaW50ZXJuYWxJbnN0YW5jZS5fbmF0aXZlTm9kZSAmJiAocHVibGljSW5zdGFuY2UgPSBpbnRlcm5hbEluc3RhbmNlLl9uYXRpdmVOb2RlKSwgbnVsbCAhPSBpbnRlcm5hbEluc3RhbmNlLl9ob3N0Tm9kZSAmJiAocHVibGljSW5zdGFuY2UgPSBpbnRlcm5hbEluc3RhbmNlLl9ob3N0Tm9kZSkpIDogImZ1bmN0aW9uIiA9PSB0eXBlb2YgdHlwZSA/IChub2RlVHlwZSA9ICJDb21wb3NpdGUiLCBuYW1lID0gZ2V0RGlzcGxheU5hbWUodHlwZSksIGludGVybmFsSW5zdGFuY2UuX3JlbmRlcmVkQ29tcG9uZW50ICYmIChpbnRlcm5hbEluc3RhbmNlLl9jdXJyZW50RWxlbWVudC5wcm9wcyA9PT0gaW50ZXJuYWxJbnN0YW5jZS5fcmVuZGVyZWRDb21wb25lbnQuX2N1cnJlbnRFbGVtZW50IHx8IGludGVybmFsSW5zdGFuY2UuX2N1cnJlbnRFbGVtZW50LnR5cGUuaXNSZWFjdFRvcExldmVsV3JhcHBlcikgJiYgKG5vZGVUeXBlID0gIldyYXBwZXIiKSwgbnVsbCA9PT0gbmFtZSAmJiAobmFtZSA9ICJObyBkaXNwbGF5IG5hbWUiKSkgOiAic3RyaW5nIiA9PSB0eXBlb2YgaW50ZXJuYWxJbnN0YW5jZS5fc3RyaW5nVGV4dCA/IChub2RlVHlwZSA9ICJUZXh0IiwgdGV4dCA9IGludGVybmFsSW5zdGFuY2UuX3N0cmluZ1RleHQpIDogbmFtZSA9IGdldERpc3BsYXlOYW1lKHR5cGUpKSwgaW50ZXJuYWxJbnN0YW5jZS5faW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5zdCA9IGludGVybmFsSW5zdGFuY2UuX2luc3RhbmNlLAogICAgICAgICAgICAgICAgICAgICAgICBmb3JjZVVwZGF0ZSA9IGluc3QuZm9yY2VVcGRhdGUgfHwgaW5zdC51cGRhdGVyICYmIGluc3QudXBkYXRlci5lbnF1ZXVlRm9yY2VVcGRhdGUgJiYgZnVuY3Rpb24gKGNiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluc3QudXBkYXRlci5lbnF1ZXVlRm9yY2VVcGRhdGUodGhpcywgY2IsICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZXIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFN0YXRlOiBpbnN0LnNldFN0YXRlICYmIGluc3Quc2V0U3RhdGUuYmluZChpbnN0KSwKICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2VVcGRhdGU6IGZvcmNlVXBkYXRlICYmIGZvcmNlVXBkYXRlLmJpbmQoaW5zdCksCiAgICAgICAgICAgICAgICAgICAgICAgIHNldEluUHJvcHM6IGZvcmNlVXBkYXRlICYmIHNldEluUHJvcHMuYmluZChudWxsLCBpbnRlcm5hbEluc3RhbmNlLCBmb3JjZVVwZGF0ZSksCiAgICAgICAgICAgICAgICAgICAgICAgIHNldEluU3RhdGU6IGluc3QuZm9yY2VVcGRhdGUgJiYgc2V0SW5TdGF0ZS5iaW5kKG51bGwsIGluc3QpLAogICAgICAgICAgICAgICAgICAgICAgICBzZXRJbkNvbnRleHQ6IGZvcmNlVXBkYXRlICYmIHNldEluQ29udGV4dC5iaW5kKG51bGwsIGluc3QsIGZvcmNlVXBkYXRlKQogICAgICAgICAgICAgICAgICAgIH0sICJmdW5jdGlvbiIgPT0gdHlwZW9mIHR5cGUgJiYgKHB1YmxpY0luc3RhbmNlID0gaW5zdCksIGluc3QuX3JlbmRlcmVkQ2hpbGRyZW4gJiYgKGNoaWxkcmVuID0gY2hpbGRyZW5MaXN0KGluc3QuX3JlbmRlcmVkQ2hpbGRyZW4pKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIiA9PSB0eXBlb2YgaW50ZXJuYWxJbnN0YW5jZS5zZXROYXRpdmVQcm9wcyAmJiAodXBkYXRlciA9IHsKICAgICAgICAgICAgICAgICAgICBzZXROYXRpdmVQcm9wczogZnVuY3Rpb24gc2V0TmF0aXZlUHJvcHMobmF0aXZlUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJuYWxJbnN0YW5jZS5zZXROYXRpdmVQcm9wcyhuYXRpdmVQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSksIHsKICAgICAgICAgICAgICAgICAgICBub2RlVHlwZTogbm9kZVR5cGUsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgICAgICByZWY6IHJlZiwKICAgICAgICAgICAgICAgICAgICBzb3VyY2U6IHNvdXJjZSwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgIHByb3BzOiBwcm9wcywKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogc3RhdGUsCiAgICAgICAgICAgICAgICAgICAgY29udGV4dDogY29udGV4dCwKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogY2hpbGRyZW4sCiAgICAgICAgICAgICAgICAgICAgdGV4dDogdGV4dCwKICAgICAgICAgICAgICAgICAgICB1cGRhdGVyOiB1cGRhdGVyLAogICAgICAgICAgICAgICAgICAgIHB1YmxpY0luc3RhbmNlOiBwdWJsaWNJbnN0YW5jZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gc2V0SW5Qcm9wcyhpbnRlcm5hbEluc3QsIGZvcmNlVXBkYXRlLCBwYXRoLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBpbnRlcm5hbEluc3QuX2N1cnJlbnRFbGVtZW50OwogICAgICAgICAgICAgICAgaW50ZXJuYWxJbnN0Ll9jdXJyZW50RWxlbWVudCA9IF9leHRlbmRzKHt9LCBlbGVtZW50LCB7CiAgICAgICAgICAgICAgICAgICAgcHJvcHM6IGNvcHlXaXRoU2V0KGVsZW1lbnQucHJvcHMsIHBhdGgsIHZhbHVlKQogICAgICAgICAgICAgICAgfSksIGZvcmNlVXBkYXRlLmNhbGwoaW50ZXJuYWxJbnN0Ll9pbnN0YW5jZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHNldEluU3RhdGUoaW5zdCwgcGF0aCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHNldEluKGluc3Quc3RhdGUsIHBhdGgsIHZhbHVlKSwgaW5zdC5mb3JjZVVwZGF0ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBzZXRJbkNvbnRleHQoaW5zdCwgZm9yY2VVcGRhdGUsIHBhdGgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICBzZXRJbihpbnN0LmNvbnRleHQsIHBhdGgsIHZhbHVlKSwgZm9yY2VVcGRhdGUuY2FsbChpbnN0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gc2V0SW4ob2JqLCBwYXRoLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGxhc3QgPSBwYXRoLnBvcCgpLAogICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IHBhdGgucmVkdWNlKGZ1bmN0aW9uIChvYmpfLCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9ial8gPyBvYmpfW2F0dHJdIDogbnVsbDsKICAgICAgICAgICAgICAgIH0sIG9iaik7CiAgICAgICAgICAgICAgICBwYXJlbnQgJiYgKHBhcmVudFtsYXN0XSA9IHZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gY2hpbGRyZW5MaXN0KGNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzID0gW107CgogICAgICAgICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBjaGlsZHJlbikgewogICAgICAgICAgICAgICAgICAgIHJlcy5wdXNoKGNoaWxkcmVuW25hbWVdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgX2V4dGVuZHMgPSBPYmplY3QuYXNzaWduIHx8IGZ1bmN0aW9uICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNvdXJjZSA9IGFyZ3VtZW50c1tpXTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc291cmNlLCBrZXkpICYmICh0YXJnZXRba2V5XSA9IHNvdXJjZVtrZXldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIF90eXBlb2YgPSAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgInN5bWJvbCIgPT0gdHlwZW9mICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLml0ZXJhdG9yIDogIkBAaXRlcmF0b3IiKSA/IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqOwogICAgICAgICAgICB9IDogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5wcm90b3R5cGUgOiAiQEBwcm90b3R5cGUiKSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNvcHlXaXRoU2V0ID0gX193ZWJwYWNrX3JlcXVpcmVfXygzNyksCiAgICAgICAgICAgICAgICBnZXREaXNwbGF5TmFtZSA9IF9fd2VicGFja19yZXF1aXJlX18oMzgpLAogICAgICAgICAgICAgICAgdHJhdmVyc2VBbGxDaGlsZHJlbkltcGwgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM5KTsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZ2V0RGF0YTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvcHlXaXRoU2V0SW1wbChvYmosIHBhdGgsIGlkeCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmIChpZHggPj0gcGF0aC5sZW5ndGgpIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoW2lkeF0sCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZCA9IEFycmF5LmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogX2V4dGVuZHMoe30sIG9iaik7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZFtrZXldID0gY29weVdpdGhTZXRJbXBsKG9ialtrZXldLCBwYXRoLCBpZHggKyAxLCB2YWx1ZSksIHVwZGF0ZWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvcHlXaXRoU2V0KG9iaiwgcGF0aCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aFNldEltcGwob2JqLCBwYXRoLCAwLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBfZXh0ZW5kcyA9IE9iamVjdC5hc3NpZ24gfHwgZnVuY3Rpb24gKHRhcmdldCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc291cmNlID0gYXJndW1lbnRzW2ldOwoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIGtleSkgJiYgKHRhcmdldFtrZXldID0gc291cmNlW2tleV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBjb3B5V2l0aFNldDsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGdldERpc3BsYXlOYW1lKHR5cGUpIHsKICAgICAgICAgICAgICAgIGlmIChjYWNoZWREaXNwbGF5TmFtZXMuaGFzKHR5cGUpKSByZXR1cm4gY2FjaGVkRGlzcGxheU5hbWVzLmdldCh0eXBlKTsKICAgICAgICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICJzdHJpbmciID09IHR5cGVvZiB0eXBlLmRpc3BsYXlOYW1lICYmIChkaXNwbGF5TmFtZSA9IHR5cGUuZGlzcGxheU5hbWUpLCBkaXNwbGF5TmFtZSB8fCAoZGlzcGxheU5hbWUgPSB0eXBlLm5hbWUgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGRpc3BsYXlOYW1lLm1hdGNoKEZCX01PRFVMRV9SRSk7CgogICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBtYXRjaFsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlTmFtZSA9IG1hdGNoWzJdOwogICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudE5hbWUgJiYgbW9kdWxlTmFtZSAmJiAobW9kdWxlTmFtZSA9PT0gY29tcG9uZW50TmFtZSB8fCBtb2R1bGVOYW1lLnN0YXJ0c1dpdGgoY29tcG9uZW50TmFtZSArICIuIikpICYmIChkaXNwbGF5TmFtZSA9IGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWREaXNwbGF5TmFtZXMuc2V0KHR5cGUsIGRpc3BsYXlOYW1lKSwgZGlzcGxheU5hbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBGQl9NT0RVTEVfUkUgPSAvXiguKikgXFtmcm9tICguKilcXSQvLAogICAgICAgICAgICAgICAgY2FjaGVkRGlzcGxheU5hbWVzID0gbmV3IFdlYWtNYXAoKTsKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBnZXREaXNwbGF5TmFtZTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGVzY2FwZShrZXkpIHsKICAgICAgICAgICAgICAgIHZhciBlc2NhcGVSZWdleCA9IC9bPTpdL2csCiAgICAgICAgICAgICAgICAgICAgZXNjYXBlckxvb2t1cCA9IHsKICAgICAgICAgICAgICAgICAgICAiPSI6ICI9MCIsCiAgICAgICAgICAgICAgICAgICAgIjoiOiAiPTIiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGVzY2FwZWRTdHJpbmcgPSAoIiIgKyBrZXkpLnJlcGxhY2UoZXNjYXBlUmVnZXgsIGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlc2NhcGVyTG9va3VwW21hdGNoXTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuICIkIiArIGVzY2FwZWRTdHJpbmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudEtleShjb21wb25lbnQsIGluZGV4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIm9iamVjdCIgPT09ICgidW5kZWZpbmVkIiA9PSB0eXBlb2YgY29tcG9uZW50ID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKGNvbXBvbmVudCkpICYmIG51bGwgIT09IGNvbXBvbmVudCAmJiBudWxsICE9IGNvbXBvbmVudC5rZXkgPyBlc2NhcGUoY29tcG9uZW50LmtleSkgOiBpbmRleC50b1N0cmluZygzNik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHRyYXZlcnNlQWxsQ2hpbGRyZW5JbXBsKGNoaWxkcmVuLCBuYW1lU29GYXIsIGNhbGxiYWNrLCB0cmF2ZXJzZUNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHZhciB0eXBlID0gInVuZGVmaW5lZCIgPT0gdHlwZW9mIGNoaWxkcmVuID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKGNoaWxkcmVuKTsKICAgICAgICAgICAgICAgIGlmICgidW5kZWZpbmVkIiAhPT0gdHlwZSAmJiAiYm9vbGVhbiIgIT09IHR5cGUgfHwgKGNoaWxkcmVuID0gbnVsbCksIG51bGwgPT09IGNoaWxkcmVuIHx8ICJzdHJpbmciID09PSB0eXBlIHx8ICJudW1iZXIiID09PSB0eXBlIHx8ICJvYmplY3QiID09PSB0eXBlICYmIGNoaWxkcmVuLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHJldHVybiBjYWxsYmFjayh0cmF2ZXJzZUNvbnRleHQsIGNoaWxkcmVuLCAiIiA9PT0gbmFtZVNvRmFyID8gU0VQQVJBVE9SICsgZ2V0Q29tcG9uZW50S2V5KGNoaWxkcmVuLCAwKSA6IG5hbWVTb0ZhciksIDE7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQsCiAgICAgICAgICAgICAgICAgICAgbmV4dE5hbWUsCiAgICAgICAgICAgICAgICAgICAgc3VidHJlZUNvdW50ID0gMCwKICAgICAgICAgICAgICAgICAgICBuZXh0TmFtZVByZWZpeCA9ICIiID09PSBuYW1lU29GYXIgPyBTRVBBUkFUT1IgOiBuYW1lU29GYXIgKyBTVUJTRVBBUkFUT1I7CiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjaGlsZHJlbikpIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkcmVuW2ldLCBuZXh0TmFtZSA9IG5leHROYW1lUHJlZml4ICsgZ2V0Q29tcG9uZW50S2V5KGNoaWxkLCBpKSwgc3VidHJlZUNvdW50ICs9IHRyYXZlcnNlQWxsQ2hpbGRyZW5JbXBsKGNoaWxkLCBuZXh0TmFtZSwgY2FsbGJhY2ssIHRyYXZlcnNlQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gSVRFUkFUT1JfU1lNQk9MICYmIGNoaWxkcmVuW0lURVJBVE9SX1NZTUJPTF0gfHwgY2hpbGRyZW5bRkFVWF9JVEVSQVRPUl9TWU1CT0xdOwogICAgICAgICAgICAgICAgICAgIGlmICgiZnVuY3Rpb24iID09IHR5cGVvZiBpdGVyYXRvckZuKSBmb3IgKHZhciBzdGVwLCBpdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChjaGlsZHJlbiksIGlpID0gMDsgIShzdGVwID0gaXRlcmF0b3IubmV4dCgpKS5kb25lOykgewogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IHN0ZXAudmFsdWUsIG5leHROYW1lID0gbmV4dE5hbWVQcmVmaXggKyBnZXRDb21wb25lbnRLZXkoY2hpbGQsIGlpKyspLCBzdWJ0cmVlQ291bnQgKz0gdHJhdmVyc2VBbGxDaGlsZHJlbkltcGwoY2hpbGQsIG5leHROYW1lLCBjYWxsYmFjaywgdHJhdmVyc2VDb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCJvYmplY3QiID09PSB0eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhZGRlbmR1bSA9ICIgSWYgeW91IG1lYW50IHRvIHJlbmRlciBhIGNvbGxlY3Rpb24gb2YgY2hpbGRyZW4sIHVzZSBhbiBhcnJheSBpbnN0ZWFkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlblN0cmluZyA9ICIiICsgY2hpbGRyZW47CiAgICAgICAgICAgICAgICAgICAgICAgIGludmFyaWFudCghMSwgIlRoZSBSZWFjdCBEZXZ0b29scyBjYW5ub3QgcmVuZGVyIGFuIG9iamVjdCBhcyBhIGNoaWxkLiAoZm91bmQ6ICVzKS4lcyIsICJbb2JqZWN0IE9iamVjdF0iID09PSBjaGlsZHJlblN0cmluZyA/ICJvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMoY2hpbGRyZW4pLmpvaW4oIiwgIikgKyAifSIgOiBjaGlsZHJlblN0cmluZywgYWRkZW5kdW0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBzdWJ0cmVlQ291bnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBfdHlwZW9mID0gImZ1bmN0aW9uIiA9PSB0eXBlb2YgU3ltYm9sICYmICJzeW1ib2wiID09IHR5cGVvZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5pdGVyYXRvciA6ICJAQGl0ZXJhdG9yIikgPyBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIG9iajsKICAgICAgICAgICAgfSA6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiBvYmogJiYgImZ1bmN0aW9uIiA9PSB0eXBlb2YgU3ltYm9sICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wucHJvdG90eXBlIDogIkBAcHJvdG90eXBlIikgPyAic3ltYm9sIiA6IHR5cGVvZiBvYmo7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnZhcmlhbnQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQwKSwKICAgICAgICAgICAgICAgIFNFUEFSQVRPUiA9ICIuIiwKICAgICAgICAgICAgICAgIFNVQlNFUEFSQVRPUiA9ICI6IiwKICAgICAgICAgICAgICAgIEZBVVhfSVRFUkFUT1JfU1lNQk9MID0gIkBAaXRlcmF0b3IiLAogICAgICAgICAgICAgICAgSVRFUkFUT1JfU1lNQk9MID0gImZ1bmN0aW9uIiA9PSB0eXBlb2YgU3ltYm9sICYmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLml0ZXJhdG9yIDogIkBAaXRlcmF0b3IiKSwKICAgICAgICAgICAgICAgIFJFQUNUX0VMRU1FTlRfVFlQRSA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiBTeW1ib2xbImZvciJdICYmIFN5bWJvbFsiZm9yIl0oInJlYWN0LmVsZW1lbnQiKSB8fCA2MDEwMzsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gdHJhdmVyc2VBbGxDaGlsZHJlbkltcGw7CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBmdW5jdGlvbiBpbnZhcmlhbnQoY29uZGl0aW9uLCBmb3JtYXQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgICAgICAgIGlmICghY29uZGl0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yOwogICAgICAgICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IGZvcm1hdCkgZXJyb3IgPSBuZXcgRXJyb3IoIk1pbmlmaWVkIGV4Y2VwdGlvbiBvY2N1cnJlZDsgdXNlIHRoZSBub24tbWluaWZpZWQgZGV2IGVudmlyb25tZW50IGZvciB0aGUgZnVsbCBlcnJvciBtZXNzYWdlIGFuZCBhZGRpdGlvbmFsIGhlbHBmdWwgd2FybmluZ3MuIik7ZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW2EsIGIsIGMsIGQsIGUsIGZdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnSW5kZXggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvciA9IG5ldyBFcnJvcihmb3JtYXQucmVwbGFjZSgvJXMvZywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3NbYXJnSW5kZXgrK107CiAgICAgICAgICAgICAgICAgICAgICAgIH0pKSwgZXJyb3IubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3IuZnJhbWVzVG9Qb3AgPSAxLCBlcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBpbnZhcmlhbnQ7CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXREYXRhMDEyKGludGVybmFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgcHJvcHMgPSBpbnRlcm5hbEluc3RhbmNlLnByb3BzLAogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gaW50ZXJuYWxJbnN0YW5jZS5zdGF0ZSwKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gaW50ZXJuYWxJbnN0YW5jZS5jb250ZXh0LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZXIgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIHR5cGUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIGtleSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgcmVmID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBwdWJsaWNJbnN0YW5jZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgbm9kZVR5cGUgPSAiTmF0aXZlIjsKICAgICAgICAgICAgICAgIHJldHVybiBpbnRlcm5hbEluc3RhbmNlLl9yZW5kZXJlZENvbXBvbmVudCA/IChub2RlVHlwZSA9ICJXcmFwcGVyIiwgY2hpbGRyZW4gPSBbaW50ZXJuYWxJbnN0YW5jZS5fcmVuZGVyZWRDb21wb25lbnRdLCBjb250ZXh0ICYmIDAgPT09IE9iamVjdC5rZXlzKGNvbnRleHQpLmxlbmd0aCAmJiAoY29udGV4dCA9IG51bGwpKSA6IGludGVybmFsSW5zdGFuY2UuX3JlbmRlcmVkQ2hpbGRyZW4gPyAobmFtZSA9IGludGVybmFsSW5zdGFuY2UuY29uc3RydWN0b3IuZGlzcGxheU5hbWUsIGNoaWxkcmVuID0gY2hpbGRyZW5MaXN0KGludGVybmFsSW5zdGFuY2UuX3JlbmRlcmVkQ2hpbGRyZW4pKSA6ICJzdHJpbmciID09IHR5cGVvZiBwcm9wcy5jaGlsZHJlbiAmJiAobmFtZSA9IGludGVybmFsSW5zdGFuY2UuY29uc3RydWN0b3IuZGlzcGxheU5hbWUsIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW4sIG5vZGVUeXBlID0gIk5hdGl2ZSIpLCAhcHJvcHMgJiYgaW50ZXJuYWxJbnN0YW5jZS5fY3VycmVudEVsZW1lbnQgJiYgaW50ZXJuYWxJbnN0YW5jZS5fY3VycmVudEVsZW1lbnQucHJvcHMgJiYgKHByb3BzID0gaW50ZXJuYWxJbnN0YW5jZS5fY3VycmVudEVsZW1lbnQucHJvcHMpLCBpbnRlcm5hbEluc3RhbmNlLl9jdXJyZW50RWxlbWVudCAmJiAodHlwZSA9IGludGVybmFsSW5zdGFuY2UuX2N1cnJlbnRFbGVtZW50LnR5cGUsIGludGVybmFsSW5zdGFuY2UuX2N1cnJlbnRFbGVtZW50LmtleSAmJiAoa2V5ID0gU3RyaW5nKGludGVybmFsSW5zdGFuY2UuX2N1cnJlbnRFbGVtZW50LmtleSkpLCByZWYgPSBpbnRlcm5hbEluc3RhbmNlLl9jdXJyZW50RWxlbWVudC5yZWYsICJzdHJpbmciID09IHR5cGVvZiB0eXBlID8gbmFtZSA9IHR5cGUgOiAobm9kZVR5cGUgPSAiQ29tcG9zaXRlIiwgbmFtZSA9IHR5cGUuZGlzcGxheU5hbWUsIG5hbWUgfHwgKG5hbWUgPSAiTm8gZGlzcGxheSBuYW1lIikpKSwgbmFtZSB8fCAobmFtZSA9IGludGVybmFsSW5zdGFuY2UuY29uc3RydWN0b3IuZGlzcGxheU5hbWUgfHwgIk5vIGRpc3BsYXkgbmFtZSIsIG5vZGVUeXBlID0gIkNvbXBvc2l0ZSIpLCAic3RyaW5nIiA9PSB0eXBlb2YgcHJvcHMgJiYgKG5vZGVUeXBlID0gIlRleHQiLCB0ZXh0ID0gcHJvcHMsIHByb3BzID0gbnVsbCwgbmFtZSA9IG51bGwpLCBpbnRlcm5hbEluc3RhbmNlLmZvcmNlVXBkYXRlICYmICh1cGRhdGVyID0gewogICAgICAgICAgICAgICAgICAgIHNldFN0YXRlOiBpbnRlcm5hbEluc3RhbmNlLnNldFN0YXRlLmJpbmQoaW50ZXJuYWxJbnN0YW5jZSksCiAgICAgICAgICAgICAgICAgICAgZm9yY2VVcGRhdGU6IGludGVybmFsSW5zdGFuY2UuZm9yY2VVcGRhdGUuYmluZChpbnRlcm5hbEluc3RhbmNlKSwKICAgICAgICAgICAgICAgICAgICBzZXRJblByb3BzOiBpbnRlcm5hbEluc3RhbmNlLmZvcmNlVXBkYXRlICYmIHNldEluUHJvcHMuYmluZChudWxsLCBpbnRlcm5hbEluc3RhbmNlKSwKICAgICAgICAgICAgICAgICAgICBzZXRJblN0YXRlOiBpbnRlcm5hbEluc3RhbmNlLmZvcmNlVXBkYXRlICYmIHNldEluU3RhdGUuYmluZChudWxsLCBpbnRlcm5hbEluc3RhbmNlKSwKICAgICAgICAgICAgICAgICAgICBzZXRJbkNvbnRleHQ6IGludGVybmFsSW5zdGFuY2UuZm9yY2VVcGRhdGUgJiYgc2V0SW5Db250ZXh0LmJpbmQobnVsbCwgaW50ZXJuYWxJbnN0YW5jZSkKICAgICAgICAgICAgICAgIH0sIHB1YmxpY0luc3RhbmNlID0gaW50ZXJuYWxJbnN0YW5jZSksIHsKICAgICAgICAgICAgICAgICAgICBub2RlVHlwZTogbm9kZVR5cGUsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgICAgICByZWY6IHJlZiwKICAgICAgICAgICAgICAgICAgICBzb3VyY2U6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICBwcm9wczogcHJvcHMsCiAgICAgICAgICAgICAgICAgICAgc3RhdGU6IHN0YXRlLAogICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IGNoaWxkcmVuLAogICAgICAgICAgICAgICAgICAgIHRleHQ6IHRleHQsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlcjogdXBkYXRlciwKICAgICAgICAgICAgICAgICAgICBwdWJsaWNJbnN0YW5jZTogcHVibGljSW5zdGFuY2UKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHNldEluUHJvcHMoaW5zdCwgcGF0aCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIGluc3QucHJvcHMgPSBjb3B5V2l0aFNldChpbnN0LnByb3BzLCBwYXRoLCB2YWx1ZSksIGluc3QuZm9yY2VVcGRhdGUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gc2V0SW5TdGF0ZShpbnN0LCBwYXRoLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgc2V0SW4oaW5zdC5zdGF0ZSwgcGF0aCwgdmFsdWUpLCBpbnN0LmZvcmNlVXBkYXRlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHNldEluQ29udGV4dChpbnN0LCBwYXRoLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgc2V0SW4oaW5zdC5jb250ZXh0LCBwYXRoLCB2YWx1ZSksIGluc3QuZm9yY2VVcGRhdGUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gc2V0SW4ob2JqLCBwYXRoLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGxhc3QgPSBwYXRoLnBvcCgpLAogICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IHBhdGgucmVkdWNlKGZ1bmN0aW9uIChvYmpfLCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9ial8gPyBvYmpfW2F0dHJdIDogbnVsbDsKICAgICAgICAgICAgICAgIH0sIG9iaik7CiAgICAgICAgICAgICAgICBwYXJlbnQgJiYgKHBhcmVudFtsYXN0XSA9IHZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gY2hpbGRyZW5MaXN0KGNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzID0gW107CgogICAgICAgICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBjaGlsZHJlbikgewogICAgICAgICAgICAgICAgICAgIHJlcy5wdXNoKGNoaWxkcmVuW25hbWVdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY29weVdpdGhTZXQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM3KTsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZ2V0RGF0YTAxMjsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGF0dGFjaFJlbmRlcmVyRmliZXIoaG9vaywgcmlkLCByZW5kZXJlcikgewogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0T3BhcXVlTm9kZShmaWJlcikgewogICAgICAgICAgICAgICAgICAgIGlmIChvcGFxdWVOb2Rlcy5oYXMoZmliZXIpKSByZXR1cm4gZmliZXI7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbCAhPSBhbHRlcm5hdGUgJiYgb3BhcXVlTm9kZXMuaGFzKGFsdGVybmF0ZSkgPyBhbHRlcm5hdGUgOiAob3BhcXVlTm9kZXMuYWRkKGZpYmVyKSwgZmliZXIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhc0RhdGFDaGFuZ2VkKHByZXZGaWJlciwgbmV4dEZpYmVyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZGaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgobmV4dEZpYmVyLmVmZmVjdFRhZyAmIFBlcmZvcm1lZFdvcmspICE9PSBQZXJmb3JtZWRXb3JrKSByZXR1cm4gITE7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2RmliZXIuc3RhdGVOb2RlLmNvbnRleHQgIT09IG5leHRGaWJlci5zdGF0ZU5vZGUuY29udGV4dCkgcmV0dXJuICEwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobnVsbCAhPSBuZXh0RmliZXIudXBkYXRlUXVldWUgJiYgbmV4dEZpYmVyLnVwZGF0ZVF1ZXVlLmhhc0ZvcmNlVXBkYXRlKSByZXR1cm4gITA7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJldkZpYmVyLm1lbW9pemVkUHJvcHMgIT09IG5leHRGaWJlci5tZW1vaXplZFByb3BzIHx8IHByZXZGaWJlci5tZW1vaXplZFN0YXRlICE9PSBuZXh0RmliZXIubWVtb2l6ZWRTdGF0ZSB8fCBwcmV2RmliZXIucmVmICE9PSBuZXh0RmliZXIucmVmIHx8IHByZXZGaWJlci5fZGVidWdTb3VyY2UgIT09IG5leHRGaWJlci5fZGVidWdTb3VyY2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZmx1c2hQZW5kaW5nRXZlbnRzKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBldmVudHMgPSBwZW5kaW5nRXZlbnRzOwogICAgICAgICAgICAgICAgICAgIHBlbmRpbmdFdmVudHMgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gZXZlbnRzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBob29rLmVtaXQoZXZlbnQudHlwZSwgZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlTW91bnQoZmliZXIpIHsKICAgICAgICAgICAgICAgICAgICBwZW5kaW5nRXZlbnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBpbnRlcm5hbEluc3RhbmNlOiBnZXRPcGFxdWVOb2RlKGZpYmVyKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZ2V0RGF0YUZpYmVyKGZpYmVyLCBnZXRPcGFxdWVOb2RlKSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZXI6IHJpZCwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm1vdW50IgogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHZhciBpc1Jvb3QgPSBmaWJlci50YWcgPT09IEhvc3RSb290OwogICAgICAgICAgICAgICAgICAgIGlzUm9vdCAmJiBwZW5kaW5nRXZlbnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBpbnRlcm5hbEluc3RhbmNlOiBnZXRPcGFxdWVOb2RlKGZpYmVyKSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZXI6IHJpZCwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogInJvb3QiCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVVwZGF0ZUlmTmVjZXNzYXJ5KGZpYmVyLCBoYXNDaGlsZE9yZGVyQ2hhbmdlZCkgewogICAgICAgICAgICAgICAgICAgIChoYXNDaGlsZE9yZGVyQ2hhbmdlZCB8fCBoYXNEYXRhQ2hhbmdlZChmaWJlci5hbHRlcm5hdGUsIGZpYmVyKSkgJiYgcGVuZGluZ0V2ZW50cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJuYWxJbnN0YW5jZTogZ2V0T3BhcXVlTm9kZShmaWJlciksCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGdldERhdGFGaWJlcihmaWJlciwgZ2V0T3BhcXVlTm9kZSksCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyOiByaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJ1cGRhdGUiCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVVubW91bnQoZmliZXIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNSb290ID0gZmliZXIudGFnID09PSBIb3N0Um9vdCwKICAgICAgICAgICAgICAgICAgICAgICAgb3BhcXVlTm9kZSA9IGdldE9wYXF1ZU5vZGUoZmliZXIpLAogICAgICAgICAgICAgICAgICAgICAgICBldmVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJuYWxJbnN0YW5jZTogb3BhcXVlTm9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZXI6IHJpZCwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogInVubW91bnQiCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBpc1Jvb3QgPyBwZW5kaW5nRXZlbnRzLnB1c2goZXZlbnQpIDogcGVuZGluZ0V2ZW50cy51bnNoaWZ0KGV2ZW50KSwgb3BhcXVlTm9kZXNbImRlbGV0ZSJdKG9wYXF1ZU5vZGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIG1vdW50RmliZXIoZmliZXIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwoKICAgICAgICAgICAgICAgICAgICBvdXRlcjogZm9yICg7OykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5jaGlsZCkgbm9kZS5jaGlsZFsicmV0dXJuIl0gPSBub2RlLCBub2RlID0gbm9kZS5jaGlsZDtlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnF1ZXVlTW91bnQobm9kZSksIG5vZGUgPT0gZmliZXIpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUuc2libGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoOyBub2RlWyJyZXR1cm4iXTspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPSBub2RlWyJyZXR1cm4iXSwgZW5xdWV1ZU1vdW50KG5vZGUpLCBub2RlID09IGZpYmVyKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5zaWJsaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnNpYmxpbmdbInJldHVybiJdID0gbm9kZVsicmV0dXJuIl0sIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuc2libGluZ1sicmV0dXJuIl0gPSBub2RlWyJyZXR1cm4iXSwgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVGaWJlcihuZXh0RmliZXIsIHByZXZGaWJlcikgewogICAgICAgICAgICAgICAgICAgIHZhciBoYXNDaGlsZE9yZGVyQ2hhbmdlZCA9ICExOwoKICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEZpYmVyLmNoaWxkICE9PSBwcmV2RmliZXIuY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbmV4dENoaWxkID0gbmV4dEZpYmVyLmNoaWxkLCBwcmV2Q2hpbGRBdFNhbWVJbmRleCA9IHByZXZGaWJlci5jaGlsZDsgbmV4dENoaWxkOykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRDaGlsZC5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldkNoaWxkID0gbmV4dENoaWxkLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVGaWJlcihuZXh0Q2hpbGQsIHByZXZDaGlsZCksIGhhc0NoaWxkT3JkZXJDaGFuZ2VkIHx8IHByZXZDaGlsZCA9PT0gcHJldkNoaWxkQXRTYW1lSW5kZXggfHwgKGhhc0NoaWxkT3JkZXJDaGFuZ2VkID0gITApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIG1vdW50RmliZXIobmV4dENoaWxkKSwgaGFzQ2hpbGRPcmRlckNoYW5nZWQgfHwgKGhhc0NoaWxkT3JkZXJDaGFuZ2VkID0gITApOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRDaGlsZCA9IG5leHRDaGlsZC5zaWJsaW5nLCBoYXNDaGlsZE9yZGVyQ2hhbmdlZCB8fCBudWxsID09IHByZXZDaGlsZEF0U2FtZUluZGV4IHx8IChwcmV2Q2hpbGRBdFNhbWVJbmRleCA9IHByZXZDaGlsZEF0U2FtZUluZGV4LnNpYmxpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBoYXNDaGlsZE9yZGVyQ2hhbmdlZCB8fCBudWxsID09IHByZXZDaGlsZEF0U2FtZUluZGV4IHx8IChoYXNDaGlsZE9yZGVyQ2hhbmdlZCA9ICEwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGVucXVldWVVcGRhdGVJZk5lY2Vzc2FyeShuZXh0RmliZXIsIGhhc0NoaWxkT3JkZXJDaGFuZ2VkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiB3YWxrVHJlZSgpIHsKICAgICAgICAgICAgICAgICAgICBob29rLmdldEZpYmVyUm9vdHMocmlkKS5mb3JFYWNoKGZ1bmN0aW9uIChyb290KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vdW50RmliZXIocm9vdC5jdXJyZW50KTsKICAgICAgICAgICAgICAgICAgICB9KSwgZmx1c2hQZW5kaW5nRXZlbnRzKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2xlYW51cCgpIHt9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlQ29tbWl0RmliZXJVbm1vdW50KGZpYmVyKSB7CiAgICAgICAgICAgICAgICAgICAgZW5xdWV1ZVVubW91bnQoZmliZXIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNvbW1pdEZpYmVyUm9vdChyb290KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSByb290LmN1cnJlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgIGFsdGVybmF0ZSA9IGN1cnJlbnQuYWx0ZXJuYXRlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3YXNNb3VudGVkID0gbnVsbCAhPSBhbHRlcm5hdGUubWVtb2l6ZWRTdGF0ZSAmJiBudWxsICE9IGFsdGVybmF0ZS5tZW1vaXplZFN0YXRlLmVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc01vdW50ZWQgPSBudWxsICE9IGN1cnJlbnQubWVtb2l6ZWRTdGF0ZSAmJiBudWxsICE9IGN1cnJlbnQubWVtb2l6ZWRTdGF0ZS5lbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAhd2FzTW91bnRlZCAmJiBpc01vdW50ZWQgPyBtb3VudEZpYmVyKGN1cnJlbnQpIDogd2FzTW91bnRlZCAmJiBpc01vdW50ZWQgPyB1cGRhdGVGaWJlcihjdXJyZW50LCBhbHRlcm5hdGUpIDogd2FzTW91bnRlZCAmJiAhaXNNb3VudGVkICYmIGVucXVldWVVbm1vdW50KGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBtb3VudEZpYmVyKGN1cnJlbnQpOwoKICAgICAgICAgICAgICAgICAgICBmbHVzaFBlbmRpbmdFdmVudHMoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXROYXRpdmVGcm9tUmVhY3RFbGVtZW50KGZpYmVyKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9wYXF1ZU5vZGUgPSBmaWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZSA9IHJlbmRlcmVyLmZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyKG9wYXF1ZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaG9zdEluc3RhbmNlOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0UmVhY3RFbGVtZW50RnJvbU5hdGl2ZShob3N0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmliZXIgPSByZW5kZXJlci5maW5kRmliZXJCeUhvc3RJbnN0YW5jZShob3N0SW5zdGFuY2UpOwoKICAgICAgICAgICAgICAgICAgICBpZiAobnVsbCAhPSBmaWJlcikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3BhcXVlTm9kZSA9IGdldE9wYXF1ZU5vZGUoZmliZXIpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3BhcXVlTm9kZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBvcGFxdWVOb2RlcyA9IG5ldyBTZXQoKSwKICAgICAgICAgICAgICAgICAgICBwZW5kaW5nRXZlbnRzID0gW107CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIGdldE5hdGl2ZUZyb21SZWFjdEVsZW1lbnQ6IGdldE5hdGl2ZUZyb21SZWFjdEVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgZ2V0UmVhY3RFbGVtZW50RnJvbU5hdGl2ZTogZ2V0UmVhY3RFbGVtZW50RnJvbU5hdGl2ZSwKICAgICAgICAgICAgICAgICAgICBoYW5kbGVDb21taXRGaWJlclJvb3Q6IGhhbmRsZUNvbW1pdEZpYmVyUm9vdCwKICAgICAgICAgICAgICAgICAgICBoYW5kbGVDb21taXRGaWJlclVubW91bnQ6IGhhbmRsZUNvbW1pdEZpYmVyVW5tb3VudCwKICAgICAgICAgICAgICAgICAgICBjbGVhbnVwOiBjbGVhbnVwLAogICAgICAgICAgICAgICAgICAgIHdhbGtUcmVlOiB3YWxrVHJlZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGdldERhdGFGaWJlciA9IF9fd2VicGFja19yZXF1aXJlX18oNDMpLAogICAgICAgICAgICAgICAgX3JlcXVpcmUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQ0KSwKICAgICAgICAgICAgICAgIENsYXNzQ29tcG9uZW50ID0gX3JlcXVpcmUuQ2xhc3NDb21wb25lbnQsCiAgICAgICAgICAgICAgICBIb3N0Um9vdCA9IF9yZXF1aXJlLkhvc3RSb290LAogICAgICAgICAgICAgICAgUGVyZm9ybWVkV29yayA9IDE7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGF0dGFjaFJlbmRlcmVyRmliZXI7CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXREYXRhRmliZXIoZmliZXIsIGdldE9wYXF1ZU5vZGUpIHsKICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZSwKICAgICAgICAgICAgICAgICAgICBrZXkgPSBmaWJlci5rZXksCiAgICAgICAgICAgICAgICAgICAgcmVmID0gZmliZXIucmVmLAogICAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGZpYmVyLl9kZWJ1Z1NvdXJjZSwKICAgICAgICAgICAgICAgICAgICBwdWJsaWNJbnN0YW5jZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgcHJvcHMgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIHN0YXRlID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbiA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlciA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgbm9kZVR5cGUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIG5hbWUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIHRleHQgPSBudWxsOwoKICAgICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbmFsQ29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVUeXBlID0gIkNvbXBvc2l0ZSIsIG5hbWUgPSBnZXREaXNwbGF5TmFtZShmaWJlci50eXBlKSwgcHVibGljSW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGUsIHByb3BzID0gZmliZXIubWVtb2l6ZWRQcm9wcywgc3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlLCBudWxsICE9IHB1YmxpY0luc3RhbmNlICYmIChjb250ZXh0ID0gcHVibGljSW5zdGFuY2UuY29udGV4dCwgY29udGV4dCAmJiAwID09PSBPYmplY3Qua2V5cyhjb250ZXh0KS5sZW5ndGggJiYgKGNvbnRleHQgPSBudWxsKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbnN0ID0gcHVibGljSW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGluc3QgJiYgKHVwZGF0ZXIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRTdGF0ZTogaW5zdC5zZXRTdGF0ZSAmJiBpbnN0LnNldFN0YXRlLmJpbmQoaW5zdCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JjZVVwZGF0ZTogaW5zdC5mb3JjZVVwZGF0ZSAmJiBpbnN0LmZvcmNlVXBkYXRlLmJpbmQoaW5zdCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRJblByb3BzOiBpbnN0LmZvcmNlVXBkYXRlICYmIHNldEluUHJvcHMuYmluZChudWxsLCBmaWJlciksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRJblN0YXRlOiBpbnN0LmZvcmNlVXBkYXRlICYmIHNldEluU3RhdGUuYmluZChudWxsLCBpbnN0KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldEluQ29udGV4dDogaW5zdC5mb3JjZVVwZGF0ZSAmJiBzZXRJbkNvbnRleHQuYmluZChudWxsLCBpbnN0KQogICAgICAgICAgICAgICAgICAgICAgICB9KSwgY2hpbGRyZW4gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVUeXBlID0gIldyYXBwZXIiLCBjaGlsZHJlbiA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgICAgICAgICAgICBub2RlVHlwZSA9ICJQb3J0YWwiLCBuYW1lID0gIlJlYWN0UG9ydGFsIiwgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IGZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvCiAgICAgICAgICAgICAgICAgICAgICAgIH0sIGNoaWxkcmVuID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVUeXBlID0gIk5hdGl2ZSIsIG5hbWUgPSBmaWJlci50eXBlLCBuYW1lID0gbmFtZS5yZXBsYWNlKCJ0b3BzZWNyZXQtIiwgIiIpLCBwdWJsaWNJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZSwgcHJvcHMgPSBmaWJlci5tZW1vaXplZFByb3BzLCBjaGlsZHJlbiA9ICJzdHJpbmciID09IHR5cGVvZiBwcm9wcy5jaGlsZHJlbiB8fCAibnVtYmVyIiA9PSB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPyBwcm9wcy5jaGlsZHJlbi50b1N0cmluZygpIDogW10sICJmdW5jdGlvbiIgPT0gdHlwZW9mIGZpYmVyLnN0YXRlTm9kZS5zZXROYXRpdmVQcm9wcyAmJiAodXBkYXRlciA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldE5hdGl2ZVByb3BzOiBmdW5jdGlvbiBzZXROYXRpdmVQcm9wcyhuYXRpdmVQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZS5zZXROYXRpdmVQcm9wcyhuYXRpdmVQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVR5cGUgPSAiVGV4dCIsIHRleHQgPSBmaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY2FzZSBGcmFnbWVudDoKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVR5cGUgPSAiV3JhcHBlciIsIGNoaWxkcmVuID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBub2RlVHlwZSA9ICJOYXRpdmUiLCBwcm9wcyA9IGZpYmVyLm1lbW9pemVkUHJvcHMsIG5hbWUgPSAiVE9ET19OT1RfSU1QTEVNRU5URURfWUVUIiwgY2hpbGRyZW4gPSBbXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjaGlsZHJlbikpIGZvciAodmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7IGNoaWxkOykgewogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goZ2V0T3BhcXVlTm9kZShjaGlsZCkpLCBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIG5vZGVUeXBlOiBub2RlVHlwZSwKICAgICAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICAgICAgICAgIHJlZjogcmVmLAogICAgICAgICAgICAgICAgICAgIHNvdXJjZTogc291cmNlLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgcHJvcHM6IHByb3BzLAogICAgICAgICAgICAgICAgICAgIHN0YXRlOiBzdGF0ZSwKICAgICAgICAgICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0LAogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBjaGlsZHJlbiwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0ZXh0LAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZXI6IHVwZGF0ZXIsCiAgICAgICAgICAgICAgICAgICAgcHVibGljSW5zdGFuY2U6IHB1YmxpY0luc3RhbmNlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBzZXRJblByb3BzKGZpYmVyLCBwYXRoLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGluc3QgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aFNldChpbnN0LnByb3BzLCBwYXRoLCB2YWx1ZSksIGZpYmVyLmFsdGVybmF0ZSAmJiAoZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wcyksIGZpYmVyLnN0YXRlTm9kZS5mb3JjZVVwZGF0ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBzZXRJblN0YXRlKGluc3QsIHBhdGgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICBzZXRJbihpbnN0LnN0YXRlLCBwYXRoLCB2YWx1ZSksIGluc3QuZm9yY2VVcGRhdGUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gc2V0SW5Db250ZXh0KGluc3QsIHBhdGgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICBzZXRJbihpbnN0LmNvbnRleHQsIHBhdGgsIHZhbHVlKSwgaW5zdC5mb3JjZVVwZGF0ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBzZXRJbihvYmosIHBhdGgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgbGFzdCA9IHBhdGgucG9wKCksCiAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gcGF0aC5yZWR1Y2UoZnVuY3Rpb24gKG9ial8sIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JqXyA/IG9ial9bYXR0cl0gOiBudWxsOwogICAgICAgICAgICAgICAgfSwgb2JqKTsKICAgICAgICAgICAgICAgIHBhcmVudCAmJiAocGFyZW50W2xhc3RdID0gdmFsdWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY29weVdpdGhTZXQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM3KSwKICAgICAgICAgICAgICAgIGdldERpc3BsYXlOYW1lID0gX193ZWJwYWNrX3JlcXVpcmVfXygzOCksCiAgICAgICAgICAgICAgICBfcmVxdWlyZSA9IF9fd2VicGFja19yZXF1aXJlX18oNDQpLAogICAgICAgICAgICAgICAgRnVuY3Rpb25hbENvbXBvbmVudCA9IF9yZXF1aXJlLkZ1bmN0aW9uYWxDb21wb25lbnQsCiAgICAgICAgICAgICAgICBDbGFzc0NvbXBvbmVudCA9IF9yZXF1aXJlLkNsYXNzQ29tcG9uZW50LAogICAgICAgICAgICAgICAgSG9zdFJvb3QgPSBfcmVxdWlyZS5Ib3N0Um9vdCwKICAgICAgICAgICAgICAgIEhvc3RQb3J0YWwgPSBfcmVxdWlyZS5Ib3N0UG9ydGFsLAogICAgICAgICAgICAgICAgSG9zdENvbXBvbmVudCA9IF9yZXF1aXJlLkhvc3RDb21wb25lbnQsCiAgICAgICAgICAgICAgICBIb3N0VGV4dCA9IF9yZXF1aXJlLkhvc3RUZXh0LAogICAgICAgICAgICAgICAgRnJhZ21lbnQgPSBfcmVxdWlyZS5GcmFnbWVudDsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZ2V0RGF0YUZpYmVyOwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgICAgICAgICAgICBJbmRldGVybWluYXRlQ29tcG9uZW50OiAwLAogICAgICAgICAgICAgICAgRnVuY3Rpb25hbENvbXBvbmVudDogMSwKICAgICAgICAgICAgICAgIENsYXNzQ29tcG9uZW50OiAyLAogICAgICAgICAgICAgICAgSG9zdFJvb3Q6IDMsCiAgICAgICAgICAgICAgICBIb3N0UG9ydGFsOiA0LAogICAgICAgICAgICAgICAgSG9zdENvbXBvbmVudDogNSwKICAgICAgICAgICAgICAgIEhvc3RUZXh0OiA2LAogICAgICAgICAgICAgICAgQ29yb3V0aW5lQ29tcG9uZW50OiA3LAogICAgICAgICAgICAgICAgQ29yb3V0aW5lSGFuZGxlclBoYXNlOiA4LAogICAgICAgICAgICAgICAgWWllbGRDb21wb25lbnQ6IDksCiAgICAgICAgICAgICAgICBGcmFnbWVudDogMTAKICAgICAgICAgICAgfTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBrZXkgaW4gb2JqID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6ICEwLAogICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICAgICAgICAgICAgICAgICAgd3JpdGFibGU6ICEwCiAgICAgICAgICAgICAgICB9KSA6IG9ialtrZXldID0gdmFsdWUsIG9iajsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gbWVhc3VyZVN0eWxlKGFnZW50LCBicmlkZ2UsIHJlc29sdmVSTlN0eWxlLCBpZCkgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBhZ2VudC5lbGVtZW50RGF0YS5nZXQoaWQpOwogICAgICAgICAgICAgICAgaWYgKCFub2RlIHx8ICFub2RlLnByb3BzKSByZXR1cm4gdm9pZCBicmlkZ2Uuc2VuZCgicm4tc3R5bGU6bWVhc3VyZSIsIHt9KTsKICAgICAgICAgICAgICAgIHZhciBzdHlsZSA9IHJlc29sdmVSTlN0eWxlKG5vZGUucHJvcHMuc3R5bGUpOwogICAgICAgICAgICAgICAgc3R5bGVPdmVycmlkZXNCeUhvc3RDb21wb25lbnRJZFtpZF0gJiYgKHN0eWxlID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHN0eWxlLCBzdHlsZU92ZXJyaWRlc0J5SG9zdENvbXBvbmVudElkW2lkXSkpOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5wdWJsaWNJbnN0YW5jZTsKICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZSAmJiBpbnN0YW5jZS5tZWFzdXJlID8gdm9pZCBpbnN0YW5jZS5tZWFzdXJlKGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsZWZ0LCB0b3ApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIm51bWJlciIgIT0gdHlwZW9mIHgpIHJldHVybiB2b2lkIGJyaWRnZS5zZW5kKCJybi1zdHlsZTptZWFzdXJlIiwgewogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2YXIgbWFyZ2luID0gc3R5bGUgJiYgcmVzb2x2ZUJveFN0eWxlKCJtYXJnaW4iLCBzdHlsZSkgfHwgYmxhbmssCiAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmcgPSBzdHlsZSAmJiByZXNvbHZlQm94U3R5bGUoInBhZGRpbmciLCBzdHlsZSkgfHwgYmxhbms7CiAgICAgICAgICAgICAgICAgICAgYnJpZGdlLnNlbmQoInJuLXN0eWxlOm1lYXN1cmUiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZSwKICAgICAgICAgICAgICAgICAgICAgICAgbWVhc3VyZWRMYXlvdXQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHg6IHgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5OiB5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHdpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiBsZWZ0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiB0b3AsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJnaW46IG1hcmdpbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6IHBhZGRpbmcKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkgOiB2b2lkIGJyaWRnZS5zZW5kKCJybi1zdHlsZTptZWFzdXJlIiwgewogICAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHNoYWxsb3dDbG9uZShvYmopIHsKICAgICAgICAgICAgICAgIHZhciBub2JqID0ge307CgogICAgICAgICAgICAgICAgZm9yICh2YXIgbiBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgICBub2JqW25dID0gb2JqW25dOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBub2JqOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiByZW5hbWVTdHlsZShhZ2VudCwgaWQsIG9sZE5hbWUsIG5ld05hbWUsIHZhbCkgewogICAgICAgICAgICAgICAgdmFyIF9yZWYzLAogICAgICAgICAgICAgICAgICAgIGRhdGEgPSBhZ2VudC5lbGVtZW50RGF0YS5nZXQoaWQpLAogICAgICAgICAgICAgICAgICAgIG5ld1N0eWxlID0gbmV3TmFtZSA/IChfcmVmMyA9IHt9LCBfZGVmaW5lUHJvcGVydHkoX3JlZjMsIG9sZE5hbWUsIHZvaWQgMCksIF9kZWZpbmVQcm9wZXJ0eShfcmVmMywgbmV3TmFtZSwgdmFsKSwgX3JlZjMpIDogX2RlZmluZVByb3BlcnR5KHt9LCBvbGROYW1lLCB2b2lkIDApOwoKICAgICAgICAgICAgICAgIGlmIChkYXRhICYmIGRhdGEudXBkYXRlciAmJiBkYXRhLnVwZGF0ZXIuc2V0SW5Qcm9wcykgewogICAgICAgICAgICAgICAgICAgIHZhciBjdXN0b21TdHlsZSwKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGUgPSBkYXRhICYmIGRhdGEucHJvcHMgJiYgZGF0YS5wcm9wcy5zdHlsZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc3R5bGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsYXN0TGVuZ3RoID0gc3R5bGUubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgIm9iamVjdCIgIT09IF90eXBlb2Yoc3R5bGVbbGFzdExlbmd0aF0pIHx8IEFycmF5LmlzQXJyYXkoc3R5bGVbbGFzdExlbmd0aF0pID8gKHN0eWxlID0gc3R5bGUuY29uY2F0KFtuZXdTdHlsZV0pLCBkYXRhLnVwZGF0ZXIuc2V0SW5Qcm9wcyhbInN0eWxlIl0sIHN0eWxlKSkgOiAoY3VzdG9tU3R5bGUgPSBzaGFsbG93Q2xvbmUoc3R5bGVbbGFzdExlbmd0aF0pLCBkZWxldGUgY3VzdG9tU3R5bGVbb2xkTmFtZV0sIG5ld05hbWUgPyBjdXN0b21TdHlsZVtuZXdOYW1lXSA9IHZhbCA6IGN1c3RvbVN0eWxlW29sZE5hbWVdID0gdm9pZCAwLCBkYXRhLnVwZGF0ZXIuc2V0SW5Qcm9wcyhbInN0eWxlIiwgbGFzdExlbmd0aF0sIGN1c3RvbVN0eWxlKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlICJvYmplY3QiID09PSAoInVuZGVmaW5lZCIgPT0gdHlwZW9mIHN0eWxlID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKHN0eWxlKSkgPyAoY3VzdG9tU3R5bGUgPSBzaGFsbG93Q2xvbmUoc3R5bGUpLCBkZWxldGUgY3VzdG9tU3R5bGVbb2xkTmFtZV0sIG5ld05hbWUgPyBjdXN0b21TdHlsZVtuZXdOYW1lXSA9IHZhbCA6IGN1c3RvbVN0eWxlW29sZE5hbWVdID0gdm9pZCAwLCBkYXRhLnVwZGF0ZXIuc2V0SW5Qcm9wcyhbInN0eWxlIl0sIGN1c3RvbVN0eWxlKSkgOiAoc3R5bGUgPSBbc3R5bGUsIG5ld1N0eWxlXSwgZGF0YS51cGRhdGVyLnNldEluUHJvcHMoWyJzdHlsZSJdLCBzdHlsZSkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIShkYXRhICYmIGRhdGEudXBkYXRlciAmJiBkYXRhLnVwZGF0ZXIuc2V0TmF0aXZlUHJvcHMpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgc3R5bGVPdmVycmlkZXNCeUhvc3RDb21wb25lbnRJZFtpZF0gPyBiYWJlbEhlbHBlcnMuZXh0ZW5kcyhzdHlsZU92ZXJyaWRlc0J5SG9zdENvbXBvbmVudElkW2lkXSwgbmV3U3R5bGUpIDogc3R5bGVPdmVycmlkZXNCeUhvc3RDb21wb25lbnRJZFtpZF0gPSBuZXdTdHlsZSwgZGF0YS51cGRhdGVyLnNldE5hdGl2ZVByb3BzKHsKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IG5ld1N0eWxlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYWdlbnQuZW1pdCgiaGlkZUhpZ2hsaWdodCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBzZXRTdHlsZShhZ2VudCwgaWQsIGF0dHIsIHZhbCkgewogICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBhZ2VudC5lbGVtZW50RGF0YS5nZXQoaWQpLAogICAgICAgICAgICAgICAgICAgIG5ld1N0eWxlID0gX2RlZmluZVByb3BlcnR5KHt9LCBhdHRyLCB2YWwpOwoKICAgICAgICAgICAgICAgIGlmIChkYXRhICYmIGRhdGEudXBkYXRlciAmJiBkYXRhLnVwZGF0ZXIuc2V0SW5Qcm9wcykgewogICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZSA9IGRhdGEucHJvcHMgJiYgZGF0YS5wcm9wcy5zdHlsZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc3R5bGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsYXN0TGVuZ3RoID0gc3R5bGUubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgIm9iamVjdCIgIT09IF90eXBlb2Yoc3R5bGVbbGFzdExlbmd0aF0pIHx8IEFycmF5LmlzQXJyYXkoc3R5bGVbbGFzdExlbmd0aF0pID8gKHN0eWxlID0gc3R5bGUuY29uY2F0KFtuZXdTdHlsZV0pLCBkYXRhLnVwZGF0ZXIuc2V0SW5Qcm9wcyhbInN0eWxlIl0sIHN0eWxlKSkgOiBkYXRhLnVwZGF0ZXIuc2V0SW5Qcm9wcyhbInN0eWxlIiwgbGFzdExlbmd0aCwgYXR0cl0sIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHN0eWxlID0gW3N0eWxlLCBuZXdTdHlsZV0sIGRhdGEudXBkYXRlci5zZXRJblByb3BzKFsic3R5bGUiXSwgc3R5bGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIShkYXRhICYmIGRhdGEudXBkYXRlciAmJiBkYXRhLnVwZGF0ZXIuc2V0TmF0aXZlUHJvcHMpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgc3R5bGVPdmVycmlkZXNCeUhvc3RDb21wb25lbnRJZFtpZF0gPyBiYWJlbEhlbHBlcnMuZXh0ZW5kcyhzdHlsZU92ZXJyaWRlc0J5SG9zdENvbXBvbmVudElkW2lkXSwgbmV3U3R5bGUpIDogc3R5bGVPdmVycmlkZXNCeUhvc3RDb21wb25lbnRJZFtpZF0gPSBuZXdTdHlsZSwgZGF0YS51cGRhdGVyLnNldE5hdGl2ZVByb3BzKHsKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IG5ld1N0eWxlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYWdlbnQuZW1pdCgiaGlkZUhpZ2hsaWdodCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgX3R5cGVvZiA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiAic3ltYm9sIiA9PSB0eXBlb2YgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciIpID8gZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmo7CiAgICAgICAgICAgIH0gOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqICYmICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiBvYmouY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvYmogIT09ICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLnByb3RvdHlwZSA6ICJAQHByb3RvdHlwZSIpID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOwogICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcmVzb2x2ZUJveFN0eWxlID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0NiksCiAgICAgICAgICAgICAgICBzdHlsZU92ZXJyaWRlc0J5SG9zdENvbXBvbmVudElkID0ge307CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChicmlkZ2UsIGFnZW50LCByZXNvbHZlUk5TdHlsZSkgewogICAgICAgICAgICAgICAgYnJpZGdlLm9uQ2FsbCgicm4tc3R5bGU6Z2V0IiwgZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBhZ2VudC5lbGVtZW50RGF0YS5nZXQoaWQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUucHJvcHMgPyByZXNvbHZlUk5TdHlsZShub2RlLnByb3BzLnN0eWxlKSA6IG51bGw7CiAgICAgICAgICAgICAgICB9KSwgYnJpZGdlLm9uKCJybi1zdHlsZTptZWFzdXJlIiwgZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgICAgICAgICAgICAgbWVhc3VyZVN0eWxlKGFnZW50LCBicmlkZ2UsIHJlc29sdmVSTlN0eWxlLCBpZCk7CiAgICAgICAgICAgICAgICB9KSwgYnJpZGdlLm9uKCJybi1zdHlsZTpyZW5hbWUiLCBmdW5jdGlvbiAoX3JlZikgewogICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IF9yZWYuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIG9sZE5hbWUgPSBfcmVmLm9sZE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld05hbWUgPSBfcmVmLm5ld05hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IF9yZWYudmFsOwogICAgICAgICAgICAgICAgICAgIHJlbmFtZVN0eWxlKGFnZW50LCBpZCwgb2xkTmFtZSwgbmV3TmFtZSwgdmFsKSwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtZWFzdXJlU3R5bGUoYWdlbnQsIGJyaWRnZSwgcmVzb2x2ZVJOU3R5bGUsIGlkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pLCBicmlkZ2Uub24oInJuLXN0eWxlOnNldCIsIGZ1bmN0aW9uIChfcmVmMikgewogICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IF9yZWYyLmlkLAogICAgICAgICAgICAgICAgICAgICAgICBhdHRyID0gX3JlZjIuYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gX3JlZjIudmFsOwogICAgICAgICAgICAgICAgICAgIHNldFN0eWxlKGFnZW50LCBpZCwgYXR0ciwgdmFsKSwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtZWFzdXJlU3R5bGUoYWdlbnQsIGJyaWRnZSwgcmVzb2x2ZVJOU3R5bGUsIGlkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGJsYW5rID0gewogICAgICAgICAgICAgICAgdG9wOiAwLAogICAgICAgICAgICAgICAgbGVmdDogMCwKICAgICAgICAgICAgICAgIHJpZ2h0OiAwLAogICAgICAgICAgICAgICAgYm90dG9tOiAwCiAgICAgICAgICAgIH07CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICBmdW5jdGlvbiByZXNvbHZlQm94U3R5bGUocHJlZml4LCBzdHlsZSkgewogICAgICAgICAgICAgICAgdmFyIHJlcyA9IHt9LAogICAgICAgICAgICAgICAgICAgIHN1YnMgPSBbInRvcCIsICJsZWZ0IiwgImJvdHRvbSIsICJyaWdodCJdLAogICAgICAgICAgICAgICAgICAgIHNldCA9ICExOwogICAgICAgICAgICAgICAgcmV0dXJuIHN1YnMuZm9yRWFjaChmdW5jdGlvbiAoc3ViKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzW3N1Yl0gPSBzdHlsZVtwcmVmaXhdIHx8IDA7CiAgICAgICAgICAgICAgICB9KSwgc3R5bGVbcHJlZml4XSAmJiAoc2V0ID0gITApLCBzdHlsZVtwcmVmaXggKyAiVmVydGljYWwiXSAmJiAocmVzLnRvcCA9IHJlcy5ib3R0b20gPSBzdHlsZVtwcmVmaXggKyAiVmVydGljYWwiXSwgc2V0ID0gITApLCBzdHlsZVtwcmVmaXggKyAiSG9yaXpvbnRhbCJdICYmIChyZXMubGVmdCA9IHJlcy5yaWdodCA9IHN0eWxlW3ByZWZpeCArICJIb3Jpem9udGFsIl0sIHNldCA9ICEwKSwgc3Vicy5mb3JFYWNoKGZ1bmN0aW9uIChzdWIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsID0gc3R5bGVbcHJlZml4ICsgY2FwRmlyc3Qoc3ViKV07CiAgICAgICAgICAgICAgICAgICAgdmFsICYmIChyZXNbc3ViXSA9IHZhbCwgc2V0ID0gITApOwogICAgICAgICAgICAgICAgfSksIHNldCA/IHJlcyA6IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGNhcEZpcnN0KHRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZXh0WzBdLnRvVXBwZXJDYXNlKCkgKyB0ZXh0LnNsaWNlKDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlc29sdmVCb3hTdHlsZTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29yYXRlKG9iaiwgYXR0ciwgZm4pIHsKICAgICAgICAgICAgICAgIHZhciBvbGQgPSBvYmpbYXR0cl07CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqW2F0dHJdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXMgPSBvbGQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKSwgcmVzOwogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIG9ialthdHRyXSA9IG9sZDsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb25FbmFibGVkID0gITE7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChicmlkZ2UsIGFnZW50LCBob29rKSB7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzZW5kU3RvcmVEYXRhKCkgewogICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkVuYWJsZWQgJiYgYnJpZGdlLnNlbmQoInJlbGF5OnN0b3JlIiwgewogICAgICAgICAgICAgICAgICAgICAgICBpZDogInJlbGF5OnN0b3JlIiwKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXM6IERlZmF1bHRTdG9yZURhdGEuZ2V0Tm9kZURhdGEoKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBzaG91bGRFbmFibGUgPSAhIWhvb2suX3JlbGF5SW50ZXJuYWxzOwoKICAgICAgICAgICAgICAgIGlmIChicmlkZ2Uub25DYWxsKCJyZWxheTpjaGVjayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2hvdWxkRW5hYmxlOwogICAgICAgICAgICAgICAgfSksIHNob3VsZEVuYWJsZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBfaG9vayRfcmVsYXlJbnRlcm5hbHMgPSBob29rLl9yZWxheUludGVybmFscywKICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdFN0b3JlRGF0YSA9IF9ob29rJF9yZWxheUludGVybmFscy5EZWZhdWx0U3RvcmVEYXRhLAogICAgICAgICAgICAgICAgICAgICAgICBzZXRSZXF1ZXN0TGlzdGVuZXIgPSBfaG9vayRfcmVsYXlJbnRlcm5hbHMuc2V0UmVxdWVzdExpc3RlbmVyOwogICAgICAgICAgICAgICAgICAgIGJyaWRnZS5vbkNhbGwoInJlbGF5OnN0b3JlOmVuYWJsZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uRW5hYmxlZCA9ICEwLCBzZW5kU3RvcmVEYXRhKCk7CiAgICAgICAgICAgICAgICAgICAgfSksIGJyaWRnZS5vbkNhbGwoInJlbGF5OnN0b3JlOmRpc2FibGUiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkVuYWJsZWQgPSAhMTsKICAgICAgICAgICAgICAgICAgICB9KSwgc2VuZFN0b3JlRGF0YSgpLCBkZWNvcmF0ZShEZWZhdWx0U3RvcmVEYXRhLCAiaGFuZGxlVXBkYXRlUGF5bG9hZCIsIHNlbmRTdG9yZURhdGEpLCBkZWNvcmF0ZShEZWZhdWx0U3RvcmVEYXRhLCAiaGFuZGxlUXVlcnlQYXlsb2FkIiwgc2VuZFN0b3JlRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlbW92ZUxpc3RlbmVyID0gc2V0UmVxdWVzdExpc3RlbmVyKGZ1bmN0aW9uIChldmVudCwgZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICBicmlkZ2Uuc2VuZChldmVudCwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaG9vay5vbigic2h1dGRvd24iLCByZW1vdmVMaXN0ZW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgICAgICB2YXIgSGlnaGxpZ2h0ZXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQ5KTsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaGwgPSBuZXcgSGlnaGxpZ2h0ZXIod2luZG93LCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgICAgIGFnZW50LnNlbGVjdEZyb21ET01Ob2RlKG5vZGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBhZ2VudC5vbigiaGlnaGxpZ2h0IiwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGwuaGlnaGxpZ2h0KGRhdGEubm9kZSwgZGF0YS5uYW1lKTsKICAgICAgICAgICAgICAgIH0pLCBhZ2VudC5vbigiaGlnaGxpZ2h0TWFueSIsIGZ1bmN0aW9uIChub2RlcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBobC5oaWdobGlnaHRNYW55KG5vZGVzKTsKICAgICAgICAgICAgICAgIH0pLCBhZ2VudC5vbigiaGlkZUhpZ2hsaWdodCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGwuaGlkZUhpZ2hsaWdodCgpOwogICAgICAgICAgICAgICAgfSksIGFnZW50Lm9uKCJyZWZyZXNoTXVsdGlPdmVybGF5IiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBobC5yZWZyZXNoTXVsdGlPdmVybGF5KCk7CiAgICAgICAgICAgICAgICB9KSwgYWdlbnQub24oInN0YXJ0SW5zcGVjdGluZyIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGwuc3RhcnRJbnNwZWN0aW5nKCk7CiAgICAgICAgICAgICAgICB9KSwgYWdlbnQub24oInN0b3BJbnNwZWN0aW5nIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBobC5zdG9wSW5zcGVjdGluZygpOwogICAgICAgICAgICAgICAgfSksIGFnZW50Lm9uKCJzaHV0ZG93biIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBobC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjYXB0dXJlU3Vic2NyaXB0aW9uKG9iaiwgZXZ0LCBjYikgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iai5hZGRFdmVudExpc3RlbmVyKGV2dCwgY2IsICEwKSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnQsIGNiLCAhMCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBtYWtlTWFnbmlmaWVyKCkgewogICAgICAgICAgICAgICAgdmFyIGJ1dHRvbiA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJidXR0b24iKTsKICAgICAgICAgICAgICAgIHJldHVybiBidXR0b24uaW5uZXJIVE1MID0gIiYjMTI4MjY5OyIsIGJ1dHRvbi5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAidHJhbnNwYXJlbnQiLCBidXR0b24uc3R5bGUuYm9yZGVyID0gIm5vbmUiLCBidXR0b24uc3R5bGUub3V0bGluZSA9ICJub25lIiwgYnV0dG9uLnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIiwgYnV0dG9uLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIiwgYnV0dG9uLnN0eWxlLmJvdHRvbSA9ICIxMHB4IiwgYnV0dG9uLnN0eWxlLnJpZ2h0ID0gIjEwcHgiLCBidXR0b24uc3R5bGUuZm9udFNpemUgPSAiMzBweCIsIGJ1dHRvbi5zdHlsZS56SW5kZXggPSAxZTcsIGJ1dHRvbjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIF9jcmVhdGVDbGFzcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8ICExLCBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9ICEwLCAidmFsdWUiIGluIGRlc2NyaXB0b3IgJiYgKGRlc2NyaXB0b3Iud3JpdGFibGUgPSAhMCksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvdG9Qcm9wcyAmJiBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyksIHN0YXRpY1Byb3BzICYmIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKSwgQ29uc3RydWN0b3I7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KCksCiAgICAgICAgICAgICAgICBPdmVybGF5ID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1MCksCiAgICAgICAgICAgICAgICBNdWx0aU92ZXJsYXkgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUyKSwKICAgICAgICAgICAgICAgIEhpZ2hsaWdodGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZnVuY3Rpb24gSGlnaGxpZ2h0ZXIod2luLCBvblNlbGVjdCkgewogICAgICAgICAgICAgICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBIaWdobGlnaHRlciksIHRoaXMuX3dpbiA9IHdpbiwgdGhpcy5fb25TZWxlY3QgPSBvblNlbGVjdCwgdGhpcy5fb3ZlcmxheSA9IG51bGwsIHRoaXMuX211bHRpT3ZlcmxheSA9IG51bGwsIHRoaXMuX3N1YnMgPSBbXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZUNsYXNzKEhpZ2hsaWdodGVyLCBbewogICAgICAgICAgICAgICAgICAgIGtleTogInN0YXJ0SW5zcGVjdGluZyIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbnNwZWN0aW5nID0gITAsIHRoaXMuX3N1YnMgPSBbY2FwdHVyZVN1YnNjcmlwdGlvbih0aGlzLl93aW4sICJtb3VzZW92ZXIiLCB0aGlzLm9uSG92ZXIuYmluZCh0aGlzKSksIGNhcHR1cmVTdWJzY3JpcHRpb24odGhpcy5fd2luLCAibW91c2Vkb3duIiwgdGhpcy5vbk1vdXNlRG93bi5iaW5kKHRoaXMpKSwgY2FwdHVyZVN1YnNjcmlwdGlvbih0aGlzLl93aW4sICJjbGljayIsIHRoaXMub25DbGljay5iaW5kKHRoaXMpKV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogInN0b3BJbnNwZWN0aW5nIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3N1YnMuZm9yRWFjaChmdW5jdGlvbiAodW5zdWIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1bnN1YigpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSwgdGhpcy5oaWRlSGlnaGxpZ2h0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogInJlbW92ZSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3BJbnNwZWN0aW5nKCksIHRoaXMuX2J1dHRvbiAmJiB0aGlzLl9idXR0b24ucGFyZW50Tm9kZSAmJiB0aGlzLl9idXR0b24ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLl9idXR0b24pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJoaWdobGlnaHQiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShub2RlLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlTXVsdGlPdmVybGF5KCksIG5vZGUubm9kZVR5cGUgIT09IE5vZGUuQ09NTUVOVF9OT0RFICYmICh0aGlzLl9vdmVybGF5IHx8ICh0aGlzLl9vdmVybGF5ID0gbmV3IE92ZXJsYXkodGhpcy5fd2luKSksIHRoaXMuX292ZXJsYXkuaW5zcGVjdChub2RlLCBuYW1lKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogImhpZ2hsaWdodE1hbnkiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShub2RlcykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZU92ZXJsYXkoKSwgdGhpcy5fbXVsdGlPdmVybGF5IHx8ICh0aGlzLl9tdWx0aU92ZXJsYXkgPSBuZXcgTXVsdGlPdmVybGF5KHRoaXMuX3dpbikpLCB0aGlzLl9tdWx0aU92ZXJsYXkuaGlnaGxpZ2h0TWFueShub2Rlcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogImhpZGVIaWdobGlnaHQiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5zcGVjdGluZyA9ICExLCB0aGlzLnJlbW92ZU92ZXJsYXkoKSwgdGhpcy5yZW1vdmVNdWx0aU92ZXJsYXkoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAicmVmcmVzaE11bHRpT3ZlcmxheSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9tdWx0aU92ZXJsYXkgJiYgdGhpcy5fbXVsdGlPdmVybGF5LnJlZnJlc2goKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAicmVtb3ZlT3ZlcmxheSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9vdmVybGF5ICYmICh0aGlzLl9vdmVybGF5LnJlbW92ZSgpLCB0aGlzLl9vdmVybGF5ID0gbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogInJlbW92ZU11bHRpT3ZlcmxheSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9tdWx0aU92ZXJsYXkgJiYgKHRoaXMuX211bHRpT3ZlcmxheS5yZW1vdmUoKSwgdGhpcy5fbXVsdGlPdmVybGF5ID0gbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogIm9uTW91c2VEb3duIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZXZ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3BlY3RpbmcgJiYgKGV2dC5wcmV2ZW50RGVmYXVsdCgpLCBldnQuc3RvcFByb3BhZ2F0aW9uKCksIGV2dC5jYW5jZWxCdWJibGUgPSAhMCwgdGhpcy5fb25TZWxlY3QoZXZ0LnRhcmdldCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJvbkNsaWNrIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZXZ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3BlY3RpbmcgJiYgKHRoaXMuX3N1YnMuZm9yRWFjaChmdW5jdGlvbiAodW5zdWIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1bnN1YigpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSwgZXZ0LnByZXZlbnREZWZhdWx0KCksIGV2dC5zdG9wUHJvcGFnYXRpb24oKSwgZXZ0LmNhbmNlbEJ1YmJsZSA9ICEwLCB0aGlzLmhpZGVIaWdobGlnaHQoKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogIm9uSG92ZXIiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShldnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5zcGVjdGluZyAmJiAoZXZ0LnByZXZlbnREZWZhdWx0KCksIGV2dC5zdG9wUHJvcGFnYXRpb24oKSwgZXZ0LmNhbmNlbEJ1YmJsZSA9ICEwLCB0aGlzLmhpZ2hsaWdodChldnQudGFyZ2V0KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogImluamVjdEJ1dHRvbiIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9idXR0b24gPSBtYWtlTWFnbmlmaWVyKCksIHRoaXMuX2J1dHRvbi5vbmNsaWNrID0gdGhpcy5zdGFydEluc3BlY3RpbmcuYmluZCh0aGlzKSwgdGhpcy5fd2luLmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5fYnV0dG9uKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9XSksIEhpZ2hsaWdodGVyOwogICAgICAgICAgICB9KCk7CgogICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IEhpZ2hsaWdodGVyOwogICAgICAgIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICAgICAgZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBmaW5kVGlwUG9zKGRpbXMsIHdpbikgewogICAgICAgICAgICAgICAgdmFyIHRvcCwKICAgICAgICAgICAgICAgICAgICB0aXBIZWlnaHQgPSAyMCwKICAgICAgICAgICAgICAgICAgICBtYXJnaW4gPSA1OwogICAgICAgICAgICAgICAgcmV0dXJuIHRvcCA9IGRpbXMudG9wICsgZGltcy5oZWlnaHQgKyB0aXBIZWlnaHQgPD0gd2luLmlubmVySGVpZ2h0ID8gZGltcy50b3AgKyBkaW1zLmhlaWdodCA8IDAgPyBtYXJnaW4gOiBkaW1zLnRvcCArIGRpbXMuaGVpZ2h0ICsgbWFyZ2luIDogZGltcy50b3AgLSB0aXBIZWlnaHQgPD0gd2luLmlubmVySGVpZ2h0ID8gZGltcy50b3AgLSB0aXBIZWlnaHQgLSBtYXJnaW4gPCBtYXJnaW4gPyBtYXJnaW4gOiBkaW1zLnRvcCAtIHRpcEhlaWdodCAtIG1hcmdpbiA6IHdpbi5pbm5lckhlaWdodCAtIHRpcEhlaWdodCAtIG1hcmdpbiwgdG9wICs9ICJweCIsIGRpbXMubGVmdCA8IDAgPyB7CiAgICAgICAgICAgICAgICAgICAgdG9wOiB0b3AsCiAgICAgICAgICAgICAgICAgICAgbGVmdDogbWFyZ2luCiAgICAgICAgICAgICAgICB9IDogZGltcy5sZWZ0ICsgMjAwID4gd2luLmlubmVyV2lkdGggPyB7CiAgICAgICAgICAgICAgICAgICAgdG9wOiB0b3AsCiAgICAgICAgICAgICAgICAgICAgcmlnaHQ6IG1hcmdpbgogICAgICAgICAgICAgICAgfSA6IHsKICAgICAgICAgICAgICAgICAgICB0b3A6IHRvcCwKICAgICAgICAgICAgICAgICAgICBsZWZ0OiBkaW1zLmxlZnQgKyBtYXJnaW4gKyAicHgiCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRFbGVtZW50RGltZW5zaW9ucyhkb21FbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsY3VsYXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIGJvcmRlckxlZnQ6ICtjYWxjdWxhdGVkU3R5bGUuYm9yZGVyTGVmdFdpZHRoLm1hdGNoKC9bMC05XSovKVswXSwKICAgICAgICAgICAgICAgICAgICBib3JkZXJSaWdodDogK2NhbGN1bGF0ZWRTdHlsZS5ib3JkZXJSaWdodFdpZHRoLm1hdGNoKC9bMC05XSovKVswXSwKICAgICAgICAgICAgICAgICAgICBib3JkZXJUb3A6ICtjYWxjdWxhdGVkU3R5bGUuYm9yZGVyVG9wV2lkdGgubWF0Y2goL1swLTldKi8pWzBdLAogICAgICAgICAgICAgICAgICAgIGJvcmRlckJvdHRvbTogK2NhbGN1bGF0ZWRTdHlsZS5ib3JkZXJCb3R0b21XaWR0aC5tYXRjaCgvWzAtOV0qLylbMF0sCiAgICAgICAgICAgICAgICAgICAgbWFyZ2luTGVmdDogK2NhbGN1bGF0ZWRTdHlsZS5tYXJnaW5MZWZ0Lm1hdGNoKC9bMC05XSovKVswXSwKICAgICAgICAgICAgICAgICAgICBtYXJnaW5SaWdodDogK2NhbGN1bGF0ZWRTdHlsZS5tYXJnaW5SaWdodC5tYXRjaCgvWzAtOV0qLylbMF0sCiAgICAgICAgICAgICAgICAgICAgbWFyZ2luVG9wOiArY2FsY3VsYXRlZFN0eWxlLm1hcmdpblRvcC5tYXRjaCgvWzAtOV0qLylbMF0sCiAgICAgICAgICAgICAgICAgICAgbWFyZ2luQm90dG9tOiArY2FsY3VsYXRlZFN0eWxlLm1hcmdpbkJvdHRvbS5tYXRjaCgvWzAtOV0qLylbMF0sCiAgICAgICAgICAgICAgICAgICAgcGFkZGluZ0xlZnQ6ICtjYWxjdWxhdGVkU3R5bGUucGFkZGluZ0xlZnQubWF0Y2goL1swLTldKi8pWzBdLAogICAgICAgICAgICAgICAgICAgIHBhZGRpbmdSaWdodDogK2NhbGN1bGF0ZWRTdHlsZS5wYWRkaW5nUmlnaHQubWF0Y2goL1swLTldKi8pWzBdLAogICAgICAgICAgICAgICAgICAgIHBhZGRpbmdUb3A6ICtjYWxjdWxhdGVkU3R5bGUucGFkZGluZ1RvcC5tYXRjaCgvWzAtOV0qLylbMF0sCiAgICAgICAgICAgICAgICAgICAgcGFkZGluZ0JvdHRvbTogK2NhbGN1bGF0ZWRTdHlsZS5wYWRkaW5nQm90dG9tLm1hdGNoKC9bMC05XSovKVswXQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0T3duZXJXaW5kb3cobm9kZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUub3duZXJEb2N1bWVudCA/IG5vZGUub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldyA6IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGdldE93bmVySWZyYW1lKG5vZGUpIHsKICAgICAgICAgICAgICAgIHZhciBub2RlV2luZG93ID0gZ2V0T3duZXJXaW5kb3cobm9kZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZVdpbmRvdyA/IG5vZGVXaW5kb3cuZnJhbWVFbGVtZW50IDogbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Qm91bmRpbmdDbGllbnRSZWN0V2l0aEJvcmRlck9mZnNldChub2RlKSB7CiAgICAgICAgICAgICAgICB2YXIgZGltZW5zaW9ucyA9IGdldEVsZW1lbnREaW1lbnNpb25zKG5vZGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIG1lcmdlUmVjdE9mZnNldHMoW25vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksIHsKICAgICAgICAgICAgICAgICAgICB0b3A6IGRpbWVuc2lvbnMuYm9yZGVyVG9wLAogICAgICAgICAgICAgICAgICAgIGxlZnQ6IGRpbWVuc2lvbnMuYm9yZGVyTGVmdCwKICAgICAgICAgICAgICAgICAgICBib3R0b206IGRpbWVuc2lvbnMuYm9yZGVyQm90dG9tLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiBkaW1lbnNpb25zLmJvcmRlclJpZ2h0LAogICAgICAgICAgICAgICAgICAgIHdpZHRoOiAwLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogMAogICAgICAgICAgICAgICAgfV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBtZXJnZVJlY3RPZmZzZXRzKHJlY3RzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVjdHMucmVkdWNlKGZ1bmN0aW9uIChwcmV2aW91c1JlY3QsIHJlY3QpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbCA9PSBwcmV2aW91c1JlY3QgPyByZWN0IDogewogICAgICAgICAgICAgICAgICAgICAgICB0b3A6IHByZXZpb3VzUmVjdC50b3AgKyByZWN0LnRvcCwKICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogcHJldmlvdXNSZWN0LmxlZnQgKyByZWN0LmxlZnQsCiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBwcmV2aW91c1JlY3Qud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogcHJldmlvdXNSZWN0LmhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgYm90dG9tOiBwcmV2aW91c1JlY3QuYm90dG9tICsgcmVjdC5ib3R0b20sCiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0OiBwcmV2aW91c1JlY3QucmlnaHQgKyByZWN0LnJpZ2h0CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBnZXROZXN0ZWRCb3VuZGluZ0NsaWVudFJlY3Qobm9kZSwgYm91bmRhcnlXaW5kb3cpIHsKICAgICAgICAgICAgICAgIHZhciBvd25lcklmcmFtZSA9IGdldE93bmVySWZyYW1lKG5vZGUpOwoKICAgICAgICAgICAgICAgIGlmIChvd25lcklmcmFtZSAmJiBvd25lcklmcmFtZSAhPT0gYm91bmRhcnlXaW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciByZWN0cyA9IFtub2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXSwgY3VycmVudElmcmFtZSA9IG93bmVySWZyYW1lLCBvbmx5T25lTW9yZSA9ICExOyBjdXJyZW50SWZyYW1lOykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVjdCA9IGdldEJvdW5kaW5nQ2xpZW50UmVjdFdpdGhCb3JkZXJPZmZzZXQoY3VycmVudElmcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWN0cy5wdXNoKHJlY3QpLCBjdXJyZW50SWZyYW1lID0gZ2V0T3duZXJJZnJhbWUoY3VycmVudElmcmFtZSksIG9ubHlPbmVNb3JlKSBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudElmcmFtZSAmJiBnZXRPd25lcldpbmRvdyhjdXJyZW50SWZyYW1lKSA9PT0gYm91bmRhcnlXaW5kb3cgJiYgKG9ubHlPbmVNb3JlID0gITApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lcmdlUmVjdE9mZnNldHMocmVjdHMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBib3hXcmFwKGRpbXMsIHdoYXQsIG5vZGUpIHsKICAgICAgICAgICAgICAgIGFzc2lnbihub2RlLnN0eWxlLCB7CiAgICAgICAgICAgICAgICAgICAgYm9yZGVyVG9wV2lkdGg6IGRpbXNbd2hhdCArICJUb3AiXSArICJweCIsCiAgICAgICAgICAgICAgICAgICAgYm9yZGVyTGVmdFdpZHRoOiBkaW1zW3doYXQgKyAiTGVmdCJdICsgInB4IiwKICAgICAgICAgICAgICAgICAgICBib3JkZXJSaWdodFdpZHRoOiBkaW1zW3doYXQgKyAiUmlnaHQiXSArICJweCIsCiAgICAgICAgICAgICAgICAgICAgYm9yZGVyQm90dG9tV2lkdGg6IGRpbXNbd2hhdCArICJCb3R0b20iXSArICJweCIsCiAgICAgICAgICAgICAgICAgICAgYm9yZGVyU3R5bGU6ICJzb2xpZCIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgX2NyZWF0ZUNsYXNzID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgITEsIGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gITAsICJ2YWx1ZSIgaW4gZGVzY3JpcHRvciAmJiAoZGVzY3JpcHRvci53cml0YWJsZSA9ICEwKSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm90b1Byb3BzICYmIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKSwgc3RhdGljUHJvcHMgJiYgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpLCBDb25zdHJ1Y3RvcjsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0oKSwKICAgICAgICAgICAgICAgIGFzc2lnbiA9IF9fd2VicGFja19yZXF1aXJlX18oMyksCiAgICAgICAgICAgICAgICBfcmVxdWlyZSA9IF9fd2VicGFja19yZXF1aXJlX18oNTEpLAogICAgICAgICAgICAgICAgbW9ub3NwYWNlID0gX3JlcXVpcmUubW9ub3NwYWNlLAogICAgICAgICAgICAgICAgT3ZlcmxheSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE92ZXJsYXkod2luZG93KSB7CiAgICAgICAgICAgICAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIE92ZXJsYXkpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgZG9jID0gd2luZG93LmRvY3VtZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXMud2luID0gd2luZG93LCB0aGlzLmNvbnRhaW5lciA9IGRvYy5jcmVhdGVFbGVtZW50KCJkaXYiKSwgdGhpcy5ub2RlID0gZG9jLmNyZWF0ZUVsZW1lbnQoImRpdiIpLCB0aGlzLmJvcmRlciA9IGRvYy5jcmVhdGVFbGVtZW50KCJkaXYiKSwgdGhpcy5wYWRkaW5nID0gZG9jLmNyZWF0ZUVsZW1lbnQoImRpdiIpLCB0aGlzLmNvbnRlbnQgPSBkb2MuY3JlYXRlRWxlbWVudCgiZGl2IiksIHRoaXMuYm9yZGVyLnN0eWxlLmJvcmRlckNvbG9yID0gb3ZlcmxheVN0eWxlcy5ib3JkZXIsIHRoaXMucGFkZGluZy5zdHlsZS5ib3JkZXJDb2xvciA9IG92ZXJsYXlTdHlsZXMucGFkZGluZywgdGhpcy5jb250ZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IG92ZXJsYXlTdHlsZXMuYmFja2dyb3VuZCwgYXNzaWduKHRoaXMubm9kZS5zdHlsZSwgewogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJDb2xvcjogb3ZlcmxheVN0eWxlcy5tYXJnaW4sCiAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6ICJub25lIiwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJmaXhlZCIKICAgICAgICAgICAgICAgICAgICB9KSwgdGhpcy50aXAgPSBkb2MuY3JlYXRlRWxlbWVudCgiZGl2IiksIGFzc2lnbih0aGlzLnRpcC5zdHlsZSwgewogICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICIjMzMzNzQwIiwKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAiMnB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgZm9udEZhbWlseTogbW9ub3NwYWNlLmZhbWlseSwKICAgICAgICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogImJvbGQiLAogICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiM3B4IDVweCIsCiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiZml4ZWQiLAogICAgICAgICAgICAgICAgICAgICAgICBmb250U2l6ZTogbW9ub3NwYWNlLnNpemVzLm5vcm1hbAogICAgICAgICAgICAgICAgICAgIH0pLCB0aGlzLm5hbWVTcGFuID0gZG9jLmNyZWF0ZUVsZW1lbnQoInNwYW4iKSwgdGhpcy50aXAuYXBwZW5kQ2hpbGQodGhpcy5uYW1lU3BhbiksIGFzc2lnbih0aGlzLm5hbWVTcGFuLnN0eWxlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAiI2VlNzhlNiIsCiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJpZ2h0OiAiMXB4IHNvbGlkICNhYWFhYWEiLAogICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nUmlnaHQ6ICIwLjVyZW0iLAogICAgICAgICAgICAgICAgICAgICAgICBtYXJnaW5SaWdodDogIjAuNXJlbSIKICAgICAgICAgICAgICAgICAgICB9KSwgdGhpcy5kaW1TcGFuID0gZG9jLmNyZWF0ZUVsZW1lbnQoInNwYW4iKSwgdGhpcy50aXAuYXBwZW5kQ2hpbGQodGhpcy5kaW1TcGFuKSwgYXNzaWduKHRoaXMuZGltU3Bhbi5zdHlsZSwgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogIiNkN2Q3ZDciCiAgICAgICAgICAgICAgICAgICAgfSksIHRoaXMuY29udGFpbmVyLnN0eWxlLnpJbmRleCA9IDFlNywgdGhpcy5ub2RlLnN0eWxlLnpJbmRleCA9IDFlNywgdGhpcy50aXAuc3R5bGUuekluZGV4ID0gMWU3LCB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLm5vZGUpLCB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLnRpcCksIHRoaXMubm9kZS5hcHBlbmRDaGlsZCh0aGlzLmJvcmRlciksIHRoaXMuYm9yZGVyLmFwcGVuZENoaWxkKHRoaXMucGFkZGluZyksIHRoaXMucGFkZGluZy5hcHBlbmRDaGlsZCh0aGlzLmNvbnRlbnQpLCBkb2MuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVDbGFzcyhPdmVybGF5LCBbewogICAgICAgICAgICAgICAgICAgIGtleTogInJlbW92ZSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5wYXJlbnROb2RlICYmIHRoaXMuY29udGFpbmVyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcy5jb250YWluZXIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJpbnNwZWN0IiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUobm9kZSwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBib3ggPSBnZXROZXN0ZWRCb3VuZGluZ0NsaWVudFJlY3Qobm9kZSwgdGhpcy53aW4pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpbXMgPSBnZXRFbGVtZW50RGltZW5zaW9ucyhub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJveFdyYXAoZGltcywgIm1hcmdpbiIsIHRoaXMubm9kZSksIGJveFdyYXAoZGltcywgImJvcmRlciIsIHRoaXMuYm9yZGVyKSwgYm94V3JhcChkaW1zLCAicGFkZGluZyIsIHRoaXMucGFkZGluZyksIGFzc2lnbih0aGlzLmNvbnRlbnQuc3R5bGUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IGJveC5oZWlnaHQgLSBkaW1zLmJvcmRlclRvcCAtIGRpbXMuYm9yZGVyQm90dG9tIC0gZGltcy5wYWRkaW5nVG9wIC0gZGltcy5wYWRkaW5nQm90dG9tICsgInB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogYm94LndpZHRoIC0gZGltcy5ib3JkZXJMZWZ0IC0gZGltcy5ib3JkZXJSaWdodCAtIGRpbXMucGFkZGluZ0xlZnQgLSBkaW1zLnBhZGRpbmdSaWdodCArICJweCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLCBhc3NpZ24odGhpcy5ub2RlLnN0eWxlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiBib3gudG9wIC0gZGltcy5tYXJnaW5Ub3AgKyAicHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IGJveC5sZWZ0IC0gZGltcy5tYXJnaW5MZWZ0ICsgInB4IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksIHRoaXMubmFtZVNwYW4udGV4dENvbnRlbnQgPSBuYW1lIHx8IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwgdGhpcy5kaW1TcGFuLnRleHRDb250ZW50ID0gYm94LndpZHRoICsgInB4IMOXICIgKyBib3guaGVpZ2h0ICsgInB4IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aXBQb3MgPSBmaW5kVGlwUG9zKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IGJveC50b3AgLSBkaW1zLm1hcmdpblRvcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiBib3gubGVmdCAtIGRpbXMubWFyZ2luTGVmdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IGJveC5oZWlnaHQgKyBkaW1zLm1hcmdpblRvcCArIGRpbXMubWFyZ2luQm90dG9tLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBib3gud2lkdGggKyBkaW1zLm1hcmdpbkxlZnQgKyBkaW1zLm1hcmdpblJpZ2h0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0aGlzLndpbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NpZ24odGhpcy50aXAuc3R5bGUsIHRpcFBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9XSksIE92ZXJsYXk7CiAgICAgICAgICAgIH0oKSwKICAgICAgICAgICAgICAgIG92ZXJsYXlTdHlsZXMgPSB7CiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiAicmdiYSgxMjAsIDE3MCwgMjEwLCAwLjcpIiwKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICJyZ2JhKDc3LCAyMDAsIDAsIDAuMykiLAogICAgICAgICAgICAgICAgbWFyZ2luOiAicmdiYSgyNTUsIDE1NSwgMCwgMC4zKSIsCiAgICAgICAgICAgICAgICBib3JkZXI6ICJyZ2JhKDI1NSwgMjAwLCA1MCwgMC4zKSIKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gT3ZlcmxheTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICAgICAgICAgICAgbW9ub3NwYWNlOiB7CiAgICAgICAgICAgICAgICAgICAgZmFtaWx5OiAiTWVubG8sIENvbnNvbGFzLCBtb25vc3BhY2UiLAogICAgICAgICAgICAgICAgICAgIHNpemVzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbDogMTEsCiAgICAgICAgICAgICAgICAgICAgICAgIGxhcmdlOiAxNAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzYW5zU2VyaWY6IHsKICAgICAgICAgICAgICAgICAgICBmYW1pbHk6ICciSGVsdmV0aWNhIE5ldWUiLCAiTHVjaWRhIEdyYW5kZSIsIC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgIlNlZ29lIFVJIiwgVWJ1bnR1LCBzYW5zLXNlcmlmJywKICAgICAgICAgICAgICAgICAgICBzaXplczogewogICAgICAgICAgICAgICAgICAgICAgICBzbWFsbDogMTAsCiAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbDogMTIsCiAgICAgICAgICAgICAgICAgICAgICAgIGxhcmdlOiAxNAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgIGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIF9jcmVhdGVDbGFzcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8ICExLCBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9ICEwLCAidmFsdWUiIGluIGRlc2NyaXB0b3IgJiYgKGRlc2NyaXB0b3Iud3JpdGFibGUgPSAhMCksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvdG9Qcm9wcyAmJiBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyksIHN0YXRpY1Byb3BzICYmIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKSwgQ29uc3RydWN0b3I7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KCksCiAgICAgICAgICAgICAgICBhc3NpZ24gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpLAogICAgICAgICAgICAgICAgTXVsdGlPdmVybGF5ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZnVuY3Rpb24gTXVsdGlPdmVybGF5KHdpbmRvdykgewogICAgICAgICAgICAgICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBNdWx0aU92ZXJsYXkpLCB0aGlzLndpbiA9IHdpbmRvdzsKICAgICAgICAgICAgICAgICAgICB2YXIgZG9jID0gd2luZG93LmRvY3VtZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gZG9jLmNyZWF0ZUVsZW1lbnQoImRpdiIpLCBkb2MuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmNvbnRhaW5lciksIHRoaXMuX2N1cnJlbnROb2RlcyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVDbGFzcyhNdWx0aU92ZXJsYXksIFt7CiAgICAgICAgICAgICAgICAgICAga2V5OiAiaGlnaGxpZ2h0TWFueSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKG5vZGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Tm9kZXMgPSBub2RlcywgdGhpcy5jb250YWluZXIuaW5uZXJIVE1MID0gIiIsIG5vZGVzLmZvckVhY2goZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXYgPSBfdGhpcy53aW4uZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJveCA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm94LmJvdHRvbSA8IDAgfHwgYm94LnRvcCA+IHdpbmRvdy5pbm5lckhlaWdodCB8fCAoYXNzaWduKGRpdi5zdHlsZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IGJveC50b3AgKyAicHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiBib3gubGVmdCArICJweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBib3gud2lkdGggKyAicHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IGJveC5oZWlnaHQgKyAicHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6ICIycHggZG90dGVkIHJnYmEoMjAwLCAxMDAsIDEwMCwgLjgpIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInJnYmEoMjAwLCAxMDAsIDEwMCwgLjIpIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJmaXhlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHpJbmRleDogMWU3LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzOiAibm9uZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSwgX3RoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKGRpdikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAga2V5OiAicmVmcmVzaCIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Tm9kZXMgJiYgdGhpcy5oaWdobGlnaHRNYW55KHRoaXMuX2N1cnJlbnROb2Rlcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGtleTogInJlbW92ZSIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5wYXJlbnROb2RlICYmICh0aGlzLmNvbnRhaW5lci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMuY29udGFpbmVyKSwgdGhpcy5fY3VycmVudE5vZGVzID0gbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfV0pLCBNdWx0aU92ZXJsYXk7CiAgICAgICAgICAgIH0oKTsKCiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gTXVsdGlPdmVybGF5OwogICAgICAgIH1dKTsKICAgIH0pOwp9LDEwMCxbXSwicmVhY3QtZGV2dG9vbHMtY29yZS9idWlsZC9iYWNrZW5kLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnk7CgogIGZ1bmN0aW9uIGdldFN0eWxlKHN0eWxlKSB7CiAgICBpZiAoUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnkgPT09IHVuZGVmaW5lZCkgewogICAgICBSZWFjdE5hdGl2ZVByb3BSZWdpc3RyeSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJSZWFjdE5hdGl2ZVByb3BSZWdpc3RyeSIpOwogICAgfQoKICAgIGlmICh0eXBlb2Ygc3R5bGUgPT09ICdudW1iZXInKSB7CiAgICAgIHJldHVybiBSZWFjdE5hdGl2ZVByb3BSZWdpc3RyeS5nZXRCeUlEKHN0eWxlKTsKICAgIH0KCiAgICByZXR1cm4gc3R5bGU7CiAgfQoKICBmdW5jdGlvbiBmbGF0dGVuU3R5bGUoc3R5bGUpIHsKICAgIGlmICghc3R5bGUpIHsKICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KCiAgICBpbnZhcmlhbnQoc3R5bGUgIT09IHRydWUsICdzdHlsZSBtYXkgYmUgZmFsc2UgYnV0IG5vdCB0cnVlJyk7CgogICAgaWYgKCFBcnJheS5pc0FycmF5KHN0eWxlKSkgewogICAgICByZXR1cm4gZ2V0U3R5bGUoc3R5bGUpOwogICAgfQoKICAgIHZhciByZXN1bHQgPSB7fTsKCiAgICBmb3IgKHZhciBpID0gMCwgc3R5bGVMZW5ndGggPSBzdHlsZS5sZW5ndGg7IGkgPCBzdHlsZUxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBjb21wdXRlZFN0eWxlID0gZmxhdHRlblN0eWxlKHN0eWxlW2ldKTsKCiAgICAgIGlmIChjb21wdXRlZFN0eWxlKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGNvbXB1dGVkU3R5bGUpIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gY29tcHV0ZWRTdHlsZVtrZXldOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGZsYXR0ZW5TdHlsZTsKfSwxMDEsWzEzLDEwMl0sImZsYXR0ZW5TdHlsZSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0TmF0aXZlIiksCiAgICAgIF9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEID0gX3JlcXVpcmUuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CgogIG1vZHVsZS5leHBvcnRzID0gX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQuUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnk7Cn0sMTAyLFsyMV0sIlJlYWN0TmF0aXZlUHJvcFJlZ2lzdHJ5Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgSlNJbnNwZWN0b3IgPSB7CiAgICByZWdpc3RlckFnZW50OiBmdW5jdGlvbiByZWdpc3RlckFnZW50KHR5cGUpIHsKICAgICAgaWYgKGdsb2JhbC5fX3JlZ2lzdGVySW5zcGVjdG9yQWdlbnQpIHsKICAgICAgICBnbG9iYWwuX19yZWdpc3Rlckluc3BlY3RvckFnZW50KHR5cGUpOwogICAgICB9CiAgICB9LAogICAgZ2V0VGltZXN0YW1wOiBmdW5jdGlvbiBnZXRUaW1lc3RhbXAoKSB7CiAgICAgIHJldHVybiBnbG9iYWwuX19pbnNwZWN0b3JUaW1lc3RhbXAoKTsKICAgIH0KICB9OwogIG1vZHVsZS5leHBvcnRzID0gSlNJbnNwZWN0b3I7Cn0sMTAzLFtdLCJKU0luc3BlY3RvciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9jbGFzczIsIF90ZW1wOwoKICB2YXIgSW5zcGVjdG9yQWdlbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiSW5zcGVjdG9yQWdlbnQiKTsKCiAgdmFyIEpTSW5zcGVjdG9yID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkpTSW5zcGVjdG9yIik7CgogIHZhciBNYXAgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiTWFwIik7CgogIHZhciBYTUxIdHRwUmVxdWVzdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJYTUxIdHRwUmVxdWVzdCIpOwoKICB2YXIgSW50ZXJjZXB0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBJbnRlcmNlcHRvcihhZ2VudCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgSW50ZXJjZXB0b3IpOwogICAgICB0aGlzLl9hZ2VudCA9IGFnZW50OwogICAgICB0aGlzLl9yZXF1ZXN0cyA9IG5ldyBNYXAoKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoSW50ZXJjZXB0b3IsIFt7CiAgICAgIGtleTogImdldERhdGEiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0RGF0YShyZXF1ZXN0SWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVxdWVzdHMuZ2V0KHJlcXVlc3RJZCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVxdWVzdFNlbnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVxdWVzdFNlbnQoaWQsIHVybCwgbWV0aG9kLCBoZWFkZXJzKSB7CiAgICAgICAgdmFyIHJlcXVlc3RJZCA9IFN0cmluZyhpZCk7CgogICAgICAgIHRoaXMuX3JlcXVlc3RzLnNldChyZXF1ZXN0SWQsICcnKTsKCiAgICAgICAgdmFyIHJlcXVlc3QgPSB7CiAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgIG1ldGhvZDogbWV0aG9kLAogICAgICAgICAgaGVhZGVyczogaGVhZGVycywKICAgICAgICAgIGluaXRpYWxQcmlvcml0eTogJ01lZGl1bScKICAgICAgICB9OwogICAgICAgIHZhciBldmVudCA9IHsKICAgICAgICAgIHJlcXVlc3RJZDogcmVxdWVzdElkLAogICAgICAgICAgZG9jdW1lbnRVUkw6ICcnLAogICAgICAgICAgZnJhbWVJZDogJzEnLAogICAgICAgICAgbG9hZGVySWQ6ICcxJywKICAgICAgICAgIHJlcXVlc3Q6IHJlcXVlc3QsCiAgICAgICAgICB0aW1lc3RhbXA6IEpTSW5zcGVjdG9yLmdldFRpbWVzdGFtcCgpLAogICAgICAgICAgaW5pdGlhdG9yOiB7CiAgICAgICAgICAgIHR5cGU6ICdvdGhlcicKICAgICAgICAgIH0sCiAgICAgICAgICB0eXBlOiAnT3RoZXInCiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5fYWdlbnQuc2VuZEV2ZW50KCdyZXF1ZXN0V2lsbEJlU2VudCcsIGV2ZW50KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZXNwb25zZVJlY2VpdmVkIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlc3BvbnNlUmVjZWl2ZWQoaWQsIHVybCwgc3RhdHVzLCBoZWFkZXJzKSB7CiAgICAgICAgdmFyIHJlcXVlc3RJZCA9IFN0cmluZyhpZCk7CiAgICAgICAgdmFyIHJlc3BvbnNlID0gewogICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICBzdGF0dXM6IHN0YXR1cywKICAgICAgICAgIHN0YXR1c1RleHQ6IFN0cmluZyhzdGF0dXMpLAogICAgICAgICAgaGVhZGVyczogaGVhZGVycywKICAgICAgICAgIHJlcXVlc3RIZWFkZXJzOiB7fSwKICAgICAgICAgIG1pbWVUeXBlOiB0aGlzLl9nZXRNaW1lVHlwZShoZWFkZXJzKSwKICAgICAgICAgIGNvbm5lY3Rpb25SZXVzZWQ6IGZhbHNlLAogICAgICAgICAgY29ubmVjdGlvbklkOiAtMSwKICAgICAgICAgIGVuY29kZWREYXRhTGVuZ3RoOiAwLAogICAgICAgICAgc2VjdXJpdHlTdGF0ZTogJ3Vua25vd24nCiAgICAgICAgfTsKICAgICAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgICByZXF1ZXN0SWQ6IHJlcXVlc3RJZCwKICAgICAgICAgIGZyYW1lSWQ6ICcxJywKICAgICAgICAgIGxvYWRlcklkOiAnMScsCiAgICAgICAgICB0aW1lc3RhbXA6IEpTSW5zcGVjdG9yLmdldFRpbWVzdGFtcCgpLAogICAgICAgICAgdHlwZTogJ090aGVyJywKICAgICAgICAgIHJlc3BvbnNlOiByZXNwb25zZQogICAgICAgIH07CgogICAgICAgIHRoaXMuX2FnZW50LnNlbmRFdmVudCgncmVzcG9uc2VSZWNlaXZlZCcsIGV2ZW50KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJkYXRhUmVjZWl2ZWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZGF0YVJlY2VpdmVkKGlkLCBkYXRhKSB7CiAgICAgICAgdmFyIHJlcXVlc3RJZCA9IFN0cmluZyhpZCk7CiAgICAgICAgdmFyIGV4aXN0aW5nRGF0YSA9IHRoaXMuX3JlcXVlc3RzLmdldChyZXF1ZXN0SWQpIHx8ICcnOwoKICAgICAgICB0aGlzLl9yZXF1ZXN0cy5zZXQocmVxdWVzdElkLCBleGlzdGluZ0RhdGEuY29uY2F0KGRhdGEpKTsKCiAgICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgICAgcmVxdWVzdElkOiByZXF1ZXN0SWQsCiAgICAgICAgICB0aW1lc3RhbXA6IEpTSW5zcGVjdG9yLmdldFRpbWVzdGFtcCgpLAogICAgICAgICAgZGF0YUxlbmd0aDogZGF0YS5sZW5ndGgsCiAgICAgICAgICBlbmNvZGVkRGF0YUxlbmd0aDogZGF0YS5sZW5ndGgKICAgICAgICB9OwoKICAgICAgICB0aGlzLl9hZ2VudC5zZW5kRXZlbnQoJ2RhdGFSZWNlaXZlZCcsIGV2ZW50KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJsb2FkaW5nRmluaXNoZWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gbG9hZGluZ0ZpbmlzaGVkKGlkLCBlbmNvZGVkRGF0YUxlbmd0aCkgewogICAgICAgIHZhciBldmVudCA9IHsKICAgICAgICAgIHJlcXVlc3RJZDogU3RyaW5nKGlkKSwKICAgICAgICAgIHRpbWVzdGFtcDogSlNJbnNwZWN0b3IuZ2V0VGltZXN0YW1wKCksCiAgICAgICAgICBlbmNvZGVkRGF0YUxlbmd0aDogZW5jb2RlZERhdGFMZW5ndGgKICAgICAgICB9OwoKICAgICAgICB0aGlzLl9hZ2VudC5zZW5kRXZlbnQoJ2xvYWRpbmdGaW5pc2hlZCcsIGV2ZW50KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJsb2FkaW5nRmFpbGVkIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGxvYWRpbmdGYWlsZWQoaWQsIGVycm9yKSB7CiAgICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgICAgcmVxdWVzdElkOiBTdHJpbmcoaWQpLAogICAgICAgICAgdGltZXN0YW1wOiBKU0luc3BlY3Rvci5nZXRUaW1lc3RhbXAoKSwKICAgICAgICAgIHR5cGU6ICdPdGhlcicsCiAgICAgICAgICBlcnJvclRleHQ6IGVycm9yCiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5fYWdlbnQuc2VuZEV2ZW50KCdsb2FkaW5nRmFpbGVkJywgZXZlbnQpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9nZXRNaW1lVHlwZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2V0TWltZVR5cGUoaGVhZGVycykgewogICAgICAgIHZhciBjb250ZW50VHlwZSA9IGhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddIHx8ICcnOwogICAgICAgIHJldHVybiBjb250ZW50VHlwZS5zcGxpdCgnOycpWzBdOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gSW50ZXJjZXB0b3I7CiAgfSgpOwoKICB2YXIgTmV0d29ya0FnZW50ID0gKF90ZW1wID0gX2NsYXNzMiA9IGZ1bmN0aW9uIChfSW5zcGVjdG9yQWdlbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhOZXR3b3JrQWdlbnQsIF9JbnNwZWN0b3JBZ2VudCk7CgogICAgZnVuY3Rpb24gTmV0d29ya0FnZW50KCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgTmV0d29ya0FnZW50KTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChOZXR3b3JrQWdlbnQuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihOZXR3b3JrQWdlbnQpKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoTmV0d29ya0FnZW50LCBbewogICAgICBrZXk6ICJlbmFibGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZW5hYmxlKF9yZWYpIHsKICAgICAgICB2YXIgbWF4UmVzb3VyY2VCdWZmZXJTaXplID0gX3JlZi5tYXhSZXNvdXJjZUJ1ZmZlclNpemUsCiAgICAgICAgICAgIG1heFRvdGFsQnVmZmVyU2l6ZSA9IF9yZWYubWF4VG90YWxCdWZmZXJTaXplOwogICAgICAgIHRoaXMuX2ludGVyY2VwdG9yID0gbmV3IEludGVyY2VwdG9yKHRoaXMpOwogICAgICAgIFhNTEh0dHBSZXF1ZXN0LnNldEludGVyY2VwdG9yKHRoaXMuX2ludGVyY2VwdG9yKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJkaXNhYmxlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGRpc2FibGUoKSB7CiAgICAgICAgWE1MSHR0cFJlcXVlc3Quc2V0SW50ZXJjZXB0b3IobnVsbCk7CiAgICAgICAgdGhpcy5faW50ZXJjZXB0b3IgPSBudWxsOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFJlc3BvbnNlQm9keSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRSZXNwb25zZUJvZHkoX3JlZjIpIHsKICAgICAgICB2YXIgcmVxdWVzdElkID0gX3JlZjIucmVxdWVzdElkOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBib2R5OiB0aGlzLmludGVyY2VwdG9yKCkuZ2V0RGF0YShyZXF1ZXN0SWQpLAogICAgICAgICAgYmFzZTY0RW5jb2RlZDogZmFsc2UKICAgICAgICB9OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImludGVyY2VwdG9yIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGludGVyY2VwdG9yKCkgewogICAgICAgIGlmICh0aGlzLl9pbnRlcmNlcHRvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX2ludGVyY2VwdG9yOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBFcnJvcignX2ludGVyY2VwdG9yIGNhbiBub3QgYmUgbnVsbCcpOwogICAgICAgIH0KICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIE5ldHdvcmtBZ2VudDsKICB9KEluc3BlY3RvckFnZW50KSwgX2NsYXNzMi5ET01BSU4gPSAnTmV0d29yaycsIF90ZW1wKTsKICBtb2R1bGUuZXhwb3J0cyA9IE5ldHdvcmtBZ2VudDsKfSwxMDQsWzEwNSwxMDMsMjYsNThdLCJOZXR3b3JrQWdlbnQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBJbnNwZWN0b3JBZ2VudCA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEluc3BlY3RvckFnZW50KGV2ZW50U2VuZGVyKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBJbnNwZWN0b3JBZ2VudCk7CiAgICAgIHRoaXMuX2V2ZW50U2VuZGVyID0gZXZlbnRTZW5kZXI7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEluc3BlY3RvckFnZW50LCBbewogICAgICBrZXk6ICJzZW5kRXZlbnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2VuZEV2ZW50KG5hbWUsIHBhcmFtcykgewogICAgICAgIHRoaXMuX2V2ZW50U2VuZGVyKG5hbWUsIHBhcmFtcyk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBJbnNwZWN0b3JBZ2VudDsKICB9KCk7CgogIG1vZHVsZS5leHBvcnRzID0gSW5zcGVjdG9yQWdlbnQ7Cn0sMTA1LFtdLCJJbnNwZWN0b3JBZ2VudCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEJhdGNoZWRCcmlkZ2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQmF0Y2hlZEJyaWRnZSIpOwoKICB2YXIgUkNURXZlbnRFbWl0dGVyID0gewogICAgcmVnaXN0ZXI6IGZ1bmN0aW9uIHJlZ2lzdGVyKGV2ZW50RW1pdHRlcikgewogICAgICBCYXRjaGVkQnJpZGdlLnJlZ2lzdGVyQ2FsbGFibGVNb2R1bGUoJ1JDVEV2ZW50RW1pdHRlcicsIGV2ZW50RW1pdHRlcik7CiAgICB9CiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IFJDVEV2ZW50RW1pdHRlcjsKfSwxMDYsWzE2XSwiUkNURXZlbnRFbWl0dGVyIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgTmF0aXZlTW9kdWxlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJQbGF0Zm9ybSIpOwoKICB2YXIgZGVmaW5lTGF6eU9iamVjdFByb3BlcnR5ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgImRlZmluZUxhenlPYmplY3RQcm9wZXJ0eSIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgVUlNYW5hZ2VyID0gTmF0aXZlTW9kdWxlcy5VSU1hbmFnZXI7CiAgaW52YXJpYW50KFVJTWFuYWdlciwgJ1VJTWFuYWdlciBpcyB1bmRlZmluZWQuIFRoZSBuYXRpdmUgbW9kdWxlIGNvbmZpZyBpcyBwcm9iYWJseSBpbmNvcnJlY3QuJyk7CiAgVUlNYW5hZ2VyLl9fdGFrZVNuYXBzaG90ID0gVUlNYW5hZ2VyLnRha2VTbmFwc2hvdDsKCiAgVUlNYW5hZ2VyLnRha2VTbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIGludmFyaWFudChmYWxzZSwgJ1VJTWFuYWdlci50YWtlU25hcHNob3Qgc2hvdWxkIG5vdCBiZSBjYWxsZWQgZGlyZWN0bHkuICcgKyAnVXNlIFJlYWN0TmF0aXZlLnRha2VTbmFwc2hvdCBpbnN0ZWFkLicpOwogIH07CgogIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgIE9iamVjdC5rZXlzKFVJTWFuYWdlcikuZm9yRWFjaChmdW5jdGlvbiAodmlld05hbWUpIHsKICAgICAgdmFyIHZpZXdDb25maWcgPSBVSU1hbmFnZXJbdmlld05hbWVdOwoKICAgICAgaWYgKHZpZXdDb25maWcuTWFuYWdlcikgewogICAgICAgIGRlZmluZUxhenlPYmplY3RQcm9wZXJ0eSh2aWV3Q29uZmlnLCAnQ29uc3RhbnRzJywgewogICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHZhciB2aWV3TWFuYWdlciA9IE5hdGl2ZU1vZHVsZXNbdmlld0NvbmZpZy5NYW5hZ2VyXTsKICAgICAgICAgICAgdmFyIGNvbnN0YW50cyA9IHt9OwogICAgICAgICAgICB2aWV3TWFuYWdlciAmJiBPYmplY3Qua2V5cyh2aWV3TWFuYWdlcikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgICAgdmFyIHZhbHVlID0gdmlld01hbmFnZXJba2V5XTsKCiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgY29uc3RhbnRzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY29uc3RhbnRzOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGRlZmluZUxhenlPYmplY3RQcm9wZXJ0eSh2aWV3Q29uZmlnLCAnQ29tbWFuZHMnLCB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgdmFyIHZpZXdNYW5hZ2VyID0gTmF0aXZlTW9kdWxlc1t2aWV3Q29uZmlnLk1hbmFnZXJdOwogICAgICAgICAgICB2YXIgY29tbWFuZHMgPSB7fTsKICAgICAgICAgICAgdmFyIGluZGV4ID0gMDsKICAgICAgICAgICAgdmlld01hbmFnZXIgJiYgT2JqZWN0LmtleXModmlld01hbmFnZXIpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZpZXdNYW5hZ2VyW2tleV07CgogICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGNvbW1hbmRzW2tleV0gPSBpbmRleCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBjb21tYW5kczsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfSBlbHNlIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnICYmIFVJTWFuYWdlci5WaWV3TWFuYWdlck5hbWVzKSB7CiAgICBVSU1hbmFnZXIuVmlld01hbmFnZXJOYW1lcy5mb3JFYWNoKGZ1bmN0aW9uICh2aWV3TWFuYWdlck5hbWUpIHsKICAgICAgZGVmaW5lTGF6eU9iamVjdFByb3BlcnR5KFVJTWFuYWdlciwgdmlld01hbmFnZXJOYW1lLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gVUlNYW5hZ2VyLmdldENvbnN0YW50c0ZvclZpZXdNYW5hZ2VyKHZpZXdNYW5hZ2VyTmFtZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBVSU1hbmFnZXI7Cn0sMTA3LFsxNSw1MiwyNCwxM10sIlVJTWFuYWdlciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgJy4vY2pzL3JlYWN0LnByb2R1Y3Rpb24ubWluLmpzJyk7CiAgfSBlbHNlIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzJyk7CiAgfQp9LDEwOCxbMTA5LDExMl0sInJlYWN0L2luZGV4LmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgLyoqIEBsaWNlbnNlIFJlYWN0IHYxNi4yLjAKICAgKiByZWFjdC5wcm9kdWN0aW9uLm1pbi5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSAyMDEzLXByZXNlbnQsIEZhY2Vib29rLCBJbmMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICovJ3VzZSBzdHJpY3QnOwoKICB2YXIgbSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJvYmplY3QtYXNzaWduIiksCiAgICAgIG4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiZmJqcy9saWIvZW1wdHlPYmplY3QiKSwKICAgICAgcCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJmYmpzL2xpYi9lbXB0eUZ1bmN0aW9uIiksCiAgICAgIHEgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgU3ltYm9sICYmIFN5bWJvbFsiZm9yIl0sCiAgICAgIHIgPSBxID8gU3ltYm9sWyJmb3IiXSgicmVhY3QuZWxlbWVudCIpIDogNjAxMDMsCiAgICAgIHQgPSBxID8gU3ltYm9sWyJmb3IiXSgicmVhY3QuY2FsbCIpIDogNjAxMDQsCiAgICAgIHUgPSBxID8gU3ltYm9sWyJmb3IiXSgicmVhY3QucmV0dXJuIikgOiA2MDEwNSwKICAgICAgdiA9IHEgPyBTeW1ib2xbImZvciJdKCJyZWFjdC5wb3J0YWwiKSA6IDYwMTA2LAogICAgICB3ID0gcSA/IFN5bWJvbFsiZm9yIl0oInJlYWN0LmZyYWdtZW50IikgOiA2MDEwNywKICAgICAgeCA9ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBTeW1ib2wgJiYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciIpOwoKICBmdW5jdGlvbiB5KGEpIHsKICAgIGZvciAodmFyIGIgPSBhcmd1bWVudHMubGVuZ3RoIC0gMSwgZSA9ICJNaW5pZmllZCBSZWFjdCBlcnJvciAjIiArIGEgKyAiOyB2aXNpdCBodHRwOi8vZmFjZWJvb2suZ2l0aHViLmlvL3JlYWN0L2RvY3MvZXJyb3ItZGVjb2Rlci5odG1sP2ludmFyaWFudFx4M2QiICsgYSwgYyA9IDA7IGMgPCBiOyBjKyspIHsKICAgICAgZSArPSAiXHgyNmFyZ3NbXVx4M2QiICsgZW5jb2RlVVJJQ29tcG9uZW50KGFyZ3VtZW50c1tjICsgMV0pOwogICAgfQoKICAgIGIgPSBFcnJvcihlICsgIiBmb3IgdGhlIGZ1bGwgbWVzc2FnZSBvciB1c2UgdGhlIG5vbi1taW5pZmllZCBkZXYgZW52aXJvbm1lbnQgZm9yIGZ1bGwgZXJyb3JzIGFuZCBhZGRpdGlvbmFsIGhlbHBmdWwgd2FybmluZ3MuIik7CiAgICBiLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICBiLmZyYW1lc1RvUG9wID0gMTsKICAgIHRocm93IGI7CiAgfQoKICB2YXIgeiA9IHsKICAgIGlzTW91bnRlZDogZnVuY3Rpb24gaXNNb3VudGVkKCkgewogICAgICByZXR1cm4gITE7CiAgICB9LAogICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbiBlbnF1ZXVlRm9yY2VVcGRhdGUoKSB7fSwKICAgIGVucXVldWVSZXBsYWNlU3RhdGU6IGZ1bmN0aW9uIGVucXVldWVSZXBsYWNlU3RhdGUoKSB7fSwKICAgIGVucXVldWVTZXRTdGF0ZTogZnVuY3Rpb24gZW5xdWV1ZVNldFN0YXRlKCkge30KICB9OwoKICBmdW5jdGlvbiBBKGEsIGIsIGUpIHsKICAgIHRoaXMucHJvcHMgPSBhOwogICAgdGhpcy5jb250ZXh0ID0gYjsKICAgIHRoaXMucmVmcyA9IG47CiAgICB0aGlzLnVwZGF0ZXIgPSBlIHx8IHo7CiAgfQoKICBBLnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50ID0ge307CgogIEEucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICJvYmplY3QiICE9PSB0eXBlb2YgYSAmJiAiZnVuY3Rpb24iICE9PSB0eXBlb2YgYSAmJiBudWxsICE9IGEgPyB5KCI4NSIpIDogdm9pZCAwOwogICAgdGhpcy51cGRhdGVyLmVucXVldWVTZXRTdGF0ZSh0aGlzLCBhLCBiLCAic2V0U3RhdGUiKTsKICB9OwoKICBBLnByb3RvdHlwZS5mb3JjZVVwZGF0ZSA9IGZ1bmN0aW9uIChhKSB7CiAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZUZvcmNlVXBkYXRlKHRoaXMsIGEsICJmb3JjZVVwZGF0ZSIpOwogIH07CgogIGZ1bmN0aW9uIEIoYSwgYiwgZSkgewogICAgdGhpcy5wcm9wcyA9IGE7CiAgICB0aGlzLmNvbnRleHQgPSBiOwogICAgdGhpcy5yZWZzID0gbjsKICAgIHRoaXMudXBkYXRlciA9IGUgfHwgejsKICB9CgogIGZ1bmN0aW9uIEMoKSB7fQoKICBDLnByb3RvdHlwZSA9IEEucHJvdG90eXBlOwogIHZhciBEID0gQi5wcm90b3R5cGUgPSBuZXcgQygpOwogIEQuY29uc3RydWN0b3IgPSBCOwogIG0oRCwgQS5wcm90b3R5cGUpOwogIEQuaXNQdXJlUmVhY3RDb21wb25lbnQgPSAhMDsKCiAgZnVuY3Rpb24gRShhLCBiLCBlKSB7CiAgICB0aGlzLnByb3BzID0gYTsKICAgIHRoaXMuY29udGV4dCA9IGI7CiAgICB0aGlzLnJlZnMgPSBuOwogICAgdGhpcy51cGRhdGVyID0gZSB8fCB6OwogIH0KCiAgdmFyIEYgPSBFLnByb3RvdHlwZSA9IG5ldyBDKCk7CiAgRi5jb25zdHJ1Y3RvciA9IEU7CiAgbShGLCBBLnByb3RvdHlwZSk7CiAgRi51bnN0YWJsZV9pc0FzeW5jUmVhY3RDb21wb25lbnQgPSAhMDsKCiAgRi5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5wcm9wcy5jaGlsZHJlbjsKICB9OwoKICB2YXIgRyA9IHsKICAgIGN1cnJlbnQ6IG51bGwKICB9LAogICAgICBIID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwKICAgICAgSSA9IHsKICAgIGtleTogITAsCiAgICByZWY6ICEwLAogICAgX19zZWxmOiAhMCwKICAgIF9fc291cmNlOiAhMAogIH07CgogIGZ1bmN0aW9uIEooYSwgYiwgZSkgewogICAgdmFyIGMsCiAgICAgICAgZCA9IHt9LAogICAgICAgIGcgPSBudWxsLAogICAgICAgIGsgPSBudWxsOwogICAgaWYgKG51bGwgIT0gYikgZm9yIChjIGluIHZvaWQgMCAhPT0gYi5yZWYgJiYgKGsgPSBiLnJlZiksIHZvaWQgMCAhPT0gYi5rZXkgJiYgKGcgPSAiIiArIGIua2V5KSwgYikgewogICAgICBILmNhbGwoYiwgYykgJiYgIUkuaGFzT3duUHJvcGVydHkoYykgJiYgKGRbY10gPSBiW2NdKTsKICAgIH0KICAgIHZhciBmID0gYXJndW1lbnRzLmxlbmd0aCAtIDI7CiAgICBpZiAoMSA9PT0gZikgZC5jaGlsZHJlbiA9IGU7ZWxzZSBpZiAoMSA8IGYpIHsKICAgICAgZm9yICh2YXIgaCA9IEFycmF5KGYpLCBsID0gMDsgbCA8IGY7IGwrKykgewogICAgICAgIGhbbF0gPSBhcmd1bWVudHNbbCArIDJdOwogICAgICB9CgogICAgICBkLmNoaWxkcmVuID0gaDsKICAgIH0KICAgIGlmIChhICYmIGEuZGVmYXVsdFByb3BzKSBmb3IgKGMgaW4gZiA9IGEuZGVmYXVsdFByb3BzLCBmKSB7CiAgICAgIHZvaWQgMCA9PT0gZFtjXSAmJiAoZFtjXSA9IGZbY10pOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgJCR0eXBlb2Y6IHIsCiAgICAgIHR5cGU6IGEsCiAgICAgIGtleTogZywKICAgICAgcmVmOiBrLAogICAgICBwcm9wczogZCwKICAgICAgX293bmVyOiBHLmN1cnJlbnQKICAgIH07CiAgfQoKICBmdW5jdGlvbiBLKGEpIHsKICAgIHJldHVybiAib2JqZWN0IiA9PT0gdHlwZW9mIGEgJiYgbnVsbCAhPT0gYSAmJiBhLiQkdHlwZW9mID09PSByOwogIH0KCiAgZnVuY3Rpb24gZXNjYXBlKGEpIHsKICAgIHZhciBiID0gewogICAgICAiXHgzZCI6ICJceDNkMCIsCiAgICAgICI6IjogIlx4M2QyIgogICAgfTsKICAgIHJldHVybiAiJCIgKyAoIiIgKyBhKS5yZXBsYWNlKC9bPTpdL2csIGZ1bmN0aW9uIChhKSB7CiAgICAgIHJldHVybiBiW2FdOwogICAgfSk7CiAgfQoKICB2YXIgTCA9IC9cLysvZywKICAgICAgTSA9IFtdOwoKICBmdW5jdGlvbiBOKGEsIGIsIGUsIGMpIHsKICAgIGlmIChNLmxlbmd0aCkgewogICAgICB2YXIgZCA9IE0ucG9wKCk7CiAgICAgIGQucmVzdWx0ID0gYTsKICAgICAgZC5rZXlQcmVmaXggPSBiOwogICAgICBkLmZ1bmMgPSBlOwogICAgICBkLmNvbnRleHQgPSBjOwogICAgICBkLmNvdW50ID0gMDsKICAgICAgcmV0dXJuIGQ7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgcmVzdWx0OiBhLAogICAgICBrZXlQcmVmaXg6IGIsCiAgICAgIGZ1bmM6IGUsCiAgICAgIGNvbnRleHQ6IGMsCiAgICAgIGNvdW50OiAwCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gTyhhKSB7CiAgICBhLnJlc3VsdCA9IG51bGw7CiAgICBhLmtleVByZWZpeCA9IG51bGw7CiAgICBhLmZ1bmMgPSBudWxsOwogICAgYS5jb250ZXh0ID0gbnVsbDsKICAgIGEuY291bnQgPSAwOwogICAgMTAgPiBNLmxlbmd0aCAmJiBNLnB1c2goYSk7CiAgfQoKICBmdW5jdGlvbiBQKGEsIGIsIGUsIGMpIHsKICAgIHZhciBkID0gdHlwZW9mIGE7CiAgICBpZiAoInVuZGVmaW5lZCIgPT09IGQgfHwgImJvb2xlYW4iID09PSBkKSBhID0gbnVsbDsKICAgIHZhciBnID0gITE7CiAgICBpZiAobnVsbCA9PT0gYSkgZyA9ICEwO2Vsc2Ugc3dpdGNoIChkKSB7CiAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgZyA9ICEwOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICBzd2l0Y2ggKGEuJCR0eXBlb2YpIHsKICAgICAgICAgIGNhc2UgcjoKICAgICAgICAgIGNhc2UgdDoKICAgICAgICAgIGNhc2UgdToKICAgICAgICAgIGNhc2UgdjoKICAgICAgICAgICAgZyA9ICEwOwogICAgICAgIH0KCiAgICB9CiAgICBpZiAoZykgcmV0dXJuIGUoYywgYSwgIiIgPT09IGIgPyAiLiIgKyBRKGEsIDApIDogYiksIDE7CiAgICBnID0gMDsKICAgIGIgPSAiIiA9PT0gYiA/ICIuIiA6IGIgKyAiOiI7CiAgICBpZiAoQXJyYXkuaXNBcnJheShhKSkgZm9yICh2YXIgayA9IDA7IGsgPCBhLmxlbmd0aDsgaysrKSB7CiAgICAgIGQgPSBhW2tdOwogICAgICB2YXIgZiA9IGIgKyBRKGQsIGspOwogICAgICBnICs9IFAoZCwgZiwgZSwgYyk7CiAgICB9IGVsc2UgaWYgKG51bGwgPT09IGEgfHwgInVuZGVmaW5lZCIgPT09IHR5cGVvZiBhID8gZiA9IG51bGwgOiAoZiA9IHggJiYgYVt4XSB8fCBhWyJAQGl0ZXJhdG9yIl0sIGYgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgZiA/IGYgOiBudWxsKSwgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGYpIGZvciAoYSA9IGYuY2FsbChhKSwgayA9IDA7ICEoZCA9IGEubmV4dCgpKS5kb25lOykgewogICAgICBkID0gZC52YWx1ZSwgZiA9IGIgKyBRKGQsIGsrKyksIGcgKz0gUChkLCBmLCBlLCBjKTsKICAgIH0gZWxzZSAib2JqZWN0IiA9PT0gZCAmJiAoZSA9ICIiICsgYSwgeSgiMzEiLCAiW29iamVjdCBPYmplY3RdIiA9PT0gZSA/ICJvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMoYSkuam9pbigiLCAiKSArICJ9IiA6IGUsICIiKSk7CiAgICByZXR1cm4gZzsKICB9CgogIGZ1bmN0aW9uIFEoYSwgYikgewogICAgcmV0dXJuICJvYmplY3QiID09PSB0eXBlb2YgYSAmJiBudWxsICE9PSBhICYmIG51bGwgIT0gYS5rZXkgPyBlc2NhcGUoYS5rZXkpIDogYi50b1N0cmluZygzNik7CiAgfQoKICBmdW5jdGlvbiBSKGEsIGIpIHsKICAgIGEuZnVuYy5jYWxsKGEuY29udGV4dCwgYiwgYS5jb3VudCsrKTsKICB9CgogIGZ1bmN0aW9uIFMoYSwgYiwgZSkgewogICAgdmFyIGMgPSBhLnJlc3VsdCwKICAgICAgICBkID0gYS5rZXlQcmVmaXg7CiAgICBhID0gYS5mdW5jLmNhbGwoYS5jb250ZXh0LCBiLCBhLmNvdW50KyspOwogICAgQXJyYXkuaXNBcnJheShhKSA/IFQoYSwgYywgZSwgcC50aGF0UmV0dXJuc0FyZ3VtZW50KSA6IG51bGwgIT0gYSAmJiAoSyhhKSAmJiAoYiA9IGQgKyAoIWEua2V5IHx8IGIgJiYgYi5rZXkgPT09IGEua2V5ID8gIiIgOiAoIiIgKyBhLmtleSkucmVwbGFjZShMLCAiJFx4MjYvIikgKyAiLyIpICsgZSwgYSA9IHsKICAgICAgJCR0eXBlb2Y6IHIsCiAgICAgIHR5cGU6IGEudHlwZSwKICAgICAga2V5OiBiLAogICAgICByZWY6IGEucmVmLAogICAgICBwcm9wczogYS5wcm9wcywKICAgICAgX293bmVyOiBhLl9vd25lcgogICAgfSksIGMucHVzaChhKSk7CiAgfQoKICBmdW5jdGlvbiBUKGEsIGIsIGUsIGMsIGQpIHsKICAgIHZhciBnID0gIiI7CiAgICBudWxsICE9IGUgJiYgKGcgPSAoIiIgKyBlKS5yZXBsYWNlKEwsICIkXHgyNi8iKSArICIvIik7CiAgICBiID0gTihiLCBnLCBjLCBkKTsKICAgIG51bGwgPT0gYSB8fCBQKGEsICIiLCBTLCBiKTsKICAgIE8oYik7CiAgfQoKICB2YXIgVSA9IHsKICAgIENoaWxkcmVuOiB7CiAgICAgIG1hcDogZnVuY3Rpb24gbWFwKGEsIGIsIGUpIHsKICAgICAgICBpZiAobnVsbCA9PSBhKSByZXR1cm4gYTsKICAgICAgICB2YXIgYyA9IFtdOwogICAgICAgIFQoYSwgYywgbnVsbCwgYiwgZSk7CiAgICAgICAgcmV0dXJuIGM7CiAgICAgIH0sCiAgICAgIGZvckVhY2g6IGZ1bmN0aW9uIGZvckVhY2goYSwgYiwgZSkgewogICAgICAgIGlmIChudWxsID09IGEpIHJldHVybiBhOwogICAgICAgIGIgPSBOKG51bGwsIG51bGwsIGIsIGUpOwogICAgICAgIG51bGwgPT0gYSB8fCBQKGEsICIiLCBSLCBiKTsKICAgICAgICBPKGIpOwogICAgICB9LAogICAgICBjb3VudDogZnVuY3Rpb24gY291bnQoYSkgewogICAgICAgIHJldHVybiBudWxsID09IGEgPyAwIDogUChhLCAiIiwgcC50aGF0UmV0dXJuc051bGwsIG51bGwpOwogICAgICB9LAogICAgICB0b0FycmF5OiBmdW5jdGlvbiB0b0FycmF5KGEpIHsKICAgICAgICB2YXIgYiA9IFtdOwogICAgICAgIFQoYSwgYiwgbnVsbCwgcC50aGF0UmV0dXJuc0FyZ3VtZW50KTsKICAgICAgICByZXR1cm4gYjsKICAgICAgfSwKICAgICAgb25seTogZnVuY3Rpb24gb25seShhKSB7CiAgICAgICAgSyhhKSA/IHZvaWQgMCA6IHkoIjE0MyIpOwogICAgICAgIHJldHVybiBhOwogICAgICB9CiAgICB9LAogICAgQ29tcG9uZW50OiBBLAogICAgUHVyZUNvbXBvbmVudDogQiwKICAgIHVuc3RhYmxlX0FzeW5jQ29tcG9uZW50OiBFLAogICAgRnJhZ21lbnQ6IHcsCiAgICBjcmVhdGVFbGVtZW50OiBKLAogICAgY2xvbmVFbGVtZW50OiBmdW5jdGlvbiBjbG9uZUVsZW1lbnQoYSwgYiwgZSkgewogICAgICB2YXIgYyA9IG0oe30sIGEucHJvcHMpLAogICAgICAgICAgZCA9IGEua2V5LAogICAgICAgICAgZyA9IGEucmVmLAogICAgICAgICAgayA9IGEuX293bmVyOwoKICAgICAgaWYgKG51bGwgIT0gYikgewogICAgICAgIHZvaWQgMCAhPT0gYi5yZWYgJiYgKGcgPSBiLnJlZiwgayA9IEcuY3VycmVudCk7CiAgICAgICAgdm9pZCAwICE9PSBiLmtleSAmJiAoZCA9ICIiICsgYi5rZXkpOwogICAgICAgIGlmIChhLnR5cGUgJiYgYS50eXBlLmRlZmF1bHRQcm9wcykgdmFyIGYgPSBhLnR5cGUuZGVmYXVsdFByb3BzOwoKICAgICAgICBmb3IgKGggaW4gYikgewogICAgICAgICAgSC5jYWxsKGIsIGgpICYmICFJLmhhc093blByb3BlcnR5KGgpICYmIChjW2hdID0gdm9pZCAwID09PSBiW2hdICYmIHZvaWQgMCAhPT0gZiA/IGZbaF0gOiBiW2hdKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBoID0gYXJndW1lbnRzLmxlbmd0aCAtIDI7CiAgICAgIGlmICgxID09PSBoKSBjLmNoaWxkcmVuID0gZTtlbHNlIGlmICgxIDwgaCkgewogICAgICAgIGYgPSBBcnJheShoKTsKCiAgICAgICAgZm9yICh2YXIgbCA9IDA7IGwgPCBoOyBsKyspIHsKICAgICAgICAgIGZbbF0gPSBhcmd1bWVudHNbbCArIDJdOwogICAgICAgIH0KCiAgICAgICAgYy5jaGlsZHJlbiA9IGY7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICAkJHR5cGVvZjogciwKICAgICAgICB0eXBlOiBhLnR5cGUsCiAgICAgICAga2V5OiBkLAogICAgICAgIHJlZjogZywKICAgICAgICBwcm9wczogYywKICAgICAgICBfb3duZXI6IGsKICAgICAgfTsKICAgIH0sCiAgICBjcmVhdGVGYWN0b3J5OiBmdW5jdGlvbiBjcmVhdGVGYWN0b3J5KGEpIHsKICAgICAgdmFyIGIgPSBKLmJpbmQobnVsbCwgYSk7CiAgICAgIGIudHlwZSA9IGE7CiAgICAgIHJldHVybiBiOwogICAgfSwKICAgIGlzVmFsaWRFbGVtZW50OiBLLAogICAgdmVyc2lvbjogIjE2LjIuMCIsCiAgICBfX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRDogewogICAgICBSZWFjdEN1cnJlbnRPd25lcjogRywKICAgICAgYXNzaWduOiBtCiAgICB9CiAgfSwKICAgICAgViA9IE9iamVjdC5mcmVlemUoewogICAgZGVmYXVsdDogVQogIH0pLAogICAgICBXID0gViAmJiBVIHx8IFY7CiAgbW9kdWxlLmV4cG9ydHMgPSBXWyJkZWZhdWx0Il0gPyBXWyJkZWZhdWx0Il0gOiBXOwp9LDEwOSxbMTEwLDExMSw1N10sInJlYWN0L2Nqcy9yZWFjdC5wcm9kdWN0aW9uLm1pbi5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewoJLyoKIG9iamVjdC1hc3NpZ24KIChjKSBTaW5kcmUgU29yaHVzCiBAbGljZW5zZSBNSVQKICovJ3VzZSBzdHJpY3QnOwoKCXZhciBnZXRPd25Qcm9wZXJ0eVN5bWJvbHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzOwoJdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCXZhciBwcm9wSXNFbnVtZXJhYmxlID0gT2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZTsKCglmdW5jdGlvbiB0b09iamVjdCh2YWwpIHsKCQlpZiAodmFsID09PSBudWxsIHx8IHZhbCA9PT0gdW5kZWZpbmVkKSB7CgkJCXRocm93IG5ldyBUeXBlRXJyb3IoJ09iamVjdC5hc3NpZ24gY2Fubm90IGJlIGNhbGxlZCB3aXRoIG51bGwgb3IgdW5kZWZpbmVkJyk7CgkJfQoKCQlyZXR1cm4gT2JqZWN0KHZhbCk7Cgl9CgoJZnVuY3Rpb24gc2hvdWxkVXNlTmF0aXZlKCkgewoJCXRyeSB7CgkJCWlmICghT2JqZWN0LmFzc2lnbikgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgdGVzdDEgPSBuZXcgU3RyaW5nKCdhYmMnKTsKCQkJdGVzdDFbNV0gPSAnZGUnOwoKCQkJaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRlc3QxKVswXSA9PT0gJzUnKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciB0ZXN0MiA9IHt9OwoKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCAxMDsgaSsrKSB7CgkJCQl0ZXN0MlsnXycgKyBTdHJpbmcuZnJvbUNoYXJDb2RlKGkpXSA9IGk7CgkJCX0KCgkJCXZhciBvcmRlcjIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0ZXN0MikubWFwKGZ1bmN0aW9uIChuKSB7CgkJCQlyZXR1cm4gdGVzdDJbbl07CgkJCX0pOwoKCQkJaWYgKG9yZGVyMi5qb2luKCcnKSAhPT0gJzAxMjM0NTY3ODknKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciB0ZXN0MyA9IHt9OwoJCQknYWJjZGVmZ2hpamtsbW5vcHFyc3QnLnNwbGl0KCcnKS5mb3JFYWNoKGZ1bmN0aW9uIChsZXR0ZXIpIHsKCQkJCXRlc3QzW2xldHRlcl0gPSBsZXR0ZXI7CgkJCX0pOwoKCQkJaWYgKE9iamVjdC5rZXlzKGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCB0ZXN0MykpLmpvaW4oJycpICE9PSAnYWJjZGVmZ2hpamtsbW5vcHFyc3QnKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXJldHVybiB0cnVlOwoJCX0gY2F0Y2ggKGVycikgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfQoKCW1vZHVsZS5leHBvcnRzID0gc2hvdWxkVXNlTmF0aXZlKCkgPyBPYmplY3QuYXNzaWduIDogZnVuY3Rpb24gKHRhcmdldCwgc291cmNlKSB7CgkJdmFyIGZyb207CgkJdmFyIHRvID0gdG9PYmplY3QodGFyZ2V0KTsKCQl2YXIgc3ltYm9sczsKCgkJZm9yICh2YXIgcyA9IDE7IHMgPCBhcmd1bWVudHMubGVuZ3RoOyBzKyspIHsKCQkJZnJvbSA9IE9iamVjdChhcmd1bWVudHNbc10pOwoKCQkJZm9yICh2YXIga2V5IGluIGZyb20pIHsKCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGZyb20sIGtleSkpIHsKCQkJCQl0b1trZXldID0gZnJvbVtrZXldOwoJCQkJfQoJCQl9CgoJCQlpZiAoZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CgkJCQlzeW1ib2xzID0gZ2V0T3duUHJvcGVydHlTeW1ib2xzKGZyb20pOwoKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgc3ltYm9scy5sZW5ndGg7IGkrKykgewoJCQkJCWlmIChwcm9wSXNFbnVtZXJhYmxlLmNhbGwoZnJvbSwgc3ltYm9sc1tpXSkpIHsKCQkJCQkJdG9bc3ltYm9sc1tpXV0gPSBmcm9tW3N5bWJvbHNbaV1dOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRvOwoJfTsKfSwxMTAsW10sIm9iamVjdC1hc3NpZ24vaW5kZXguanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBlbXB0eU9iamVjdCA9IHt9OwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgT2JqZWN0LmZyZWV6ZShlbXB0eU9iamVjdCk7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGVtcHR5T2JqZWN0Owp9LDExMSxbXSwiZmJqcy9saWIvZW1wdHlPYmplY3QuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAvKiogQGxpY2Vuc2UgUmVhY3QgdjE2LjIuMAogICAqIHJlYWN0LmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIDIwMTMtcHJlc2VudCwgRmFjZWJvb2ssIEluYy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKi8ndXNlIHN0cmljdCc7CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gInByb2R1Y3Rpb24iKSB7CiAgICAoZnVuY3Rpb24gKCkgewogICAgICAndXNlIHN0cmljdCc7CgogICAgICB2YXIgX2Fzc2lnbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJvYmplY3QtYXNzaWduIik7CgogICAgICB2YXIgZW1wdHlPYmplY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiZmJqcy9saWIvZW1wdHlPYmplY3QiKTsKCiAgICAgIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogICAgICB2YXIgd2FybmluZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJmYmpzL2xpYi93YXJuaW5nIik7CgogICAgICB2YXIgZW1wdHlGdW5jdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJmYmpzL2xpYi9lbXB0eUZ1bmN0aW9uIik7CgogICAgICB2YXIgY2hlY2tQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAicHJvcC10eXBlcy9jaGVja1Byb3BUeXBlcyIpOwoKICAgICAgdmFyIFJlYWN0VmVyc2lvbiA9ICcxNi4yLjAnOwogICAgICB2YXIgaGFzU3ltYm9sID0gdHlwZW9mIFN5bWJvbCA9PT0gJ2Z1bmN0aW9uJyAmJiBTeW1ib2xbJ2ZvciddOwogICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gaGFzU3ltYm9sID8gU3ltYm9sWydmb3InXSgncmVhY3QuZWxlbWVudCcpIDogMHhlYWM3OwogICAgICB2YXIgUkVBQ1RfQ0FMTF9UWVBFID0gaGFzU3ltYm9sID8gU3ltYm9sWydmb3InXSgncmVhY3QuY2FsbCcpIDogMHhlYWM4OwogICAgICB2YXIgUkVBQ1RfUkVUVVJOX1RZUEUgPSBoYXNTeW1ib2wgPyBTeW1ib2xbJ2ZvciddKCdyZWFjdC5yZXR1cm4nKSA6IDB4ZWFjOTsKICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gaGFzU3ltYm9sID8gU3ltYm9sWydmb3InXSgncmVhY3QucG9ydGFsJykgOiAweGVhY2E7CiAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gaGFzU3ltYm9sID8gU3ltYm9sWydmb3InXSgncmVhY3QuZnJhZ21lbnQnKSA6IDB4ZWFjYjsKICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IHR5cGVvZiBTeW1ib2wgPT09ICdmdW5jdGlvbicgJiYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciIpOwogICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAnQEBpdGVyYXRvcic7CgogICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgdmFyIG1heWJlSXRlcmF0b3IgPSBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgJiYgbWF5YmVJdGVyYWJsZVtNQVlCRV9JVEVSQVRPUl9TWU1CT0xdIHx8IG1heWJlSXRlcmFibGVbRkFVWF9JVEVSQVRPUl9TWU1CT0xdOwoKICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHJldHVybiBtYXliZUl0ZXJhdG9yOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHZhciBsb3dQcmlvcml0eVdhcm5pbmcgPSBmdW5jdGlvbiBsb3dQcmlvcml0eVdhcm5pbmcoKSB7fTsKCiAgICAgIHsKICAgICAgICB2YXIgcHJpbnRXYXJuaW5nID0gZnVuY3Rpb24gcHJpbnRXYXJuaW5nKGZvcm1hdCkgewogICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2tleSAtIDFdID0gYXJndW1lbnRzW19rZXldOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBhcmdJbmRleCA9IDA7CiAgICAgICAgICB2YXIgbWVzc2FnZSA9ICdXYXJuaW5nOiAnICsgZm9ybWF0LnJlcGxhY2UoLyVzL2csIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGFyZ3NbYXJnSW5kZXgrK107CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihtZXNzYWdlKTsKICAgICAgICAgIH0KCiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobWVzc2FnZSk7CiAgICAgICAgICB9IGNhdGNoICh4KSB7fQogICAgICAgIH07CgogICAgICAgIGxvd1ByaW9yaXR5V2FybmluZyA9IGZ1bmN0aW9uIGxvd1ByaW9yaXR5V2FybmluZyhjb25kaXRpb24sIGZvcm1hdCkgewogICAgICAgICAgaWYgKGZvcm1hdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYHdhcm5pbmcoY29uZGl0aW9uLCBmb3JtYXQsIC4uLmFyZ3MpYCByZXF1aXJlcyBhIHdhcm5pbmcgJyArICdtZXNzYWdlIGFyZ3VtZW50Jyk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFjb25kaXRpb24pIHsKICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbjIgPiAyID8gX2xlbjIgLSAyIDogMCksIF9rZXkyID0gMjsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAyXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHByaW50V2FybmluZy5hcHBseSh1bmRlZmluZWQsIFtmb3JtYXRdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICB2YXIgbG93UHJpb3JpdHlXYXJuaW5nJDEgPSBsb3dQcmlvcml0eVdhcm5pbmc7CiAgICAgIHZhciBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnQgPSB7fTsKCiAgICAgIGZ1bmN0aW9uIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgewogICAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gcHVibGljSW5zdGFuY2UuY29uc3RydWN0b3I7CiAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGNvbnN0cnVjdG9yICYmIChjb25zdHJ1Y3Rvci5kaXNwbGF5TmFtZSB8fCBjb25zdHJ1Y3Rvci5uYW1lKSB8fCAnUmVhY3RDbGFzcyc7CiAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IGNvbXBvbmVudE5hbWUgKyAnLicgKyBjYWxsZXJOYW1lOwoKICAgICAgICAgIGlmIChkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbd2FybmluZ0tleV0pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICclcyguLi4pOiBDYW4gb25seSB1cGRhdGUgYSBtb3VudGVkIG9yIG1vdW50aW5nIGNvbXBvbmVudC4gJyArICdUaGlzIHVzdWFsbHkgbWVhbnMgeW91IGNhbGxlZCAlcygpIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuICcgKyAnVGhpcyBpcyBhIG5vLW9wLlxuXG5QbGVhc2UgY2hlY2sgdGhlIGNvZGUgZm9yIHRoZSAlcyBjb21wb25lbnQuJywgY2FsbGVyTmFtZSwgY2FsbGVyTmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlID0gewogICAgICAgIGlzTW91bnRlZDogZnVuY3Rpb24gaXNNb3VudGVkKHB1YmxpY0luc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBlbnF1ZXVlRm9yY2VVcGRhdGU6IGZ1bmN0aW9uIGVucXVldWVGb3JjZVVwZGF0ZShwdWJsaWNJbnN0YW5jZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAnZm9yY2VVcGRhdGUnKTsKICAgICAgICB9LAogICAgICAgIGVucXVldWVSZXBsYWNlU3RhdGU6IGZ1bmN0aW9uIGVucXVldWVSZXBsYWNlU3RhdGUocHVibGljSW5zdGFuY2UsIGNvbXBsZXRlU3RhdGUsIGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgJ3JlcGxhY2VTdGF0ZScpOwogICAgICAgIH0sCiAgICAgICAgZW5xdWV1ZVNldFN0YXRlOiBmdW5jdGlvbiBlbnF1ZXVlU2V0U3RhdGUocHVibGljSW5zdGFuY2UsIHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAnc2V0U3RhdGUnKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBmdW5jdGlvbiBDb21wb25lbnQocHJvcHMsIGNvbnRleHQsIHVwZGF0ZXIpIHsKICAgICAgICB0aGlzLnByb3BzID0gcHJvcHM7CiAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICB0aGlzLnJlZnMgPSBlbXB0eU9iamVjdDsKICAgICAgICB0aGlzLnVwZGF0ZXIgPSB1cGRhdGVyIHx8IFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlOwogICAgICB9CgogICAgICBDb21wb25lbnQucHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQgPSB7fTsKCiAgICAgIENvbXBvbmVudC5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbiAocGFydGlhbFN0YXRlLCBjYWxsYmFjaykgewogICAgICAgICEodHlwZW9mIHBhcnRpYWxTdGF0ZSA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIHBhcnRpYWxTdGF0ZSA9PT0gJ2Z1bmN0aW9uJyB8fCBwYXJ0aWFsU3RhdGUgPT0gbnVsbCkgPyBpbnZhcmlhbnQoZmFsc2UsICdzZXRTdGF0ZSguLi4pOiB0YWtlcyBhbiBvYmplY3Qgb2Ygc3RhdGUgdmFyaWFibGVzIHRvIHVwZGF0ZSBvciBhIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcy4nKSA6IHZvaWQgMDsKICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKHRoaXMsIHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2ssICdzZXRTdGF0ZScpOwogICAgICB9OwoKICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5mb3JjZVVwZGF0ZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlRm9yY2VVcGRhdGUodGhpcywgY2FsbGJhY2ssICdmb3JjZVVwZGF0ZScpOwogICAgICB9OwoKICAgICAgewogICAgICAgIHZhciBkZXByZWNhdGVkQVBJcyA9IHsKICAgICAgICAgIGlzTW91bnRlZDogWydpc01vdW50ZWQnLCAnSW5zdGVhZCwgbWFrZSBzdXJlIHRvIGNsZWFuIHVwIHN1YnNjcmlwdGlvbnMgYW5kIHBlbmRpbmcgcmVxdWVzdHMgaW4gJyArICdjb21wb25lbnRXaWxsVW5tb3VudCB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcy4nXSwKICAgICAgICAgIHJlcGxhY2VTdGF0ZTogWydyZXBsYWNlU3RhdGUnLCAnUmVmYWN0b3IgeW91ciBjb2RlIHRvIHVzZSBzZXRTdGF0ZSBpbnN0ZWFkIChzZWUgJyArICdodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QvaXNzdWVzLzMyMzYpLiddCiAgICAgICAgfTsKCiAgICAgICAgdmFyIGRlZmluZURlcHJlY2F0aW9uV2FybmluZyA9IGZ1bmN0aW9uIGRlZmluZURlcHJlY2F0aW9uV2FybmluZyhtZXRob2ROYW1lLCBpbmZvKSB7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ29tcG9uZW50LnByb3RvdHlwZSwgbWV0aG9kTmFtZSwgewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgICBsb3dQcmlvcml0eVdhcm5pbmckMShmYWxzZSwgJyVzKC4uLikgaXMgZGVwcmVjYXRlZCBpbiBwbGFpbiBKYXZhU2NyaXB0IFJlYWN0IGNsYXNzZXMuICVzJywgaW5mb1swXSwgaW5mb1sxXSk7CiAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgZm9yICh2YXIgZm5OYW1lIGluIGRlcHJlY2F0ZWRBUElzKSB7CiAgICAgICAgICBpZiAoZGVwcmVjYXRlZEFQSXMuaGFzT3duUHJvcGVydHkoZm5OYW1lKSkgewogICAgICAgICAgICBkZWZpbmVEZXByZWNhdGlvbldhcm5pbmcoZm5OYW1lLCBkZXByZWNhdGVkQVBJc1tmbk5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIFB1cmVDb21wb25lbnQocHJvcHMsIGNvbnRleHQsIHVwZGF0ZXIpIHsKICAgICAgICB0aGlzLnByb3BzID0gcHJvcHM7CiAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICB0aGlzLnJlZnMgPSBlbXB0eU9iamVjdDsKICAgICAgICB0aGlzLnVwZGF0ZXIgPSB1cGRhdGVyIHx8IFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlOwogICAgICB9CgogICAgICBmdW5jdGlvbiBDb21wb25lbnREdW1teSgpIHt9CgogICAgICBDb21wb25lbnREdW1teS5wcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICB2YXIgcHVyZUNvbXBvbmVudFByb3RvdHlwZSA9IFB1cmVDb21wb25lbnQucHJvdG90eXBlID0gbmV3IENvbXBvbmVudER1bW15KCk7CiAgICAgIHB1cmVDb21wb25lbnRQcm90b3R5cGUuY29uc3RydWN0b3IgPSBQdXJlQ29tcG9uZW50OwoKICAgICAgX2Fzc2lnbihwdXJlQ29tcG9uZW50UHJvdG90eXBlLCBDb21wb25lbnQucHJvdG90eXBlKTsKCiAgICAgIHB1cmVDb21wb25lbnRQcm90b3R5cGUuaXNQdXJlUmVhY3RDb21wb25lbnQgPSB0cnVlOwoKICAgICAgZnVuY3Rpb24gQXN5bmNDb21wb25lbnQocHJvcHMsIGNvbnRleHQsIHVwZGF0ZXIpIHsKICAgICAgICB0aGlzLnByb3BzID0gcHJvcHM7CiAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICB0aGlzLnJlZnMgPSBlbXB0eU9iamVjdDsKICAgICAgICB0aGlzLnVwZGF0ZXIgPSB1cGRhdGVyIHx8IFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlOwogICAgICB9CgogICAgICB2YXIgYXN5bmNDb21wb25lbnRQcm90b3R5cGUgPSBBc3luY0NvbXBvbmVudC5wcm90b3R5cGUgPSBuZXcgQ29tcG9uZW50RHVtbXkoKTsKICAgICAgYXN5bmNDb21wb25lbnRQcm90b3R5cGUuY29uc3RydWN0b3IgPSBBc3luY0NvbXBvbmVudDsKCiAgICAgIF9hc3NpZ24oYXN5bmNDb21wb25lbnRQcm90b3R5cGUsIENvbXBvbmVudC5wcm90b3R5cGUpOwoKICAgICAgYXN5bmNDb21wb25lbnRQcm90b3R5cGUudW5zdGFibGVfaXNBc3luY1JlYWN0Q29tcG9uZW50ID0gdHJ1ZTsKCiAgICAgIGFzeW5jQ29tcG9uZW50UHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5jaGlsZHJlbjsKICAgICAgfTsKCiAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciA9IHsKICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgIH07CiAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgIHZhciBSRVNFUlZFRF9QUk9QUyA9IHsKICAgICAgICBrZXk6IHRydWUsCiAgICAgICAgcmVmOiB0cnVlLAogICAgICAgIF9fc2VsZjogdHJ1ZSwKICAgICAgICBfX3NvdXJjZTogdHJ1ZQogICAgICB9OwogICAgICB2YXIgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd247CiAgICAgIHZhciBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bjsKCiAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkUmVmKGNvbmZpZykgewogICAgICAgIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgJ3JlZicpKSB7CiAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgJ3JlZicpLmdldDsKCiAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb25maWcucmVmICE9PSB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkS2V5KGNvbmZpZykgewogICAgICAgIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgJ2tleScpKSB7CiAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgJ2tleScpLmdldDsKCiAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb25maWcua2V5ICE9PSB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkgPSBmdW5jdGlvbiB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkoKSB7CiAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgd2FybmluZyhmYWxzZSwgJyVzOiBga2V5YCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0ICcgKyAnaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSAnICsgJ3ZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgJyArICdwcm9wLiAoaHR0cHM6Ly9mYi5tZS9yZWFjdC1zcGVjaWFsLXByb3BzKScsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgJ2tleScsIHsKICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nS2V5LAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYgPSBmdW5jdGlvbiB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYoKSB7CiAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgd2FybmluZyhmYWxzZSwgJyVzOiBgcmVmYCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0ICcgKyAnaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSAnICsgJ3ZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgJyArICdwcm9wLiAoaHR0cHM6Ly9mYi5tZS9yZWFjdC1zcGVjaWFsLXByb3BzKScsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgJ3JlZicsIHsKICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nUmVmLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHZhciBSZWFjdEVsZW1lbnQgPSBmdW5jdGlvbiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYsIHNvdXJjZSwgb3duZXIsIHByb3BzKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSB7CiAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfRUxFTUVOVF9UWVBFLAogICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgcmVmOiByZWYsCiAgICAgICAgICBwcm9wczogcHJvcHMsCiAgICAgICAgICBfb3duZXI6IG93bmVyCiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICBlbGVtZW50Ll9zdG9yZSA9IHt9OwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQuX3N0b3JlLCAndmFsaWRhdGVkJywgewogICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgfSk7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgJ19zZWxmJywgewogICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgICB2YWx1ZTogc2VsZgogICAgICAgICAgfSk7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgJ19zb3VyY2UnLCB7CiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgIHZhbHVlOiBzb3VyY2UKICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICB9OwoKICAgICAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudCh0eXBlLCBjb25maWcsIGNoaWxkcmVuKSB7CiAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgIHZhciBwcm9wcyA9IHt9OwogICAgICAgIHZhciBrZXkgPSBudWxsOwogICAgICAgIHZhciByZWYgPSBudWxsOwogICAgICAgIHZhciBzZWxmID0gbnVsbDsKICAgICAgICB2YXIgc291cmNlID0gbnVsbDsKCiAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICBpZiAoaGFzVmFsaWRSZWYoY29uZmlnKSkgewogICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChoYXNWYWxpZEtleShjb25maWcpKSB7CiAgICAgICAgICAgIGtleSA9ICcnICsgY29uZmlnLmtleTsKICAgICAgICAgIH0KCiAgICAgICAgICBzZWxmID0gY29uZmlnLl9fc2VsZiA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGNvbmZpZy5fX3NlbGY7CiAgICAgICAgICBzb3VyY2UgPSBjb25maWcuX19zb3VyY2UgPT09IHVuZGVmaW5lZCA/IG51bGwgOiBjb25maWcuX19zb3VyY2U7CgogICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCBwcm9wTmFtZSkgJiYgIVJFU0VSVkVEX1BST1BTLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBjaGlsZHJlbkxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGggLSAyOwoKICAgICAgICBpZiAoY2hpbGRyZW5MZW5ndGggPT09IDEpIHsKICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbkxlbmd0aCA+IDEpIHsKICAgICAgICAgIHZhciBjaGlsZEFycmF5ID0gQXJyYXkoY2hpbGRyZW5MZW5ndGgpOwoKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW5MZW5ndGg7IGkrKykgewogICAgICAgICAgICBjaGlsZEFycmF5W2ldID0gYXJndW1lbnRzW2kgKyAyXTsKICAgICAgICAgIH0KCiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShjaGlsZEFycmF5KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZEFycmF5OwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGUgJiYgdHlwZS5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSB0eXBlLmRlZmF1bHRQcm9wczsKCiAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB7CiAgICAgICAgICBpZiAoa2V5IHx8IHJlZikgewogICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLiQkdHlwZW9mID09PSAndW5kZWZpbmVkJyB8fCBwcm9wcy4kJHR5cGVvZiAhPT0gUkVBQ1RfRUxFTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gdHlwZW9mIHR5cGUgPT09ICdmdW5jdGlvbicgPyB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCAnVW5rbm93bicgOiB0eXBlOwoKICAgICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKHJlZikgewogICAgICAgICAgICAgICAgZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudCh0eXBlLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LCBwcm9wcyk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNsb25lQW5kUmVwbGFjZUtleShvbGRFbGVtZW50LCBuZXdLZXkpIHsKICAgICAgICB2YXIgbmV3RWxlbWVudCA9IFJlYWN0RWxlbWVudChvbGRFbGVtZW50LnR5cGUsIG5ld0tleSwgb2xkRWxlbWVudC5yZWYsIG9sZEVsZW1lbnQuX3NlbGYsIG9sZEVsZW1lbnQuX3NvdXJjZSwgb2xkRWxlbWVudC5fb3duZXIsIG9sZEVsZW1lbnQucHJvcHMpOwogICAgICAgIHJldHVybiBuZXdFbGVtZW50OwogICAgICB9CgogICAgICBmdW5jdGlvbiBjbG9uZUVsZW1lbnQoZWxlbWVudCwgY29uZmlnLCBjaGlsZHJlbikgewogICAgICAgIHZhciBwcm9wTmFtZTsKCiAgICAgICAgdmFyIHByb3BzID0gX2Fzc2lnbih7fSwgZWxlbWVudC5wcm9wcyk7CgogICAgICAgIHZhciBrZXkgPSBlbGVtZW50LmtleTsKICAgICAgICB2YXIgcmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgdmFyIHNlbGYgPSBlbGVtZW50Ll9zZWxmOwogICAgICAgIHZhciBzb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CgogICAgICAgIGlmIChjb25maWcgIT0gbnVsbCkgewogICAgICAgICAgaWYgKGhhc1ZhbGlkUmVmKGNvbmZpZykpIHsKICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50OwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChoYXNWYWxpZEtleShjb25maWcpKSB7CiAgICAgICAgICAgIGtleSA9ICcnICsgY29uZmlnLmtleTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzOwoKICAgICAgICAgIGlmIChlbGVtZW50LnR5cGUgJiYgZWxlbWVudC50eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICBkZWZhdWx0UHJvcHMgPSBlbGVtZW50LnR5cGUuZGVmYXVsdFByb3BzOwogICAgICAgICAgfQoKICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gY29uZmlnKSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICBpZiAoY29uZmlnW3Byb3BOYW1lXSA9PT0gdW5kZWZpbmVkICYmIGRlZmF1bHRQcm9wcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGNoaWxkcmVuTGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCAtIDI7CgogICAgICAgIGlmIChjaGlsZHJlbkxlbmd0aCA9PT0gMSkgewogICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgICB9IGVsc2UgaWYgKGNoaWxkcmVuTGVuZ3RoID4gMSkgewogICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CgogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNoaWxkQXJyYXlbaV0gPSBhcmd1bWVudHNbaSArIDJdOwogICAgICAgICAgfQoKICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRBcnJheTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQoZWxlbWVudC50eXBlLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBvd25lciwgcHJvcHMpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBpc1ZhbGlkRWxlbWVudChvYmplY3QpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIG9iamVjdCA9PT0gJ29iamVjdCcgJiYgb2JqZWN0ICE9PSBudWxsICYmIG9iamVjdC4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFOwogICAgICB9CgogICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IHt9OwogICAgICB7CiAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRDdXJyZW50U3RhY2sgPSBudWxsOwoKICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldFN0YWNrQWRkZW5kdW0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgaW1wbCA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrOwoKICAgICAgICAgIGlmIChpbXBsKSB7CiAgICAgICAgICAgIHJldHVybiBpbXBsKCk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgfQogICAgICB2YXIgU0VQQVJBVE9SID0gJy4nOwogICAgICB2YXIgU1VCU0VQQVJBVE9SID0gJzonOwoKICAgICAgZnVuY3Rpb24gZXNjYXBlKGtleSkgewogICAgICAgIHZhciBlc2NhcGVSZWdleCA9IC9bPTpdL2c7CiAgICAgICAgdmFyIGVzY2FwZXJMb29rdXAgPSB7CiAgICAgICAgICAnPSc6ICc9MCcsCiAgICAgICAgICAnOic6ICc9MicKICAgICAgICB9OwogICAgICAgIHZhciBlc2NhcGVkU3RyaW5nID0gKCcnICsga2V5KS5yZXBsYWNlKGVzY2FwZVJlZ2V4LCBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICAgIHJldHVybiBlc2NhcGVyTG9va3VwW21hdGNoXTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gJyQnICsgZXNjYXBlZFN0cmluZzsKICAgICAgfQoKICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgdmFyIHVzZXJQcm92aWRlZEtleUVzY2FwZVJlZ2V4ID0gL1wvKy9nOwoKICAgICAgZnVuY3Rpb24gZXNjYXBlVXNlclByb3ZpZGVkS2V5KHRleHQpIHsKICAgICAgICByZXR1cm4gKCcnICsgdGV4dCkucmVwbGFjZSh1c2VyUHJvdmlkZWRLZXlFc2NhcGVSZWdleCwgJyQmLycpOwogICAgICB9CgogICAgICB2YXIgUE9PTF9TSVpFID0gMTA7CiAgICAgIHZhciB0cmF2ZXJzZUNvbnRleHRQb29sID0gW107CgogICAgICBmdW5jdGlvbiBnZXRQb29sZWRUcmF2ZXJzZUNvbnRleHQobWFwUmVzdWx0LCBrZXlQcmVmaXgsIG1hcEZ1bmN0aW9uLCBtYXBDb250ZXh0KSB7CiAgICAgICAgaWYgKHRyYXZlcnNlQ29udGV4dFBvb2wubGVuZ3RoKSB7CiAgICAgICAgICB2YXIgdHJhdmVyc2VDb250ZXh0ID0gdHJhdmVyc2VDb250ZXh0UG9vbC5wb3AoKTsKICAgICAgICAgIHRyYXZlcnNlQ29udGV4dC5yZXN1bHQgPSBtYXBSZXN1bHQ7CiAgICAgICAgICB0cmF2ZXJzZUNvbnRleHQua2V5UHJlZml4ID0ga2V5UHJlZml4OwogICAgICAgICAgdHJhdmVyc2VDb250ZXh0LmZ1bmMgPSBtYXBGdW5jdGlvbjsKICAgICAgICAgIHRyYXZlcnNlQ29udGV4dC5jb250ZXh0ID0gbWFwQ29udGV4dDsKICAgICAgICAgIHRyYXZlcnNlQ29udGV4dC5jb3VudCA9IDA7CiAgICAgICAgICByZXR1cm4gdHJhdmVyc2VDb250ZXh0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN1bHQ6IG1hcFJlc3VsdCwKICAgICAgICAgICAga2V5UHJlZml4OiBrZXlQcmVmaXgsCiAgICAgICAgICAgIGZ1bmM6IG1hcEZ1bmN0aW9uLAogICAgICAgICAgICBjb250ZXh0OiBtYXBDb250ZXh0LAogICAgICAgICAgICBjb3VudDogMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHJlbGVhc2VUcmF2ZXJzZUNvbnRleHQodHJhdmVyc2VDb250ZXh0KSB7CiAgICAgICAgdHJhdmVyc2VDb250ZXh0LnJlc3VsdCA9IG51bGw7CiAgICAgICAgdHJhdmVyc2VDb250ZXh0LmtleVByZWZpeCA9IG51bGw7CiAgICAgICAgdHJhdmVyc2VDb250ZXh0LmZ1bmMgPSBudWxsOwogICAgICAgIHRyYXZlcnNlQ29udGV4dC5jb250ZXh0ID0gbnVsbDsKICAgICAgICB0cmF2ZXJzZUNvbnRleHQuY291bnQgPSAwOwoKICAgICAgICBpZiAodHJhdmVyc2VDb250ZXh0UG9vbC5sZW5ndGggPCBQT09MX1NJWkUpIHsKICAgICAgICAgIHRyYXZlcnNlQ29udGV4dFBvb2wucHVzaCh0cmF2ZXJzZUNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gdHJhdmVyc2VBbGxDaGlsZHJlbkltcGwoY2hpbGRyZW4sIG5hbWVTb0ZhciwgY2FsbGJhY2ssIHRyYXZlcnNlQ29udGV4dCkgewogICAgICAgIHZhciB0eXBlID0gdHlwZW9mIGNoaWxkcmVuOwoKICAgICAgICBpZiAodHlwZSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICBjaGlsZHJlbiA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICB2YXIgaW52b2tlQ2FsbGJhY2sgPSBmYWxzZTsKCiAgICAgICAgaWYgKGNoaWxkcmVuID09PSBudWxsKSB7CiAgICAgICAgICBpbnZva2VDYWxsYmFjayA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgICBjYXNlICdudW1iZXInOgogICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ29iamVjdCc6CiAgICAgICAgICAgICAgc3dpdGNoIChjaGlsZHJlbi4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NBTExfVFlQRToKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUkVUVVJOX1RZUEU6CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICBpbnZva2VDYWxsYmFjayA9IHRydWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChpbnZva2VDYWxsYmFjaykgewogICAgICAgICAgY2FsbGJhY2sodHJhdmVyc2VDb250ZXh0LCBjaGlsZHJlbiwgbmFtZVNvRmFyID09PSAnJyA/IFNFUEFSQVRPUiArIGdldENvbXBvbmVudEtleShjaGlsZHJlbiwgMCkgOiBuYW1lU29GYXIpOwogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQoKICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgdmFyIG5leHROYW1lOwogICAgICAgIHZhciBzdWJ0cmVlQ291bnQgPSAwOwogICAgICAgIHZhciBuZXh0TmFtZVByZWZpeCA9IG5hbWVTb0ZhciA9PT0gJycgPyBTRVBBUkFUT1IgOiBuYW1lU29GYXIgKyBTVUJTRVBBUkFUT1I7CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNoaWxkcmVuKSkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgICAgICAgICBuZXh0TmFtZSA9IG5leHROYW1lUHJlZml4ICsgZ2V0Q29tcG9uZW50S2V5KGNoaWxkLCBpKTsKICAgICAgICAgICAgc3VidHJlZUNvdW50ICs9IHRyYXZlcnNlQWxsQ2hpbGRyZW5JbXBsKGNoaWxkLCBuZXh0TmFtZSwgY2FsbGJhY2ssIHRyYXZlcnNlQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihjaGlsZHJlbik7CgogICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiA9PT0gY2hpbGRyZW4uZW50cmllcykgewogICAgICAgICAgICAgICAgd2FybmluZyhkaWRXYXJuQWJvdXRNYXBzLCAnVXNpbmcgTWFwcyBhcyBjaGlsZHJlbiBpcyB1bnN1cHBvcnRlZCBhbmQgd2lsbCBsaWtlbHkgeWllbGQgJyArICd1bmV4cGVjdGVkIHJlc3VsdHMuIENvbnZlcnQgaXQgdG8gYSBzZXF1ZW5jZS9pdGVyYWJsZSBvZiBrZXllZCAnICsgJ1JlYWN0RWxlbWVudHMgaW5zdGVhZC4lcycsIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0U3RhY2tBZGRlbmR1bSgpKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1hcHMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwoY2hpbGRyZW4pOwogICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgdmFyIGlpID0gMDsKCiAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICBjaGlsZCA9IHN0ZXAudmFsdWU7CiAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldENvbXBvbmVudEtleShjaGlsZCwgaWkrKyk7CiAgICAgICAgICAgICAgc3VidHJlZUNvdW50ICs9IHRyYXZlcnNlQWxsQ2hpbGRyZW5JbXBsKGNoaWxkLCBuZXh0TmFtZSwgY2FsbGJhY2ssIHRyYXZlcnNlQ29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgdmFyIGFkZGVuZHVtID0gJyc7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBhZGRlbmR1bSA9ICcgSWYgeW91IG1lYW50IHRvIHJlbmRlciBhIGNvbGxlY3Rpb24gb2YgY2hpbGRyZW4sIHVzZSBhbiBhcnJheSAnICsgJ2luc3RlYWQuJyArIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZHJlblN0cmluZyA9ICcnICsgY2hpbGRyZW47CiAgICAgICAgICAgIGludmFyaWFudChmYWxzZSwgJ09iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogJXMpLiVzJywgY2hpbGRyZW5TdHJpbmcgPT09ICdbb2JqZWN0IE9iamVjdF0nID8gJ29iamVjdCB3aXRoIGtleXMgeycgKyBPYmplY3Qua2V5cyhjaGlsZHJlbikuam9pbignLCAnKSArICd9JyA6IGNoaWxkcmVuU3RyaW5nLCBhZGRlbmR1bSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc3VidHJlZUNvdW50OwogICAgICB9CgogICAgICBmdW5jdGlvbiB0cmF2ZXJzZUFsbENoaWxkcmVuKGNoaWxkcmVuLCBjYWxsYmFjaywgdHJhdmVyc2VDb250ZXh0KSB7CiAgICAgICAgaWYgKGNoaWxkcmVuID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRyYXZlcnNlQWxsQ2hpbGRyZW5JbXBsKGNoaWxkcmVuLCAnJywgY2FsbGJhY2ssIHRyYXZlcnNlQ29udGV4dCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudEtleShjb21wb25lbnQsIGluZGV4KSB7CiAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQgPT09ICdvYmplY3QnICYmIGNvbXBvbmVudCAhPT0gbnVsbCAmJiBjb21wb25lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgIHJldHVybiBlc2NhcGUoY29tcG9uZW50LmtleSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaW5kZXgudG9TdHJpbmcoMzYpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBmb3JFYWNoU2luZ2xlQ2hpbGQoYm9va0tlZXBpbmcsIGNoaWxkLCBuYW1lKSB7CiAgICAgICAgdmFyIGZ1bmMgPSBib29rS2VlcGluZy5mdW5jLAogICAgICAgICAgICBjb250ZXh0ID0gYm9va0tlZXBpbmcuY29udGV4dDsKICAgICAgICBmdW5jLmNhbGwoY29udGV4dCwgY2hpbGQsIGJvb2tLZWVwaW5nLmNvdW50KyspOwogICAgICB9CgogICAgICBmdW5jdGlvbiBmb3JFYWNoQ2hpbGRyZW4oY2hpbGRyZW4sIGZvckVhY2hGdW5jLCBmb3JFYWNoQ29udGV4dCkgewogICAgICAgIGlmIChjaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfQoKICAgICAgICB2YXIgdHJhdmVyc2VDb250ZXh0ID0gZ2V0UG9vbGVkVHJhdmVyc2VDb250ZXh0KG51bGwsIG51bGwsIGZvckVhY2hGdW5jLCBmb3JFYWNoQ29udGV4dCk7CiAgICAgICAgdHJhdmVyc2VBbGxDaGlsZHJlbihjaGlsZHJlbiwgZm9yRWFjaFNpbmdsZUNoaWxkLCB0cmF2ZXJzZUNvbnRleHQpOwogICAgICAgIHJlbGVhc2VUcmF2ZXJzZUNvbnRleHQodHJhdmVyc2VDb250ZXh0KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gbWFwU2luZ2xlQ2hpbGRJbnRvQ29udGV4dChib29rS2VlcGluZywgY2hpbGQsIGNoaWxkS2V5KSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGJvb2tLZWVwaW5nLnJlc3VsdCwKICAgICAgICAgICAga2V5UHJlZml4ID0gYm9va0tlZXBpbmcua2V5UHJlZml4LAogICAgICAgICAgICBmdW5jID0gYm9va0tlZXBpbmcuZnVuYywKICAgICAgICAgICAgY29udGV4dCA9IGJvb2tLZWVwaW5nLmNvbnRleHQ7CiAgICAgICAgdmFyIG1hcHBlZENoaWxkID0gZnVuYy5jYWxsKGNvbnRleHQsIGNoaWxkLCBib29rS2VlcGluZy5jb3VudCsrKTsKCiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICBtYXBJbnRvV2l0aEtleVByZWZpeEludGVybmFsKG1hcHBlZENoaWxkLCByZXN1bHQsIGNoaWxkS2V5LCBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zQXJndW1lbnQpOwogICAgICAgIH0gZWxzZSBpZiAobWFwcGVkQ2hpbGQgIT0gbnVsbCkgewogICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50KG1hcHBlZENoaWxkKSkgewogICAgICAgICAgICBtYXBwZWRDaGlsZCA9IGNsb25lQW5kUmVwbGFjZUtleShtYXBwZWRDaGlsZCwga2V5UHJlZml4ICsgKG1hcHBlZENoaWxkLmtleSAmJiAoIWNoaWxkIHx8IGNoaWxkLmtleSAhPT0gbWFwcGVkQ2hpbGQua2V5KSA/IGVzY2FwZVVzZXJQcm92aWRlZEtleShtYXBwZWRDaGlsZC5rZXkpICsgJy8nIDogJycpICsgY2hpbGRLZXkpOwogICAgICAgICAgfQoKICAgICAgICAgIHJlc3VsdC5wdXNoKG1hcHBlZENoaWxkKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIG1hcEludG9XaXRoS2V5UHJlZml4SW50ZXJuYWwoY2hpbGRyZW4sIGFycmF5LCBwcmVmaXgsIGZ1bmMsIGNvbnRleHQpIHsKICAgICAgICB2YXIgZXNjYXBlZFByZWZpeCA9ICcnOwoKICAgICAgICBpZiAocHJlZml4ICE9IG51bGwpIHsKICAgICAgICAgIGVzY2FwZWRQcmVmaXggPSBlc2NhcGVVc2VyUHJvdmlkZWRLZXkocHJlZml4KSArICcvJzsKICAgICAgICB9CgogICAgICAgIHZhciB0cmF2ZXJzZUNvbnRleHQgPSBnZXRQb29sZWRUcmF2ZXJzZUNvbnRleHQoYXJyYXksIGVzY2FwZWRQcmVmaXgsIGZ1bmMsIGNvbnRleHQpOwogICAgICAgIHRyYXZlcnNlQWxsQ2hpbGRyZW4oY2hpbGRyZW4sIG1hcFNpbmdsZUNoaWxkSW50b0NvbnRleHQsIHRyYXZlcnNlQ29udGV4dCk7CiAgICAgICAgcmVsZWFzZVRyYXZlcnNlQ29udGV4dCh0cmF2ZXJzZUNvbnRleHQpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBtYXBDaGlsZHJlbihjaGlsZHJlbiwgZnVuYywgY29udGV4dCkgewogICAgICAgIGlmIChjaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgbWFwSW50b1dpdGhLZXlQcmVmaXhJbnRlcm5hbChjaGlsZHJlbiwgcmVzdWx0LCBudWxsLCBmdW5jLCBjb250ZXh0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CgogICAgICBmdW5jdGlvbiBjb3VudENoaWxkcmVuKGNoaWxkcmVuLCBjb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIHRyYXZlcnNlQWxsQ2hpbGRyZW4oY2hpbGRyZW4sIGVtcHR5RnVuY3Rpb24udGhhdFJldHVybnNOdWxsLCBudWxsKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gdG9BcnJheShjaGlsZHJlbikgewogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICBtYXBJbnRvV2l0aEtleVByZWZpeEludGVybmFsKGNoaWxkcmVuLCByZXN1bHQsIG51bGwsIGVtcHR5RnVuY3Rpb24udGhhdFJldHVybnNBcmd1bWVudCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gb25seUNoaWxkKGNoaWxkcmVuKSB7CiAgICAgICAgIWlzVmFsaWRFbGVtZW50KGNoaWxkcmVuKSA/IGludmFyaWFudChmYWxzZSwgJ1JlYWN0LkNoaWxkcmVuLm9ubHkgZXhwZWN0ZWQgdG8gcmVjZWl2ZSBhIHNpbmdsZSBSZWFjdCBlbGVtZW50IGNoaWxkLicpIDogdm9pZCAwOwogICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgfQoKICAgICAgdmFyIGRlc2NyaWJlQ29tcG9uZW50RnJhbWUgPSBmdW5jdGlvbiBkZXNjcmliZUNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJOYW1lKSB7CiAgICAgICAgcmV0dXJuICdcbiAgICBpbiAnICsgKG5hbWUgfHwgJ1Vua25vd24nKSArIChzb3VyY2UgPyAnIChhdCAnICsgc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICcnKSArICc6JyArIHNvdXJjZS5saW5lTnVtYmVyICsgJyknIDogb3duZXJOYW1lID8gJyAoY3JlYXRlZCBieSAnICsgb3duZXJOYW1lICsgJyknIDogJycpOwogICAgICB9OwoKICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZShmaWJlcikgewogICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKCiAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICB7CiAgICAgICAgdmFyIGN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50ID0gbnVsbDsKICAgICAgICB2YXIgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSBmYWxzZTsKCiAgICAgICAgdmFyIGdldERpc3BsYXlOYW1lID0gZnVuY3Rpb24gZ2V0RGlzcGxheU5hbWUoZWxlbWVudCkgewogICAgICAgICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gJyNlbXB0eSc7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgZWxlbWVudCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgcmV0dXJuICcjdGV4dCc7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbGVtZW50LnR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnR5cGU7CiAgICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICByZXR1cm4gJ1JlYWN0LkZyYWdtZW50JzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnR5cGUuZGlzcGxheU5hbWUgfHwgZWxlbWVudC50eXBlLm5hbWUgfHwgJ1Vua25vd24nOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBnZXRTdGFja0FkZGVuZHVtID0gZnVuY3Rpb24gZ2V0U3RhY2tBZGRlbmR1bSgpIHsKICAgICAgICAgIHZhciBzdGFjayA9ICcnOwoKICAgICAgICAgIGlmIChjdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCkgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldERpc3BsYXlOYW1lKGN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KTsKICAgICAgICAgICAgdmFyIG93bmVyID0gY3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQuX293bmVyOwogICAgICAgICAgICBzdGFjayArPSBkZXNjcmliZUNvbXBvbmVudEZyYW1lKG5hbWUsIGN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50Ll9zb3VyY2UsIG93bmVyICYmIGdldENvbXBvbmVudE5hbWUob3duZXIpKTsKICAgICAgICAgIH0KCiAgICAgICAgICBzdGFjayArPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldFN0YWNrQWRkZW5kdW0oKSB8fCAnJzsKICAgICAgICAgIHJldHVybiBzdGFjazsKICAgICAgICB9OwoKICAgICAgICB2YXIgVkFMSURfRlJBR01FTlRfUFJPUFMgPSBuZXcgTWFwKFtbJ2NoaWxkcmVuJywgdHJ1ZV0sIFsna2V5JywgdHJ1ZV1dKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkgewogICAgICAgIGlmIChSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCk7CgogICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuICdcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCcgKyBuYW1lICsgJ2AuJzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAnJzsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oZWxlbWVudFByb3BzKSB7CiAgICAgICAgaWYgKGVsZW1lbnRQcm9wcyAhPT0gbnVsbCAmJiBlbGVtZW50UHJvcHMgIT09IHVuZGVmaW5lZCAmJiBlbGVtZW50UHJvcHMuX19zb3VyY2UgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFyIHNvdXJjZSA9IGVsZW1lbnRQcm9wcy5fX3NvdXJjZTsKICAgICAgICAgIHZhciBmaWxlTmFtZSA9IHNvdXJjZS5maWxlTmFtZS5yZXBsYWNlKC9eLipbXFxcL10vLCAnJyk7CiAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgcmV0dXJuICdcblxuQ2hlY2sgeW91ciBjb2RlIGF0ICcgKyBmaWxlTmFtZSArICc6JyArIGxpbmVOdW1iZXIgKyAnLic7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0KCiAgICAgIHZhciBvd25lckhhc0tleVVzZVdhcm5pbmcgPSB7fTsKCiAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSkgewogICAgICAgIHZhciBpbmZvID0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CgogICAgICAgIGlmICghaW5mbykgewogICAgICAgICAgdmFyIHBhcmVudE5hbWUgPSB0eXBlb2YgcGFyZW50VHlwZSA9PT0gJ3N0cmluZycgPyBwYXJlbnRUeXBlIDogcGFyZW50VHlwZS5kaXNwbGF5TmFtZSB8fCBwYXJlbnRUeXBlLm5hbWU7CgogICAgICAgICAgaWYgKHBhcmVudE5hbWUpIHsKICAgICAgICAgICAgaW5mbyA9ICdcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8JyArIHBhcmVudE5hbWUgKyAnPi4nOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGluZm87CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRXhwbGljaXRLZXkoZWxlbWVudCwgcGFyZW50VHlwZSkgewogICAgICAgIGlmICghZWxlbWVudC5fc3RvcmUgfHwgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkIHx8IGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwoKICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10gPSB0cnVlOwogICAgICAgIHZhciBjaGlsZE93bmVyID0gJyc7CgogICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICBjaGlsZE93bmVyID0gJyBJdCB3YXMgcGFzc2VkIGEgY2hpbGQgZnJvbSAnICsgZ2V0Q29tcG9uZW50TmFtZShlbGVtZW50Ll9vd25lcikgKyAnLic7CiAgICAgICAgfQoKICAgICAgICBjdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgewogICAgICAgICAgd2FybmluZyhmYWxzZSwgJ0VhY2ggY2hpbGQgaW4gYW4gYXJyYXkgb3IgaXRlcmF0b3Igc2hvdWxkIGhhdmUgYSB1bmlxdWUgImtleSIgcHJvcC4nICsgJyVzJXMgU2VlIGh0dHBzOi8vZmIubWUvcmVhY3Qtd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLiVzJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lciwgZ2V0U3RhY2tBZGRlbmR1bSgpKTsKICAgICAgICB9CiAgICAgICAgY3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQgPSBudWxsOwogICAgICB9CgogICAgICBmdW5jdGlvbiB2YWxpZGF0ZUNoaWxkS2V5cyhub2RlLCBwYXJlbnRUeXBlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAnb2JqZWN0JykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZSkpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlW2ldOwoKICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50KGNoaWxkKSkgewogICAgICAgICAgICAgIHZhbGlkYXRlRXhwbGljaXRLZXkoY2hpbGQsIHBhcmVudFR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChpc1ZhbGlkRWxlbWVudChub2RlKSkgewogICAgICAgICAgaWYgKG5vZGUuX3N0b3JlKSB7CiAgICAgICAgICAgIG5vZGUuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChub2RlKSB7CiAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obm9kZSk7CgogICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGlmIChpdGVyYXRvckZuICE9PSBub2RlLmVudHJpZXMpIHsKICAgICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwobm9kZSk7CiAgICAgICAgICAgICAgdmFyIHN0ZXA7CgogICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudChzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KHN0ZXAudmFsdWUsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgIHZhciBjb21wb25lbnRDbGFzcyA9IGVsZW1lbnQudHlwZTsKCiAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnRDbGFzcyAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIG5hbWUgPSBjb21wb25lbnRDbGFzcy5kaXNwbGF5TmFtZSB8fCBjb21wb25lbnRDbGFzcy5uYW1lOwogICAgICAgIHZhciBwcm9wVHlwZXMgPSBjb21wb25lbnRDbGFzcy5wcm9wVHlwZXM7CgogICAgICAgIGlmIChwcm9wVHlwZXMpIHsKICAgICAgICAgIGN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKHByb3BUeXBlcywgZWxlbWVudC5wcm9wcywgJ3Byb3AnLCBuYW1lLCBnZXRTdGFja0FkZGVuZHVtKTsKICAgICAgICAgIGN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50ID0gbnVsbDsKICAgICAgICB9IGVsc2UgaWYgKGNvbXBvbmVudENsYXNzLlByb3BUeXBlcyAhPT0gdW5kZWZpbmVkICYmICFwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93bikgewogICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgd2FybmluZyhmYWxzZSwgJ0NvbXBvbmVudCAlcyBkZWNsYXJlZCBgUHJvcFR5cGVzYCBpbnN0ZWFkIG9mIGBwcm9wVHlwZXNgLiBEaWQgeW91IG1pc3NwZWxsIHRoZSBwcm9wZXJ0eSBhc3NpZ25tZW50PycsIG5hbWUgfHwgJ1Vua25vd24nKTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgY29tcG9uZW50Q2xhc3MuZ2V0RGVmYXVsdFByb3BzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICB3YXJuaW5nKGNvbXBvbmVudENsYXNzLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCwgJ2dldERlZmF1bHRQcm9wcyBpcyBvbmx5IHVzZWQgb24gY2xhc3NpYyBSZWFjdC5jcmVhdGVDbGFzcyAnICsgJ2RlZmluaXRpb25zLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgbmFtZWQgYGRlZmF1bHRQcm9wc2AgaW5zdGVhZC4nKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhmcmFnbWVudCkgewogICAgICAgIGN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50ID0gZnJhZ21lbnQ7CiAgICAgICAgdmFyIF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24gPSB0cnVlOwogICAgICAgIHZhciBfZGlkSXRlcmF0b3JFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBfaXRlcmF0b3JFcnJvciA9IHVuZGVmaW5lZDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZvciAodmFyIF9pdGVyYXRvciA9IE9iamVjdC5rZXlzKGZyYWdtZW50LnByb3BzKVt0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLml0ZXJhdG9yIDogIkBAaXRlcmF0b3IiXSgpLCBfc3RlcDsgIShfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uID0gKF9zdGVwID0gX2l0ZXJhdG9yLm5leHQoKSkuZG9uZSk7IF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24gPSB0cnVlKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBfc3RlcC52YWx1ZTsKCiAgICAgICAgICAgIGlmICghVkFMSURfRlJBR01FTlRfUFJPUFMuaGFzKGtleSkpIHsKICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAnSW52YWxpZCBwcm9wIGAlc2Agc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4gJyArICdSZWFjdC5GcmFnbWVudCBjYW4gb25seSBoYXZlIGBrZXlgIGFuZCBgY2hpbGRyZW5gIHByb3BzLiVzJywga2V5LCBnZXRTdGFja0FkZGVuZHVtKCkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBfZGlkSXRlcmF0b3JFcnJvciA9IHRydWU7CiAgICAgICAgICBfaXRlcmF0b3JFcnJvciA9IGVycjsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKCFfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uICYmIF9pdGVyYXRvclsncmV0dXJuJ10pIHsKICAgICAgICAgICAgICBfaXRlcmF0b3JbJ3JldHVybiddKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGlmIChfZGlkSXRlcmF0b3JFcnJvcikgewogICAgICAgICAgICAgIHRocm93IF9pdGVyYXRvckVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZnJhZ21lbnQucmVmICE9PSBudWxsKSB7CiAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAnSW52YWxpZCBhdHRyaWJ1dGUgYHJlZmAgc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4lcycsIGdldFN0YWNrQWRkZW5kdW0oKSk7CiAgICAgICAgfQoKICAgICAgICBjdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCA9IG51bGw7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICB2YXIgdmFsaWRUeXBlID0gdHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB0eXBlID09PSAnZnVuY3Rpb24nIHx8IHR5cGVvZiB0eXBlID09PSAnc3ltYm9sJyB8fCB0eXBlb2YgdHlwZSA9PT0gJ251bWJlcic7CgogICAgICAgIGlmICghdmFsaWRUeXBlKSB7CiAgICAgICAgICB2YXIgaW5mbyA9ICcnOwoKICAgICAgICAgIGlmICh0eXBlID09PSB1bmRlZmluZWQgfHwgdHlwZW9mIHR5cGUgPT09ICdvYmplY3QnICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGluZm8gKz0gJyBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSAnICsgIml0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBzb3VyY2VJbmZvID0gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0ocHJvcHMpOwoKICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgIGluZm8gKz0gc291cmNlSW5mbzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluZm8gKz0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICB9CgogICAgICAgICAgaW5mbyArPSBnZXRTdGFja0FkZGVuZHVtKCkgfHwgJyc7CiAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAnUmVhY3QuY3JlYXRlRWxlbWVudDogdHlwZSBpcyBpbnZhbGlkIC0tIGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgJyArICdidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlICcgKyAnY29tcG9uZW50cykgYnV0IGdvdDogJXMuJXMnLCB0eXBlID09IG51bGwgPyB0eXBlIDogdHlwZW9mIHR5cGUsIGluZm8pOwogICAgICAgIH0KCiAgICAgICAgdmFyIGVsZW1lbnQgPSBjcmVhdGVFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIGlmIChlbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbGlkVHlwZSkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gJ3N5bWJvbCcgJiYgdHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgdmFsaWRhdGVGcmFnbWVudFByb3BzKGVsZW1lbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICB9CgogICAgICBmdW5jdGlvbiBjcmVhdGVGYWN0b3J5V2l0aFZhbGlkYXRpb24odHlwZSkgewogICAgICAgIHZhciB2YWxpZGF0ZWRGYWN0b3J5ID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uLmJpbmQobnVsbCwgdHlwZSk7CiAgICAgICAgdmFsaWRhdGVkRmFjdG9yeS50eXBlID0gdHlwZTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodmFsaWRhdGVkRmFjdG9yeSwgJ3R5cGUnLCB7CiAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgICBsb3dQcmlvcml0eVdhcm5pbmckMShmYWxzZSwgJ0ZhY3RvcnkudHlwZSBpcyBkZXByZWNhdGVkLiBBY2Nlc3MgdGhlIGNsYXNzIGRpcmVjdGx5ICcgKyAnYmVmb3JlIHBhc3NpbmcgaXQgdG8gY3JlYXRlRmFjdG9yeS4nKTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ3R5cGUnLCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogdHlwZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbGlkYXRlZEZhY3Rvcnk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNsb25lRWxlbWVudFdpdGhWYWxpZGF0aW9uKGVsZW1lbnQsIHByb3BzLCBjaGlsZHJlbikgewogICAgICAgIHZhciBuZXdFbGVtZW50ID0gY2xvbmVFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YWxpZGF0ZUNoaWxkS2V5cyhhcmd1bWVudHNbaV0sIG5ld0VsZW1lbnQudHlwZSk7CiAgICAgICAgfQoKICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhuZXdFbGVtZW50KTsKICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgfQoKICAgICAgdmFyIFJlYWN0ID0gewogICAgICAgIENoaWxkcmVuOiB7CiAgICAgICAgICBtYXA6IG1hcENoaWxkcmVuLAogICAgICAgICAgZm9yRWFjaDogZm9yRWFjaENoaWxkcmVuLAogICAgICAgICAgY291bnQ6IGNvdW50Q2hpbGRyZW4sCiAgICAgICAgICB0b0FycmF5OiB0b0FycmF5LAogICAgICAgICAgb25seTogb25seUNoaWxkCiAgICAgICAgfSwKICAgICAgICBDb21wb25lbnQ6IENvbXBvbmVudCwKICAgICAgICBQdXJlQ29tcG9uZW50OiBQdXJlQ29tcG9uZW50LAogICAgICAgIHVuc3RhYmxlX0FzeW5jQ29tcG9uZW50OiBBc3luY0NvbXBvbmVudCwKICAgICAgICBGcmFnbWVudDogUkVBQ1RfRlJBR01FTlRfVFlQRSwKICAgICAgICBjcmVhdGVFbGVtZW50OiBjcmVhdGVFbGVtZW50V2l0aFZhbGlkYXRpb24sCiAgICAgICAgY2xvbmVFbGVtZW50OiBjbG9uZUVsZW1lbnRXaXRoVmFsaWRhdGlvbiwKICAgICAgICBjcmVhdGVGYWN0b3J5OiBjcmVhdGVGYWN0b3J5V2l0aFZhbGlkYXRpb24sCiAgICAgICAgaXNWYWxpZEVsZW1lbnQ6IGlzVmFsaWRFbGVtZW50LAogICAgICAgIHZlcnNpb246IFJlYWN0VmVyc2lvbiwKICAgICAgICBfX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRDogewogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXI6IFJlYWN0Q3VycmVudE93bmVyLAogICAgICAgICAgYXNzaWduOiBfYXNzaWduCiAgICAgICAgfQogICAgICB9OwogICAgICB7CiAgICAgICAgX2Fzc2lnbihSZWFjdC5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCwgewogICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTogUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSwKICAgICAgICAgIFJlYWN0Q29tcG9uZW50VHJlZUhvb2s6IHt9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdmFyIFJlYWN0JDIgPSBPYmplY3QuZnJlZXplKHsKICAgICAgICBkZWZhdWx0OiBSZWFjdAogICAgICB9KTsKICAgICAgdmFyIFJlYWN0JDMgPSBSZWFjdCQyICYmIFJlYWN0IHx8IFJlYWN0JDI7CiAgICAgIHZhciByZWFjdCA9IFJlYWN0JDNbJ2RlZmF1bHQnXSA/IFJlYWN0JDNbJ2RlZmF1bHQnXSA6IFJlYWN0JDM7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVhY3Q7CiAgICB9KSgpOwogIH0KfSwxMTIsWzExMCwxMTEsMTMsNTYsNTcsMTEzXSwicmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgICB2YXIgd2FybmluZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJmYmpzL2xpYi93YXJuaW5nIik7CgogICAgdmFyIFJlYWN0UHJvcFR5cGVzU2VjcmV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgJy4vbGliL1JlYWN0UHJvcFR5cGVzU2VjcmV0Jyk7CgogICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogIH0KCiAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBnZXRTdGFjaykgewogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgIGlmICh0eXBlU3BlY3MuaGFzT3duUHJvcGVydHkodHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgdmFyIGVycm9yOwoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGludmFyaWFudCh0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gPT09ICdmdW5jdGlvbicsICclczogJXMgdHlwZSBgJXNgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tICcgKyAndGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCVzYC4nLCBjb21wb25lbnROYW1lIHx8ICdSZWFjdCBjbGFzcycsIGxvY2F0aW9uLCB0eXBlU3BlY05hbWUsIHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSk7CiAgICAgICAgICAgIGVycm9yID0gdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0odmFsdWVzLCB0eXBlU3BlY05hbWUsIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBudWxsLCBSZWFjdFByb3BUeXBlc1NlY3JldCk7CiAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICBlcnJvciA9IGV4OwogICAgICAgICAgfQoKICAgICAgICAgIHdhcm5pbmcoIWVycm9yIHx8IGVycm9yIGluc3RhbmNlb2YgRXJyb3IsICclczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciAnICsgJ2Z1bmN0aW9uIG11c3QgcmV0dXJuIGBudWxsYCBvciBhbiBgRXJyb3JgIGJ1dCByZXR1cm5lZCBhICVzLiAnICsgJ1lvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyICcgKyAnY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCAnICsgJ3NoYXBlIGFsbCByZXF1aXJlIGFuIGFyZ3VtZW50KS4nLCBjb21wb25lbnROYW1lIHx8ICdSZWFjdCBjbGFzcycsIGxvY2F0aW9uLCB0eXBlU3BlY05hbWUsIHR5cGVvZiBlcnJvcik7CgogICAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvci5tZXNzYWdlIGluIGxvZ2dlZFR5cGVGYWlsdXJlcykpIHsKICAgICAgICAgICAgbG9nZ2VkVHlwZUZhaWx1cmVzW2Vycm9yLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gZ2V0U3RhY2sgPyBnZXRTdGFjaygpIDogJyc7CiAgICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICdGYWlsZWQgJXMgdHlwZTogJXMlcycsIGxvY2F0aW9uLCBlcnJvci5tZXNzYWdlLCBzdGFjayAhPSBudWxsID8gc3RhY2sgOiAnJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGNoZWNrUHJvcFR5cGVzOwp9LDExMyxbMTMsNTYsMTE0XSwicHJvcC10eXBlcy9jaGVja1Byb3BUeXBlcy5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFJlYWN0UHJvcFR5cGVzU2VjcmV0ID0gJ1NFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEJzsKICBtb2R1bGUuZXhwb3J0cyA9IFJlYWN0UHJvcFR5cGVzU2VjcmV0Owp9LDExNCxbXSwicHJvcC10eXBlcy9saWIvUmVhY3RQcm9wVHlwZXNTZWNyZXQuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJQbGF0Zm9ybSIpOwoKICB2YXIgVUlNYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlVJTWFuYWdlciIpOwoKICB2YXIgVGV4dElucHV0U3RhdGUgPSB7CiAgICBfY3VycmVudGx5Rm9jdXNlZElEOiBudWxsLAogICAgY3VycmVudGx5Rm9jdXNlZEZpZWxkOiBmdW5jdGlvbiBjdXJyZW50bHlGb2N1c2VkRmllbGQoKSB7CiAgICAgIHJldHVybiB0aGlzLl9jdXJyZW50bHlGb2N1c2VkSUQ7CiAgICB9LAogICAgZm9jdXNUZXh0SW5wdXQ6IGZ1bmN0aW9uIGZvY3VzVGV4dElucHV0KHRleHRGaWVsZElEKSB7CiAgICAgIGlmICh0aGlzLl9jdXJyZW50bHlGb2N1c2VkSUQgIT09IHRleHRGaWVsZElEICYmIHRleHRGaWVsZElEICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5fY3VycmVudGx5Rm9jdXNlZElEID0gdGV4dEZpZWxkSUQ7CgogICAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgICAgICAgIFVJTWFuYWdlci5mb2N1cyh0ZXh0RmllbGRJRCk7CiAgICAgICAgfSBlbHNlIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICAgICAgICBVSU1hbmFnZXIuZGlzcGF0Y2hWaWV3TWFuYWdlckNvbW1hbmQodGV4dEZpZWxkSUQsIFVJTWFuYWdlci5BbmRyb2lkVGV4dElucHV0LkNvbW1hbmRzLmZvY3VzVGV4dElucHV0LCBudWxsKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBibHVyVGV4dElucHV0OiBmdW5jdGlvbiBibHVyVGV4dElucHV0KHRleHRGaWVsZElEKSB7CiAgICAgIGlmICh0aGlzLl9jdXJyZW50bHlGb2N1c2VkSUQgPT09IHRleHRGaWVsZElEICYmIHRleHRGaWVsZElEICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5fY3VycmVudGx5Rm9jdXNlZElEID0gbnVsbDsKCiAgICAgICAgaWYgKFBsYXRmb3JtLk9TID09PSAnaW9zJykgewogICAgICAgICAgVUlNYW5hZ2VyLmJsdXIodGV4dEZpZWxkSUQpOwogICAgICAgIH0gZWxzZSBpZiAoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJykgewogICAgICAgICAgVUlNYW5hZ2VyLmRpc3BhdGNoVmlld01hbmFnZXJDb21tYW5kKHRleHRGaWVsZElELCBVSU1hbmFnZXIuQW5kcm9pZFRleHRJbnB1dC5Db21tYW5kcy5ibHVyVGV4dElucHV0LCBudWxsKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwogIG1vZHVsZS5leHBvcnRzID0gVGV4dElucHV0U3RhdGU7Cn0sMTE1LFs1MiwxMDddLCJUZXh0SW5wdXRTdGF0ZSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGRlZXBEaWZmZXIgPSBmdW5jdGlvbiBkZWVwRGlmZmVyKG9uZSwgdHdvKSB7CiAgICBpZiAob25lID09PSB0d28pIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmICh0eXBlb2Ygb25lID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiB0d28gPT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmICh0eXBlb2Ygb25lICE9PSAnb2JqZWN0JyB8fCBvbmUgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIG9uZSAhPT0gdHdvOwogICAgfQoKICAgIGlmICh0eXBlb2YgdHdvICE9PSAnb2JqZWN0JyB8fCB0d28gPT09IG51bGwpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgaWYgKG9uZS5jb25zdHJ1Y3RvciAhPT0gdHdvLmNvbnN0cnVjdG9yKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGlmIChBcnJheS5pc0FycmF5KG9uZSkpIHsKICAgICAgdmFyIGxlbiA9IG9uZS5sZW5ndGg7CgogICAgICBpZiAodHdvLmxlbmd0aCAhPT0gbGVuKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGlpID0gMDsgaWkgPCBsZW47IGlpKyspIHsKICAgICAgICBpZiAoZGVlcERpZmZlcihvbmVbaWldLCB0d29baWldKSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgKHZhciBrZXkgaW4gb25lKSB7CiAgICAgICAgaWYgKGRlZXBEaWZmZXIob25lW2tleV0sIHR3b1trZXldKSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKHZhciB0d29LZXkgaW4gdHdvKSB7CiAgICAgICAgaWYgKG9uZVt0d29LZXldID09PSB1bmRlZmluZWQgJiYgdHdvW3R3b0tleV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH07CgogIG1vZHVsZS5leHBvcnRzID0gZGVlcERpZmZlcjsKfSwxMTYsW10sImRlZXBEaWZmZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgogIGZ1bmN0aW9uIGlzKHgsIHkpIHsKICAgIGlmICh4ID09PSB5KSB7CiAgICAgIHJldHVybiB4ICE9PSAwIHx8IHkgIT09IDAgfHwgMSAvIHggPT09IDEgLyB5OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHggIT09IHggJiYgeSAhPT0geTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHNoYWxsb3dFcXVhbChvYmpBLCBvYmpCKSB7CiAgICBpZiAoaXMob2JqQSwgb2JqQikpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgaWYgKHR5cGVvZiBvYmpBICE9PSAnb2JqZWN0JyB8fCBvYmpBID09PSBudWxsIHx8IHR5cGVvZiBvYmpCICE9PSAnb2JqZWN0JyB8fCBvYmpCID09PSBudWxsKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICB2YXIga2V5c0EgPSBPYmplY3Qua2V5cyhvYmpBKTsKICAgIHZhciBrZXlzQiA9IE9iamVjdC5rZXlzKG9iakIpOwoKICAgIGlmIChrZXlzQS5sZW5ndGggIT09IGtleXNCLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzQS5sZW5ndGg7IGkrKykgewogICAgICBpZiAoIWhhc093blByb3BlcnR5LmNhbGwob2JqQiwga2V5c0FbaV0pIHx8ICFpcyhvYmpBW2tleXNBW2ldXSwgb2JqQltrZXlzQVtpXV0pKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IHNoYWxsb3dFcXVhbDsKfSwxMTcsW10sImZianMvbGliL3NoYWxsb3dFcXVhbC5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZnVuY3Rpb24gZGVlcEZyZWV6ZUFuZFRocm93T25NdXRhdGlvbkluRGV2KG9iamVjdCkgewogICAgaWYgKF9fREVWX18pIHsKICAgICAgaWYgKHR5cGVvZiBvYmplY3QgIT09ICdvYmplY3QnIHx8IG9iamVjdCA9PT0gbnVsbCB8fCBPYmplY3QuaXNGcm96ZW4ob2JqZWN0KSB8fCBPYmplY3QuaXNTZWFsZWQob2JqZWN0KSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmplY3QpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CgogICAgICAgIGlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgb2JqZWN0Ll9fZGVmaW5lR2V0dGVyX18oa2V5LCBpZGVudGl0eS5iaW5kKG51bGwsIG9iamVjdFtrZXldKSk7CgogICAgICAgICAgb2JqZWN0Ll9fZGVmaW5lU2V0dGVyX18oa2V5LCB0aHJvd09uSW1tdXRhYmxlTXV0YXRpb24uYmluZChudWxsLCBrZXkpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIE9iamVjdC5mcmVlemUob2JqZWN0KTsKICAgICAgT2JqZWN0LnNlYWwob2JqZWN0KTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwoKICAgICAgICBpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgIGRlZXBGcmVlemVBbmRUaHJvd09uTXV0YXRpb25JbkRldihvYmplY3Rba2V5XSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0aHJvd09uSW1tdXRhYmxlTXV0YXRpb24oa2V5LCB2YWx1ZSkgewogICAgdGhyb3cgRXJyb3IoJ1lvdSBhdHRlbXB0ZWQgdG8gc2V0IHRoZSBrZXkgYCcgKyBrZXkgKyAnYCB3aXRoIHRoZSB2YWx1ZSBgJyArIEpTT04uc3RyaW5naWZ5KHZhbHVlKSArICdgIG9uIGFuIG9iamVjdCB0aGF0IGlzIG1lYW50IHRvIGJlIGltbXV0YWJsZSAnICsgJ2FuZCBoYXMgYmVlbiBmcm96ZW4uJyk7CiAgfQoKICBmdW5jdGlvbiBpZGVudGl0eSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBkZWVwRnJlZXplQW5kVGhyb3dPbk11dGF0aW9uSW5EZXY7Cn0sMTE4LFtdLCJkZWVwRnJlZXplQW5kVGhyb3dPbk11dGF0aW9uSW5EZXYiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBSZWFjdEZlYXR1cmVGbGFncyA9IHsKICAgIGRlYnVnUmVuZGVyUGhhc2VTaWRlRWZmZWN0czogZmFsc2UKICB9OwogIG1vZHVsZS5leHBvcnRzID0gUmVhY3RGZWF0dXJlRmxhZ3M7Cn0sMTE5LFtdLCJSZWFjdEZlYXR1cmVGbGFncyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkluaXRpYWxpemVDb3JlIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiZmJqcy9saWIvaW52YXJpYW50IiksCiAgICAgIGVtcHR5RnVuY3Rpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiZmJqcy9saWIvZW1wdHlGdW5jdGlvbiIpLAogICAgICBSQ1RFdmVudEVtaXR0ZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUkNURXZlbnRFbWl0dGVyIiksCiAgICAgIFVJTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJVSU1hbmFnZXIiKSwKICAgICAgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAicmVhY3QiKSwKICAgICAgRXhjZXB0aW9uc01hbmFnZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAiRXhjZXB0aW9uc01hbmFnZXIiKSwKICAgICAgVGV4dElucHV0U3RhdGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiVGV4dElucHV0U3RhdGUiKSwKICAgICAgZGVlcERpZmZlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJkZWVwRGlmZmVyIiksCiAgICAgIGZsYXR0ZW5TdHlsZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOV0sICJmbGF0dGVuU3R5bGUiKSwKICAgICAgZW1wdHlPYmplY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEwXSwgImZianMvbGliL2VtcHR5T2JqZWN0IiksCiAgICAgIHNoYWxsb3dFcXVhbCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTFdLCAiZmJqcy9saWIvc2hhbGxvd0VxdWFsIiksCiAgICAgIFJlYWN0RXJyb3JVdGlscyA9IHsKICAgIF9jYXVnaHRFcnJvcjogbnVsbCwKICAgIF9oYXNDYXVnaHRFcnJvcjogITEsCiAgICBfcmV0aHJvd0Vycm9yOiBudWxsLAogICAgX2hhc1JldGhyb3dFcnJvcjogITEsCiAgICBpbmplY3Rpb246IHsKICAgICAgaW5qZWN0RXJyb3JVdGlsczogZnVuY3Rpb24gaW5qZWN0RXJyb3JVdGlscyhpbmplY3RlZEVycm9yVXRpbHMpIHsKICAgICAgICBpbnZhcmlhbnQoImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGluamVjdGVkRXJyb3JVdGlscy5pbnZva2VHdWFyZGVkQ2FsbGJhY2ssICJJbmplY3RlZCBpbnZva2VHdWFyZGVkQ2FsbGJhY2soKSBtdXN0IGJlIGEgZnVuY3Rpb24uIik7CiAgICAgICAgX2ludm9rZUd1YXJkZWRDYWxsYmFjayA9IGluamVjdGVkRXJyb3JVdGlscy5pbnZva2VHdWFyZGVkQ2FsbGJhY2s7CiAgICAgIH0KICAgIH0sCiAgICBpbnZva2VHdWFyZGVkQ2FsbGJhY2s6IGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFjayhuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgIF9pbnZva2VHdWFyZGVkQ2FsbGJhY2suYXBwbHkoUmVhY3RFcnJvclV0aWxzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0FuZENhdGNoRmlyc3RFcnJvcjogZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgUmVhY3RFcnJvclV0aWxzLmludm9rZUd1YXJkZWRDYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgaWYgKFJlYWN0RXJyb3JVdGlscy5oYXNDYXVnaHRFcnJvcigpKSB7CiAgICAgICAgdmFyIGVycm9yID0gUmVhY3RFcnJvclV0aWxzLmNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICBSZWFjdEVycm9yVXRpbHMuX2hhc1JldGhyb3dFcnJvciB8fCAoUmVhY3RFcnJvclV0aWxzLl9oYXNSZXRocm93RXJyb3IgPSAhMCwgUmVhY3RFcnJvclV0aWxzLl9yZXRocm93RXJyb3IgPSBlcnJvcik7CiAgICAgIH0KICAgIH0sCiAgICByZXRocm93Q2F1Z2h0RXJyb3I6IGZ1bmN0aW9uIHJldGhyb3dDYXVnaHRFcnJvcigpIHsKICAgICAgcmV0dXJuIF9yZXRocm93Q2F1Z2h0RXJyb3IuYXBwbHkoUmVhY3RFcnJvclV0aWxzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIGhhc0NhdWdodEVycm9yOiBmdW5jdGlvbiBoYXNDYXVnaHRFcnJvcigpIHsKICAgICAgcmV0dXJuIFJlYWN0RXJyb3JVdGlscy5faGFzQ2F1Z2h0RXJyb3I7CiAgICB9LAogICAgY2xlYXJDYXVnaHRFcnJvcjogZnVuY3Rpb24gY2xlYXJDYXVnaHRFcnJvcigpIHsKICAgICAgaWYgKFJlYWN0RXJyb3JVdGlscy5faGFzQ2F1Z2h0RXJyb3IpIHsKICAgICAgICB2YXIgZXJyb3IgPSBSZWFjdEVycm9yVXRpbHMuX2NhdWdodEVycm9yOwogICAgICAgIFJlYWN0RXJyb3JVdGlscy5fY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIFJlYWN0RXJyb3JVdGlscy5faGFzQ2F1Z2h0RXJyb3IgPSAhMTsKICAgICAgICByZXR1cm4gZXJyb3I7CiAgICAgIH0KCiAgICAgIGludmFyaWFudCghMSwgImNsZWFyQ2F1Z2h0RXJyb3Igd2FzIGNhbGxlZCBidXQgbm8gZXJyb3Igd2FzIGNhcHR1cmVkLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgfQogIH07CgogIGZ1bmN0aW9uIF9pbnZva2VHdWFyZGVkQ2FsbGJhY2sobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgUmVhY3RFcnJvclV0aWxzLl9oYXNDYXVnaHRFcnJvciA9ICExOwogICAgUmVhY3RFcnJvclV0aWxzLl9jYXVnaHRFcnJvciA9IG51bGw7CiAgICB2YXIgZnVuY0FyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDMpOwoKICAgIHRyeSB7CiAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgZnVuY0FyZ3MpOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgUmVhY3RFcnJvclV0aWxzLl9jYXVnaHRFcnJvciA9IGVycm9yLCBSZWFjdEVycm9yVXRpbHMuX2hhc0NhdWdodEVycm9yID0gITA7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBfcmV0aHJvd0NhdWdodEVycm9yKCkgewogICAgaWYgKFJlYWN0RXJyb3JVdGlscy5faGFzUmV0aHJvd0Vycm9yKSB7CiAgICAgIHZhciBlcnJvciA9IFJlYWN0RXJyb3JVdGlscy5fcmV0aHJvd0Vycm9yOwogICAgICBSZWFjdEVycm9yVXRpbHMuX3JldGhyb3dFcnJvciA9IG51bGw7CiAgICAgIFJlYWN0RXJyb3JVdGlscy5faGFzUmV0aHJvd0Vycm9yID0gITE7CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KCiAgdmFyIGV2ZW50UGx1Z2luT3JkZXIgPSBudWxsLAogICAgICBuYW1lc1RvUGx1Z2lucyA9IHt9OwoKICBmdW5jdGlvbiByZWNvbXB1dGVQbHVnaW5PcmRlcmluZygpIHsKICAgIGlmIChldmVudFBsdWdpbk9yZGVyKSBmb3IgKHZhciBwbHVnaW5OYW1lIGluIG5hbWVzVG9QbHVnaW5zKSB7CiAgICAgIHZhciBwbHVnaW5Nb2R1bGUgPSBuYW1lc1RvUGx1Z2luc1twbHVnaW5OYW1lXSwKICAgICAgICAgIHBsdWdpbkluZGV4ID0gZXZlbnRQbHVnaW5PcmRlci5pbmRleE9mKHBsdWdpbk5hbWUpOwogICAgICBpbnZhcmlhbnQoLTEgPCBwbHVnaW5JbmRleCwgIkV2ZW50UGx1Z2luUmVnaXN0cnk6IENhbm5vdCBpbmplY3QgZXZlbnQgcGx1Z2lucyB0aGF0IGRvIG5vdCBleGlzdCBpbiB0aGUgcGx1Z2luIG9yZGVyaW5nLCBgJXNgLiIsIHBsdWdpbk5hbWUpOwoKICAgICAgaWYgKCFwbHVnaW5zW3BsdWdpbkluZGV4XSkgewogICAgICAgIGludmFyaWFudChwbHVnaW5Nb2R1bGUuZXh0cmFjdEV2ZW50cywgIkV2ZW50UGx1Z2luUmVnaXN0cnk6IEV2ZW50IHBsdWdpbnMgbXVzdCBpbXBsZW1lbnQgYW4gYGV4dHJhY3RFdmVudHNgIG1ldGhvZCwgYnV0IGAlc2AgZG9lcyBub3QuIiwgcGx1Z2luTmFtZSk7CiAgICAgICAgcGx1Z2luc1twbHVnaW5JbmRleF0gPSBwbHVnaW5Nb2R1bGU7CiAgICAgICAgcGx1Z2luSW5kZXggPSBwbHVnaW5Nb2R1bGUuZXZlbnRUeXBlczsKCiAgICAgICAgZm9yICh2YXIgZXZlbnROYW1lIGluIHBsdWdpbkluZGV4KSB7CiAgICAgICAgICB2YXIgSlNDb21waWxlcl9pbmxpbmVfcmVzdWx0ID0gdm9pZCAwOwogICAgICAgICAgdmFyIGRpc3BhdGNoQ29uZmlnID0gcGx1Z2luSW5kZXhbZXZlbnROYW1lXSwKICAgICAgICAgICAgICBwbHVnaW5Nb2R1bGUkanNjb21wJDAgPSBwbHVnaW5Nb2R1bGUsCiAgICAgICAgICAgICAgZXZlbnROYW1lJGpzY29tcCQwID0gZXZlbnROYW1lOwogICAgICAgICAgaW52YXJpYW50KCFldmVudE5hbWVEaXNwYXRjaENvbmZpZ3MuaGFzT3duUHJvcGVydHkoZXZlbnROYW1lJGpzY29tcCQwKSwgIkV2ZW50UGx1Z2luSHViOiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSBldmVudCBuYW1lLCBgJXNgLiIsIGV2ZW50TmFtZSRqc2NvbXAkMCk7CiAgICAgICAgICBldmVudE5hbWVEaXNwYXRjaENvbmZpZ3NbZXZlbnROYW1lJGpzY29tcCQwXSA9IGRpc3BhdGNoQ29uZmlnOwogICAgICAgICAgdmFyIHBoYXNlZFJlZ2lzdHJhdGlvbk5hbWVzID0gZGlzcGF0Y2hDb25maWcucGhhc2VkUmVnaXN0cmF0aW9uTmFtZXM7CgogICAgICAgICAgaWYgKHBoYXNlZFJlZ2lzdHJhdGlvbk5hbWVzKSB7CiAgICAgICAgICAgIGZvciAoSlNDb21waWxlcl9pbmxpbmVfcmVzdWx0IGluIHBoYXNlZFJlZ2lzdHJhdGlvbk5hbWVzKSB7CiAgICAgICAgICAgICAgcGhhc2VkUmVnaXN0cmF0aW9uTmFtZXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9pbmxpbmVfcmVzdWx0KSAmJiBwdWJsaXNoUmVnaXN0cmF0aW9uTmFtZShwaGFzZWRSZWdpc3RyYXRpb25OYW1lc1tKU0NvbXBpbGVyX2lubGluZV9yZXN1bHRdLCBwbHVnaW5Nb2R1bGUkanNjb21wJDAsIGV2ZW50TmFtZSRqc2NvbXAkMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEpTQ29tcGlsZXJfaW5saW5lX3Jlc3VsdCA9ICEwOwogICAgICAgICAgfSBlbHNlIGRpc3BhdGNoQ29uZmlnLnJlZ2lzdHJhdGlvbk5hbWUgPyAocHVibGlzaFJlZ2lzdHJhdGlvbk5hbWUoZGlzcGF0Y2hDb25maWcucmVnaXN0cmF0aW9uTmFtZSwgcGx1Z2luTW9kdWxlJGpzY29tcCQwLCBldmVudE5hbWUkanNjb21wJDApLCBKU0NvbXBpbGVyX2lubGluZV9yZXN1bHQgPSAhMCkgOiBKU0NvbXBpbGVyX2lubGluZV9yZXN1bHQgPSAhMTsKCiAgICAgICAgICBpbnZhcmlhbnQoSlNDb21waWxlcl9pbmxpbmVfcmVzdWx0LCAiRXZlbnRQbHVnaW5SZWdpc3RyeTogRmFpbGVkIHRvIHB1Ymxpc2ggZXZlbnQgYCVzYCBmb3IgcGx1Z2luIGAlc2AuIiwgZXZlbnROYW1lLCBwbHVnaW5OYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHB1Ymxpc2hSZWdpc3RyYXRpb25OYW1lKHJlZ2lzdHJhdGlvbk5hbWUsIHBsdWdpbk1vZHVsZSkgewogICAgaW52YXJpYW50KCFyZWdpc3RyYXRpb25OYW1lTW9kdWxlc1tyZWdpc3RyYXRpb25OYW1lXSwgIkV2ZW50UGx1Z2luSHViOiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSByZWdpc3RyYXRpb24gbmFtZSwgYCVzYC4iLCByZWdpc3RyYXRpb25OYW1lKTsKICAgIHJlZ2lzdHJhdGlvbk5hbWVNb2R1bGVzW3JlZ2lzdHJhdGlvbk5hbWVdID0gcGx1Z2luTW9kdWxlOwogIH0KCiAgdmFyIHBsdWdpbnMgPSBbXSwKICAgICAgZXZlbnROYW1lRGlzcGF0Y2hDb25maWdzID0ge30sCiAgICAgIHJlZ2lzdHJhdGlvbk5hbWVNb2R1bGVzID0ge30sCiAgICAgIGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUgPSBudWxsLAogICAgICBnZXRJbnN0YW5jZUZyb21Ob2RlID0gbnVsbCwKICAgICAgZ2V0Tm9kZUZyb21JbnN0YW5jZSA9IG51bGw7CgogIGZ1bmN0aW9uIGlzRW5kaXNoKHRvcExldmVsVHlwZSkgewogICAgcmV0dXJuICJ0b3BNb3VzZVVwIiA9PT0gdG9wTGV2ZWxUeXBlIHx8ICJ0b3BUb3VjaEVuZCIgPT09IHRvcExldmVsVHlwZSB8fCAidG9wVG91Y2hDYW5jZWwiID09PSB0b3BMZXZlbFR5cGU7CiAgfQoKICBmdW5jdGlvbiBpc01vdmVpc2godG9wTGV2ZWxUeXBlKSB7CiAgICByZXR1cm4gInRvcE1vdXNlTW92ZSIgPT09IHRvcExldmVsVHlwZSB8fCAidG9wVG91Y2hNb3ZlIiA9PT0gdG9wTGV2ZWxUeXBlOwogIH0KCiAgZnVuY3Rpb24gaXNTdGFydGlzaCh0b3BMZXZlbFR5cGUpIHsKICAgIHJldHVybiAidG9wTW91c2VEb3duIiA9PT0gdG9wTGV2ZWxUeXBlIHx8ICJ0b3BUb3VjaFN0YXJ0IiA9PT0gdG9wTGV2ZWxUeXBlOwogIH0KCiAgZnVuY3Rpb24gZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBzaW11bGF0ZWQsIGxpc3RlbmVyLCBpbnN0KSB7CiAgICBzaW11bGF0ZWQgPSBldmVudC50eXBlIHx8ICJ1bmtub3duLWV2ZW50IjsKICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBnZXROb2RlRnJvbUluc3RhbmNlKGluc3QpOwogICAgUmVhY3RFcnJvclV0aWxzLmludm9rZUd1YXJkZWRDYWxsYmFja0FuZENhdGNoRmlyc3RFcnJvcihzaW11bGF0ZWQsIGxpc3RlbmVyLCB2b2lkIDAsIGV2ZW50KTsKICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBudWxsOwogIH0KCiAgZnVuY3Rpb24gZXhlY3V0ZURpcmVjdERpc3BhdGNoKGV2ZW50KSB7CiAgICB2YXIgZGlzcGF0Y2hMaXN0ZW5lciA9IGV2ZW50Ll9kaXNwYXRjaExpc3RlbmVycywKICAgICAgICBkaXNwYXRjaEluc3RhbmNlID0gZXZlbnQuX2Rpc3BhdGNoSW5zdGFuY2VzOwogICAgaW52YXJpYW50KCFBcnJheS5pc0FycmF5KGRpc3BhdGNoTGlzdGVuZXIpLCAiZXhlY3V0ZURpcmVjdERpc3BhdGNoKC4uLik6IEludmFsaWQgYGV2ZW50YC4iKTsKICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBkaXNwYXRjaExpc3RlbmVyID8gZ2V0Tm9kZUZyb21JbnN0YW5jZShkaXNwYXRjaEluc3RhbmNlKSA6IG51bGw7CiAgICBkaXNwYXRjaExpc3RlbmVyID0gZGlzcGF0Y2hMaXN0ZW5lciA/IGRpc3BhdGNoTGlzdGVuZXIoZXZlbnQpIDogbnVsbDsKICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBudWxsOwogICAgZXZlbnQuX2Rpc3BhdGNoTGlzdGVuZXJzID0gbnVsbDsKICAgIGV2ZW50Ll9kaXNwYXRjaEluc3RhbmNlcyA9IG51bGw7CiAgICByZXR1cm4gZGlzcGF0Y2hMaXN0ZW5lcjsKICB9CgogIGZ1bmN0aW9uIGFjY3VtdWxhdGVJbnRvKGN1cnJlbnQsIG5leHQpIHsKICAgIGludmFyaWFudChudWxsICE9IG5leHQsICJhY2N1bXVsYXRlSW50byguLi4pOiBBY2N1bXVsYXRlZCBpdGVtcyBtdXN0IG5vdCBiZSBudWxsIG9yIHVuZGVmaW5lZC4iKTsKICAgIGlmIChudWxsID09IGN1cnJlbnQpIHJldHVybiBuZXh0OwoKICAgIGlmIChBcnJheS5pc0FycmF5KGN1cnJlbnQpKSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KG5leHQpKSByZXR1cm4gY3VycmVudC5wdXNoLmFwcGx5KGN1cnJlbnQsIG5leHQpLCBjdXJyZW50OwogICAgICBjdXJyZW50LnB1c2gobmV4dCk7CiAgICAgIHJldHVybiBjdXJyZW50OwogICAgfQoKICAgIHJldHVybiBBcnJheS5pc0FycmF5KG5leHQpID8gW2N1cnJlbnRdLmNvbmNhdChuZXh0KSA6IFtjdXJyZW50LCBuZXh0XTsKICB9CgogIGZ1bmN0aW9uIGZvckVhY2hBY2N1bXVsYXRlZChhcnIsIGNiLCBzY29wZSkgewogICAgQXJyYXkuaXNBcnJheShhcnIpID8gYXJyLmZvckVhY2goY2IsIHNjb3BlKSA6IGFyciAmJiBjYi5jYWxsKHNjb3BlLCBhcnIpOwogIH0KCiAgdmFyIGV2ZW50UXVldWUgPSBudWxsOwoKICBmdW5jdGlvbiBleGVjdXRlRGlzcGF0Y2hlc0FuZFJlbGVhc2VUb3BMZXZlbChlKSB7CiAgICBpZiAoZSkgewogICAgICB2YXIgZGlzcGF0Y2hMaXN0ZW5lcnMgPSBlLl9kaXNwYXRjaExpc3RlbmVycywKICAgICAgICAgIGRpc3BhdGNoSW5zdGFuY2VzID0gZS5fZGlzcGF0Y2hJbnN0YW5jZXM7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRpc3BhdGNoTGlzdGVuZXJzKSkgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXNwYXRjaExpc3RlbmVycy5sZW5ndGggJiYgIWUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKTsgaSsrKSB7CiAgICAgICAgZXhlY3V0ZURpc3BhdGNoKGUsICExLCBkaXNwYXRjaExpc3RlbmVyc1tpXSwgZGlzcGF0Y2hJbnN0YW5jZXNbaV0pOwogICAgICB9IGVsc2UgZGlzcGF0Y2hMaXN0ZW5lcnMgJiYgZXhlY3V0ZURpc3BhdGNoKGUsICExLCBkaXNwYXRjaExpc3RlbmVycywgZGlzcGF0Y2hJbnN0YW5jZXMpOwogICAgICBlLl9kaXNwYXRjaExpc3RlbmVycyA9IG51bGw7CiAgICAgIGUuX2Rpc3BhdGNoSW5zdGFuY2VzID0gbnVsbDsKICAgICAgZS5pc1BlcnNpc3RlbnQoKSB8fCBlLmNvbnN0cnVjdG9yLnJlbGVhc2UoZSk7CiAgICB9CiAgfQoKICB2YXIgaW5qZWN0aW9uID0gewogICAgaW5qZWN0RXZlbnRQbHVnaW5PcmRlcjogZnVuY3Rpb24gaW5qZWN0RXZlbnRQbHVnaW5PcmRlcihpbmplY3RlZEV2ZW50UGx1Z2luT3JkZXIpIHsKICAgICAgaW52YXJpYW50KCFldmVudFBsdWdpbk9yZGVyLCAiRXZlbnRQbHVnaW5SZWdpc3RyeTogQ2Fubm90IGluamVjdCBldmVudCBwbHVnaW4gb3JkZXJpbmcgbW9yZSB0aGFuIG9uY2UuIFlvdSBhcmUgbGlrZWx5IHRyeWluZyB0byBsb2FkIG1vcmUgdGhhbiBvbmUgY29weSBvZiBSZWFjdC4iKTsKICAgICAgZXZlbnRQbHVnaW5PcmRlciA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGluamVjdGVkRXZlbnRQbHVnaW5PcmRlcik7CiAgICAgIHJlY29tcHV0ZVBsdWdpbk9yZGVyaW5nKCk7CiAgICB9LAogICAgaW5qZWN0RXZlbnRQbHVnaW5zQnlOYW1lOiBmdW5jdGlvbiBpbmplY3RFdmVudFBsdWdpbnNCeU5hbWUoaW5qZWN0ZWROYW1lc1RvUGx1Z2lucykgewogICAgICB2YXIgaXNPcmRlcmluZ0RpcnR5ID0gITEsCiAgICAgICAgICBwbHVnaW5OYW1lOwoKICAgICAgZm9yIChwbHVnaW5OYW1lIGluIGluamVjdGVkTmFtZXNUb1BsdWdpbnMpIHsKICAgICAgICBpZiAoaW5qZWN0ZWROYW1lc1RvUGx1Z2lucy5oYXNPd25Qcm9wZXJ0eShwbHVnaW5OYW1lKSkgewogICAgICAgICAgdmFyIHBsdWdpbk1vZHVsZSA9IGluamVjdGVkTmFtZXNUb1BsdWdpbnNbcGx1Z2luTmFtZV07CiAgICAgICAgICBuYW1lc1RvUGx1Z2lucy5oYXNPd25Qcm9wZXJ0eShwbHVnaW5OYW1lKSAmJiBuYW1lc1RvUGx1Z2luc1twbHVnaW5OYW1lXSA9PT0gcGx1Z2luTW9kdWxlIHx8IChpbnZhcmlhbnQoIW5hbWVzVG9QbHVnaW5zW3BsdWdpbk5hbWVdLCAiRXZlbnRQbHVnaW5SZWdpc3RyeTogQ2Fubm90IGluamVjdCB0d28gZGlmZmVyZW50IGV2ZW50IHBsdWdpbnMgdXNpbmcgdGhlIHNhbWUgbmFtZSwgYCVzYC4iLCBwbHVnaW5OYW1lKSwgbmFtZXNUb1BsdWdpbnNbcGx1Z2luTmFtZV0gPSBwbHVnaW5Nb2R1bGUsIGlzT3JkZXJpbmdEaXJ0eSA9ICEwKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlzT3JkZXJpbmdEaXJ0eSAmJiByZWNvbXB1dGVQbHVnaW5PcmRlcmluZygpOwogICAgfQogIH07CgogIGZ1bmN0aW9uIGdldExpc3RlbmVyKGluc3QsIHJlZ2lzdHJhdGlvbk5hbWUpIHsKICAgIHZhciBsaXN0ZW5lciA9IGluc3Quc3RhdGVOb2RlOwogICAgaWYgKCFsaXN0ZW5lcikgcmV0dXJuIG51bGw7CiAgICB2YXIgcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKGxpc3RlbmVyKTsKICAgIGlmICghcHJvcHMpIHJldHVybiBudWxsOwogICAgbGlzdGVuZXIgPSBwcm9wc1tyZWdpc3RyYXRpb25OYW1lXTsKCiAgICBhOiBzd2l0Y2ggKHJlZ2lzdHJhdGlvbk5hbWUpIHsKICAgICAgY2FzZSAib25DbGljayI6CiAgICAgIGNhc2UgIm9uQ2xpY2tDYXB0dXJlIjoKICAgICAgY2FzZSAib25Eb3VibGVDbGljayI6CiAgICAgIGNhc2UgIm9uRG91YmxlQ2xpY2tDYXB0dXJlIjoKICAgICAgY2FzZSAib25Nb3VzZURvd24iOgogICAgICBjYXNlICJvbk1vdXNlRG93bkNhcHR1cmUiOgogICAgICBjYXNlICJvbk1vdXNlTW92ZSI6CiAgICAgIGNhc2UgIm9uTW91c2VNb3ZlQ2FwdHVyZSI6CiAgICAgIGNhc2UgIm9uTW91c2VVcCI6CiAgICAgIGNhc2UgIm9uTW91c2VVcENhcHR1cmUiOgogICAgICAgIChwcm9wcyA9ICFwcm9wcy5kaXNhYmxlZCkgfHwgKGluc3QgPSBpbnN0LnR5cGUsIHByb3BzID0gISgiYnV0dG9uIiA9PT0gaW5zdCB8fCAiaW5wdXQiID09PSBpbnN0IHx8ICJzZWxlY3QiID09PSBpbnN0IHx8ICJ0ZXh0YXJlYSIgPT09IGluc3QpKTsKICAgICAgICBpbnN0ID0gIXByb3BzOwogICAgICAgIGJyZWFrIGE7CgogICAgICBkZWZhdWx0OgogICAgICAgIGluc3QgPSAhMTsKICAgIH0KCiAgICBpZiAoaW5zdCkgcmV0dXJuIG51bGw7CiAgICBpbnZhcmlhbnQoIWxpc3RlbmVyIHx8ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBsaXN0ZW5lciwgIkV4cGVjdGVkIGAlc2AgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYSB2YWx1ZSBvZiBgJXNgIHR5cGUuIiwgcmVnaXN0cmF0aW9uTmFtZSwgdHlwZW9mIGxpc3RlbmVyKTsKICAgIHJldHVybiBsaXN0ZW5lcjsKICB9CgogIGZ1bmN0aW9uIGdldFBhcmVudChpbnN0KSB7CiAgICBkbyB7CiAgICAgIGluc3QgPSBpbnN0WyJyZXR1cm4iXTsKICAgIH0gd2hpbGUgKGluc3QgJiYgNSAhPT0gaW5zdC50YWcpOwoKICAgIHJldHVybiBpbnN0ID8gaW5zdCA6IG51bGw7CiAgfQoKICBmdW5jdGlvbiB0cmF2ZXJzZVR3b1BoYXNlKGluc3QsIGZuLCBhcmcpIHsKICAgIGZvciAodmFyIHBhdGggPSBbXTsgaW5zdDspIHsKICAgICAgcGF0aC5wdXNoKGluc3QpLCBpbnN0ID0gZ2V0UGFyZW50KGluc3QpOwogICAgfQoKICAgIGZvciAoaW5zdCA9IHBhdGgubGVuZ3RoOyAwIDwgaW5zdC0tOykgewogICAgICBmbihwYXRoW2luc3RdLCAiY2FwdHVyZWQiLCBhcmcpOwogICAgfQoKICAgIGZvciAoaW5zdCA9IDA7IGluc3QgPCBwYXRoLmxlbmd0aDsgaW5zdCsrKSB7CiAgICAgIGZuKHBhdGhbaW5zdF0sICJidWJibGVkIiwgYXJnKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGFjY3VtdWxhdGVEaXJlY3Rpb25hbERpc3BhdGNoZXMoaW5zdCwgcGhhc2UsIGV2ZW50KSB7CiAgICBpZiAocGhhc2UgPSBnZXRMaXN0ZW5lcihpbnN0LCBldmVudC5kaXNwYXRjaENvbmZpZy5waGFzZWRSZWdpc3RyYXRpb25OYW1lc1twaGFzZV0pKSBldmVudC5fZGlzcGF0Y2hMaXN0ZW5lcnMgPSBhY2N1bXVsYXRlSW50byhldmVudC5fZGlzcGF0Y2hMaXN0ZW5lcnMsIHBoYXNlKSwgZXZlbnQuX2Rpc3BhdGNoSW5zdGFuY2VzID0gYWNjdW11bGF0ZUludG8oZXZlbnQuX2Rpc3BhdGNoSW5zdGFuY2VzLCBpbnN0KTsKICB9CgogIGZ1bmN0aW9uIGFjY3VtdWxhdGVUd29QaGFzZURpc3BhdGNoZXNTaW5nbGUoZXZlbnQpIHsKICAgIGV2ZW50ICYmIGV2ZW50LmRpc3BhdGNoQ29uZmlnLnBoYXNlZFJlZ2lzdHJhdGlvbk5hbWVzICYmIHRyYXZlcnNlVHdvUGhhc2UoZXZlbnQuX3RhcmdldEluc3QsIGFjY3VtdWxhdGVEaXJlY3Rpb25hbERpc3BhdGNoZXMsIGV2ZW50KTsKICB9CgogIGZ1bmN0aW9uIGFjY3VtdWxhdGVUd29QaGFzZURpc3BhdGNoZXNTaW5nbGVTa2lwVGFyZ2V0KGV2ZW50KSB7CiAgICBpZiAoZXZlbnQgJiYgZXZlbnQuZGlzcGF0Y2hDb25maWcucGhhc2VkUmVnaXN0cmF0aW9uTmFtZXMpIHsKICAgICAgdmFyIHRhcmdldEluc3QgPSBldmVudC5fdGFyZ2V0SW5zdDsKICAgICAgdGFyZ2V0SW5zdCA9IHRhcmdldEluc3QgPyBnZXRQYXJlbnQodGFyZ2V0SW5zdCkgOiBudWxsOwogICAgICB0cmF2ZXJzZVR3b1BoYXNlKHRhcmdldEluc3QsIGFjY3VtdWxhdGVEaXJlY3Rpb25hbERpc3BhdGNoZXMsIGV2ZW50KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGFjY3VtdWxhdGVEaXJlY3REaXNwYXRjaGVzU2luZ2xlKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQgJiYgZXZlbnQuZGlzcGF0Y2hDb25maWcucmVnaXN0cmF0aW9uTmFtZSkgewogICAgICB2YXIgaW5zdCA9IGV2ZW50Ll90YXJnZXRJbnN0OwoKICAgICAgaWYgKGluc3QgJiYgZXZlbnQgJiYgZXZlbnQuZGlzcGF0Y2hDb25maWcucmVnaXN0cmF0aW9uTmFtZSkgewogICAgICAgIHZhciBsaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3QsIGV2ZW50LmRpc3BhdGNoQ29uZmlnLnJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgIGxpc3RlbmVyICYmIChldmVudC5fZGlzcGF0Y2hMaXN0ZW5lcnMgPSBhY2N1bXVsYXRlSW50byhldmVudC5fZGlzcGF0Y2hMaXN0ZW5lcnMsIGxpc3RlbmVyKSwgZXZlbnQuX2Rpc3BhdGNoSW5zdGFuY2VzID0gYWNjdW11bGF0ZUludG8oZXZlbnQuX2Rpc3BhdGNoSW5zdGFuY2VzLCBpbnN0KSk7CiAgICAgIH0KICAgIH0KICB9CgogIHZhciBzaG91bGRCZVJlbGVhc2VkUHJvcGVydGllcyA9ICJkaXNwYXRjaENvbmZpZyBfdGFyZ2V0SW5zdCBuYXRpdmVFdmVudCBpc0RlZmF1bHRQcmV2ZW50ZWQgaXNQcm9wYWdhdGlvblN0b3BwZWQgX2Rpc3BhdGNoTGlzdGVuZXJzIF9kaXNwYXRjaEluc3RhbmNlcyIuc3BsaXQoIiAiKSwKICAgICAgRXZlbnRJbnRlcmZhY2UgPSB7CiAgICB0eXBlOiBudWxsLAogICAgdGFyZ2V0OiBudWxsLAogICAgY3VycmVudFRhcmdldDogZW1wdHlGdW5jdGlvbi50aGF0UmV0dXJuc051bGwsCiAgICBldmVudFBoYXNlOiBudWxsLAogICAgYnViYmxlczogbnVsbCwKICAgIGNhbmNlbGFibGU6IG51bGwsCiAgICB0aW1lU3RhbXA6IGZ1bmN0aW9uIHRpbWVTdGFtcChldmVudCkgewogICAgICByZXR1cm4gZXZlbnQudGltZVN0YW1wIHx8IERhdGUubm93KCk7CiAgICB9LAogICAgZGVmYXVsdFByZXZlbnRlZDogbnVsbCwKICAgIGlzVHJ1c3RlZDogbnVsbAogIH07CgogIGZ1bmN0aW9uIFN5bnRoZXRpY0V2ZW50KGRpc3BhdGNoQ29uZmlnLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgIHRoaXMuZGlzcGF0Y2hDb25maWcgPSBkaXNwYXRjaENvbmZpZzsKICAgIHRoaXMuX3RhcmdldEluc3QgPSB0YXJnZXRJbnN0OwogICAgdGhpcy5uYXRpdmVFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgZGlzcGF0Y2hDb25maWcgPSB0aGlzLmNvbnN0cnVjdG9yLkludGVyZmFjZTsKCiAgICBmb3IgKHZhciBwcm9wTmFtZSBpbiBkaXNwYXRjaENvbmZpZykgewogICAgICBkaXNwYXRjaENvbmZpZy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkgJiYgKCh0YXJnZXRJbnN0ID0gZGlzcGF0Y2hDb25maWdbcHJvcE5hbWVdKSA/IHRoaXNbcHJvcE5hbWVdID0gdGFyZ2V0SW5zdChuYXRpdmVFdmVudCkgOiAidGFyZ2V0IiA9PT0gcHJvcE5hbWUgPyB0aGlzLnRhcmdldCA9IG5hdGl2ZUV2ZW50VGFyZ2V0IDogdGhpc1twcm9wTmFtZV0gPSBuYXRpdmVFdmVudFtwcm9wTmFtZV0pOwogICAgfQoKICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gKG51bGwgIT0gbmF0aXZlRXZlbnQuZGVmYXVsdFByZXZlbnRlZCA/IG5hdGl2ZUV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgOiAhMSA9PT0gbmF0aXZlRXZlbnQucmV0dXJuVmFsdWUpID8gZW1wdHlGdW5jdGlvbi50aGF0UmV0dXJuc1RydWUgOiBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zRmFsc2U7CiAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZW1wdHlGdW5jdGlvbi50aGF0UmV0dXJuc0ZhbHNlOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBiYWJlbEhlbHBlcnMuZXh0ZW5kcyhTeW50aGV0aWNFdmVudC5wcm90b3R5cGUsIHsKICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiBwcmV2ZW50RGVmYXVsdCgpIHsKICAgICAgdGhpcy5kZWZhdWx0UHJldmVudGVkID0gITA7CiAgICAgIHZhciBldmVudCA9IHRoaXMubmF0aXZlRXZlbnQ7CiAgICAgIGV2ZW50ICYmIChldmVudC5wcmV2ZW50RGVmYXVsdCA/IGV2ZW50LnByZXZlbnREZWZhdWx0KCkgOiAidW5rbm93biIgIT09IHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSAmJiAoZXZlbnQucmV0dXJuVmFsdWUgPSAhMSksIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZW1wdHlGdW5jdGlvbi50aGF0UmV0dXJuc1RydWUpOwogICAgfSwKICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24gc3RvcFByb3BhZ2F0aW9uKCkgewogICAgICB2YXIgZXZlbnQgPSB0aGlzLm5hdGl2ZUV2ZW50OwogICAgICBldmVudCAmJiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uID8gZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCkgOiAidW5rbm93biIgIT09IHR5cGVvZiBldmVudC5jYW5jZWxCdWJibGUgJiYgKGV2ZW50LmNhbmNlbEJ1YmJsZSA9ICEwKSwgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IGVtcHR5RnVuY3Rpb24udGhhdFJldHVybnNUcnVlKTsKICAgIH0sCiAgICBwZXJzaXN0OiBmdW5jdGlvbiBwZXJzaXN0KCkgewogICAgICB0aGlzLmlzUGVyc2lzdGVudCA9IGVtcHR5RnVuY3Rpb24udGhhdFJldHVybnNUcnVlOwogICAgfSwKICAgIGlzUGVyc2lzdGVudDogZW1wdHlGdW5jdGlvbi50aGF0UmV0dXJuc0ZhbHNlLAogICAgZGVzdHJ1Y3RvcjogZnVuY3Rpb24gZGVzdHJ1Y3RvcigpIHsKICAgICAgdmFyIEludGVyZmFjZSA9IHRoaXMuY29uc3RydWN0b3IuSW50ZXJmYWNlLAogICAgICAgICAgcHJvcE5hbWU7CgogICAgICBmb3IgKHByb3BOYW1lIGluIEludGVyZmFjZSkgewogICAgICAgIHRoaXNbcHJvcE5hbWVdID0gbnVsbDsKICAgICAgfQoKICAgICAgZm9yIChJbnRlcmZhY2UgPSAwOyBJbnRlcmZhY2UgPCBzaG91bGRCZVJlbGVhc2VkUHJvcGVydGllcy5sZW5ndGg7IEludGVyZmFjZSsrKSB7CiAgICAgICAgdGhpc1tzaG91bGRCZVJlbGVhc2VkUHJvcGVydGllc1tJbnRlcmZhY2VdXSA9IG51bGw7CiAgICAgIH0KICAgIH0KICB9KTsKICBTeW50aGV0aWNFdmVudC5JbnRlcmZhY2UgPSBFdmVudEludGVyZmFjZTsKCiAgU3ludGhldGljRXZlbnQuYXVnbWVudENsYXNzID0gZnVuY3Rpb24gKENsYXNzLCBJbnRlcmZhY2UpIHsKICAgIGZ1bmN0aW9uIEUoKSB7fQoKICAgIEUucHJvdG90eXBlID0gdGhpcy5wcm90b3R5cGU7CiAgICB2YXIgcHJvdG90eXBlID0gbmV3IEUoKTsKICAgIGJhYmVsSGVscGVycy5leHRlbmRzKHByb3RvdHlwZSwgQ2xhc3MucHJvdG90eXBlKTsKICAgIENsYXNzLnByb3RvdHlwZSA9IHByb3RvdHlwZTsKICAgIENsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENsYXNzOwogICAgQ2xhc3MuSW50ZXJmYWNlID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHRoaXMuSW50ZXJmYWNlLCBJbnRlcmZhY2UpOwogICAgQ2xhc3MuYXVnbWVudENsYXNzID0gdGhpcy5hdWdtZW50Q2xhc3M7CiAgICBhZGRFdmVudFBvb2xpbmdUbyhDbGFzcyk7CiAgfTsKCiAgYWRkRXZlbnRQb29saW5nVG8oU3ludGhldGljRXZlbnQpOwoKICBmdW5jdGlvbiBnZXRQb29sZWRFdmVudChkaXNwYXRjaENvbmZpZywgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUluc3QpIHsKICAgIGlmICh0aGlzLmV2ZW50UG9vbC5sZW5ndGgpIHsKICAgICAgdmFyIGluc3RhbmNlID0gdGhpcy5ldmVudFBvb2wucG9wKCk7CiAgICAgIHRoaXMuY2FsbChpbnN0YW5jZSwgZGlzcGF0Y2hDb25maWcsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVJbnN0KTsKICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgfQoKICAgIHJldHVybiBuZXcgdGhpcyhkaXNwYXRjaENvbmZpZywgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUluc3QpOwogIH0KCiAgZnVuY3Rpb24gcmVsZWFzZVBvb2xlZEV2ZW50KGV2ZW50KSB7CiAgICBpbnZhcmlhbnQoZXZlbnQgaW5zdGFuY2VvZiB0aGlzLCAiVHJ5aW5nIHRvIHJlbGVhc2UgYW4gZXZlbnQgaW5zdGFuY2UgIGludG8gYSBwb29sIG9mIGEgZGlmZmVyZW50IHR5cGUuIik7CiAgICBldmVudC5kZXN0cnVjdG9yKCk7CiAgICAxMCA+IHRoaXMuZXZlbnRQb29sLmxlbmd0aCAmJiB0aGlzLmV2ZW50UG9vbC5wdXNoKGV2ZW50KTsKICB9CgogIGZ1bmN0aW9uIGFkZEV2ZW50UG9vbGluZ1RvKEV2ZW50Q29uc3RydWN0b3IpIHsKICAgIEV2ZW50Q29uc3RydWN0b3IuZXZlbnRQb29sID0gW107CiAgICBFdmVudENvbnN0cnVjdG9yLmdldFBvb2xlZCA9IGdldFBvb2xlZEV2ZW50OwogICAgRXZlbnRDb25zdHJ1Y3Rvci5yZWxlYXNlID0gcmVsZWFzZVBvb2xlZEV2ZW50OwogIH0KCiAgZnVuY3Rpb24gUmVzcG9uZGVyU3ludGhldGljRXZlbnQoZGlzcGF0Y2hDb25maWcsIGRpc3BhdGNoTWFya2VyLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgIHJldHVybiBTeW50aGV0aWNFdmVudC5jYWxsKHRoaXMsIGRpc3BhdGNoQ29uZmlnLCBkaXNwYXRjaE1hcmtlciwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICB9CgogIFN5bnRoZXRpY0V2ZW50LmF1Z21lbnRDbGFzcyhSZXNwb25kZXJTeW50aGV0aWNFdmVudCwgewogICAgdG91Y2hIaXN0b3J5OiBmdW5jdGlvbiB0b3VjaEhpc3RvcnkoKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH0pOwogIHZhciB0b3VjaEJhbmsgPSBbXSwKICAgICAgdG91Y2hIaXN0b3J5ID0gewogICAgdG91Y2hCYW5rOiB0b3VjaEJhbmssCiAgICBudW1iZXJBY3RpdmVUb3VjaGVzOiAwLAogICAgaW5kZXhPZlNpbmdsZUFjdGl2ZVRvdWNoOiAtMSwKICAgIG1vc3RSZWNlbnRUaW1lU3RhbXA6IDAKICB9OwoKICBmdW5jdGlvbiB0aW1lc3RhbXBGb3JUb3VjaCh0b3VjaCkgewogICAgcmV0dXJuIHRvdWNoLnRpbWVTdGFtcCB8fCB0b3VjaC50aW1lc3RhbXA7CiAgfQoKICBmdW5jdGlvbiBnZXRUb3VjaElkZW50aWZpZXIoX3JlZikgewogICAgX3JlZiA9IF9yZWYuaWRlbnRpZmllcjsKICAgIGludmFyaWFudChudWxsICE9IF9yZWYsICJUb3VjaCBvYmplY3QgaXMgbWlzc2luZyBpZGVudGlmaWVyLiIpOwogICAgcmV0dXJuIF9yZWY7CiAgfQoKICBmdW5jdGlvbiByZWNvcmRUb3VjaFN0YXJ0KHRvdWNoKSB7CiAgICB2YXIgaWRlbnRpZmllciA9IGdldFRvdWNoSWRlbnRpZmllcih0b3VjaCksCiAgICAgICAgdG91Y2hSZWNvcmQgPSB0b3VjaEJhbmtbaWRlbnRpZmllcl07CiAgICB0b3VjaFJlY29yZCA/ICh0b3VjaFJlY29yZC50b3VjaEFjdGl2ZSA9ICEwLCB0b3VjaFJlY29yZC5zdGFydFBhZ2VYID0gdG91Y2gucGFnZVgsIHRvdWNoUmVjb3JkLnN0YXJ0UGFnZVkgPSB0b3VjaC5wYWdlWSwgdG91Y2hSZWNvcmQuc3RhcnRUaW1lU3RhbXAgPSB0aW1lc3RhbXBGb3JUb3VjaCh0b3VjaCksIHRvdWNoUmVjb3JkLmN1cnJlbnRQYWdlWCA9IHRvdWNoLnBhZ2VYLCB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVkgPSB0b3VjaC5wYWdlWSwgdG91Y2hSZWNvcmQuY3VycmVudFRpbWVTdGFtcCA9IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKSwgdG91Y2hSZWNvcmQucHJldmlvdXNQYWdlWCA9IHRvdWNoLnBhZ2VYLCB0b3VjaFJlY29yZC5wcmV2aW91c1BhZ2VZID0gdG91Y2gucGFnZVksIHRvdWNoUmVjb3JkLnByZXZpb3VzVGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpKSA6ICh0b3VjaFJlY29yZCA9IHsKICAgICAgdG91Y2hBY3RpdmU6ICEwLAogICAgICBzdGFydFBhZ2VYOiB0b3VjaC5wYWdlWCwKICAgICAgc3RhcnRQYWdlWTogdG91Y2gucGFnZVksCiAgICAgIHN0YXJ0VGltZVN0YW1wOiB0aW1lc3RhbXBGb3JUb3VjaCh0b3VjaCksCiAgICAgIGN1cnJlbnRQYWdlWDogdG91Y2gucGFnZVgsCiAgICAgIGN1cnJlbnRQYWdlWTogdG91Y2gucGFnZVksCiAgICAgIGN1cnJlbnRUaW1lU3RhbXA6IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKSwKICAgICAgcHJldmlvdXNQYWdlWDogdG91Y2gucGFnZVgsCiAgICAgIHByZXZpb3VzUGFnZVk6IHRvdWNoLnBhZ2VZLAogICAgICBwcmV2aW91c1RpbWVTdGFtcDogdGltZXN0YW1wRm9yVG91Y2godG91Y2gpCiAgICB9LCB0b3VjaEJhbmtbaWRlbnRpZmllcl0gPSB0b3VjaFJlY29yZCk7CiAgICB0b3VjaEhpc3RvcnkubW9zdFJlY2VudFRpbWVTdGFtcCA9IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKTsKICB9CgogIGZ1bmN0aW9uIHJlY29yZFRvdWNoTW92ZSh0b3VjaCkgewogICAgdmFyIHRvdWNoUmVjb3JkID0gdG91Y2hCYW5rW2dldFRvdWNoSWRlbnRpZmllcih0b3VjaCldOwogICAgdG91Y2hSZWNvcmQgPyAodG91Y2hSZWNvcmQudG91Y2hBY3RpdmUgPSAhMCwgdG91Y2hSZWNvcmQucHJldmlvdXNQYWdlWCA9IHRvdWNoUmVjb3JkLmN1cnJlbnRQYWdlWCwgdG91Y2hSZWNvcmQucHJldmlvdXNQYWdlWSA9IHRvdWNoUmVjb3JkLmN1cnJlbnRQYWdlWSwgdG91Y2hSZWNvcmQucHJldmlvdXNUaW1lU3RhbXAgPSB0b3VjaFJlY29yZC5jdXJyZW50VGltZVN0YW1wLCB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVggPSB0b3VjaC5wYWdlWCwgdG91Y2hSZWNvcmQuY3VycmVudFBhZ2VZID0gdG91Y2gucGFnZVksIHRvdWNoUmVjb3JkLmN1cnJlbnRUaW1lU3RhbXAgPSB0aW1lc3RhbXBGb3JUb3VjaCh0b3VjaCksIHRvdWNoSGlzdG9yeS5tb3N0UmVjZW50VGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpKSA6IGNvbnNvbGUuZXJyb3IoIkNhbm5vdCByZWNvcmQgdG91Y2ggbW92ZSB3aXRob3V0IGEgdG91Y2ggc3RhcnQuXG5Ub3VjaCBNb3ZlOiAlc1xuIiwgIlRvdWNoIEJhbms6ICVzIiwgcHJpbnRUb3VjaCh0b3VjaCksIHByaW50VG91Y2hCYW5rKCkpOwogIH0KCiAgZnVuY3Rpb24gcmVjb3JkVG91Y2hFbmQodG91Y2gpIHsKICAgIHZhciB0b3VjaFJlY29yZCA9IHRvdWNoQmFua1tnZXRUb3VjaElkZW50aWZpZXIodG91Y2gpXTsKICAgIHRvdWNoUmVjb3JkID8gKHRvdWNoUmVjb3JkLnRvdWNoQWN0aXZlID0gITEsIHRvdWNoUmVjb3JkLnByZXZpb3VzUGFnZVggPSB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVgsIHRvdWNoUmVjb3JkLnByZXZpb3VzUGFnZVkgPSB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVksIHRvdWNoUmVjb3JkLnByZXZpb3VzVGltZVN0YW1wID0gdG91Y2hSZWNvcmQuY3VycmVudFRpbWVTdGFtcCwgdG91Y2hSZWNvcmQuY3VycmVudFBhZ2VYID0gdG91Y2gucGFnZVgsIHRvdWNoUmVjb3JkLmN1cnJlbnRQYWdlWSA9IHRvdWNoLnBhZ2VZLCB0b3VjaFJlY29yZC5jdXJyZW50VGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpLCB0b3VjaEhpc3RvcnkubW9zdFJlY2VudFRpbWVTdGFtcCA9IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKSkgOiBjb25zb2xlLmVycm9yKCJDYW5ub3QgcmVjb3JkIHRvdWNoIGVuZCB3aXRob3V0IGEgdG91Y2ggc3RhcnQuXG5Ub3VjaCBFbmQ6ICVzXG4iLCAiVG91Y2ggQmFuazogJXMiLCBwcmludFRvdWNoKHRvdWNoKSwgcHJpbnRUb3VjaEJhbmsoKSk7CiAgfQoKICBmdW5jdGlvbiBwcmludFRvdWNoKHRvdWNoKSB7CiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoewogICAgICBpZGVudGlmaWVyOiB0b3VjaC5pZGVudGlmaWVyLAogICAgICBwYWdlWDogdG91Y2gucGFnZVgsCiAgICAgIHBhZ2VZOiB0b3VjaC5wYWdlWSwKICAgICAgdGltZXN0YW1wOiB0aW1lc3RhbXBGb3JUb3VjaCh0b3VjaCkKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gcHJpbnRUb3VjaEJhbmsoKSB7CiAgICB2YXIgcHJpbnRlZCA9IEpTT04uc3RyaW5naWZ5KHRvdWNoQmFuay5zbGljZSgwLCAyMCkpOwogICAgMjAgPCB0b3VjaEJhbmsubGVuZ3RoICYmIChwcmludGVkICs9ICIgKG9yaWdpbmFsIHNpemU6ICIgKyB0b3VjaEJhbmsubGVuZ3RoICsgIikiKTsKICAgIHJldHVybiBwcmludGVkOwogIH0KCiAgdmFyIFJlc3BvbmRlclRvdWNoSGlzdG9yeVN0b3JlID0gewogICAgcmVjb3JkVG91Y2hUcmFjazogZnVuY3Rpb24gcmVjb3JkVG91Y2hUcmFjayh0b3BMZXZlbFR5cGUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgIGlmIChpc01vdmVpc2godG9wTGV2ZWxUeXBlKSkgbmF0aXZlRXZlbnQuY2hhbmdlZFRvdWNoZXMuZm9yRWFjaChyZWNvcmRUb3VjaE1vdmUpO2Vsc2UgaWYgKGlzU3RhcnRpc2godG9wTGV2ZWxUeXBlKSkgbmF0aXZlRXZlbnQuY2hhbmdlZFRvdWNoZXMuZm9yRWFjaChyZWNvcmRUb3VjaFN0YXJ0KSwgdG91Y2hIaXN0b3J5Lm51bWJlckFjdGl2ZVRvdWNoZXMgPSBuYXRpdmVFdmVudC50b3VjaGVzLmxlbmd0aCwgMSA9PT0gdG91Y2hIaXN0b3J5Lm51bWJlckFjdGl2ZVRvdWNoZXMgJiYgKHRvdWNoSGlzdG9yeS5pbmRleE9mU2luZ2xlQWN0aXZlVG91Y2ggPSBuYXRpdmVFdmVudC50b3VjaGVzWzBdLmlkZW50aWZpZXIpO2Vsc2UgaWYgKGlzRW5kaXNoKHRvcExldmVsVHlwZSkgJiYgKG5hdGl2ZUV2ZW50LmNoYW5nZWRUb3VjaGVzLmZvckVhY2gocmVjb3JkVG91Y2hFbmQpLCB0b3VjaEhpc3RvcnkubnVtYmVyQWN0aXZlVG91Y2hlcyA9IG5hdGl2ZUV2ZW50LnRvdWNoZXMubGVuZ3RoLCAxID09PSB0b3VjaEhpc3RvcnkubnVtYmVyQWN0aXZlVG91Y2hlcykpIGZvciAodG9wTGV2ZWxUeXBlID0gMDsgdG9wTGV2ZWxUeXBlIDwgdG91Y2hCYW5rLmxlbmd0aDsgdG9wTGV2ZWxUeXBlKyspIHsKICAgICAgICBpZiAobmF0aXZlRXZlbnQgPSB0b3VjaEJhbmtbdG9wTGV2ZWxUeXBlXSwgbnVsbCAhPSBuYXRpdmVFdmVudCAmJiBuYXRpdmVFdmVudC50b3VjaEFjdGl2ZSkgewogICAgICAgICAgdG91Y2hIaXN0b3J5LmluZGV4T2ZTaW5nbGVBY3RpdmVUb3VjaCA9IHRvcExldmVsVHlwZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHRvdWNoSGlzdG9yeTogdG91Y2hIaXN0b3J5CiAgfTsKCiAgZnVuY3Rpb24gYWNjdW11bGF0ZShjdXJyZW50LCBuZXh0KSB7CiAgICBpbnZhcmlhbnQobnVsbCAhPSBuZXh0LCAiYWNjdW11bGF0ZSguLi4pOiBBY2N1bXVsYXRlZCBpdGVtcyBtdXN0IGJlIG5vdCBiZSBudWxsIG9yIHVuZGVmaW5lZC4iKTsKICAgIHJldHVybiBudWxsID09IGN1cnJlbnQgPyBuZXh0IDogQXJyYXkuaXNBcnJheShjdXJyZW50KSA/IGN1cnJlbnQuY29uY2F0KG5leHQpIDogQXJyYXkuaXNBcnJheShuZXh0KSA/IFtjdXJyZW50XS5jb25jYXQobmV4dCkgOiBbY3VycmVudCwgbmV4dF07CiAgfQoKICB2YXIgcmVzcG9uZGVySW5zdCA9IG51bGwsCiAgICAgIHRyYWNrZWRUb3VjaENvdW50ID0gMCwKICAgICAgcHJldmlvdXNBY3RpdmVUb3VjaGVzID0gMDsKCiAgZnVuY3Rpb24gY2hhbmdlUmVzcG9uZGVyKG5leHRSZXNwb25kZXJJbnN0LCBibG9ja0hvc3RSZXNwb25kZXIpIHsKICAgIHZhciBvbGRSZXNwb25kZXJJbnN0ID0gcmVzcG9uZGVySW5zdDsKICAgIHJlc3BvbmRlckluc3QgPSBuZXh0UmVzcG9uZGVySW5zdDsKICAgIGlmIChudWxsICE9PSBSZXNwb25kZXJFdmVudFBsdWdpbi5HbG9iYWxSZXNwb25kZXJIYW5kbGVyKSBSZXNwb25kZXJFdmVudFBsdWdpbi5HbG9iYWxSZXNwb25kZXJIYW5kbGVyLm9uQ2hhbmdlKG9sZFJlc3BvbmRlckluc3QsIG5leHRSZXNwb25kZXJJbnN0LCBibG9ja0hvc3RSZXNwb25kZXIpOwogIH0KCiAgdmFyIGV2ZW50VHlwZXMgPSB7CiAgICBzdGFydFNob3VsZFNldFJlc3BvbmRlcjogewogICAgICBwaGFzZWRSZWdpc3RyYXRpb25OYW1lczogewogICAgICAgIGJ1YmJsZWQ6ICJvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyIiwKICAgICAgICBjYXB0dXJlZDogIm9uU3RhcnRTaG91bGRTZXRSZXNwb25kZXJDYXB0dXJlIgogICAgICB9CiAgICB9LAogICAgc2Nyb2xsU2hvdWxkU2V0UmVzcG9uZGVyOiB7CiAgICAgIHBoYXNlZFJlZ2lzdHJhdGlvbk5hbWVzOiB7CiAgICAgICAgYnViYmxlZDogIm9uU2Nyb2xsU2hvdWxkU2V0UmVzcG9uZGVyIiwKICAgICAgICBjYXB0dXJlZDogIm9uU2Nyb2xsU2hvdWxkU2V0UmVzcG9uZGVyQ2FwdHVyZSIKICAgICAgfQogICAgfSwKICAgIHNlbGVjdGlvbkNoYW5nZVNob3VsZFNldFJlc3BvbmRlcjogewogICAgICBwaGFzZWRSZWdpc3RyYXRpb25OYW1lczogewogICAgICAgIGJ1YmJsZWQ6ICJvblNlbGVjdGlvbkNoYW5nZVNob3VsZFNldFJlc3BvbmRlciIsCiAgICAgICAgY2FwdHVyZWQ6ICJvblNlbGVjdGlvbkNoYW5nZVNob3VsZFNldFJlc3BvbmRlckNhcHR1cmUiCiAgICAgIH0KICAgIH0sCiAgICBtb3ZlU2hvdWxkU2V0UmVzcG9uZGVyOiB7CiAgICAgIHBoYXNlZFJlZ2lzdHJhdGlvbk5hbWVzOiB7CiAgICAgICAgYnViYmxlZDogIm9uTW92ZVNob3VsZFNldFJlc3BvbmRlciIsCiAgICAgICAgY2FwdHVyZWQ6ICJvbk1vdmVTaG91bGRTZXRSZXNwb25kZXJDYXB0dXJlIgogICAgICB9CiAgICB9LAogICAgcmVzcG9uZGVyU3RhcnQ6IHsKICAgICAgcmVnaXN0cmF0aW9uTmFtZTogIm9uUmVzcG9uZGVyU3RhcnQiCiAgICB9LAogICAgcmVzcG9uZGVyTW92ZTogewogICAgICByZWdpc3RyYXRpb25OYW1lOiAib25SZXNwb25kZXJNb3ZlIgogICAgfSwKICAgIHJlc3BvbmRlckVuZDogewogICAgICByZWdpc3RyYXRpb25OYW1lOiAib25SZXNwb25kZXJFbmQiCiAgICB9LAogICAgcmVzcG9uZGVyUmVsZWFzZTogewogICAgICByZWdpc3RyYXRpb25OYW1lOiAib25SZXNwb25kZXJSZWxlYXNlIgogICAgfSwKICAgIHJlc3BvbmRlclRlcm1pbmF0aW9uUmVxdWVzdDogewogICAgICByZWdpc3RyYXRpb25OYW1lOiAib25SZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3QiCiAgICB9LAogICAgcmVzcG9uZGVyR3JhbnQ6IHsKICAgICAgcmVnaXN0cmF0aW9uTmFtZTogIm9uUmVzcG9uZGVyR3JhbnQiCiAgICB9LAogICAgcmVzcG9uZGVyUmVqZWN0OiB7CiAgICAgIHJlZ2lzdHJhdGlvbk5hbWU6ICJvblJlc3BvbmRlclJlamVjdCIKICAgIH0sCiAgICByZXNwb25kZXJUZXJtaW5hdGU6IHsKICAgICAgcmVnaXN0cmF0aW9uTmFtZTogIm9uUmVzcG9uZGVyVGVybWluYXRlIgogICAgfQogIH0sCiAgICAgIFJlc3BvbmRlckV2ZW50UGx1Z2luID0gewogICAgX2dldFJlc3BvbmRlcjogZnVuY3Rpb24gX2dldFJlc3BvbmRlcigpIHsKICAgICAgcmV0dXJuIHJlc3BvbmRlckluc3Q7CiAgICB9LAogICAgZXZlbnRUeXBlczogZXZlbnRUeXBlcywKICAgIGV4dHJhY3RFdmVudHM6IGZ1bmN0aW9uIGV4dHJhY3RFdmVudHModG9wTGV2ZWxUeXBlLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgaWYgKGlzU3RhcnRpc2godG9wTGV2ZWxUeXBlKSkgdHJhY2tlZFRvdWNoQ291bnQgKz0gMTtlbHNlIGlmIChpc0VuZGlzaCh0b3BMZXZlbFR5cGUpKSBpZiAoMCA8PSB0cmFja2VkVG91Y2hDb3VudCkgLS10cmFja2VkVG91Y2hDb3VudDtlbHNlIHJldHVybiBjb25zb2xlLmVycm9yKCJFbmRlZCBhIHRvdWNoIGV2ZW50IHdoaWNoIHdhcyBub3QgY291bnRlZCBpbiBgdHJhY2tlZFRvdWNoQ291bnRgLiIpLCBudWxsOwogICAgICBSZXNwb25kZXJUb3VjaEhpc3RvcnlTdG9yZS5yZWNvcmRUb3VjaFRyYWNrKHRvcExldmVsVHlwZSwgbmF0aXZlRXZlbnQpOwoKICAgICAgaWYgKHRhcmdldEluc3QgJiYgKCJ0b3BTY3JvbGwiID09PSB0b3BMZXZlbFR5cGUgJiYgIW5hdGl2ZUV2ZW50LnJlc3BvbmRlcklnbm9yZVNjcm9sbCB8fCAwIDwgdHJhY2tlZFRvdWNoQ291bnQgJiYgInRvcFNlbGVjdGlvbkNoYW5nZSIgPT09IHRvcExldmVsVHlwZSB8fCBpc1N0YXJ0aXNoKHRvcExldmVsVHlwZSkgfHwgaXNNb3ZlaXNoKHRvcExldmVsVHlwZSkpKSB7CiAgICAgICAgdmFyIHNob3VsZFNldEV2ZW50VHlwZSA9IGlzU3RhcnRpc2godG9wTGV2ZWxUeXBlKSA/IGV2ZW50VHlwZXMuc3RhcnRTaG91bGRTZXRSZXNwb25kZXIgOiBpc01vdmVpc2godG9wTGV2ZWxUeXBlKSA/IGV2ZW50VHlwZXMubW92ZVNob3VsZFNldFJlc3BvbmRlciA6ICJ0b3BTZWxlY3Rpb25DaGFuZ2UiID09PSB0b3BMZXZlbFR5cGUgPyBldmVudFR5cGVzLnNlbGVjdGlvbkNoYW5nZVNob3VsZFNldFJlc3BvbmRlciA6IGV2ZW50VHlwZXMuc2Nyb2xsU2hvdWxkU2V0UmVzcG9uZGVyOwogICAgICAgIGlmIChyZXNwb25kZXJJbnN0KSBiOiB7CiAgICAgICAgICB2YXIgSlNDb21waWxlcl90ZW1wID0gcmVzcG9uZGVySW5zdDsKCiAgICAgICAgICBmb3IgKHZhciBkZXB0aEEgPSAwLCB0ZW1wQSA9IEpTQ29tcGlsZXJfdGVtcDsgdGVtcEE7IHRlbXBBID0gZ2V0UGFyZW50KHRlbXBBKSkgewogICAgICAgICAgICBkZXB0aEErKzsKICAgICAgICAgIH0KCiAgICAgICAgICB0ZW1wQSA9IDA7CgogICAgICAgICAgZm9yICh2YXIgdGVtcEIgPSB0YXJnZXRJbnN0OyB0ZW1wQjsgdGVtcEIgPSBnZXRQYXJlbnQodGVtcEIpKSB7CiAgICAgICAgICAgIHRlbXBBKys7CiAgICAgICAgICB9CgogICAgICAgICAgZm9yICg7IDAgPCBkZXB0aEEgLSB0ZW1wQTspIHsKICAgICAgICAgICAgSlNDb21waWxlcl90ZW1wID0gZ2V0UGFyZW50KEpTQ29tcGlsZXJfdGVtcCksIGRlcHRoQS0tOwogICAgICAgICAgfQoKICAgICAgICAgIGZvciAoOyAwIDwgdGVtcEEgLSBkZXB0aEE7KSB7CiAgICAgICAgICAgIHRhcmdldEluc3QgPSBnZXRQYXJlbnQodGFyZ2V0SW5zdCksIHRlbXBBLS07CiAgICAgICAgICB9CgogICAgICAgICAgZm9yICg7IGRlcHRoQS0tOykgewogICAgICAgICAgICBpZiAoSlNDb21waWxlcl90ZW1wID09PSB0YXJnZXRJbnN0IHx8IEpTQ29tcGlsZXJfdGVtcCA9PT0gdGFyZ2V0SW5zdC5hbHRlcm5hdGUpIGJyZWFrIGI7CiAgICAgICAgICAgIEpTQ29tcGlsZXJfdGVtcCA9IGdldFBhcmVudChKU0NvbXBpbGVyX3RlbXApOwogICAgICAgICAgICB0YXJnZXRJbnN0ID0gZ2V0UGFyZW50KHRhcmdldEluc3QpOwogICAgICAgICAgfQoKICAgICAgICAgIEpTQ29tcGlsZXJfdGVtcCA9IG51bGw7CiAgICAgICAgfSBlbHNlIEpTQ29tcGlsZXJfdGVtcCA9IHRhcmdldEluc3Q7CiAgICAgICAgdGFyZ2V0SW5zdCA9IEpTQ29tcGlsZXJfdGVtcCA9PT0gcmVzcG9uZGVySW5zdDsKICAgICAgICBKU0NvbXBpbGVyX3RlbXAgPSBSZXNwb25kZXJTeW50aGV0aWNFdmVudC5nZXRQb29sZWQoc2hvdWxkU2V0RXZlbnRUeXBlLCBKU0NvbXBpbGVyX3RlbXAsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgSlNDb21waWxlcl90ZW1wLnRvdWNoSGlzdG9yeSA9IFJlc3BvbmRlclRvdWNoSGlzdG9yeVN0b3JlLnRvdWNoSGlzdG9yeTsKICAgICAgICB0YXJnZXRJbnN0ID8gZm9yRWFjaEFjY3VtdWxhdGVkKEpTQ29tcGlsZXJfdGVtcCwgYWNjdW11bGF0ZVR3b1BoYXNlRGlzcGF0Y2hlc1NpbmdsZVNraXBUYXJnZXQpIDogZm9yRWFjaEFjY3VtdWxhdGVkKEpTQ29tcGlsZXJfdGVtcCwgYWNjdW11bGF0ZVR3b1BoYXNlRGlzcGF0Y2hlc1NpbmdsZSk7CgogICAgICAgIGI6IHsKICAgICAgICAgIHNob3VsZFNldEV2ZW50VHlwZSA9IEpTQ29tcGlsZXJfdGVtcC5fZGlzcGF0Y2hMaXN0ZW5lcnM7CiAgICAgICAgICB0YXJnZXRJbnN0ID0gSlNDb21waWxlcl90ZW1wLl9kaXNwYXRjaEluc3RhbmNlczsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHNob3VsZFNldEV2ZW50VHlwZSkpIGZvciAoZGVwdGhBID0gMDsgZGVwdGhBIDwgc2hvdWxkU2V0RXZlbnRUeXBlLmxlbmd0aCAmJiAhSlNDb21waWxlcl90ZW1wLmlzUHJvcGFnYXRpb25TdG9wcGVkKCk7IGRlcHRoQSsrKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRTZXRFdmVudFR5cGVbZGVwdGhBXShKU0NvbXBpbGVyX3RlbXAsIHRhcmdldEluc3RbZGVwdGhBXSkpIHsKICAgICAgICAgICAgICBzaG91bGRTZXRFdmVudFR5cGUgPSB0YXJnZXRJbnN0W2RlcHRoQV07CiAgICAgICAgICAgICAgYnJlYWsgYjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRTZXRFdmVudFR5cGUgJiYgc2hvdWxkU2V0RXZlbnRUeXBlKEpTQ29tcGlsZXJfdGVtcCwgdGFyZ2V0SW5zdCkpIHsKICAgICAgICAgICAgc2hvdWxkU2V0RXZlbnRUeXBlID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgYnJlYWsgYjsKICAgICAgICAgIH0KICAgICAgICAgIHNob3VsZFNldEV2ZW50VHlwZSA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBKU0NvbXBpbGVyX3RlbXAuX2Rpc3BhdGNoSW5zdGFuY2VzID0gbnVsbDsKICAgICAgICBKU0NvbXBpbGVyX3RlbXAuX2Rpc3BhdGNoTGlzdGVuZXJzID0gbnVsbDsKICAgICAgICBKU0NvbXBpbGVyX3RlbXAuaXNQZXJzaXN0ZW50KCkgfHwgSlNDb21waWxlcl90ZW1wLmNvbnN0cnVjdG9yLnJlbGVhc2UoSlNDb21waWxlcl90ZW1wKTsKICAgICAgICBpZiAoc2hvdWxkU2V0RXZlbnRUeXBlICYmIHNob3VsZFNldEV2ZW50VHlwZSAhPT0gcmVzcG9uZGVySW5zdCkgewogICAgICAgICAgaWYgKEpTQ29tcGlsZXJfdGVtcCA9IFJlc3BvbmRlclN5bnRoZXRpY0V2ZW50LmdldFBvb2xlZChldmVudFR5cGVzLnJlc3BvbmRlckdyYW50LCBzaG91bGRTZXRFdmVudFR5cGUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCksIEpTQ29tcGlsZXJfdGVtcC50b3VjaEhpc3RvcnkgPSBSZXNwb25kZXJUb3VjaEhpc3RvcnlTdG9yZS50b3VjaEhpc3RvcnksIGZvckVhY2hBY2N1bXVsYXRlZChKU0NvbXBpbGVyX3RlbXAsIGFjY3VtdWxhdGVEaXJlY3REaXNwYXRjaGVzU2luZ2xlKSwgdGFyZ2V0SW5zdCA9ICEwID09PSBleGVjdXRlRGlyZWN0RGlzcGF0Y2goSlNDb21waWxlcl90ZW1wKSwgcmVzcG9uZGVySW5zdCkgewogICAgICAgICAgICBpZiAoZGVwdGhBID0gUmVzcG9uZGVyU3ludGhldGljRXZlbnQuZ2V0UG9vbGVkKGV2ZW50VHlwZXMucmVzcG9uZGVyVGVybWluYXRpb25SZXF1ZXN0LCByZXNwb25kZXJJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpLCBkZXB0aEEudG91Y2hIaXN0b3J5ID0gUmVzcG9uZGVyVG91Y2hIaXN0b3J5U3RvcmUudG91Y2hIaXN0b3J5LCBmb3JFYWNoQWNjdW11bGF0ZWQoZGVwdGhBLCBhY2N1bXVsYXRlRGlyZWN0RGlzcGF0Y2hlc1NpbmdsZSksIHRlbXBBID0gIWRlcHRoQS5fZGlzcGF0Y2hMaXN0ZW5lcnMgfHwgZXhlY3V0ZURpcmVjdERpc3BhdGNoKGRlcHRoQSksIGRlcHRoQS5pc1BlcnNpc3RlbnQoKSB8fCBkZXB0aEEuY29uc3RydWN0b3IucmVsZWFzZShkZXB0aEEpLCB0ZW1wQSkgewogICAgICAgICAgICAgIGRlcHRoQSA9IFJlc3BvbmRlclN5bnRoZXRpY0V2ZW50LmdldFBvb2xlZChldmVudFR5cGVzLnJlc3BvbmRlclRlcm1pbmF0ZSwgcmVzcG9uZGVySW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBkZXB0aEEudG91Y2hIaXN0b3J5ID0gUmVzcG9uZGVyVG91Y2hIaXN0b3J5U3RvcmUudG91Y2hIaXN0b3J5OwogICAgICAgICAgICAgIGZvckVhY2hBY2N1bXVsYXRlZChkZXB0aEEsIGFjY3VtdWxhdGVEaXJlY3REaXNwYXRjaGVzU2luZ2xlKTsKICAgICAgICAgICAgICB2YXIgSlNDb21waWxlcl90ZW1wJGpzY29tcCQwID0gYWNjdW11bGF0ZShKU0NvbXBpbGVyX3RlbXAkanNjb21wJDAsIFtKU0NvbXBpbGVyX3RlbXAsIGRlcHRoQV0pOwogICAgICAgICAgICAgIGNoYW5nZVJlc3BvbmRlcihzaG91bGRTZXRFdmVudFR5cGUsIHRhcmdldEluc3QpOwogICAgICAgICAgICB9IGVsc2Ugc2hvdWxkU2V0RXZlbnRUeXBlID0gUmVzcG9uZGVyU3ludGhldGljRXZlbnQuZ2V0UG9vbGVkKGV2ZW50VHlwZXMucmVzcG9uZGVyUmVqZWN0LCBzaG91bGRTZXRFdmVudFR5cGUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCksIHNob3VsZFNldEV2ZW50VHlwZS50b3VjaEhpc3RvcnkgPSBSZXNwb25kZXJUb3VjaEhpc3RvcnlTdG9yZS50b3VjaEhpc3RvcnksIGZvckVhY2hBY2N1bXVsYXRlZChzaG91bGRTZXRFdmVudFR5cGUsIGFjY3VtdWxhdGVEaXJlY3REaXNwYXRjaGVzU2luZ2xlKSwgSlNDb21waWxlcl90ZW1wJGpzY29tcCQwID0gYWNjdW11bGF0ZShKU0NvbXBpbGVyX3RlbXAkanNjb21wJDAsIHNob3VsZFNldEV2ZW50VHlwZSk7CiAgICAgICAgICB9IGVsc2UgSlNDb21waWxlcl90ZW1wJGpzY29tcCQwID0gYWNjdW11bGF0ZShKU0NvbXBpbGVyX3RlbXAkanNjb21wJDAsIEpTQ29tcGlsZXJfdGVtcCksIGNoYW5nZVJlc3BvbmRlcihzaG91bGRTZXRFdmVudFR5cGUsIHRhcmdldEluc3QpOwogICAgICAgIH0gZWxzZSBKU0NvbXBpbGVyX3RlbXAkanNjb21wJDAgPSBudWxsOwogICAgICB9IGVsc2UgSlNDb21waWxlcl90ZW1wJGpzY29tcCQwID0gbnVsbDsKCiAgICAgIHNob3VsZFNldEV2ZW50VHlwZSA9IHJlc3BvbmRlckluc3QgJiYgaXNTdGFydGlzaCh0b3BMZXZlbFR5cGUpOwogICAgICBKU0NvbXBpbGVyX3RlbXAgPSByZXNwb25kZXJJbnN0ICYmIGlzTW92ZWlzaCh0b3BMZXZlbFR5cGUpOwogICAgICB0YXJnZXRJbnN0ID0gcmVzcG9uZGVySW5zdCAmJiBpc0VuZGlzaCh0b3BMZXZlbFR5cGUpOwogICAgICBpZiAoc2hvdWxkU2V0RXZlbnRUeXBlID0gc2hvdWxkU2V0RXZlbnRUeXBlID8gZXZlbnRUeXBlcy5yZXNwb25kZXJTdGFydCA6IEpTQ29tcGlsZXJfdGVtcCA/IGV2ZW50VHlwZXMucmVzcG9uZGVyTW92ZSA6IHRhcmdldEluc3QgPyBldmVudFR5cGVzLnJlc3BvbmRlckVuZCA6IG51bGwpIHNob3VsZFNldEV2ZW50VHlwZSA9IFJlc3BvbmRlclN5bnRoZXRpY0V2ZW50LmdldFBvb2xlZChzaG91bGRTZXRFdmVudFR5cGUsIHJlc3BvbmRlckluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCksIHNob3VsZFNldEV2ZW50VHlwZS50b3VjaEhpc3RvcnkgPSBSZXNwb25kZXJUb3VjaEhpc3RvcnlTdG9yZS50b3VjaEhpc3RvcnksIGZvckVhY2hBY2N1bXVsYXRlZChzaG91bGRTZXRFdmVudFR5cGUsIGFjY3VtdWxhdGVEaXJlY3REaXNwYXRjaGVzU2luZ2xlKSwgSlNDb21waWxlcl90ZW1wJGpzY29tcCQwID0gYWNjdW11bGF0ZShKU0NvbXBpbGVyX3RlbXAkanNjb21wJDAsIHNob3VsZFNldEV2ZW50VHlwZSk7CiAgICAgIHNob3VsZFNldEV2ZW50VHlwZSA9IHJlc3BvbmRlckluc3QgJiYgInRvcFRvdWNoQ2FuY2VsIiA9PT0gdG9wTGV2ZWxUeXBlOwogICAgICBpZiAodG9wTGV2ZWxUeXBlID0gcmVzcG9uZGVySW5zdCAmJiAhc2hvdWxkU2V0RXZlbnRUeXBlICYmIGlzRW5kaXNoKHRvcExldmVsVHlwZSkpIGE6IHsKICAgICAgICBpZiAoKHRvcExldmVsVHlwZSA9IG5hdGl2ZUV2ZW50LnRvdWNoZXMpICYmIDAgIT09IHRvcExldmVsVHlwZS5sZW5ndGgpIGZvciAoSlNDb21waWxlcl90ZW1wID0gMDsgSlNDb21waWxlcl90ZW1wIDwgdG9wTGV2ZWxUeXBlLmxlbmd0aDsgSlNDb21waWxlcl90ZW1wKyspIHsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0ID0gdG9wTGV2ZWxUeXBlW0pTQ29tcGlsZXJfdGVtcF0udGFyZ2V0LCBudWxsICE9PSB0YXJnZXRJbnN0ICYmIHZvaWQgMCAhPT0gdGFyZ2V0SW5zdCAmJiAwICE9PSB0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgIGRlcHRoQSA9IGdldEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0SW5zdCk7CgogICAgICAgICAgICBiOiB7CiAgICAgICAgICAgICAgZm9yICh0YXJnZXRJbnN0ID0gcmVzcG9uZGVySW5zdDsgZGVwdGhBOykgewogICAgICAgICAgICAgICAgaWYgKHRhcmdldEluc3QgPT09IGRlcHRoQSB8fCB0YXJnZXRJbnN0ID09PSBkZXB0aEEuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSAhMDsKICAgICAgICAgICAgICAgICAgYnJlYWsgYjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBkZXB0aEEgPSBnZXRQYXJlbnQoZGVwdGhBKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHRhcmdldEluc3QgPSAhMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhcmdldEluc3QpIHsKICAgICAgICAgICAgICB0b3BMZXZlbFR5cGUgPSAhMTsKICAgICAgICAgICAgICBicmVhayBhOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRvcExldmVsVHlwZSA9ICEwOwogICAgICB9CiAgICAgIGlmICh0b3BMZXZlbFR5cGUgPSBzaG91bGRTZXRFdmVudFR5cGUgPyBldmVudFR5cGVzLnJlc3BvbmRlclRlcm1pbmF0ZSA6IHRvcExldmVsVHlwZSA/IGV2ZW50VHlwZXMucmVzcG9uZGVyUmVsZWFzZSA6IG51bGwpIG5hdGl2ZUV2ZW50ID0gUmVzcG9uZGVyU3ludGhldGljRXZlbnQuZ2V0UG9vbGVkKHRvcExldmVsVHlwZSwgcmVzcG9uZGVySW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSwgbmF0aXZlRXZlbnQudG91Y2hIaXN0b3J5ID0gUmVzcG9uZGVyVG91Y2hIaXN0b3J5U3RvcmUudG91Y2hIaXN0b3J5LCBmb3JFYWNoQWNjdW11bGF0ZWQobmF0aXZlRXZlbnQsIGFjY3VtdWxhdGVEaXJlY3REaXNwYXRjaGVzU2luZ2xlKSwgSlNDb21waWxlcl90ZW1wJGpzY29tcCQwID0gYWNjdW11bGF0ZShKU0NvbXBpbGVyX3RlbXAkanNjb21wJDAsIG5hdGl2ZUV2ZW50KSwgY2hhbmdlUmVzcG9uZGVyKG51bGwpOwogICAgICBuYXRpdmVFdmVudCA9IFJlc3BvbmRlclRvdWNoSGlzdG9yeVN0b3JlLnRvdWNoSGlzdG9yeS5udW1iZXJBY3RpdmVUb3VjaGVzOwogICAgICBpZiAoUmVzcG9uZGVyRXZlbnRQbHVnaW4uR2xvYmFsSW50ZXJhY3Rpb25IYW5kbGVyICYmIG5hdGl2ZUV2ZW50ICE9PSBwcmV2aW91c0FjdGl2ZVRvdWNoZXMpIFJlc3BvbmRlckV2ZW50UGx1Z2luLkdsb2JhbEludGVyYWN0aW9uSGFuZGxlci5vbkNoYW5nZShuYXRpdmVFdmVudCk7CiAgICAgIHByZXZpb3VzQWN0aXZlVG91Y2hlcyA9IG5hdGl2ZUV2ZW50OwogICAgICByZXR1cm4gSlNDb21waWxlcl90ZW1wJGpzY29tcCQwOwogICAgfSwKICAgIEdsb2JhbFJlc3BvbmRlckhhbmRsZXI6IG51bGwsCiAgICBHbG9iYWxJbnRlcmFjdGlvbkhhbmRsZXI6IG51bGwsCiAgICBpbmplY3Rpb246IHsKICAgICAgaW5qZWN0R2xvYmFsUmVzcG9uZGVySGFuZGxlcjogZnVuY3Rpb24gaW5qZWN0R2xvYmFsUmVzcG9uZGVySGFuZGxlcihHbG9iYWxSZXNwb25kZXJIYW5kbGVyKSB7CiAgICAgICAgUmVzcG9uZGVyRXZlbnRQbHVnaW4uR2xvYmFsUmVzcG9uZGVySGFuZGxlciA9IEdsb2JhbFJlc3BvbmRlckhhbmRsZXI7CiAgICAgIH0sCiAgICAgIGluamVjdEdsb2JhbEludGVyYWN0aW9uSGFuZGxlcjogZnVuY3Rpb24gaW5qZWN0R2xvYmFsSW50ZXJhY3Rpb25IYW5kbGVyKEdsb2JhbEludGVyYWN0aW9uSGFuZGxlcikgewogICAgICAgIFJlc3BvbmRlckV2ZW50UGx1Z2luLkdsb2JhbEludGVyYWN0aW9uSGFuZGxlciA9IEdsb2JhbEludGVyYWN0aW9uSGFuZGxlcjsKICAgICAgfQogICAgfQogIH0sCiAgICAgIGN1c3RvbUJ1YmJsaW5nRXZlbnRUeXBlcyA9IHt9LAogICAgICBjdXN0b21EaXJlY3RFdmVudFR5cGVzID0ge30sCiAgICAgIFJlYWN0TmF0aXZlQnJpZGdlRXZlbnRQbHVnaW4gPSB7CiAgICBldmVudFR5cGVzOiB7fSwKICAgIGV4dHJhY3RFdmVudHM6IGZ1bmN0aW9uIGV4dHJhY3RFdmVudHModG9wTGV2ZWxUeXBlLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgdmFyIGJ1YmJsZURpc3BhdGNoQ29uZmlnID0gY3VzdG9tQnViYmxpbmdFdmVudFR5cGVzW3RvcExldmVsVHlwZV0sCiAgICAgICAgICBkaXJlY3REaXNwYXRjaENvbmZpZyA9IGN1c3RvbURpcmVjdEV2ZW50VHlwZXNbdG9wTGV2ZWxUeXBlXTsKICAgICAgaW52YXJpYW50KGJ1YmJsZURpc3BhdGNoQ29uZmlnIHx8IGRpcmVjdERpc3BhdGNoQ29uZmlnLCAnVW5zdXBwb3J0ZWQgdG9wIGxldmVsIGV2ZW50IHR5cGUgIiVzIiBkaXNwYXRjaGVkJywgdG9wTGV2ZWxUeXBlKTsKICAgICAgdG9wTGV2ZWxUeXBlID0gU3ludGhldGljRXZlbnQuZ2V0UG9vbGVkKGJ1YmJsZURpc3BhdGNoQ29uZmlnIHx8IGRpcmVjdERpc3BhdGNoQ29uZmlnLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICBpZiAoYnViYmxlRGlzcGF0Y2hDb25maWcpIGZvckVhY2hBY2N1bXVsYXRlZCh0b3BMZXZlbFR5cGUsIGFjY3VtdWxhdGVUd29QaGFzZURpc3BhdGNoZXNTaW5nbGUpO2Vsc2UgaWYgKGRpcmVjdERpc3BhdGNoQ29uZmlnKSBmb3JFYWNoQWNjdW11bGF0ZWQodG9wTGV2ZWxUeXBlLCBhY2N1bXVsYXRlRGlyZWN0RGlzcGF0Y2hlc1NpbmdsZSk7ZWxzZSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHRvcExldmVsVHlwZTsKICAgIH0sCiAgICBwcm9jZXNzRXZlbnRUeXBlczogZnVuY3Rpb24gcHJvY2Vzc0V2ZW50VHlwZXModmlld0NvbmZpZykgewogICAgICB2YXIgYnViYmxpbmdFdmVudFR5cGVzID0gdmlld0NvbmZpZy5idWJibGluZ0V2ZW50VHlwZXM7CiAgICAgIHZpZXdDb25maWcgPSB2aWV3Q29uZmlnLmRpcmVjdEV2ZW50VHlwZXM7CiAgICAgIGlmIChudWxsICE9IGJ1YmJsaW5nRXZlbnRUeXBlcykgZm9yICh2YXIgX3RvcExldmVsVHlwZSBpbiBidWJibGluZ0V2ZW50VHlwZXMpIHsKICAgICAgICBudWxsID09IGN1c3RvbUJ1YmJsaW5nRXZlbnRUeXBlc1tfdG9wTGV2ZWxUeXBlXSAmJiAoUmVhY3ROYXRpdmVCcmlkZ2VFdmVudFBsdWdpbi5ldmVudFR5cGVzW190b3BMZXZlbFR5cGVdID0gY3VzdG9tQnViYmxpbmdFdmVudFR5cGVzW190b3BMZXZlbFR5cGVdID0gYnViYmxpbmdFdmVudFR5cGVzW190b3BMZXZlbFR5cGVdKTsKICAgICAgfQogICAgICBpZiAobnVsbCAhPSB2aWV3Q29uZmlnKSBmb3IgKHZhciBfdG9wTGV2ZWxUeXBlMiBpbiB2aWV3Q29uZmlnKSB7CiAgICAgICAgbnVsbCA9PSBjdXN0b21EaXJlY3RFdmVudFR5cGVzW190b3BMZXZlbFR5cGUyXSAmJiAoUmVhY3ROYXRpdmVCcmlkZ2VFdmVudFBsdWdpbi5ldmVudFR5cGVzW190b3BMZXZlbFR5cGUyXSA9IGN1c3RvbURpcmVjdEV2ZW50VHlwZXNbX3RvcExldmVsVHlwZTJdID0gdmlld0NvbmZpZ1tfdG9wTGV2ZWxUeXBlMl0pOwogICAgICB9CiAgICB9CiAgfSwKICAgICAgaW5zdGFuY2VDYWNoZSA9IHt9LAogICAgICBpbnN0YW5jZVByb3BzID0ge307CgogIGZ1bmN0aW9uIHVuY2FjaGVGaWJlck5vZGUodGFnKSB7CiAgICBkZWxldGUgaW5zdGFuY2VDYWNoZVt0YWddOwogICAgZGVsZXRlIGluc3RhbmNlUHJvcHNbdGFnXTsKICB9CgogIGZ1bmN0aW9uIGdldEluc3RhbmNlRnJvbVRhZyh0YWcpIHsKICAgIHJldHVybiBpbnN0YW5jZUNhY2hlW3RhZ10gfHwgbnVsbDsKICB9CgogIHZhciBSZWFjdE5hdGl2ZUNvbXBvbmVudFRyZWUgPSBPYmplY3QuZnJlZXplKHsKICAgIHByZWNhY2hlRmliZXJOb2RlOiBmdW5jdGlvbiBwcmVjYWNoZUZpYmVyTm9kZShob3N0SW5zdCwgdGFnKSB7CiAgICAgIGluc3RhbmNlQ2FjaGVbdGFnXSA9IGhvc3RJbnN0OwogICAgfSwKICAgIHVuY2FjaGVGaWJlck5vZGU6IHVuY2FjaGVGaWJlck5vZGUsCiAgICBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZTogZ2V0SW5zdGFuY2VGcm9tVGFnLAogICAgZ2V0SW5zdGFuY2VGcm9tTm9kZTogZ2V0SW5zdGFuY2VGcm9tVGFnLAogICAgZ2V0Tm9kZUZyb21JbnN0YW5jZTogZnVuY3Rpb24gZ2V0Tm9kZUZyb21JbnN0YW5jZShpbnN0KSB7CiAgICAgIGluc3QgPSBpbnN0LnN0YXRlTm9kZS5fbmF0aXZlVGFnOwogICAgICBpbnZhcmlhbnQoaW5zdCwgIkFsbCBuYXRpdmUgaW5zdGFuY2VzIHNob3VsZCBoYXZlIGEgdGFnLiIpOwogICAgICByZXR1cm4gaW5zdDsKICAgIH0sCiAgICBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlOiBmdW5jdGlvbiBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSkgewogICAgICByZXR1cm4gaW5zdGFuY2VQcm9wc1tzdGF0ZU5vZGUuX25hdGl2ZVRhZ10gfHwgbnVsbDsKICAgIH0sCiAgICB1cGRhdGVGaWJlclByb3BzOiBmdW5jdGlvbiB1cGRhdGVGaWJlclByb3BzKHRhZywgcHJvcHMpIHsKICAgICAgaW5zdGFuY2VQcm9wc1t0YWddID0gcHJvcHM7CiAgICB9CiAgfSksCiAgICAgIHJlc3RvcmVUYXJnZXQgPSBudWxsLAogICAgICByZXN0b3JlUXVldWUgPSBudWxsOwoKICBmdW5jdGlvbiByZXN0b3JlU3RhdGVPZlRhcmdldCh0YXJnZXQpIHsKICAgIGlmICh0YXJnZXQgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKHRhcmdldCkpIHsKICAgICAgaW52YXJpYW50KG51bGwsICJGaWJlciBuZWVkcyB0byBiZSBpbmplY3RlZCB0byBoYW5kbGUgYSBmaWJlciB0YXJnZXQgZm9yIGNvbnRyb2xsZWQgZXZlbnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICB2YXIgcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHRhcmdldC5zdGF0ZU5vZGUpOwogICAgICBudWxsLnJlc3RvcmVDb250cm9sbGVkU3RhdGUodGFyZ2V0LnN0YXRlTm9kZSwgdGFyZ2V0LnR5cGUsIHByb3BzKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGZpYmVyQmF0Y2hlZFVwZGF0ZXMoZm4sIGJvb2trZWVwaW5nKSB7CiAgICByZXR1cm4gZm4oYm9va2tlZXBpbmcpOwogIH0KCiAgdmFyIGlzTmVzdGluZ0JhdGNoZWQgPSAhMTsKCiAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMoZm4sIGJvb2trZWVwaW5nKSB7CiAgICBpZiAoaXNOZXN0aW5nQmF0Y2hlZCkgcmV0dXJuIGZpYmVyQmF0Y2hlZFVwZGF0ZXMoZm4sIGJvb2trZWVwaW5nKTsKICAgIGlzTmVzdGluZ0JhdGNoZWQgPSAhMDsKCiAgICB0cnkgewogICAgICByZXR1cm4gZmliZXJCYXRjaGVkVXBkYXRlcyhmbiwgYm9va2tlZXBpbmcpOwogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKGlzTmVzdGluZ0JhdGNoZWQgPSAhMSwgcmVzdG9yZVRhcmdldCAmJiAoYm9va2tlZXBpbmcgPSByZXN0b3JlVGFyZ2V0LCBmbiA9IHJlc3RvcmVRdWV1ZSwgcmVzdG9yZVF1ZXVlID0gcmVzdG9yZVRhcmdldCA9IG51bGwsIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KGJvb2trZWVwaW5nKSwgZm4pKSBmb3IgKGJvb2trZWVwaW5nID0gMDsgYm9va2tlZXBpbmcgPCBmbi5sZW5ndGg7IGJvb2trZWVwaW5nKyspIHsKICAgICAgICByZXN0b3JlU3RhdGVPZlRhcmdldChmbltib29ra2VlcGluZ10pOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVUb3BMZXZlbCh0b3BMZXZlbFR5cGUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgZm9yICh2YXIgZXZlbnRzLCBpID0gMDsgaSA8IHBsdWdpbnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHBvc3NpYmxlUGx1Z2luID0gcGx1Z2luc1tpXTsKICAgICAgcG9zc2libGVQbHVnaW4gJiYgKHBvc3NpYmxlUGx1Z2luID0gcG9zc2libGVQbHVnaW4uZXh0cmFjdEV2ZW50cyh0b3BMZXZlbFR5cGUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkpICYmIChldmVudHMgPSBhY2N1bXVsYXRlSW50byhldmVudHMsIHBvc3NpYmxlUGx1Z2luKSk7CiAgICB9CgogICAgZXZlbnRzICYmIChldmVudFF1ZXVlID0gYWNjdW11bGF0ZUludG8oZXZlbnRRdWV1ZSwgZXZlbnRzKSk7CiAgICB0b3BMZXZlbFR5cGUgPSBldmVudFF1ZXVlOwogICAgZXZlbnRRdWV1ZSA9IG51bGw7CiAgICB0b3BMZXZlbFR5cGUgJiYgKGZvckVhY2hBY2N1bXVsYXRlZCh0b3BMZXZlbFR5cGUsIGV4ZWN1dGVEaXNwYXRjaGVzQW5kUmVsZWFzZVRvcExldmVsKSwgaW52YXJpYW50KCFldmVudFF1ZXVlLCAicHJvY2Vzc0V2ZW50UXVldWUoKTogQWRkaXRpb25hbCBldmVudHMgd2VyZSBlbnF1ZXVlZCB3aGlsZSBwcm9jZXNzaW5nIGFuIGV2ZW50IHF1ZXVlLiBTdXBwb3J0IGZvciB0aGlzIGhhcyBub3QgeWV0IGJlZW4gaW1wbGVtZW50ZWQuIiksIFJlYWN0RXJyb3JVdGlscy5yZXRocm93Q2F1Z2h0RXJyb3IoKSk7CiAgfQoKICB2YXIgUmVhY3ROYXRpdmVUYWdIYW5kbGVzID0gewogICAgdGFnc1N0YXJ0QXQ6IDEsCiAgICB0YWdDb3VudDogMSwKICAgIGFsbG9jYXRlVGFnOiBmdW5jdGlvbiBhbGxvY2F0ZVRhZygpIHsKICAgICAgZm9yICg7IHRoaXMucmVhY3RUYWdJc05hdGl2ZVRvcFJvb3RJRChSZWFjdE5hdGl2ZVRhZ0hhbmRsZXMudGFnQ291bnQpOykgewogICAgICAgIFJlYWN0TmF0aXZlVGFnSGFuZGxlcy50YWdDb3VudCsrOwogICAgICB9CgogICAgICB2YXIgdGFnID0gUmVhY3ROYXRpdmVUYWdIYW5kbGVzLnRhZ0NvdW50OwogICAgICBSZWFjdE5hdGl2ZVRhZ0hhbmRsZXMudGFnQ291bnQrKzsKICAgICAgcmV0dXJuIHRhZzsKICAgIH0sCiAgICBhc3NlcnRSb290VGFnOiBmdW5jdGlvbiBhc3NlcnRSb290VGFnKHRhZykgewogICAgICBpbnZhcmlhbnQodGhpcy5yZWFjdFRhZ0lzTmF0aXZlVG9wUm9vdElEKHRhZyksICJFeHBlY3QgYSBuYXRpdmUgcm9vdCB0YWcsIGluc3RlYWQgZ290ICVzIiwgdGFnKTsKICAgIH0sCiAgICByZWFjdFRhZ0lzTmF0aXZlVG9wUm9vdElEOiBmdW5jdGlvbiByZWFjdFRhZ0lzTmF0aXZlVG9wUm9vdElEKHJlYWN0VGFnKSB7CiAgICAgIHJldHVybiAxID09PSByZWFjdFRhZyAlIDEwOwogICAgfQogIH0sCiAgICAgIEVNUFRZX05BVElWRV9FVkVOVCA9IHt9OwoKICBmdW5jdGlvbiBfcmVjZWl2ZVJvb3ROb2RlSURFdmVudChyb290Tm9kZUlELCB0b3BMZXZlbFR5cGUsIG5hdGl2ZUV2ZW50UGFyYW0pIHsKICAgIHZhciBuYXRpdmVFdmVudCA9IG5hdGl2ZUV2ZW50UGFyYW0gfHwgRU1QVFlfTkFUSVZFX0VWRU5ULAogICAgICAgIGluc3QgPSBnZXRJbnN0YW5jZUZyb21UYWcocm9vdE5vZGVJRCk7CiAgICBiYXRjaGVkVXBkYXRlcyhmdW5jdGlvbiAoKSB7CiAgICAgIGhhbmRsZVRvcExldmVsKHRvcExldmVsVHlwZSwgaW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50LnRhcmdldCk7CiAgICB9KTsKICB9CgogIHZhciBSZWFjdE5hdGl2ZUV2ZW50RW1pdHRlciA9IE9iamVjdC5mcmVlemUoewogICAgZ2V0TGlzdGVuZXI6IGdldExpc3RlbmVyLAogICAgcmVnaXN0cmF0aW9uTmFtZXM6IHJlZ2lzdHJhdGlvbk5hbWVNb2R1bGVzLAogICAgX3JlY2VpdmVSb290Tm9kZUlERXZlbnQ6IF9yZWNlaXZlUm9vdE5vZGVJREV2ZW50LAogICAgcmVjZWl2ZUV2ZW50OiBmdW5jdGlvbiByZWNlaXZlRXZlbnQocm9vdE5vZGVJRCwgdG9wTGV2ZWxUeXBlLCBuYXRpdmVFdmVudFBhcmFtKSB7CiAgICAgIF9yZWNlaXZlUm9vdE5vZGVJREV2ZW50KHJvb3ROb2RlSUQsIHRvcExldmVsVHlwZSwgbmF0aXZlRXZlbnRQYXJhbSk7CiAgICB9LAogICAgcmVjZWl2ZVRvdWNoZXM6IGZ1bmN0aW9uIHJlY2VpdmVUb3VjaGVzKGV2ZW50VG9wTGV2ZWxUeXBlLCB0b3VjaGVzLCBjaGFuZ2VkSW5kaWNlcykgewogICAgICBpZiAoInRvcFRvdWNoRW5kIiA9PT0gZXZlbnRUb3BMZXZlbFR5cGUgfHwgInRvcFRvdWNoQ2FuY2VsIiA9PT0gZXZlbnRUb3BMZXZlbFR5cGUpIHsKICAgICAgICB2YXIgSlNDb21waWxlcl90ZW1wID0gW107CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hhbmdlZEluZGljZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBpbmRleCA9IGNoYW5nZWRJbmRpY2VzW2ldOwogICAgICAgICAgSlNDb21waWxlcl90ZW1wLnB1c2godG91Y2hlc1tpbmRleF0pOwogICAgICAgICAgdG91Y2hlc1tpbmRleF0gPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgZm9yIChpID0gY2hhbmdlZEluZGljZXMgPSAwOyBpIDwgdG91Y2hlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaW5kZXggPSB0b3VjaGVzW2ldLCBudWxsICE9PSBpbmRleCAmJiAodG91Y2hlc1tjaGFuZ2VkSW5kaWNlcysrXSA9IGluZGV4KTsKICAgICAgICB9CgogICAgICAgIHRvdWNoZXMubGVuZ3RoID0gY2hhbmdlZEluZGljZXM7CiAgICAgIH0gZWxzZSBmb3IgKEpTQ29tcGlsZXJfdGVtcCA9IFtdLCBpID0gMDsgaSA8IGNoYW5nZWRJbmRpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgSlNDb21waWxlcl90ZW1wLnB1c2godG91Y2hlc1tjaGFuZ2VkSW5kaWNlc1tpXV0pOwogICAgICB9CgogICAgICBmb3IgKGNoYW5nZWRJbmRpY2VzID0gMDsgY2hhbmdlZEluZGljZXMgPCBKU0NvbXBpbGVyX3RlbXAubGVuZ3RoOyBjaGFuZ2VkSW5kaWNlcysrKSB7CiAgICAgICAgaSA9IEpTQ29tcGlsZXJfdGVtcFtjaGFuZ2VkSW5kaWNlc107CiAgICAgICAgaS5jaGFuZ2VkVG91Y2hlcyA9IEpTQ29tcGlsZXJfdGVtcDsKICAgICAgICBpLnRvdWNoZXMgPSB0b3VjaGVzOwogICAgICAgIGluZGV4ID0gbnVsbDsKICAgICAgICB2YXIgdGFyZ2V0ID0gaS50YXJnZXQ7CiAgICAgICAgbnVsbCA9PT0gdGFyZ2V0IHx8IHZvaWQgMCA9PT0gdGFyZ2V0IHx8IHRhcmdldCA8IFJlYWN0TmF0aXZlVGFnSGFuZGxlcy50YWdzU3RhcnRBdCB8fCAoaW5kZXggPSB0YXJnZXQpOwoKICAgICAgICBfcmVjZWl2ZVJvb3ROb2RlSURFdmVudChpbmRleCwgZXZlbnRUb3BMZXZlbFR5cGUsIGkpOwogICAgICB9CiAgICB9LAogICAgaGFuZGxlVG9wTGV2ZWw6IGhhbmRsZVRvcExldmVsCiAgfSk7CiAgUkNURXZlbnRFbWl0dGVyLnJlZ2lzdGVyKFJlYWN0TmF0aXZlRXZlbnRFbWl0dGVyKTsKICBpbmplY3Rpb24uaW5qZWN0RXZlbnRQbHVnaW5PcmRlcihbIlJlc3BvbmRlckV2ZW50UGx1Z2luIiwgIlJlYWN0TmF0aXZlQnJpZGdlRXZlbnRQbHVnaW4iXSk7CiAgZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZSA9IFJlYWN0TmF0aXZlQ29tcG9uZW50VHJlZS5nZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlOwogIGdldEluc3RhbmNlRnJvbU5vZGUgPSBSZWFjdE5hdGl2ZUNvbXBvbmVudFRyZWUuZ2V0SW5zdGFuY2VGcm9tTm9kZTsKICBnZXROb2RlRnJvbUluc3RhbmNlID0gUmVhY3ROYXRpdmVDb21wb25lbnRUcmVlLmdldE5vZGVGcm9tSW5zdGFuY2U7CiAgUmVzcG9uZGVyRXZlbnRQbHVnaW4uaW5qZWN0aW9uLmluamVjdEdsb2JhbFJlc3BvbmRlckhhbmRsZXIoewogICAgb25DaGFuZ2U6IGZ1bmN0aW9uIG9uQ2hhbmdlKGZyb20sIHRvLCBibG9ja05hdGl2ZVJlc3BvbmRlcikgewogICAgICBudWxsICE9PSB0byA/IFVJTWFuYWdlci5zZXRKU1Jlc3BvbmRlcih0by5zdGF0ZU5vZGUuX25hdGl2ZVRhZywgYmxvY2tOYXRpdmVSZXNwb25kZXIpIDogVUlNYW5hZ2VyLmNsZWFySlNSZXNwb25kZXIoKTsKICAgIH0KICB9KTsKICBpbmplY3Rpb24uaW5qZWN0RXZlbnRQbHVnaW5zQnlOYW1lKHsKICAgIFJlc3BvbmRlckV2ZW50UGx1Z2luOiBSZXNwb25kZXJFdmVudFBsdWdpbiwKICAgIFJlYWN0TmF0aXZlQnJpZGdlRXZlbnRQbHVnaW46IFJlYWN0TmF0aXZlQnJpZGdlRXZlbnRQbHVnaW4KICB9KTsKCiAgZnVuY3Rpb24gZGVmYXVsdFNob3dEaWFsb2coKSB7CiAgICByZXR1cm4gITA7CiAgfQoKICB2YXIgc2hvd0RpYWxvZyA9IGRlZmF1bHRTaG93RGlhbG9nLAogICAgICBoYXNTeW1ib2wgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgU3ltYm9sICYmIFN5bWJvbFsiZm9yIl0sCiAgICAgIFJFQUNUX0VMRU1FTlRfVFlQRSA9IGhhc1N5bWJvbCA/IFN5bWJvbFsiZm9yIl0oInJlYWN0LmVsZW1lbnQiKSA6IDYwMTAzLAogICAgICBSRUFDVF9DQUxMX1RZUEUgPSBoYXNTeW1ib2wgPyBTeW1ib2xbImZvciJdKCJyZWFjdC5jYWxsIikgOiA2MDEwNCwKICAgICAgUkVBQ1RfUkVUVVJOX1RZUEUgPSBoYXNTeW1ib2wgPyBTeW1ib2xbImZvciJdKCJyZWFjdC5yZXR1cm4iKSA6IDYwMTA1LAogICAgICBSRUFDVF9QT1JUQUxfVFlQRSA9IGhhc1N5bWJvbCA/IFN5bWJvbFsiZm9yIl0oInJlYWN0LnBvcnRhbCIpIDogNjAxMDYsCiAgICAgIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBoYXNTeW1ib2wgPyBTeW1ib2xbImZvciJdKCJyZWFjdC5mcmFnbWVudCIpIDogNjAxMDcsCiAgICAgIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBTeW1ib2wgJiYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciIpOwoKICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgIGlmIChudWxsID09PSBtYXliZUl0ZXJhYmxlIHx8ICJ1bmRlZmluZWQiID09PSB0eXBlb2YgbWF5YmVJdGVyYWJsZSkgcmV0dXJuIG51bGw7CiAgICBtYXliZUl0ZXJhYmxlID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlWyJAQGl0ZXJhdG9yIl07CiAgICByZXR1cm4gImZ1bmN0aW9uIiA9PT0gdHlwZW9mIG1heWJlSXRlcmFibGUgPyBtYXliZUl0ZXJhYmxlIDogbnVsbDsKICB9CgogIGZ1bmN0aW9uIF9jcmVhdGVQb3J0YWwoY2hpbGRyZW4sIGNvbnRhaW5lckluZm8sIGltcGxlbWVudGF0aW9uKSB7CiAgICB2YXIga2V5ID0gMyA8IGFyZ3VtZW50cy5sZW5ndGggJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbM10gPyBhcmd1bWVudHNbM10gOiBudWxsOwogICAgcmV0dXJuIHsKICAgICAgJCR0eXBlb2Y6IFJFQUNUX1BPUlRBTF9UWVBFLAogICAgICBrZXk6IG51bGwgPT0ga2V5ID8gbnVsbCA6ICIiICsga2V5LAogICAgICBjaGlsZHJlbjogY2hpbGRyZW4sCiAgICAgIGNvbnRhaW5lckluZm86IGNvbnRhaW5lckluZm8sCiAgICAgIGltcGxlbWVudGF0aW9uOiBpbXBsZW1lbnRhdGlvbgogICAgfTsKICB9CgogIHZhciBUb3VjaEhpc3RvcnlNYXRoID0gewogICAgY2VudHJvaWREaW1lbnNpb246IGZ1bmN0aW9uIGNlbnRyb2lkRGltZW5zaW9uKHRvdWNoSGlzdG9yeSwgdG91Y2hlc0NoYW5nZWRBZnRlciwgaXNYQXhpcywgb2ZDdXJyZW50KSB7CiAgICAgIHZhciB0b3VjaEJhbmsgPSB0b3VjaEhpc3RvcnkudG91Y2hCYW5rLAogICAgICAgICAgdG90YWwgPSAwLAogICAgICAgICAgY291bnQgPSAwOwogICAgICB0b3VjaEhpc3RvcnkgPSAxID09PSB0b3VjaEhpc3RvcnkubnVtYmVyQWN0aXZlVG91Y2hlcyA/IHRvdWNoSGlzdG9yeS50b3VjaEJhbmtbdG91Y2hIaXN0b3J5LmluZGV4T2ZTaW5nbGVBY3RpdmVUb3VjaF0gOiBudWxsOwogICAgICBpZiAobnVsbCAhPT0gdG91Y2hIaXN0b3J5KSB0b3VjaEhpc3RvcnkudG91Y2hBY3RpdmUgJiYgdG91Y2hIaXN0b3J5LmN1cnJlbnRUaW1lU3RhbXAgPiB0b3VjaGVzQ2hhbmdlZEFmdGVyICYmICh0b3RhbCArPSBvZkN1cnJlbnQgJiYgaXNYQXhpcyA/IHRvdWNoSGlzdG9yeS5jdXJyZW50UGFnZVggOiBvZkN1cnJlbnQgJiYgIWlzWEF4aXMgPyB0b3VjaEhpc3RvcnkuY3VycmVudFBhZ2VZIDogIW9mQ3VycmVudCAmJiBpc1hBeGlzID8gdG91Y2hIaXN0b3J5LnByZXZpb3VzUGFnZVggOiB0b3VjaEhpc3RvcnkucHJldmlvdXNQYWdlWSwgY291bnQgPSAxKTtlbHNlIGZvciAodG91Y2hIaXN0b3J5ID0gMDsgdG91Y2hIaXN0b3J5IDwgdG91Y2hCYW5rLmxlbmd0aDsgdG91Y2hIaXN0b3J5KyspIHsKICAgICAgICB2YXIgdG91Y2hUcmFjayA9IHRvdWNoQmFua1t0b3VjaEhpc3RvcnldOwogICAgICAgIG51bGwgIT09IHRvdWNoVHJhY2sgJiYgdm9pZCAwICE9PSB0b3VjaFRyYWNrICYmIHRvdWNoVHJhY2sudG91Y2hBY3RpdmUgJiYgdG91Y2hUcmFjay5jdXJyZW50VGltZVN0YW1wID49IHRvdWNoZXNDaGFuZ2VkQWZ0ZXIgJiYgKHRvdGFsICs9IG9mQ3VycmVudCAmJiBpc1hBeGlzID8gdG91Y2hUcmFjay5jdXJyZW50UGFnZVggOiBvZkN1cnJlbnQgJiYgIWlzWEF4aXMgPyB0b3VjaFRyYWNrLmN1cnJlbnRQYWdlWSA6ICFvZkN1cnJlbnQgJiYgaXNYQXhpcyA/IHRvdWNoVHJhY2sucHJldmlvdXNQYWdlWCA6IHRvdWNoVHJhY2sucHJldmlvdXNQYWdlWSwgY291bnQrKyk7CiAgICAgIH0KICAgICAgcmV0dXJuIDAgPCBjb3VudCA/IHRvdGFsIC8gY291bnQgOiBUb3VjaEhpc3RvcnlNYXRoLm5vQ2VudHJvaWQ7CiAgICB9LAogICAgY3VycmVudENlbnRyb2lkWE9mVG91Y2hlc0NoYW5nZWRBZnRlcjogZnVuY3Rpb24gY3VycmVudENlbnRyb2lkWE9mVG91Y2hlc0NoYW5nZWRBZnRlcih0b3VjaEhpc3RvcnksIHRvdWNoZXNDaGFuZ2VkQWZ0ZXIpIHsKICAgICAgcmV0dXJuIFRvdWNoSGlzdG9yeU1hdGguY2VudHJvaWREaW1lbnNpb24odG91Y2hIaXN0b3J5LCB0b3VjaGVzQ2hhbmdlZEFmdGVyLCAhMCwgITApOwogICAgfSwKICAgIGN1cnJlbnRDZW50cm9pZFlPZlRvdWNoZXNDaGFuZ2VkQWZ0ZXI6IGZ1bmN0aW9uIGN1cnJlbnRDZW50cm9pZFlPZlRvdWNoZXNDaGFuZ2VkQWZ0ZXIodG91Y2hIaXN0b3J5LCB0b3VjaGVzQ2hhbmdlZEFmdGVyKSB7CiAgICAgIHJldHVybiBUb3VjaEhpc3RvcnlNYXRoLmNlbnRyb2lkRGltZW5zaW9uKHRvdWNoSGlzdG9yeSwgdG91Y2hlc0NoYW5nZWRBZnRlciwgITEsICEwKTsKICAgIH0sCiAgICBwcmV2aW91c0NlbnRyb2lkWE9mVG91Y2hlc0NoYW5nZWRBZnRlcjogZnVuY3Rpb24gcHJldmlvdXNDZW50cm9pZFhPZlRvdWNoZXNDaGFuZ2VkQWZ0ZXIodG91Y2hIaXN0b3J5LCB0b3VjaGVzQ2hhbmdlZEFmdGVyKSB7CiAgICAgIHJldHVybiBUb3VjaEhpc3RvcnlNYXRoLmNlbnRyb2lkRGltZW5zaW9uKHRvdWNoSGlzdG9yeSwgdG91Y2hlc0NoYW5nZWRBZnRlciwgITAsICExKTsKICAgIH0sCiAgICBwcmV2aW91c0NlbnRyb2lkWU9mVG91Y2hlc0NoYW5nZWRBZnRlcjogZnVuY3Rpb24gcHJldmlvdXNDZW50cm9pZFlPZlRvdWNoZXNDaGFuZ2VkQWZ0ZXIodG91Y2hIaXN0b3J5LCB0b3VjaGVzQ2hhbmdlZEFmdGVyKSB7CiAgICAgIHJldHVybiBUb3VjaEhpc3RvcnlNYXRoLmNlbnRyb2lkRGltZW5zaW9uKHRvdWNoSGlzdG9yeSwgdG91Y2hlc0NoYW5nZWRBZnRlciwgITEsICExKTsKICAgIH0sCiAgICBjdXJyZW50Q2VudHJvaWRYOiBmdW5jdGlvbiBjdXJyZW50Q2VudHJvaWRYKHRvdWNoSGlzdG9yeSkgewogICAgICByZXR1cm4gVG91Y2hIaXN0b3J5TWF0aC5jZW50cm9pZERpbWVuc2lvbih0b3VjaEhpc3RvcnksIDAsICEwLCAhMCk7CiAgICB9LAogICAgY3VycmVudENlbnRyb2lkWTogZnVuY3Rpb24gY3VycmVudENlbnRyb2lkWSh0b3VjaEhpc3RvcnkpIHsKICAgICAgcmV0dXJuIFRvdWNoSGlzdG9yeU1hdGguY2VudHJvaWREaW1lbnNpb24odG91Y2hIaXN0b3J5LCAwLCAhMSwgITApOwogICAgfSwKICAgIG5vQ2VudHJvaWQ6IC0xCiAgfSwKICAgICAgUmVhY3RDdXJyZW50T3duZXIgPSBSZWFjdC5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRC5SZWFjdEN1cnJlbnRPd25lciwKICAgICAgUmVhY3RHbG9iYWxTaGFyZWRTdGF0ZSA9IE9iamVjdC5mcmVlemUoewogICAgUmVhY3RDdXJyZW50T3duZXI6IFJlYWN0Q3VycmVudE93bmVyLAogICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTogbnVsbAogIH0pLAogICAgICBvYmplY3RzID0ge30sCiAgICAgIHVuaXF1ZUlEID0gMSwKICAgICAgZW1wdHlPYmplY3QkMiA9IHt9LAogICAgICBSZWFjdE5hdGl2ZVByb3BSZWdpc3RyeSA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFJlYWN0TmF0aXZlUHJvcFJlZ2lzdHJ5KCkgewogICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnkpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsKICAgIH0KCiAgICBSZWFjdE5hdGl2ZVByb3BSZWdpc3RyeS5yZWdpc3RlciA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgdmFyIGlkID0gKyt1bmlxdWVJRDsKICAgICAgb2JqZWN0c1tpZF0gPSBvYmplY3Q7CiAgICAgIHJldHVybiBpZDsKICAgIH07CgogICAgUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnkuZ2V0QnlJRCA9IGZ1bmN0aW9uIChpZCkgewogICAgICBpZiAoIWlkKSByZXR1cm4gZW1wdHlPYmplY3QkMjsKICAgICAgdmFyIG9iamVjdCA9IG9iamVjdHNbaWRdOwogICAgICByZXR1cm4gb2JqZWN0ID8gb2JqZWN0IDogKGNvbnNvbGUud2FybigiSW52YWxpZCBzdHlsZSB3aXRoIGlkIGAiICsgaWQgKyAiYC4gU2tpcHBpbmcgLi4uIiksIGVtcHR5T2JqZWN0JDIpOwogICAgfTsKCiAgICByZXR1cm4gUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnk7CiAgfSgpLAogICAgICBlbXB0eU9iamVjdCQxID0ge30sCiAgICAgIHJlbW92ZWRLZXlzID0gbnVsbCwKICAgICAgcmVtb3ZlZEtleUNvdW50ID0gMDsKCiAgZnVuY3Rpb24gcmVzb2x2ZU9iamVjdChpZE9yT2JqZWN0KSB7CiAgICByZXR1cm4gIm51bWJlciIgPT09IHR5cGVvZiBpZE9yT2JqZWN0ID8gUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnkuZ2V0QnlJRChpZE9yT2JqZWN0KSA6IGlkT3JPYmplY3Q7CiAgfQoKICBmdW5jdGlvbiByZXN0b3JlRGVsZXRlZFZhbHVlc0luTmVzdGVkQXJyYXkodXBkYXRlUGF5bG9hZCwgbm9kZSwgdmFsaWRBdHRyaWJ1dGVzKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShub2RlKSkgZm9yICh2YXIgaSA9IG5vZGUubGVuZ3RoOyBpLS0gJiYgMCA8IHJlbW92ZWRLZXlDb3VudDspIHsKICAgICAgcmVzdG9yZURlbGV0ZWRWYWx1ZXNJbk5lc3RlZEFycmF5KHVwZGF0ZVBheWxvYWQsIG5vZGVbaV0sIHZhbGlkQXR0cmlidXRlcyk7CiAgICB9IGVsc2UgaWYgKG5vZGUgJiYgMCA8IHJlbW92ZWRLZXlDb3VudCkgZm9yIChpIGluIG5vZGUgPSByZXNvbHZlT2JqZWN0KG5vZGUpLCByZW1vdmVkS2V5cykgewogICAgICBpZiAocmVtb3ZlZEtleXNbaV0pIHsKICAgICAgICB2YXIgbmV4dFByb3AgPSBub2RlW2ldOwoKICAgICAgICBpZiAodm9pZCAwICE9PSBuZXh0UHJvcCkgewogICAgICAgICAgdmFyIGF0dHJpYnV0ZUNvbmZpZyA9IHZhbGlkQXR0cmlidXRlc1tpXTsKCiAgICAgICAgICBpZiAoYXR0cmlidXRlQ29uZmlnKSB7CiAgICAgICAgICAgICJmdW5jdGlvbiIgPT09IHR5cGVvZiBuZXh0UHJvcCAmJiAobmV4dFByb3AgPSAhMCk7CiAgICAgICAgICAgICJ1bmRlZmluZWQiID09PSB0eXBlb2YgbmV4dFByb3AgJiYgKG5leHRQcm9wID0gbnVsbCk7CiAgICAgICAgICAgIGlmICgib2JqZWN0IiAhPT0gdHlwZW9mIGF0dHJpYnV0ZUNvbmZpZykgdXBkYXRlUGF5bG9hZFtpXSA9IG5leHRQcm9wO2Vsc2UgaWYgKCJmdW5jdGlvbiIgPT09IHR5cGVvZiBhdHRyaWJ1dGVDb25maWcuZGlmZiB8fCAiZnVuY3Rpb24iID09PSB0eXBlb2YgYXR0cmlidXRlQ29uZmlnLnByb2Nlc3MpIG5leHRQcm9wID0gImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGF0dHJpYnV0ZUNvbmZpZy5wcm9jZXNzID8gYXR0cmlidXRlQ29uZmlnLnByb2Nlc3MobmV4dFByb3ApIDogbmV4dFByb3AsIHVwZGF0ZVBheWxvYWRbaV0gPSBuZXh0UHJvcDsKICAgICAgICAgICAgcmVtb3ZlZEtleXNbaV0gPSAhMTsKICAgICAgICAgICAgcmVtb3ZlZEtleUNvdW50LS07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkaWZmTmVzdGVkUHJvcGVydHkodXBkYXRlUGF5bG9hZCwgcHJldlByb3AsIG5leHRQcm9wLCB2YWxpZEF0dHJpYnV0ZXMpIHsKICAgIGlmICghdXBkYXRlUGF5bG9hZCAmJiBwcmV2UHJvcCA9PT0gbmV4dFByb3ApIHJldHVybiB1cGRhdGVQYXlsb2FkOwogICAgaWYgKCFwcmV2UHJvcCB8fCAhbmV4dFByb3ApIHJldHVybiBuZXh0UHJvcCA/IGFkZE5lc3RlZFByb3BlcnR5KHVwZGF0ZVBheWxvYWQsIG5leHRQcm9wLCB2YWxpZEF0dHJpYnV0ZXMpIDogcHJldlByb3AgPyBjbGVhck5lc3RlZFByb3BlcnR5KHVwZGF0ZVBheWxvYWQsIHByZXZQcm9wLCB2YWxpZEF0dHJpYnV0ZXMpIDogdXBkYXRlUGF5bG9hZDsKICAgIGlmICghQXJyYXkuaXNBcnJheShwcmV2UHJvcCkgJiYgIUFycmF5LmlzQXJyYXkobmV4dFByb3ApKSByZXR1cm4gZGlmZlByb3BlcnRpZXModXBkYXRlUGF5bG9hZCwgcmVzb2x2ZU9iamVjdChwcmV2UHJvcCksIHJlc29sdmVPYmplY3QobmV4dFByb3ApLCB2YWxpZEF0dHJpYnV0ZXMpOwoKICAgIGlmIChBcnJheS5pc0FycmF5KHByZXZQcm9wKSAmJiBBcnJheS5pc0FycmF5KG5leHRQcm9wKSkgewogICAgICB2YXIgbWluTGVuZ3RoID0gcHJldlByb3AubGVuZ3RoIDwgbmV4dFByb3AubGVuZ3RoID8gcHJldlByb3AubGVuZ3RoIDogbmV4dFByb3AubGVuZ3RoLAogICAgICAgICAgaTsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBtaW5MZW5ndGg7IGkrKykgewogICAgICAgIHVwZGF0ZVBheWxvYWQgPSBkaWZmTmVzdGVkUHJvcGVydHkodXBkYXRlUGF5bG9hZCwgcHJldlByb3BbaV0sIG5leHRQcm9wW2ldLCB2YWxpZEF0dHJpYnV0ZXMpOwogICAgICB9CgogICAgICBmb3IgKDsgaSA8IHByZXZQcm9wLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdXBkYXRlUGF5bG9hZCA9IGNsZWFyTmVzdGVkUHJvcGVydHkodXBkYXRlUGF5bG9hZCwgcHJldlByb3BbaV0sIHZhbGlkQXR0cmlidXRlcyk7CiAgICAgIH0KCiAgICAgIGZvciAoOyBpIDwgbmV4dFByb3AubGVuZ3RoOyBpKyspIHsKICAgICAgICB1cGRhdGVQYXlsb2FkID0gYWRkTmVzdGVkUHJvcGVydHkodXBkYXRlUGF5bG9hZCwgbmV4dFByb3BbaV0sIHZhbGlkQXR0cmlidXRlcyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB1cGRhdGVQYXlsb2FkOwogICAgfQoKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHByZXZQcm9wKSA/IGRpZmZQcm9wZXJ0aWVzKHVwZGF0ZVBheWxvYWQsIGZsYXR0ZW5TdHlsZShwcmV2UHJvcCksIHJlc29sdmVPYmplY3QobmV4dFByb3ApLCB2YWxpZEF0dHJpYnV0ZXMpIDogZGlmZlByb3BlcnRpZXModXBkYXRlUGF5bG9hZCwgcmVzb2x2ZU9iamVjdChwcmV2UHJvcCksIGZsYXR0ZW5TdHlsZShuZXh0UHJvcCksIHZhbGlkQXR0cmlidXRlcyk7CiAgfQoKICBmdW5jdGlvbiBhZGROZXN0ZWRQcm9wZXJ0eSh1cGRhdGVQYXlsb2FkLCBuZXh0UHJvcCwgdmFsaWRBdHRyaWJ1dGVzKSB7CiAgICBpZiAoIW5leHRQcm9wKSByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICAgIGlmICghQXJyYXkuaXNBcnJheShuZXh0UHJvcCkpIHJldHVybiBuZXh0UHJvcCA9IHJlc29sdmVPYmplY3QobmV4dFByb3ApLCBkaWZmUHJvcGVydGllcyh1cGRhdGVQYXlsb2FkLCBlbXB0eU9iamVjdCQxLCBuZXh0UHJvcCwgdmFsaWRBdHRyaWJ1dGVzKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5leHRQcm9wLmxlbmd0aDsgaSsrKSB7CiAgICAgIHVwZGF0ZVBheWxvYWQgPSBhZGROZXN0ZWRQcm9wZXJ0eSh1cGRhdGVQYXlsb2FkLCBuZXh0UHJvcFtpXSwgdmFsaWRBdHRyaWJ1dGVzKTsKICAgIH0KCiAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICB9CgogIGZ1bmN0aW9uIGNsZWFyTmVzdGVkUHJvcGVydHkodXBkYXRlUGF5bG9hZCwgcHJldlByb3AsIHZhbGlkQXR0cmlidXRlcykgewogICAgaWYgKCFwcmV2UHJvcCkgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkocHJldlByb3ApKSByZXR1cm4gcHJldlByb3AgPSByZXNvbHZlT2JqZWN0KHByZXZQcm9wKSwgZGlmZlByb3BlcnRpZXModXBkYXRlUGF5bG9hZCwgcHJldlByb3AsIGVtcHR5T2JqZWN0JDEsIHZhbGlkQXR0cmlidXRlcyk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmV2UHJvcC5sZW5ndGg7IGkrKykgewogICAgICB1cGRhdGVQYXlsb2FkID0gY2xlYXJOZXN0ZWRQcm9wZXJ0eSh1cGRhdGVQYXlsb2FkLCBwcmV2UHJvcFtpXSwgdmFsaWRBdHRyaWJ1dGVzKTsKICAgIH0KCiAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICB9CgogIGZ1bmN0aW9uIGRpZmZQcm9wZXJ0aWVzKHVwZGF0ZVBheWxvYWQsIHByZXZQcm9wcywgbmV4dFByb3BzLCB2YWxpZEF0dHJpYnV0ZXMpIHsKICAgIHZhciBhdHRyaWJ1dGVDb25maWcsIHByb3BLZXk7CgogICAgZm9yIChwcm9wS2V5IGluIG5leHRQcm9wcykgewogICAgICBpZiAoYXR0cmlidXRlQ29uZmlnID0gdmFsaWRBdHRyaWJ1dGVzW3Byb3BLZXldKSB7CiAgICAgICAgdmFyIHByZXZQcm9wID0gcHJldlByb3BzW3Byb3BLZXldOwogICAgICAgIHZhciBuZXh0UHJvcCA9IG5leHRQcm9wc1twcm9wS2V5XTsKICAgICAgICAiZnVuY3Rpb24iID09PSB0eXBlb2YgbmV4dFByb3AgJiYgKG5leHRQcm9wID0gITAsICJmdW5jdGlvbiIgPT09IHR5cGVvZiBwcmV2UHJvcCAmJiAocHJldlByb3AgPSAhMCkpOwogICAgICAgICJ1bmRlZmluZWQiID09PSB0eXBlb2YgbmV4dFByb3AgJiYgKG5leHRQcm9wID0gbnVsbCwgInVuZGVmaW5lZCIgPT09IHR5cGVvZiBwcmV2UHJvcCAmJiAocHJldlByb3AgPSBudWxsKSk7CiAgICAgICAgcmVtb3ZlZEtleXMgJiYgKHJlbW92ZWRLZXlzW3Byb3BLZXldID0gITEpOwogICAgICAgIGlmICh1cGRhdGVQYXlsb2FkICYmIHZvaWQgMCAhPT0gdXBkYXRlUGF5bG9hZFtwcm9wS2V5XSkgewogICAgICAgICAgaWYgKCJvYmplY3QiICE9PSB0eXBlb2YgYXR0cmlidXRlQ29uZmlnKSB1cGRhdGVQYXlsb2FkW3Byb3BLZXldID0gbmV4dFByb3A7ZWxzZSB7CiAgICAgICAgICAgIGlmICgiZnVuY3Rpb24iID09PSB0eXBlb2YgYXR0cmlidXRlQ29uZmlnLmRpZmYgfHwgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGF0dHJpYnV0ZUNvbmZpZy5wcm9jZXNzKSBhdHRyaWJ1dGVDb25maWcgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgYXR0cmlidXRlQ29uZmlnLnByb2Nlc3MgPyBhdHRyaWJ1dGVDb25maWcucHJvY2VzcyhuZXh0UHJvcCkgOiBuZXh0UHJvcCwgdXBkYXRlUGF5bG9hZFtwcm9wS2V5XSA9IGF0dHJpYnV0ZUNvbmZpZzsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHByZXZQcm9wICE9PSBuZXh0UHJvcCkgaWYgKCJvYmplY3QiICE9PSB0eXBlb2YgYXR0cmlidXRlQ29uZmlnKSAoIm9iamVjdCIgIT09IHR5cGVvZiBuZXh0UHJvcCB8fCBudWxsID09PSBuZXh0UHJvcCB8fCBkZWVwRGlmZmVyKHByZXZQcm9wLCBuZXh0UHJvcCkpICYmICgodXBkYXRlUGF5bG9hZCB8fCAodXBkYXRlUGF5bG9hZCA9IHt9KSlbcHJvcEtleV0gPSBuZXh0UHJvcCk7ZWxzZSBpZiAoImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGF0dHJpYnV0ZUNvbmZpZy5kaWZmIHx8ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBhdHRyaWJ1dGVDb25maWcucHJvY2VzcykgewogICAgICAgICAgaWYgKHZvaWQgMCA9PT0gcHJldlByb3AgfHwgKCJmdW5jdGlvbiIgPT09IHR5cGVvZiBhdHRyaWJ1dGVDb25maWcuZGlmZiA/IGF0dHJpYnV0ZUNvbmZpZy5kaWZmKHByZXZQcm9wLCBuZXh0UHJvcCkgOiAib2JqZWN0IiAhPT0gdHlwZW9mIG5leHRQcm9wIHx8IG51bGwgPT09IG5leHRQcm9wIHx8IGRlZXBEaWZmZXIocHJldlByb3AsIG5leHRQcm9wKSkpIGF0dHJpYnV0ZUNvbmZpZyA9ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBhdHRyaWJ1dGVDb25maWcucHJvY2VzcyA/IGF0dHJpYnV0ZUNvbmZpZy5wcm9jZXNzKG5leHRQcm9wKSA6IG5leHRQcm9wLCAodXBkYXRlUGF5bG9hZCB8fCAodXBkYXRlUGF5bG9hZCA9IHt9KSlbcHJvcEtleV0gPSBhdHRyaWJ1dGVDb25maWc7CiAgICAgICAgfSBlbHNlIHJlbW92ZWRLZXlzID0gbnVsbCwgcmVtb3ZlZEtleUNvdW50ID0gMCwgdXBkYXRlUGF5bG9hZCA9IGRpZmZOZXN0ZWRQcm9wZXJ0eSh1cGRhdGVQYXlsb2FkLCBwcmV2UHJvcCwgbmV4dFByb3AsIGF0dHJpYnV0ZUNvbmZpZyksIDAgPCByZW1vdmVkS2V5Q291bnQgJiYgdXBkYXRlUGF5bG9hZCAmJiAocmVzdG9yZURlbGV0ZWRWYWx1ZXNJbk5lc3RlZEFycmF5KHVwZGF0ZVBheWxvYWQsIG5leHRQcm9wLCBhdHRyaWJ1dGVDb25maWcpLCByZW1vdmVkS2V5cyA9IG51bGwpOwogICAgICB9CiAgICB9CgogICAgZm9yIChwcm9wS2V5IGluIHByZXZQcm9wcykgewogICAgICB2b2lkIDAgPT09IG5leHRQcm9wc1twcm9wS2V5XSAmJiAoIShhdHRyaWJ1dGVDb25maWcgPSB2YWxpZEF0dHJpYnV0ZXNbcHJvcEtleV0pIHx8IHVwZGF0ZVBheWxvYWQgJiYgdm9pZCAwICE9PSB1cGRhdGVQYXlsb2FkW3Byb3BLZXldIHx8IChwcmV2UHJvcCA9IHByZXZQcm9wc1twcm9wS2V5XSwgdm9pZCAwICE9PSBwcmV2UHJvcCAmJiAoIm9iamVjdCIgIT09IHR5cGVvZiBhdHRyaWJ1dGVDb25maWcgfHwgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGF0dHJpYnV0ZUNvbmZpZy5kaWZmIHx8ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBhdHRyaWJ1dGVDb25maWcucHJvY2VzcyA/ICgodXBkYXRlUGF5bG9hZCB8fCAodXBkYXRlUGF5bG9hZCA9IHt9KSlbcHJvcEtleV0gPSBudWxsLCByZW1vdmVkS2V5cyB8fCAocmVtb3ZlZEtleXMgPSB7fSksIHJlbW92ZWRLZXlzW3Byb3BLZXldIHx8IChyZW1vdmVkS2V5c1twcm9wS2V5XSA9ICEwLCByZW1vdmVkS2V5Q291bnQrKykpIDogdXBkYXRlUGF5bG9hZCA9IGNsZWFyTmVzdGVkUHJvcGVydHkodXBkYXRlUGF5bG9hZCwgcHJldlByb3AsIGF0dHJpYnV0ZUNvbmZpZykpKSk7CiAgICB9CgogICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgfQoKICBmdW5jdGlvbiBtb3VudFNhZmVDYWxsYmFjayhjb250ZXh0LCBjYWxsYmFjaykgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKCJib29sZWFuIiA9PT0gdHlwZW9mIGNvbnRleHQuX19pc01vdW50ZWQpIHsKICAgICAgICAgIGlmICghY29udGV4dC5fX2lzTW91bnRlZCkgcmV0dXJuOwogICAgICAgIH0gZWxzZSBpZiAoImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGNvbnRleHQuaXNNb3VudGVkICYmICFjb250ZXh0LmlzTW91bnRlZCgpKSByZXR1cm47CgogICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZShmaWJlcikgewogICAgZmliZXIgPSBmaWJlci50eXBlOwogICAgcmV0dXJuICJzdHJpbmciID09PSB0eXBlb2YgZmliZXIgPyBmaWJlciA6ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBmaWJlciA/IGZpYmVyLmRpc3BsYXlOYW1lIHx8IGZpYmVyLm5hbWUgOiBudWxsOwogIH0KCiAgdmFyIGRlYnVnUmVuZGVyUGhhc2VTaWRlRWZmZWN0cyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTJdLCAiUmVhY3RGZWF0dXJlRmxhZ3MiKS5kZWJ1Z1JlbmRlclBoYXNlU2lkZUVmZmVjdHM7CgogIGZ1bmN0aW9uIGlzRmliZXJNb3VudGVkSW1wbChmaWJlcikgewogICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIGZvciAoOyBub2RlWyJyZXR1cm4iXTspIHsKICAgICAgbm9kZSA9IG5vZGVbInJldHVybiJdOwogICAgfSBlbHNlIHsKICAgICAgaWYgKDAgIT09IChub2RlLmVmZmVjdFRhZyAmIDIpKSByZXR1cm4gMTsKCiAgICAgIGZvciAoOyBub2RlWyJyZXR1cm4iXTspIHsKICAgICAgICBpZiAobm9kZSA9IG5vZGVbInJldHVybiJdLCAwICE9PSAobm9kZS5lZmZlY3RUYWcgJiAyKSkgcmV0dXJuIDE7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAzID09PSBub2RlLnRhZyA/IDIgOiAzOwogIH0KCiAgZnVuY3Rpb24gaXNNb3VudGVkKGNvbXBvbmVudCkgewogICAgcmV0dXJuIChjb21wb25lbnQgPSBjb21wb25lbnQuX3JlYWN0SW50ZXJuYWxGaWJlcikgPyAyID09PSBpc0ZpYmVyTW91bnRlZEltcGwoY29tcG9uZW50KSA6ICExOwogIH0KCiAgZnVuY3Rpb24gYXNzZXJ0SXNNb3VudGVkKGZpYmVyKSB7CiAgICBpbnZhcmlhbnQoMiA9PT0gaXNGaWJlck1vdW50ZWRJbXBsKGZpYmVyKSwgIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICB9CgogIGZ1bmN0aW9uIGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKGZpYmVyKSB7CiAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgaWYgKCFhbHRlcm5hdGUpIHJldHVybiBhbHRlcm5hdGUgPSBpc0ZpYmVyTW91bnRlZEltcGwoZmliZXIpLCBpbnZhcmlhbnQoMyAhPT0gYWx0ZXJuYXRlLCAiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpLCAxID09PSBhbHRlcm5hdGUgPyBudWxsIDogZmliZXI7CgogICAgZm9yICh2YXIgYSA9IGZpYmVyLCBiID0gYWx0ZXJuYXRlOzspIHsKICAgICAgdmFyIHBhcmVudEEgPSBhWyJyZXR1cm4iXSwKICAgICAgICAgIHBhcmVudEIgPSBwYXJlbnRBID8gcGFyZW50QS5hbHRlcm5hdGUgOiBudWxsOwogICAgICBpZiAoIXBhcmVudEEgfHwgIXBhcmVudEIpIGJyZWFrOwoKICAgICAgaWYgKHBhcmVudEEuY2hpbGQgPT09IHBhcmVudEIuY2hpbGQpIHsKICAgICAgICBmb3IgKHZhciBjaGlsZCA9IHBhcmVudEEuY2hpbGQ7IGNoaWxkOykgewogICAgICAgICAgaWYgKGNoaWxkID09PSBhKSByZXR1cm4gYXNzZXJ0SXNNb3VudGVkKHBhcmVudEEpLCBmaWJlcjsKICAgICAgICAgIGlmIChjaGlsZCA9PT0gYikgcmV0dXJuIGFzc2VydElzTW91bnRlZChwYXJlbnRBKSwgYWx0ZXJuYXRlOwogICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgIH0KCiAgICAgICAgaW52YXJpYW50KCExLCAiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICB9CgogICAgICBpZiAoYVsicmV0dXJuIl0gIT09IGJbInJldHVybiJdKSBhID0gcGFyZW50QSwgYiA9IHBhcmVudEI7ZWxzZSB7CiAgICAgICAgY2hpbGQgPSAhMTsKCiAgICAgICAgZm9yICh2YXIgX2NoaWxkID0gcGFyZW50QS5jaGlsZDsgX2NoaWxkOykgewogICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYSkgewogICAgICAgICAgICBjaGlsZCA9ICEwOwogICAgICAgICAgICBhID0gcGFyZW50QTsKICAgICAgICAgICAgYiA9IHBhcmVudEI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgY2hpbGQgPSAhMDsKICAgICAgICAgICAgYiA9IHBhcmVudEE7CiAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICBfY2hpbGQgPSBfY2hpbGQuc2libGluZzsKICAgICAgICB9CgogICAgICAgIGlmICghY2hpbGQpIHsKICAgICAgICAgIGZvciAoX2NoaWxkID0gcGFyZW50Qi5jaGlsZDsgX2NoaWxkOykgewogICAgICAgICAgICBpZiAoX2NoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgY2hpbGQgPSAhMDsKICAgICAgICAgICAgICBhID0gcGFyZW50QjsKICAgICAgICAgICAgICBiID0gcGFyZW50QTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9jaGlsZCA9PT0gYikgewogICAgICAgICAgICAgIGNoaWxkID0gITA7CiAgICAgICAgICAgICAgYiA9IHBhcmVudEI7CiAgICAgICAgICAgICAgYSA9IHBhcmVudEE7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQoKICAgICAgICAgIGludmFyaWFudChjaGlsZCwgIkNoaWxkIHdhcyBub3QgZm91bmQgaW4gZWl0aGVyIHBhcmVudCBzZXQuIFRoaXMgaW5kaWNhdGVzIGEgYnVnIGluIFJlYWN0IHJlbGF0ZWQgdG8gdGhlIHJldHVybiBwb2ludGVyLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaW52YXJpYW50KGEuYWx0ZXJuYXRlID09PSBiLCAiUmV0dXJuIGZpYmVycyBzaG91bGQgYWx3YXlzIGJlIGVhY2ggb3RoZXJzJyBhbHRlcm5hdGVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgfQoKICAgIGludmFyaWFudCgzID09PSBhLnRhZywgIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgIHJldHVybiBhLnN0YXRlTm9kZS5jdXJyZW50ID09PSBhID8gZmliZXIgOiBhbHRlcm5hdGU7CiAgfQoKICBmdW5jdGlvbiBmaW5kQ3VycmVudEhvc3RGaWJlcihwYXJlbnQpIHsKICAgIHBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CiAgICBpZiAoIXBhcmVudCkgcmV0dXJuIG51bGw7CgogICAgZm9yICh2YXIgbm9kZSA9IHBhcmVudDs7KSB7CiAgICAgIGlmICg1ID09PSBub2RlLnRhZyB8fCA2ID09PSBub2RlLnRhZykgcmV0dXJuIG5vZGU7CiAgICAgIGlmIChub2RlLmNoaWxkKSBub2RlLmNoaWxkWyJyZXR1cm4iXSA9IG5vZGUsIG5vZGUgPSBub2RlLmNoaWxkO2Vsc2UgewogICAgICAgIGlmIChub2RlID09PSBwYXJlbnQpIGJyZWFrOwoKICAgICAgICBmb3IgKDsgIW5vZGUuc2libGluZzspIHsKICAgICAgICAgIGlmICghbm9kZVsicmV0dXJuIl0gfHwgbm9kZVsicmV0dXJuIl0gPT09IHBhcmVudCkgcmV0dXJuIG51bGw7CiAgICAgICAgICBub2RlID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgfQoKICAgICAgICBub2RlLnNpYmxpbmdbInJldHVybiJdID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsOwogIH0KCiAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzKHBhcmVudCkgewogICAgcGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgIGlmICghcGFyZW50KSByZXR1cm4gbnVsbDsKCiAgICBmb3IgKHZhciBub2RlID0gcGFyZW50OzspIHsKICAgICAgaWYgKDUgPT09IG5vZGUudGFnIHx8IDYgPT09IG5vZGUudGFnKSByZXR1cm4gbm9kZTsKICAgICAgaWYgKG5vZGUuY2hpbGQgJiYgNCAhPT0gbm9kZS50YWcpIG5vZGUuY2hpbGRbInJldHVybiJdID0gbm9kZSwgbm9kZSA9IG5vZGUuY2hpbGQ7ZWxzZSB7CiAgICAgICAgaWYgKG5vZGUgPT09IHBhcmVudCkgYnJlYWs7CgogICAgICAgIGZvciAoOyAhbm9kZS5zaWJsaW5nOykgewogICAgICAgICAgaWYgKCFub2RlWyJyZXR1cm4iXSB8fCBub2RlWyJyZXR1cm4iXSA9PT0gcGFyZW50KSByZXR1cm4gbnVsbDsKICAgICAgICAgIG5vZGUgPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICB9CgogICAgICAgIG5vZGUuc2libGluZ1sicmV0dXJuIl0gPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfQoKICB2YXIgdmFsdWVTdGFjayA9IFtdLAogICAgICBpbmRleCA9IC0xOwoKICBmdW5jdGlvbiBwb3AoY3Vyc29yKSB7CiAgICAwID4gaW5kZXggfHwgKGN1cnNvci5jdXJyZW50ID0gdmFsdWVTdGFja1tpbmRleF0sIHZhbHVlU3RhY2tbaW5kZXhdID0gbnVsbCwgaW5kZXgtLSk7CiAgfQoKICBmdW5jdGlvbiBwdXNoKGN1cnNvciwgdmFsdWUpIHsKICAgIGluZGV4Kys7CiAgICB2YWx1ZVN0YWNrW2luZGV4XSA9IGN1cnNvci5jdXJyZW50OwogICAgY3Vyc29yLmN1cnJlbnQgPSB2YWx1ZTsKICB9CgogIG5ldyBTZXQoKTsKICB2YXIgY29udGV4dFN0YWNrQ3Vyc29yID0gewogICAgY3VycmVudDogZW1wdHlPYmplY3QKICB9LAogICAgICBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yID0gewogICAgY3VycmVudDogITEKICB9LAogICAgICBwcmV2aW91c0NvbnRleHQgPSBlbXB0eU9iamVjdDsKCiAgZnVuY3Rpb24gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzKSB7CiAgICByZXR1cm4gaXNDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MpID8gcHJldmlvdXNDb250ZXh0IDogY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgfQoKICBmdW5jdGlvbiBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzLCB1bm1hc2tlZENvbnRleHQpIHsKICAgIHZhciBjb250ZXh0VHlwZXMgPSB3b3JrSW5Qcm9ncmVzcy50eXBlLmNvbnRleHRUeXBlczsKICAgIGlmICghY29udGV4dFR5cGVzKSByZXR1cm4gZW1wdHlPYmplY3Q7CiAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGU7CiAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRVbm1hc2tlZENoaWxkQ29udGV4dCA9PT0gdW5tYXNrZWRDb250ZXh0KSByZXR1cm4gaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNYXNrZWRDaGlsZENvbnRleHQ7CiAgICB2YXIgY29udGV4dCA9IHt9LAogICAgICAgIGtleTsKCiAgICBmb3IgKGtleSBpbiBjb250ZXh0VHlwZXMpIHsKICAgICAgY29udGV4dFtrZXldID0gdW5tYXNrZWRDb250ZXh0W2tleV07CiAgICB9CgogICAgaW5zdGFuY2UgJiYgKHdvcmtJblByb2dyZXNzID0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlLCB3b3JrSW5Qcm9ncmVzcy5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZFVubWFza2VkQ2hpbGRDb250ZXh0ID0gdW5tYXNrZWRDb250ZXh0LCB3b3JrSW5Qcm9ncmVzcy5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1hc2tlZENoaWxkQ29udGV4dCA9IGNvbnRleHQpOwogICAgcmV0dXJuIGNvbnRleHQ7CiAgfQoKICBmdW5jdGlvbiBpc0NvbnRleHRQcm92aWRlcihmaWJlcikgewogICAgcmV0dXJuIDIgPT09IGZpYmVyLnRhZyAmJiBudWxsICE9IGZpYmVyLnR5cGUuY2hpbGRDb250ZXh0VHlwZXM7CiAgfQoKICBmdW5jdGlvbiBwb3BDb250ZXh0UHJvdmlkZXIoZmliZXIpIHsKICAgIGlzQ29udGV4dFByb3ZpZGVyKGZpYmVyKSAmJiAocG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGZpYmVyKSwgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgZmliZXIpKTsKICB9CgogIGZ1bmN0aW9uIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIsIGNvbnRleHQsIGRpZENoYW5nZSkgewogICAgaW52YXJpYW50KG51bGwgPT0gY29udGV4dFN0YWNrQ3Vyc29yLmN1cnNvciwgIlVuZXhwZWN0ZWQgY29udGV4dCBmb3VuZCBvbiBzdGFjay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBjb250ZXh0LCBmaWJlcik7CiAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgZmliZXIpOwogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc0NoaWxkQ29udGV4dChmaWJlciwgcGFyZW50Q29udGV4dCkgewogICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlLAogICAgICAgIGNoaWxkQ29udGV4dFR5cGVzID0gZmliZXIudHlwZS5jaGlsZENvbnRleHRUeXBlczsKICAgIGlmICgiZnVuY3Rpb24iICE9PSB0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0KSByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgIGluc3RhbmNlID0gaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0KCk7CgogICAgZm9yICh2YXIgY29udGV4dEtleSBpbiBpbnN0YW5jZSkgewogICAgICBpbnZhcmlhbnQoY29udGV4dEtleSBpbiBjaGlsZENvbnRleHRUeXBlcywgJyVzLmdldENoaWxkQ29udGV4dCgpOiBrZXkgIiVzIiBpcyBub3QgZGVmaW5lZCBpbiBjaGlsZENvbnRleHRUeXBlcy4nLCBnZXRDb21wb25lbnROYW1lKGZpYmVyKSB8fCAiVW5rbm93biIsIGNvbnRleHRLZXkpOwogICAgfQoKICAgIHJldHVybiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgcGFyZW50Q29udGV4dCwgaW5zdGFuY2UpOwogIH0KCiAgZnVuY3Rpb24gcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzcykgewogICAgaWYgKCFpc0NvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzcykpIHJldHVybiAhMTsKICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZTsKICAgIGluc3RhbmNlID0gaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgfHwgZW1wdHlPYmplY3Q7CiAgICBwcmV2aW91c0NvbnRleHQgPSBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBpbnN0YW5jZSwgd29ya0luUHJvZ3Jlc3MpOwogICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQsIHdvcmtJblByb2dyZXNzKTsKICAgIHJldHVybiAhMDsKICB9CgogIGZ1bmN0aW9uIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MsIGRpZENoYW5nZSkgewogICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlOwogICAgaW52YXJpYW50KGluc3RhbmNlLCAiRXhwZWN0ZWQgdG8gaGF2ZSBhbiBpbnN0YW5jZSBieSB0aGlzIHBvaW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwoKICAgIGlmIChkaWRDaGFuZ2UpIHsKICAgICAgdmFyIG1lcmdlZENvbnRleHQgPSBwcm9jZXNzQ2hpbGRDb250ZXh0KHdvcmtJblByb2dyZXNzLCBwcmV2aW91c0NvbnRleHQpOwogICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCA9IG1lcmdlZENvbnRleHQ7CiAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzKTsKICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIG1lcmdlZENvbnRleHQsIHdvcmtJblByb2dyZXNzKTsKICAgIH0gZWxzZSBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MpOwoKICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCB3b3JrSW5Qcm9ncmVzcyk7CiAgfQoKICBmdW5jdGlvbiBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgaW50ZXJuYWxDb250ZXh0VGFnKSB7CiAgICB0aGlzLnRhZyA9IHRhZzsKICAgIHRoaXMua2V5ID0ga2V5OwogICAgdGhpcy5zdGF0ZU5vZGUgPSB0aGlzLnR5cGUgPSBudWxsOwogICAgdGhpcy5zaWJsaW5nID0gdGhpcy5jaGlsZCA9IHRoaXNbInJldHVybiJdID0gbnVsbDsKICAgIHRoaXMuaW5kZXggPSAwOwogICAgdGhpcy5yZWYgPSBudWxsOwogICAgdGhpcy5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICB0aGlzLm1lbW9pemVkU3RhdGUgPSB0aGlzLnVwZGF0ZVF1ZXVlID0gdGhpcy5tZW1vaXplZFByb3BzID0gbnVsbDsKICAgIHRoaXMuaW50ZXJuYWxDb250ZXh0VGFnID0gaW50ZXJuYWxDb250ZXh0VGFnOwogICAgdGhpcy5lZmZlY3RUYWcgPSAwOwogICAgdGhpcy5sYXN0RWZmZWN0ID0gdGhpcy5maXJzdEVmZmVjdCA9IHRoaXMubmV4dEVmZmVjdCA9IG51bGw7CiAgICB0aGlzLmV4cGlyYXRpb25UaW1lID0gMDsKICAgIHRoaXMuYWx0ZXJuYXRlID0gbnVsbDsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIGludGVybmFsQ29udGV4dFRhZykgewogICAgcmV0dXJuIG5ldyBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgaW50ZXJuYWxDb250ZXh0VGFnKTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnQsIHBlbmRpbmdQcm9wcywgZXhwaXJhdGlvblRpbWUpIHsKICAgIHZhciB3b3JrSW5Qcm9ncmVzcyA9IGN1cnJlbnQuYWx0ZXJuYXRlOwogICAgbnVsbCA9PT0gd29ya0luUHJvZ3Jlc3MgPyAod29ya0luUHJvZ3Jlc3MgPSBjcmVhdGVGaWJlcihjdXJyZW50LnRhZywgcGVuZGluZ1Byb3BzLCBjdXJyZW50LmtleSwgY3VycmVudC5pbnRlcm5hbENvbnRleHRUYWcpLCB3b3JrSW5Qcm9ncmVzcy50eXBlID0gY3VycmVudC50eXBlLCB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUgPSBjdXJyZW50LnN0YXRlTm9kZSwgd29ya0luUHJvZ3Jlc3MuYWx0ZXJuYXRlID0gY3VycmVudCwgY3VycmVudC5hbHRlcm5hdGUgPSB3b3JrSW5Qcm9ncmVzcykgOiAod29ya0luUHJvZ3Jlc3MucGVuZGluZ1Byb3BzID0gcGVuZGluZ1Byb3BzLCB3b3JrSW5Qcm9ncmVzcy5lZmZlY3RUYWcgPSAwLCB3b3JrSW5Qcm9ncmVzcy5uZXh0RWZmZWN0ID0gbnVsbCwgd29ya0luUHJvZ3Jlc3MuZmlyc3RFZmZlY3QgPSBudWxsLCB3b3JrSW5Qcm9ncmVzcy5sYXN0RWZmZWN0ID0gbnVsbCk7CiAgICB3b3JrSW5Qcm9ncmVzcy5leHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lOwogICAgd29ya0luUHJvZ3Jlc3MuY2hpbGQgPSBjdXJyZW50LmNoaWxkOwogICAgd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRQcm9wcyA9IGN1cnJlbnQubWVtb2l6ZWRQcm9wczsKICAgIHdvcmtJblByb2dyZXNzLm1lbW9pemVkU3RhdGUgPSBjdXJyZW50Lm1lbW9pemVkU3RhdGU7CiAgICB3b3JrSW5Qcm9ncmVzcy51cGRhdGVRdWV1ZSA9IGN1cnJlbnQudXBkYXRlUXVldWU7CiAgICB3b3JrSW5Qcm9ncmVzcy5zaWJsaW5nID0gY3VycmVudC5zaWJsaW5nOwogICAgd29ya0luUHJvZ3Jlc3MuaW5kZXggPSBjdXJyZW50LmluZGV4OwogICAgd29ya0luUHJvZ3Jlc3MucmVmID0gY3VycmVudC5yZWY7CiAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3M7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIGludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpIHsKICAgIHZhciBmaWJlciA9IHZvaWQgMCwKICAgICAgICB0eXBlID0gZWxlbWVudC50eXBlLAogICAgICAgIGtleSA9IGVsZW1lbnQua2V5OwogICAgZWxlbWVudCA9IGVsZW1lbnQucHJvcHM7CiAgICAiZnVuY3Rpb24iID09PSB0eXBlb2YgdHlwZSA/IChmaWJlciA9IHR5cGUucHJvdG90eXBlICYmIHR5cGUucHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQgPyBjcmVhdGVGaWJlcigyLCBlbGVtZW50LCBrZXksIGludGVybmFsQ29udGV4dFRhZykgOiBjcmVhdGVGaWJlcigwLCBlbGVtZW50LCBrZXksIGludGVybmFsQ29udGV4dFRhZyksIGZpYmVyLnR5cGUgPSB0eXBlKSA6ICJzdHJpbmciID09PSB0eXBlb2YgdHlwZSA/IChmaWJlciA9IGNyZWF0ZUZpYmVyKDUsIGVsZW1lbnQsIGtleSwgaW50ZXJuYWxDb250ZXh0VGFnKSwgZmliZXIudHlwZSA9IHR5cGUpIDogIm9iamVjdCIgPT09IHR5cGVvZiB0eXBlICYmIG51bGwgIT09IHR5cGUgJiYgIm51bWJlciIgPT09IHR5cGVvZiB0eXBlLnRhZyA/IChmaWJlciA9IHR5cGUsIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGVsZW1lbnQpIDogaW52YXJpYW50KCExLCAiRWxlbWVudCB0eXBlIGlzIGludmFsaWQ6IGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSBidXQgZ290OiAlcy4lcyIsIG51bGwgPT0gdHlwZSA/IHR5cGUgOiB0eXBlb2YgdHlwZSwgIiIpOwogICAgZmliZXIuZXhwaXJhdGlvblRpbWUgPSBleHBpcmF0aW9uVGltZTsKICAgIHJldHVybiBmaWJlcjsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGVsZW1lbnRzLCBpbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lLCBrZXkpIHsKICAgIGVsZW1lbnRzID0gY3JlYXRlRmliZXIoMTAsIGVsZW1lbnRzLCBrZXksIGludGVybmFsQ29udGV4dFRhZyk7CiAgICBlbGVtZW50cy5leHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lOwogICAgcmV0dXJuIGVsZW1lbnRzOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tVGV4dChjb250ZW50LCBpbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKSB7CiAgICBjb250ZW50ID0gY3JlYXRlRmliZXIoNiwgY29udGVudCwgbnVsbCwgaW50ZXJuYWxDb250ZXh0VGFnKTsKICAgIGNvbnRlbnQuZXhwaXJhdGlvblRpbWUgPSBleHBpcmF0aW9uVGltZTsKICAgIHJldHVybiBjb250ZW50OwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tQ2FsbChjYWxsLCBpbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKSB7CiAgICBpbnRlcm5hbENvbnRleHRUYWcgPSBjcmVhdGVGaWJlcig3LCBjYWxsLCBjYWxsLmtleSwgaW50ZXJuYWxDb250ZXh0VGFnKTsKICAgIGludGVybmFsQ29udGV4dFRhZy50eXBlID0gY2FsbC5oYW5kbGVyOwogICAgaW50ZXJuYWxDb250ZXh0VGFnLmV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWU7CiAgICByZXR1cm4gaW50ZXJuYWxDb250ZXh0VGFnOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUmV0dXJuKHJldHVybk5vZGUsIGludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpIHsKICAgIHJldHVybk5vZGUgPSBjcmVhdGVGaWJlcig5LCBudWxsLCBudWxsLCBpbnRlcm5hbENvbnRleHRUYWcpOwogICAgcmV0dXJuTm9kZS5leHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lOwogICAgcmV0dXJuIHJldHVybk5vZGU7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCBpbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKSB7CiAgICBpbnRlcm5hbENvbnRleHRUYWcgPSBjcmVhdGVGaWJlcig0LCBudWxsICE9PSBwb3J0YWwuY2hpbGRyZW4gPyBwb3J0YWwuY2hpbGRyZW4gOiBbXSwgcG9ydGFsLmtleSwgaW50ZXJuYWxDb250ZXh0VGFnKTsKICAgIGludGVybmFsQ29udGV4dFRhZy5leHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lOwogICAgaW50ZXJuYWxDb250ZXh0VGFnLnN0YXRlTm9kZSA9IHsKICAgICAgY29udGFpbmVySW5mbzogcG9ydGFsLmNvbnRhaW5lckluZm8sCiAgICAgIHBlbmRpbmdDaGlsZHJlbjogbnVsbCwKICAgICAgaW1wbGVtZW50YXRpb246IHBvcnRhbC5pbXBsZW1lbnRhdGlvbgogICAgfTsKICAgIHJldHVybiBpbnRlcm5hbENvbnRleHRUYWc7CiAgfQoKICB2YXIgb25Db21taXRGaWJlclJvb3QgPSBudWxsLAogICAgICBvbkNvbW1pdEZpYmVyVW5tb3VudCA9IG51bGw7CgogIGZ1bmN0aW9uIGNhdGNoRXJyb3JzKGZuKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKGFyZykgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBmbihhcmcpOwogICAgICB9IGNhdGNoIChlcnIpIHt9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gaW5qZWN0SW50ZXJuYWxzKGludGVybmFscykgewogICAgaWYgKCJ1bmRlZmluZWQiID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fKSByZXR1cm4gITE7CiAgICB2YXIgaG9vayA9IF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXzsKICAgIGlmIChob29rLmlzRGlzYWJsZWQgfHwgIWhvb2suc3VwcG9ydHNGaWJlcikgcmV0dXJuICEwOwoKICAgIHRyeSB7CiAgICAgIHZhciByZW5kZXJlcklEID0gaG9vay5pbmplY3QoaW50ZXJuYWxzKTsKICAgICAgb25Db21taXRGaWJlclJvb3QgPSBjYXRjaEVycm9ycyhmdW5jdGlvbiAocm9vdCkgewogICAgICAgIHJldHVybiBob29rLm9uQ29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QpOwogICAgICB9KTsKICAgICAgb25Db21taXRGaWJlclVubW91bnQgPSBjYXRjaEVycm9ycyhmdW5jdGlvbiAoZmliZXIpIHsKICAgICAgICByZXR1cm4gaG9vay5vbkNvbW1pdEZpYmVyVW5tb3VudChyZW5kZXJlcklELCBmaWJlcik7CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyKSB7fQoKICAgIHJldHVybiAhMDsKICB9CgogIGZ1bmN0aW9uIG9uQ29tbWl0Um9vdChyb290KSB7CiAgICAiZnVuY3Rpb24iID09PSB0eXBlb2Ygb25Db21taXRGaWJlclJvb3QgJiYgb25Db21taXRGaWJlclJvb3Qocm9vdCk7CiAgfQoKICBmdW5jdGlvbiBvbkNvbW1pdFVubW91bnQoZmliZXIpIHsKICAgICJmdW5jdGlvbiIgPT09IHR5cGVvZiBvbkNvbW1pdEZpYmVyVW5tb3VudCAmJiBvbkNvbW1pdEZpYmVyVW5tb3VudChmaWJlcik7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVVcGRhdGVRdWV1ZShiYXNlU3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIGJhc2VTdGF0ZTogYmFzZVN0YXRlLAogICAgICBleHBpcmF0aW9uVGltZTogMCwKICAgICAgZmlyc3Q6IG51bGwsCiAgICAgIGxhc3Q6IG51bGwsCiAgICAgIGNhbGxiYWNrTGlzdDogbnVsbCwKICAgICAgaGFzRm9yY2VVcGRhdGU6ICExLAogICAgICBpc0luaXRpYWxpemVkOiAhMQogICAgfTsKICB9CgogIGZ1bmN0aW9uIGluc2VydFVwZGF0ZUludG9RdWV1ZShxdWV1ZSwgdXBkYXRlKSB7CiAgICBudWxsID09PSBxdWV1ZS5sYXN0ID8gcXVldWUuZmlyc3QgPSBxdWV1ZS5sYXN0ID0gdXBkYXRlIDogKHF1ZXVlLmxhc3QubmV4dCA9IHVwZGF0ZSwgcXVldWUubGFzdCA9IHVwZGF0ZSk7CiAgICBpZiAoMCA9PT0gcXVldWUuZXhwaXJhdGlvblRpbWUgfHwgcXVldWUuZXhwaXJhdGlvblRpbWUgPiB1cGRhdGUuZXhwaXJhdGlvblRpbWUpIHF1ZXVlLmV4cGlyYXRpb25UaW1lID0gdXBkYXRlLmV4cGlyYXRpb25UaW1lOwogIH0KCiAgZnVuY3Rpb24gaW5zZXJ0VXBkYXRlSW50b0ZpYmVyKGZpYmVyLCB1cGRhdGUpIHsKICAgIHZhciBhbHRlcm5hdGVGaWJlciA9IGZpYmVyLmFsdGVybmF0ZSwKICAgICAgICBxdWV1ZTEgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgIG51bGwgPT09IHF1ZXVlMSAmJiAocXVldWUxID0gZmliZXIudXBkYXRlUXVldWUgPSBjcmVhdGVVcGRhdGVRdWV1ZShudWxsKSk7CiAgICBudWxsICE9PSBhbHRlcm5hdGVGaWJlciA/IChmaWJlciA9IGFsdGVybmF0ZUZpYmVyLnVwZGF0ZVF1ZXVlLCBudWxsID09PSBmaWJlciAmJiAoZmliZXIgPSBhbHRlcm5hdGVGaWJlci51cGRhdGVRdWV1ZSA9IGNyZWF0ZVVwZGF0ZVF1ZXVlKG51bGwpKSkgOiBmaWJlciA9IG51bGw7CiAgICBmaWJlciA9IGZpYmVyICE9PSBxdWV1ZTEgPyBmaWJlciA6IG51bGw7CiAgICBudWxsID09PSBmaWJlciA/IGluc2VydFVwZGF0ZUludG9RdWV1ZShxdWV1ZTEsIHVwZGF0ZSkgOiBudWxsID09PSBxdWV1ZTEubGFzdCB8fCBudWxsID09PSBmaWJlci5sYXN0ID8gKGluc2VydFVwZGF0ZUludG9RdWV1ZShxdWV1ZTEsIHVwZGF0ZSksIGluc2VydFVwZGF0ZUludG9RdWV1ZShmaWJlciwgdXBkYXRlKSkgOiAoaW5zZXJ0VXBkYXRlSW50b1F1ZXVlKHF1ZXVlMSwgdXBkYXRlKSwgZmliZXIubGFzdCA9IHVwZGF0ZSk7CiAgfQoKICBmdW5jdGlvbiBnZXRTdGF0ZUZyb21VcGRhdGUodXBkYXRlLCBpbnN0YW5jZSwgcHJldlN0YXRlLCBwcm9wcykgewogICAgdXBkYXRlID0gdXBkYXRlLnBhcnRpYWxTdGF0ZTsKICAgIHJldHVybiAiZnVuY3Rpb24iID09PSB0eXBlb2YgdXBkYXRlID8gKGRlYnVnUmVuZGVyUGhhc2VTaWRlRWZmZWN0cyAmJiB1cGRhdGUuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBwcm9wcyksIHVwZGF0ZS5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIHByb3BzKSkgOiB1cGRhdGU7CiAgfQoKICBmdW5jdGlvbiBwcm9jZXNzVXBkYXRlUXVldWUoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHF1ZXVlLCBpbnN0YW5jZSwgcHJvcHMsIHJlbmRlckV4cGlyYXRpb25UaW1lKSB7CiAgICBudWxsICE9PSBjdXJyZW50ICYmIGN1cnJlbnQudXBkYXRlUXVldWUgPT09IHF1ZXVlICYmIChxdWV1ZSA9IHdvcmtJblByb2dyZXNzLnVwZGF0ZVF1ZXVlID0gewogICAgICBiYXNlU3RhdGU6IHF1ZXVlLmJhc2VTdGF0ZSwKICAgICAgZXhwaXJhdGlvblRpbWU6IHF1ZXVlLmV4cGlyYXRpb25UaW1lLAogICAgICBmaXJzdDogcXVldWUuZmlyc3QsCiAgICAgIGxhc3Q6IHF1ZXVlLmxhc3QsCiAgICAgIGlzSW5pdGlhbGl6ZWQ6IHF1ZXVlLmlzSW5pdGlhbGl6ZWQsCiAgICAgIGNhbGxiYWNrTGlzdDogbnVsbCwKICAgICAgaGFzRm9yY2VVcGRhdGU6ICExCiAgICB9KTsKICAgIHF1ZXVlLmV4cGlyYXRpb25UaW1lID0gMDsKICAgIHF1ZXVlLmlzSW5pdGlhbGl6ZWQgPyBjdXJyZW50ID0gcXVldWUuYmFzZVN0YXRlIDogKGN1cnJlbnQgPSBxdWV1ZS5iYXNlU3RhdGUgPSB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFN0YXRlLCBxdWV1ZS5pc0luaXRpYWxpemVkID0gITApOwoKICAgIGZvciAodmFyIGRvbnRNdXRhdGVQcmV2U3RhdGUgPSAhMCwgdXBkYXRlID0gcXVldWUuZmlyc3QsIGRpZFNraXAgPSAhMTsgbnVsbCAhPT0gdXBkYXRlOykgewogICAgICB2YXIgdXBkYXRlRXhwaXJhdGlvblRpbWUgPSB1cGRhdGUuZXhwaXJhdGlvblRpbWU7CgogICAgICBpZiAodXBkYXRlRXhwaXJhdGlvblRpbWUgPiByZW5kZXJFeHBpcmF0aW9uVGltZSkgewogICAgICAgIHZhciByZW1haW5pbmdFeHBpcmF0aW9uVGltZSA9IHF1ZXVlLmV4cGlyYXRpb25UaW1lOwogICAgICAgIGlmICgwID09PSByZW1haW5pbmdFeHBpcmF0aW9uVGltZSB8fCByZW1haW5pbmdFeHBpcmF0aW9uVGltZSA+IHVwZGF0ZUV4cGlyYXRpb25UaW1lKSBxdWV1ZS5leHBpcmF0aW9uVGltZSA9IHVwZGF0ZUV4cGlyYXRpb25UaW1lOwogICAgICAgIGRpZFNraXAgfHwgKGRpZFNraXAgPSAhMCwgcXVldWUuYmFzZVN0YXRlID0gY3VycmVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGlkU2tpcCB8fCAocXVldWUuZmlyc3QgPSB1cGRhdGUubmV4dCwgbnVsbCA9PT0gcXVldWUuZmlyc3QgJiYgKHF1ZXVlLmxhc3QgPSBudWxsKSk7CiAgICAgICAgaWYgKHVwZGF0ZS5pc1JlcGxhY2UpIGN1cnJlbnQgPSBnZXRTdGF0ZUZyb21VcGRhdGUodXBkYXRlLCBpbnN0YW5jZSwgY3VycmVudCwgcHJvcHMpLCBkb250TXV0YXRlUHJldlN0YXRlID0gITA7ZWxzZSBpZiAodXBkYXRlRXhwaXJhdGlvblRpbWUgPSBnZXRTdGF0ZUZyb21VcGRhdGUodXBkYXRlLCBpbnN0YW5jZSwgY3VycmVudCwgcHJvcHMpKSBjdXJyZW50ID0gZG9udE11dGF0ZVByZXZTdGF0ZSA/IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBjdXJyZW50LCB1cGRhdGVFeHBpcmF0aW9uVGltZSkgOiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyhjdXJyZW50LCB1cGRhdGVFeHBpcmF0aW9uVGltZSksIGRvbnRNdXRhdGVQcmV2U3RhdGUgPSAhMTsKICAgICAgICB1cGRhdGUuaXNGb3JjZWQgJiYgKHF1ZXVlLmhhc0ZvcmNlVXBkYXRlID0gITApOwogICAgICAgIG51bGwgIT09IHVwZGF0ZS5jYWxsYmFjayAmJiAodXBkYXRlRXhwaXJhdGlvblRpbWUgPSBxdWV1ZS5jYWxsYmFja0xpc3QsIG51bGwgPT09IHVwZGF0ZUV4cGlyYXRpb25UaW1lICYmICh1cGRhdGVFeHBpcmF0aW9uVGltZSA9IHF1ZXVlLmNhbGxiYWNrTGlzdCA9IFtdKSwgdXBkYXRlRXhwaXJhdGlvblRpbWUucHVzaCh1cGRhdGUpKTsKICAgICAgfQoKICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICB9CgogICAgbnVsbCAhPT0gcXVldWUuY2FsbGJhY2tMaXN0ID8gd29ya0luUHJvZ3Jlc3MuZWZmZWN0VGFnIHw9IDMyIDogbnVsbCAhPT0gcXVldWUuZmlyc3QgfHwgcXVldWUuaGFzRm9yY2VVcGRhdGUgfHwgKHdvcmtJblByb2dyZXNzLnVwZGF0ZVF1ZXVlID0gbnVsbCk7CiAgICBkaWRTa2lwIHx8IChxdWV1ZS5iYXNlU3RhdGUgPSBjdXJyZW50KTsKICAgIHJldHVybiBjdXJyZW50OwogIH0KCiAgZnVuY3Rpb24gY29tbWl0Q2FsbGJhY2tzKHF1ZXVlLCBjb250ZXh0KSB7CiAgICB2YXIgY2FsbGJhY2tMaXN0ID0gcXVldWUuY2FsbGJhY2tMaXN0OwogICAgaWYgKG51bGwgIT09IGNhbGxiYWNrTGlzdCkgZm9yIChxdWV1ZS5jYWxsYmFja0xpc3QgPSBudWxsLCBxdWV1ZSA9IDA7IHF1ZXVlIDwgY2FsbGJhY2tMaXN0Lmxlbmd0aDsgcXVldWUrKykgewogICAgICB2YXIgdXBkYXRlID0gY2FsbGJhY2tMaXN0W3F1ZXVlXSwKICAgICAgICAgIF9jYWxsYmFjayA9IHVwZGF0ZS5jYWxsYmFjazsKICAgICAgdXBkYXRlLmNhbGxiYWNrID0gbnVsbDsKICAgICAgaW52YXJpYW50KCJmdW5jdGlvbiIgPT09IHR5cGVvZiBfY2FsbGJhY2ssICJJbnZhbGlkIGFyZ3VtZW50IHBhc3NlZCBhcyBjYWxsYmFjay4gRXhwZWN0ZWQgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMiLCBfY2FsbGJhY2spOwoKICAgICAgX2NhbGxiYWNrLmNhbGwoY29udGV4dCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBSZWFjdEZpYmVyQ2xhc3NDb21wb25lbnQoc2NoZWR1bGVXb3JrLCBjb21wdXRlRXhwaXJhdGlvbkZvckZpYmVyLCBtZW1vaXplUHJvcHMsIG1lbW9pemVTdGF0ZSkgewogICAgZnVuY3Rpb24gYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzLCBpbnN0YW5jZSkgewogICAgICBpbnN0YW5jZS51cGRhdGVyID0gdXBkYXRlcjsKICAgICAgd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlID0gaW5zdGFuY2U7CiAgICAgIGluc3RhbmNlLl9yZWFjdEludGVybmFsRmliZXIgPSB3b3JrSW5Qcm9ncmVzczsKICAgIH0KCiAgICB2YXIgdXBkYXRlciA9IHsKICAgICAgaXNNb3VudGVkOiBpc01vdW50ZWQsCiAgICAgIGVucXVldWVTZXRTdGF0ZTogZnVuY3Rpb24gZW5xdWV1ZVNldFN0YXRlKGluc3RhbmNlLCBwYXJ0aWFsU3RhdGUsIGNhbGxiYWNrKSB7CiAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZS5fcmVhY3RJbnRlcm5hbEZpYmVyOwogICAgICAgIGNhbGxiYWNrID0gdm9pZCAwID09PSBjYWxsYmFjayA/IG51bGwgOiBjYWxsYmFjazsKICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWUgPSBjb21wdXRlRXhwaXJhdGlvbkZvckZpYmVyKGluc3RhbmNlKTsKICAgICAgICBpbnNlcnRVcGRhdGVJbnRvRmliZXIoaW5zdGFuY2UsIHsKICAgICAgICAgIGV4cGlyYXRpb25UaW1lOiBleHBpcmF0aW9uVGltZSwKICAgICAgICAgIHBhcnRpYWxTdGF0ZTogcGFydGlhbFN0YXRlLAogICAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgICAgaXNSZXBsYWNlOiAhMSwKICAgICAgICAgIGlzRm9yY2VkOiAhMSwKICAgICAgICAgIG5leHRDYWxsYmFjazogbnVsbCwKICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICB9KTsKICAgICAgICBzY2hlZHVsZVdvcmsoaW5zdGFuY2UsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgfSwKICAgICAgZW5xdWV1ZVJlcGxhY2VTdGF0ZTogZnVuY3Rpb24gZW5xdWV1ZVJlcGxhY2VTdGF0ZShpbnN0YW5jZSwgc3RhdGUsIGNhbGxiYWNrKSB7CiAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZS5fcmVhY3RJbnRlcm5hbEZpYmVyOwogICAgICAgIGNhbGxiYWNrID0gdm9pZCAwID09PSBjYWxsYmFjayA/IG51bGwgOiBjYWxsYmFjazsKICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWUgPSBjb21wdXRlRXhwaXJhdGlvbkZvckZpYmVyKGluc3RhbmNlKTsKICAgICAgICBpbnNlcnRVcGRhdGVJbnRvRmliZXIoaW5zdGFuY2UsIHsKICAgICAgICAgIGV4cGlyYXRpb25UaW1lOiBleHBpcmF0aW9uVGltZSwKICAgICAgICAgIHBhcnRpYWxTdGF0ZTogc3RhdGUsCiAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgICBpc1JlcGxhY2U6ICEwLAogICAgICAgICAgaXNGb3JjZWQ6ICExLAogICAgICAgICAgbmV4dENhbGxiYWNrOiBudWxsLAogICAgICAgICAgbmV4dDogbnVsbAogICAgICAgIH0pOwogICAgICAgIHNjaGVkdWxlV29yayhpbnN0YW5jZSwgZXhwaXJhdGlvblRpbWUpOwogICAgICB9LAogICAgICBlbnF1ZXVlRm9yY2VVcGRhdGU6IGZ1bmN0aW9uIGVucXVldWVGb3JjZVVwZGF0ZShpbnN0YW5jZSwgY2FsbGJhY2spIHsKICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLl9yZWFjdEludGVybmFsRmliZXI7CiAgICAgICAgY2FsbGJhY2sgPSB2b2lkIDAgPT09IGNhbGxiYWNrID8gbnVsbCA6IGNhbGxiYWNrOwogICAgICAgIHZhciBleHBpcmF0aW9uVGltZSA9IGNvbXB1dGVFeHBpcmF0aW9uRm9yRmliZXIoaW5zdGFuY2UpOwogICAgICAgIGluc2VydFVwZGF0ZUludG9GaWJlcihpbnN0YW5jZSwgewogICAgICAgICAgZXhwaXJhdGlvblRpbWU6IGV4cGlyYXRpb25UaW1lLAogICAgICAgICAgcGFydGlhbFN0YXRlOiBudWxsLAogICAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgICAgaXNSZXBsYWNlOiAhMSwKICAgICAgICAgIGlzRm9yY2VkOiAhMCwKICAgICAgICAgIG5leHRDYWxsYmFjazogbnVsbCwKICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICB9KTsKICAgICAgICBzY2hlZHVsZVdvcmsoaW5zdGFuY2UsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgfQogICAgfTsKICAgIHJldHVybiB7CiAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZTogYWRvcHRDbGFzc0luc3RhbmNlLAogICAgICBjb25zdHJ1Y3RDbGFzc0luc3RhbmNlOiBmdW5jdGlvbiBjb25zdHJ1Y3RDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzLCBwcm9wcykgewogICAgICAgIHZhciBjdG9yID0gd29ya0luUHJvZ3Jlc3MudHlwZSwKICAgICAgICAgICAgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzKSwKICAgICAgICAgICAgbmVlZHNDb250ZXh0ID0gMiA9PT0gd29ya0luUHJvZ3Jlc3MudGFnICYmIG51bGwgIT0gd29ya0luUHJvZ3Jlc3MudHlwZS5jb250ZXh0VHlwZXMsCiAgICAgICAgICAgIGNvbnRleHQgPSBuZWVkc0NvbnRleHQgPyBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzLCB1bm1hc2tlZENvbnRleHQpIDogZW1wdHlPYmplY3Q7CiAgICAgICAgcHJvcHMgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzLCBwcm9wcyk7CiAgICAgICAgbmVlZHNDb250ZXh0ICYmICh3b3JrSW5Qcm9ncmVzcyA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZSwgd29ya0luUHJvZ3Jlc3MuX19yZWFjdEludGVybmFsTWVtb2l6ZWRVbm1hc2tlZENoaWxkQ29udGV4dCA9IHVubWFza2VkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNYXNrZWRDaGlsZENvbnRleHQgPSBjb250ZXh0KTsKICAgICAgICByZXR1cm4gcHJvcHM7CiAgICAgIH0sCiAgICAgIG1vdW50Q2xhc3NJbnN0YW5jZTogZnVuY3Rpb24gbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzLCByZW5kZXJFeHBpcmF0aW9uVGltZSkgewogICAgICAgIHZhciBjdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MuYWx0ZXJuYXRlLAogICAgICAgICAgICBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZSwKICAgICAgICAgICAgc3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSB8fCBudWxsLAogICAgICAgICAgICBwcm9wcyA9IHdvcmtJblByb2dyZXNzLnBlbmRpbmdQcm9wcywKICAgICAgICAgICAgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzKTsKICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IHByb3BzOwogICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRTdGF0ZSA9IHN0YXRlOwogICAgICAgIGluc3RhbmNlLnJlZnMgPSBlbXB0eU9iamVjdDsKICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzcywgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICBudWxsICE9IHdvcmtJblByb2dyZXNzLnR5cGUgJiYgbnVsbCAhPSB3b3JrSW5Qcm9ncmVzcy50eXBlLnByb3RvdHlwZSAmJiAhMCA9PT0gd29ya0luUHJvZ3Jlc3MudHlwZS5wcm90b3R5cGUudW5zdGFibGVfaXNBc3luY1JlYWN0Q29tcG9uZW50ICYmICh3b3JrSW5Qcm9ncmVzcy5pbnRlcm5hbENvbnRleHRUYWcgfD0gMSk7CiAgICAgICAgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCAmJiAoc3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSwgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50KCksIGRlYnVnUmVuZGVyUGhhc2VTaWRlRWZmZWN0cyAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKSwgc3RhdGUgIT09IGluc3RhbmNlLnN0YXRlICYmIHVwZGF0ZXIuZW5xdWV1ZVJlcGxhY2VTdGF0ZShpbnN0YW5jZSwgaW5zdGFuY2Uuc3RhdGUsIG51bGwpLCBzdGF0ZSA9IHdvcmtJblByb2dyZXNzLnVwZGF0ZVF1ZXVlLCBudWxsICE9PSBzdGF0ZSAmJiAoaW5zdGFuY2Uuc3RhdGUgPSBwcm9jZXNzVXBkYXRlUXVldWUoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHN0YXRlLCBpbnN0YW5jZSwgcHJvcHMsIHJlbmRlckV4cGlyYXRpb25UaW1lKSkpOwogICAgICAgICJmdW5jdGlvbiIgPT09IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCAmJiAod29ya0luUHJvZ3Jlc3MuZWZmZWN0VGFnIHw9IDQpOwogICAgICB9LAogICAgICB1cGRhdGVDbGFzc0luc3RhbmNlOiBmdW5jdGlvbiB1cGRhdGVDbGFzc0luc3RhbmNlKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCByZW5kZXJFeHBpcmF0aW9uVGltZSkgewogICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZTsKICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHM7CiAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFN0YXRlOwogICAgICAgIHZhciBvbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHMsCiAgICAgICAgICAgIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MucGVuZGluZ1Byb3BzLAogICAgICAgICAgICBvbGRDb250ZXh0ID0gaW5zdGFuY2UuY29udGV4dCwKICAgICAgICAgICAgbmV3VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzKTsKICAgICAgICBuZXdVbm1hc2tlZENvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzLCBuZXdVbm1hc2tlZENvbnRleHQpOwogICAgICAgICJmdW5jdGlvbiIgIT09IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIHx8IG9sZFByb3BzID09PSBuZXdQcm9wcyAmJiBvbGRDb250ZXh0ID09PSBuZXdVbm1hc2tlZENvbnRleHQgfHwgKG9sZENvbnRleHQgPSBpbnN0YW5jZS5zdGF0ZSwgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXdQcm9wcywgbmV3VW5tYXNrZWRDb250ZXh0KSwgZGVidWdSZW5kZXJQaGFzZVNpZGVFZmZlY3RzICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV3UHJvcHMsIG5ld1VubWFza2VkQ29udGV4dCksIGluc3RhbmNlLnN0YXRlICE9PSBvbGRDb250ZXh0ICYmIHVwZGF0ZXIuZW5xdWV1ZVJlcGxhY2VTdGF0ZShpbnN0YW5jZSwgaW5zdGFuY2Uuc3RhdGUsIG51bGwpKTsKICAgICAgICBvbGRDb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRTdGF0ZTsKICAgICAgICByZW5kZXJFeHBpcmF0aW9uVGltZSA9IG51bGwgIT09IHdvcmtJblByb2dyZXNzLnVwZGF0ZVF1ZXVlID8gcHJvY2Vzc1VwZGF0ZVF1ZXVlKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCB3b3JrSW5Qcm9ncmVzcy51cGRhdGVRdWV1ZSwgaW5zdGFuY2UsIG5ld1Byb3BzLCByZW5kZXJFeHBpcmF0aW9uVGltZSkgOiBvbGRDb250ZXh0OwogICAgICAgIGlmICghKG9sZFByb3BzICE9PSBuZXdQcm9wcyB8fCBvbGRDb250ZXh0ICE9PSByZW5kZXJFeHBpcmF0aW9uVGltZSB8fCBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQgfHwgbnVsbCAhPT0gd29ya0luUHJvZ3Jlc3MudXBkYXRlUXVldWUgJiYgd29ya0luUHJvZ3Jlc3MudXBkYXRlUXVldWUuaGFzRm9yY2VVcGRhdGUpKSByZXR1cm4gImZ1bmN0aW9uIiAhPT0gdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSB8fCBvbGRQcm9wcyA9PT0gY3VycmVudC5tZW1vaXplZFByb3BzICYmIG9sZENvbnRleHQgPT09IGN1cnJlbnQubWVtb2l6ZWRTdGF0ZSB8fCAod29ya0luUHJvZ3Jlc3MuZWZmZWN0VGFnIHw9IDQpLCAhMTsKICAgICAgICBpZiAobnVsbCA9PT0gb2xkUHJvcHMgfHwgbnVsbCAhPT0gd29ya0luUHJvZ3Jlc3MudXBkYXRlUXVldWUgJiYgd29ya0luUHJvZ3Jlc3MudXBkYXRlUXVldWUuaGFzRm9yY2VVcGRhdGUpIHZhciBzaG91bGRVcGRhdGUgPSAhMDtlbHNlIHsKICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MudHlwZTsKICAgICAgICAgICJmdW5jdGlvbiIgPT09IHR5cGVvZiBzaG91bGRVcGRhdGUuc2hvdWxkQ29tcG9uZW50VXBkYXRlID8gKHR5cGUgPSBzaG91bGRVcGRhdGUuc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5ld1Byb3BzLCByZW5kZXJFeHBpcmF0aW9uVGltZSwgbmV3VW5tYXNrZWRDb250ZXh0KSwgZGVidWdSZW5kZXJQaGFzZVNpZGVFZmZlY3RzICYmIHNob3VsZFVwZGF0ZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIHJlbmRlckV4cGlyYXRpb25UaW1lLCBuZXdVbm1hc2tlZENvbnRleHQpLCBzaG91bGRVcGRhdGUgPSB0eXBlKSA6IHNob3VsZFVwZGF0ZSA9IHR5cGUucHJvdG90eXBlICYmIHR5cGUucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ID8gIXNoYWxsb3dFcXVhbChvbGRQcm9wcywgbmV3UHJvcHMpIHx8ICFzaGFsbG93RXF1YWwob2xkQ29udGV4dCwgcmVuZGVyRXhwaXJhdGlvblRpbWUpIDogITA7CiAgICAgICAgfQogICAgICAgIHNob3VsZFVwZGF0ZSA/ICgiZnVuY3Rpb24iID09PSB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZSAmJiAoaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZShuZXdQcm9wcywgcmVuZGVyRXhwaXJhdGlvblRpbWUsIG5ld1VubWFza2VkQ29udGV4dCksIGRlYnVnUmVuZGVyUGhhc2VTaWRlRWZmZWN0cyAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlKG5ld1Byb3BzLCByZW5kZXJFeHBpcmF0aW9uVGltZSwgbmV3VW5tYXNrZWRDb250ZXh0KSksICJmdW5jdGlvbiIgPT09IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgJiYgKHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyB8PSA0KSkgOiAoImZ1bmN0aW9uIiAhPT0gdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSB8fCBvbGRQcm9wcyA9PT0gY3VycmVudC5tZW1vaXplZFByb3BzICYmIG9sZENvbnRleHQgPT09IGN1cnJlbnQubWVtb2l6ZWRTdGF0ZSB8fCAod29ya0luUHJvZ3Jlc3MuZWZmZWN0VGFnIHw9IDQpLCBtZW1vaXplUHJvcHMod29ya0luUHJvZ3Jlc3MsIG5ld1Byb3BzKSwgbWVtb2l6ZVN0YXRlKHdvcmtJblByb2dyZXNzLCByZW5kZXJFeHBpcmF0aW9uVGltZSkpOwogICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSByZW5kZXJFeHBpcmF0aW9uVGltZTsKICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gbmV3VW5tYXNrZWRDb250ZXh0OwogICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgIH0KICAgIH07CiAgfQoKICB2YXIgaXNBcnJheSQxID0gQXJyYXkuaXNBcnJheTsKCiAgZnVuY3Rpb24gY29lcmNlUmVmKGN1cnJlbnQsIGVsZW1lbnQpIHsKICAgIHZhciBtaXhlZFJlZiA9IGVsZW1lbnQucmVmOwoKICAgIGlmIChudWxsICE9PSBtaXhlZFJlZiAmJiAiZnVuY3Rpb24iICE9PSB0eXBlb2YgbWl4ZWRSZWYpIHsKICAgICAgaWYgKGVsZW1lbnQuX293bmVyKSB7CiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQuX293bmVyOwogICAgICAgIHZhciBpbnN0ID0gdm9pZCAwOwogICAgICAgIGVsZW1lbnQgJiYgKGludmFyaWFudCgyID09PSBlbGVtZW50LnRhZywgIlN0YXRlbGVzcyBmdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHJlZnMuIiksIGluc3QgPSBlbGVtZW50LnN0YXRlTm9kZSk7CiAgICAgICAgaW52YXJpYW50KGluc3QsICJNaXNzaW5nIG93bmVyIGZvciBzdHJpbmcgcmVmICVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIG1peGVkUmVmKTsKICAgICAgICB2YXIgc3RyaW5nUmVmID0gIiIgKyBtaXhlZFJlZjsKICAgICAgICBpZiAobnVsbCAhPT0gY3VycmVudCAmJiBudWxsICE9PSBjdXJyZW50LnJlZiAmJiBjdXJyZW50LnJlZi5fc3RyaW5nUmVmID09PSBzdHJpbmdSZWYpIHJldHVybiBjdXJyZW50LnJlZjsKCiAgICAgICAgY3VycmVudCA9IGZ1bmN0aW9uIGN1cnJlbnQodmFsdWUpIHsKICAgICAgICAgIHZhciByZWZzID0gaW5zdC5yZWZzID09PSBlbXB0eU9iamVjdCA/IGluc3QucmVmcyA9IHt9IDogaW5zdC5yZWZzOwogICAgICAgICAgbnVsbCA9PT0gdmFsdWUgPyBkZWxldGUgcmVmc1tzdHJpbmdSZWZdIDogcmVmc1tzdHJpbmdSZWZdID0gdmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgY3VycmVudC5fc3RyaW5nUmVmID0gc3RyaW5nUmVmOwogICAgICAgIHJldHVybiBjdXJyZW50OwogICAgICB9CgogICAgICBpbnZhcmlhbnQoInN0cmluZyIgPT09IHR5cGVvZiBtaXhlZFJlZiwgIkV4cGVjdGVkIHJlZiB0byBiZSBhIGZ1bmN0aW9uIG9yIGEgc3RyaW5nLiIpOwogICAgICBpbnZhcmlhbnQoZWxlbWVudC5fb3duZXIsICJFbGVtZW50IHJlZiB3YXMgc3BlY2lmaWVkIGFzIGEgc3RyaW5nICglcykgYnV0IG5vIG93bmVyIHdhcyBzZXQuIFlvdSBtYXkgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgbG9hZGVkLiAoZGV0YWlsczogaHR0cHM6Ly9mYi5tZS9yZWFjdC1yZWZzLW11c3QtaGF2ZS1vd25lcikuIiwgbWl4ZWRSZWYpOwogICAgfQoKICAgIHJldHVybiBtaXhlZFJlZjsKICB9CgogIGZ1bmN0aW9uIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpIHsKICAgICJ0ZXh0YXJlYSIgIT09IHJldHVybkZpYmVyLnR5cGUgJiYgaW52YXJpYW50KCExLCAiT2JqZWN0cyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQgKGZvdW5kOiAlcykuJXMiLCAiW29iamVjdCBPYmplY3RdIiA9PT0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG5ld0NoaWxkKSA/ICJvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMobmV3Q2hpbGQpLmpvaW4oIiwgIikgKyAifSIgOiBuZXdDaGlsZCwgIiIpOwogIH0KCiAgZnVuY3Rpb24gQ2hpbGRSZWNvbmNpbGVyKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgIGZ1bmN0aW9uIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZFRvRGVsZXRlKSB7CiAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgdmFyIGxhc3QgPSByZXR1cm5GaWJlci5sYXN0RWZmZWN0OwogICAgICAgIG51bGwgIT09IGxhc3QgPyAobGFzdC5uZXh0RWZmZWN0ID0gY2hpbGRUb0RlbGV0ZSwgcmV0dXJuRmliZXIubGFzdEVmZmVjdCA9IGNoaWxkVG9EZWxldGUpIDogcmV0dXJuRmliZXIuZmlyc3RFZmZlY3QgPSByZXR1cm5GaWJlci5sYXN0RWZmZWN0ID0gY2hpbGRUb0RlbGV0ZTsKICAgICAgICBjaGlsZFRvRGVsZXRlLm5leHRFZmZlY3QgPSBudWxsOwogICAgICAgIGNoaWxkVG9EZWxldGUuZWZmZWN0VGFnID0gODsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCkgewogICAgICBpZiAoIXNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHJldHVybiBudWxsOwoKICAgICAgZm9yICg7IG51bGwgIT09IGN1cnJlbnRGaXJzdENoaWxkOykgewogICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCksIGN1cnJlbnRGaXJzdENoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQuc2libGluZzsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgIGZvciAocmV0dXJuRmliZXIgPSBuZXcgTWFwKCk7IG51bGwgIT09IGN1cnJlbnRGaXJzdENoaWxkOykgewogICAgICAgIG51bGwgIT09IGN1cnJlbnRGaXJzdENoaWxkLmtleSA/IHJldHVybkZpYmVyLnNldChjdXJyZW50Rmlyc3RDaGlsZC5rZXksIGN1cnJlbnRGaXJzdENoaWxkKSA6IHJldHVybkZpYmVyLnNldChjdXJyZW50Rmlyc3RDaGlsZC5pbmRleCwgY3VycmVudEZpcnN0Q2hpbGQpLCBjdXJyZW50Rmlyc3RDaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkLnNpYmxpbmc7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXR1cm5GaWJlcjsKICAgIH0KCiAgICBmdW5jdGlvbiB1c2VGaWJlcihmaWJlciwgcGVuZGluZ1Byb3BzLCBleHBpcmF0aW9uVGltZSkgewogICAgICBmaWJlciA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGZpYmVyLCBwZW5kaW5nUHJvcHMsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgZmliZXIuaW5kZXggPSAwOwogICAgICBmaWJlci5zaWJsaW5nID0gbnVsbDsKICAgICAgcmV0dXJuIGZpYmVyOwogICAgfQoKICAgIGZ1bmN0aW9uIHBsYWNlQ2hpbGQobmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SW5kZXgpIHsKICAgICAgbmV3RmliZXIuaW5kZXggPSBuZXdJbmRleDsKICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSByZXR1cm4gbGFzdFBsYWNlZEluZGV4OwogICAgICBuZXdJbmRleCA9IG5ld0ZpYmVyLmFsdGVybmF0ZTsKICAgICAgaWYgKG51bGwgIT09IG5ld0luZGV4KSByZXR1cm4gbmV3SW5kZXggPSBuZXdJbmRleC5pbmRleCwgbmV3SW5kZXggPCBsYXN0UGxhY2VkSW5kZXggPyAobmV3RmliZXIuZWZmZWN0VGFnID0gMiwgbGFzdFBsYWNlZEluZGV4KSA6IG5ld0luZGV4OwogICAgICBuZXdGaWJlci5lZmZlY3RUYWcgPSAyOwogICAgICByZXR1cm4gbGFzdFBsYWNlZEluZGV4OwogICAgfQoKICAgIGZ1bmN0aW9uIHBsYWNlU2luZ2xlQ2hpbGQobmV3RmliZXIpIHsKICAgICAgc2hvdWxkVHJhY2tTaWRlRWZmZWN0cyAmJiBudWxsID09PSBuZXdGaWJlci5hbHRlcm5hdGUgJiYgKG5ld0ZpYmVyLmVmZmVjdFRhZyA9IDIpOwogICAgICByZXR1cm4gbmV3RmliZXI7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnQsIHRleHRDb250ZW50LCBleHBpcmF0aW9uVGltZSkgewogICAgICBpZiAobnVsbCA9PT0gY3VycmVudCB8fCA2ICE9PSBjdXJyZW50LnRhZykgcmV0dXJuIGN1cnJlbnQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5pbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKSwgY3VycmVudFsicmV0dXJuIl0gPSByZXR1cm5GaWJlciwgY3VycmVudDsKICAgICAgY3VycmVudCA9IHVzZUZpYmVyKGN1cnJlbnQsIHRleHRDb250ZW50LCBleHBpcmF0aW9uVGltZSk7CiAgICAgIGN1cnJlbnRbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgIHJldHVybiBjdXJyZW50OwogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnQsIGVsZW1lbnQsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgIGlmIChudWxsICE9PSBjdXJyZW50ICYmIGN1cnJlbnQudHlwZSA9PT0gZWxlbWVudC50eXBlKSByZXR1cm4gZXhwaXJhdGlvblRpbWUgPSB1c2VGaWJlcihjdXJyZW50LCBlbGVtZW50LnByb3BzLCBleHBpcmF0aW9uVGltZSksIGV4cGlyYXRpb25UaW1lLnJlZiA9IGNvZXJjZVJlZihjdXJyZW50LCBlbGVtZW50KSwgZXhwaXJhdGlvblRpbWVbInJldHVybiJdID0gcmV0dXJuRmliZXIsIGV4cGlyYXRpb25UaW1lOwogICAgICBleHBpcmF0aW9uVGltZSA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSk7CiAgICAgIGV4cGlyYXRpb25UaW1lLnJlZiA9IGNvZXJjZVJlZihjdXJyZW50LCBlbGVtZW50KTsKICAgICAgZXhwaXJhdGlvblRpbWVbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgIHJldHVybiBleHBpcmF0aW9uVGltZTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVDYWxsKHJldHVybkZpYmVyLCBjdXJyZW50LCBjYWxsLCBleHBpcmF0aW9uVGltZSkgewogICAgICBpZiAobnVsbCA9PT0gY3VycmVudCB8fCA3ICE9PSBjdXJyZW50LnRhZykgcmV0dXJuIGN1cnJlbnQgPSBjcmVhdGVGaWJlckZyb21DYWxsKGNhbGwsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpLCBjdXJyZW50WyJyZXR1cm4iXSA9IHJldHVybkZpYmVyLCBjdXJyZW50OwogICAgICBjdXJyZW50ID0gdXNlRmliZXIoY3VycmVudCwgY2FsbCwgZXhwaXJhdGlvblRpbWUpOwogICAgICBjdXJyZW50WyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICByZXR1cm4gY3VycmVudDsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVSZXR1cm4ocmV0dXJuRmliZXIsIGN1cnJlbnQsIHJldHVybk5vZGUsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgIGlmIChudWxsID09PSBjdXJyZW50IHx8IDkgIT09IGN1cnJlbnQudGFnKSByZXR1cm4gY3VycmVudCA9IGNyZWF0ZUZpYmVyRnJvbVJldHVybihyZXR1cm5Ob2RlLCByZXR1cm5GaWJlci5pbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKSwgY3VycmVudC50eXBlID0gcmV0dXJuTm9kZS52YWx1ZSwgY3VycmVudFsicmV0dXJuIl0gPSByZXR1cm5GaWJlciwgY3VycmVudDsKICAgICAgY3VycmVudCA9IHVzZUZpYmVyKGN1cnJlbnQsIG51bGwsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgY3VycmVudC50eXBlID0gcmV0dXJuTm9kZS52YWx1ZTsKICAgICAgY3VycmVudFsicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBjdXJyZW50LCBwb3J0YWwsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgIGlmIChudWxsID09PSBjdXJyZW50IHx8IDQgIT09IGN1cnJlbnQudGFnIHx8IGN1cnJlbnQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gIT09IHBvcnRhbC5jb250YWluZXJJbmZvIHx8IGN1cnJlbnQuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uICE9PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHJldHVybiBjdXJyZW50ID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSksIGN1cnJlbnRbInJldHVybiJdID0gcmV0dXJuRmliZXIsIGN1cnJlbnQ7CiAgICAgIGN1cnJlbnQgPSB1c2VGaWJlcihjdXJyZW50LCBwb3J0YWwuY2hpbGRyZW4gfHwgW10sIGV4cGlyYXRpb25UaW1lKTsKICAgICAgY3VycmVudFsicmV0dXJuIl0gPSByZXR1cm5GaWJlcjsKICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQocmV0dXJuRmliZXIsIGN1cnJlbnQsIGZyYWdtZW50LCBleHBpcmF0aW9uVGltZSwga2V5KSB7CiAgICAgIGlmIChudWxsID09PSBjdXJyZW50IHx8IDEwICE9PSBjdXJyZW50LnRhZykgcmV0dXJuIGN1cnJlbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmcmFnbWVudCwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSwga2V5KSwgY3VycmVudFsicmV0dXJuIl0gPSByZXR1cm5GaWJlciwgY3VycmVudDsKICAgICAgY3VycmVudCA9IHVzZUZpYmVyKGN1cnJlbnQsIGZyYWdtZW50LCBleHBpcmF0aW9uVGltZSk7CiAgICAgIGN1cnJlbnRbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgIHJldHVybiBjdXJyZW50OwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpIHsKICAgICAgaWYgKCJzdHJpbmciID09PSB0eXBlb2YgbmV3Q2hpbGQgfHwgIm51bWJlciIgPT09IHR5cGVvZiBuZXdDaGlsZCkgcmV0dXJuIG5ld0NoaWxkID0gY3JlYXRlRmliZXJGcm9tVGV4dCgiIiArIG5ld0NoaWxkLCByZXR1cm5GaWJlci5pbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKSwgbmV3Q2hpbGRbInJldHVybiJdID0gcmV0dXJuRmliZXIsIG5ld0NoaWxkOwoKICAgICAgaWYgKCJvYmplY3QiID09PSB0eXBlb2YgbmV3Q2hpbGQgJiYgbnVsbCAhPT0gbmV3Q2hpbGQpIHsKICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgaWYgKG5ld0NoaWxkLnR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHJldHVybiBuZXdDaGlsZCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KG5ld0NoaWxkLnByb3BzLmNoaWxkcmVuLCByZXR1cm5GaWJlci5pbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lLCBuZXdDaGlsZC5rZXkpLCBuZXdDaGlsZFsicmV0dXJuIl0gPSByZXR1cm5GaWJlciwgbmV3Q2hpbGQ7CiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lID0gY3JlYXRlRmliZXJGcm9tRWxlbWVudChuZXdDaGlsZCwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lLnJlZiA9IGNvZXJjZVJlZihudWxsLCBuZXdDaGlsZCk7CiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gZXhwaXJhdGlvblRpbWU7CgogICAgICAgICAgY2FzZSBSRUFDVF9DQUxMX1RZUEU6CiAgICAgICAgICAgIHJldHVybiBuZXdDaGlsZCA9IGNyZWF0ZUZpYmVyRnJvbUNhbGwobmV3Q2hpbGQsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpLCBuZXdDaGlsZFsicmV0dXJuIl0gPSByZXR1cm5GaWJlciwgbmV3Q2hpbGQ7CgogICAgICAgICAgY2FzZSBSRUFDVF9SRVRVUk5fVFlQRToKICAgICAgICAgICAgcmV0dXJuIGV4cGlyYXRpb25UaW1lID0gY3JlYXRlRmliZXJGcm9tUmV0dXJuKG5ld0NoaWxkLCByZXR1cm5GaWJlci5pbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKSwgZXhwaXJhdGlvblRpbWUudHlwZSA9IG5ld0NoaWxkLnZhbHVlLCBleHBpcmF0aW9uVGltZVsicmV0dXJuIl0gPSByZXR1cm5GaWJlciwgZXhwaXJhdGlvblRpbWU7CgogICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgcmV0dXJuIG5ld0NoaWxkID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKG5ld0NoaWxkLCByZXR1cm5GaWJlci5pbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lKSwgbmV3Q2hpbGRbInJldHVybiJdID0gcmV0dXJuRmliZXIsIG5ld0NoaWxkOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzQXJyYXkkMShuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHJldHVybiBuZXdDaGlsZCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KG5ld0NoaWxkLCByZXR1cm5GaWJlci5pbnRlcm5hbENvbnRleHRUYWcsIGV4cGlyYXRpb25UaW1lLCBudWxsKSwgbmV3Q2hpbGRbInJldHVybiJdID0gcmV0dXJuRmliZXIsIG5ld0NoaWxkOwogICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICB9CgogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgIHZhciBrZXkgPSBudWxsICE9PSBvbGRGaWJlciA/IG9sZEZpYmVyLmtleSA6IG51bGw7CiAgICAgIGlmICgic3RyaW5nIiA9PT0gdHlwZW9mIG5ld0NoaWxkIHx8ICJudW1iZXIiID09PSB0eXBlb2YgbmV3Q2hpbGQpIHJldHVybiBudWxsICE9PSBrZXkgPyBudWxsIDogdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG9sZEZpYmVyLCAiIiArIG5ld0NoaWxkLCBleHBpcmF0aW9uVGltZSk7CgogICAgICBpZiAoIm9iamVjdCIgPT09IHR5cGVvZiBuZXdDaGlsZCAmJiBudWxsICE9PSBuZXdDaGlsZCkgewogICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICByZXR1cm4gbmV3Q2hpbGQua2V5ID09PSBrZXkgPyBuZXdDaGlsZC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFID8gdXBkYXRlRnJhZ21lbnQocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZC5wcm9wcy5jaGlsZHJlbiwgZXhwaXJhdGlvblRpbWUsIGtleSkgOiB1cGRhdGVFbGVtZW50KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKSA6IG51bGw7CgogICAgICAgICAgY2FzZSBSRUFDVF9DQUxMX1RZUEU6CiAgICAgICAgICAgIHJldHVybiBuZXdDaGlsZC5rZXkgPT09IGtleSA/IHVwZGF0ZUNhbGwocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpIDogbnVsbDsKCiAgICAgICAgICBjYXNlIFJFQUNUX1JFVFVSTl9UWVBFOgogICAgICAgICAgICByZXR1cm4gbnVsbCA9PT0ga2V5ID8gdXBkYXRlUmV0dXJuKHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKSA6IG51bGw7CgogICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgcmV0dXJuIG5ld0NoaWxkLmtleSA9PT0ga2V5ID8gdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKSA6IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNBcnJheSQxKG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgcmV0dXJuIG51bGwgIT09IGtleSA/IG51bGwgOiB1cGRhdGVGcmFnbWVudChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBleHBpcmF0aW9uVGltZSwgbnVsbCk7CiAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgIGlmICgic3RyaW5nIiA9PT0gdHlwZW9mIG5ld0NoaWxkIHx8ICJudW1iZXIiID09PSB0eXBlb2YgbmV3Q2hpbGQpIHJldHVybiBleGlzdGluZ0NoaWxkcmVuID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3SWR4KSB8fCBudWxsLCB1cGRhdGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgZXhpc3RpbmdDaGlsZHJlbiwgIiIgKyBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpOwoKICAgICAgaWYgKCJvYmplY3QiID09PSB0eXBlb2YgbmV3Q2hpbGQgJiYgbnVsbCAhPT0gbmV3Q2hpbGQpIHsKICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nQ2hpbGRyZW4gPSBleGlzdGluZ0NoaWxkcmVuLmdldChudWxsID09PSBuZXdDaGlsZC5rZXkgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGwsIG5ld0NoaWxkLnR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgPyB1cGRhdGVGcmFnbWVudChyZXR1cm5GaWJlciwgZXhpc3RpbmdDaGlsZHJlbiwgbmV3Q2hpbGQucHJvcHMuY2hpbGRyZW4sIGV4cGlyYXRpb25UaW1lLCBuZXdDaGlsZC5rZXkpIDogdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgZXhpc3RpbmdDaGlsZHJlbiwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICBjYXNlIFJFQUNUX0NBTExfVFlQRToKICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nQ2hpbGRyZW4gPSBleGlzdGluZ0NoaWxkcmVuLmdldChudWxsID09PSBuZXdDaGlsZC5rZXkgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGwsIHVwZGF0ZUNhbGwocmV0dXJuRmliZXIsIGV4aXN0aW5nQ2hpbGRyZW4sIG5ld0NoaWxkLCBleHBpcmF0aW9uVGltZSk7CgogICAgICAgICAgY2FzZSBSRUFDVF9SRVRVUk5fVFlQRToKICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nQ2hpbGRyZW4gPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdJZHgpIHx8IG51bGwsIHVwZGF0ZVJldHVybihyZXR1cm5GaWJlciwgZXhpc3RpbmdDaGlsZHJlbiwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICByZXR1cm4gZXhpc3RpbmdDaGlsZHJlbiA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG51bGwgPT09IG5ld0NoaWxkLmtleSA/IG5ld0lkeCA6IG5ld0NoaWxkLmtleSkgfHwgbnVsbCwgdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBleGlzdGluZ0NoaWxkcmVuLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzQXJyYXkkMShuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHJldHVybiBleGlzdGluZ0NoaWxkcmVuID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3SWR4KSB8fCBudWxsLCB1cGRhdGVGcmFnbWVudChyZXR1cm5GaWJlciwgZXhpc3RpbmdDaGlsZHJlbiwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lLCBudWxsKTsKICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5BcnJheShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuLCBleHBpcmF0aW9uVGltZSkgewogICAgICBmb3IgKHZhciByZXN1bHRpbmdGaXJzdENoaWxkID0gbnVsbCwgcHJldmlvdXNOZXdGaWJlciA9IG51bGwsIG9sZEZpYmVyID0gY3VycmVudEZpcnN0Q2hpbGQsIG5ld0lkeCA9IGN1cnJlbnRGaXJzdENoaWxkID0gMCwgbmV4dE9sZEZpYmVyID0gbnVsbDsgbnVsbCAhPT0gb2xkRmliZXIgJiYgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgIG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4ID8gKG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLCBvbGRGaWJlciA9IG51bGwpIDogbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICB2YXIgbmV3RmliZXIgPSB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGRyZW5bbmV3SWR4XSwgZXhwaXJhdGlvblRpbWUpOwoKICAgICAgICBpZiAobnVsbCA9PT0gbmV3RmliZXIpIHsKICAgICAgICAgIG51bGwgPT09IG9sZEZpYmVyICYmIChvbGRGaWJlciA9IG5leHRPbGRGaWJlcik7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHNob3VsZFRyYWNrU2lkZUVmZmVjdHMgJiYgb2xkRmliZXIgJiYgbnVsbCA9PT0gbmV3RmliZXIuYWx0ZXJuYXRlICYmIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgY3VycmVudEZpcnN0Q2hpbGQgPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3SWR4KTsKICAgICAgICBudWxsID09PSBwcmV2aW91c05ld0ZpYmVyID8gcmVzdWx0aW5nRmlyc3RDaGlsZCA9IG5ld0ZpYmVyIDogcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IG5ld0ZpYmVyOwogICAgICAgIG9sZEZpYmVyID0gbmV4dE9sZEZpYmVyOwogICAgICB9CgogICAgICBpZiAobmV3SWR4ID09PSBuZXdDaGlsZHJlbi5sZW5ndGgpIHJldHVybiBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpLCByZXN1bHRpbmdGaXJzdENoaWxkOwoKICAgICAgaWYgKG51bGwgPT09IG9sZEZpYmVyKSB7CiAgICAgICAgZm9yICg7IG5ld0lkeCA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgbmV3SWR4KyspIHsKICAgICAgICAgIGlmIChvbGRGaWJlciA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZHJlbltuZXdJZHhdLCBleHBpcmF0aW9uVGltZSkpIGN1cnJlbnRGaXJzdENoaWxkID0gcGxhY2VDaGlsZChvbGRGaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0lkeCksIG51bGwgPT09IHByZXZpb3VzTmV3RmliZXIgPyByZXN1bHRpbmdGaXJzdENoaWxkID0gb2xkRmliZXIgOiBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBvbGRGaWJlciwgcHJldmlvdXNOZXdGaWJlciA9IG9sZEZpYmVyOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgIH0KCiAgICAgIGZvciAob2xkRmliZXIgPSBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOyBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgaWYgKG5leHRPbGRGaWJlciA9IHVwZGF0ZUZyb21NYXAob2xkRmliZXIsIHJldHVybkZpYmVyLCBuZXdJZHgsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGV4cGlyYXRpb25UaW1lKSkgewogICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMgJiYgbnVsbCAhPT0gbmV4dE9sZEZpYmVyLmFsdGVybmF0ZSkgb2xkRmliZXJbImRlbGV0ZSJdKG51bGwgPT09IG5leHRPbGRGaWJlci5rZXkgPyBuZXdJZHggOiBuZXh0T2xkRmliZXIua2V5KTsKICAgICAgICAgIGN1cnJlbnRGaXJzdENoaWxkID0gcGxhY2VDaGlsZChuZXh0T2xkRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdJZHgpOwogICAgICAgICAgbnVsbCA9PT0gcHJldmlvdXNOZXdGaWJlciA/IHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBuZXh0T2xkRmliZXIgOiBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV4dE9sZEZpYmVyOwogICAgICAgIH0KICAgICAgfQoKICAgICAgc2hvdWxkVHJhY2tTaWRlRWZmZWN0cyAmJiBvbGRGaWJlci5mb3JFYWNoKGZ1bmN0aW9uIChjaGlsZCkgewogICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICB9CgogICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuSXRlcmFibGUsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihuZXdDaGlsZHJlbkl0ZXJhYmxlKTsKICAgICAgaW52YXJpYW50KCJmdW5jdGlvbiIgPT09IHR5cGVvZiBpdGVyYXRvckZuLCAiQW4gb2JqZWN0IGlzIG5vdCBhbiBpdGVyYWJsZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgbmV3Q2hpbGRyZW5JdGVyYWJsZSA9IGl0ZXJhdG9yRm4uY2FsbChuZXdDaGlsZHJlbkl0ZXJhYmxlKTsKICAgICAgaW52YXJpYW50KG51bGwgIT0gbmV3Q2hpbGRyZW5JdGVyYWJsZSwgIkFuIGl0ZXJhYmxlIG9iamVjdCBwcm92aWRlZCBubyBpdGVyYXRvci4iKTsKCiAgICAgIGZvciAodmFyIHByZXZpb3VzTmV3RmliZXIgPSBpdGVyYXRvckZuID0gbnVsbCwgb2xkRmliZXIgPSBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3SWR4ID0gY3VycmVudEZpcnN0Q2hpbGQgPSAwLCBuZXh0T2xkRmliZXIgPSBudWxsLCBzdGVwID0gbmV3Q2hpbGRyZW5JdGVyYWJsZS5uZXh0KCk7IG51bGwgIT09IG9sZEZpYmVyICYmICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW5JdGVyYWJsZS5uZXh0KCkpIHsKICAgICAgICBvbGRGaWJlci5pbmRleCA+IG5ld0lkeCA/IChuZXh0T2xkRmliZXIgPSBvbGRGaWJlciwgb2xkRmliZXIgPSBudWxsKSA6IG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLnNpYmxpbmc7CiAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIHN0ZXAudmFsdWUsIGV4cGlyYXRpb25UaW1lKTsKCiAgICAgICAgaWYgKG51bGwgPT09IG5ld0ZpYmVyKSB7CiAgICAgICAgICBvbGRGaWJlciB8fCAob2xkRmliZXIgPSBuZXh0T2xkRmliZXIpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBzaG91bGRUcmFja1NpZGVFZmZlY3RzICYmIG9sZEZpYmVyICYmIG51bGwgPT09IG5ld0ZpYmVyLmFsdGVybmF0ZSAmJiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgIGN1cnJlbnRGaXJzdENoaWxkID0gcGxhY2VDaGlsZChuZXdGaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0lkeCk7CiAgICAgICAgbnVsbCA9PT0gcHJldmlvdXNOZXdGaWJlciA/IGl0ZXJhdG9yRm4gPSBuZXdGaWJlciA6IHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IG5ld0ZpYmVyOwogICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgfQoKICAgICAgaWYgKHN0ZXAuZG9uZSkgcmV0dXJuIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlciksIGl0ZXJhdG9yRm47CgogICAgICBpZiAobnVsbCA9PT0gb2xkRmliZXIpIHsKICAgICAgICBmb3IgKDsgIXN0ZXAuZG9uZTsgbmV3SWR4KyssIHN0ZXAgPSBuZXdDaGlsZHJlbkl0ZXJhYmxlLm5leHQoKSkgewogICAgICAgICAgc3RlcCA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBzdGVwLnZhbHVlLCBleHBpcmF0aW9uVGltZSksIG51bGwgIT09IHN0ZXAgJiYgKGN1cnJlbnRGaXJzdENoaWxkID0gcGxhY2VDaGlsZChzdGVwLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3SWR4KSwgbnVsbCA9PT0gcHJldmlvdXNOZXdGaWJlciA/IGl0ZXJhdG9yRm4gPSBzdGVwIDogcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gc3RlcCwgcHJldmlvdXNOZXdGaWJlciA9IHN0ZXApOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGl0ZXJhdG9yRm47CiAgICAgIH0KCiAgICAgIGZvciAob2xkRmliZXIgPSBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOyAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuSXRlcmFibGUubmV4dCgpKSB7CiAgICAgICAgaWYgKHN0ZXAgPSB1cGRhdGVGcm9tTWFwKG9sZEZpYmVyLCByZXR1cm5GaWJlciwgbmV3SWR4LCBzdGVwLnZhbHVlLCBleHBpcmF0aW9uVGltZSksIG51bGwgIT09IHN0ZXApIHsKICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzICYmIG51bGwgIT09IHN0ZXAuYWx0ZXJuYXRlKSBvbGRGaWJlclsiZGVsZXRlIl0obnVsbCA9PT0gc3RlcC5rZXkgPyBuZXdJZHggOiBzdGVwLmtleSk7CiAgICAgICAgICBjdXJyZW50Rmlyc3RDaGlsZCA9IHBsYWNlQ2hpbGQoc3RlcCwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0lkeCk7CiAgICAgICAgICBudWxsID09PSBwcmV2aW91c05ld0ZpYmVyID8gaXRlcmF0b3JGbiA9IHN0ZXAgOiBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBzdGVwOwogICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IHN0ZXA7CiAgICAgICAgfQogICAgICB9CgogICAgICBzaG91bGRUcmFja1NpZGVFZmZlY3RzICYmIG9sZEZpYmVyLmZvckVhY2goZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgcmV0dXJuIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgIH0pOwogICAgICByZXR1cm4gaXRlcmF0b3JGbjsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgICJvYmplY3QiID09PSB0eXBlb2YgbmV3Q2hpbGQgJiYgbnVsbCAhPT0gbmV3Q2hpbGQgJiYgbmV3Q2hpbGQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSAmJiBudWxsID09PSBuZXdDaGlsZC5rZXkgJiYgKG5ld0NoaWxkID0gbmV3Q2hpbGQucHJvcHMuY2hpbGRyZW4pOwogICAgICB2YXIgaXNPYmplY3QgPSAib2JqZWN0IiA9PT0gdHlwZW9mIG5ld0NoaWxkICYmIG51bGwgIT09IG5ld0NoaWxkOwogICAgICBpZiAoaXNPYmplY3QpIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgIGE6IHsKICAgICAgICAgICAgdmFyIGtleSA9IG5ld0NoaWxkLmtleTsKCiAgICAgICAgICAgIGZvciAoaXNPYmplY3QgPSBjdXJyZW50Rmlyc3RDaGlsZDsgbnVsbCAhPT0gaXNPYmplY3Q7KSB7CiAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0LmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICBpZiAoMTAgPT09IGlzT2JqZWN0LnRhZyA/IG5ld0NoaWxkLnR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgOiBpc09iamVjdC50eXBlID09PSBuZXdDaGlsZC50eXBlKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBpc09iamVjdC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgY3VycmVudEZpcnN0Q2hpbGQgPSB1c2VGaWJlcihpc09iamVjdCwgbmV3Q2hpbGQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSA/IG5ld0NoaWxkLnByb3BzLmNoaWxkcmVuIDogbmV3Q2hpbGQucHJvcHMsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgICAgICAgY3VycmVudEZpcnN0Q2hpbGQucmVmID0gY29lcmNlUmVmKGlzT2JqZWN0LCBuZXdDaGlsZCk7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRGaXJzdENoaWxkWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICAgICAgICBicmVhayBhOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGlzT2JqZWN0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBpc09iamVjdCk7CiAgICAgICAgICAgICAgaXNPYmplY3QgPSBpc09iamVjdC5zaWJsaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdDaGlsZC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFID8gKGN1cnJlbnRGaXJzdENoaWxkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQobmV3Q2hpbGQucHJvcHMuY2hpbGRyZW4sIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUsIG5ld0NoaWxkLmtleSksIGN1cnJlbnRGaXJzdENoaWxkWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyLCByZXR1cm5GaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkKSA6IChleHBpcmF0aW9uVGltZSA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQobmV3Q2hpbGQsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpLCBleHBpcmF0aW9uVGltZS5yZWYgPSBjb2VyY2VSZWYoY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkKSwgZXhwaXJhdGlvblRpbWVbInJldHVybiJdID0gcmV0dXJuRmliZXIsIHJldHVybkZpYmVyID0gZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJldHVybkZpYmVyKTsKCiAgICAgICAgY2FzZSBSRUFDVF9DQUxMX1RZUEU6CiAgICAgICAgICBhOiB7CiAgICAgICAgICAgIGZvciAoaXNPYmplY3QgPSBuZXdDaGlsZC5rZXk7IG51bGwgIT09IGN1cnJlbnRGaXJzdENoaWxkOykgewogICAgICAgICAgICAgIGlmIChjdXJyZW50Rmlyc3RDaGlsZC5rZXkgPT09IGlzT2JqZWN0KSB7CiAgICAgICAgICAgICAgICBpZiAoNyA9PT0gY3VycmVudEZpcnN0Q2hpbGQudGFnKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgY3VycmVudEZpcnN0Q2hpbGQgPSB1c2VGaWJlcihjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgICAgICAgY3VycmVudEZpcnN0Q2hpbGRbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGE7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgICAgICBjdXJyZW50Rmlyc3RDaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN1cnJlbnRGaXJzdENoaWxkID0gY3JlYXRlRmliZXJGcm9tQ2FsbChuZXdDaGlsZCwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgIGN1cnJlbnRGaXJzdENoaWxkWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm5GaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJldHVybkZpYmVyKTsKCiAgICAgICAgY2FzZSBSRUFDVF9SRVRVUk5fVFlQRToKICAgICAgICAgIGE6IHsKICAgICAgICAgICAgaWYgKG51bGwgIT09IGN1cnJlbnRGaXJzdENoaWxkKSBpZiAoOSA9PT0gY3VycmVudEZpcnN0Q2hpbGQudGFnKSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgIGN1cnJlbnRGaXJzdENoaWxkID0gdXNlRmliZXIoY3VycmVudEZpcnN0Q2hpbGQsIG51bGwsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgICAgICAgICBjdXJyZW50Rmlyc3RDaGlsZC50eXBlID0gbmV3Q2hpbGQudmFsdWU7CiAgICAgICAgICAgICAgY3VycmVudEZpcnN0Q2hpbGRbInJldHVybiJdID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgICBicmVhayBhOwogICAgICAgICAgICB9IGVsc2UgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgICAgY3VycmVudEZpcnN0Q2hpbGQgPSBjcmVhdGVGaWJlckZyb21SZXR1cm4obmV3Q2hpbGQsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICBjdXJyZW50Rmlyc3RDaGlsZC50eXBlID0gbmV3Q2hpbGQudmFsdWU7CiAgICAgICAgICAgIGN1cnJlbnRGaXJzdENoaWxkWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm5GaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJldHVybkZpYmVyKTsKCiAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgIGE6IHsKICAgICAgICAgICAgZm9yIChpc09iamVjdCA9IG5ld0NoaWxkLmtleTsgbnVsbCAhPT0gY3VycmVudEZpcnN0Q2hpbGQ7KSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRGaXJzdENoaWxkLmtleSA9PT0gaXNPYmplY3QpIHsKICAgICAgICAgICAgICAgIGlmICg0ID09PSBjdXJyZW50Rmlyc3RDaGlsZC50YWcgJiYgY3VycmVudEZpcnN0Q2hpbGQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gPT09IG5ld0NoaWxkLmNvbnRhaW5lckluZm8gJiYgY3VycmVudEZpcnN0Q2hpbGQuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uID09PSBuZXdDaGlsZC5pbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRGaXJzdENoaWxkID0gdXNlRmliZXIoY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLmNoaWxkcmVuIHx8IFtdLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRGaXJzdENoaWxkWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICAgICAgICBicmVhayBhOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgY3VycmVudEZpcnN0Q2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdXJyZW50Rmlyc3RDaGlsZCA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChuZXdDaGlsZCwgcmV0dXJuRmliZXIuaW50ZXJuYWxDb250ZXh0VGFnLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgIGN1cnJlbnRGaXJzdENoaWxkWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm5GaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJldHVybkZpYmVyKTsKICAgICAgfQogICAgICBpZiAoInN0cmluZyIgPT09IHR5cGVvZiBuZXdDaGlsZCB8fCAibnVtYmVyIiA9PT0gdHlwZW9mIG5ld0NoaWxkKSByZXR1cm4gbmV3Q2hpbGQgPSAiIiArIG5ld0NoaWxkLCBudWxsICE9PSBjdXJyZW50Rmlyc3RDaGlsZCAmJiA2ID09PSBjdXJyZW50Rmlyc3RDaGlsZC50YWcgPyAoZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLnNpYmxpbmcpLCBjdXJyZW50Rmlyc3RDaGlsZCA9IHVzZUZpYmVyKGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpKSA6IChkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpLCBjdXJyZW50Rmlyc3RDaGlsZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQobmV3Q2hpbGQsIHJldHVybkZpYmVyLmludGVybmFsQ29udGV4dFRhZywgZXhwaXJhdGlvblRpbWUpKSwgY3VycmVudEZpcnN0Q2hpbGRbInJldHVybiJdID0gcmV0dXJuRmliZXIsIHJldHVybkZpYmVyID0gY3VycmVudEZpcnN0Q2hpbGQsIHBsYWNlU2luZ2xlQ2hpbGQocmV0dXJuRmliZXIpOwogICAgICBpZiAoaXNBcnJheSQxKG5ld0NoaWxkKSkgcmV0dXJuIHJlY29uY2lsZUNoaWxkcmVuQXJyYXkocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgZXhwaXJhdGlvblRpbWUpOwogICAgICBpZiAoZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHJldHVybiByZWNvbmNpbGVDaGlsZHJlbkl0ZXJhdG9yKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGV4cGlyYXRpb25UaW1lKTsKICAgICAgaXNPYmplY3QgJiYgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgIGlmICgidW5kZWZpbmVkIiA9PT0gdHlwZW9mIG5ld0NoaWxkKSBzd2l0Y2ggKHJldHVybkZpYmVyLnRhZykgewogICAgICAgIGNhc2UgMjoKICAgICAgICBjYXNlIDE6CiAgICAgICAgICBleHBpcmF0aW9uVGltZSA9IHJldHVybkZpYmVyLnR5cGUsIGludmFyaWFudCghMSwgIiVzKC4uLik6IE5vdGhpbmcgd2FzIHJldHVybmVkIGZyb20gcmVuZGVyLiBUaGlzIHVzdWFsbHkgbWVhbnMgYSByZXR1cm4gc3RhdGVtZW50IGlzIG1pc3NpbmcuIE9yLCB0byByZW5kZXIgbm90aGluZywgcmV0dXJuIG51bGwuIiwgZXhwaXJhdGlvblRpbWUuZGlzcGxheU5hbWUgfHwgZXhwaXJhdGlvblRpbWUubmFtZSB8fCAiQ29tcG9uZW50Iik7CiAgICAgIH0KICAgICAgcmV0dXJuIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCk7CiAgICB9OwogIH0KCiAgdmFyIHJlY29uY2lsZUNoaWxkRmliZXJzID0gQ2hpbGRSZWNvbmNpbGVyKCEwKSwKICAgICAgbW91bnRDaGlsZEZpYmVycyA9IENoaWxkUmVjb25jaWxlcighMSk7CgogIGZ1bmN0aW9uIFJlYWN0RmliZXJCZWdpbldvcmsoY29uZmlnLCBob3N0Q29udGV4dCwgaHlkcmF0aW9uQ29udGV4dCwgc2NoZWR1bGVXb3JrLCBjb21wdXRlRXhwaXJhdGlvbkZvckZpYmVyKSB7CiAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgbmV4dENoaWxkcmVuKSB7CiAgICAgIHZhciByZW5kZXJFeHBpcmF0aW9uVGltZSA9IHdvcmtJblByb2dyZXNzLmV4cGlyYXRpb25UaW1lOwogICAgICB3b3JrSW5Qcm9ncmVzcy5jaGlsZCA9IG51bGwgPT09IGN1cnJlbnQgPyBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckV4cGlyYXRpb25UaW1lKSA6IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzLCBjdXJyZW50LmNoaWxkLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckV4cGlyYXRpb25UaW1lKTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYXJrUmVmKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzKSB7CiAgICAgIHZhciByZWYgPSB3b3JrSW5Qcm9ncmVzcy5yZWY7CiAgICAgIG51bGwgPT09IHJlZiB8fCBjdXJyZW50ICYmIGN1cnJlbnQucmVmID09PSByZWYgfHwgKHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyB8PSAxMjgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBzaG91bGRVcGRhdGUsIGhhc0NvbnRleHQpIHsKICAgICAgbWFya1JlZihjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgIGlmICghc2hvdWxkVXBkYXRlKSByZXR1cm4gaGFzQ29udGV4dCAmJiBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzLCAhMSksIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MpOwogICAgICBzaG91bGRVcGRhdGUgPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGU7CiAgICAgIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgZGVidWdSZW5kZXJQaGFzZVNpZGVFZmZlY3RzICYmIHNob3VsZFVwZGF0ZS5yZW5kZXIoKTsKICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IHNob3VsZFVwZGF0ZS5yZW5kZXIoKTsKICAgICAgd29ya0luUHJvZ3Jlc3MuZWZmZWN0VGFnIHw9IDE7CiAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBuZXh0Q2hpbGRyZW4pOwogICAgICB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFN0YXRlID0gc2hvdWxkVXBkYXRlLnN0YXRlOwogICAgICB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFByb3BzID0gc2hvdWxkVXBkYXRlLnByb3BzOwogICAgICBoYXNDb250ZXh0ICYmIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MsICEwKTsKICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzLmNoaWxkOwogICAgfQoKICAgIGZ1bmN0aW9uIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MpIHsKICAgICAgdmFyIHJvb3QgPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGU7CiAgICAgIHJvb3QucGVuZGluZ0NvbnRleHQgPyBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KHdvcmtJblByb2dyZXNzLCByb290LnBlbmRpbmdDb250ZXh0LCByb290LnBlbmRpbmdDb250ZXh0ICE9PSByb290LmNvbnRleHQpIDogcm9vdC5jb250ZXh0ICYmIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MsIHJvb3QuY29udGV4dCwgITEpOwogICAgICBwdXNoSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzcywgcm9vdC5jb250YWluZXJJbmZvKTsKICAgIH0KCiAgICBmdW5jdGlvbiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzKSB7CiAgICAgIGludmFyaWFudChudWxsID09PSBjdXJyZW50IHx8IHdvcmtJblByb2dyZXNzLmNoaWxkID09PSBjdXJyZW50LmNoaWxkLCAiUmVzdW1pbmcgd29yayBub3QgeWV0IGltcGxlbWVudGVkLiIpOwoKICAgICAgaWYgKG51bGwgIT09IHdvcmtJblByb2dyZXNzLmNoaWxkKSB7CiAgICAgICAgY3VycmVudCA9IHdvcmtJblByb2dyZXNzLmNoaWxkOwogICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnQsIGN1cnJlbnQucGVuZGluZ1Byb3BzLCBjdXJyZW50LmV4cGlyYXRpb25UaW1lKTsKICAgICAgICB3b3JrSW5Qcm9ncmVzcy5jaGlsZCA9IG5ld0NoaWxkOwoKICAgICAgICBmb3IgKG5ld0NoaWxkWyJyZXR1cm4iXSA9IHdvcmtJblByb2dyZXNzOyBudWxsICE9PSBjdXJyZW50LnNpYmxpbmc7KSB7CiAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC5zaWJsaW5nLCBuZXdDaGlsZCA9IG5ld0NoaWxkLnNpYmxpbmcgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50LCBjdXJyZW50LnBlbmRpbmdQcm9wcywgY3VycmVudC5leHBpcmF0aW9uVGltZSksIG5ld0NoaWxkWyJyZXR1cm4iXSA9IHdvcmtJblByb2dyZXNzOwogICAgICAgIH0KCiAgICAgICAgbmV3Q2hpbGQuc2libGluZyA9IG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzcy5jaGlsZDsKICAgIH0KCiAgICBmdW5jdGlvbiBiYWlsb3V0T25Mb3dQcmlvcml0eShjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcykgewogICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzLnRhZykgewogICAgICAgIGNhc2UgMzoKICAgICAgICAgIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgMjoKICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgNDoKICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzLCB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHZhciBzaG91bGRTZXRUZXh0Q29udGVudCA9IGNvbmZpZy5zaG91bGRTZXRUZXh0Q29udGVudCwKICAgICAgICB1c2VTeW5jU2NoZWR1bGluZyA9IGNvbmZpZy51c2VTeW5jU2NoZWR1bGluZywKICAgICAgICBzaG91bGREZXByaW9yaXRpemVTdWJ0cmVlID0gY29uZmlnLnNob3VsZERlcHJpb3JpdGl6ZVN1YnRyZWUsCiAgICAgICAgcHVzaEhvc3RDb250ZXh0ID0gaG9zdENvbnRleHQucHVzaEhvc3RDb250ZXh0LAogICAgICAgIHB1c2hIb3N0Q29udGFpbmVyID0gaG9zdENvbnRleHQucHVzaEhvc3RDb250YWluZXIsCiAgICAgICAgZW50ZXJIeWRyYXRpb25TdGF0ZSA9IGh5ZHJhdGlvbkNvbnRleHQuZW50ZXJIeWRyYXRpb25TdGF0ZSwKICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlID0gaHlkcmF0aW9uQ29udGV4dC5yZXNldEh5ZHJhdGlvblN0YXRlLAogICAgICAgIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gaHlkcmF0aW9uQ29udGV4dC50cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZTsKICAgIGNvbmZpZyA9IFJlYWN0RmliZXJDbGFzc0NvbXBvbmVudChzY2hlZHVsZVdvcmssIGNvbXB1dGVFeHBpcmF0aW9uRm9yRmliZXIsIGZ1bmN0aW9uICh3b3JrSW5Qcm9ncmVzcywgbmV4dFByb3BzKSB7CiAgICAgIHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHMgPSBuZXh0UHJvcHM7CiAgICB9LCBmdW5jdGlvbiAod29ya0luUHJvZ3Jlc3MsIG5leHRTdGF0ZSkgewogICAgICB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFN0YXRlID0gbmV4dFN0YXRlOwogICAgfSk7CiAgICB2YXIgYWRvcHRDbGFzc0luc3RhbmNlID0gY29uZmlnLmFkb3B0Q2xhc3NJbnN0YW5jZSwKICAgICAgICBjb25zdHJ1Y3RDbGFzc0luc3RhbmNlID0gY29uZmlnLmNvbnN0cnVjdENsYXNzSW5zdGFuY2UsCiAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlID0gY29uZmlnLm1vdW50Q2xhc3NJbnN0YW5jZSwKICAgICAgICB1cGRhdGVDbGFzc0luc3RhbmNlID0gY29uZmlnLnVwZGF0ZUNsYXNzSW5zdGFuY2U7CiAgICByZXR1cm4gewogICAgICBiZWdpbldvcms6IGZ1bmN0aW9uIGJlZ2luV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgcmVuZGVyRXhwaXJhdGlvblRpbWUpIHsKICAgICAgICBpZiAoMCA9PT0gd29ya0luUHJvZ3Jlc3MuZXhwaXJhdGlvblRpbWUgfHwgd29ya0luUHJvZ3Jlc3MuZXhwaXJhdGlvblRpbWUgPiByZW5kZXJFeHBpcmF0aW9uVGltZSkgcmV0dXJuIGJhaWxvdXRPbkxvd1ByaW9yaXR5KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzKTsKCiAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzcy50YWcpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgaW52YXJpYW50KG51bGwgPT09IGN1cnJlbnQsICJBbiBpbmRldGVybWluYXRlIGNvbXBvbmVudCBzaG91bGQgbmV2ZXIgaGF2ZSBtb3VudGVkLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB2YXIgZm4gPSB3b3JrSW5Qcm9ncmVzcy50eXBlLAogICAgICAgICAgICAgICAgcHJvcHMgPSB3b3JrSW5Qcm9ncmVzcy5wZW5kaW5nUHJvcHMsCiAgICAgICAgICAgICAgICB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICB1bm1hc2tlZENvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzLCB1bm1hc2tlZENvbnRleHQpOwogICAgICAgICAgICBmbiA9IGZuKHByb3BzLCB1bm1hc2tlZENvbnRleHQpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5lZmZlY3RUYWcgfD0gMTsKICAgICAgICAgICAgIm9iamVjdCIgPT09IHR5cGVvZiBmbiAmJiBudWxsICE9PSBmbiAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgZm4ucmVuZGVyID8gKHdvcmtJblByb2dyZXNzLnRhZyA9IDIsIHByb3BzID0gcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzcyksIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzcywgZm4pLCBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKSwgY3VycmVudCA9IGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCAhMCwgcHJvcHMpKSA6ICh3b3JrSW5Qcm9ncmVzcy50YWcgPSAxLCByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgZm4pLCB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFByb3BzID0gcHJvcHMsIGN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzcy5jaGlsZCk7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50OwoKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgcmV0dXJuIHByb3BzID0gd29ya0luUHJvZ3Jlc3MudHlwZSwgcmVuZGVyRXhwaXJhdGlvblRpbWUgPSB3b3JrSW5Qcm9ncmVzcy5wZW5kaW5nUHJvcHMsIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudCB8fCB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFByb3BzICE9PSByZW5kZXJFeHBpcmF0aW9uVGltZSA/IChmbiA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzcyksIGZuID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzcywgZm4pLCBwcm9wcyA9IHByb3BzKHJlbmRlckV4cGlyYXRpb25UaW1lLCBmbiksIHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyB8PSAxLCByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgcHJvcHMpLCB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFByb3BzID0gcmVuZGVyRXhwaXJhdGlvblRpbWUsIGN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzcy5jaGlsZCkgOiBjdXJyZW50ID0gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyksIGN1cnJlbnQ7CgogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gcHJvcHMgPSBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzKSwgZm4gPSB2b2lkIDAsIG51bGwgPT09IGN1cnJlbnQgPyB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUgPyBpbnZhcmlhbnQoITEsICJSZXN1bWluZyB3b3JrIG5vdCB5ZXQgaW1wbGVtZW50ZWQuIikgOiAoY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzcywgd29ya0luUHJvZ3Jlc3MucGVuZGluZ1Byb3BzKSwgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzLCByZW5kZXJFeHBpcmF0aW9uVGltZSksIGZuID0gITApIDogZm4gPSB1cGRhdGVDbGFzc0luc3RhbmNlKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCByZW5kZXJFeHBpcmF0aW9uVGltZSksIGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBmbiwgcHJvcHMpOwoKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgcmV0dXJuIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MpLCBwcm9wcyA9IHdvcmtJblByb2dyZXNzLnVwZGF0ZVF1ZXVlLCBudWxsICE9PSBwcm9wcyA/IChmbiA9IHdvcmtJblByb2dyZXNzLm1lbW9pemVkU3RhdGUsIHByb3BzID0gcHJvY2Vzc1VwZGF0ZVF1ZXVlKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBwcm9wcywgbnVsbCwgbnVsbCwgcmVuZGVyRXhwaXJhdGlvblRpbWUpLCBmbiA9PT0gcHJvcHMgPyAocmVzZXRIeWRyYXRpb25TdGF0ZSgpLCBjdXJyZW50ID0gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcykpIDogKGZuID0gcHJvcHMuZWxlbWVudCwgdW5tYXNrZWRDb250ZXh0ID0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlLCAobnVsbCA9PT0gY3VycmVudCB8fCBudWxsID09PSBjdXJyZW50LmNoaWxkKSAmJiB1bm1hc2tlZENvbnRleHQuaHlkcmF0ZSAmJiBlbnRlckh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzKSA/ICh3b3JrSW5Qcm9ncmVzcy5lZmZlY3RUYWcgfD0gMiwgd29ya0luUHJvZ3Jlc3MuY2hpbGQgPSBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzLCBudWxsLCBmbiwgcmVuZGVyRXhwaXJhdGlvblRpbWUpKSA6IChyZXNldEh5ZHJhdGlvblN0YXRlKCksIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBmbikpLCB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFN0YXRlID0gcHJvcHMsIGN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzcy5jaGlsZCkpIDogKHJlc2V0SHlkcmF0aW9uU3RhdGUoKSwgY3VycmVudCA9IGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MpKSwgY3VycmVudDsKCiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIHB1c2hIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgIG51bGwgPT09IGN1cnJlbnQgJiYgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICBwcm9wcyA9IHdvcmtJblByb2dyZXNzLnR5cGU7CiAgICAgICAgICAgIHZhciBtZW1vaXplZFByb3BzID0gd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgZm4gPSB3b3JrSW5Qcm9ncmVzcy5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIHVubWFza2VkQ29udGV4dCA9IG51bGwgIT09IGN1cnJlbnQgPyBjdXJyZW50Lm1lbW9pemVkUHJvcHMgOiBudWxsOwogICAgICAgICAgICBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQgfHwgbWVtb2l6ZWRQcm9wcyAhPT0gZm4gPyAobWVtb2l6ZWRQcm9wcyA9IGZuLmNoaWxkcmVuLCBzaG91bGRTZXRUZXh0Q29udGVudChwcm9wcywgZm4pID8gbWVtb2l6ZWRQcm9wcyA9IG51bGwgOiB1bm1hc2tlZENvbnRleHQgJiYgc2hvdWxkU2V0VGV4dENvbnRlbnQocHJvcHMsIHVubWFza2VkQ29udGV4dCkgJiYgKHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyB8PSAxNiksIG1hcmtSZWYoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MpLCAyMTQ3NDgzNjQ3ICE9PSByZW5kZXJFeHBpcmF0aW9uVGltZSAmJiAhdXNlU3luY1NjaGVkdWxpbmcgJiYgc2hvdWxkRGVwcmlvcml0aXplU3VidHJlZShwcm9wcywgZm4pID8gKHdvcmtJblByb2dyZXNzLmV4cGlyYXRpb25UaW1lID0gMjE0NzQ4MzY0NywgY3VycmVudCA9IG51bGwpIDogKHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBtZW1vaXplZFByb3BzKSwgd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRQcm9wcyA9IGZuLCBjdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MuY2hpbGQpKSA6IGN1cnJlbnQgPSBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CgogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICByZXR1cm4gbnVsbCA9PT0gY3VycmVudCAmJiB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzcyksIHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzcy5wZW5kaW5nUHJvcHMsIG51bGw7CgogICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy50YWcgPSA3OwoKICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgcmV0dXJuIHByb3BzID0gd29ya0luUHJvZ3Jlc3MucGVuZGluZ1Byb3BzLCBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQgfHwgd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRQcm9wcyAhPT0gcHJvcHMgfHwgKHByb3BzID0gd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRQcm9wcyksIGZuID0gcHJvcHMuY2hpbGRyZW4sIHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZSA9IG51bGwgPT09IGN1cnJlbnQgPyBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzLCB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUsIGZuLCByZW5kZXJFeHBpcmF0aW9uVGltZSkgOiByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzcywgd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlLCBmbiwgcmVuZGVyRXhwaXJhdGlvblRpbWUpLCB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFByb3BzID0gcHJvcHMsIHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZTsKCiAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgIHJldHVybiBudWxsOwoKICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgcmV0dXJuIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzLCB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyksIHByb3BzID0gd29ya0luUHJvZ3Jlc3MucGVuZGluZ1Byb3BzLCBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQgfHwgd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRQcm9wcyAhPT0gcHJvcHMgPyAobnVsbCA9PT0gY3VycmVudCA/IHdvcmtJblByb2dyZXNzLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MsIG51bGwsIHByb3BzLCByZW5kZXJFeHBpcmF0aW9uVGltZSkgOiByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgcHJvcHMpLCB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFByb3BzID0gcHJvcHMsIGN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzcy5jaGlsZCkgOiBjdXJyZW50ID0gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyksIGN1cnJlbnQ7CgogICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgcmV0dXJuIHJlbmRlckV4cGlyYXRpb25UaW1lID0gd29ya0luUHJvZ3Jlc3MucGVuZGluZ1Byb3BzLCBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQgfHwgbnVsbCAhPT0gcmVuZGVyRXhwaXJhdGlvblRpbWUgJiYgd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRQcm9wcyAhPT0gcmVuZGVyRXhwaXJhdGlvblRpbWUgPyAocmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudCwgd29ya0luUHJvZ3Jlc3MsIHJlbmRlckV4cGlyYXRpb25UaW1lKSwgd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRQcm9wcyA9IHJlbmRlckV4cGlyYXRpb25UaW1lLCBjdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MuY2hpbGQpIDogY3VycmVudCA9IGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudCwgd29ya0luUHJvZ3Jlc3MpLCBjdXJyZW50OwoKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGludmFyaWFudCghMSwgIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGJlZ2luRmFpbGVkV29yazogZnVuY3Rpb24gYmVnaW5GYWlsZWRXb3JrKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCByZW5kZXJFeHBpcmF0aW9uVGltZSkgewogICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MudGFnKSB7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBpbnZhcmlhbnQoITEsICJJbnZhbGlkIHR5cGUgb2Ygd29yay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CgogICAgICAgIHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyB8PSA2NDsKICAgICAgICBudWxsID09PSBjdXJyZW50ID8gd29ya0luUHJvZ3Jlc3MuY2hpbGQgPSBudWxsIDogd29ya0luUHJvZ3Jlc3MuY2hpbGQgIT09IGN1cnJlbnQuY2hpbGQgJiYgKHdvcmtJblByb2dyZXNzLmNoaWxkID0gY3VycmVudC5jaGlsZCk7CiAgICAgICAgaWYgKDAgPT09IHdvcmtJblByb2dyZXNzLmV4cGlyYXRpb25UaW1lIHx8IHdvcmtJblByb2dyZXNzLmV4cGlyYXRpb25UaW1lID4gcmVuZGVyRXhwaXJhdGlvblRpbWUpIHJldHVybiBiYWlsb3V0T25Mb3dQcmlvcml0eShjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgd29ya0luUHJvZ3Jlc3MuZmlyc3RFZmZlY3QgPSBudWxsOwogICAgICAgIHdvcmtJblByb2dyZXNzLmxhc3RFZmZlY3QgPSBudWxsOwogICAgICAgIHdvcmtJblByb2dyZXNzLmNoaWxkID0gbnVsbCA9PT0gY3VycmVudCA/IG1vdW50Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MsIG51bGwsIG51bGwsIHJlbmRlckV4cGlyYXRpb25UaW1lKSA6IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzLCBjdXJyZW50LmNoaWxkLCBudWxsLCByZW5kZXJFeHBpcmF0aW9uVGltZSk7CiAgICAgICAgMiA9PT0gd29ya0luUHJvZ3Jlc3MudGFnICYmIChjdXJyZW50ID0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlLCB3b3JrSW5Qcm9ncmVzcy5tZW1vaXplZFByb3BzID0gY3VycmVudC5wcm9wcywgd29ya0luUHJvZ3Jlc3MubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQuc3RhdGUpOwogICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzcy5jaGlsZDsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIFJlYWN0RmliZXJDb21wbGV0ZVdvcmsoY29uZmlnLCBob3N0Q29udGV4dCwgaHlkcmF0aW9uQ29udGV4dCkgewogICAgZnVuY3Rpb24gbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzcykgewogICAgICB3b3JrSW5Qcm9ncmVzcy5lZmZlY3RUYWcgfD0gNDsKICAgIH0KCiAgICB2YXIgY3JlYXRlSW5zdGFuY2UgPSBjb25maWcuY3JlYXRlSW5zdGFuY2UsCiAgICAgICAgY3JlYXRlVGV4dEluc3RhbmNlID0gY29uZmlnLmNyZWF0ZVRleHRJbnN0YW5jZSwKICAgICAgICBhcHBlbmRJbml0aWFsQ2hpbGQgPSBjb25maWcuYXBwZW5kSW5pdGlhbENoaWxkLAogICAgICAgIGZpbmFsaXplSW5pdGlhbENoaWxkcmVuID0gY29uZmlnLmZpbmFsaXplSW5pdGlhbENoaWxkcmVuLAogICAgICAgIHByZXBhcmVVcGRhdGUgPSBjb25maWcucHJlcGFyZVVwZGF0ZSwKICAgICAgICBwZXJzaXN0ZW5jZSA9IGNvbmZpZy5wZXJzaXN0ZW5jZSwKICAgICAgICBnZXRSb290SG9zdENvbnRhaW5lciA9IGhvc3RDb250ZXh0LmdldFJvb3RIb3N0Q29udGFpbmVyLAogICAgICAgIHBvcEhvc3RDb250ZXh0ID0gaG9zdENvbnRleHQucG9wSG9zdENvbnRleHQsCiAgICAgICAgZ2V0SG9zdENvbnRleHQgPSBob3N0Q29udGV4dC5nZXRIb3N0Q29udGV4dCwKICAgICAgICBwb3BIb3N0Q29udGFpbmVyID0gaG9zdENvbnRleHQucG9wSG9zdENvbnRhaW5lciwKICAgICAgICBwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlID0gaHlkcmF0aW9uQ29udGV4dC5wcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlLAogICAgICAgIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlID0gaHlkcmF0aW9uQ29udGV4dC5wcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZSwKICAgICAgICBwb3BIeWRyYXRpb25TdGF0ZSA9IGh5ZHJhdGlvbkNvbnRleHQucG9wSHlkcmF0aW9uU3RhdGUsCiAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lciA9IHZvaWQgMCwKICAgICAgICB1cGRhdGVIb3N0Q29tcG9uZW50ID0gdm9pZCAwLAogICAgICAgIHVwZGF0ZUhvc3RUZXh0ID0gdm9pZCAwOwogICAgY29uZmlnLm11dGF0aW9uID8gKHVwZGF0ZUhvc3RDb250YWluZXIgPSBmdW5jdGlvbiB1cGRhdGVIb3N0Q29udGFpbmVyKCkge30sIHVwZGF0ZUhvc3RDb21wb25lbnQgPSBmdW5jdGlvbiB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCB1cGRhdGVQYXlsb2FkKSB7CiAgICAgICh3b3JrSW5Qcm9ncmVzcy51cGRhdGVRdWV1ZSA9IHVwZGF0ZVBheWxvYWQpICYmIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MpOwogICAgfSwgdXBkYXRlSG9zdFRleHQgPSBmdW5jdGlvbiB1cGRhdGVIb3N0VGV4dChjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICBvbGRUZXh0ICE9PSBuZXdUZXh0ICYmIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MpOwogICAgfSkgOiBwZXJzaXN0ZW5jZSA/IGludmFyaWFudCghMSwgIlBlcnNpc3RlbnQgcmVjb25jaWxlciBpcyBkaXNhYmxlZC4iKSA6IGludmFyaWFudCghMSwgIk5vb3AgcmVjb25jaWxlciBpcyBkaXNhYmxlZC4iKTsKICAgIHJldHVybiB7CiAgICAgIGNvbXBsZXRlV29yazogZnVuY3Rpb24gY29tcGxldGVXb3JrKGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCByZW5kZXJFeHBpcmF0aW9uVGltZSkgewogICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzLnBlbmRpbmdQcm9wczsKCiAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzcy50YWcpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gcG9wQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzKSwgbnVsbDsKCiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlOwogICAgICAgICAgICBuZXdQcm9wcy5wZW5kaW5nQ29udGV4dCAmJiAobmV3UHJvcHMuY29udGV4dCA9IG5ld1Byb3BzLnBlbmRpbmdDb250ZXh0LCBuZXdQcm9wcy5wZW5kaW5nQ29udGV4dCA9IG51bGwpOwogICAgICAgICAgICBpZiAobnVsbCA9PT0gY3VycmVudCB8fCBudWxsID09PSBjdXJyZW50LmNoaWxkKSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzcyksIHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyAmPSAtMzsKICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwoKICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgcG9wSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MpOwogICAgICAgICAgICByZW5kZXJFeHBpcmF0aW9uVGltZSA9IGdldFJvb3RIb3N0Q29udGFpbmVyKCk7CiAgICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MudHlwZTsKCiAgICAgICAgICAgIGlmIChudWxsICE9PSBjdXJyZW50ICYmIG51bGwgIT0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlKSB7CiAgICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudC5tZW1vaXplZFByb3BzLAogICAgICAgICAgICAgICAgICBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZSwKICAgICAgICAgICAgICAgICAgY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgICBpbnN0YW5jZSA9IHByZXBhcmVVcGRhdGUoaW5zdGFuY2UsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcmVuZGVyRXhwaXJhdGlvblRpbWUsIGN1cnJlbnRIb3N0Q29udGV4dCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcywgaW5zdGFuY2UsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcmVuZGVyRXhwaXJhdGlvblRpbWUpOwogICAgICAgICAgICAgIGN1cnJlbnQucmVmICE9PSB3b3JrSW5Qcm9ncmVzcy5yZWYgJiYgKHdvcmtJblByb2dyZXNzLmVmZmVjdFRhZyB8PSAxMjgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghbmV3UHJvcHMpIHJldHVybiBpbnZhcmlhbnQobnVsbCAhPT0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlLCAiV2UgbXVzdCBoYXZlIG5ldyBwcm9wcyBmb3IgbmV3IG1vdW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKSwgbnVsbDsKICAgICAgICAgICAgICBjdXJyZW50ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgICBpZiAocG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MpKSBwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKHdvcmtJblByb2dyZXNzLCByZW5kZXJFeHBpcmF0aW9uVGltZSwgY3VycmVudCkgJiYgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzcyk7ZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3JlYXRlSW5zdGFuY2UodHlwZSwgbmV3UHJvcHMsIHJlbmRlckV4cGlyYXRpb25UaW1lLCBjdXJyZW50LCB3b3JrSW5Qcm9ncmVzcyk7CgogICAgICAgICAgICAgICAgYTogZm9yIChvbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzLmNoaWxkOyBudWxsICE9PSBvbGRQcm9wczspIHsKICAgICAgICAgICAgICAgICAgaWYgKDUgPT09IG9sZFByb3BzLnRhZyB8fCA2ID09PSBvbGRQcm9wcy50YWcpIGFwcGVuZEluaXRpYWxDaGlsZChjdXJyZW50LCBvbGRQcm9wcy5zdGF0ZU5vZGUpO2Vsc2UgaWYgKDQgIT09IG9sZFByb3BzLnRhZyAmJiBudWxsICE9PSBvbGRQcm9wcy5jaGlsZCkgewogICAgICAgICAgICAgICAgICAgIG9sZFByb3BzLmNoaWxkWyJyZXR1cm4iXSA9IG9sZFByb3BzOwogICAgICAgICAgICAgICAgICAgIG9sZFByb3BzID0gb2xkUHJvcHMuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG9sZFByb3BzID09PSB3b3JrSW5Qcm9ncmVzcykgYnJlYWs7CgogICAgICAgICAgICAgICAgICBmb3IgKDsgbnVsbCA9PT0gb2xkUHJvcHMuc2libGluZzspIHsKICAgICAgICAgICAgICAgICAgICBpZiAobnVsbCA9PT0gb2xkUHJvcHNbInJldHVybiJdIHx8IG9sZFByb3BzWyJyZXR1cm4iXSA9PT0gd29ya0luUHJvZ3Jlc3MpIGJyZWFrIGE7CiAgICAgICAgICAgICAgICAgICAgb2xkUHJvcHMgPSBvbGRQcm9wc1sicmV0dXJuIl07CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIG9sZFByb3BzLnNpYmxpbmdbInJldHVybiJdID0gb2xkUHJvcHNbInJldHVybiJdOwogICAgICAgICAgICAgICAgICBvbGRQcm9wcyA9IG9sZFByb3BzLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZmluYWxpemVJbml0aWFsQ2hpbGRyZW4oY3VycmVudCwgdHlwZSwgbmV3UHJvcHMsIHJlbmRlckV4cGlyYXRpb25UaW1lKSAmJiBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzLnN0YXRlTm9kZSA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG51bGwgIT09IHdvcmtJblByb2dyZXNzLnJlZiAmJiAod29ya0luUHJvZ3Jlc3MuZWZmZWN0VGFnIHw9IDEyOCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBudWxsOwoKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgaWYgKGN1cnJlbnQgJiYgbnVsbCAhPSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUpIHVwZGF0ZUhvc3RUZXh0KGN1cnJlbnQsIHdvcmtJblByb2dyZXNzLCBjdXJyZW50Lm1lbW9pemVkUHJvcHMsIG5ld1Byb3BzKTtlbHNlIHsKICAgICAgICAgICAgICBpZiAoInN0cmluZyIgIT09IHR5cGVvZiBuZXdQcm9wcykgcmV0dXJuIGludmFyaWFudChudWxsICE9PSB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUsICJXZSBtdXN0IGhhdmUgbmV3IHByb3BzIGZvciBuZXcgbW91bnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpLCBudWxsOwogICAgICAgICAgICAgIGN1cnJlbnQgPSBnZXRSb290SG9zdENvbnRhaW5lcigpOwogICAgICAgICAgICAgIHJlbmRlckV4cGlyYXRpb25UaW1lID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgICBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzcykgPyBwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzcykgJiYgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzcykgOiB3b3JrSW5Qcm9ncmVzcy5zdGF0ZU5vZGUgPSBjcmVhdGVUZXh0SW5zdGFuY2UobmV3UHJvcHMsIGN1cnJlbnQsIHJlbmRlckV4cGlyYXRpb25UaW1lLCB3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGludmFyaWFudChuZXdQcm9wcywgIlNob3VsZCBiZSByZXNvbHZlZCBieSBub3cuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzLnRhZyA9IDg7CiAgICAgICAgICAgIHR5cGUgPSBbXTsKCiAgICAgICAgICAgIGE6IGZvciAoKG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3Muc3RhdGVOb2RlKSAmJiAob2xkUHJvcHNbInJldHVybiJdID0gd29ya0luUHJvZ3Jlc3MpOyBudWxsICE9PSBvbGRQcm9wczspIHsKICAgICAgICAgICAgICBpZiAoNSA9PT0gb2xkUHJvcHMudGFnIHx8IDYgPT09IG9sZFByb3BzLnRhZyB8fCA0ID09PSBvbGRQcm9wcy50YWcpIGludmFyaWFudCghMSwgIkEgY2FsbCBjYW5ub3QgaGF2ZSBob3N0IGNvbXBvbmVudCBjaGlsZHJlbi4iKTtlbHNlIGlmICg5ID09PSBvbGRQcm9wcy50YWcpIHR5cGUucHVzaChvbGRQcm9wcy50eXBlKTtlbHNlIGlmIChudWxsICE9PSBvbGRQcm9wcy5jaGlsZCkgewogICAgICAgICAgICAgICAgb2xkUHJvcHMuY2hpbGRbInJldHVybiJdID0gb2xkUHJvcHM7CiAgICAgICAgICAgICAgICBvbGRQcm9wcyA9IG9sZFByb3BzLmNoaWxkOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBmb3IgKDsgbnVsbCA9PT0gb2xkUHJvcHMuc2libGluZzspIHsKICAgICAgICAgICAgICAgIGlmIChudWxsID09PSBvbGRQcm9wc1sicmV0dXJuIl0gfHwgb2xkUHJvcHNbInJldHVybiJdID09PSB3b3JrSW5Qcm9ncmVzcykgYnJlYWsgYTsKICAgICAgICAgICAgICAgIG9sZFByb3BzID0gb2xkUHJvcHNbInJldHVybiJdOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgb2xkUHJvcHMuc2libGluZ1sicmV0dXJuIl0gPSBvbGRQcm9wc1sicmV0dXJuIl07CiAgICAgICAgICAgICAgb2xkUHJvcHMgPSBvbGRQcm9wcy5zaWJsaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvbGRQcm9wcyA9IG5ld1Byb3BzLmhhbmRsZXI7CiAgICAgICAgICAgIG5ld1Byb3BzID0gb2xkUHJvcHMobmV3UHJvcHMucHJvcHMsIHR5cGUpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzLCBudWxsICE9PSBjdXJyZW50ID8gY3VycmVudC5jaGlsZCA6IG51bGwsIG5ld1Byb3BzLCByZW5kZXJFeHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzcy5jaGlsZDsKCiAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzcy50YWcgPSA3LCBudWxsOwoKICAgICAgICAgIGNhc2UgOToKICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICByZXR1cm4gcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzcyksIHVwZGF0ZUhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MpLCBudWxsOwoKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgaW52YXJpYW50KCExLCAiQW4gaW5kZXRlcm1pbmF0ZSBjb21wb25lbnQgc2hvdWxkIGhhdmUgYmVjb21lIGRldGVybWluYXRlIGJlZm9yZSBjb21wbGV0aW5nLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwoKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGludmFyaWFudCghMSwgIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBSZWFjdEZpYmVyQ29tbWl0V29yayhjb25maWcsIGNhcHR1cmVFcnJvcikgewogICAgZnVuY3Rpb24gc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQpIHsKICAgICAgdmFyIHJlZiA9IGN1cnJlbnQucmVmOwogICAgICBpZiAobnVsbCAhPT0gcmVmKSB0cnkgewogICAgICAgIHJlZihudWxsKTsKICAgICAgfSBjYXRjaCAocmVmRXJyb3IpIHsKICAgICAgICBjYXB0dXJlRXJyb3IoY3VycmVudCwgcmVmRXJyb3IpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY29tbWl0VW5tb3VudChjdXJyZW50KSB7CiAgICAgICJmdW5jdGlvbiIgPT09IHR5cGVvZiBvbkNvbW1pdFVubW91bnQgJiYgb25Db21taXRVbm1vdW50KGN1cnJlbnQpOwoKICAgICAgc3dpdGNoIChjdXJyZW50LnRhZykgewogICAgICAgIGNhc2UgMjoKICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50KTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGN1cnJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKCJmdW5jdGlvbiIgPT09IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCkgdHJ5IHsKICAgICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBjdXJyZW50Lm1lbW9pemVkUHJvcHMsIGluc3RhbmNlLnN0YXRlID0gY3VycmVudC5tZW1vaXplZFN0YXRlLCBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCgpOwogICAgICAgICAgfSBjYXRjaCAodW5tb3VudEVycm9yKSB7CiAgICAgICAgICAgIGNhcHR1cmVFcnJvcihjdXJyZW50LCB1bm1vdW50RXJyb3IpOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgNToKICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50KTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIDc6CiAgICAgICAgICBjb21taXROZXN0ZWRVbm1vdW50cyhjdXJyZW50LnN0YXRlTm9kZSk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSA0OgogICAgICAgICAgbXV0YXRpb24gJiYgdW5tb3VudEhvc3RDb21wb25lbnRzKGN1cnJlbnQpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY29tbWl0TmVzdGVkVW5tb3VudHMocm9vdCkgewogICAgICBmb3IgKHZhciBub2RlID0gcm9vdDs7KSB7CiAgICAgICAgaWYgKGNvbW1pdFVubW91bnQobm9kZSksIG51bGwgPT09IG5vZGUuY2hpbGQgfHwgbXV0YXRpb24gJiYgNCA9PT0gbm9kZS50YWcpIHsKICAgICAgICAgIGlmIChub2RlID09PSByb290KSBicmVhazsKCiAgICAgICAgICBmb3IgKDsgbnVsbCA9PT0gbm9kZS5zaWJsaW5nOykgewogICAgICAgICAgICBpZiAobnVsbCA9PT0gbm9kZVsicmV0dXJuIl0gfHwgbm9kZVsicmV0dXJuIl0gPT09IHJvb3QpIHJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGVbInJldHVybiJdOwogICAgICAgICAgfQoKICAgICAgICAgIG5vZGUuc2libGluZ1sicmV0dXJuIl0gPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgfSBlbHNlIG5vZGUuY2hpbGRbInJldHVybiJdID0gbm9kZSwgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc0hvc3RQYXJlbnQoZmliZXIpIHsKICAgICAgcmV0dXJuIDUgPT09IGZpYmVyLnRhZyB8fCAzID09PSBmaWJlci50YWcgfHwgNCA9PT0gZmliZXIudGFnOwogICAgfQoKICAgIGZ1bmN0aW9uIHVubW91bnRIb3N0Q29tcG9uZW50cyhjdXJyZW50KSB7CiAgICAgIGZvciAodmFyIG5vZGUgPSBjdXJyZW50LCBjdXJyZW50UGFyZW50SXNWYWxpZCA9ICExLCBjdXJyZW50UGFyZW50ID0gdm9pZCAwLCBjdXJyZW50UGFyZW50SXNDb250YWluZXIgPSB2b2lkIDA7OykgewogICAgICAgIGlmICghY3VycmVudFBhcmVudElzVmFsaWQpIHsKICAgICAgICAgIGN1cnJlbnRQYXJlbnRJc1ZhbGlkID0gbm9kZVsicmV0dXJuIl07CgogICAgICAgICAgYTogZm9yICg7OykgewogICAgICAgICAgICBpbnZhcmlhbnQobnVsbCAhPT0gY3VycmVudFBhcmVudElzVmFsaWQsICJFeHBlY3RlZCB0byBmaW5kIGEgaG9zdCBwYXJlbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CgogICAgICAgICAgICBzd2l0Y2ggKGN1cnJlbnRQYXJlbnRJc1ZhbGlkLnRhZykgewogICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgIGN1cnJlbnRQYXJlbnQgPSBjdXJyZW50UGFyZW50SXNWYWxpZC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBjdXJyZW50UGFyZW50SXNDb250YWluZXIgPSAhMTsKICAgICAgICAgICAgICAgIGJyZWFrIGE7CgogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIGN1cnJlbnRQYXJlbnQgPSBjdXJyZW50UGFyZW50SXNWYWxpZC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgIGN1cnJlbnRQYXJlbnRJc0NvbnRhaW5lciA9ICEwOwogICAgICAgICAgICAgICAgYnJlYWsgYTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgY3VycmVudFBhcmVudCA9IGN1cnJlbnRQYXJlbnRJc1ZhbGlkLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgY3VycmVudFBhcmVudElzQ29udGFpbmVyID0gITA7CiAgICAgICAgICAgICAgICBicmVhayBhOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdXJyZW50UGFyZW50SXNWYWxpZCA9IGN1cnJlbnRQYXJlbnRJc1ZhbGlkWyJyZXR1cm4iXTsKICAgICAgICAgIH0KCiAgICAgICAgICBjdXJyZW50UGFyZW50SXNWYWxpZCA9ICEwOwogICAgICAgIH0KCiAgICAgICAgaWYgKDUgPT09IG5vZGUudGFnIHx8IDYgPT09IG5vZGUudGFnKSBjb21taXROZXN0ZWRVbm1vdW50cyhub2RlKSwgY3VycmVudFBhcmVudElzQ29udGFpbmVyID8gcmVtb3ZlQ2hpbGRGcm9tQ29udGFpbmVyKGN1cnJlbnRQYXJlbnQsIG5vZGUuc3RhdGVOb2RlKSA6IHJlbW92ZUNoaWxkKGN1cnJlbnRQYXJlbnQsIG5vZGUuc3RhdGVOb2RlKTtlbHNlIGlmICg0ID09PSBub2RlLnRhZyA/IGN1cnJlbnRQYXJlbnQgPSBub2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvIDogY29tbWl0VW5tb3VudChub2RlKSwgbnVsbCAhPT0gbm9kZS5jaGlsZCkgewogICAgICAgICAgbm9kZS5jaGlsZFsicmV0dXJuIl0gPSBub2RlOwogICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKG5vZGUgPT09IGN1cnJlbnQpIGJyZWFrOwoKICAgICAgICBmb3IgKDsgbnVsbCA9PT0gbm9kZS5zaWJsaW5nOykgewogICAgICAgICAgaWYgKG51bGwgPT09IG5vZGVbInJldHVybiJdIHx8IG5vZGVbInJldHVybiJdID09PSBjdXJyZW50KSByZXR1cm47CiAgICAgICAgICBub2RlID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgICA0ID09PSBub2RlLnRhZyAmJiAoY3VycmVudFBhcmVudElzVmFsaWQgPSAhMSk7CiAgICAgICAgfQoKICAgICAgICBub2RlLnNpYmxpbmdbInJldHVybiJdID0gbm9kZVsicmV0dXJuIl07CiAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgfQogICAgfQoKICAgIHZhciBnZXRQdWJsaWNJbnN0YW5jZSA9IGNvbmZpZy5nZXRQdWJsaWNJbnN0YW5jZSwKICAgICAgICBtdXRhdGlvbiA9IGNvbmZpZy5tdXRhdGlvbjsKICAgIGNvbmZpZyA9IGNvbmZpZy5wZXJzaXN0ZW5jZTsKICAgIG11dGF0aW9uIHx8IChjb25maWcgPyBpbnZhcmlhbnQoITEsICJQZXJzaXN0ZW50IHJlY29uY2lsZXIgaXMgZGlzYWJsZWQuIikgOiBpbnZhcmlhbnQoITEsICJOb29wIHJlY29uY2lsZXIgaXMgZGlzYWJsZWQuIikpOwogICAgdmFyIGNvbW1pdE1vdW50ID0gbXV0YXRpb24uY29tbWl0TW91bnQsCiAgICAgICAgY29tbWl0VXBkYXRlID0gbXV0YXRpb24uY29tbWl0VXBkYXRlLAogICAgICAgIHJlc2V0VGV4dENvbnRlbnQgPSBtdXRhdGlvbi5yZXNldFRleHRDb250ZW50LAogICAgICAgIGNvbW1pdFRleHRVcGRhdGUgPSBtdXRhdGlvbi5jb21taXRUZXh0VXBkYXRlLAogICAgICAgIGFwcGVuZENoaWxkID0gbXV0YXRpb24uYXBwZW5kQ2hpbGQsCiAgICAgICAgYXBwZW5kQ2hpbGRUb0NvbnRhaW5lciA9IG11dGF0aW9uLmFwcGVuZENoaWxkVG9Db250YWluZXIsCiAgICAgICAgaW5zZXJ0QmVmb3JlID0gbXV0YXRpb24uaW5zZXJ0QmVmb3JlLAogICAgICAgIGluc2VydEluQ29udGFpbmVyQmVmb3JlID0gbXV0YXRpb24uaW5zZXJ0SW5Db250YWluZXJCZWZvcmUsCiAgICAgICAgcmVtb3ZlQ2hpbGQgPSBtdXRhdGlvbi5yZW1vdmVDaGlsZCwKICAgICAgICByZW1vdmVDaGlsZEZyb21Db250YWluZXIgPSBtdXRhdGlvbi5yZW1vdmVDaGlsZEZyb21Db250YWluZXI7CiAgICByZXR1cm4gewogICAgICBjb21taXRSZXNldFRleHRDb250ZW50OiBmdW5jdGlvbiBjb21taXRSZXNldFRleHRDb250ZW50KGN1cnJlbnQpIHsKICAgICAgICByZXNldFRleHRDb250ZW50KGN1cnJlbnQuc3RhdGVOb2RlKTsKICAgICAgfSwKICAgICAgY29tbWl0UGxhY2VtZW50OiBmdW5jdGlvbiBjb21taXRQbGFjZW1lbnQoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgYTogewogICAgICAgICAgZm9yICh2YXIgcGFyZW50ID0gZmluaXNoZWRXb3JrWyJyZXR1cm4iXTsgbnVsbCAhPT0gcGFyZW50OykgewogICAgICAgICAgICBpZiAoaXNIb3N0UGFyZW50KHBhcmVudCkpIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50RmliZXIgPSBwYXJlbnQ7CiAgICAgICAgICAgICAgYnJlYWsgYTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50WyJyZXR1cm4iXTsKICAgICAgICAgIH0KCiAgICAgICAgICBpbnZhcmlhbnQoITEsICJFeHBlY3RlZCB0byBmaW5kIGEgaG9zdCBwYXJlbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICBwYXJlbnRGaWJlciA9IHZvaWQgMDsKICAgICAgICB9CgogICAgICAgIHZhciBpc0NvbnRhaW5lciA9IHBhcmVudCA9IHZvaWQgMDsKCiAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICBpc0NvbnRhaW5lciA9ICExOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICBpc0NvbnRhaW5lciA9ICEwOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICBpc0NvbnRhaW5lciA9ICEwOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBpbnZhcmlhbnQoITEsICJJbnZhbGlkIGhvc3QgcGFyZW50IGZpYmVyLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KCiAgICAgICAgcGFyZW50RmliZXIuZWZmZWN0VGFnICYgMTYgJiYgKHJlc2V0VGV4dENvbnRlbnQocGFyZW50KSwgcGFyZW50RmliZXIuZWZmZWN0VGFnICY9IC0xNyk7CgogICAgICAgIGE6IGI6IGZvciAocGFyZW50RmliZXIgPSBmaW5pc2hlZFdvcms7OykgewogICAgICAgICAgZm9yICg7IG51bGwgPT09IHBhcmVudEZpYmVyLnNpYmxpbmc7KSB7CiAgICAgICAgICAgIGlmIChudWxsID09PSBwYXJlbnRGaWJlclsicmV0dXJuIl0gfHwgaXNIb3N0UGFyZW50KHBhcmVudEZpYmVyWyJyZXR1cm4iXSkpIHsKICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWsgYTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlclsicmV0dXJuIl07CiAgICAgICAgICB9CgogICAgICAgICAgcGFyZW50RmliZXIuc2libGluZ1sicmV0dXJuIl0gPSBwYXJlbnRGaWJlclsicmV0dXJuIl07CgogICAgICAgICAgZm9yIChwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnNpYmxpbmc7IDUgIT09IHBhcmVudEZpYmVyLnRhZyAmJiA2ICE9PSBwYXJlbnRGaWJlci50YWc7KSB7CiAgICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5lZmZlY3RUYWcgJiAyKSBjb250aW51ZSBiOwogICAgICAgICAgICBpZiAobnVsbCA9PT0gcGFyZW50RmliZXIuY2hpbGQgfHwgNCA9PT0gcGFyZW50RmliZXIudGFnKSBjb250aW51ZSBiO2Vsc2UgcGFyZW50RmliZXIuY2hpbGRbInJldHVybiJdID0gcGFyZW50RmliZXIsIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIuY2hpbGQ7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCEocGFyZW50RmliZXIuZWZmZWN0VGFnICYgMikpIHsKICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGJyZWFrIGE7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBub2RlID0gZmluaXNoZWRXb3JrOzspIHsKICAgICAgICAgIGlmICg1ID09PSBub2RlLnRhZyB8fCA2ID09PSBub2RlLnRhZykgcGFyZW50RmliZXIgPyBpc0NvbnRhaW5lciA/IGluc2VydEluQ29udGFpbmVyQmVmb3JlKHBhcmVudCwgbm9kZS5zdGF0ZU5vZGUsIHBhcmVudEZpYmVyKSA6IGluc2VydEJlZm9yZShwYXJlbnQsIG5vZGUuc3RhdGVOb2RlLCBwYXJlbnRGaWJlcikgOiBpc0NvbnRhaW5lciA/IGFwcGVuZENoaWxkVG9Db250YWluZXIocGFyZW50LCBub2RlLnN0YXRlTm9kZSkgOiBhcHBlbmRDaGlsZChwYXJlbnQsIG5vZGUuc3RhdGVOb2RlKTtlbHNlIGlmICg0ICE9PSBub2RlLnRhZyAmJiBudWxsICE9PSBub2RlLmNoaWxkKSB7CiAgICAgICAgICAgIG5vZGUuY2hpbGRbInJldHVybiJdID0gbm9kZTsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgYnJlYWs7CgogICAgICAgICAgZm9yICg7IG51bGwgPT09IG5vZGUuc2libGluZzspIHsKICAgICAgICAgICAgaWYgKG51bGwgPT09IG5vZGVbInJldHVybiJdIHx8IG5vZGVbInJldHVybiJdID09PSBmaW5pc2hlZFdvcmspIHJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGVbInJldHVybiJdOwogICAgICAgICAgfQoKICAgICAgICAgIG5vZGUuc2libGluZ1sicmV0dXJuIl0gPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgfQogICAgICB9LAogICAgICBjb21taXREZWxldGlvbjogZnVuY3Rpb24gY29tbWl0RGVsZXRpb24oY3VycmVudCkgewogICAgICAgIHVubW91bnRIb3N0Q29tcG9uZW50cyhjdXJyZW50KTsKICAgICAgICBjdXJyZW50WyJyZXR1cm4iXSA9IG51bGw7CiAgICAgICAgY3VycmVudC5jaGlsZCA9IG51bGw7CiAgICAgICAgY3VycmVudC5hbHRlcm5hdGUgJiYgKGN1cnJlbnQuYWx0ZXJuYXRlLmNoaWxkID0gbnVsbCwgY3VycmVudC5hbHRlcm5hdGVbInJldHVybiJdID0gbnVsbCk7CiAgICAgIH0sCiAgICAgIGNvbW1pdFdvcms6IGZ1bmN0aW9uIGNvbW1pdFdvcmsoY3VycmVudCwgZmluaXNoZWRXb3JrKSB7CiAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKCiAgICAgICAgICAgIGlmIChudWxsICE9IGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1Byb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgY3VycmVudCA9IG51bGwgIT09IGN1cnJlbnQgPyBjdXJyZW50Lm1lbW9pemVkUHJvcHMgOiBuZXdQcm9wczsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpbmlzaGVkV29yay50eXBlLAogICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgIGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgbnVsbCAhPT0gdXBkYXRlUGF5bG9hZCAmJiBjb21taXRVcGRhdGUoaW5zdGFuY2UsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIGN1cnJlbnQsIG5ld1Byb3BzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICB9CgogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgIGludmFyaWFudChudWxsICE9PSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLCAiVGhpcyBzaG91bGQgaGF2ZSBhIHRleHQgbm9kZSBpbml0aWFsaXplZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgY29tbWl0VGV4dFVwZGF0ZShmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLCBudWxsICE9PSBjdXJyZW50ID8gY3VycmVudC5tZW1vaXplZFByb3BzIDogaW5zdGFuY2UsIGluc3RhbmNlKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBpbnZhcmlhbnQoITEsICJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbW1pdExpZmVDeWNsZXM6IGZ1bmN0aW9uIGNvbW1pdExpZmVDeWNsZXMoY3VycmVudCwgZmluaXNoZWRXb3JrKSB7CiAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZWZmZWN0VGFnICYgNCkgaWYgKG51bGwgPT09IGN1cnJlbnQpIGluc3RhbmNlLnByb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIGluc3RhbmNlLnN0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUsIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7ZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzLCBjdXJyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5pc2hlZFdvcmsgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgIG51bGwgIT09IGZpbmlzaGVkV29yayAmJiBjb21taXRDYWxsYmFja3MoZmluaXNoZWRXb3JrLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgIG51bGwgIT09IGluc3RhbmNlICYmIGNvbW1pdENhbGxiYWNrcyhpbnN0YW5jZSwgbnVsbCAhPT0gZmluaXNoZWRXb3JrLmNoaWxkID8gZmluaXNoZWRXb3JrLmNoaWxkLnN0YXRlTm9kZSA6IG51bGwpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgbnVsbCA9PT0gY3VycmVudCAmJiBmaW5pc2hlZFdvcmsuZWZmZWN0VGFnICYgNCAmJiBjb21taXRNb3VudChpbnN0YW5jZSwgZmluaXNoZWRXb3JrLnR5cGUsIGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgaW52YXJpYW50KCExLCAiVGhpcyB1bml0IG9mIHdvcmsgdGFnIHNob3VsZCBub3QgaGF2ZSBzaWRlLWVmZmVjdHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgfQogICAgICB9LAogICAgICBjb21taXRBdHRhY2hSZWY6IGZ1bmN0aW9uIGNvbW1pdEF0dGFjaFJlZihmaW5pc2hlZFdvcmspIHsKICAgICAgICB2YXIgcmVmID0gZmluaXNoZWRXb3JrLnJlZjsKCiAgICAgICAgaWYgKG51bGwgIT09IHJlZikgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKCiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgIHJlZihnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSkpOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZWYoaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgY29tbWl0RGV0YWNoUmVmOiBmdW5jdGlvbiBjb21taXREZXRhY2hSZWYoY3VycmVudCkgewogICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnJlZjsKICAgICAgICBudWxsICE9PSBjdXJyZW50ICYmIGN1cnJlbnQobnVsbCk7CiAgICAgIH0KICAgIH07CiAgfQoKICB2YXIgTk9fQ09OVEVYVCA9IHt9OwoKICBmdW5jdGlvbiBSZWFjdEZpYmVySG9zdENvbnRleHQoY29uZmlnKSB7CiAgICBmdW5jdGlvbiByZXF1aXJlZENvbnRleHQoYykgewogICAgICBpbnZhcmlhbnQoYyAhPT0gTk9fQ09OVEVYVCwgIkV4cGVjdGVkIGhvc3QgY29udGV4dCB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgcmV0dXJuIGM7CiAgICB9CgogICAgdmFyIGdldENoaWxkSG9zdENvbnRleHQgPSBjb25maWcuZ2V0Q2hpbGRIb3N0Q29udGV4dCwKICAgICAgICBnZXRSb290SG9zdENvbnRleHQgPSBjb25maWcuZ2V0Um9vdEhvc3RDb250ZXh0LAogICAgICAgIGNvbnRleHRTdGFja0N1cnNvciA9IHsKICAgICAgY3VycmVudDogTk9fQ09OVEVYVAogICAgfSwKICAgICAgICBjb250ZXh0RmliZXJTdGFja0N1cnNvciA9IHsKICAgICAgY3VycmVudDogTk9fQ09OVEVYVAogICAgfSwKICAgICAgICByb290SW5zdGFuY2VTdGFja0N1cnNvciA9IHsKICAgICAgY3VycmVudDogTk9fQ09OVEVYVAogICAgfTsKICAgIHJldHVybiB7CiAgICAgIGdldEhvc3RDb250ZXh0OiBmdW5jdGlvbiBnZXRIb3N0Q29udGV4dCgpIHsKICAgICAgICByZXR1cm4gcmVxdWlyZWRDb250ZXh0KGNvbnRleHRTdGFja0N1cnNvci5jdXJyZW50KTsKICAgICAgfSwKICAgICAgZ2V0Um9vdEhvc3RDb250YWluZXI6IGZ1bmN0aW9uIGdldFJvb3RIb3N0Q29udGFpbmVyKCkgewogICAgICAgIHJldHVybiByZXF1aXJlZENvbnRleHQocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgIH0sCiAgICAgIHBvcEhvc3RDb250YWluZXI6IGZ1bmN0aW9uIHBvcEhvc3RDb250YWluZXIoZmliZXIpIHsKICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgcG9wKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgcG9wKHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgIH0sCiAgICAgIHBvcEhvc3RDb250ZXh0OiBmdW5jdGlvbiBwb3BIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgIGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLmN1cnJlbnQgPT09IGZpYmVyICYmIChwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlciksIHBvcChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIpKTsKICAgICAgfSwKICAgICAgcHVzaEhvc3RDb250YWluZXI6IGZ1bmN0aW9uIHB1c2hIb3N0Q29udGFpbmVyKGZpYmVyLCBuZXh0Um9vdEluc3RhbmNlKSB7CiAgICAgICAgcHVzaChyb290SW5zdGFuY2VTdGFja0N1cnNvciwgbmV4dFJvb3RJbnN0YW5jZSwgZmliZXIpOwogICAgICAgIG5leHRSb290SW5zdGFuY2UgPSBnZXRSb290SG9zdENvbnRleHQobmV4dFJvb3RJbnN0YW5jZSk7CiAgICAgICAgcHVzaChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIsIGZpYmVyKTsKICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgbmV4dFJvb3RJbnN0YW5jZSwgZmliZXIpOwogICAgICB9LAogICAgICBwdXNoSG9zdENvbnRleHQ6IGZ1bmN0aW9uIHB1c2hIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgIHZhciByb290SW5zdGFuY2UgPSByZXF1aXJlZENvbnRleHQocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IuY3VycmVudCksCiAgICAgICAgICAgIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgIHJvb3RJbnN0YW5jZSA9IGdldENoaWxkSG9zdENvbnRleHQoY29udGV4dCwgZmliZXIudHlwZSwgcm9vdEluc3RhbmNlKTsKICAgICAgICBjb250ZXh0ICE9PSByb290SW5zdGFuY2UgJiYgKHB1c2goY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyLCBmaWJlciksIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCByb290SW5zdGFuY2UsIGZpYmVyKSk7CiAgICAgIH0sCiAgICAgIHJlc2V0SG9zdENvbnRhaW5lcjogZnVuY3Rpb24gcmVzZXRIb3N0Q29udGFpbmVyKCkgewogICAgICAgIGNvbnRleHRTdGFja0N1cnNvci5jdXJyZW50ID0gTk9fQ09OVEVYVDsKICAgICAgICByb290SW5zdGFuY2VTdGFja0N1cnNvci5jdXJyZW50ID0gTk9fQ09OVEVYVDsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIFJlYWN0RmliZXJIeWRyYXRpb25Db250ZXh0KGNvbmZpZykgewogICAgZnVuY3Rpb24gZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSkgewogICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcig1LCBudWxsLCBudWxsLCAwKTsKICAgICAgZmliZXIudHlwZSA9ICJERUxFVEVEIjsKICAgICAgZmliZXIuc3RhdGVOb2RlID0gaW5zdGFuY2U7CiAgICAgIGZpYmVyWyJyZXR1cm4iXSA9IHJldHVybkZpYmVyOwogICAgICBmaWJlci5lZmZlY3RUYWcgPSA4OwogICAgICBudWxsICE9PSByZXR1cm5GaWJlci5sYXN0RWZmZWN0ID8gKHJldHVybkZpYmVyLmxhc3RFZmZlY3QubmV4dEVmZmVjdCA9IGZpYmVyLCByZXR1cm5GaWJlci5sYXN0RWZmZWN0ID0gZmliZXIpIDogcmV0dXJuRmliZXIuZmlyc3RFZmZlY3QgPSByZXR1cm5GaWJlci5sYXN0RWZmZWN0ID0gZmliZXI7CiAgICB9CgogICAgZnVuY3Rpb24gdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSB7CiAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgY2FzZSA1OgogICAgICAgICAgcmV0dXJuIG5leHRJbnN0YW5jZSA9IGNhbkh5ZHJhdGVJbnN0YW5jZShuZXh0SW5zdGFuY2UsIGZpYmVyLnR5cGUsIGZpYmVyLnBlbmRpbmdQcm9wcyksIG51bGwgIT09IG5leHRJbnN0YW5jZSA/IChmaWJlci5zdGF0ZU5vZGUgPSBuZXh0SW5zdGFuY2UsICEwKSA6ICExOwoKICAgICAgICBjYXNlIDY6CiAgICAgICAgICByZXR1cm4gbmV4dEluc3RhbmNlID0gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShuZXh0SW5zdGFuY2UsIGZpYmVyLnBlbmRpbmdQcm9wcyksIG51bGwgIT09IG5leHRJbnN0YW5jZSA/IChmaWJlci5zdGF0ZU5vZGUgPSBuZXh0SW5zdGFuY2UsICEwKSA6ICExOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuICExOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcG9wVG9OZXh0SG9zdFBhcmVudChmaWJlcikgewogICAgICBmb3IgKGZpYmVyID0gZmliZXJbInJldHVybiJdOyBudWxsICE9PSBmaWJlciAmJiA1ICE9PSBmaWJlci50YWcgJiYgMyAhPT0gZmliZXIudGFnOykgewogICAgICAgIGZpYmVyID0gZmliZXJbInJldHVybiJdOwogICAgICB9CgogICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgfQoKICAgIHZhciBzaG91bGRTZXRUZXh0Q29udGVudCA9IGNvbmZpZy5zaG91bGRTZXRUZXh0Q29udGVudDsKICAgIGNvbmZpZyA9IGNvbmZpZy5oeWRyYXRpb247CiAgICBpZiAoIWNvbmZpZykgcmV0dXJuIHsKICAgICAgZW50ZXJIeWRyYXRpb25TdGF0ZTogZnVuY3Rpb24gZW50ZXJIeWRyYXRpb25TdGF0ZSgpIHsKICAgICAgICByZXR1cm4gITE7CiAgICAgIH0sCiAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGU6IGZ1bmN0aW9uIHJlc2V0SHlkcmF0aW9uU3RhdGUoKSB7fSwKICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2U6IGZ1bmN0aW9uIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKCkge30sCiAgICAgIHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2U6IGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2UoKSB7CiAgICAgICAgaW52YXJpYW50KCExLCAiRXhwZWN0ZWQgcHJlcGFyZVRvSHlkcmF0ZUhvc3RJbnN0YW5jZSgpIHRvIG5ldmVyIGJlIGNhbGxlZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgfSwKICAgICAgcHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2U6IGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKCkgewogICAgICAgIGludmFyaWFudCghMSwgIkV4cGVjdGVkIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKCkgdG8gbmV2ZXIgYmUgY2FsbGVkLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICB9LAogICAgICBwb3BIeWRyYXRpb25TdGF0ZTogZnVuY3Rpb24gcG9wSHlkcmF0aW9uU3RhdGUoKSB7CiAgICAgICAgcmV0dXJuICExOwogICAgICB9CiAgICB9OwogICAgdmFyIGNhbkh5ZHJhdGVJbnN0YW5jZSA9IGNvbmZpZy5jYW5IeWRyYXRlSW5zdGFuY2UsCiAgICAgICAgY2FuSHlkcmF0ZVRleHRJbnN0YW5jZSA9IGNvbmZpZy5jYW5IeWRyYXRlVGV4dEluc3RhbmNlLAogICAgICAgIGdldE5leHRIeWRyYXRhYmxlU2libGluZyA9IGNvbmZpZy5nZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcsCiAgICAgICAgZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGQgPSBjb25maWcuZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGQsCiAgICAgICAgaHlkcmF0ZUluc3RhbmNlID0gY29uZmlnLmh5ZHJhdGVJbnN0YW5jZSwKICAgICAgICBoeWRyYXRlVGV4dEluc3RhbmNlID0gY29uZmlnLmh5ZHJhdGVUZXh0SW5zdGFuY2UsCiAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsLAogICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBudWxsLAogICAgICAgIGlzSHlkcmF0aW5nID0gITE7CiAgICByZXR1cm4gewogICAgICBlbnRlckh5ZHJhdGlvblN0YXRlOiBmdW5jdGlvbiBlbnRlckh5ZHJhdGlvblN0YXRlKGZpYmVyKSB7CiAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkKGZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgIHJldHVybiBpc0h5ZHJhdGluZyA9ICEwOwogICAgICB9LAogICAgICByZXNldEh5ZHJhdGlvblN0YXRlOiBmdW5jdGlvbiByZXNldEh5ZHJhdGlvblN0YXRlKCkgewogICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBoeWRyYXRpb25QYXJlbnRGaWJlciA9IG51bGw7CiAgICAgICAgaXNIeWRyYXRpbmcgPSAhMTsKICAgICAgfSwKICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2U6IGZ1bmN0aW9uIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgaWYgKGlzSHlkcmF0aW5nKSB7CiAgICAgICAgICB2YXIgbmV4dEluc3RhbmNlID0gbmV4dEh5ZHJhdGFibGVJbnN0YW5jZTsKCiAgICAgICAgICBpZiAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmICghdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSkgewogICAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwoKICAgICAgICAgICAgICBpZiAoIW5leHRJbnN0YW5jZSB8fCAhdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgZmliZXIuZWZmZWN0VGFnIHw9IDI7CiAgICAgICAgICAgICAgICBpc0h5ZHJhdGluZyA9ICExOwogICAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGRlbGV0ZUh5ZHJhdGFibGVJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChuZXh0SW5zdGFuY2UpOwogICAgICAgICAgfSBlbHNlIGZpYmVyLmVmZmVjdFRhZyB8PSAyLCBpc0h5ZHJhdGluZyA9ICExLCBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZVRvSHlkcmF0ZUhvc3RJbnN0YW5jZTogZnVuY3Rpb24gcHJlcGFyZVRvSHlkcmF0ZUhvc3RJbnN0YW5jZShmaWJlciwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgIHJvb3RDb250YWluZXJJbnN0YW5jZSA9IGh5ZHJhdGVJbnN0YW5jZShmaWJlci5zdGF0ZU5vZGUsIGZpYmVyLnR5cGUsIGZpYmVyLm1lbW9pemVkUHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQsIGZpYmVyKTsKICAgICAgICBmaWJlci51cGRhdGVRdWV1ZSA9IHJvb3RDb250YWluZXJJbnN0YW5jZTsKICAgICAgICByZXR1cm4gbnVsbCAhPT0gcm9vdENvbnRhaW5lckluc3RhbmNlID8gITAgOiAhMTsKICAgICAgfSwKICAgICAgcHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2U6IGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgcmV0dXJuIGh5ZHJhdGVUZXh0SW5zdGFuY2UoZmliZXIuc3RhdGVOb2RlLCBmaWJlci5tZW1vaXplZFByb3BzLCBmaWJlcik7CiAgICAgIH0sCiAgICAgIHBvcEh5ZHJhdGlvblN0YXRlOiBmdW5jdGlvbiBwb3BIeWRyYXRpb25TdGF0ZShmaWJlcikgewogICAgICAgIGlmIChmaWJlciAhPT0gaHlkcmF0aW9uUGFyZW50RmliZXIpIHJldHVybiAhMTsKICAgICAgICBpZiAoIWlzSHlkcmF0aW5nKSByZXR1cm4gcG9wVG9OZXh0SG9zdFBhcmVudChmaWJlciksIGlzSHlkcmF0aW5nID0gITAsICExOwogICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICBpZiAoNSAhPT0gZmliZXIudGFnIHx8ICJoZWFkIiAhPT0gdHlwZSAmJiAiYm9keSIgIT09IHR5cGUgJiYgIXNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIGZpYmVyLm1lbW9pemVkUHJvcHMpKSBmb3IgKHR5cGUgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOyB0eXBlOykgewogICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyLCB0eXBlKSwgdHlwZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyh0eXBlKTsKICAgICAgICB9CiAgICAgICAgcG9wVG9OZXh0SG9zdFBhcmVudChmaWJlcik7CiAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGh5ZHJhdGlvblBhcmVudEZpYmVyID8gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpYmVyLnN0YXRlTm9kZSkgOiBudWxsOwogICAgICAgIHJldHVybiAhMDsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIFJlYWN0RmliZXJTY2hlZHVsZXIoY29uZmlnKSB7CiAgICBmdW5jdGlvbiBjb21wbGV0ZVVuaXRPZldvcmsod29ya0luUHJvZ3Jlc3MkanNjb21wJDApIHsKICAgICAgZm9yICg7OykgewogICAgICAgIHZhciBuZXh0ID0gY29tcGxldGVXb3JrKHdvcmtJblByb2dyZXNzJGpzY29tcCQwLmFsdGVybmF0ZSwgd29ya0luUHJvZ3Jlc3MkanNjb21wJDAsIG5leHRSZW5kZXJFeHBpcmF0aW9uVGltZSksCiAgICAgICAgICAgIHJldHVybkZpYmVyID0gd29ya0luUHJvZ3Jlc3MkanNjb21wJDBbInJldHVybiJdLAogICAgICAgICAgICBzaWJsaW5nRmliZXIgPSB3b3JrSW5Qcm9ncmVzcyRqc2NvbXAkMC5zaWJsaW5nOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzcyA9IHdvcmtJblByb2dyZXNzJGpzY29tcCQwOwoKICAgICAgICBpZiAoMjE0NzQ4MzY0NyA9PT0gbmV4dFJlbmRlckV4cGlyYXRpb25UaW1lIHx8IDIxNDc0ODM2NDcgIT09IHdvcmtJblByb2dyZXNzLmV4cGlyYXRpb25UaW1lKSB7CiAgICAgICAgICBpZiAoMiAhPT0gd29ya0luUHJvZ3Jlc3MudGFnICYmIDMgIT09IHdvcmtJblByb2dyZXNzLnRhZykgdmFyIG5ld0V4cGlyYXRpb25UaW1lID0gMDtlbHNlIG5ld0V4cGlyYXRpb25UaW1lID0gd29ya0luUHJvZ3Jlc3MudXBkYXRlUXVldWUsIG5ld0V4cGlyYXRpb25UaW1lID0gbnVsbCA9PT0gbmV3RXhwaXJhdGlvblRpbWUgPyAwIDogbmV3RXhwaXJhdGlvblRpbWUuZXhwaXJhdGlvblRpbWU7CgogICAgICAgICAgZm9yICh2YXIgY2hpbGQgPSB3b3JrSW5Qcm9ncmVzcy5jaGlsZDsgbnVsbCAhPT0gY2hpbGQ7KSB7CiAgICAgICAgICAgIDAgIT09IGNoaWxkLmV4cGlyYXRpb25UaW1lICYmICgwID09PSBuZXdFeHBpcmF0aW9uVGltZSB8fCBuZXdFeHBpcmF0aW9uVGltZSA+IGNoaWxkLmV4cGlyYXRpb25UaW1lKSAmJiAobmV3RXhwaXJhdGlvblRpbWUgPSBjaGlsZC5leHBpcmF0aW9uVGltZSksIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KCiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcy5leHBpcmF0aW9uVGltZSA9IG5ld0V4cGlyYXRpb25UaW1lOwogICAgICAgIH0KCiAgICAgICAgaWYgKG51bGwgIT09IG5leHQpIHJldHVybiBuZXh0OwogICAgICAgIG51bGwgIT09IHJldHVybkZpYmVyICYmIChudWxsID09PSByZXR1cm5GaWJlci5maXJzdEVmZmVjdCAmJiAocmV0dXJuRmliZXIuZmlyc3RFZmZlY3QgPSB3b3JrSW5Qcm9ncmVzcyRqc2NvbXAkMC5maXJzdEVmZmVjdCksIG51bGwgIT09IHdvcmtJblByb2dyZXNzJGpzY29tcCQwLmxhc3RFZmZlY3QgJiYgKG51bGwgIT09IHJldHVybkZpYmVyLmxhc3RFZmZlY3QgJiYgKHJldHVybkZpYmVyLmxhc3RFZmZlY3QubmV4dEVmZmVjdCA9IHdvcmtJblByb2dyZXNzJGpzY29tcCQwLmZpcnN0RWZmZWN0KSwgcmV0dXJuRmliZXIubGFzdEVmZmVjdCA9IHdvcmtJblByb2dyZXNzJGpzY29tcCQwLmxhc3RFZmZlY3QpLCAxIDwgd29ya0luUHJvZ3Jlc3MkanNjb21wJDAuZWZmZWN0VGFnICYmIChudWxsICE9PSByZXR1cm5GaWJlci5sYXN0RWZmZWN0ID8gcmV0dXJuRmliZXIubGFzdEVmZmVjdC5uZXh0RWZmZWN0ID0gd29ya0luUHJvZ3Jlc3MkanNjb21wJDAgOiByZXR1cm5GaWJlci5maXJzdEVmZmVjdCA9IHdvcmtJblByb2dyZXNzJGpzY29tcCQwLCByZXR1cm5GaWJlci5sYXN0RWZmZWN0ID0gd29ya0luUHJvZ3Jlc3MkanNjb21wJDApKTsKICAgICAgICBpZiAobnVsbCAhPT0gc2libGluZ0ZpYmVyKSByZXR1cm4gc2libGluZ0ZpYmVyOwogICAgICAgIGlmIChudWxsICE9PSByZXR1cm5GaWJlcikgd29ya0luUHJvZ3Jlc3MkanNjb21wJDAgPSByZXR1cm5GaWJlcjtlbHNlIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzJGpzY29tcCQwLnN0YXRlTm9kZS5pc1JlYWR5Rm9yQ29tbWl0ID0gITA7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKSB7CiAgICAgIHZhciBuZXh0ID0gYmVnaW5Xb3JrKHdvcmtJblByb2dyZXNzLmFsdGVybmF0ZSwgd29ya0luUHJvZ3Jlc3MsIG5leHRSZW5kZXJFeHBpcmF0aW9uVGltZSk7CiAgICAgIG51bGwgPT09IG5leHQgJiYgKG5leHQgPSBjb21wbGV0ZVVuaXRPZldvcmsod29ya0luUHJvZ3Jlc3MpKTsKICAgICAgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCA9IG51bGw7CiAgICAgIHJldHVybiBuZXh0OwogICAgfQoKICAgIGZ1bmN0aW9uIHBlcmZvcm1GYWlsZWRVbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKSB7CiAgICAgIHZhciBuZXh0ID0gYmVnaW5GYWlsZWRXb3JrKHdvcmtJblByb2dyZXNzLmFsdGVybmF0ZSwgd29ya0luUHJvZ3Jlc3MsIG5leHRSZW5kZXJFeHBpcmF0aW9uVGltZSk7CiAgICAgIG51bGwgPT09IG5leHQgJiYgKG5leHQgPSBjb21wbGV0ZVVuaXRPZldvcmsod29ya0luUHJvZ3Jlc3MpKTsKICAgICAgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCA9IG51bGw7CiAgICAgIHJldHVybiBuZXh0OwogICAgfQoKICAgIGZ1bmN0aW9uIHdvcmtMb29wKGV4cGlyYXRpb25UaW1lKSB7CiAgICAgIGlmIChudWxsICE9PSBjYXB0dXJlZEVycm9ycykgewogICAgICAgIGlmICghKDAgPT09IG5leHRSZW5kZXJFeHBpcmF0aW9uVGltZSB8fCBuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWUgPiBleHBpcmF0aW9uVGltZSkpIGlmIChuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWUgPD0gbW9zdFJlY2VudEN1cnJlbnRUaW1lKSBmb3IgKDsgbnVsbCAhPT0gbmV4dFVuaXRPZldvcms7KSB7CiAgICAgICAgICBuZXh0VW5pdE9mV29yayA9IGhhc0NhcHR1cmVkRXJyb3IobmV4dFVuaXRPZldvcmspID8gcGVyZm9ybUZhaWxlZFVuaXRPZldvcmsobmV4dFVuaXRPZldvcmspIDogcGVyZm9ybVVuaXRPZldvcmsobmV4dFVuaXRPZldvcmspOwogICAgICAgIH0gZWxzZSBmb3IgKDsgbnVsbCAhPT0gbmV4dFVuaXRPZldvcmsgJiYgIXNob3VsZFlpZWxkKCk7KSB7CiAgICAgICAgICBuZXh0VW5pdE9mV29yayA9IGhhc0NhcHR1cmVkRXJyb3IobmV4dFVuaXRPZldvcmspID8gcGVyZm9ybUZhaWxlZFVuaXRPZldvcmsobmV4dFVuaXRPZldvcmspIDogcGVyZm9ybVVuaXRPZldvcmsobmV4dFVuaXRPZldvcmspOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICghKDAgPT09IG5leHRSZW5kZXJFeHBpcmF0aW9uVGltZSB8fCBuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWUgPiBleHBpcmF0aW9uVGltZSkpIGlmIChuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWUgPD0gbW9zdFJlY2VudEN1cnJlbnRUaW1lKSBmb3IgKDsgbnVsbCAhPT0gbmV4dFVuaXRPZldvcms7KSB7CiAgICAgICAgbmV4dFVuaXRPZldvcmsgPSBwZXJmb3JtVW5pdE9mV29yayhuZXh0VW5pdE9mV29yayk7CiAgICAgIH0gZWxzZSBmb3IgKDsgbnVsbCAhPT0gbmV4dFVuaXRPZldvcmsgJiYgIXNob3VsZFlpZWxkKCk7KSB7CiAgICAgICAgbmV4dFVuaXRPZldvcmsgPSBwZXJmb3JtVW5pdE9mV29yayhuZXh0VW5pdE9mV29yayk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiByZW5kZXJSb290KHJvb3QsIGV4cGlyYXRpb25UaW1lKSB7CiAgICAgIGludmFyaWFudCghaXNXb3JraW5nLCAicmVuZGVyUm9vdCB3YXMgY2FsbGVkIHJlY3Vyc2l2ZWx5LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICBpc1dvcmtpbmcgPSAhMDsKICAgICAgcm9vdC5pc1JlYWR5Rm9yQ29tbWl0ID0gITE7CgogICAgICBpZiAocm9vdCAhPT0gbmV4dFJvb3QgfHwgZXhwaXJhdGlvblRpbWUgIT09IG5leHRSZW5kZXJFeHBpcmF0aW9uVGltZSB8fCBudWxsID09PSBuZXh0VW5pdE9mV29yaykgewogICAgICAgIGZvciAoOyAtMSA8IGluZGV4OykgewogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBudWxsLCBpbmRleC0tOwogICAgICAgIH0KCiAgICAgICAgcHJldmlvdXNDb250ZXh0ID0gZW1wdHlPYmplY3Q7CiAgICAgICAgY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQgPSBlbXB0eU9iamVjdDsKICAgICAgICBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQgPSAhMTsKICAgICAgICByZXNldEhvc3RDb250YWluZXIoKTsKICAgICAgICBuZXh0Um9vdCA9IHJvb3Q7CiAgICAgICAgbmV4dFJlbmRlckV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWU7CiAgICAgICAgbmV4dFVuaXRPZldvcmsgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhuZXh0Um9vdC5jdXJyZW50LCBudWxsLCBleHBpcmF0aW9uVGltZSk7CiAgICAgIH0KCiAgICAgIHZhciBkaWRFcnJvciA9ICExLAogICAgICAgICAgZXJyb3IgPSBudWxsOwoKICAgICAgdHJ5IHsKICAgICAgICB3b3JrTG9vcChleHBpcmF0aW9uVGltZSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBkaWRFcnJvciA9ICEwLCBlcnJvciA9IGU7CiAgICAgIH0KCiAgICAgIGZvciAoOyBkaWRFcnJvcjspIHsKICAgICAgICBpZiAoZGlkRmF0YWwpIHsKICAgICAgICAgIGZpcnN0VW5jYXVnaHRFcnJvciA9IGVycm9yOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICB2YXIgZmFpbGVkV29yayA9IG5leHRVbml0T2ZXb3JrOwogICAgICAgIGlmIChudWxsID09PSBmYWlsZWRXb3JrKSBkaWRGYXRhbCA9ICEwO2Vsc2UgewogICAgICAgICAgdmFyIGJvdW5kYXJ5ID0gY2FwdHVyZUVycm9yKGZhaWxlZFdvcmssIGVycm9yKTsKICAgICAgICAgIGludmFyaWFudChudWxsICE9PSBib3VuZGFyeSwgIlNob3VsZCBoYXZlIGZvdW5kIGFuIGVycm9yIGJvdW5kYXJ5LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwoKICAgICAgICAgIGlmICghZGlkRmF0YWwpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBkaWRFcnJvciA9IGJvdW5kYXJ5OwogICAgICAgICAgICAgIGVycm9yID0gZXhwaXJhdGlvblRpbWU7CgogICAgICAgICAgICAgIGZvciAoYm91bmRhcnkgPSBkaWRFcnJvcjsgbnVsbCAhPT0gZmFpbGVkV29yazspIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAoZmFpbGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgIHBvcENvbnRleHRQcm92aWRlcihmYWlsZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dChmYWlsZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKGZhaWxlZFdvcmspOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoZmFpbGVkV29yayk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGZhaWxlZFdvcmsgPT09IGJvdW5kYXJ5IHx8IGZhaWxlZFdvcmsuYWx0ZXJuYXRlID09PSBib3VuZGFyeSkgYnJlYWs7CiAgICAgICAgICAgICAgICBmYWlsZWRXb3JrID0gZmFpbGVkV29ya1sicmV0dXJuIl07CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBuZXh0VW5pdE9mV29yayA9IHBlcmZvcm1GYWlsZWRVbml0T2ZXb3JrKGRpZEVycm9yKTsKICAgICAgICAgICAgICB3b3JrTG9vcChlcnJvcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBkaWRFcnJvciA9ICEwOwogICAgICAgICAgICAgIGVycm9yID0gZTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBleHBpcmF0aW9uVGltZSA9IGZpcnN0VW5jYXVnaHRFcnJvcjsKICAgICAgZGlkRmF0YWwgPSBpc1dvcmtpbmcgPSAhMTsKICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbDsKICAgICAgbnVsbCAhPT0gZXhwaXJhdGlvblRpbWUgJiYgb25VbmNhdWdodEVycm9yKGV4cGlyYXRpb25UaW1lKTsKICAgICAgcmV0dXJuIHJvb3QuaXNSZWFkeUZvckNvbW1pdCA/IHJvb3QuY3VycmVudC5hbHRlcm5hdGUgOiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIGNhcHR1cmVFcnJvcihmYWlsZWRXb3JrLCBlcnJvciRqc2NvbXAkMCkgewogICAgICB2YXIgYm91bmRhcnkgPSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50ID0gbnVsbCwKICAgICAgICAgIGVycm9yQm91bmRhcnlGb3VuZCA9ICExLAogICAgICAgICAgd2lsbFJldHJ5ID0gITEsCiAgICAgICAgICBlcnJvckJvdW5kYXJ5TmFtZSA9IG51bGw7CiAgICAgIGlmICgzID09PSBmYWlsZWRXb3JrLnRhZykgYm91bmRhcnkgPSBmYWlsZWRXb3JrLCBpc0ZhaWxlZEJvdW5kYXJ5KGZhaWxlZFdvcmspICYmIChkaWRGYXRhbCA9ICEwKTtlbHNlIGZvciAodmFyIG5vZGUgPSBmYWlsZWRXb3JrWyJyZXR1cm4iXTsgbnVsbCAhPT0gbm9kZSAmJiBudWxsID09PSBib3VuZGFyeTspIHsKICAgICAgICAyID09PSBub2RlLnRhZyA/ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBub2RlLnN0YXRlTm9kZS5jb21wb25lbnREaWRDYXRjaCAmJiAoZXJyb3JCb3VuZGFyeUZvdW5kID0gITAsIGVycm9yQm91bmRhcnlOYW1lID0gZ2V0Q29tcG9uZW50TmFtZShub2RlKSwgYm91bmRhcnkgPSBub2RlLCB3aWxsUmV0cnkgPSAhMCkgOiAzID09PSBub2RlLnRhZyAmJiAoYm91bmRhcnkgPSBub2RlKTsKCiAgICAgICAgaWYgKGlzRmFpbGVkQm91bmRhcnkobm9kZSkpIHsKICAgICAgICAgIGlmIChpc1VubW91bnRpbmcgfHwgbnVsbCAhPT0gY29tbWl0UGhhc2VCb3VuZGFyaWVzICYmIChjb21taXRQaGFzZUJvdW5kYXJpZXMuaGFzKG5vZGUpIHx8IG51bGwgIT09IG5vZGUuYWx0ZXJuYXRlICYmIGNvbW1pdFBoYXNlQm91bmRhcmllcy5oYXMobm9kZS5hbHRlcm5hdGUpKSkgcmV0dXJuIG51bGw7CiAgICAgICAgICBib3VuZGFyeSA9IG51bGw7CiAgICAgICAgICB3aWxsUmV0cnkgPSAhMTsKICAgICAgICB9CgogICAgICAgIG5vZGUgPSBub2RlWyJyZXR1cm4iXTsKICAgICAgfQoKICAgICAgaWYgKG51bGwgIT09IGJvdW5kYXJ5KSB7CiAgICAgICAgbnVsbCA9PT0gZmFpbGVkQm91bmRhcmllcyAmJiAoZmFpbGVkQm91bmRhcmllcyA9IG5ldyBTZXQoKSk7CiAgICAgICAgZmFpbGVkQm91bmRhcmllcy5hZGQoYm91bmRhcnkpOwogICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgbm9kZSA9IGZhaWxlZFdvcms7CgogICAgICAgIGRvIHsKICAgICAgICAgIGE6IHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgIHZhciBvd25lciA9IG5vZGUuX2RlYnVnT3duZXIsCiAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IG5vZGUuX2RlYnVnU291cmNlOwogICAgICAgICAgICAgIHZhciBKU0NvbXBpbGVyX2lubGluZV9yZXN1bHQgPSBnZXRDb21wb25lbnROYW1lKG5vZGUpOwogICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBudWxsOwogICAgICAgICAgICAgIG93bmVyICYmIChvd25lck5hbWUgPSBnZXRDb21wb25lbnROYW1lKG93bmVyKSk7CiAgICAgICAgICAgICAgb3duZXIgPSBzb3VyY2U7CiAgICAgICAgICAgICAgSlNDb21waWxlcl9pbmxpbmVfcmVzdWx0ID0gIlxuICAgIGluICIgKyAoSlNDb21waWxlcl9pbmxpbmVfcmVzdWx0IHx8ICJVbmtub3duIikgKyAob3duZXIgPyAiIChhdCAiICsgb3duZXIuZmlsZU5hbWUucmVwbGFjZSgvXi4qW1xcXC9dLywgIiIpICsgIjoiICsgb3duZXIubGluZU51bWJlciArICIpIiA6IG93bmVyTmFtZSA/ICIgKGNyZWF0ZWQgYnkgIiArIG93bmVyTmFtZSArICIpIiA6ICIiKTsKICAgICAgICAgICAgICBicmVhayBhOwoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBKU0NvbXBpbGVyX2lubGluZV9yZXN1bHQgPSAiIjsKICAgICAgICAgIH0KCiAgICAgICAgICBpbmZvICs9IEpTQ29tcGlsZXJfaW5saW5lX3Jlc3VsdDsKICAgICAgICAgIG5vZGUgPSBub2RlWyJyZXR1cm4iXTsKICAgICAgICB9IHdoaWxlIChub2RlKTsKCiAgICAgICAgbm9kZSA9IGluZm87CiAgICAgICAgZmFpbGVkV29yayA9IGdldENvbXBvbmVudE5hbWUoZmFpbGVkV29yayk7CiAgICAgICAgbnVsbCA9PT0gY2FwdHVyZWRFcnJvcnMgJiYgKGNhcHR1cmVkRXJyb3JzID0gbmV3IE1hcCgpKTsKICAgICAgICBlcnJvciRqc2NvbXAkMCA9IHsKICAgICAgICAgIGNvbXBvbmVudE5hbWU6IGZhaWxlZFdvcmssCiAgICAgICAgICBjb21wb25lbnRTdGFjazogbm9kZSwKICAgICAgICAgIGVycm9yOiBlcnJvciRqc2NvbXAkMCwKICAgICAgICAgIGVycm9yQm91bmRhcnk6IGVycm9yQm91bmRhcnlGb3VuZCA/IGJvdW5kYXJ5LnN0YXRlTm9kZSA6IG51bGwsCiAgICAgICAgICBlcnJvckJvdW5kYXJ5Rm91bmQ6IGVycm9yQm91bmRhcnlGb3VuZCwKICAgICAgICAgIGVycm9yQm91bmRhcnlOYW1lOiBlcnJvckJvdW5kYXJ5TmFtZSwKICAgICAgICAgIHdpbGxSZXRyeTogd2lsbFJldHJ5CiAgICAgICAgfTsKICAgICAgICBjYXB0dXJlZEVycm9ycy5zZXQoYm91bmRhcnksIGVycm9yJGpzY29tcCQwKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICghMSAhPT0gc2hvd0RpYWxvZyhlcnJvciRqc2NvbXAkMCkpIHsKICAgICAgICAgICAgdmFyIGVycm9yID0gZXJyb3IkanNjb21wJDAuZXJyb3I7CiAgICAgICAgICAgIGVycm9yICYmIGVycm9yLnN1cHByZXNzUmVhY3RFcnJvckxvZ2dpbmcgfHwgY29uc29sZS5lcnJvcihlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgZSAmJiBlLnN1cHByZXNzUmVhY3RFcnJvckxvZ2dpbmcgfHwgY29uc29sZS5lcnJvcihlKTsKICAgICAgICB9CgogICAgICAgIGlzQ29tbWl0dGluZyA/IChudWxsID09PSBjb21taXRQaGFzZUJvdW5kYXJpZXMgJiYgKGNvbW1pdFBoYXNlQm91bmRhcmllcyA9IG5ldyBTZXQoKSksIGNvbW1pdFBoYXNlQm91bmRhcmllcy5hZGQoYm91bmRhcnkpKSA6IHNjaGVkdWxlRXJyb3JSZWNvdmVyeShib3VuZGFyeSk7CiAgICAgICAgcmV0dXJuIGJvdW5kYXJ5OwogICAgICB9CgogICAgICBudWxsID09PSBmaXJzdFVuY2F1Z2h0RXJyb3IgJiYgKGZpcnN0VW5jYXVnaHRFcnJvciA9IGVycm9yJGpzY29tcCQwKTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gaGFzQ2FwdHVyZWRFcnJvcihmaWJlcikgewogICAgICByZXR1cm4gbnVsbCAhPT0gY2FwdHVyZWRFcnJvcnMgJiYgKGNhcHR1cmVkRXJyb3JzLmhhcyhmaWJlcikgfHwgbnVsbCAhPT0gZmliZXIuYWx0ZXJuYXRlICYmIGNhcHR1cmVkRXJyb3JzLmhhcyhmaWJlci5hbHRlcm5hdGUpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0ZhaWxlZEJvdW5kYXJ5KGZpYmVyKSB7CiAgICAgIHJldHVybiBudWxsICE9PSBmYWlsZWRCb3VuZGFyaWVzICYmIChmYWlsZWRCb3VuZGFyaWVzLmhhcyhmaWJlcikgfHwgbnVsbCAhPT0gZmliZXIuYWx0ZXJuYXRlICYmIGZhaWxlZEJvdW5kYXJpZXMuaGFzKGZpYmVyLmFsdGVybmF0ZSkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbXB1dGVBc3luY0V4cGlyYXRpb24oKSB7CiAgICAgIHJldHVybiAyMCAqICgoKHJlY2FsY3VsYXRlQ3VycmVudFRpbWUoKSArIDEwMCkgLyAyMCB8IDApICsgMSk7CiAgICB9CgogICAgZnVuY3Rpb24gY29tcHV0ZUV4cGlyYXRpb25Gb3JGaWJlcihmaWJlcikgewogICAgICByZXR1cm4gMCAhPT0gZXhwaXJhdGlvbkNvbnRleHQgPyBleHBpcmF0aW9uQ29udGV4dCA6IGlzV29ya2luZyA/IGlzQ29tbWl0dGluZyA/IDEgOiBuZXh0UmVuZGVyRXhwaXJhdGlvblRpbWUgOiAhdXNlU3luY1NjaGVkdWxpbmcgfHwgZmliZXIuaW50ZXJuYWxDb250ZXh0VGFnICYgMSA/IGNvbXB1dGVBc3luY0V4cGlyYXRpb24oKSA6IDE7CiAgICB9CgogICAgZnVuY3Rpb24gc2NoZWR1bGVXb3JrKGZpYmVyLCBleHBpcmF0aW9uVGltZSkgewogICAgICByZXR1cm4gc2NoZWR1bGVXb3JrSW1wbChmaWJlciwgZXhwaXJhdGlvblRpbWUsICExKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzY2hlZHVsZVdvcmtJbXBsKGZpYmVyLCBleHBpcmF0aW9uVGltZSkgewogICAgICBmb3IgKDsgbnVsbCAhPT0gZmliZXI7KSB7CiAgICAgICAgaWYgKDAgPT09IGZpYmVyLmV4cGlyYXRpb25UaW1lIHx8IGZpYmVyLmV4cGlyYXRpb25UaW1lID4gZXhwaXJhdGlvblRpbWUpIGZpYmVyLmV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWU7CiAgICAgICAgbnVsbCAhPT0gZmliZXIuYWx0ZXJuYXRlICYmICgwID09PSBmaWJlci5hbHRlcm5hdGUuZXhwaXJhdGlvblRpbWUgfHwgZmliZXIuYWx0ZXJuYXRlLmV4cGlyYXRpb25UaW1lID4gZXhwaXJhdGlvblRpbWUpICYmIChmaWJlci5hbHRlcm5hdGUuZXhwaXJhdGlvblRpbWUgPSBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgaWYgKG51bGwgPT09IGZpYmVyWyJyZXR1cm4iXSkgaWYgKDMgPT09IGZpYmVyLnRhZykgewogICAgICAgICAgdmFyIHJvb3QgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAhaXNXb3JraW5nICYmIHJvb3QgPT09IG5leHRSb290ICYmIGV4cGlyYXRpb25UaW1lIDwgbmV4dFJlbmRlckV4cGlyYXRpb25UaW1lICYmIChuZXh0VW5pdE9mV29yayA9IG5leHRSb290ID0gbnVsbCwgbmV4dFJlbmRlckV4cGlyYXRpb25UaW1lID0gMCk7CiAgICAgICAgICByZXF1ZXN0V29yayhyb290LCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgICAhaXNXb3JraW5nICYmIHJvb3QgPT09IG5leHRSb290ICYmIGV4cGlyYXRpb25UaW1lIDwgbmV4dFJlbmRlckV4cGlyYXRpb25UaW1lICYmIChuZXh0VW5pdE9mV29yayA9IG5leHRSb290ID0gbnVsbCwgbmV4dFJlbmRlckV4cGlyYXRpb25UaW1lID0gMCk7CiAgICAgICAgfSBlbHNlIGJyZWFrOwogICAgICAgIGZpYmVyID0gZmliZXJbInJldHVybiJdOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2NoZWR1bGVFcnJvclJlY292ZXJ5KGZpYmVyKSB7CiAgICAgIHNjaGVkdWxlV29ya0ltcGwoZmliZXIsIDEsICEwKTsKICAgIH0KCiAgICBmdW5jdGlvbiByZWNhbGN1bGF0ZUN1cnJlbnRUaW1lKCkgewogICAgICByZXR1cm4gbW9zdFJlY2VudEN1cnJlbnRUaW1lID0gKChub3coKSAtIHN0YXJ0VGltZSkgLyAxMCB8IDApICsgMjsKICAgIH0KCiAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrV2l0aEV4cGlyYXRpb24oZXhwaXJhdGlvblRpbWUpIHsKICAgICAgaWYgKDAgIT09IGNhbGxiYWNrRXhwaXJhdGlvblRpbWUpIHsKICAgICAgICBpZiAoZXhwaXJhdGlvblRpbWUgPiBjYWxsYmFja0V4cGlyYXRpb25UaW1lKSByZXR1cm47CiAgICAgICAgY2FuY2VsRGVmZXJyZWRDYWxsYmFjayhjYWxsYmFja0lEKTsKICAgICAgfQoKICAgICAgdmFyIGN1cnJlbnRNcyA9IG5vdygpIC0gc3RhcnRUaW1lOwogICAgICBjYWxsYmFja0V4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWU7CiAgICAgIGNhbGxiYWNrSUQgPSBzY2hlZHVsZURlZmVycmVkQ2FsbGJhY2socGVyZm9ybUFzeW5jV29yaywgewogICAgICAgIHRpbWVvdXQ6IDEwICogKGV4cGlyYXRpb25UaW1lIC0gMikgLSBjdXJyZW50TXMKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gcmVxdWVzdFdvcmsocm9vdCwgZXhwaXJhdGlvblRpbWUpIHsKICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPiBORVNURURfVVBEQVRFX0xJTUlUICYmIGludmFyaWFudCghMSwgIk1heGltdW0gdXBkYXRlIGRlcHRoIGV4Y2VlZGVkLiBUaGlzIGNhbiBoYXBwZW4gd2hlbiBhIGNvbXBvbmVudCByZXBlYXRlZGx5IGNhbGxzIHNldFN0YXRlIGluc2lkZSBjb21wb25lbnRXaWxsVXBkYXRlIG9yIGNvbXBvbmVudERpZFVwZGF0ZS4gUmVhY3QgbGltaXRzIHRoZSBudW1iZXIgb2YgbmVzdGVkIHVwZGF0ZXMgdG8gcHJldmVudCBpbmZpbml0ZSBsb29wcy4iKTsKICAgICAgaWYgKG51bGwgPT09IHJvb3QubmV4dFNjaGVkdWxlZFJvb3QpIHJvb3QucmVtYWluaW5nRXhwaXJhdGlvblRpbWUgPSBleHBpcmF0aW9uVGltZSwgbnVsbCA9PT0gbGFzdFNjaGVkdWxlZFJvb3QgPyAoZmlyc3RTY2hlZHVsZWRSb290ID0gbGFzdFNjaGVkdWxlZFJvb3QgPSByb290LCByb290Lm5leHRTY2hlZHVsZWRSb290ID0gcm9vdCkgOiAobGFzdFNjaGVkdWxlZFJvb3QgPSBsYXN0U2NoZWR1bGVkUm9vdC5uZXh0U2NoZWR1bGVkUm9vdCA9IHJvb3QsIGxhc3RTY2hlZHVsZWRSb290Lm5leHRTY2hlZHVsZWRSb290ID0gZmlyc3RTY2hlZHVsZWRSb290KTtlbHNlIHsKICAgICAgICB2YXIgcmVtYWluaW5nRXhwaXJhdGlvblRpbWUgPSByb290LnJlbWFpbmluZ0V4cGlyYXRpb25UaW1lOwogICAgICAgIGlmICgwID09PSByZW1haW5pbmdFeHBpcmF0aW9uVGltZSB8fCBleHBpcmF0aW9uVGltZSA8IHJlbWFpbmluZ0V4cGlyYXRpb25UaW1lKSByb290LnJlbWFpbmluZ0V4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWU7CiAgICAgIH0KICAgICAgaXNSZW5kZXJpbmcgfHwgKGlzQmF0Y2hpbmdVcGRhdGVzID8gaXNVbmJhdGNoaW5nVXBkYXRlcyAmJiAobmV4dEZsdXNoZWRSb290ID0gcm9vdCwgbmV4dEZsdXNoZWRFeHBpcmF0aW9uVGltZSA9IDEsIHBlcmZvcm1Xb3JrT25Sb290KHJvb3QsIDEsIHJlY2FsY3VsYXRlQ3VycmVudFRpbWUoKSkpIDogMSA9PT0gZXhwaXJhdGlvblRpbWUgPyBwZXJmb3JtV29yaygxLCBudWxsKSA6IHNjaGVkdWxlQ2FsbGJhY2tXaXRoRXhwaXJhdGlvbihleHBpcmF0aW9uVGltZSkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGZpbmRIaWdoZXN0UHJpb3JpdHlSb290KCkgewogICAgICB2YXIgaGlnaGVzdFByaW9yaXR5V29yayA9IDAsCiAgICAgICAgICBoaWdoZXN0UHJpb3JpdHlSb290ID0gbnVsbDsKICAgICAgaWYgKG51bGwgIT09IGxhc3RTY2hlZHVsZWRSb290KSBmb3IgKHZhciBwcmV2aW91c1NjaGVkdWxlZFJvb3QgPSBsYXN0U2NoZWR1bGVkUm9vdCwgcm9vdCA9IGZpcnN0U2NoZWR1bGVkUm9vdDsgbnVsbCAhPT0gcm9vdDspIHsKICAgICAgICB2YXIgcmVtYWluaW5nRXhwaXJhdGlvblRpbWUgPSByb290LnJlbWFpbmluZ0V4cGlyYXRpb25UaW1lOwoKICAgICAgICBpZiAoMCA9PT0gcmVtYWluaW5nRXhwaXJhdGlvblRpbWUpIHsKICAgICAgICAgIGludmFyaWFudChudWxsICE9PSBwcmV2aW91c1NjaGVkdWxlZFJvb3QgJiYgbnVsbCAhPT0gbGFzdFNjaGVkdWxlZFJvb3QsICJTaG91bGQgaGF2ZSBhIHByZXZpb3VzIGFuZCBsYXN0IHJvb3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CgogICAgICAgICAgaWYgKHJvb3QgPT09IHJvb3QubmV4dFNjaGVkdWxlZFJvb3QpIHsKICAgICAgICAgICAgZmlyc3RTY2hlZHVsZWRSb290ID0gbGFzdFNjaGVkdWxlZFJvb3QgPSByb290Lm5leHRTY2hlZHVsZWRSb290ID0gbnVsbDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3QgPT09IGZpcnN0U2NoZWR1bGVkUm9vdCkgZmlyc3RTY2hlZHVsZWRSb290ID0gcmVtYWluaW5nRXhwaXJhdGlvblRpbWUgPSByb290Lm5leHRTY2hlZHVsZWRSb290LCBsYXN0U2NoZWR1bGVkUm9vdC5uZXh0U2NoZWR1bGVkUm9vdCA9IHJlbWFpbmluZ0V4cGlyYXRpb25UaW1lLCByb290Lm5leHRTY2hlZHVsZWRSb290ID0gbnVsbDtlbHNlIGlmIChyb290ID09PSBsYXN0U2NoZWR1bGVkUm9vdCkgewogICAgICAgICAgICBsYXN0U2NoZWR1bGVkUm9vdCA9IHByZXZpb3VzU2NoZWR1bGVkUm9vdDsKICAgICAgICAgICAgbGFzdFNjaGVkdWxlZFJvb3QubmV4dFNjaGVkdWxlZFJvb3QgPSBmaXJzdFNjaGVkdWxlZFJvb3Q7CiAgICAgICAgICAgIHJvb3QubmV4dFNjaGVkdWxlZFJvb3QgPSBudWxsOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0gZWxzZSBwcmV2aW91c1NjaGVkdWxlZFJvb3QubmV4dFNjaGVkdWxlZFJvb3QgPSByb290Lm5leHRTY2hlZHVsZWRSb290LCByb290Lm5leHRTY2hlZHVsZWRSb290ID0gbnVsbDsKCiAgICAgICAgICByb290ID0gcHJldmlvdXNTY2hlZHVsZWRSb290Lm5leHRTY2hlZHVsZWRSb290OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoMCA9PT0gaGlnaGVzdFByaW9yaXR5V29yayB8fCByZW1haW5pbmdFeHBpcmF0aW9uVGltZSA8IGhpZ2hlc3RQcmlvcml0eVdvcmspIGhpZ2hlc3RQcmlvcml0eVdvcmsgPSByZW1haW5pbmdFeHBpcmF0aW9uVGltZSwgaGlnaGVzdFByaW9yaXR5Um9vdCA9IHJvb3Q7CiAgICAgICAgICBpZiAocm9vdCA9PT0gbGFzdFNjaGVkdWxlZFJvb3QpIGJyZWFrOwogICAgICAgICAgcHJldmlvdXNTY2hlZHVsZWRSb290ID0gcm9vdDsKICAgICAgICAgIHJvb3QgPSByb290Lm5leHRTY2hlZHVsZWRSb290OwogICAgICAgIH0KICAgICAgfQogICAgICBwcmV2aW91c1NjaGVkdWxlZFJvb3QgPSBuZXh0Rmx1c2hlZFJvb3Q7CiAgICAgIG51bGwgIT09IHByZXZpb3VzU2NoZWR1bGVkUm9vdCAmJiBwcmV2aW91c1NjaGVkdWxlZFJvb3QgPT09IGhpZ2hlc3RQcmlvcml0eVJvb3QgPyBuZXN0ZWRVcGRhdGVDb3VudCsrIDogbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICBuZXh0Rmx1c2hlZFJvb3QgPSBoaWdoZXN0UHJpb3JpdHlSb290OwogICAgICBuZXh0Rmx1c2hlZEV4cGlyYXRpb25UaW1lID0gaGlnaGVzdFByaW9yaXR5V29yazsKICAgIH0KCiAgICBmdW5jdGlvbiBwZXJmb3JtQXN5bmNXb3JrKGRsKSB7CiAgICAgIHBlcmZvcm1Xb3JrKDAsIGRsKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwZXJmb3JtV29yayhtaW5FeHBpcmF0aW9uVGltZSwgZGwpIHsKICAgICAgZGVhZGxpbmUgPSBkbDsKCiAgICAgIGZvciAoZmluZEhpZ2hlc3RQcmlvcml0eVJvb3QoKTsgbnVsbCAhPT0gbmV4dEZsdXNoZWRSb290ICYmIDAgIT09IG5leHRGbHVzaGVkRXhwaXJhdGlvblRpbWUgJiYgKDAgPT09IG1pbkV4cGlyYXRpb25UaW1lIHx8IG5leHRGbHVzaGVkRXhwaXJhdGlvblRpbWUgPD0gbWluRXhwaXJhdGlvblRpbWUpICYmICFkZWFkbGluZURpZEV4cGlyZTspIHsKICAgICAgICBwZXJmb3JtV29ya09uUm9vdChuZXh0Rmx1c2hlZFJvb3QsIG5leHRGbHVzaGVkRXhwaXJhdGlvblRpbWUsIHJlY2FsY3VsYXRlQ3VycmVudFRpbWUoKSksIGZpbmRIaWdoZXN0UHJpb3JpdHlSb290KCk7CiAgICAgIH0KCiAgICAgIG51bGwgIT09IGRlYWRsaW5lICYmIChjYWxsYmFja0V4cGlyYXRpb25UaW1lID0gMCwgY2FsbGJhY2tJRCA9IC0xKTsKICAgICAgMCAhPT0gbmV4dEZsdXNoZWRFeHBpcmF0aW9uVGltZSAmJiBzY2hlZHVsZUNhbGxiYWNrV2l0aEV4cGlyYXRpb24obmV4dEZsdXNoZWRFeHBpcmF0aW9uVGltZSk7CiAgICAgIGRlYWRsaW5lID0gbnVsbDsKICAgICAgZGVhZGxpbmVEaWRFeHBpcmUgPSAhMTsKICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICBmaW5pc2hSZW5kZXJpbmcoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBmaW5pc2hSZW5kZXJpbmcoKSB7CiAgICAgIGlmIChudWxsICE9PSBjb21wbGV0ZWRCYXRjaGVzKSB7CiAgICAgICAgdmFyIGJhdGNoZXMgPSBjb21wbGV0ZWRCYXRjaGVzOwogICAgICAgIGNvbXBsZXRlZEJhdGNoZXMgPSBudWxsOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJhdGNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBiYXRjaCA9IGJhdGNoZXNbaV07CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYmF0Y2guX29uQ29tcGxldGUoKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGhhc1VuaGFuZGxlZEVycm9yIHx8IChoYXNVbmhhbmRsZWRFcnJvciA9ICEwLCB1bmhhbmRsZWRFcnJvciA9IGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChoYXNVbmhhbmRsZWRFcnJvcikgdGhyb3cgYmF0Y2hlcyA9IHVuaGFuZGxlZEVycm9yLCB1bmhhbmRsZWRFcnJvciA9IG51bGwsIGhhc1VuaGFuZGxlZEVycm9yID0gITEsIGJhdGNoZXM7CiAgICB9CgogICAgZnVuY3Rpb24gcGVyZm9ybVdvcmtPblJvb3Qocm9vdCwgZXhwaXJhdGlvblRpbWUsIGN1cnJlbnRUaW1lKSB7CiAgICAgIGludmFyaWFudCghaXNSZW5kZXJpbmcsICJwZXJmb3JtV29ya09uUm9vdCB3YXMgY2FsbGVkIHJlY3Vyc2l2ZWx5LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICBpc1JlbmRlcmluZyA9ICEwOwogICAgICBleHBpcmF0aW9uVGltZSA8PSBjdXJyZW50VGltZSA/IChjdXJyZW50VGltZSA9IHJvb3QuZmluaXNoZWRXb3JrLCBudWxsICE9PSBjdXJyZW50VGltZSA/IGNvbXBsZXRlUm9vdChyb290LCBjdXJyZW50VGltZSwgZXhwaXJhdGlvblRpbWUpIDogKHJvb3QuZmluaXNoZWRXb3JrID0gbnVsbCwgY3VycmVudFRpbWUgPSByZW5kZXJSb290KHJvb3QsIGV4cGlyYXRpb25UaW1lKSwgbnVsbCAhPT0gY3VycmVudFRpbWUgJiYgY29tcGxldGVSb290KHJvb3QsIGN1cnJlbnRUaW1lLCBleHBpcmF0aW9uVGltZSkpKSA6IChjdXJyZW50VGltZSA9IHJvb3QuZmluaXNoZWRXb3JrLCBudWxsICE9PSBjdXJyZW50VGltZSA/IGNvbXBsZXRlUm9vdChyb290LCBjdXJyZW50VGltZSwgZXhwaXJhdGlvblRpbWUpIDogKHJvb3QuZmluaXNoZWRXb3JrID0gbnVsbCwgY3VycmVudFRpbWUgPSByZW5kZXJSb290KHJvb3QsIGV4cGlyYXRpb25UaW1lKSwgbnVsbCAhPT0gY3VycmVudFRpbWUgJiYgKHNob3VsZFlpZWxkKCkgPyByb290LmZpbmlzaGVkV29yayA9IGN1cnJlbnRUaW1lIDogY29tcGxldGVSb290KHJvb3QsIGN1cnJlbnRUaW1lLCBleHBpcmF0aW9uVGltZSkpKSk7CiAgICAgIGlzUmVuZGVyaW5nID0gITE7CiAgICB9CgogICAgZnVuY3Rpb24gY29tcGxldGVSb290KHJvb3QsIGZpbmlzaGVkV29yaywgZXhwaXJhdGlvblRpbWUpIHsKICAgICAgdmFyIGZpcnN0QmF0Y2ggPSByb290LmZpcnN0QmF0Y2g7CgogICAgICBpZiAobnVsbCAhPT0gZmlyc3RCYXRjaCAmJiBmaXJzdEJhdGNoLl9leHBpcmF0aW9uVGltZSA8PSBleHBpcmF0aW9uVGltZSAmJiAobnVsbCA9PT0gY29tcGxldGVkQmF0Y2hlcyA/IGNvbXBsZXRlZEJhdGNoZXMgPSBbZmlyc3RCYXRjaF0gOiBjb21wbGV0ZWRCYXRjaGVzLnB1c2goZmlyc3RCYXRjaCksIGZpcnN0QmF0Y2guX2RlZmVyKSkgewogICAgICAgIHJvb3QuZmluaXNoZWRXb3JrID0gZmluaXNoZWRXb3JrOwogICAgICAgIHJvb3QucmVtYWluaW5nRXhwaXJhdGlvblRpbWUgPSAwOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgcm9vdC5maW5pc2hlZFdvcmsgPSBudWxsOwogICAgICBpc0NvbW1pdHRpbmcgPSBpc1dvcmtpbmcgPSAhMDsKICAgICAgZXhwaXJhdGlvblRpbWUgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICBpbnZhcmlhbnQoZXhwaXJhdGlvblRpbWUuY3VycmVudCAhPT0gZmluaXNoZWRXb3JrLCAiQ2Fubm90IGNvbW1pdCB0aGUgc2FtZSB0cmVlIGFzIGJlZm9yZS4gVGhpcyBpcyBwcm9iYWJseSBhIGJ1ZyByZWxhdGVkIHRvIHRoZSByZXR1cm4gZmllbGQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgIGV4cGlyYXRpb25UaW1lLmlzUmVhZHlGb3JDb21taXQgPSAhMTsKICAgICAgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCA9IG51bGw7CiAgICAgIDEgPCBmaW5pc2hlZFdvcmsuZWZmZWN0VGFnID8gbnVsbCAhPT0gZmluaXNoZWRXb3JrLmxhc3RFZmZlY3QgPyAoZmluaXNoZWRXb3JrLmxhc3RFZmZlY3QubmV4dEVmZmVjdCA9IGZpbmlzaGVkV29yaywgZmlyc3RCYXRjaCA9IGZpbmlzaGVkV29yay5maXJzdEVmZmVjdCkgOiBmaXJzdEJhdGNoID0gZmluaXNoZWRXb3JrIDogZmlyc3RCYXRjaCA9IGZpbmlzaGVkV29yay5maXJzdEVmZmVjdDsKICAgICAgcHJlcGFyZUZvckNvbW1pdCgpOwoKICAgICAgZm9yIChuZXh0RWZmZWN0ID0gZmlyc3RCYXRjaDsgbnVsbCAhPT0gbmV4dEVmZmVjdDspIHsKICAgICAgICB2YXIgZGlkRXJyb3IgPSAhMSwKICAgICAgICAgICAgX2Vycm9yID0gdm9pZCAwOwoKICAgICAgICB0cnkgewogICAgICAgICAgZm9yICg7IG51bGwgIT09IG5leHRFZmZlY3Q7KSB7CiAgICAgICAgICAgIHZhciBlZmZlY3RUYWcgPSBuZXh0RWZmZWN0LmVmZmVjdFRhZzsKICAgICAgICAgICAgZWZmZWN0VGFnICYgMTYgJiYgY29tbWl0UmVzZXRUZXh0Q29udGVudChuZXh0RWZmZWN0KTsKCiAgICAgICAgICAgIGlmIChlZmZlY3RUYWcgJiAxMjgpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IG5leHRFZmZlY3QuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIG51bGwgIT09IGN1cnJlbnQgJiYgY29tbWl0RGV0YWNoUmVmKGN1cnJlbnQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2ggKGVmZmVjdFRhZyAmIC0yNDIpIHsKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBjb21taXRQbGFjZW1lbnQobmV4dEVmZmVjdCk7CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0LmVmZmVjdFRhZyAmPSAtMzsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICBjb21taXRQbGFjZW1lbnQobmV4dEVmZmVjdCk7CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0LmVmZmVjdFRhZyAmPSAtMzsKICAgICAgICAgICAgICAgIGNvbW1pdFdvcmsobmV4dEVmZmVjdC5hbHRlcm5hdGUsIG5leHRFZmZlY3QpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIGNvbW1pdFdvcmsobmV4dEVmZmVjdC5hbHRlcm5hdGUsIG5leHRFZmZlY3QpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgICAgIGlzVW5tb3VudGluZyA9ICEwLCBjb21taXREZWxldGlvbihuZXh0RWZmZWN0KSwgaXNVbm1vdW50aW5nID0gITE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBuZXh0RWZmZWN0Lm5leHRFZmZlY3Q7CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgZGlkRXJyb3IgPSAhMCwgX2Vycm9yID0gZTsKICAgICAgICB9CgogICAgICAgIGRpZEVycm9yICYmIChpbnZhcmlhbnQobnVsbCAhPT0gbmV4dEVmZmVjdCwgIlNob3VsZCBoYXZlIG5leHQgZWZmZWN0LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpLCBjYXB0dXJlRXJyb3IobmV4dEVmZmVjdCwgX2Vycm9yKSwgbnVsbCAhPT0gbmV4dEVmZmVjdCAmJiAobmV4dEVmZmVjdCA9IG5leHRFZmZlY3QubmV4dEVmZmVjdCkpOwogICAgICB9CgogICAgICByZXNldEFmdGVyQ29tbWl0KCk7CiAgICAgIGV4cGlyYXRpb25UaW1lLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CgogICAgICBmb3IgKG5leHRFZmZlY3QgPSBmaXJzdEJhdGNoOyBudWxsICE9PSBuZXh0RWZmZWN0OykgewogICAgICAgIGVmZmVjdFRhZyA9ICExOwogICAgICAgIGN1cnJlbnQgPSB2b2lkIDA7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBmb3IgKDsgbnVsbCAhPT0gbmV4dEVmZmVjdDspIHsKICAgICAgICAgICAgdmFyIGVmZmVjdFRhZyRqc2NvbXAkMCA9IG5leHRFZmZlY3QuZWZmZWN0VGFnOwogICAgICAgICAgICBlZmZlY3RUYWckanNjb21wJDAgJiAzNiAmJiBjb21taXRMaWZlQ3ljbGVzKG5leHRFZmZlY3QuYWx0ZXJuYXRlLCBuZXh0RWZmZWN0KTsKICAgICAgICAgICAgZWZmZWN0VGFnJGpzY29tcCQwICYgMTI4ICYmIGNvbW1pdEF0dGFjaFJlZihuZXh0RWZmZWN0KTsKICAgICAgICAgICAgaWYgKGVmZmVjdFRhZyRqc2NvbXAkMCAmIDY0KSBzd2l0Y2ggKGZpcnN0QmF0Y2ggPSBuZXh0RWZmZWN0LCBkaWRFcnJvciA9IHZvaWQgMCwgbnVsbCAhPT0gY2FwdHVyZWRFcnJvcnMgJiYgKGRpZEVycm9yID0gY2FwdHVyZWRFcnJvcnMuZ2V0KGZpcnN0QmF0Y2gpLCBjYXB0dXJlZEVycm9yc1siZGVsZXRlIl0oZmlyc3RCYXRjaCksIG51bGwgPT0gZGlkRXJyb3IgJiYgbnVsbCAhPT0gZmlyc3RCYXRjaC5hbHRlcm5hdGUgJiYgKGZpcnN0QmF0Y2ggPSBmaXJzdEJhdGNoLmFsdGVybmF0ZSwgZGlkRXJyb3IgPSBjYXB0dXJlZEVycm9ycy5nZXQoZmlyc3RCYXRjaCksIGNhcHR1cmVkRXJyb3JzWyJkZWxldGUiXShmaXJzdEJhdGNoKSkpLCBpbnZhcmlhbnQobnVsbCAhPSBkaWRFcnJvciwgIk5vIGVycm9yIGZvciBnaXZlbiB1bml0IG9mIHdvcmsuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiksIGZpcnN0QmF0Y2gudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgZmlyc3RCYXRjaC5zdGF0ZU5vZGUuY29tcG9uZW50RGlkQ2F0Y2goZGlkRXJyb3IuZXJyb3IsIHsKICAgICAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2s6IGRpZEVycm9yLmNvbXBvbmVudFN0YWNrCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICBudWxsID09PSBmaXJzdFVuY2F1Z2h0RXJyb3IgJiYgKGZpcnN0VW5jYXVnaHRFcnJvciA9IGRpZEVycm9yLmVycm9yKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgaW52YXJpYW50KCExLCAiSW52YWxpZCB0eXBlIG9mIHdvcmsuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHQgPSBuZXh0RWZmZWN0Lm5leHRFZmZlY3Q7CiAgICAgICAgICAgIG5leHRFZmZlY3QubmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGVmZmVjdFRhZyA9ICEwLCBjdXJyZW50ID0gZTsKICAgICAgICB9CgogICAgICAgIGVmZmVjdFRhZyAmJiAoaW52YXJpYW50KG51bGwgIT09IG5leHRFZmZlY3QsICJTaG91bGQgaGF2ZSBuZXh0IGVmZmVjdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKSwgY2FwdHVyZUVycm9yKG5leHRFZmZlY3QsIGN1cnJlbnQpLCBudWxsICE9PSBuZXh0RWZmZWN0ICYmIChuZXh0RWZmZWN0ID0gbmV4dEVmZmVjdC5uZXh0RWZmZWN0KSk7CiAgICAgIH0KCiAgICAgIGlzV29ya2luZyA9IGlzQ29tbWl0dGluZyA9ICExOwogICAgICAiZnVuY3Rpb24iID09PSB0eXBlb2Ygb25Db21taXRSb290ICYmIG9uQ29tbWl0Um9vdChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlKTsKICAgICAgY29tbWl0UGhhc2VCb3VuZGFyaWVzICYmIChjb21taXRQaGFzZUJvdW5kYXJpZXMuZm9yRWFjaChzY2hlZHVsZUVycm9yUmVjb3ZlcnkpLCBjb21taXRQaGFzZUJvdW5kYXJpZXMgPSBudWxsKTsKICAgICAgbnVsbCAhPT0gZmlyc3RVbmNhdWdodEVycm9yICYmIChmaW5pc2hlZFdvcmsgPSBmaXJzdFVuY2F1Z2h0RXJyb3IsIGZpcnN0VW5jYXVnaHRFcnJvciA9IG51bGwsIG9uVW5jYXVnaHRFcnJvcihmaW5pc2hlZFdvcmspKTsKICAgICAgZmluaXNoZWRXb3JrID0gZXhwaXJhdGlvblRpbWUuY3VycmVudC5leHBpcmF0aW9uVGltZTsKICAgICAgMCA9PT0gZmluaXNoZWRXb3JrICYmIChmYWlsZWRCb3VuZGFyaWVzID0gY2FwdHVyZWRFcnJvcnMgPSBudWxsKTsKICAgICAgcm9vdC5yZW1haW5pbmdFeHBpcmF0aW9uVGltZSA9IGZpbmlzaGVkV29yazsKICAgIH0KCiAgICBmdW5jdGlvbiBzaG91bGRZaWVsZCgpIHsKICAgICAgcmV0dXJuIG51bGwgPT09IGRlYWRsaW5lIHx8IGRlYWRsaW5lLnRpbWVSZW1haW5pbmcoKSA+IHRpbWVIZXVyaXN0aWNGb3JVbml0T2ZXb3JrID8gITEgOiBkZWFkbGluZURpZEV4cGlyZSA9ICEwOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uVW5jYXVnaHRFcnJvcihlcnJvcikgewogICAgICBpbnZhcmlhbnQobnVsbCAhPT0gbmV4dEZsdXNoZWRSb290LCAiU2hvdWxkIGJlIHdvcmtpbmcgb24gYSByb290LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICBuZXh0Rmx1c2hlZFJvb3QucmVtYWluaW5nRXhwaXJhdGlvblRpbWUgPSAwOwogICAgICBoYXNVbmhhbmRsZWRFcnJvciB8fCAoaGFzVW5oYW5kbGVkRXJyb3IgPSAhMCwgdW5oYW5kbGVkRXJyb3IgPSBlcnJvcik7CiAgICB9CgogICAgdmFyIGhvc3RDb250ZXh0ID0gUmVhY3RGaWJlckhvc3RDb250ZXh0KGNvbmZpZyksCiAgICAgICAgaHlkcmF0aW9uQ29udGV4dCA9IFJlYWN0RmliZXJIeWRyYXRpb25Db250ZXh0KGNvbmZpZyksCiAgICAgICAgcG9wSG9zdENvbnRhaW5lciA9IGhvc3RDb250ZXh0LnBvcEhvc3RDb250YWluZXIsCiAgICAgICAgcG9wSG9zdENvbnRleHQgPSBob3N0Q29udGV4dC5wb3BIb3N0Q29udGV4dCwKICAgICAgICByZXNldEhvc3RDb250YWluZXIgPSBob3N0Q29udGV4dC5yZXNldEhvc3RDb250YWluZXIsCiAgICAgICAgX1JlYWN0RmliZXJCZWdpbldvcmsgPSBSZWFjdEZpYmVyQmVnaW5Xb3JrKGNvbmZpZywgaG9zdENvbnRleHQsIGh5ZHJhdGlvbkNvbnRleHQsIHNjaGVkdWxlV29yaywgY29tcHV0ZUV4cGlyYXRpb25Gb3JGaWJlciksCiAgICAgICAgYmVnaW5Xb3JrID0gX1JlYWN0RmliZXJCZWdpbldvcmsuYmVnaW5Xb3JrLAogICAgICAgIGJlZ2luRmFpbGVkV29yayA9IF9SZWFjdEZpYmVyQmVnaW5Xb3JrLmJlZ2luRmFpbGVkV29yaywKICAgICAgICBjb21wbGV0ZVdvcmsgPSBSZWFjdEZpYmVyQ29tcGxldGVXb3JrKGNvbmZpZywgaG9zdENvbnRleHQsIGh5ZHJhdGlvbkNvbnRleHQpLmNvbXBsZXRlV29yazsKCiAgICBob3N0Q29udGV4dCA9IFJlYWN0RmliZXJDb21taXRXb3JrKGNvbmZpZywgY2FwdHVyZUVycm9yKTsKICAgIHZhciBjb21taXRSZXNldFRleHRDb250ZW50ID0gaG9zdENvbnRleHQuY29tbWl0UmVzZXRUZXh0Q29udGVudCwKICAgICAgICBjb21taXRQbGFjZW1lbnQgPSBob3N0Q29udGV4dC5jb21taXRQbGFjZW1lbnQsCiAgICAgICAgY29tbWl0RGVsZXRpb24gPSBob3N0Q29udGV4dC5jb21taXREZWxldGlvbiwKICAgICAgICBjb21taXRXb3JrID0gaG9zdENvbnRleHQuY29tbWl0V29yaywKICAgICAgICBjb21taXRMaWZlQ3ljbGVzID0gaG9zdENvbnRleHQuY29tbWl0TGlmZUN5Y2xlcywKICAgICAgICBjb21taXRBdHRhY2hSZWYgPSBob3N0Q29udGV4dC5jb21taXRBdHRhY2hSZWYsCiAgICAgICAgY29tbWl0RGV0YWNoUmVmID0gaG9zdENvbnRleHQuY29tbWl0RGV0YWNoUmVmLAogICAgICAgIG5vdyA9IGNvbmZpZy5ub3csCiAgICAgICAgc2NoZWR1bGVEZWZlcnJlZENhbGxiYWNrID0gY29uZmlnLnNjaGVkdWxlRGVmZXJyZWRDYWxsYmFjaywKICAgICAgICBjYW5jZWxEZWZlcnJlZENhbGxiYWNrID0gY29uZmlnLmNhbmNlbERlZmVycmVkQ2FsbGJhY2ssCiAgICAgICAgdXNlU3luY1NjaGVkdWxpbmcgPSBjb25maWcudXNlU3luY1NjaGVkdWxpbmcsCiAgICAgICAgcHJlcGFyZUZvckNvbW1pdCA9IGNvbmZpZy5wcmVwYXJlRm9yQ29tbWl0LAogICAgICAgIHJlc2V0QWZ0ZXJDb21taXQgPSBjb25maWcucmVzZXRBZnRlckNvbW1pdCwKICAgICAgICBzdGFydFRpbWUgPSBub3coKSwKICAgICAgICBtb3N0UmVjZW50Q3VycmVudFRpbWUgPSAyLAogICAgICAgIGxhc3RVbmlxdWVBc3luY0V4cGlyYXRpb24gPSAwLAogICAgICAgIGV4cGlyYXRpb25Db250ZXh0ID0gMCwKICAgICAgICBpc1dvcmtpbmcgPSAhMSwKICAgICAgICBuZXh0VW5pdE9mV29yayA9IG51bGwsCiAgICAgICAgbmV4dFJvb3QgPSBudWxsLAogICAgICAgIG5leHRSZW5kZXJFeHBpcmF0aW9uVGltZSA9IDAsCiAgICAgICAgbmV4dEVmZmVjdCA9IG51bGwsCiAgICAgICAgY2FwdHVyZWRFcnJvcnMgPSBudWxsLAogICAgICAgIGZhaWxlZEJvdW5kYXJpZXMgPSBudWxsLAogICAgICAgIGNvbW1pdFBoYXNlQm91bmRhcmllcyA9IG51bGwsCiAgICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbCwKICAgICAgICBkaWRGYXRhbCA9ICExLAogICAgICAgIGlzQ29tbWl0dGluZyA9ICExLAogICAgICAgIGlzVW5tb3VudGluZyA9ICExLAogICAgICAgIGZpcnN0U2NoZWR1bGVkUm9vdCA9IG51bGwsCiAgICAgICAgbGFzdFNjaGVkdWxlZFJvb3QgPSBudWxsLAogICAgICAgIGNhbGxiYWNrRXhwaXJhdGlvblRpbWUgPSAwLAogICAgICAgIGNhbGxiYWNrSUQgPSAtMSwKICAgICAgICBpc1JlbmRlcmluZyA9ICExLAogICAgICAgIG5leHRGbHVzaGVkUm9vdCA9IG51bGwsCiAgICAgICAgbmV4dEZsdXNoZWRFeHBpcmF0aW9uVGltZSA9IDAsCiAgICAgICAgZGVhZGxpbmVEaWRFeHBpcmUgPSAhMSwKICAgICAgICBoYXNVbmhhbmRsZWRFcnJvciA9ICExLAogICAgICAgIHVuaGFuZGxlZEVycm9yID0gbnVsbCwKICAgICAgICBkZWFkbGluZSA9IG51bGwsCiAgICAgICAgaXNCYXRjaGluZ1VwZGF0ZXMgPSAhMSwKICAgICAgICBpc1VuYmF0Y2hpbmdVcGRhdGVzID0gITEsCiAgICAgICAgY29tcGxldGVkQmF0Y2hlcyA9IG51bGwsCiAgICAgICAgTkVTVEVEX1VQREFURV9MSU1JVCA9IDFlMywKICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDAsCiAgICAgICAgdGltZUhldXJpc3RpY0ZvclVuaXRPZldvcmsgPSAxOwogICAgcmV0dXJuIHsKICAgICAgY29tcHV0ZUFzeW5jRXhwaXJhdGlvbjogY29tcHV0ZUFzeW5jRXhwaXJhdGlvbiwKICAgICAgY29tcHV0ZUV4cGlyYXRpb25Gb3JGaWJlcjogY29tcHV0ZUV4cGlyYXRpb25Gb3JGaWJlciwKICAgICAgc2NoZWR1bGVXb3JrOiBzY2hlZHVsZVdvcmssCiAgICAgIHJlcXVlc3RXb3JrOiByZXF1ZXN0V29yaywKICAgICAgZmx1c2hSb290OiBmdW5jdGlvbiBmbHVzaFJvb3Qocm9vdCwgZXhwaXJhdGlvblRpbWUpIHsKICAgICAgICBpbnZhcmlhbnQoIWlzUmVuZGVyaW5nLCAid29yay5jb21taXQoKTogQ2Fubm90IGNvbW1pdCB3aGlsZSBhbHJlYWR5IHJlbmRlcmluZy4gVGhpcyBsaWtlbHkgbWVhbnMgeW91IGF0dGVtcHRlZCB0byBjb21taXQgZnJvbSBpbnNpZGUgYSBsaWZlY3ljbGUgbWV0aG9kLiIpOwogICAgICAgIHBlcmZvcm1Xb3JrT25Sb290KHJvb3QsIGV4cGlyYXRpb25UaW1lLCBleHBpcmF0aW9uVGltZSk7CiAgICAgICAgZmluaXNoUmVuZGVyaW5nKCk7CiAgICAgIH0sCiAgICAgIGJhdGNoZWRVcGRhdGVzOiBmdW5jdGlvbiBiYXRjaGVkVXBkYXRlcyhmbiwgYSkgewogICAgICAgIHZhciBwcmV2aW91c0lzQmF0Y2hpbmdVcGRhdGVzID0gaXNCYXRjaGluZ1VwZGF0ZXM7CiAgICAgICAgaXNCYXRjaGluZ1VwZGF0ZXMgPSAhMDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBmbihhKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgKGlzQmF0Y2hpbmdVcGRhdGVzID0gcHJldmlvdXNJc0JhdGNoaW5nVXBkYXRlcykgfHwgaXNSZW5kZXJpbmcgfHwgcGVyZm9ybVdvcmsoMSwgbnVsbCk7CiAgICAgICAgfQogICAgICB9LAogICAgICB1bmJhdGNoZWRVcGRhdGVzOiBmdW5jdGlvbiB1bmJhdGNoZWRVcGRhdGVzKGZuKSB7CiAgICAgICAgaWYgKGlzQmF0Y2hpbmdVcGRhdGVzICYmICFpc1VuYmF0Y2hpbmdVcGRhdGVzKSB7CiAgICAgICAgICBpc1VuYmF0Y2hpbmdVcGRhdGVzID0gITA7CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpc1VuYmF0Y2hpbmdVcGRhdGVzID0gITE7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgfSwKICAgICAgZmx1c2hTeW5jOiBmdW5jdGlvbiBmbHVzaFN5bmMoZm4pIHsKICAgICAgICB2YXIgcHJldmlvdXNJc0JhdGNoaW5nVXBkYXRlcyA9IGlzQmF0Y2hpbmdVcGRhdGVzOwogICAgICAgIGlzQmF0Y2hpbmdVcGRhdGVzID0gITA7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBhOiB7CiAgICAgICAgICAgIHZhciBwcmV2aW91c0V4cGlyYXRpb25Db250ZXh0ID0gZXhwaXJhdGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGV4cGlyYXRpb25Db250ZXh0ID0gMTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIEpTQ29tcGlsZXJfaW5saW5lX3Jlc3VsdCA9IGZuKCk7CiAgICAgICAgICAgICAgYnJlYWsgYTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBleHBpcmF0aW9uQ29udGV4dCA9IHByZXZpb3VzRXhwaXJhdGlvbkNvbnRleHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEpTQ29tcGlsZXJfaW5saW5lX3Jlc3VsdCA9IHZvaWQgMDsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gSlNDb21waWxlcl9pbmxpbmVfcmVzdWx0OwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpc0JhdGNoaW5nVXBkYXRlcyA9IHByZXZpb3VzSXNCYXRjaGluZ1VwZGF0ZXMsIGludmFyaWFudCghaXNSZW5kZXJpbmcsICJmbHVzaFN5bmMgd2FzIGNhbGxlZCBmcm9tIGluc2lkZSBhIGxpZmVjeWNsZSBtZXRob2QuIEl0IGNhbm5vdCBiZSBjYWxsZWQgd2hlbiBSZWFjdCBpcyBhbHJlYWR5IHJlbmRlcmluZy4iKSwgcGVyZm9ybVdvcmsoMSwgbnVsbCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZWZlcnJlZFVwZGF0ZXM6IGZ1bmN0aW9uIGRlZmVycmVkVXBkYXRlcyhmbikgewogICAgICAgIHZhciBwcmV2aW91c0V4cGlyYXRpb25Db250ZXh0ID0gZXhwaXJhdGlvbkNvbnRleHQ7CiAgICAgICAgZXhwaXJhdGlvbkNvbnRleHQgPSBjb21wdXRlQXN5bmNFeHBpcmF0aW9uKCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgZXhwaXJhdGlvbkNvbnRleHQgPSBwcmV2aW91c0V4cGlyYXRpb25Db250ZXh0OwogICAgICAgIH0KICAgICAgfSwKICAgICAgY29tcHV0ZVVuaXF1ZUFzeW5jRXhwaXJhdGlvbjogZnVuY3Rpb24gY29tcHV0ZVVuaXF1ZUFzeW5jRXhwaXJhdGlvbigpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gY29tcHV0ZUFzeW5jRXhwaXJhdGlvbigpOwogICAgICAgIHJlc3VsdCA8PSBsYXN0VW5pcXVlQXN5bmNFeHBpcmF0aW9uICYmIChyZXN1bHQgPSBsYXN0VW5pcXVlQXN5bmNFeHBpcmF0aW9uICsgMSk7CiAgICAgICAgcmV0dXJuIGxhc3RVbmlxdWVBc3luY0V4cGlyYXRpb24gPSByZXN1bHQ7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBSZWFjdEZpYmVyUmVjb25jaWxlciQxKGNvbmZpZykgewogICAgZnVuY3Rpb24gdXBkYXRlQ29udGFpbmVyQXRFeHBpcmF0aW9uVGltZShlbGVtZW50LCBjb250YWluZXIsIHBhcmVudENvbXBvbmVudCwgZXhwaXJhdGlvblRpbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBjdXJyZW50ID0gY29udGFpbmVyLmN1cnJlbnQ7CgogICAgICBpZiAocGFyZW50Q29tcG9uZW50KSB7CiAgICAgICAgcGFyZW50Q29tcG9uZW50ID0gcGFyZW50Q29tcG9uZW50Ll9yZWFjdEludGVybmFsRmliZXI7CiAgICAgICAgdmFyIHBhcmVudENvbnRleHQ7CgogICAgICAgIGI6IHsKICAgICAgICAgIGludmFyaWFudCgyID09PSBpc0ZpYmVyTW91bnRlZEltcGwocGFyZW50Q29tcG9uZW50KSAmJiAyID09PSBwYXJlbnRDb21wb25lbnQudGFnLCAiRXhwZWN0ZWQgc3VidHJlZSBwYXJlbnQgdG8gYmUgYSBtb3VudGVkIGNsYXNzIGNvbXBvbmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKCiAgICAgICAgICBmb3IgKHBhcmVudENvbnRleHQgPSBwYXJlbnRDb21wb25lbnQ7IDMgIT09IHBhcmVudENvbnRleHQudGFnOykgewogICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIocGFyZW50Q29udGV4dCkpIHsKICAgICAgICAgICAgICBwYXJlbnRDb250ZXh0ID0gcGFyZW50Q29udGV4dC5zdGF0ZU5vZGUuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQ7CiAgICAgICAgICAgICAgYnJlYWsgYjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcGFyZW50Q29udGV4dCA9IHBhcmVudENvbnRleHRbInJldHVybiJdOwogICAgICAgICAgICBpbnZhcmlhbnQocGFyZW50Q29udGV4dCwgIkZvdW5kIHVuZXhwZWN0ZWQgZGV0YWNoZWQgc3VidHJlZSBwYXJlbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CgogICAgICAgICAgcGFyZW50Q29udGV4dCA9IHBhcmVudENvbnRleHQuc3RhdGVOb2RlLmNvbnRleHQ7CiAgICAgICAgfQoKICAgICAgICBwYXJlbnRDb21wb25lbnQgPSBpc0NvbnRleHRQcm92aWRlcihwYXJlbnRDb21wb25lbnQpID8gcHJvY2Vzc0NoaWxkQ29udGV4dChwYXJlbnRDb21wb25lbnQsIHBhcmVudENvbnRleHQpIDogcGFyZW50Q29udGV4dDsKICAgICAgfSBlbHNlIHBhcmVudENvbXBvbmVudCA9IGVtcHR5T2JqZWN0OwoKICAgICAgbnVsbCA9PT0gY29udGFpbmVyLmNvbnRleHQgPyBjb250YWluZXIuY29udGV4dCA9IHBhcmVudENvbXBvbmVudCA6IGNvbnRhaW5lci5wZW5kaW5nQ29udGV4dCA9IHBhcmVudENvbXBvbmVudDsKICAgICAgY29udGFpbmVyID0gY2FsbGJhY2s7CiAgICAgIGluc2VydFVwZGF0ZUludG9GaWJlcihjdXJyZW50LCB7CiAgICAgICAgZXhwaXJhdGlvblRpbWU6IGV4cGlyYXRpb25UaW1lLAogICAgICAgIHBhcnRpYWxTdGF0ZTogewogICAgICAgICAgZWxlbWVudDogZWxlbWVudAogICAgICAgIH0sCiAgICAgICAgY2FsbGJhY2s6IHZvaWQgMCA9PT0gY29udGFpbmVyID8gbnVsbCA6IGNvbnRhaW5lciwKICAgICAgICBpc1JlcGxhY2U6ICExLAogICAgICAgIGlzRm9yY2VkOiAhMSwKICAgICAgICBuZXh0OiBudWxsCiAgICAgIH0pOwogICAgICBzY2hlZHVsZVdvcmsoY3VycmVudCwgZXhwaXJhdGlvblRpbWUpOwogICAgICByZXR1cm4gZXhwaXJhdGlvblRpbWU7CiAgICB9CgogICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZShmaWJlcikgewogICAgICBmaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyKGZpYmVyKTsKICAgICAgcmV0dXJuIG51bGwgPT09IGZpYmVyID8gbnVsbCA6IGZpYmVyLnN0YXRlTm9kZTsKICAgIH0KCiAgICB2YXIgZ2V0UHVibGljSW5zdGFuY2UgPSBjb25maWcuZ2V0UHVibGljSW5zdGFuY2U7CiAgICBjb25maWcgPSBSZWFjdEZpYmVyU2NoZWR1bGVyKGNvbmZpZyk7CiAgICB2YXIgY29tcHV0ZUFzeW5jRXhwaXJhdGlvbiA9IGNvbmZpZy5jb21wdXRlQXN5bmNFeHBpcmF0aW9uLAogICAgICAgIGNvbXB1dGVFeHBpcmF0aW9uRm9yRmliZXIgPSBjb25maWcuY29tcHV0ZUV4cGlyYXRpb25Gb3JGaWJlciwKICAgICAgICBzY2hlZHVsZVdvcmsgPSBjb25maWcuc2NoZWR1bGVXb3JrOwogICAgcmV0dXJuIHsKICAgICAgY3JlYXRlQ29udGFpbmVyOiBmdW5jdGlvbiBjcmVhdGVDb250YWluZXIoY29udGFpbmVySW5mbywgaHlkcmF0ZSkgewogICAgICAgIHZhciB1bmluaXRpYWxpemVkRmliZXIgPSBjcmVhdGVGaWJlcigzLCBudWxsLCAwKTsKICAgICAgICBjb250YWluZXJJbmZvID0gewogICAgICAgICAgY3VycmVudDogdW5pbml0aWFsaXplZEZpYmVyLAogICAgICAgICAgY29udGFpbmVySW5mbzogY29udGFpbmVySW5mbywKICAgICAgICAgIHBlbmRpbmdDaGlsZHJlbjogbnVsbCwKICAgICAgICAgIHJlbWFpbmluZ0V4cGlyYXRpb25UaW1lOiAwLAogICAgICAgICAgaXNSZWFkeUZvckNvbW1pdDogITEsCiAgICAgICAgICBmaW5pc2hlZFdvcms6IG51bGwsCiAgICAgICAgICBjb250ZXh0OiBudWxsLAogICAgICAgICAgcGVuZGluZ0NvbnRleHQ6IG51bGwsCiAgICAgICAgICBoeWRyYXRlOiBoeWRyYXRlLAogICAgICAgICAgZmlyc3RCYXRjaDogbnVsbCwKICAgICAgICAgIG5leHRTY2hlZHVsZWRSb290OiBudWxsCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gdW5pbml0aWFsaXplZEZpYmVyLnN0YXRlTm9kZSA9IGNvbnRhaW5lckluZm87CiAgICAgIH0sCiAgICAgIHVwZGF0ZUNvbnRhaW5lcjogZnVuY3Rpb24gdXBkYXRlQ29udGFpbmVyKGVsZW1lbnQsIGNvbnRhaW5lciwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaykgewogICAgICAgIHZhciBjdXJyZW50ID0gY29udGFpbmVyLmN1cnJlbnQ7CiAgICAgICAgY3VycmVudCA9IG51bGwgIT0gZWxlbWVudCAmJiBudWxsICE9IGVsZW1lbnQudHlwZSAmJiBudWxsICE9IGVsZW1lbnQudHlwZS5wcm90b3R5cGUgJiYgITAgPT09IGVsZW1lbnQudHlwZS5wcm90b3R5cGUudW5zdGFibGVfaXNBc3luY1JlYWN0Q29tcG9uZW50ID8gY29tcHV0ZUFzeW5jRXhwaXJhdGlvbigpIDogY29tcHV0ZUV4cGlyYXRpb25Gb3JGaWJlcihjdXJyZW50KTsKICAgICAgICByZXR1cm4gdXBkYXRlQ29udGFpbmVyQXRFeHBpcmF0aW9uVGltZShlbGVtZW50LCBjb250YWluZXIsIHBhcmVudENvbXBvbmVudCwgY3VycmVudCwgY2FsbGJhY2spOwogICAgICB9LAogICAgICB1cGRhdGVDb250YWluZXJBdEV4cGlyYXRpb25UaW1lOiB1cGRhdGVDb250YWluZXJBdEV4cGlyYXRpb25UaW1lLAogICAgICBmbHVzaFJvb3Q6IGNvbmZpZy5mbHVzaFJvb3QsCiAgICAgIHJlcXVlc3RXb3JrOiBjb25maWcucmVxdWVzdFdvcmssCiAgICAgIGNvbXB1dGVVbmlxdWVBc3luY0V4cGlyYXRpb246IGNvbmZpZy5jb21wdXRlVW5pcXVlQXN5bmNFeHBpcmF0aW9uLAogICAgICBiYXRjaGVkVXBkYXRlczogY29uZmlnLmJhdGNoZWRVcGRhdGVzLAogICAgICB1bmJhdGNoZWRVcGRhdGVzOiBjb25maWcudW5iYXRjaGVkVXBkYXRlcywKICAgICAgZGVmZXJyZWRVcGRhdGVzOiBjb25maWcuZGVmZXJyZWRVcGRhdGVzLAogICAgICBmbHVzaFN5bmM6IGNvbmZpZy5mbHVzaFN5bmMsCiAgICAgIGdldFB1YmxpY1Jvb3RJbnN0YW5jZTogZnVuY3Rpb24gZ2V0UHVibGljUm9vdEluc3RhbmNlKGNvbnRhaW5lcikgewogICAgICAgIGNvbnRhaW5lciA9IGNvbnRhaW5lci5jdXJyZW50OwogICAgICAgIGlmICghY29udGFpbmVyLmNoaWxkKSByZXR1cm4gbnVsbDsKCiAgICAgICAgc3dpdGNoIChjb250YWluZXIuY2hpbGQudGFnKSB7CiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIHJldHVybiBnZXRQdWJsaWNJbnN0YW5jZShjb250YWluZXIuY2hpbGQuc3RhdGVOb2RlKTsKCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gY29udGFpbmVyLmNoaWxkLnN0YXRlTm9kZTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZpbmRIb3N0SW5zdGFuY2U6IGZpbmRIb3N0SW5zdGFuY2UsCiAgICAgIGZpbmRIb3N0SW5zdGFuY2VXaXRoTm9Qb3J0YWxzOiBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhmaWJlcikgewogICAgICAgIGZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzKGZpYmVyKTsKICAgICAgICByZXR1cm4gbnVsbCA9PT0gZmliZXIgPyBudWxsIDogZmliZXIuc3RhdGVOb2RlOwogICAgICB9LAogICAgICBpbmplY3RJbnRvRGV2VG9vbHM6IGZ1bmN0aW9uIGluamVjdEludG9EZXZUb29scyhkZXZUb29sc0NvbmZpZykgewogICAgICAgIHZhciBfZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UgPSBkZXZUb29sc0NvbmZpZy5maW5kRmliZXJCeUhvc3RJbnN0YW5jZTsKICAgICAgICByZXR1cm4gaW5qZWN0SW50ZXJuYWxzKGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBkZXZUb29sc0NvbmZpZywgewogICAgICAgICAgZmluZEhvc3RJbnN0YW5jZUJ5RmliZXI6IGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmaW5kSG9zdEluc3RhbmNlKGZpYmVyKTsKICAgICAgICAgIH0sCiAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZnVuY3Rpb24gZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIF9maW5kRmliZXJCeUhvc3RJbnN0YW5jZSA/IF9maW5kRmliZXJCeUhvc3RJbnN0YW5jZShpbnN0YW5jZSkgOiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0pKTsKICAgICAgfQogICAgfTsKICB9CgogIHZhciBSZWFjdEZpYmVyUmVjb25jaWxlciQyID0gT2JqZWN0LmZyZWV6ZSh7CiAgICBkZWZhdWx0OiBSZWFjdEZpYmVyUmVjb25jaWxlciQxCiAgfSksCiAgICAgIFJlYWN0RmliZXJSZWNvbmNpbGVyJDMgPSBSZWFjdEZpYmVyUmVjb25jaWxlciQyICYmIFJlYWN0RmliZXJSZWNvbmNpbGVyJDEgfHwgUmVhY3RGaWJlclJlY29uY2lsZXIkMiwKICAgICAgcmVhY3RSZWNvbmNpbGVyID0gUmVhY3RGaWJlclJlY29uY2lsZXIkM1siZGVmYXVsdCJdID8gUmVhY3RGaWJlclJlY29uY2lsZXIkM1siZGVmYXVsdCJdIDogUmVhY3RGaWJlclJlY29uY2lsZXIkMywKICAgICAgdmlld0NvbmZpZ0NhbGxiYWNrcyA9IG5ldyBNYXAoKSwKICAgICAgdmlld0NvbmZpZ3MgPSBuZXcgTWFwKCksCiAgICAgIFJlYWN0TmF0aXZlRmliZXJIb3N0Q29tcG9uZW50ID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gUmVhY3ROYXRpdmVGaWJlckhvc3RDb21wb25lbnQodGFnLCB2aWV3Q29uZmlnKSB7CiAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBSZWFjdE5hdGl2ZUZpYmVySG9zdENvbXBvbmVudCkpIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOwogICAgICB0aGlzLl9uYXRpdmVUYWcgPSB0YWc7CiAgICAgIHRoaXMuX2NoaWxkcmVuID0gW107CiAgICAgIHRoaXMudmlld0NvbmZpZyA9IHZpZXdDb25maWc7CiAgICB9CgogICAgUmVhY3ROYXRpdmVGaWJlckhvc3RDb21wb25lbnQucHJvdG90eXBlLmJsdXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIFRleHRJbnB1dFN0YXRlLmJsdXJUZXh0SW5wdXQodGhpcy5fbmF0aXZlVGFnKTsKICAgIH07CgogICAgUmVhY3ROYXRpdmVGaWJlckhvc3RDb21wb25lbnQucHJvdG90eXBlLmZvY3VzID0gZnVuY3Rpb24gKCkgewogICAgICBUZXh0SW5wdXRTdGF0ZS5mb2N1c1RleHRJbnB1dCh0aGlzLl9uYXRpdmVUYWcpOwogICAgfTsKCiAgICBSZWFjdE5hdGl2ZUZpYmVySG9zdENvbXBvbmVudC5wcm90b3R5cGUubWVhc3VyZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICBVSU1hbmFnZXIubWVhc3VyZSh0aGlzLl9uYXRpdmVUYWcsIG1vdW50U2FmZUNhbGxiYWNrKHRoaXMsIGNhbGxiYWNrKSk7CiAgICB9OwoKICAgIFJlYWN0TmF0aXZlRmliZXJIb3N0Q29tcG9uZW50LnByb3RvdHlwZS5tZWFzdXJlSW5XaW5kb3cgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgVUlNYW5hZ2VyLm1lYXN1cmVJbldpbmRvdyh0aGlzLl9uYXRpdmVUYWcsIG1vdW50U2FmZUNhbGxiYWNrKHRoaXMsIGNhbGxiYWNrKSk7CiAgICB9OwoKICAgIFJlYWN0TmF0aXZlRmliZXJIb3N0Q29tcG9uZW50LnByb3RvdHlwZS5tZWFzdXJlTGF5b3V0ID0gZnVuY3Rpb24gKHJlbGF0aXZlVG9OYXRpdmVOb2RlLCBvblN1Y2Nlc3MsIG9uRmFpbCkgewogICAgICBVSU1hbmFnZXIubWVhc3VyZUxheW91dCh0aGlzLl9uYXRpdmVUYWcsIHJlbGF0aXZlVG9OYXRpdmVOb2RlLCBtb3VudFNhZmVDYWxsYmFjayh0aGlzLCBvbkZhaWwpLCBtb3VudFNhZmVDYWxsYmFjayh0aGlzLCBvblN1Y2Nlc3MpKTsKICAgIH07CgogICAgUmVhY3ROYXRpdmVGaWJlckhvc3RDb21wb25lbnQucHJvdG90eXBlLnNldE5hdGl2ZVByb3BzID0gZnVuY3Rpb24gKG5hdGl2ZVByb3BzKSB7CiAgICAgIG5hdGl2ZVByb3BzID0gZGlmZlByb3BlcnRpZXMobnVsbCwgZW1wdHlPYmplY3QkMSwgbmF0aXZlUHJvcHMsIHRoaXMudmlld0NvbmZpZy52YWxpZEF0dHJpYnV0ZXMpOwogICAgICBudWxsICE9IG5hdGl2ZVByb3BzICYmIFVJTWFuYWdlci51cGRhdGVWaWV3KHRoaXMuX25hdGl2ZVRhZywgdGhpcy52aWV3Q29uZmlnLnVpVmlld0NsYXNzTmFtZSwgbmF0aXZlUHJvcHMpOwogICAgfTsKCiAgICByZXR1cm4gUmVhY3ROYXRpdmVGaWJlckhvc3RDb21wb25lbnQ7CiAgfSgpLAogICAgICBub3cgPSAib2JqZWN0IiA9PT0gdHlwZW9mIHBlcmZvcm1hbmNlICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPyBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgfSA6IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBEYXRlLm5vdygpOwogIH0sCiAgICAgIHNjaGVkdWxlZENhbGxiYWNrID0gbnVsbCwKICAgICAgZnJhbWVEZWFkbGluZSA9IDAsCiAgICAgIGZyYW1lRGVhZGxpbmVPYmplY3QgPSB7CiAgICB0aW1lUmVtYWluaW5nOiBmdW5jdGlvbiB0aW1lUmVtYWluaW5nKCkgewogICAgICByZXR1cm4gZnJhbWVEZWFkbGluZSAtIG5vdygpOwogICAgfQogIH07CgogIGZ1bmN0aW9uIHNldFRpbWVvdXRDYWxsYmFjaygpIHsKICAgIGZyYW1lRGVhZGxpbmUgPSBub3coKSArIDU7CiAgICB2YXIgY2FsbGJhY2sgPSBzY2hlZHVsZWRDYWxsYmFjazsKICAgIHNjaGVkdWxlZENhbGxiYWNrID0gbnVsbDsKICAgIG51bGwgIT09IGNhbGxiYWNrICYmIGNhbGxiYWNrKGZyYW1lRGVhZGxpbmVPYmplY3QpOwogIH0KCiAgZnVuY3Rpb24gcmVjdXJzaXZlbHlVbmNhY2hlRmliZXJOb2RlKG5vZGUpIHsKICAgICJudW1iZXIiID09PSB0eXBlb2Ygbm9kZSA/IHVuY2FjaGVGaWJlck5vZGUobm9kZSkgOiAodW5jYWNoZUZpYmVyTm9kZShub2RlLl9uYXRpdmVUYWcpLCBub2RlLl9jaGlsZHJlbi5mb3JFYWNoKHJlY3Vyc2l2ZWx5VW5jYWNoZUZpYmVyTm9kZSkpOwogIH0KCiAgdmFyIE5hdGl2ZVJlbmRlcmVyID0gcmVhY3RSZWNvbmNpbGVyKHsKICAgIGFwcGVuZEluaXRpYWxDaGlsZDogZnVuY3Rpb24gYXBwZW5kSW5pdGlhbENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICBwYXJlbnRJbnN0YW5jZS5fY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgICB9LAogICAgY3JlYXRlSW5zdGFuY2U6IGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlKHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgIGhvc3RDb250ZXh0ID0gUmVhY3ROYXRpdmVUYWdIYW5kbGVzLmFsbG9jYXRlVGFnKCk7CiAgICAgIGlmICh2aWV3Q29uZmlncy5oYXModHlwZSkpIHZhciB2aWV3Q29uZmlnID0gdmlld0NvbmZpZ3MuZ2V0KHR5cGUpO2Vsc2Ugdmlld0NvbmZpZyA9IHZpZXdDb25maWdDYWxsYmFja3MuZ2V0KHR5cGUpLCBpbnZhcmlhbnQoImZ1bmN0aW9uIiA9PT0gdHlwZW9mIHZpZXdDb25maWcsICJWaWV3IGNvbmZpZyBub3QgZm91bmQgZm9yIG5hbWUgJXMiLCB0eXBlKSwgdmlld0NvbmZpZ0NhbGxiYWNrcy5zZXQodHlwZSwgbnVsbCksIHZpZXdDb25maWcgPSB2aWV3Q29uZmlnKCksIHZpZXdDb25maWdzLnNldCh0eXBlLCB2aWV3Q29uZmlnKTsKICAgICAgaW52YXJpYW50KHZpZXdDb25maWcsICJWaWV3IGNvbmZpZyBub3QgZm91bmQgZm9yIG5hbWUgJXMiLCB0eXBlKTsKICAgICAgdHlwZSA9IHZpZXdDb25maWc7CiAgICAgIHZpZXdDb25maWcgPSBkaWZmUHJvcGVydGllcyhudWxsLCBlbXB0eU9iamVjdCQxLCBwcm9wcywgdHlwZS52YWxpZEF0dHJpYnV0ZXMpOwogICAgICBVSU1hbmFnZXIuY3JlYXRlVmlldyhob3N0Q29udGV4dCwgdHlwZS51aVZpZXdDbGFzc05hbWUsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgdmlld0NvbmZpZyk7CiAgICAgIHJvb3RDb250YWluZXJJbnN0YW5jZSA9IG5ldyBSZWFjdE5hdGl2ZUZpYmVySG9zdENvbXBvbmVudChob3N0Q29udGV4dCwgdHlwZSk7CiAgICAgIGluc3RhbmNlQ2FjaGVbaG9zdENvbnRleHRdID0gaW50ZXJuYWxJbnN0YW5jZUhhbmRsZTsKICAgICAgaW5zdGFuY2VQcm9wc1tob3N0Q29udGV4dF0gPSBwcm9wczsKICAgICAgcmV0dXJuIHJvb3RDb250YWluZXJJbnN0YW5jZTsKICAgIH0sCiAgICBjcmVhdGVUZXh0SW5zdGFuY2U6IGZ1bmN0aW9uIGNyZWF0ZVRleHRJbnN0YW5jZSh0ZXh0LCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgIGhvc3RDb250ZXh0ID0gUmVhY3ROYXRpdmVUYWdIYW5kbGVzLmFsbG9jYXRlVGFnKCk7CiAgICAgIFVJTWFuYWdlci5jcmVhdGVWaWV3KGhvc3RDb250ZXh0LCAiUkNUUmF3VGV4dCIsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgewogICAgICAgIHRleHQ6IHRleHQKICAgICAgfSk7CiAgICAgIGluc3RhbmNlQ2FjaGVbaG9zdENvbnRleHRdID0gaW50ZXJuYWxJbnN0YW5jZUhhbmRsZTsKICAgICAgcmV0dXJuIGhvc3RDb250ZXh0OwogICAgfSwKICAgIGZpbmFsaXplSW5pdGlhbENoaWxkcmVuOiBmdW5jdGlvbiBmaW5hbGl6ZUluaXRpYWxDaGlsZHJlbihwYXJlbnRJbnN0YW5jZSkgewogICAgICBpZiAoMCA9PT0gcGFyZW50SW5zdGFuY2UuX2NoaWxkcmVuLmxlbmd0aCkgcmV0dXJuICExOwoKICAgICAgdmFyIG5hdGl2ZVRhZ3MgPSBwYXJlbnRJbnN0YW5jZS5fY2hpbGRyZW4ubWFwKGZ1bmN0aW9uIChjaGlsZCkgewogICAgICAgIHJldHVybiAibnVtYmVyIiA9PT0gdHlwZW9mIGNoaWxkID8gY2hpbGQgOiBjaGlsZC5fbmF0aXZlVGFnOwogICAgICB9KTsKCiAgICAgIFVJTWFuYWdlci5zZXRDaGlsZHJlbihwYXJlbnRJbnN0YW5jZS5fbmF0aXZlVGFnLCBuYXRpdmVUYWdzKTsKICAgICAgcmV0dXJuICExOwogICAgfSwKICAgIGdldFJvb3RIb3N0Q29udGV4dDogZnVuY3Rpb24gZ2V0Um9vdEhvc3RDb250ZXh0KCkgewogICAgICByZXR1cm4gZW1wdHlPYmplY3Q7CiAgICB9LAogICAgZ2V0Q2hpbGRIb3N0Q29udGV4dDogZnVuY3Rpb24gZ2V0Q2hpbGRIb3N0Q29udGV4dCgpIHsKICAgICAgcmV0dXJuIGVtcHR5T2JqZWN0OwogICAgfSwKICAgIGdldFB1YmxpY0luc3RhbmNlOiBmdW5jdGlvbiBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICB9LAogICAgbm93OiBub3csCiAgICBwcmVwYXJlRm9yQ29tbWl0OiBmdW5jdGlvbiBwcmVwYXJlRm9yQ29tbWl0KCkge30sCiAgICBwcmVwYXJlVXBkYXRlOiBmdW5jdGlvbiBwcmVwYXJlVXBkYXRlKCkgewogICAgICByZXR1cm4gZW1wdHlPYmplY3Q7CiAgICB9LAogICAgcmVzZXRBZnRlckNvbW1pdDogZnVuY3Rpb24gcmVzZXRBZnRlckNvbW1pdCgpIHt9LAogICAgc2NoZWR1bGVEZWZlcnJlZENhbGxiYWNrOiBmdW5jdGlvbiBzY2hlZHVsZURlZmVycmVkQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgc2NoZWR1bGVkQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgcmV0dXJuIHNldFRpbWVvdXQoc2V0VGltZW91dENhbGxiYWNrLCAxKTsKICAgIH0sCiAgICBjYW5jZWxEZWZlcnJlZENhbGxiYWNrOiBmdW5jdGlvbiBjYW5jZWxEZWZlcnJlZENhbGxiYWNrKGNhbGxiYWNrSUQpIHsKICAgICAgc2NoZWR1bGVkQ2FsbGJhY2sgPSBudWxsOwogICAgICBjbGVhclRpbWVvdXQoY2FsbGJhY2tJRCk7CiAgICB9LAogICAgc2hvdWxkRGVwcmlvcml0aXplU3VidHJlZTogZnVuY3Rpb24gc2hvdWxkRGVwcmlvcml0aXplU3VidHJlZSgpIHsKICAgICAgcmV0dXJuICExOwogICAgfSwKICAgIHNob3VsZFNldFRleHRDb250ZW50OiBmdW5jdGlvbiBzaG91bGRTZXRUZXh0Q29udGVudCgpIHsKICAgICAgcmV0dXJuICExOwogICAgfSwKICAgIHVzZVN5bmNTY2hlZHVsaW5nOiAhMCwKICAgIG11dGF0aW9uOiB7CiAgICAgIGFwcGVuZENoaWxkOiBmdW5jdGlvbiBhcHBlbmRDaGlsZChwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICB2YXIgY2hpbGRUYWcgPSAibnVtYmVyIiA9PT0gdHlwZW9mIGNoaWxkID8gY2hpbGQgOiBjaGlsZC5fbmF0aXZlVGFnLAogICAgICAgICAgICBjaGlsZHJlbiA9IHBhcmVudEluc3RhbmNlLl9jaGlsZHJlbiwKICAgICAgICAgICAgaW5kZXggPSBjaGlsZHJlbi5pbmRleE9mKGNoaWxkKTsKICAgICAgICAwIDw9IGluZGV4ID8gKGNoaWxkcmVuLnNwbGljZShpbmRleCwgMSksIGNoaWxkcmVuLnB1c2goY2hpbGQpLCBVSU1hbmFnZXIubWFuYWdlQ2hpbGRyZW4ocGFyZW50SW5zdGFuY2UuX25hdGl2ZVRhZywgW2luZGV4XSwgW2NoaWxkcmVuLmxlbmd0aCAtIDFdLCBbXSwgW10sIFtdKSkgOiAoY2hpbGRyZW4ucHVzaChjaGlsZCksIFVJTWFuYWdlci5tYW5hZ2VDaGlsZHJlbihwYXJlbnRJbnN0YW5jZS5fbmF0aXZlVGFnLCBbXSwgW10sIFtjaGlsZFRhZ10sIFtjaGlsZHJlbi5sZW5ndGggLSAxXSwgW10pKTsKICAgICAgfSwKICAgICAgYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcjogZnVuY3Rpb24gYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcihwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICBVSU1hbmFnZXIuc2V0Q2hpbGRyZW4ocGFyZW50SW5zdGFuY2UsIFsibnVtYmVyIiA9PT0gdHlwZW9mIGNoaWxkID8gY2hpbGQgOiBjaGlsZC5fbmF0aXZlVGFnXSk7CiAgICAgIH0sCiAgICAgIGNvbW1pdFRleHRVcGRhdGU6IGZ1bmN0aW9uIGNvbW1pdFRleHRVcGRhdGUodGV4dEluc3RhbmNlLCBvbGRUZXh0LCBuZXdUZXh0KSB7CiAgICAgICAgVUlNYW5hZ2VyLnVwZGF0ZVZpZXcodGV4dEluc3RhbmNlLCAiUkNUUmF3VGV4dCIsIHsKICAgICAgICAgIHRleHQ6IG5ld1RleHQKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgY29tbWl0TW91bnQ6IGZ1bmN0aW9uIGNvbW1pdE1vdW50KCkge30sCiAgICAgIGNvbW1pdFVwZGF0ZTogZnVuY3Rpb24gY29tbWl0VXBkYXRlKGluc3RhbmNlLCB1cGRhdGVQYXlsb2FkVE9ETywgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzKSB7CiAgICAgICAgdXBkYXRlUGF5bG9hZFRPRE8gPSBpbnN0YW5jZS52aWV3Q29uZmlnOwogICAgICAgIGluc3RhbmNlUHJvcHNbaW5zdGFuY2UuX25hdGl2ZVRhZ10gPSBuZXdQcm9wczsKICAgICAgICBvbGRQcm9wcyA9IGRpZmZQcm9wZXJ0aWVzKG51bGwsIG9sZFByb3BzLCBuZXdQcm9wcywgdXBkYXRlUGF5bG9hZFRPRE8udmFsaWRBdHRyaWJ1dGVzKTsKICAgICAgICBudWxsICE9IG9sZFByb3BzICYmIFVJTWFuYWdlci51cGRhdGVWaWV3KGluc3RhbmNlLl9uYXRpdmVUYWcsIHVwZGF0ZVBheWxvYWRUT0RPLnVpVmlld0NsYXNzTmFtZSwgb2xkUHJvcHMpOwogICAgICB9LAogICAgICBpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uIGluc2VydEJlZm9yZShwYXJlbnRJbnN0YW5jZSwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgdmFyIGNoaWxkcmVuID0gcGFyZW50SW5zdGFuY2UuX2NoaWxkcmVuLAogICAgICAgICAgICBpbmRleCA9IGNoaWxkcmVuLmluZGV4T2YoY2hpbGQpOwogICAgICAgIDAgPD0gaW5kZXggPyAoY2hpbGRyZW4uc3BsaWNlKGluZGV4LCAxKSwgYmVmb3JlQ2hpbGQgPSBjaGlsZHJlbi5pbmRleE9mKGJlZm9yZUNoaWxkKSwgY2hpbGRyZW4uc3BsaWNlKGJlZm9yZUNoaWxkLCAwLCBjaGlsZCksIFVJTWFuYWdlci5tYW5hZ2VDaGlsZHJlbihwYXJlbnRJbnN0YW5jZS5fbmF0aXZlVGFnLCBbaW5kZXhdLCBbYmVmb3JlQ2hpbGRdLCBbXSwgW10sIFtdKSkgOiAoaW5kZXggPSBjaGlsZHJlbi5pbmRleE9mKGJlZm9yZUNoaWxkKSwgY2hpbGRyZW4uc3BsaWNlKGluZGV4LCAwLCBjaGlsZCksIFVJTWFuYWdlci5tYW5hZ2VDaGlsZHJlbihwYXJlbnRJbnN0YW5jZS5fbmF0aXZlVGFnLCBbXSwgW10sIFsibnVtYmVyIiA9PT0gdHlwZW9mIGNoaWxkID8gY2hpbGQgOiBjaGlsZC5fbmF0aXZlVGFnXSwgW2luZGV4XSwgW10pKTsKICAgICAgfSwKICAgICAgaW5zZXJ0SW5Db250YWluZXJCZWZvcmU6IGZ1bmN0aW9uIGluc2VydEluQ29udGFpbmVyQmVmb3JlKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgaW52YXJpYW50KCJudW1iZXIiICE9PSB0eXBlb2YgcGFyZW50SW5zdGFuY2UsICJDb250YWluZXIgZG9lcyBub3Qgc3VwcG9ydCBpbnNlcnRCZWZvcmUgb3BlcmF0aW9uIik7CiAgICAgIH0sCiAgICAgIHJlbW92ZUNoaWxkOiBmdW5jdGlvbiByZW1vdmVDaGlsZChwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICByZWN1cnNpdmVseVVuY2FjaGVGaWJlck5vZGUoY2hpbGQpOwogICAgICAgIHZhciBjaGlsZHJlbiA9IHBhcmVudEluc3RhbmNlLl9jaGlsZHJlbjsKICAgICAgICBjaGlsZCA9IGNoaWxkcmVuLmluZGV4T2YoY2hpbGQpOwogICAgICAgIGNoaWxkcmVuLnNwbGljZShjaGlsZCwgMSk7CiAgICAgICAgVUlNYW5hZ2VyLm1hbmFnZUNoaWxkcmVuKHBhcmVudEluc3RhbmNlLl9uYXRpdmVUYWcsIFtdLCBbXSwgW10sIFtdLCBbY2hpbGRdKTsKICAgICAgfSwKICAgICAgcmVtb3ZlQ2hpbGRGcm9tQ29udGFpbmVyOiBmdW5jdGlvbiByZW1vdmVDaGlsZEZyb21Db250YWluZXIocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgcmVjdXJzaXZlbHlVbmNhY2hlRmliZXJOb2RlKGNoaWxkKTsKICAgICAgICBVSU1hbmFnZXIubWFuYWdlQ2hpbGRyZW4ocGFyZW50SW5zdGFuY2UsIFtdLCBbXSwgW10sIFtdLCBbMF0pOwogICAgICB9LAogICAgICByZXNldFRleHRDb250ZW50OiBmdW5jdGlvbiByZXNldFRleHRDb250ZW50KCkge30KICAgIH0KICB9KTsKCiAgZnVuY3Rpb24gZmluZE5vZGVIYW5kbGUoY29tcG9uZW50T3JIYW5kbGUpIHsKICAgIGlmIChudWxsID09IGNvbXBvbmVudE9ySGFuZGxlKSByZXR1cm4gbnVsbDsKICAgIGlmICgibnVtYmVyIiA9PT0gdHlwZW9mIGNvbXBvbmVudE9ySGFuZGxlKSByZXR1cm4gY29tcG9uZW50T3JIYW5kbGU7CiAgICB2YXIgaW50ZXJuYWxJbnN0YW5jZSA9IGNvbXBvbmVudE9ySGFuZGxlLl9yZWFjdEludGVybmFsRmliZXI7CiAgICBpZiAoaW50ZXJuYWxJbnN0YW5jZSkgcmV0dXJuIE5hdGl2ZVJlbmRlcmVyLmZpbmRIb3N0SW5zdGFuY2UoaW50ZXJuYWxJbnN0YW5jZSk7CiAgICBpZiAoY29tcG9uZW50T3JIYW5kbGUpIHJldHVybiBjb21wb25lbnRPckhhbmRsZTsKICAgIGludmFyaWFudCgib2JqZWN0IiA9PT0gdHlwZW9mIGNvbXBvbmVudE9ySGFuZGxlICYmICJfbmF0aXZlVGFnIiBpbiBjb21wb25lbnRPckhhbmRsZSB8fCBudWxsICE9IGNvbXBvbmVudE9ySGFuZGxlLnJlbmRlciAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgY29tcG9uZW50T3JIYW5kbGUucmVuZGVyLCAiZmluZE5vZGVIYW5kbGUoLi4uKTogQXJndW1lbnQgaXMgbm90IGEgY29tcG9uZW50ICh0eXBlOiAlcywga2V5czogJXMpIiwgdHlwZW9mIGNvbXBvbmVudE9ySGFuZGxlLCBPYmplY3Qua2V5cyhjb21wb25lbnRPckhhbmRsZSkpOwogICAgaW52YXJpYW50KCExLCAiZmluZE5vZGVIYW5kbGUoLi4uKTogVW5hYmxlIHRvIGZpbmQgbm9kZSBoYW5kbGUgZm9yIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgfQoKICBmdW5jdGlvbiBmaW5kTnVtZXJpY05vZGVIYW5kbGVGaWJlcihjb21wb25lbnRPckhhbmRsZSkgewogICAgY29tcG9uZW50T3JIYW5kbGUgPSBmaW5kTm9kZUhhbmRsZShjb21wb25lbnRPckhhbmRsZSk7CiAgICByZXR1cm4gbnVsbCA9PSBjb21wb25lbnRPckhhbmRsZSB8fCAibnVtYmVyIiA9PT0gdHlwZW9mIGNvbXBvbmVudE9ySGFuZGxlID8gY29tcG9uZW50T3JIYW5kbGUgOiBjb21wb25lbnRPckhhbmRsZS5fbmF0aXZlVGFnOwogIH0KCiAgZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7CiAgICBpZiAoImZ1bmN0aW9uIiAhPT0gdHlwZW9mIHN1cGVyQ2xhc3MgJiYgbnVsbCAhPT0gc3VwZXJDbGFzcykgdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAiICsgdHlwZW9mIHN1cGVyQ2xhc3MpOwogICAgc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7CiAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgdmFsdWU6IHN1YkNsYXNzLAogICAgICAgIGVudW1lcmFibGU6ICExLAogICAgICAgIHdyaXRhYmxlOiAhMCwKICAgICAgICBjb25maWd1cmFibGU6ICEwCiAgICAgIH0KICAgIH0pOwogICAgc3VwZXJDbGFzcyAmJiAoT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3MpOwogIH0KCiAgdmFyIFJlYWN0TmF0aXZlQ29tcG9uZW50ID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICAgIGZ1bmN0aW9uIFJlYWN0TmF0aXZlQ29tcG9uZW50KCkgewogICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUmVhY3ROYXRpdmVDb21wb25lbnQpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsKCiAgICAgIHZhciBjYWxsID0gX1JlYWN0JENvbXBvbmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgaWYgKCF0aGlzKSB0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoInRoaXMgaGFzbid0IGJlZW4gaW5pdGlhbGlzZWQgLSBzdXBlcigpIGhhc24ndCBiZWVuIGNhbGxlZCIpOwogICAgICByZXR1cm4gIWNhbGwgfHwgIm9iamVjdCIgIT09IHR5cGVvZiBjYWxsICYmICJmdW5jdGlvbiIgIT09IHR5cGVvZiBjYWxsID8gdGhpcyA6IGNhbGw7CiAgICB9CgogICAgX2luaGVyaXRzKFJlYWN0TmF0aXZlQ29tcG9uZW50LCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBSZWFjdE5hdGl2ZUNvbXBvbmVudC5wcm90b3R5cGUuYmx1ciA9IGZ1bmN0aW9uICgpIHsKICAgICAgVGV4dElucHV0U3RhdGUuYmx1clRleHRJbnB1dChmaW5kTnVtZXJpY05vZGVIYW5kbGVGaWJlcih0aGlzKSk7CiAgICB9OwoKICAgIFJlYWN0TmF0aXZlQ29tcG9uZW50LnByb3RvdHlwZS5mb2N1cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgVGV4dElucHV0U3RhdGUuZm9jdXNUZXh0SW5wdXQoZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIodGhpcykpOwogICAgfTsKCiAgICBSZWFjdE5hdGl2ZUNvbXBvbmVudC5wcm90b3R5cGUubWVhc3VyZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICBVSU1hbmFnZXIubWVhc3VyZShmaW5kTnVtZXJpY05vZGVIYW5kbGVGaWJlcih0aGlzKSwgbW91bnRTYWZlQ2FsbGJhY2sodGhpcywgY2FsbGJhY2spKTsKICAgIH07CgogICAgUmVhY3ROYXRpdmVDb21wb25lbnQucHJvdG90eXBlLm1lYXN1cmVJbldpbmRvdyA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICBVSU1hbmFnZXIubWVhc3VyZUluV2luZG93KGZpbmROdW1lcmljTm9kZUhhbmRsZUZpYmVyKHRoaXMpLCBtb3VudFNhZmVDYWxsYmFjayh0aGlzLCBjYWxsYmFjaykpOwogICAgfTsKCiAgICBSZWFjdE5hdGl2ZUNvbXBvbmVudC5wcm90b3R5cGUubWVhc3VyZUxheW91dCA9IGZ1bmN0aW9uIChyZWxhdGl2ZVRvTmF0aXZlTm9kZSwgb25TdWNjZXNzLCBvbkZhaWwpIHsKICAgICAgVUlNYW5hZ2VyLm1lYXN1cmVMYXlvdXQoZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIodGhpcyksIHJlbGF0aXZlVG9OYXRpdmVOb2RlLCBtb3VudFNhZmVDYWxsYmFjayh0aGlzLCBvbkZhaWwpLCBtb3VudFNhZmVDYWxsYmFjayh0aGlzLCBvblN1Y2Nlc3MpKTsKICAgIH07CgogICAgUmVhY3ROYXRpdmVDb21wb25lbnQucHJvdG90eXBlLnNldE5hdGl2ZVByb3BzID0gZnVuY3Rpb24gKG5hdGl2ZVByb3BzKSB7CiAgICAgIHZhciBtYXliZUluc3RhbmNlID0gdm9pZCAwOwoKICAgICAgdHJ5IHsKICAgICAgICBtYXliZUluc3RhbmNlID0gZmluZE5vZGVIYW5kbGUodGhpcyk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7fQoKICAgICAgaWYgKG51bGwgIT0gbWF5YmVJbnN0YW5jZSkgewogICAgICAgIHZhciB2aWV3Q29uZmlnID0gbWF5YmVJbnN0YW5jZS52aWV3Q29uZmlnOwogICAgICAgIG5hdGl2ZVByb3BzID0gZGlmZlByb3BlcnRpZXMobnVsbCwgZW1wdHlPYmplY3QkMSwgbmF0aXZlUHJvcHMsIHZpZXdDb25maWcudmFsaWRBdHRyaWJ1dGVzKTsKICAgICAgICBudWxsICE9IG5hdGl2ZVByb3BzICYmIFVJTWFuYWdlci51cGRhdGVWaWV3KG1heWJlSW5zdGFuY2UuX25hdGl2ZVRhZywgdmlld0NvbmZpZy51aVZpZXdDbGFzc05hbWUsIG5hdGl2ZVByb3BzKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gUmVhY3ROYXRpdmVDb21wb25lbnQ7CiAgfShSZWFjdC5Db21wb25lbnQpLAogICAgICBnZXRJbnNwZWN0b3JEYXRhRm9yVmlld1RhZyA9IHZvaWQgMDsKCiAgZ2V0SW5zcGVjdG9yRGF0YUZvclZpZXdUYWcgPSBmdW5jdGlvbiBnZXRJbnNwZWN0b3JEYXRhRm9yVmlld1RhZygpIHsKICAgIGludmFyaWFudCghMSwgImdldEluc3BlY3RvckRhdGFGb3JWaWV3VGFnKCkgaXMgbm90IGF2YWlsYWJsZSBpbiBwcm9kdWN0aW9uIik7CiAgfTsKCiAgZmliZXJCYXRjaGVkVXBkYXRlcyA9IE5hdGl2ZVJlbmRlcmVyLmJhdGNoZWRVcGRhdGVzOwogIHZhciByb290cyA9IG5ldyBNYXAoKTsKCiAgZnVuY3Rpb24gZm4kanNjb21wJGlubGluZV82MTYoY2FwdHVyZWRFcnJvcikgewogICAgdmFyIGNvbXBvbmVudFN0YWNrID0gY2FwdHVyZWRFcnJvci5jb21wb25lbnRTdGFjaywKICAgICAgICBlcnJvciA9IGNhcHR1cmVkRXJyb3IuZXJyb3I7CgogICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgY2FwdHVyZWRFcnJvciA9IGVycm9yLm1lc3NhZ2U7CiAgICAgIHZhciBuYW1lID0gZXJyb3IubmFtZTsKCiAgICAgIHRyeSB7CiAgICAgICAgZXJyb3IubWVzc2FnZSA9IChjYXB0dXJlZEVycm9yID8gbmFtZSArICI6ICIgKyBjYXB0dXJlZEVycm9yIDogbmFtZSkgKyAiXG5cblRoaXMgZXJyb3IgaXMgbG9jYXRlZCBhdDoiICsgY29tcG9uZW50U3RhY2s7CiAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICB9IGVsc2UgZXJyb3IgPSAic3RyaW5nIiA9PT0gdHlwZW9mIGVycm9yID8gRXJyb3IoZXJyb3IgKyAiXG5cblRoaXMgZXJyb3IgaXMgbG9jYXRlZCBhdDoiICsgY29tcG9uZW50U3RhY2spIDogRXJyb3IoIlVuc3BlY2lmaWVkIGVycm9yIGF0OiIgKyBjb21wb25lbnRTdGFjayk7CgogICAgRXhjZXB0aW9uc01hbmFnZXIuaGFuZGxlRXhjZXB0aW9uKGVycm9yLCAhMSk7CiAgICByZXR1cm4gITE7CiAgfQoKICBpbnZhcmlhbnQoc2hvd0RpYWxvZyA9PT0gZGVmYXVsdFNob3dEaWFsb2csICJUaGUgY3VzdG9tIGRpYWxvZyB3YXMgYWxyZWFkeSBpbmplY3RlZC4iKTsKICBpbnZhcmlhbnQoImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGZuJGpzY29tcCRpbmxpbmVfNjE2LCAiSW5qZWN0ZWQgc2hvd0RpYWxvZygpIG11c3QgYmUgYSBmdW5jdGlvbi4iKTsKICBzaG93RGlhbG9nID0gZm4kanNjb21wJGlubGluZV82MTY7CiAgdmFyIFJlYWN0TmF0aXZlUmVuZGVyZXIgPSB7CiAgICBOYXRpdmVDb21wb25lbnQ6IFJlYWN0TmF0aXZlQ29tcG9uZW50LAogICAgZmluZE5vZGVIYW5kbGU6IGZpbmROdW1lcmljTm9kZUhhbmRsZUZpYmVyLAogICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoZWxlbWVudCwgY29udGFpbmVyVGFnLCBjYWxsYmFjaykgewogICAgICB2YXIgcm9vdCA9IHJvb3RzLmdldChjb250YWluZXJUYWcpOwogICAgICByb290IHx8IChyb290ID0gTmF0aXZlUmVuZGVyZXIuY3JlYXRlQ29udGFpbmVyKGNvbnRhaW5lclRhZywgITEpLCByb290cy5zZXQoY29udGFpbmVyVGFnLCByb290KSk7CiAgICAgIE5hdGl2ZVJlbmRlcmVyLnVwZGF0ZUNvbnRhaW5lcihlbGVtZW50LCByb290LCBudWxsLCBjYWxsYmFjayk7CiAgICAgIHJldHVybiBOYXRpdmVSZW5kZXJlci5nZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdCk7CiAgICB9LAogICAgdW5tb3VudENvbXBvbmVudEF0Tm9kZTogZnVuY3Rpb24gdW5tb3VudENvbXBvbmVudEF0Tm9kZShjb250YWluZXJUYWcpIHsKICAgICAgdmFyIHJvb3QgPSByb290cy5nZXQoY29udGFpbmVyVGFnKTsKICAgICAgcm9vdCAmJiBOYXRpdmVSZW5kZXJlci51cGRhdGVDb250YWluZXIobnVsbCwgcm9vdCwgbnVsbCwgZnVuY3Rpb24gKCkgewogICAgICAgIHJvb3RzWyJkZWxldGUiXShjb250YWluZXJUYWcpOwogICAgICB9KTsKICAgIH0sCiAgICB1bm1vdW50Q29tcG9uZW50QXROb2RlQW5kUmVtb3ZlQ29udGFpbmVyOiBmdW5jdGlvbiB1bm1vdW50Q29tcG9uZW50QXROb2RlQW5kUmVtb3ZlQ29udGFpbmVyKGNvbnRhaW5lclRhZykgewogICAgICBSZWFjdE5hdGl2ZVJlbmRlcmVyLnVubW91bnRDb21wb25lbnRBdE5vZGUoY29udGFpbmVyVGFnKTsKICAgICAgVUlNYW5hZ2VyLnJlbW92ZVJvb3RWaWV3KGNvbnRhaW5lclRhZyk7CiAgICB9LAogICAgY3JlYXRlUG9ydGFsOiBmdW5jdGlvbiBjcmVhdGVQb3J0YWwoY2hpbGRyZW4sIGNvbnRhaW5lclRhZykgewogICAgICByZXR1cm4gX2NyZWF0ZVBvcnRhbChjaGlsZHJlbiwgY29udGFpbmVyVGFnLCBudWxsLCAyIDwgYXJndW1lbnRzLmxlbmd0aCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1syXSA/IGFyZ3VtZW50c1syXSA6IG51bGwpOwogICAgfSwKICAgIHVuc3RhYmxlX2JhdGNoZWRVcGRhdGVzOiBiYXRjaGVkVXBkYXRlcywKICAgIGZsdXNoU3luYzogTmF0aXZlUmVuZGVyZXIuZmx1c2hTeW5jLAogICAgX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ6IHsKICAgICAgTmF0aXZlTWV0aG9kc01peGluOiB7CiAgICAgICAgbWVhc3VyZTogZnVuY3Rpb24gbWVhc3VyZShjYWxsYmFjaykgewogICAgICAgICAgVUlNYW5hZ2VyLm1lYXN1cmUoZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIodGhpcyksIG1vdW50U2FmZUNhbGxiYWNrKHRoaXMsIGNhbGxiYWNrKSk7CiAgICAgICAgfSwKICAgICAgICBtZWFzdXJlSW5XaW5kb3c6IGZ1bmN0aW9uIG1lYXN1cmVJbldpbmRvdyhjYWxsYmFjaykgewogICAgICAgICAgVUlNYW5hZ2VyLm1lYXN1cmVJbldpbmRvdyhmaW5kTnVtZXJpY05vZGVIYW5kbGVGaWJlcih0aGlzKSwgbW91bnRTYWZlQ2FsbGJhY2sodGhpcywgY2FsbGJhY2spKTsKICAgICAgICB9LAogICAgICAgIG1lYXN1cmVMYXlvdXQ6IGZ1bmN0aW9uIG1lYXN1cmVMYXlvdXQocmVsYXRpdmVUb05hdGl2ZU5vZGUsIG9uU3VjY2Vzcywgb25GYWlsKSB7CiAgICAgICAgICBVSU1hbmFnZXIubWVhc3VyZUxheW91dChmaW5kTnVtZXJpY05vZGVIYW5kbGVGaWJlcih0aGlzKSwgcmVsYXRpdmVUb05hdGl2ZU5vZGUsIG1vdW50U2FmZUNhbGxiYWNrKHRoaXMsIG9uRmFpbCksIG1vdW50U2FmZUNhbGxiYWNrKHRoaXMsIG9uU3VjY2VzcykpOwogICAgICAgIH0sCiAgICAgICAgc2V0TmF0aXZlUHJvcHM6IGZ1bmN0aW9uIHNldE5hdGl2ZVByb3BzKG5hdGl2ZVByb3BzKSB7CiAgICAgICAgICB2YXIgbWF5YmVJbnN0YW5jZSA9IHZvaWQgMDsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBtYXliZUluc3RhbmNlID0gZmluZE5vZGVIYW5kbGUodGhpcyk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcikge30KCiAgICAgICAgICBpZiAobnVsbCAhPSBtYXliZUluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciB2aWV3Q29uZmlnID0gbWF5YmVJbnN0YW5jZS52aWV3Q29uZmlnOwogICAgICAgICAgICBuYXRpdmVQcm9wcyA9IGRpZmZQcm9wZXJ0aWVzKG51bGwsIGVtcHR5T2JqZWN0JDEsIG5hdGl2ZVByb3BzLCB2aWV3Q29uZmlnLnZhbGlkQXR0cmlidXRlcyk7CiAgICAgICAgICAgIG51bGwgIT0gbmF0aXZlUHJvcHMgJiYgVUlNYW5hZ2VyLnVwZGF0ZVZpZXcobWF5YmVJbnN0YW5jZS5fbmF0aXZlVGFnLCB2aWV3Q29uZmlnLnVpVmlld0NsYXNzTmFtZSwgbmF0aXZlUHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uIGZvY3VzKCkgewogICAgICAgICAgVGV4dElucHV0U3RhdGUuZm9jdXNUZXh0SW5wdXQoZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIodGhpcykpOwogICAgICAgIH0sCiAgICAgICAgYmx1cjogZnVuY3Rpb24gYmx1cigpIHsKICAgICAgICAgIFRleHRJbnB1dFN0YXRlLmJsdXJUZXh0SW5wdXQoZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIodGhpcykpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgUmVhY3ROYXRpdmVCcmlkZ2VFdmVudFBsdWdpbjogUmVhY3ROYXRpdmVCcmlkZ2VFdmVudFBsdWdpbiwKICAgICAgUmVhY3RHbG9iYWxTaGFyZWRTdGF0ZTogUmVhY3RHbG9iYWxTaGFyZWRTdGF0ZSwKICAgICAgUmVhY3ROYXRpdmVDb21wb25lbnRUcmVlOiBSZWFjdE5hdGl2ZUNvbXBvbmVudFRyZWUsCiAgICAgIFJlYWN0TmF0aXZlUHJvcFJlZ2lzdHJ5OiBSZWFjdE5hdGl2ZVByb3BSZWdpc3RyeSwKICAgICAgVG91Y2hIaXN0b3J5TWF0aDogVG91Y2hIaXN0b3J5TWF0aCwKICAgICAgY3JlYXRlUmVhY3ROYXRpdmVDb21wb25lbnRDbGFzczogZnVuY3Rpb24gY3JlYXRlUmVhY3ROYXRpdmVDb21wb25lbnRDbGFzcyhuYW1lLCBjYWxsYmFjaykgewogICAgICAgIGludmFyaWFudCghdmlld0NvbmZpZ0NhbGxiYWNrcy5oYXMobmFtZSksICJUcmllZCB0byByZWdpc3RlciB0d28gdmlld3Mgd2l0aCB0aGUgc2FtZSBuYW1lICVzIiwgbmFtZSk7CiAgICAgICAgdmlld0NvbmZpZ0NhbGxiYWNrcy5zZXQobmFtZSwgY2FsbGJhY2spOwogICAgICAgIHJldHVybiBuYW1lOwogICAgICB9LAogICAgICB0YWtlU25hcHNob3Q6IGZ1bmN0aW9uIHRha2VTbmFwc2hvdCh2aWV3LCBvcHRpb25zKSB7CiAgICAgICAgIm51bWJlciIgIT09IHR5cGVvZiB2aWV3ICYmICJ3aW5kb3ciICE9PSB2aWV3ICYmICh2aWV3ID0gZmluZE51bWVyaWNOb2RlSGFuZGxlRmliZXIodmlldykgfHwgIndpbmRvdyIpOwogICAgICAgIHJldHVybiBVSU1hbmFnZXIuX190YWtlU25hcHNob3Qodmlldywgb3B0aW9ucyk7CiAgICAgIH0KICAgIH0KICB9OwogIE5hdGl2ZVJlbmRlcmVyLmluamVjdEludG9EZXZUb29scyh7CiAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZ2V0SW5zdGFuY2VGcm9tVGFnLAogICAgZ2V0SW5zcGVjdG9yRGF0YUZvclZpZXdUYWc6IGdldEluc3BlY3RvckRhdGFGb3JWaWV3VGFnLAogICAgYnVuZGxlVHlwZTogMCwKICAgIHZlcnNpb246ICIxNi4yLjAiLAogICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogInJlYWN0LW5hdGl2ZS1yZW5kZXJlciIKICB9KTsKICB2YXIgUmVhY3ROYXRpdmVSZW5kZXJlciQyID0gT2JqZWN0LmZyZWV6ZSh7CiAgICBkZWZhdWx0OiBSZWFjdE5hdGl2ZVJlbmRlcmVyCiAgfSksCiAgICAgIFJlYWN0TmF0aXZlUmVuZGVyZXIkMyA9IFJlYWN0TmF0aXZlUmVuZGVyZXIkMiAmJiBSZWFjdE5hdGl2ZVJlbmRlcmVyIHx8IFJlYWN0TmF0aXZlUmVuZGVyZXIkMjsKICBtb2R1bGUuZXhwb3J0cyA9IFJlYWN0TmF0aXZlUmVuZGVyZXIkM1siZGVmYXVsdCJdID8gUmVhY3ROYXRpdmVSZW5kZXJlciQzWyJkZWZhdWx0Il0gOiBSZWFjdE5hdGl2ZVJlbmRlcmVyJDM7Cn0sMTIwLFsyMywxMyw1NywxMDYsMTA3LDEwOCwzMSwxMTUsMTE2LDEwMSwxMTEsMTE3LDExOV0sIlJlYWN0TmF0aXZlUmVuZGVyZXItcHJvZCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0TmF0aXZlIiksCiAgICAgIF9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEID0gX3JlcXVpcmUuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CgogIG1vZHVsZS5leHBvcnRzID0gX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQuUmVhY3REZWJ1Z1Rvb2w7Cn0sMTIxLFsyMV0sIlJlYWN0RGVidWdUb29sIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29tcG9uZW50cy9BY3Rpdml0eUluZGljYXRvci9BY3Rpdml0eUluZGljYXRvci5qcyI7CgogIHZhciBDb2xvclByb3BUeXBlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkNvbG9yUHJvcFR5cGUiKTsKCiAgdmFyIE5hdGl2ZU1ldGhvZHNNaXhpbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJOYXRpdmVNZXRob2RzTWl4aW4iKTsKCiAgdmFyIFBsYXRmb3JtID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlBsYXRmb3JtIik7CgogIHZhciBQcm9ncmVzc0JhckFuZHJvaWQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUHJvZ3Jlc3NCYXJBbmRyb2lkIik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiUmVhY3QiKTsKCiAgdmFyIFN0eWxlU2hlZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAiU3R5bGVTaGVldCIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJWaWV3Iik7CgogIHZhciBWaWV3UHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4XSwgIlZpZXdQcm9wVHlwZXMiKTsKCiAgdmFyIGNyZWF0ZVJlYWN0Q2xhc3MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAiY3JlYXRlLXJlYWN0LWNsYXNzIik7CgogIHZhciByZXF1aXJlTmF0aXZlQ29tcG9uZW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMF0sICJyZXF1aXJlTmF0aXZlQ29tcG9uZW50Iik7CgogIHZhciBHUkFZID0gJyM5OTk5OTknOwogIHZhciBBY3Rpdml0eUluZGljYXRvciA9IGNyZWF0ZVJlYWN0Q2xhc3MoewogICAgZGlzcGxheU5hbWU6ICdBY3Rpdml0eUluZGljYXRvcicsCiAgICBtaXhpbnM6IFtOYXRpdmVNZXRob2RzTWl4aW5dLAogICAgcHJvcFR5cGVzOiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgVmlld1Byb3BUeXBlcywgewogICAgICBhbmltYXRpbmc6IFByb3BUeXBlcy5ib29sLAogICAgICBjb2xvcjogQ29sb3JQcm9wVHlwZSwKICAgICAgc2l6ZTogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLm9uZU9mKFsnc21hbGwnLCAnbGFyZ2UnXSksIFByb3BUeXBlcy5udW1iZXJdKSwKICAgICAgaGlkZXNXaGVuU3RvcHBlZDogUHJvcFR5cGVzLmJvb2wKICAgIH0pLAogICAgZ2V0RGVmYXVsdFByb3BzOiBmdW5jdGlvbiBnZXREZWZhdWx0UHJvcHMoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgYW5pbWF0aW5nOiB0cnVlLAogICAgICAgIGNvbG9yOiBQbGF0Zm9ybS5PUyA9PT0gJ2lvcycgPyBHUkFZIDogdW5kZWZpbmVkLAogICAgICAgIGhpZGVzV2hlblN0b3BwZWQ6IHRydWUsCiAgICAgICAgc2l6ZTogJ3NtYWxsJwogICAgICB9OwogICAgfSwKICAgIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICB2YXIgX3Byb3BzID0gdGhpcy5wcm9wcywKICAgICAgICAgIG9uTGF5b3V0ID0gX3Byb3BzLm9uTGF5b3V0LAogICAgICAgICAgc3R5bGUgPSBfcHJvcHMuc3R5bGUsCiAgICAgICAgICBwcm9wcyA9IGJhYmVsSGVscGVycy5vYmplY3RXaXRob3V0UHJvcGVydGllcyhfcHJvcHMsIFsib25MYXlvdXQiLCAic3R5bGUiXSk7CiAgICAgIHZhciBzaXplU3R5bGUgPSB2b2lkIDA7CgogICAgICBzd2l0Y2ggKHByb3BzLnNpemUpIHsKICAgICAgICBjYXNlICdzbWFsbCc6CiAgICAgICAgICBzaXplU3R5bGUgPSBzdHlsZXMuc2l6ZVNtYWxsOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ2xhcmdlJzoKICAgICAgICAgIHNpemVTdHlsZSA9IHN0eWxlcy5zaXplTGFyZ2U7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHNpemVTdHlsZSA9IHsKICAgICAgICAgICAgaGVpZ2h0OiBwcm9wcy5zaXplLAogICAgICAgICAgICB3aWR0aDogcHJvcHMuc2l6ZQogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICB2YXIgbmF0aXZlUHJvcHMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgcHJvcHMsIHsKICAgICAgICBzdHlsZTogc2l6ZVN0eWxlLAogICAgICAgIHN0eWxlQXR0cjogJ05vcm1hbCcsCiAgICAgICAgaW5kZXRlcm1pbmF0ZTogdHJ1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgVmlldywKICAgICAgICB7CiAgICAgICAgICBvbkxheW91dDogb25MYXlvdXQsCiAgICAgICAgICBzdHlsZTogW3N0eWxlcy5jb250YWluZXIsIHN0eWxlXSwKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDExNAogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgUGxhdGZvcm0uT1MgPT09ICdpb3MnID8gUmVhY3QuY3JlYXRlRWxlbWVudChSQ1RBY3Rpdml0eUluZGljYXRvciwgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIG5hdGl2ZVByb3BzLCB7CiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiAxMTYKICAgICAgICAgIH0KICAgICAgICB9KSkgOiBSZWFjdC5jcmVhdGVFbGVtZW50KFByb2dyZXNzQmFyQW5kcm9pZCwgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIG5hdGl2ZVByb3BzLCB7CiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiAxMTgKICAgICAgICAgIH0KICAgICAgICB9KSkKICAgICAgKTsKICAgIH0KICB9KTsKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgY29udGFpbmVyOiB7CiAgICAgIGFsaWduSXRlbXM6ICdjZW50ZXInLAogICAgICBqdXN0aWZ5Q29udGVudDogJ2NlbnRlcicKICAgIH0sCiAgICBzaXplU21hbGw6IHsKICAgICAgd2lkdGg6IDIwLAogICAgICBoZWlnaHQ6IDIwCiAgICB9LAogICAgc2l6ZUxhcmdlOiB7CiAgICAgIHdpZHRoOiAzNiwKICAgICAgaGVpZ2h0OiAzNgogICAgfQogIH0pOwoKICBpZiAoUGxhdGZvcm0uT1MgPT09ICdpb3MnKSB7CiAgICB2YXIgUkNUQWN0aXZpdHlJbmRpY2F0b3IgPSByZXF1aXJlTmF0aXZlQ29tcG9uZW50KCdSQ1RBY3Rpdml0eUluZGljYXRvclZpZXcnLCBBY3Rpdml0eUluZGljYXRvciwgewogICAgICBuYXRpdmVPbmx5OiB7CiAgICAgICAgYWN0aXZpdHlJbmRpY2F0b3JWaWV3U3R5bGU6IHRydWUKICAgICAgfQogICAgfSk7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IEFjdGl2aXR5SW5kaWNhdG9yOwp9LDEyMixbMTIzLDEyNSw1MiwxMjYsMTI3LDEzMCwxNjgsMTcwLDEzMSwxNzIsMTQ1XSwiQWN0aXZpdHlJbmRpY2F0b3IiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBub3JtYWxpemVDb2xvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJub3JtYWxpemVDb2xvciIpOwoKICB2YXIgY29sb3JQcm9wVHlwZSA9IGZ1bmN0aW9uIGNvbG9yUHJvcFR5cGUoaXNSZXF1aXJlZCwgcHJvcHMsIHByb3BOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgcHJvcEZ1bGxOYW1lKSB7CiAgICB2YXIgY29sb3IgPSBwcm9wc1twcm9wTmFtZV07CgogICAgaWYgKGNvbG9yID09PSB1bmRlZmluZWQgfHwgY29sb3IgPT09IG51bGwpIHsKICAgICAgaWYgKGlzUmVxdWlyZWQpIHsKICAgICAgICByZXR1cm4gbmV3IEVycm9yKCdSZXF1aXJlZCAnICsgbG9jYXRpb24gKyAnIGAnICsgKHByb3BGdWxsTmFtZSB8fCBwcm9wTmFtZSkgKyAnYCB3YXMgbm90IHNwZWNpZmllZCBpbiBgJyArIGNvbXBvbmVudE5hbWUgKyAnYC4nKTsKICAgICAgfQoKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh0eXBlb2YgY29sb3IgPT09ICdudW1iZXInKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAobm9ybWFsaXplQ29sb3IoY29sb3IpID09PSBudWxsKSB7CiAgICAgIHJldHVybiBuZXcgRXJyb3IoJ0ludmFsaWQgJyArIGxvY2F0aW9uICsgJyBgJyArIChwcm9wRnVsbE5hbWUgfHwgcHJvcE5hbWUpICsgJ2Agc3VwcGxpZWQgdG8gYCcgKyBjb21wb25lbnROYW1lICsgJ2A6ICcgKyBjb2xvciArICdcbicgKyAiVmFsaWQgY29sb3IgZm9ybWF0cyBhcmVcbiAgLSAnI2YwZicgKCNyZ2IpXG4gIC0gJyNmMGZjJyAoI3JnYmEpXG4gIC0gJyNmZjAwZmYnICgjcnJnZ2JiKVxuICAtICcjZmYwMGZmMDAnICgjcnJnZ2JiYWEpXG4gIC0gJ3JnYigyNTUsIDI1NSwgMjU1KSdcbiAgLSAncmdiYSgyNTUsIDI1NSwgMjU1LCAxLjApJ1xuICAtICdoc2woMzYwLCAxMDAlLCAxMDAlKSdcbiAgLSAnaHNsYSgzNjAsIDEwMCUsIDEwMCUsIDEuMCknXG4gIC0gJ3RyYW5zcGFyZW50J1xuICAtICdyZWQnXG4gIC0gMHhmZjAwZmYwMCAoMHhycmdnYmJhYSlcbiIpOwogICAgfQogIH07CgogIHZhciBDb2xvclByb3BUeXBlID0gY29sb3JQcm9wVHlwZS5iaW5kKG51bGwsIGZhbHNlKTsKICBDb2xvclByb3BUeXBlLmlzUmVxdWlyZWQgPSBjb2xvclByb3BUeXBlLmJpbmQobnVsbCwgdHJ1ZSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBDb2xvclByb3BUeXBlOwp9LDEyMyxbMTI0XSwiQ29sb3JQcm9wVHlwZSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZnVuY3Rpb24gbm9ybWFsaXplQ29sb3IoY29sb3IpIHsKICAgIHZhciBtYXRjaDsKCiAgICBpZiAodHlwZW9mIGNvbG9yID09PSAnbnVtYmVyJykgewogICAgICBpZiAoY29sb3IgPj4+IDAgPT09IGNvbG9yICYmIGNvbG9yID49IDAgJiYgY29sb3IgPD0gMHhmZmZmZmZmZikgewogICAgICAgIHJldHVybiBjb2xvcjsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgaWYgKG1hdGNoID0gbWF0Y2hlcnMuaGV4Ni5leGVjKGNvbG9yKSkgewogICAgICByZXR1cm4gcGFyc2VJbnQobWF0Y2hbMV0gKyAnZmYnLCAxNikgPj4+IDA7CiAgICB9CgogICAgaWYgKG5hbWVzLmhhc093blByb3BlcnR5KGNvbG9yKSkgewogICAgICByZXR1cm4gbmFtZXNbY29sb3JdOwogICAgfQoKICAgIGlmIChtYXRjaCA9IG1hdGNoZXJzLnJnYi5leGVjKGNvbG9yKSkgewogICAgICByZXR1cm4gKHBhcnNlMjU1KG1hdGNoWzFdKSA8PCAyNCB8IHBhcnNlMjU1KG1hdGNoWzJdKSA8PCAxNiB8IHBhcnNlMjU1KG1hdGNoWzNdKSA8PCA4IHwgMHgwMDAwMDBmZikgPj4+IDA7CiAgICB9CgogICAgaWYgKG1hdGNoID0gbWF0Y2hlcnMucmdiYS5leGVjKGNvbG9yKSkgewogICAgICByZXR1cm4gKHBhcnNlMjU1KG1hdGNoWzFdKSA8PCAyNCB8IHBhcnNlMjU1KG1hdGNoWzJdKSA8PCAxNiB8IHBhcnNlMjU1KG1hdGNoWzNdKSA8PCA4IHwgcGFyc2UxKG1hdGNoWzRdKSkgPj4+IDA7CiAgICB9CgogICAgaWYgKG1hdGNoID0gbWF0Y2hlcnMuaGV4My5leGVjKGNvbG9yKSkgewogICAgICByZXR1cm4gcGFyc2VJbnQobWF0Y2hbMV0gKyBtYXRjaFsxXSArIG1hdGNoWzJdICsgbWF0Y2hbMl0gKyBtYXRjaFszXSArIG1hdGNoWzNdICsgJ2ZmJywgMTYpID4+PiAwOwogICAgfQoKICAgIGlmIChtYXRjaCA9IG1hdGNoZXJzLmhleDguZXhlYyhjb2xvcikpIHsKICAgICAgcmV0dXJuIHBhcnNlSW50KG1hdGNoWzFdLCAxNikgPj4+IDA7CiAgICB9CgogICAgaWYgKG1hdGNoID0gbWF0Y2hlcnMuaGV4NC5leGVjKGNvbG9yKSkgewogICAgICByZXR1cm4gcGFyc2VJbnQobWF0Y2hbMV0gKyBtYXRjaFsxXSArIG1hdGNoWzJdICsgbWF0Y2hbMl0gKyBtYXRjaFszXSArIG1hdGNoWzNdICsgbWF0Y2hbNF0gKyBtYXRjaFs0XSwgMTYpID4+PiAwOwogICAgfQoKICAgIGlmIChtYXRjaCA9IG1hdGNoZXJzLmhzbC5leGVjKGNvbG9yKSkgewogICAgICByZXR1cm4gKGhzbFRvUmdiKHBhcnNlMzYwKG1hdGNoWzFdKSwgcGFyc2VQZXJjZW50YWdlKG1hdGNoWzJdKSwgcGFyc2VQZXJjZW50YWdlKG1hdGNoWzNdKSkgfCAweDAwMDAwMGZmKSA+Pj4gMDsKICAgIH0KCiAgICBpZiAobWF0Y2ggPSBtYXRjaGVycy5oc2xhLmV4ZWMoY29sb3IpKSB7CiAgICAgIHJldHVybiAoaHNsVG9SZ2IocGFyc2UzNjAobWF0Y2hbMV0pLCBwYXJzZVBlcmNlbnRhZ2UobWF0Y2hbMl0pLCBwYXJzZVBlcmNlbnRhZ2UobWF0Y2hbM10pKSB8IHBhcnNlMShtYXRjaFs0XSkpID4+PiAwOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH0KCiAgZnVuY3Rpb24gaHVlMnJnYihwLCBxLCB0KSB7CiAgICBpZiAodCA8IDApIHsKICAgICAgdCArPSAxOwogICAgfQoKICAgIGlmICh0ID4gMSkgewogICAgICB0IC09IDE7CiAgICB9CgogICAgaWYgKHQgPCAxIC8gNikgewogICAgICByZXR1cm4gcCArIChxIC0gcCkgKiA2ICogdDsKICAgIH0KCiAgICBpZiAodCA8IDEgLyAyKSB7CiAgICAgIHJldHVybiBxOwogICAgfQoKICAgIGlmICh0IDwgMiAvIDMpIHsKICAgICAgcmV0dXJuIHAgKyAocSAtIHApICogKDIgLyAzIC0gdCkgKiA2OwogICAgfQoKICAgIHJldHVybiBwOwogIH0KCiAgZnVuY3Rpb24gaHNsVG9SZ2IoaCwgcywgbCkgewogICAgdmFyIHEgPSBsIDwgMC41ID8gbCAqICgxICsgcykgOiBsICsgcyAtIGwgKiBzOwogICAgdmFyIHAgPSAyICogbCAtIHE7CiAgICB2YXIgciA9IGh1ZTJyZ2IocCwgcSwgaCArIDEgLyAzKTsKICAgIHZhciBnID0gaHVlMnJnYihwLCBxLCBoKTsKICAgIHZhciBiID0gaHVlMnJnYihwLCBxLCBoIC0gMSAvIDMpOwogICAgcmV0dXJuIE1hdGgucm91bmQociAqIDI1NSkgPDwgMjQgfCBNYXRoLnJvdW5kKGcgKiAyNTUpIDw8IDE2IHwgTWF0aC5yb3VuZChiICogMjU1KSA8PCA4OwogIH0KCiAgdmFyIE5VTUJFUiA9ICdbLStdP1xcZCpcXC4/XFxkKyc7CiAgdmFyIFBFUkNFTlRBR0UgPSBOVU1CRVIgKyAnJSc7CgogIGZ1bmN0aW9uIGNhbGwoKSB7CiAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgfQoKICAgIHJldHVybiAnXFwoXFxzKignICsgYXJncy5qb2luKCcpXFxzKixcXHMqKCcpICsgJylcXHMqXFwpJzsKICB9CgogIHZhciBtYXRjaGVycyA9IHsKICAgIHJnYjogbmV3IFJlZ0V4cCgncmdiJyArIGNhbGwoTlVNQkVSLCBOVU1CRVIsIE5VTUJFUikpLAogICAgcmdiYTogbmV3IFJlZ0V4cCgncmdiYScgKyBjYWxsKE5VTUJFUiwgTlVNQkVSLCBOVU1CRVIsIE5VTUJFUikpLAogICAgaHNsOiBuZXcgUmVnRXhwKCdoc2wnICsgY2FsbChOVU1CRVIsIFBFUkNFTlRBR0UsIFBFUkNFTlRBR0UpKSwKICAgIGhzbGE6IG5ldyBSZWdFeHAoJ2hzbGEnICsgY2FsbChOVU1CRVIsIFBFUkNFTlRBR0UsIFBFUkNFTlRBR0UsIE5VTUJFUikpLAogICAgaGV4MzogL14jKFswLTlhLWZBLUZdezF9KShbMC05YS1mQS1GXXsxfSkoWzAtOWEtZkEtRl17MX0pJC8sCiAgICBoZXg0OiAvXiMoWzAtOWEtZkEtRl17MX0pKFswLTlhLWZBLUZdezF9KShbMC05YS1mQS1GXXsxfSkoWzAtOWEtZkEtRl17MX0pJC8sCiAgICBoZXg2OiAvXiMoWzAtOWEtZkEtRl17Nn0pJC8sCiAgICBoZXg4OiAvXiMoWzAtOWEtZkEtRl17OH0pJC8KICB9OwoKICBmdW5jdGlvbiBwYXJzZTI1NShzdHIpIHsKICAgIHZhciBpbnQgPSBwYXJzZUludChzdHIsIDEwKTsKCiAgICBpZiAoaW50IDwgMCkgewogICAgICByZXR1cm4gMDsKICAgIH0KCiAgICBpZiAoaW50ID4gMjU1KSB7CiAgICAgIHJldHVybiAyNTU7CiAgICB9CgogICAgcmV0dXJuIGludDsKICB9CgogIGZ1bmN0aW9uIHBhcnNlMzYwKHN0cikgewogICAgdmFyIGludCA9IHBhcnNlRmxvYXQoc3RyKTsKICAgIHJldHVybiAoaW50ICUgMzYwICsgMzYwKSAlIDM2MCAvIDM2MDsKICB9CgogIGZ1bmN0aW9uIHBhcnNlMShzdHIpIHsKICAgIHZhciBudW0gPSBwYXJzZUZsb2F0KHN0cik7CgogICAgaWYgKG51bSA8IDApIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgaWYgKG51bSA+IDEpIHsKICAgICAgcmV0dXJuIDI1NTsKICAgIH0KCiAgICByZXR1cm4gTWF0aC5yb3VuZChudW0gKiAyNTUpOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VQZXJjZW50YWdlKHN0cikgewogICAgdmFyIGludCA9IHBhcnNlRmxvYXQoc3RyKTsKCiAgICBpZiAoaW50IDwgMCkgewogICAgICByZXR1cm4gMDsKICAgIH0KCiAgICBpZiAoaW50ID4gMTAwKSB7CiAgICAgIHJldHVybiAxOwogICAgfQoKICAgIHJldHVybiBpbnQgLyAxMDA7CiAgfQoKICB2YXIgbmFtZXMgPSB7CiAgICB0cmFuc3BhcmVudDogMHgwMDAwMDAwMCwKICAgIGFsaWNlYmx1ZTogMHhmMGY4ZmZmZiwKICAgIGFudGlxdWV3aGl0ZTogMHhmYWViZDdmZiwKICAgIGFxdWE6IDB4MDBmZmZmZmYsCiAgICBhcXVhbWFyaW5lOiAweDdmZmZkNGZmLAogICAgYXp1cmU6IDB4ZjBmZmZmZmYsCiAgICBiZWlnZTogMHhmNWY1ZGNmZiwKICAgIGJpc3F1ZTogMHhmZmU0YzRmZiwKICAgIGJsYWNrOiAweDAwMDAwMGZmLAogICAgYmxhbmNoZWRhbG1vbmQ6IDB4ZmZlYmNkZmYsCiAgICBibHVlOiAweDAwMDBmZmZmLAogICAgYmx1ZXZpb2xldDogMHg4YTJiZTJmZiwKICAgIGJyb3duOiAweGE1MmEyYWZmLAogICAgYnVybHl3b29kOiAweGRlYjg4N2ZmLAogICAgYnVybnRzaWVubmE6IDB4ZWE3ZTVkZmYsCiAgICBjYWRldGJsdWU6IDB4NWY5ZWEwZmYsCiAgICBjaGFydHJldXNlOiAweDdmZmYwMGZmLAogICAgY2hvY29sYXRlOiAweGQyNjkxZWZmLAogICAgY29yYWw6IDB4ZmY3ZjUwZmYsCiAgICBjb3JuZmxvd2VyYmx1ZTogMHg2NDk1ZWRmZiwKICAgIGNvcm5zaWxrOiAweGZmZjhkY2ZmLAogICAgY3JpbXNvbjogMHhkYzE0M2NmZiwKICAgIGN5YW46IDB4MDBmZmZmZmYsCiAgICBkYXJrYmx1ZTogMHgwMDAwOGJmZiwKICAgIGRhcmtjeWFuOiAweDAwOGI4YmZmLAogICAgZGFya2dvbGRlbnJvZDogMHhiODg2MGJmZiwKICAgIGRhcmtncmF5OiAweGE5YTlhOWZmLAogICAgZGFya2dyZWVuOiAweDAwNjQwMGZmLAogICAgZGFya2dyZXk6IDB4YTlhOWE5ZmYsCiAgICBkYXJra2hha2k6IDB4YmRiNzZiZmYsCiAgICBkYXJrbWFnZW50YTogMHg4YjAwOGJmZiwKICAgIGRhcmtvbGl2ZWdyZWVuOiAweDU1NmIyZmZmLAogICAgZGFya29yYW5nZTogMHhmZjhjMDBmZiwKICAgIGRhcmtvcmNoaWQ6IDB4OTkzMmNjZmYsCiAgICBkYXJrcmVkOiAweDhiMDAwMGZmLAogICAgZGFya3NhbG1vbjogMHhlOTk2N2FmZiwKICAgIGRhcmtzZWFncmVlbjogMHg4ZmJjOGZmZiwKICAgIGRhcmtzbGF0ZWJsdWU6IDB4NDgzZDhiZmYsCiAgICBkYXJrc2xhdGVncmF5OiAweDJmNGY0ZmZmLAogICAgZGFya3NsYXRlZ3JleTogMHgyZjRmNGZmZiwKICAgIGRhcmt0dXJxdW9pc2U6IDB4MDBjZWQxZmYsCiAgICBkYXJrdmlvbGV0OiAweDk0MDBkM2ZmLAogICAgZGVlcHBpbms6IDB4ZmYxNDkzZmYsCiAgICBkZWVwc2t5Ymx1ZTogMHgwMGJmZmZmZiwKICAgIGRpbWdyYXk6IDB4Njk2OTY5ZmYsCiAgICBkaW1ncmV5OiAweDY5Njk2OWZmLAogICAgZG9kZ2VyYmx1ZTogMHgxZTkwZmZmZiwKICAgIGZpcmVicmljazogMHhiMjIyMjJmZiwKICAgIGZsb3JhbHdoaXRlOiAweGZmZmFmMGZmLAogICAgZm9yZXN0Z3JlZW46IDB4MjI4YjIyZmYsCiAgICBmdWNoc2lhOiAweGZmMDBmZmZmLAogICAgZ2FpbnNib3JvOiAweGRjZGNkY2ZmLAogICAgZ2hvc3R3aGl0ZTogMHhmOGY4ZmZmZiwKICAgIGdvbGQ6IDB4ZmZkNzAwZmYsCiAgICBnb2xkZW5yb2Q6IDB4ZGFhNTIwZmYsCiAgICBncmF5OiAweDgwODA4MGZmLAogICAgZ3JlZW46IDB4MDA4MDAwZmYsCiAgICBncmVlbnllbGxvdzogMHhhZGZmMmZmZiwKICAgIGdyZXk6IDB4ODA4MDgwZmYsCiAgICBob25leWRldzogMHhmMGZmZjBmZiwKICAgIGhvdHBpbms6IDB4ZmY2OWI0ZmYsCiAgICBpbmRpYW5yZWQ6IDB4Y2Q1YzVjZmYsCiAgICBpbmRpZ286IDB4NGIwMDgyZmYsCiAgICBpdm9yeTogMHhmZmZmZjBmZiwKICAgIGtoYWtpOiAweGYwZTY4Y2ZmLAogICAgbGF2ZW5kZXI6IDB4ZTZlNmZhZmYsCiAgICBsYXZlbmRlcmJsdXNoOiAweGZmZjBmNWZmLAogICAgbGF3bmdyZWVuOiAweDdjZmMwMGZmLAogICAgbGVtb25jaGlmZm9uOiAweGZmZmFjZGZmLAogICAgbGlnaHRibHVlOiAweGFkZDhlNmZmLAogICAgbGlnaHRjb3JhbDogMHhmMDgwODBmZiwKICAgIGxpZ2h0Y3lhbjogMHhlMGZmZmZmZiwKICAgIGxpZ2h0Z29sZGVucm9keWVsbG93OiAweGZhZmFkMmZmLAogICAgbGlnaHRncmF5OiAweGQzZDNkM2ZmLAogICAgbGlnaHRncmVlbjogMHg5MGVlOTBmZiwKICAgIGxpZ2h0Z3JleTogMHhkM2QzZDNmZiwKICAgIGxpZ2h0cGluazogMHhmZmI2YzFmZiwKICAgIGxpZ2h0c2FsbW9uOiAweGZmYTA3YWZmLAogICAgbGlnaHRzZWFncmVlbjogMHgyMGIyYWFmZiwKICAgIGxpZ2h0c2t5Ymx1ZTogMHg4N2NlZmFmZiwKICAgIGxpZ2h0c2xhdGVncmF5OiAweDc3ODg5OWZmLAogICAgbGlnaHRzbGF0ZWdyZXk6IDB4Nzc4ODk5ZmYsCiAgICBsaWdodHN0ZWVsYmx1ZTogMHhiMGM0ZGVmZiwKICAgIGxpZ2h0eWVsbG93OiAweGZmZmZlMGZmLAogICAgbGltZTogMHgwMGZmMDBmZiwKICAgIGxpbWVncmVlbjogMHgzMmNkMzJmZiwKICAgIGxpbmVuOiAweGZhZjBlNmZmLAogICAgbWFnZW50YTogMHhmZjAwZmZmZiwKICAgIG1hcm9vbjogMHg4MDAwMDBmZiwKICAgIG1lZGl1bWFxdWFtYXJpbmU6IDB4NjZjZGFhZmYsCiAgICBtZWRpdW1ibHVlOiAweDAwMDBjZGZmLAogICAgbWVkaXVtb3JjaGlkOiAweGJhNTVkM2ZmLAogICAgbWVkaXVtcHVycGxlOiAweDkzNzBkYmZmLAogICAgbWVkaXVtc2VhZ3JlZW46IDB4M2NiMzcxZmYsCiAgICBtZWRpdW1zbGF0ZWJsdWU6IDB4N2I2OGVlZmYsCiAgICBtZWRpdW1zcHJpbmdncmVlbjogMHgwMGZhOWFmZiwKICAgIG1lZGl1bXR1cnF1b2lzZTogMHg0OGQxY2NmZiwKICAgIG1lZGl1bXZpb2xldHJlZDogMHhjNzE1ODVmZiwKICAgIG1pZG5pZ2h0Ymx1ZTogMHgxOTE5NzBmZiwKICAgIG1pbnRjcmVhbTogMHhmNWZmZmFmZiwKICAgIG1pc3R5cm9zZTogMHhmZmU0ZTFmZiwKICAgIG1vY2Nhc2luOiAweGZmZTRiNWZmLAogICAgbmF2YWpvd2hpdGU6IDB4ZmZkZWFkZmYsCiAgICBuYXZ5OiAweDAwMDA4MGZmLAogICAgb2xkbGFjZTogMHhmZGY1ZTZmZiwKICAgIG9saXZlOiAweDgwODAwMGZmLAogICAgb2xpdmVkcmFiOiAweDZiOGUyM2ZmLAogICAgb3JhbmdlOiAweGZmYTUwMGZmLAogICAgb3JhbmdlcmVkOiAweGZmNDUwMGZmLAogICAgb3JjaGlkOiAweGRhNzBkNmZmLAogICAgcGFsZWdvbGRlbnJvZDogMHhlZWU4YWFmZiwKICAgIHBhbGVncmVlbjogMHg5OGZiOThmZiwKICAgIHBhbGV0dXJxdW9pc2U6IDB4YWZlZWVlZmYsCiAgICBwYWxldmlvbGV0cmVkOiAweGRiNzA5M2ZmLAogICAgcGFwYXlhd2hpcDogMHhmZmVmZDVmZiwKICAgIHBlYWNocHVmZjogMHhmZmRhYjlmZiwKICAgIHBlcnU6IDB4Y2Q4NTNmZmYsCiAgICBwaW5rOiAweGZmYzBjYmZmLAogICAgcGx1bTogMHhkZGEwZGRmZiwKICAgIHBvd2RlcmJsdWU6IDB4YjBlMGU2ZmYsCiAgICBwdXJwbGU6IDB4ODAwMDgwZmYsCiAgICByZWJlY2NhcHVycGxlOiAweDY2MzM5OWZmLAogICAgcmVkOiAweGZmMDAwMGZmLAogICAgcm9zeWJyb3duOiAweGJjOGY4ZmZmLAogICAgcm95YWxibHVlOiAweDQxNjllMWZmLAogICAgc2FkZGxlYnJvd246IDB4OGI0NTEzZmYsCiAgICBzYWxtb246IDB4ZmE4MDcyZmYsCiAgICBzYW5keWJyb3duOiAweGY0YTQ2MGZmLAogICAgc2VhZ3JlZW46IDB4MmU4YjU3ZmYsCiAgICBzZWFzaGVsbDogMHhmZmY1ZWVmZiwKICAgIHNpZW5uYTogMHhhMDUyMmRmZiwKICAgIHNpbHZlcjogMHhjMGMwYzBmZiwKICAgIHNreWJsdWU6IDB4ODdjZWViZmYsCiAgICBzbGF0ZWJsdWU6IDB4NmE1YWNkZmYsCiAgICBzbGF0ZWdyYXk6IDB4NzA4MDkwZmYsCiAgICBzbGF0ZWdyZXk6IDB4NzA4MDkwZmYsCiAgICBzbm93OiAweGZmZmFmYWZmLAogICAgc3ByaW5nZ3JlZW46IDB4MDBmZjdmZmYsCiAgICBzdGVlbGJsdWU6IDB4NDY4MmI0ZmYsCiAgICB0YW46IDB4ZDJiNDhjZmYsCiAgICB0ZWFsOiAweDAwODA4MGZmLAogICAgdGhpc3RsZTogMHhkOGJmZDhmZiwKICAgIHRvbWF0bzogMHhmZjYzNDdmZiwKICAgIHR1cnF1b2lzZTogMHg0MGUwZDBmZiwKICAgIHZpb2xldDogMHhlZTgyZWVmZiwKICAgIHdoZWF0OiAweGY1ZGViM2ZmLAogICAgd2hpdGU6IDB4ZmZmZmZmZmYsCiAgICB3aGl0ZXNtb2tlOiAweGY1ZjVmNWZmLAogICAgeWVsbG93OiAweGZmZmYwMGZmLAogICAgeWVsbG93Z3JlZW46IDB4OWFjZDMyZmYKICB9OwogIG1vZHVsZS5leHBvcnRzID0gbm9ybWFsaXplQ29sb3I7Cn0sMTI0LFtdLCJub3JtYWxpemVDb2xvciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0TmF0aXZlIiksCiAgICAgIF9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEID0gX3JlcXVpcmUuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CgogIHZhciBOYXRpdmVNZXRob2RzTWl4aW4gPSBfX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRC5OYXRpdmVNZXRob2RzTWl4aW47CiAgbW9kdWxlLmV4cG9ydHMgPSBOYXRpdmVNZXRob2RzTWl4aW47Cn0sMTI1LFsyMV0sIk5hdGl2ZU1ldGhvZHNNaXhpbiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9jbGFzcywKICAgICAgX3RlbXAsCiAgICAgIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvbXBvbmVudHMvUHJvZ3Jlc3NCYXJBbmRyb2lkL1Byb2dyZXNzQmFyQW5kcm9pZC5hbmRyb2lkLmpzIjsKCiAgdmFyIENvbG9yUHJvcFR5cGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQ29sb3JQcm9wVHlwZSIpOwoKICB2YXIgUHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgInByb3AtdHlwZXMiKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlJlYWN0Iik7CgogIHZhciBSZWFjdE5hdGl2ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJSZWFjdE5hdGl2ZSIpOwoKICB2YXIgVmlld1Byb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJWaWV3UHJvcFR5cGVzIik7CgogIHZhciByZXF1aXJlTmF0aXZlQ29tcG9uZW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgInJlcXVpcmVOYXRpdmVDb21wb25lbnQiKTsKCiAgdmFyIFNUWUxFX0FUVFJJQlVURVMgPSBbJ0hvcml6b250YWwnLCAnTm9ybWFsJywgJ1NtYWxsJywgJ0xhcmdlJywgJ0ludmVyc2UnLCAnU21hbGxJbnZlcnNlJywgJ0xhcmdlSW52ZXJzZSddOwoKICB2YXIgaW5kZXRlcm1pbmF0ZVR5cGUgPSBmdW5jdGlvbiBpbmRldGVybWluYXRlVHlwZShwcm9wcywgcHJvcE5hbWUsIGNvbXBvbmVudE5hbWUpIHsKICAgIHZhciBjaGVja2VyID0gZnVuY3Rpb24gY2hlY2tlcigpIHsKICAgICAgdmFyIGluZGV0ZXJtaW5hdGUgPSBwcm9wc1twcm9wTmFtZV07CiAgICAgIHZhciBzdHlsZUF0dHIgPSBwcm9wcy5zdHlsZUF0dHI7CgogICAgICBpZiAoIWluZGV0ZXJtaW5hdGUgJiYgc3R5bGVBdHRyICE9PSAnSG9yaXpvbnRhbCcpIHsKICAgICAgICByZXR1cm4gbmV3IEVycm9yKCdpbmRldGVybWluYXRlPWZhbHNlIGlzIG9ubHkgdmFsaWQgZm9yIHN0eWxlQXR0cj1Ib3Jpem9udGFsJyk7CiAgICAgIH0KICAgIH07CgogICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIHJlc3QgPSBBcnJheShfbGVuID4gMyA/IF9sZW4gLSAzIDogMCksIF9rZXkgPSAzOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgIHJlc3RbX2tleSAtIDNdID0gYXJndW1lbnRzW19rZXldOwogICAgfQoKICAgIHJldHVybiBQcm9wVHlwZXMuYm9vbC5hcHBseShQcm9wVHlwZXMsIFtwcm9wcywgcHJvcE5hbWUsIGNvbXBvbmVudE5hbWVdLmNvbmNhdChyZXN0KSkgfHwgY2hlY2tlcigpOwogIH07CgogIHZhciBQcm9ncmVzc0JhckFuZHJvaWQgPSAoX3RlbXAgPSBfY2xhc3MgPSBmdW5jdGlvbiAoX1JlYWN0TmF0aXZlJE5hdGl2ZUNvKSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoUHJvZ3Jlc3NCYXJBbmRyb2lkLCBfUmVhY3ROYXRpdmUkTmF0aXZlQ28pOwoKICAgIGZ1bmN0aW9uIFByb2dyZXNzQmFyQW5kcm9pZCgpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFByb2dyZXNzQmFyQW5kcm9pZCk7CiAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoUHJvZ3Jlc3NCYXJBbmRyb2lkLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoUHJvZ3Jlc3NCYXJBbmRyb2lkKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFByb2dyZXNzQmFyQW5kcm9pZCwgW3sKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChBbmRyb2lkUHJvZ3Jlc3NCYXIsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCB0aGlzLnByb3BzLCB7CiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiAxMTIKICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBQcm9ncmVzc0JhckFuZHJvaWQ7CiAgfShSZWFjdE5hdGl2ZS5OYXRpdmVDb21wb25lbnQpLCBfY2xhc3MucHJvcFR5cGVzID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIFZpZXdQcm9wVHlwZXMsIHsKICAgIHN0eWxlQXR0cjogUHJvcFR5cGVzLm9uZU9mKFNUWUxFX0FUVFJJQlVURVMpLAogICAgYW5pbWF0aW5nOiBQcm9wVHlwZXMuYm9vbCwKICAgIGluZGV0ZXJtaW5hdGU6IGluZGV0ZXJtaW5hdGVUeXBlLAogICAgcHJvZ3Jlc3M6IFByb3BUeXBlcy5udW1iZXIsCiAgICBjb2xvcjogQ29sb3JQcm9wVHlwZSwKICAgIHRlc3RJRDogUHJvcFR5cGVzLnN0cmluZwogIH0pLCBfY2xhc3MuZGVmYXVsdFByb3BzID0gewogICAgc3R5bGVBdHRyOiAnTm9ybWFsJywKICAgIGluZGV0ZXJtaW5hdGU6IHRydWUsCiAgICBhbmltYXRpbmc6IHRydWUKICB9LCBfdGVtcCk7CiAgdmFyIEFuZHJvaWRQcm9ncmVzc0JhciA9IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoJ0FuZHJvaWRQcm9ncmVzc0JhcicsIFByb2dyZXNzQmFyQW5kcm9pZCwgewogICAgbmF0aXZlT25seTogewogICAgICBhbmltYXRpbmc6IHRydWUKICAgIH0KICB9KTsKICBtb2R1bGUuZXhwb3J0cyA9IFByb2dyZXNzQmFyQW5kcm9pZDsKfSwxMjYsWzEyMywxMjcsMTMwLDIxLDEzMSwxNDVdLCJQcm9ncmVzc0JhckFuZHJvaWQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgdmFyIFJFQUNUX0VMRU1FTlRfVFlQRSA9IHR5cGVvZiBTeW1ib2wgPT09ICdmdW5jdGlvbicgJiYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuZm9yIDogIkBAZm9yIikgJiYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuZm9yIDogIkBAZm9yIikoJ3JlYWN0LmVsZW1lbnQnKSB8fCAweGVhYzc7CgogICAgdmFyIGlzVmFsaWRFbGVtZW50ID0gZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQob2JqZWN0KSB7CiAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAnb2JqZWN0JyAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICB9OwoKICAgIHZhciB0aHJvd09uRGlyZWN0QWNjZXNzID0gdHJ1ZTsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgJy4vZmFjdG9yeVdpdGhUeXBlQ2hlY2tlcnMnKShpc1ZhbGlkRWxlbWVudCwgdGhyb3dPbkRpcmVjdEFjY2Vzcyk7CiAgfSBlbHNlIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vZmFjdG9yeVdpdGhUaHJvd2luZ1NoaW1zJykoKTsKICB9Cn0sMTI3LFsxMjgsMTI5XSwicHJvcC10eXBlcy9pbmRleC5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGVtcHR5RnVuY3Rpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiZmJqcy9saWIvZW1wdHlGdW5jdGlvbiIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgd2FybmluZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJmYmpzL2xpYi93YXJuaW5nIik7CgogIHZhciBhc3NpZ24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAib2JqZWN0LWFzc2lnbiIpOwoKICB2YXIgUmVhY3RQcm9wVHlwZXNTZWNyZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAnLi9saWIvUmVhY3RQcm9wVHlwZXNTZWNyZXQnKTsKCiAgdmFyIGNoZWNrUHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgJy4vY2hlY2tQcm9wVHlwZXMnKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoaXNWYWxpZEVsZW1lbnQsIHRocm93T25EaXJlY3RBY2Nlc3MpIHsKICAgIHZhciBJVEVSQVRPUl9TWU1CT0wgPSB0eXBlb2YgU3ltYm9sID09PSAnZnVuY3Rpb24nICYmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLml0ZXJhdG9yIDogIkBAaXRlcmF0b3IiKTsKICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICdAQGl0ZXJhdG9yJzsKCiAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBtYXliZUl0ZXJhYmxlICYmIChJVEVSQVRPUl9TWU1CT0wgJiYgbWF5YmVJdGVyYWJsZVtJVEVSQVRPUl9TWU1CT0xdIHx8IG1heWJlSXRlcmFibGVbRkFVWF9JVEVSQVRPUl9TWU1CT0xdKTsKCiAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBpdGVyYXRvckZuOwogICAgICB9CiAgICB9CgogICAgdmFyIEFOT05ZTU9VUyA9ICc8PGFub255bW91cz4+JzsKICAgIHZhciBSZWFjdFByb3BUeXBlcyA9IHsKICAgICAgYXJyYXk6IGNyZWF0ZVByaW1pdGl2ZVR5cGVDaGVja2VyKCdhcnJheScpLAogICAgICBib29sOiBjcmVhdGVQcmltaXRpdmVUeXBlQ2hlY2tlcignYm9vbGVhbicpLAogICAgICBmdW5jOiBjcmVhdGVQcmltaXRpdmVUeXBlQ2hlY2tlcignZnVuY3Rpb24nKSwKICAgICAgbnVtYmVyOiBjcmVhdGVQcmltaXRpdmVUeXBlQ2hlY2tlcignbnVtYmVyJyksCiAgICAgIG9iamVjdDogY3JlYXRlUHJpbWl0aXZlVHlwZUNoZWNrZXIoJ29iamVjdCcpLAogICAgICBzdHJpbmc6IGNyZWF0ZVByaW1pdGl2ZVR5cGVDaGVja2VyKCdzdHJpbmcnKSwKICAgICAgc3ltYm9sOiBjcmVhdGVQcmltaXRpdmVUeXBlQ2hlY2tlcignc3ltYm9sJyksCiAgICAgIGFueTogY3JlYXRlQW55VHlwZUNoZWNrZXIoKSwKICAgICAgYXJyYXlPZjogY3JlYXRlQXJyYXlPZlR5cGVDaGVja2VyLAogICAgICBlbGVtZW50OiBjcmVhdGVFbGVtZW50VHlwZUNoZWNrZXIoKSwKICAgICAgaW5zdGFuY2VPZjogY3JlYXRlSW5zdGFuY2VUeXBlQ2hlY2tlciwKICAgICAgbm9kZTogY3JlYXRlTm9kZUNoZWNrZXIoKSwKICAgICAgb2JqZWN0T2Y6IGNyZWF0ZU9iamVjdE9mVHlwZUNoZWNrZXIsCiAgICAgIG9uZU9mOiBjcmVhdGVFbnVtVHlwZUNoZWNrZXIsCiAgICAgIG9uZU9mVHlwZTogY3JlYXRlVW5pb25UeXBlQ2hlY2tlciwKICAgICAgc2hhcGU6IGNyZWF0ZVNoYXBlVHlwZUNoZWNrZXIsCiAgICAgIGV4YWN0OiBjcmVhdGVTdHJpY3RTaGFwZVR5cGVDaGVja2VyCiAgICB9OwoKICAgIGZ1bmN0aW9uIGlzKHgsIHkpIHsKICAgICAgaWYgKHggPT09IHkpIHsKICAgICAgICByZXR1cm4geCAhPT0gMCB8fCAxIC8geCA9PT0gMSAvIHk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHggIT09IHggJiYgeSAhPT0geTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIFByb3BUeXBlRXJyb3IobWVzc2FnZSkgewogICAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICB0aGlzLnN0YWNrID0gJyc7CiAgICB9CgogICAgUHJvcFR5cGVFcnJvci5wcm90b3R5cGUgPSBFcnJvci5wcm90b3R5cGU7CgogICAgZnVuY3Rpb24gY3JlYXRlQ2hhaW5hYmxlVHlwZUNoZWNrZXIodmFsaWRhdGUpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICB2YXIgbWFudWFsUHJvcFR5cGVDYWxsQ2FjaGUgPSB7fTsKICAgICAgICB2YXIgbWFudWFsUHJvcFR5cGVXYXJuaW5nQ291bnQgPSAwOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjaGVja1R5cGUoaXNSZXF1aXJlZCwgcHJvcHMsIHByb3BOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgcHJvcEZ1bGxOYW1lLCBzZWNyZXQpIHsKICAgICAgICBjb21wb25lbnROYW1lID0gY29tcG9uZW50TmFtZSB8fCBBTk9OWU1PVVM7CiAgICAgICAgcHJvcEZ1bGxOYW1lID0gcHJvcEZ1bGxOYW1lIHx8IHByb3BOYW1lOwoKICAgICAgICBpZiAoc2VjcmV0ICE9PSBSZWFjdFByb3BUeXBlc1NlY3JldCkgewogICAgICAgICAgaWYgKHRocm93T25EaXJlY3RBY2Nlc3MpIHsKICAgICAgICAgICAgaW52YXJpYW50KGZhbHNlLCAnQ2FsbGluZyBQcm9wVHlwZXMgdmFsaWRhdG9ycyBkaXJlY3RseSBpcyBub3Qgc3VwcG9ydGVkIGJ5IHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZS4gJyArICdVc2UgYFByb3BUeXBlcy5jaGVja1Byb3BUeXBlcygpYCB0byBjYWxsIHRoZW0uICcgKyAnUmVhZCBtb3JlIGF0IGh0dHA6Ly9mYi5tZS91c2UtY2hlY2stcHJvcC10eXBlcycpOwogICAgICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICB2YXIgY2FjaGVLZXkgPSBjb21wb25lbnROYW1lICsgJzonICsgcHJvcE5hbWU7CgogICAgICAgICAgICBpZiAoIW1hbnVhbFByb3BUeXBlQ2FsbENhY2hlW2NhY2hlS2V5XSAmJiBtYW51YWxQcm9wVHlwZVdhcm5pbmdDb3VudCA8IDMpIHsKICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAnWW91IGFyZSBtYW51YWxseSBjYWxsaW5nIGEgUmVhY3QuUHJvcFR5cGVzIHZhbGlkYXRpb24gJyArICdmdW5jdGlvbiBmb3IgdGhlIGAlc2AgcHJvcCBvbiBgJXNgLiBUaGlzIGlzIGRlcHJlY2F0ZWQgJyArICdhbmQgd2lsbCB0aHJvdyBpbiB0aGUgc3RhbmRhbG9uZSBgcHJvcC10eXBlc2AgcGFja2FnZS4gJyArICdZb3UgbWF5IGJlIHNlZWluZyB0aGlzIHdhcm5pbmcgZHVlIHRvIGEgdGhpcmQtcGFydHkgUHJvcFR5cGVzICcgKyAnbGlicmFyeS4gU2VlIGh0dHBzOi8vZmIubWUvcmVhY3Qtd2FybmluZy1kb250LWNhbGwtcHJvcHR5cGVzICcgKyAnZm9yIGRldGFpbHMuJywgcHJvcEZ1bGxOYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICBtYW51YWxQcm9wVHlwZUNhbGxDYWNoZVtjYWNoZUtleV0gPSB0cnVlOwogICAgICAgICAgICAgIG1hbnVhbFByb3BUeXBlV2FybmluZ0NvdW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT0gbnVsbCkgewogICAgICAgICAgaWYgKGlzUmVxdWlyZWQpIHsKICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvcFR5cGVFcnJvcignVGhlICcgKyBsb2NhdGlvbiArICcgYCcgKyBwcm9wRnVsbE5hbWUgKyAnYCBpcyBtYXJrZWQgYXMgcmVxdWlyZWQgJyArICgnaW4gYCcgKyBjb21wb25lbnROYW1lICsgJ2AsIGJ1dCBpdHMgdmFsdWUgaXMgYG51bGxgLicpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9wVHlwZUVycm9yKCdUaGUgJyArIGxvY2F0aW9uICsgJyBgJyArIHByb3BGdWxsTmFtZSArICdgIGlzIG1hcmtlZCBhcyByZXF1aXJlZCBpbiAnICsgKCdgJyArIGNvbXBvbmVudE5hbWUgKyAnYCwgYnV0IGl0cyB2YWx1ZSBpcyBgdW5kZWZpbmVkYC4nKSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB2YWxpZGF0ZShwcm9wcywgcHJvcE5hbWUsIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBwcm9wRnVsbE5hbWUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIGNoYWluZWRDaGVja1R5cGUgPSBjaGVja1R5cGUuYmluZChudWxsLCBmYWxzZSk7CiAgICAgIGNoYWluZWRDaGVja1R5cGUuaXNSZXF1aXJlZCA9IGNoZWNrVHlwZS5iaW5kKG51bGwsIHRydWUpOwogICAgICByZXR1cm4gY2hhaW5lZENoZWNrVHlwZTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVQcmltaXRpdmVUeXBlQ2hlY2tlcihleHBlY3RlZFR5cGUpIHsKICAgICAgZnVuY3Rpb24gdmFsaWRhdGUocHJvcHMsIHByb3BOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgcHJvcEZ1bGxOYW1lLCBzZWNyZXQpIHsKICAgICAgICB2YXIgcHJvcFZhbHVlID0gcHJvcHNbcHJvcE5hbWVdOwogICAgICAgIHZhciBwcm9wVHlwZSA9IGdldFByb3BUeXBlKHByb3BWYWx1ZSk7CgogICAgICAgIGlmIChwcm9wVHlwZSAhPT0gZXhwZWN0ZWRUeXBlKSB7CiAgICAgICAgICB2YXIgcHJlY2lzZVR5cGUgPSBnZXRQcmVjaXNlVHlwZShwcm9wVmFsdWUpOwogICAgICAgICAgcmV0dXJuIG5ldyBQcm9wVHlwZUVycm9yKCdJbnZhbGlkICcgKyBsb2NhdGlvbiArICcgYCcgKyBwcm9wRnVsbE5hbWUgKyAnYCBvZiB0eXBlICcgKyAoJ2AnICsgcHJlY2lzZVR5cGUgKyAnYCBzdXBwbGllZCB0byBgJyArIGNvbXBvbmVudE5hbWUgKyAnYCwgZXhwZWN0ZWQgJykgKyAoJ2AnICsgZXhwZWN0ZWRUeXBlICsgJ2AuJykpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiBjcmVhdGVDaGFpbmFibGVUeXBlQ2hlY2tlcih2YWxpZGF0ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlQW55VHlwZUNoZWNrZXIoKSB7CiAgICAgIHJldHVybiBjcmVhdGVDaGFpbmFibGVUeXBlQ2hlY2tlcihlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zTnVsbCk7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlQXJyYXlPZlR5cGVDaGVja2VyKHR5cGVDaGVja2VyKSB7CiAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlKHByb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIHByb3BGdWxsTmFtZSkgewogICAgICAgIGlmICh0eXBlb2YgdHlwZUNoZWNrZXIgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHJldHVybiBuZXcgUHJvcFR5cGVFcnJvcignUHJvcGVydHkgYCcgKyBwcm9wRnVsbE5hbWUgKyAnYCBvZiBjb21wb25lbnQgYCcgKyBjb21wb25lbnROYW1lICsgJ2AgaGFzIGludmFsaWQgUHJvcFR5cGUgbm90YXRpb24gaW5zaWRlIGFycmF5T2YuJyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcHJvcFZhbHVlID0gcHJvcHNbcHJvcE5hbWVdOwoKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocHJvcFZhbHVlKSkgewogICAgICAgICAgdmFyIHByb3BUeXBlID0gZ2V0UHJvcFR5cGUocHJvcFZhbHVlKTsKICAgICAgICAgIHJldHVybiBuZXcgUHJvcFR5cGVFcnJvcignSW52YWxpZCAnICsgbG9jYXRpb24gKyAnIGAnICsgcHJvcEZ1bGxOYW1lICsgJ2Agb2YgdHlwZSAnICsgKCdgJyArIHByb3BUeXBlICsgJ2Agc3VwcGxpZWQgdG8gYCcgKyBjb21wb25lbnROYW1lICsgJ2AsIGV4cGVjdGVkIGFuIGFycmF5LicpKTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcFZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgZXJyb3IgPSB0eXBlQ2hlY2tlcihwcm9wVmFsdWUsIGksIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBwcm9wRnVsbE5hbWUgKyAnWycgKyBpICsgJ10nLCBSZWFjdFByb3BUeXBlc1NlY3JldCk7CgogICAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgICAgcmV0dXJuIGVycm9yOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiBjcmVhdGVDaGFpbmFibGVUeXBlQ2hlY2tlcih2YWxpZGF0ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudFR5cGVDaGVja2VyKCkgewogICAgICBmdW5jdGlvbiB2YWxpZGF0ZShwcm9wcywgcHJvcE5hbWUsIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBwcm9wRnVsbE5hbWUpIHsKICAgICAgICB2YXIgcHJvcFZhbHVlID0gcHJvcHNbcHJvcE5hbWVdOwoKICAgICAgICBpZiAoIWlzVmFsaWRFbGVtZW50KHByb3BWYWx1ZSkpIHsKICAgICAgICAgIHZhciBwcm9wVHlwZSA9IGdldFByb3BUeXBlKHByb3BWYWx1ZSk7CiAgICAgICAgICByZXR1cm4gbmV3IFByb3BUeXBlRXJyb3IoJ0ludmFsaWQgJyArIGxvY2F0aW9uICsgJyBgJyArIHByb3BGdWxsTmFtZSArICdgIG9mIHR5cGUgJyArICgnYCcgKyBwcm9wVHlwZSArICdgIHN1cHBsaWVkIHRvIGAnICsgY29tcG9uZW50TmFtZSArICdgLCBleHBlY3RlZCBhIHNpbmdsZSBSZWFjdEVsZW1lbnQuJykpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiBjcmVhdGVDaGFpbmFibGVUeXBlQ2hlY2tlcih2YWxpZGF0ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlSW5zdGFuY2VUeXBlQ2hlY2tlcihleHBlY3RlZENsYXNzKSB7CiAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlKHByb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIHByb3BGdWxsTmFtZSkgewogICAgICAgIGlmICghKHByb3BzW3Byb3BOYW1lXSBpbnN0YW5jZW9mIGV4cGVjdGVkQ2xhc3MpKSB7CiAgICAgICAgICB2YXIgZXhwZWN0ZWRDbGFzc05hbWUgPSBleHBlY3RlZENsYXNzLm5hbWUgfHwgQU5PTllNT1VTOwogICAgICAgICAgdmFyIGFjdHVhbENsYXNzTmFtZSA9IGdldENsYXNzTmFtZShwcm9wc1twcm9wTmFtZV0pOwogICAgICAgICAgcmV0dXJuIG5ldyBQcm9wVHlwZUVycm9yKCdJbnZhbGlkICcgKyBsb2NhdGlvbiArICcgYCcgKyBwcm9wRnVsbE5hbWUgKyAnYCBvZiB0eXBlICcgKyAoJ2AnICsgYWN0dWFsQ2xhc3NOYW1lICsgJ2Agc3VwcGxpZWQgdG8gYCcgKyBjb21wb25lbnROYW1lICsgJ2AsIGV4cGVjdGVkICcpICsgKCdpbnN0YW5jZSBvZiBgJyArIGV4cGVjdGVkQ2xhc3NOYW1lICsgJ2AuJykpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiBjcmVhdGVDaGFpbmFibGVUeXBlQ2hlY2tlcih2YWxpZGF0ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlRW51bVR5cGVDaGVja2VyKGV4cGVjdGVkVmFsdWVzKSB7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShleHBlY3RlZFZhbHVlcykpIHsKICAgICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gd2FybmluZyhmYWxzZSwgJ0ludmFsaWQgYXJndW1lbnQgc3VwcGxpZWQgdG8gb25lT2YsIGV4cGVjdGVkIGFuIGluc3RhbmNlIG9mIGFycmF5LicpIDogdm9pZCAwOwogICAgICAgIHJldHVybiBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zTnVsbDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gdmFsaWRhdGUocHJvcHMsIHByb3BOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgcHJvcEZ1bGxOYW1lKSB7CiAgICAgICAgdmFyIHByb3BWYWx1ZSA9IHByb3BzW3Byb3BOYW1lXTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBleHBlY3RlZFZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGlzKHByb3BWYWx1ZSwgZXhwZWN0ZWRWYWx1ZXNbaV0pKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIHZhbHVlc1N0cmluZyA9IEpTT04uc3RyaW5naWZ5KGV4cGVjdGVkVmFsdWVzKTsKICAgICAgICByZXR1cm4gbmV3IFByb3BUeXBlRXJyb3IoJ0ludmFsaWQgJyArIGxvY2F0aW9uICsgJyBgJyArIHByb3BGdWxsTmFtZSArICdgIG9mIHZhbHVlIGAnICsgcHJvcFZhbHVlICsgJ2AgJyArICgnc3VwcGxpZWQgdG8gYCcgKyBjb21wb25lbnROYW1lICsgJ2AsIGV4cGVjdGVkIG9uZSBvZiAnICsgdmFsdWVzU3RyaW5nICsgJy4nKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBjcmVhdGVDaGFpbmFibGVUeXBlQ2hlY2tlcih2YWxpZGF0ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlT2JqZWN0T2ZUeXBlQ2hlY2tlcih0eXBlQ2hlY2tlcikgewogICAgICBmdW5jdGlvbiB2YWxpZGF0ZShwcm9wcywgcHJvcE5hbWUsIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBwcm9wRnVsbE5hbWUpIHsKICAgICAgICBpZiAodHlwZW9mIHR5cGVDaGVja2VyICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFByb3BUeXBlRXJyb3IoJ1Byb3BlcnR5IGAnICsgcHJvcEZ1bGxOYW1lICsgJ2Agb2YgY29tcG9uZW50IGAnICsgY29tcG9uZW50TmFtZSArICdgIGhhcyBpbnZhbGlkIFByb3BUeXBlIG5vdGF0aW9uIGluc2lkZSBvYmplY3RPZi4nKTsKICAgICAgICB9CgogICAgICAgIHZhciBwcm9wVmFsdWUgPSBwcm9wc1twcm9wTmFtZV07CiAgICAgICAgdmFyIHByb3BUeXBlID0gZ2V0UHJvcFR5cGUocHJvcFZhbHVlKTsKCiAgICAgICAgaWYgKHByb3BUeXBlICE9PSAnb2JqZWN0JykgewogICAgICAgICAgcmV0dXJuIG5ldyBQcm9wVHlwZUVycm9yKCdJbnZhbGlkICcgKyBsb2NhdGlvbiArICcgYCcgKyBwcm9wRnVsbE5hbWUgKyAnYCBvZiB0eXBlICcgKyAoJ2AnICsgcHJvcFR5cGUgKyAnYCBzdXBwbGllZCB0byBgJyArIGNvbXBvbmVudE5hbWUgKyAnYCwgZXhwZWN0ZWQgYW4gb2JqZWN0LicpKTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wVmFsdWUpIHsKICAgICAgICAgIGlmIChwcm9wVmFsdWUuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICB2YXIgZXJyb3IgPSB0eXBlQ2hlY2tlcihwcm9wVmFsdWUsIGtleSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIHByb3BGdWxsTmFtZSArICcuJyArIGtleSwgUmVhY3RQcm9wVHlwZXNTZWNyZXQpOwoKICAgICAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgICAgICByZXR1cm4gZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gY3JlYXRlQ2hhaW5hYmxlVHlwZUNoZWNrZXIodmFsaWRhdGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZVVuaW9uVHlwZUNoZWNrZXIoYXJyYXlPZlR5cGVDaGVja2VycykgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkoYXJyYXlPZlR5cGVDaGVja2VycykpIHsKICAgICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gd2FybmluZyhmYWxzZSwgJ0ludmFsaWQgYXJndW1lbnQgc3VwcGxpZWQgdG8gb25lT2ZUeXBlLCBleHBlY3RlZCBhbiBpbnN0YW5jZSBvZiBhcnJheS4nKSA6IHZvaWQgMDsKICAgICAgICByZXR1cm4gZW1wdHlGdW5jdGlvbi50aGF0UmV0dXJuc051bGw7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXlPZlR5cGVDaGVja2Vycy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBjaGVja2VyID0gYXJyYXlPZlR5cGVDaGVja2Vyc1tpXTsKCiAgICAgICAgaWYgKHR5cGVvZiBjaGVja2VyICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAnSW52YWxpZCBhcmd1bWVudCBzdXBwbGllZCB0byBvbmVPZlR5cGUuIEV4cGVjdGVkIGFuIGFycmF5IG9mIGNoZWNrIGZ1bmN0aW9ucywgYnV0ICcgKyAncmVjZWl2ZWQgJXMgYXQgaW5kZXggJXMuJywgZ2V0UG9zdGZpeEZvclR5cGVXYXJuaW5nKGNoZWNrZXIpLCBpKTsKICAgICAgICAgIHJldHVybiBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zTnVsbDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlKHByb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIHByb3BGdWxsTmFtZSkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXlPZlR5cGVDaGVja2Vycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGNoZWNrZXIgPSBhcnJheU9mVHlwZUNoZWNrZXJzW2ldOwoKICAgICAgICAgIGlmIChjaGVja2VyKHByb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIHByb3BGdWxsTmFtZSwgUmVhY3RQcm9wVHlwZXNTZWNyZXQpID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbmV3IFByb3BUeXBlRXJyb3IoJ0ludmFsaWQgJyArIGxvY2F0aW9uICsgJyBgJyArIHByb3BGdWxsTmFtZSArICdgIHN1cHBsaWVkIHRvICcgKyAoJ2AnICsgY29tcG9uZW50TmFtZSArICdgLicpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNyZWF0ZUNoYWluYWJsZVR5cGVDaGVja2VyKHZhbGlkYXRlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVOb2RlQ2hlY2tlcigpIHsKICAgICAgZnVuY3Rpb24gdmFsaWRhdGUocHJvcHMsIHByb3BOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgcHJvcEZ1bGxOYW1lKSB7CiAgICAgICAgaWYgKCFpc05vZGUocHJvcHNbcHJvcE5hbWVdKSkgewogICAgICAgICAgcmV0dXJuIG5ldyBQcm9wVHlwZUVycm9yKCdJbnZhbGlkICcgKyBsb2NhdGlvbiArICcgYCcgKyBwcm9wRnVsbE5hbWUgKyAnYCBzdXBwbGllZCB0byAnICsgKCdgJyArIGNvbXBvbmVudE5hbWUgKyAnYCwgZXhwZWN0ZWQgYSBSZWFjdE5vZGUuJykpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiBjcmVhdGVDaGFpbmFibGVUeXBlQ2hlY2tlcih2YWxpZGF0ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlU2hhcGVUeXBlQ2hlY2tlcihzaGFwZVR5cGVzKSB7CiAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlKHByb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIHByb3BGdWxsTmFtZSkgewogICAgICAgIHZhciBwcm9wVmFsdWUgPSBwcm9wc1twcm9wTmFtZV07CiAgICAgICAgdmFyIHByb3BUeXBlID0gZ2V0UHJvcFR5cGUocHJvcFZhbHVlKTsKCiAgICAgICAgaWYgKHByb3BUeXBlICE9PSAnb2JqZWN0JykgewogICAgICAgICAgcmV0dXJuIG5ldyBQcm9wVHlwZUVycm9yKCdJbnZhbGlkICcgKyBsb2NhdGlvbiArICcgYCcgKyBwcm9wRnVsbE5hbWUgKyAnYCBvZiB0eXBlIGAnICsgcHJvcFR5cGUgKyAnYCAnICsgKCdzdXBwbGllZCB0byBgJyArIGNvbXBvbmVudE5hbWUgKyAnYCwgZXhwZWN0ZWQgYG9iamVjdGAuJykpOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIga2V5IGluIHNoYXBlVHlwZXMpIHsKICAgICAgICAgIHZhciBjaGVja2VyID0gc2hhcGVUeXBlc1trZXldOwoKICAgICAgICAgIGlmICghY2hlY2tlcikgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZXJyb3IgPSBjaGVja2VyKHByb3BWYWx1ZSwga2V5LCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgcHJvcEZ1bGxOYW1lICsgJy4nICsga2V5LCBSZWFjdFByb3BUeXBlc1NlY3JldCk7CgogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHJldHVybiBlcnJvcjsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gY3JlYXRlQ2hhaW5hYmxlVHlwZUNoZWNrZXIodmFsaWRhdGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZVN0cmljdFNoYXBlVHlwZUNoZWNrZXIoc2hhcGVUeXBlcykgewogICAgICBmdW5jdGlvbiB2YWxpZGF0ZShwcm9wcywgcHJvcE5hbWUsIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBwcm9wRnVsbE5hbWUpIHsKICAgICAgICB2YXIgcHJvcFZhbHVlID0gcHJvcHNbcHJvcE5hbWVdOwogICAgICAgIHZhciBwcm9wVHlwZSA9IGdldFByb3BUeXBlKHByb3BWYWx1ZSk7CgogICAgICAgIGlmIChwcm9wVHlwZSAhPT0gJ29iamVjdCcpIHsKICAgICAgICAgIHJldHVybiBuZXcgUHJvcFR5cGVFcnJvcignSW52YWxpZCAnICsgbG9jYXRpb24gKyAnIGAnICsgcHJvcEZ1bGxOYW1lICsgJ2Agb2YgdHlwZSBgJyArIHByb3BUeXBlICsgJ2AgJyArICgnc3VwcGxpZWQgdG8gYCcgKyBjb21wb25lbnROYW1lICsgJ2AsIGV4cGVjdGVkIGBvYmplY3RgLicpKTsKICAgICAgICB9CgogICAgICAgIHZhciBhbGxLZXlzID0gYXNzaWduKHt9LCBwcm9wc1twcm9wTmFtZV0sIHNoYXBlVHlwZXMpOwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYWxsS2V5cykgewogICAgICAgICAgdmFyIGNoZWNrZXIgPSBzaGFwZVR5cGVzW2tleV07CgogICAgICAgICAgaWYgKCFjaGVja2VyKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvcFR5cGVFcnJvcignSW52YWxpZCAnICsgbG9jYXRpb24gKyAnIGAnICsgcHJvcEZ1bGxOYW1lICsgJ2Aga2V5IGAnICsga2V5ICsgJ2Agc3VwcGxpZWQgdG8gYCcgKyBjb21wb25lbnROYW1lICsgJ2AuJyArICdcbkJhZCBvYmplY3Q6ICcgKyBKU09OLnN0cmluZ2lmeShwcm9wc1twcm9wTmFtZV0sIG51bGwsICcgICcpICsgJ1xuVmFsaWQga2V5czogJyArIEpTT04uc3RyaW5naWZ5KE9iamVjdC5rZXlzKHNoYXBlVHlwZXMpLCBudWxsLCAnICAnKSk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGVycm9yID0gY2hlY2tlcihwcm9wVmFsdWUsIGtleSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIHByb3BGdWxsTmFtZSArICcuJyArIGtleSwgUmVhY3RQcm9wVHlwZXNTZWNyZXQpOwoKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICByZXR1cm4gZXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgcmV0dXJuIGNyZWF0ZUNoYWluYWJsZVR5cGVDaGVja2VyKHZhbGlkYXRlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc05vZGUocHJvcFZhbHVlKSB7CiAgICAgIHN3aXRjaCAodHlwZW9mIHByb3BWYWx1ZSkgewogICAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICBjYXNlICd1bmRlZmluZWQnOgogICAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgICAgcmV0dXJuICFwcm9wVmFsdWU7CgogICAgICAgIGNhc2UgJ29iamVjdCc6CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShwcm9wVmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9wVmFsdWUuZXZlcnkoaXNOb2RlKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAocHJvcFZhbHVlID09PSBudWxsIHx8IGlzVmFsaWRFbGVtZW50KHByb3BWYWx1ZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKHByb3BWYWx1ZSk7CgogICAgICAgICAgaWYgKGl0ZXJhdG9yRm4pIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKHByb3BWYWx1ZSk7CiAgICAgICAgICAgIHZhciBzdGVwOwoKICAgICAgICAgICAgaWYgKGl0ZXJhdG9yRm4gIT09IHByb3BWYWx1ZS5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc05vZGUoc3RlcC52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3aGlsZSAoIShzdGVwID0gaXRlcmF0b3IubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICAgICAgICB2YXIgZW50cnkgPSBzdGVwLnZhbHVlOwoKICAgICAgICAgICAgICAgIGlmIChlbnRyeSkgewogICAgICAgICAgICAgICAgICBpZiAoIWlzTm9kZShlbnRyeVsxXSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGlzU3ltYm9sKHByb3BUeXBlLCBwcm9wVmFsdWUpIHsKICAgICAgaWYgKHByb3BUeXBlID09PSAnc3ltYm9sJykgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBpZiAocHJvcFZhbHVlWydAQHRvU3RyaW5nVGFnJ10gPT09ICdTeW1ib2wnKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgU3ltYm9sID09PSAnZnVuY3Rpb24nICYmIHByb3BWYWx1ZSBpbnN0YW5jZW9mIFN5bWJvbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0UHJvcFR5cGUocHJvcFZhbHVlKSB7CiAgICAgIHZhciBwcm9wVHlwZSA9IHR5cGVvZiBwcm9wVmFsdWU7CgogICAgICBpZiAoQXJyYXkuaXNBcnJheShwcm9wVmFsdWUpKSB7CiAgICAgICAgcmV0dXJuICdhcnJheSc7CiAgICAgIH0KCiAgICAgIGlmIChwcm9wVmFsdWUgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICByZXR1cm4gJ29iamVjdCc7CiAgICAgIH0KCiAgICAgIGlmIChpc1N5bWJvbChwcm9wVHlwZSwgcHJvcFZhbHVlKSkgewogICAgICAgIHJldHVybiAnc3ltYm9sJzsKICAgICAgfQoKICAgICAgcmV0dXJuIHByb3BUeXBlOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFByZWNpc2VUeXBlKHByb3BWYWx1ZSkgewogICAgICBpZiAodHlwZW9mIHByb3BWYWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgcHJvcFZhbHVlID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuICcnICsgcHJvcFZhbHVlOwogICAgICB9CgogICAgICB2YXIgcHJvcFR5cGUgPSBnZXRQcm9wVHlwZShwcm9wVmFsdWUpOwoKICAgICAgaWYgKHByb3BUeXBlID09PSAnb2JqZWN0JykgewogICAgICAgIGlmIChwcm9wVmFsdWUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgICByZXR1cm4gJ2RhdGUnOwogICAgICAgIH0gZWxzZSBpZiAocHJvcFZhbHVlIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICByZXR1cm4gJ3JlZ2V4cCc7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gcHJvcFR5cGU7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0UG9zdGZpeEZvclR5cGVXYXJuaW5nKHZhbHVlKSB7CiAgICAgIHZhciB0eXBlID0gZ2V0UHJlY2lzZVR5cGUodmFsdWUpOwoKICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgY2FzZSAnYXJyYXknOgogICAgICAgIGNhc2UgJ29iamVjdCc6CiAgICAgICAgICByZXR1cm4gJ2FuICcgKyB0eXBlOwoKICAgICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICBjYXNlICdkYXRlJzoKICAgICAgICBjYXNlICdyZWdleHAnOgogICAgICAgICAgcmV0dXJuICdhICcgKyB0eXBlOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDbGFzc05hbWUocHJvcFZhbHVlKSB7CiAgICAgIGlmICghcHJvcFZhbHVlLmNvbnN0cnVjdG9yIHx8ICFwcm9wVmFsdWUuY29uc3RydWN0b3IubmFtZSkgewogICAgICAgIHJldHVybiBBTk9OWU1PVVM7CiAgICAgIH0KCiAgICAgIHJldHVybiBwcm9wVmFsdWUuY29uc3RydWN0b3IubmFtZTsKICAgIH0KCiAgICBSZWFjdFByb3BUeXBlcy5jaGVja1Byb3BUeXBlcyA9IGNoZWNrUHJvcFR5cGVzOwogICAgUmVhY3RQcm9wVHlwZXMuUHJvcFR5cGVzID0gUmVhY3RQcm9wVHlwZXM7CiAgICByZXR1cm4gUmVhY3RQcm9wVHlwZXM7CiAgfTsKfSwxMjgsWzU3LDEzLDU2LDExMCwxMTQsMTEzXSwicHJvcC10eXBlcy9mYWN0b3J5V2l0aFR5cGVDaGVja2Vycy5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGVtcHR5RnVuY3Rpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiZmJqcy9saWIvZW1wdHlGdW5jdGlvbiIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgUmVhY3RQcm9wVHlwZXNTZWNyZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAnLi9saWIvUmVhY3RQcm9wVHlwZXNTZWNyZXQnKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBzaGltKHByb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIHByb3BGdWxsTmFtZSwgc2VjcmV0KSB7CiAgICAgIGlmIChzZWNyZXQgPT09IFJlYWN0UHJvcFR5cGVzU2VjcmV0KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpbnZhcmlhbnQoZmFsc2UsICdDYWxsaW5nIFByb3BUeXBlcyB2YWxpZGF0b3JzIGRpcmVjdGx5IGlzIG5vdCBzdXBwb3J0ZWQgYnkgdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLiAnICsgJ1VzZSBQcm9wVHlwZXMuY2hlY2tQcm9wVHlwZXMoKSB0byBjYWxsIHRoZW0uICcgKyAnUmVhZCBtb3JlIGF0IGh0dHA6Ly9mYi5tZS91c2UtY2hlY2stcHJvcC10eXBlcycpOwogICAgfQoKICAgIDsKICAgIHNoaW0uaXNSZXF1aXJlZCA9IHNoaW07CgogICAgZnVuY3Rpb24gZ2V0U2hpbSgpIHsKICAgICAgcmV0dXJuIHNoaW07CiAgICB9CgogICAgOwogICAgdmFyIFJlYWN0UHJvcFR5cGVzID0gewogICAgICBhcnJheTogc2hpbSwKICAgICAgYm9vbDogc2hpbSwKICAgICAgZnVuYzogc2hpbSwKICAgICAgbnVtYmVyOiBzaGltLAogICAgICBvYmplY3Q6IHNoaW0sCiAgICAgIHN0cmluZzogc2hpbSwKICAgICAgc3ltYm9sOiBzaGltLAogICAgICBhbnk6IHNoaW0sCiAgICAgIGFycmF5T2Y6IGdldFNoaW0sCiAgICAgIGVsZW1lbnQ6IHNoaW0sCiAgICAgIGluc3RhbmNlT2Y6IGdldFNoaW0sCiAgICAgIG5vZGU6IHNoaW0sCiAgICAgIG9iamVjdE9mOiBnZXRTaGltLAogICAgICBvbmVPZjogZ2V0U2hpbSwKICAgICAgb25lT2ZUeXBlOiBnZXRTaGltLAogICAgICBzaGFwZTogZ2V0U2hpbSwKICAgICAgZXhhY3Q6IGdldFNoaW0KICAgIH07CiAgICBSZWFjdFByb3BUeXBlcy5jaGVja1Byb3BUeXBlcyA9IGVtcHR5RnVuY3Rpb247CiAgICBSZWFjdFByb3BUeXBlcy5Qcm9wVHlwZXMgPSBSZWFjdFByb3BUeXBlczsKICAgIHJldHVybiBSZWFjdFByb3BUeXBlczsKICB9Owp9LDEyOSxbNTcsMTMsMTE0XSwicHJvcC10eXBlcy9mYWN0b3J5V2l0aFRocm93aW5nU2hpbXMuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgInJlYWN0Iik7Cn0sMTMwLFsxMDhdLCJSZWFjdCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEVkZ2VJbnNldHNQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJFZGdlSW5zZXRzUHJvcFR5cGUiKTsKCiAgdmFyIFBsYXRmb3JtVmlld1Byb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJQbGF0Zm9ybVZpZXdQcm9wVHlwZXMiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJwcm9wLXR5cGVzIik7CgogIHZhciBTdHlsZVNoZWV0UHJvcFR5cGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiU3R5bGVTaGVldFByb3BUeXBlIik7CgogIHZhciBWaWV3U3R5bGVQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiVmlld1N0eWxlUHJvcFR5cGVzIik7CgogIHZhciBfcmVxdWlyZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJWaWV3QWNjZXNzaWJpbGl0eSIpLAogICAgICBBY2Nlc3NpYmlsaXR5Q29tcG9uZW50VHlwZXMgPSBfcmVxdWlyZS5BY2Nlc3NpYmlsaXR5Q29tcG9uZW50VHlwZXMsCiAgICAgIEFjY2Vzc2liaWxpdHlUcmFpdHMgPSBfcmVxdWlyZS5BY2Nlc3NpYmlsaXR5VHJhaXRzOwoKICB2YXIgc3R5bGVQcm9wVHlwZSA9IFN0eWxlU2hlZXRQcm9wVHlwZShWaWV3U3R5bGVQcm9wVHlwZXMpOwogIG1vZHVsZS5leHBvcnRzID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIFBsYXRmb3JtVmlld1Byb3BUeXBlcywgewogICAgYWNjZXNzaWJsZTogUHJvcFR5cGVzLmJvb2wsCiAgICBhY2Nlc3NpYmlsaXR5TGFiZWw6IFByb3BUeXBlcy5ub2RlLAogICAgYWNjZXNzaWJpbGl0eUFjdGlvbnM6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5zdHJpbmcpLAogICAgYWNjZXNzaWJpbGl0eUNvbXBvbmVudFR5cGU6IFByb3BUeXBlcy5vbmVPZihBY2Nlc3NpYmlsaXR5Q29tcG9uZW50VHlwZXMpLAogICAgYWNjZXNzaWJpbGl0eUxpdmVSZWdpb246IFByb3BUeXBlcy5vbmVPZihbJ25vbmUnLCAncG9saXRlJywgJ2Fzc2VydGl2ZSddKSwKICAgIGltcG9ydGFudEZvckFjY2Vzc2liaWxpdHk6IFByb3BUeXBlcy5vbmVPZihbJ2F1dG8nLCAneWVzJywgJ25vJywgJ25vLWhpZGUtZGVzY2VuZGFudHMnXSksCiAgICBhY2Nlc3NpYmlsaXR5VHJhaXRzOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMub25lT2YoQWNjZXNzaWJpbGl0eVRyYWl0cyksIFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5vbmVPZihBY2Nlc3NpYmlsaXR5VHJhaXRzKSldKSwKICAgIGFjY2Vzc2liaWxpdHlWaWV3SXNNb2RhbDogUHJvcFR5cGVzLmJvb2wsCiAgICBvbkFjY2Vzc2liaWxpdHlBY3Rpb246IFByb3BUeXBlcy5mdW5jLAogICAgb25BY2Nlc3NpYmlsaXR5VGFwOiBQcm9wVHlwZXMuZnVuYywKICAgIG9uTWFnaWNUYXA6IFByb3BUeXBlcy5mdW5jLAogICAgdGVzdElEOiBQcm9wVHlwZXMuc3RyaW5nLAogICAgbmF0aXZlSUQ6IFByb3BUeXBlcy5zdHJpbmcsCiAgICBvblJlc3BvbmRlckdyYW50OiBQcm9wVHlwZXMuZnVuYywKICAgIG9uUmVzcG9uZGVyTW92ZTogUHJvcFR5cGVzLmZ1bmMsCiAgICBvblJlc3BvbmRlclJlamVjdDogUHJvcFR5cGVzLmZ1bmMsCiAgICBvblJlc3BvbmRlclJlbGVhc2U6IFByb3BUeXBlcy5mdW5jLAogICAgb25SZXNwb25kZXJUZXJtaW5hdGU6IFByb3BUeXBlcy5mdW5jLAogICAgb25SZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3Q6IFByb3BUeXBlcy5mdW5jLAogICAgb25TdGFydFNob3VsZFNldFJlc3BvbmRlcjogUHJvcFR5cGVzLmZ1bmMsCiAgICBvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyQ2FwdHVyZTogUHJvcFR5cGVzLmZ1bmMsCiAgICBvbk1vdmVTaG91bGRTZXRSZXNwb25kZXI6IFByb3BUeXBlcy5mdW5jLAogICAgb25Nb3ZlU2hvdWxkU2V0UmVzcG9uZGVyQ2FwdHVyZTogUHJvcFR5cGVzLmZ1bmMsCiAgICBoaXRTbG9wOiBFZGdlSW5zZXRzUHJvcFR5cGUsCiAgICBvbkxheW91dDogUHJvcFR5cGVzLmZ1bmMsCiAgICBwb2ludGVyRXZlbnRzOiBQcm9wVHlwZXMub25lT2YoWydib3gtbm9uZScsICdub25lJywgJ2JveC1vbmx5JywgJ2F1dG8nXSksCiAgICBzdHlsZTogc3R5bGVQcm9wVHlwZSwKICAgIHJlbW92ZUNsaXBwZWRTdWJ2aWV3czogUHJvcFR5cGVzLmJvb2wsCiAgICByZW5kZXJUb0hhcmR3YXJlVGV4dHVyZUFuZHJvaWQ6IFByb3BUeXBlcy5ib29sLAogICAgc2hvdWxkUmFzdGVyaXplSU9TOiBQcm9wVHlwZXMuYm9vbCwKICAgIGNvbGxhcHNhYmxlOiBQcm9wVHlwZXMuYm9vbCwKICAgIG5lZWRzT2Zmc2NyZWVuQWxwaGFDb21wb3NpdGluZzogUHJvcFR5cGVzLmJvb2wKICB9KTsKfSwxMzEsWzEzMiwxMzcsMTI3LDEzOCwxMzksMTQ0XSwiVmlld1Byb3BUeXBlcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJwcm9wLXR5cGVzIik7CgogIHZhciBjcmVhdGVTdHJpY3RTaGFwZVR5cGVDaGVja2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImNyZWF0ZVN0cmljdFNoYXBlVHlwZUNoZWNrZXIiKTsKCiAgdmFyIEVkZ2VJbnNldHNQcm9wVHlwZSA9IGNyZWF0ZVN0cmljdFNoYXBlVHlwZUNoZWNrZXIoewogICAgdG9wOiBQcm9wVHlwZXMubnVtYmVyLAogICAgbGVmdDogUHJvcFR5cGVzLm51bWJlciwKICAgIGJvdHRvbTogUHJvcFR5cGVzLm51bWJlciwKICAgIHJpZ2h0OiBQcm9wVHlwZXMubnVtYmVyCiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBFZGdlSW5zZXRzUHJvcFR5cGU7Cn0sMTMyLFsxMjcsMTMzXSwiRWRnZUluc2V0c1Byb3BUeXBlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgbWVyZ2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAibWVyZ2UiKTsKCiAgZnVuY3Rpb24gY3JlYXRlU3RyaWN0U2hhcGVUeXBlQ2hlY2tlcihzaGFwZVR5cGVzKSB7CiAgICBmdW5jdGlvbiBjaGVja1R5cGUoaXNSZXF1aXJlZCwgcHJvcHMsIHByb3BOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbikgewogICAgICBpZiAoIXByb3BzW3Byb3BOYW1lXSkgewogICAgICAgIGlmIChpc1JlcXVpcmVkKSB7CiAgICAgICAgICBpbnZhcmlhbnQoZmFsc2UsICJSZXF1aXJlZCBvYmplY3QgYCIgKyBwcm9wTmFtZSArICJgIHdhcyBub3Qgc3BlY2lmaWVkIGluICIgKyAoImAiICsgY29tcG9uZW50TmFtZSArICJgLiIpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHByb3BWYWx1ZSA9IHByb3BzW3Byb3BOYW1lXTsKICAgICAgdmFyIHByb3BUeXBlID0gdHlwZW9mIHByb3BWYWx1ZTsKICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IGxvY2F0aW9uIHx8ICcodW5rbm93biknOwoKICAgICAgaWYgKHByb3BUeXBlICE9PSAnb2JqZWN0JykgewogICAgICAgIGludmFyaWFudChmYWxzZSwgIkludmFsaWQgIiArIGxvY2F0aW9uTmFtZSArICIgYCIgKyBwcm9wTmFtZSArICJgIG9mIHR5cGUgYCIgKyBwcm9wVHlwZSArICJgICIgKyAoInN1cHBsaWVkIHRvIGAiICsgY29tcG9uZW50TmFtZSArICJgLCBleHBlY3RlZCBgb2JqZWN0YC4iKSk7CiAgICAgIH0KCiAgICAgIHZhciBhbGxLZXlzID0gbWVyZ2UocHJvcHNbcHJvcE5hbWVdLCBzaGFwZVR5cGVzKTsKCiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCByZXN0ID0gQXJyYXkoX2xlbiA+IDUgPyBfbGVuIC0gNSA6IDApLCBfa2V5ID0gNTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIHJlc3RbX2tleSAtIDVdID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICBmb3IgKHZhciBrZXkgaW4gYWxsS2V5cykgewogICAgICAgIHZhciBjaGVja2VyID0gc2hhcGVUeXBlc1trZXldOwoKICAgICAgICBpZiAoIWNoZWNrZXIpIHsKICAgICAgICAgIGludmFyaWFudChmYWxzZSwgIkludmFsaWQgcHJvcHMuIiArIHByb3BOYW1lICsgIiBrZXkgYCIgKyBrZXkgKyAiYCBzdXBwbGllZCB0byBgIiArIGNvbXBvbmVudE5hbWUgKyAiYC4iICsgJ1xuQmFkIG9iamVjdDogJyArIEpTT04uc3RyaW5naWZ5KHByb3BzW3Byb3BOYW1lXSwgbnVsbCwgJyAgJykgKyAnXG5WYWxpZCBrZXlzOiAnICsgSlNPTi5zdHJpbmdpZnkoT2JqZWN0LmtleXMoc2hhcGVUeXBlcyksIG51bGwsICcgICcpKTsKICAgICAgICB9CgogICAgICAgIHZhciBlcnJvciA9IGNoZWNrZXIuYXBwbHkodW5kZWZpbmVkLCBbcHJvcFZhbHVlLCBrZXksIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uXS5jb25jYXQocmVzdCkpOwoKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIGludmFyaWFudChmYWxzZSwgZXJyb3IubWVzc2FnZSArICdcbkJhZCBvYmplY3Q6ICcgKyBKU09OLnN0cmluZ2lmeShwcm9wc1twcm9wTmFtZV0sIG51bGwsICcgICcpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjaGFpbmVkQ2hlY2tUeXBlKHByb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24pIHsKICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCByZXN0ID0gQXJyYXkoX2xlbjIgPiA0ID8gX2xlbjIgLSA0IDogMCksIF9rZXkyID0gNDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgIHJlc3RbX2tleTIgLSA0XSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgIH0KCiAgICAgIHJldHVybiBjaGVja1R5cGUuYXBwbHkodW5kZWZpbmVkLCBbZmFsc2UsIHByb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb25dLmNvbmNhdChyZXN0KSk7CiAgICB9CgogICAgY2hhaW5lZENoZWNrVHlwZS5pc1JlcXVpcmVkID0gY2hlY2tUeXBlLmJpbmQobnVsbCwgdHJ1ZSk7CiAgICByZXR1cm4gY2hhaW5lZENoZWNrVHlwZTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gY3JlYXRlU3RyaWN0U2hhcGVUeXBlQ2hlY2tlcjsKfSwxMzMsWzEzLDEzNF0sImNyZWF0ZVN0cmljdFNoYXBlVHlwZUNoZWNrZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAidXNlIHN0cmljdCI7CgogIHZhciBtZXJnZUludG8gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAibWVyZ2VJbnRvIik7CgogIHZhciBtZXJnZSA9IGZ1bmN0aW9uIG1lcmdlKG9uZSwgdHdvKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBtZXJnZUludG8ocmVzdWx0LCBvbmUpOwogICAgbWVyZ2VJbnRvKHJlc3VsdCwgdHdvKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBtZXJnZTsKfSwxMzQsWzEzNV0sIm1lcmdlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgInVzZSBzdHJpY3QiOwoKICB2YXIgbWVyZ2VIZWxwZXJzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIm1lcmdlSGVscGVycyIpOwoKICB2YXIgY2hlY2tNZXJnZU9iamVjdEFyZyA9IG1lcmdlSGVscGVycy5jaGVja01lcmdlT2JqZWN0QXJnOwogIHZhciBjaGVja01lcmdlSW50b09iamVjdEFyZyA9IG1lcmdlSGVscGVycy5jaGVja01lcmdlSW50b09iamVjdEFyZzsKCiAgZnVuY3Rpb24gbWVyZ2VJbnRvKG9uZSwgdHdvKSB7CiAgICBjaGVja01lcmdlSW50b09iamVjdEFyZyhvbmUpOwoKICAgIGlmICh0d28gIT0gbnVsbCkgewogICAgICBjaGVja01lcmdlT2JqZWN0QXJnKHR3byk7CgogICAgICBmb3IgKHZhciBrZXkgaW4gdHdvKSB7CiAgICAgICAgaWYgKCF0d28uaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBvbmVba2V5XSA9IHR3b1trZXldOwogICAgICB9CiAgICB9CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IG1lcmdlSW50bzsKfSwxMzUsWzEzNl0sIm1lcmdlSW50byIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIE1BWF9NRVJHRV9ERVBUSCA9IDM2OwoKICB2YXIgaXNUZXJtaW5hbCA9IGZ1bmN0aW9uIGlzVGVybWluYWwobykgewogICAgcmV0dXJuIHR5cGVvZiBvICE9PSAnb2JqZWN0JyB8fCBvIGluc3RhbmNlb2YgRGF0ZSB8fCBvID09PSBudWxsOwogIH07CgogIHZhciBtZXJnZUhlbHBlcnMgPSB7CiAgICBNQVhfTUVSR0VfREVQVEg6IE1BWF9NRVJHRV9ERVBUSCwKICAgIGlzVGVybWluYWw6IGlzVGVybWluYWwsCiAgICBub3JtYWxpemVNZXJnZUFyZzogZnVuY3Rpb24gbm9ybWFsaXplTWVyZ2VBcmcoYXJnKSB7CiAgICAgIHJldHVybiBhcmcgPT09IHVuZGVmaW5lZCB8fCBhcmcgPT09IG51bGwgPyB7fSA6IGFyZzsKICAgIH0sCiAgICBjaGVja01lcmdlQXJyYXlBcmdzOiBmdW5jdGlvbiBjaGVja01lcmdlQXJyYXlBcmdzKG9uZSwgdHdvKSB7CiAgICAgIGludmFyaWFudChBcnJheS5pc0FycmF5KG9uZSkgJiYgQXJyYXkuaXNBcnJheSh0d28pLCAnVHJpZWQgdG8gbWVyZ2UgYXJyYXlzLCBpbnN0ZWFkIGdvdCAlcyBhbmQgJXMuJywgb25lLCB0d28pOwogICAgfSwKICAgIGNoZWNrTWVyZ2VPYmplY3RBcmdzOiBmdW5jdGlvbiBjaGVja01lcmdlT2JqZWN0QXJncyhvbmUsIHR3bykgewogICAgICBtZXJnZUhlbHBlcnMuY2hlY2tNZXJnZU9iamVjdEFyZyhvbmUpOwogICAgICBtZXJnZUhlbHBlcnMuY2hlY2tNZXJnZU9iamVjdEFyZyh0d28pOwogICAgfSwKICAgIGNoZWNrTWVyZ2VPYmplY3RBcmc6IGZ1bmN0aW9uIGNoZWNrTWVyZ2VPYmplY3RBcmcoYXJnKSB7CiAgICAgIGludmFyaWFudCghaXNUZXJtaW5hbChhcmcpICYmICFBcnJheS5pc0FycmF5KGFyZyksICdUcmllZCB0byBtZXJnZSBhbiBvYmplY3QsIGluc3RlYWQgZ290ICVzLicsIGFyZyk7CiAgICB9LAogICAgY2hlY2tNZXJnZUludG9PYmplY3RBcmc6IGZ1bmN0aW9uIGNoZWNrTWVyZ2VJbnRvT2JqZWN0QXJnKGFyZykgewogICAgICBpbnZhcmlhbnQoKCFpc1Rlcm1pbmFsKGFyZykgfHwgdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJykgJiYgIUFycmF5LmlzQXJyYXkoYXJnKSwgJ1RyaWVkIHRvIG1lcmdlIGludG8gYW4gb2JqZWN0LCBpbnN0ZWFkIGdvdCAlcy4nLCBhcmcpOwogICAgfSwKICAgIGNoZWNrTWVyZ2VMZXZlbDogZnVuY3Rpb24gY2hlY2tNZXJnZUxldmVsKGxldmVsKSB7CiAgICAgIGludmFyaWFudChsZXZlbCA8IE1BWF9NRVJHRV9ERVBUSCwgJ01heGltdW0gZGVlcCBtZXJnZSBkZXB0aCBleGNlZWRlZC4gWW91IG1heSBiZSBhdHRlbXB0aW5nIHRvIG1lcmdlICcgKyAnY2lyY3VsYXIgc3RydWN0dXJlcyBpbiBhbiB1bnN1cHBvcnRlZCB3YXkuJyk7CiAgICB9LAogICAgY2hlY2tBcnJheVN0cmF0ZWd5OiBmdW5jdGlvbiBjaGVja0FycmF5U3RyYXRlZ3koc3RyYXRlZ3kpIHsKICAgICAgaW52YXJpYW50KHN0cmF0ZWd5ID09PSB1bmRlZmluZWQgfHwgc3RyYXRlZ3kgaW4gbWVyZ2VIZWxwZXJzLkFycmF5U3RyYXRlZ2llcywgJ1lvdSBtdXN0IHByb3ZpZGUgYW4gYXJyYXkgc3RyYXRlZ3kgdG8gZGVlcCBtZXJnZSBmdW5jdGlvbnMgdG8gJyArICdpbnN0cnVjdCB0aGUgZGVlcCBtZXJnZSBob3cgdG8gcmVzb2x2ZSBtZXJnaW5nIHR3byBhcnJheXMuJyk7CiAgICB9LAogICAgQXJyYXlTdHJhdGVnaWVzOiB7CiAgICAgIENsb2JiZXI6ICdDbG9iYmVyJywKICAgICAgQ29uY2F0OiAnQ29uY2F0JywKICAgICAgSW5kZXhCeUluZGV4OiAnSW5kZXhCeUluZGV4JwogICAgfQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBtZXJnZUhlbHBlcnM7Cn0sMTM2LFsxM10sIm1lcmdlSGVscGVycyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogIG1vZHVsZS5leHBvcnQgPSB7fTsKfSwxMzcsW10sIlBsYXRmb3JtVmlld1Byb3BUeXBlcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGNyZWF0ZVN0cmljdFNoYXBlVHlwZUNoZWNrZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiY3JlYXRlU3RyaWN0U2hhcGVUeXBlQ2hlY2tlciIpOwoKICB2YXIgZmxhdHRlblN0eWxlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImZsYXR0ZW5TdHlsZSIpOwoKICBmdW5jdGlvbiBTdHlsZVNoZWV0UHJvcFR5cGUoc2hhcGUpIHsKICAgIHZhciBzaGFwZVByb3BUeXBlID0gY3JlYXRlU3RyaWN0U2hhcGVUeXBlQ2hlY2tlcihzaGFwZSk7CiAgICByZXR1cm4gZnVuY3Rpb24gKHByb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24pIHsKICAgICAgdmFyIG5ld1Byb3BzID0gcHJvcHM7CgogICAgICBpZiAocHJvcHNbcHJvcE5hbWVdKSB7CiAgICAgICAgbmV3UHJvcHMgPSB7fTsKICAgICAgICBuZXdQcm9wc1twcm9wTmFtZV0gPSBmbGF0dGVuU3R5bGUocHJvcHNbcHJvcE5hbWVdKTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIHJlc3QgPSBBcnJheShfbGVuID4gNCA/IF9sZW4gLSA0IDogMCksIF9rZXkgPSA0OyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgcmVzdFtfa2V5IC0gNF0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiBzaGFwZVByb3BUeXBlLmFwcGx5KHVuZGVmaW5lZCwgW25ld1Byb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb25dLmNvbmNhdChyZXN0KSk7CiAgICB9OwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBTdHlsZVNoZWV0UHJvcFR5cGU7Cn0sMTM4LFsxMzMsMTAxXSwiU3R5bGVTaGVldFByb3BUeXBlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBMYXlvdXRQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiTGF5b3V0UHJvcFR5cGVzIik7CgogIHZhciBSZWFjdFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJwcm9wLXR5cGVzIik7CgogIHZhciBTaGFkb3dQcm9wVHlwZXNJT1MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiU2hhZG93UHJvcFR5cGVzSU9TIik7CgogIHZhciBUcmFuc2Zvcm1Qcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiVHJhbnNmb3JtUHJvcFR5cGVzIik7CgogIHZhciBWaWV3U3R5bGVQcm9wVHlwZXMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgTGF5b3V0UHJvcFR5cGVzLCBTaGFkb3dQcm9wVHlwZXNJT1MsIFRyYW5zZm9ybVByb3BUeXBlcywgewogICAgYmFja2ZhY2VWaXNpYmlsaXR5OiBSZWFjdFByb3BUeXBlcy5vbmVPZihbJ3Zpc2libGUnLCAnaGlkZGVuJ10pLAogICAgYmFja2dyb3VuZENvbG9yOiBDb2xvclByb3BUeXBlLAogICAgYm9yZGVyQ29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICBib3JkZXJUb3BDb2xvcjogQ29sb3JQcm9wVHlwZSwKICAgIGJvcmRlclJpZ2h0Q29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICBib3JkZXJCb3R0b21Db2xvcjogQ29sb3JQcm9wVHlwZSwKICAgIGJvcmRlckxlZnRDb2xvcjogQ29sb3JQcm9wVHlwZSwKICAgIGJvcmRlclN0YXJ0Q29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICBib3JkZXJFbmRDb2xvcjogQ29sb3JQcm9wVHlwZSwKICAgIGJvcmRlclJhZGl1czogUmVhY3RQcm9wVHlwZXMubnVtYmVyLAogICAgYm9yZGVyVG9wTGVmdFJhZGl1czogUmVhY3RQcm9wVHlwZXMubnVtYmVyLAogICAgYm9yZGVyVG9wUmlnaHRSYWRpdXM6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGJvcmRlclRvcFN0YXJ0UmFkaXVzOiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICBib3JkZXJUb3BFbmRSYWRpdXM6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGJvcmRlckJvdHRvbUxlZnRSYWRpdXM6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGJvcmRlckJvdHRvbVJpZ2h0UmFkaXVzOiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICBib3JkZXJCb3R0b21TdGFydFJhZGl1czogUmVhY3RQcm9wVHlwZXMubnVtYmVyLAogICAgYm9yZGVyQm90dG9tRW5kUmFkaXVzOiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICBib3JkZXJTdHlsZTogUmVhY3RQcm9wVHlwZXMub25lT2YoWydzb2xpZCcsICdkb3R0ZWQnLCAnZGFzaGVkJ10pLAogICAgYm9yZGVyV2lkdGg6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGJvcmRlclRvcFdpZHRoOiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICBib3JkZXJSaWdodFdpZHRoOiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICBib3JkZXJCb3R0b21XaWR0aDogUmVhY3RQcm9wVHlwZXMubnVtYmVyLAogICAgYm9yZGVyTGVmdFdpZHRoOiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICBvcGFjaXR5OiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICBlbGV2YXRpb246IFJlYWN0UHJvcFR5cGVzLm51bWJlcgogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gVmlld1N0eWxlUHJvcFR5cGVzOwp9LDEzOSxbMTIzLDE0MCwxMjcsMTQxLDE0Ml0sIlZpZXdTdHlsZVByb3BUeXBlcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFJlYWN0UHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgInByb3AtdHlwZXMiKTsKCiAgdmFyIExheW91dFByb3BUeXBlcyA9IHsKICAgIGRpc3BsYXk6IFJlYWN0UHJvcFR5cGVzLm9uZU9mKFsnbm9uZScsICdmbGV4J10pLAogICAgd2lkdGg6IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIGhlaWdodDogUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5udW1iZXIsIFJlYWN0UHJvcFR5cGVzLnN0cmluZ10pLAogICAgc3RhcnQ6IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIGVuZDogUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5udW1iZXIsIFJlYWN0UHJvcFR5cGVzLnN0cmluZ10pLAogICAgdG9wOiBSZWFjdFByb3BUeXBlcy5vbmVPZlR5cGUoW1JlYWN0UHJvcFR5cGVzLm51bWJlciwgUmVhY3RQcm9wVHlwZXMuc3RyaW5nXSksCiAgICBsZWZ0OiBSZWFjdFByb3BUeXBlcy5vbmVPZlR5cGUoW1JlYWN0UHJvcFR5cGVzLm51bWJlciwgUmVhY3RQcm9wVHlwZXMuc3RyaW5nXSksCiAgICByaWdodDogUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5udW1iZXIsIFJlYWN0UHJvcFR5cGVzLnN0cmluZ10pLAogICAgYm90dG9tOiBSZWFjdFByb3BUeXBlcy5vbmVPZlR5cGUoW1JlYWN0UHJvcFR5cGVzLm51bWJlciwgUmVhY3RQcm9wVHlwZXMuc3RyaW5nXSksCiAgICBtaW5XaWR0aDogUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5udW1iZXIsIFJlYWN0UHJvcFR5cGVzLnN0cmluZ10pLAogICAgbWF4V2lkdGg6IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIG1pbkhlaWdodDogUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5udW1iZXIsIFJlYWN0UHJvcFR5cGVzLnN0cmluZ10pLAogICAgbWF4SGVpZ2h0OiBSZWFjdFByb3BUeXBlcy5vbmVPZlR5cGUoW1JlYWN0UHJvcFR5cGVzLm51bWJlciwgUmVhY3RQcm9wVHlwZXMuc3RyaW5nXSksCiAgICBtYXJnaW46IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIG1hcmdpblZlcnRpY2FsOiBSZWFjdFByb3BUeXBlcy5vbmVPZlR5cGUoW1JlYWN0UHJvcFR5cGVzLm51bWJlciwgUmVhY3RQcm9wVHlwZXMuc3RyaW5nXSksCiAgICBtYXJnaW5Ib3Jpem9udGFsOiBSZWFjdFByb3BUeXBlcy5vbmVPZlR5cGUoW1JlYWN0UHJvcFR5cGVzLm51bWJlciwgUmVhY3RQcm9wVHlwZXMuc3RyaW5nXSksCiAgICBtYXJnaW5Ub3A6IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIG1hcmdpbkJvdHRvbTogUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5udW1iZXIsIFJlYWN0UHJvcFR5cGVzLnN0cmluZ10pLAogICAgbWFyZ2luTGVmdDogUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5udW1iZXIsIFJlYWN0UHJvcFR5cGVzLnN0cmluZ10pLAogICAgbWFyZ2luUmlnaHQ6IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIG1hcmdpblN0YXJ0OiBSZWFjdFByb3BUeXBlcy5vbmVPZlR5cGUoW1JlYWN0UHJvcFR5cGVzLm51bWJlciwgUmVhY3RQcm9wVHlwZXMuc3RyaW5nXSksCiAgICBtYXJnaW5FbmQ6IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIHBhZGRpbmc6IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIHBhZGRpbmdWZXJ0aWNhbDogUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5udW1iZXIsIFJlYWN0UHJvcFR5cGVzLnN0cmluZ10pLAogICAgcGFkZGluZ0hvcml6b250YWw6IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIHBhZGRpbmdUb3A6IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIHBhZGRpbmdCb3R0b206IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIHBhZGRpbmdMZWZ0OiBSZWFjdFByb3BUeXBlcy5vbmVPZlR5cGUoW1JlYWN0UHJvcFR5cGVzLm51bWJlciwgUmVhY3RQcm9wVHlwZXMuc3RyaW5nXSksCiAgICBwYWRkaW5nUmlnaHQ6IFJlYWN0UHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3RQcm9wVHlwZXMubnVtYmVyLCBSZWFjdFByb3BUeXBlcy5zdHJpbmddKSwKICAgIHBhZGRpbmdTdGFydDogUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5udW1iZXIsIFJlYWN0UHJvcFR5cGVzLnN0cmluZ10pLAogICAgcGFkZGluZ0VuZDogUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5udW1iZXIsIFJlYWN0UHJvcFR5cGVzLnN0cmluZ10pLAogICAgYm9yZGVyV2lkdGg6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGJvcmRlclRvcFdpZHRoOiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICBib3JkZXJTdGFydFdpZHRoOiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICBib3JkZXJFbmRXaWR0aDogUmVhY3RQcm9wVHlwZXMubnVtYmVyLAogICAgYm9yZGVyUmlnaHRXaWR0aDogUmVhY3RQcm9wVHlwZXMubnVtYmVyLAogICAgYm9yZGVyQm90dG9tV2lkdGg6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGJvcmRlckxlZnRXaWR0aDogUmVhY3RQcm9wVHlwZXMubnVtYmVyLAogICAgcG9zaXRpb246IFJlYWN0UHJvcFR5cGVzLm9uZU9mKFsnYWJzb2x1dGUnLCAncmVsYXRpdmUnXSksCiAgICBmbGV4RGlyZWN0aW9uOiBSZWFjdFByb3BUeXBlcy5vbmVPZihbJ3JvdycsICdyb3ctcmV2ZXJzZScsICdjb2x1bW4nLCAnY29sdW1uLXJldmVyc2UnXSksCiAgICBmbGV4V3JhcDogUmVhY3RQcm9wVHlwZXMub25lT2YoWyd3cmFwJywgJ25vd3JhcCddKSwKICAgIGp1c3RpZnlDb250ZW50OiBSZWFjdFByb3BUeXBlcy5vbmVPZihbJ2ZsZXgtc3RhcnQnLCAnZmxleC1lbmQnLCAnY2VudGVyJywgJ3NwYWNlLWJldHdlZW4nLCAnc3BhY2UtYXJvdW5kJ10pLAogICAgYWxpZ25JdGVtczogUmVhY3RQcm9wVHlwZXMub25lT2YoWydmbGV4LXN0YXJ0JywgJ2ZsZXgtZW5kJywgJ2NlbnRlcicsICdzdHJldGNoJywgJ2Jhc2VsaW5lJ10pLAogICAgYWxpZ25TZWxmOiBSZWFjdFByb3BUeXBlcy5vbmVPZihbJ2F1dG8nLCAnZmxleC1zdGFydCcsICdmbGV4LWVuZCcsICdjZW50ZXInLCAnc3RyZXRjaCcsICdiYXNlbGluZSddKSwKICAgIGFsaWduQ29udGVudDogUmVhY3RQcm9wVHlwZXMub25lT2YoWydmbGV4LXN0YXJ0JywgJ2ZsZXgtZW5kJywgJ2NlbnRlcicsICdzdHJldGNoJywgJ3NwYWNlLWJldHdlZW4nLCAnc3BhY2UtYXJvdW5kJ10pLAogICAgb3ZlcmZsb3c6IFJlYWN0UHJvcFR5cGVzLm9uZU9mKFsndmlzaWJsZScsICdoaWRkZW4nLCAnc2Nyb2xsJ10pLAogICAgZmxleDogUmVhY3RQcm9wVHlwZXMubnVtYmVyLAogICAgZmxleEdyb3c6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGZsZXhTaHJpbms6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGZsZXhCYXNpczogUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5udW1iZXIsIFJlYWN0UHJvcFR5cGVzLnN0cmluZ10pLAogICAgYXNwZWN0UmF0aW86IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIHpJbmRleDogUmVhY3RQcm9wVHlwZXMubnVtYmVyLAogICAgZGlyZWN0aW9uOiBSZWFjdFByb3BUeXBlcy5vbmVPZihbJ2luaGVyaXQnLCAnbHRyJywgJ3J0bCddKQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBMYXlvdXRQcm9wVHlwZXM7Cn0sMTQwLFsxMjddLCJMYXlvdXRQcm9wVHlwZXMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBDb2xvclByb3BUeXBlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkNvbG9yUHJvcFR5cGUiKTsKCiAgdmFyIFJlYWN0UHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgInByb3AtdHlwZXMiKTsKCiAgdmFyIFNoYWRvd1Byb3BUeXBlc0lPUyA9IHsKICAgIHNoYWRvd0NvbG9yOiBDb2xvclByb3BUeXBlLAogICAgc2hhZG93T2Zmc2V0OiBSZWFjdFByb3BUeXBlcy5zaGFwZSh7CiAgICAgIHdpZHRoOiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICAgIGhlaWdodDogUmVhY3RQcm9wVHlwZXMubnVtYmVyCiAgICB9KSwKICAgIHNoYWRvd09wYWNpdHk6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIHNoYWRvd1JhZGl1czogUmVhY3RQcm9wVHlwZXMubnVtYmVyCiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IFNoYWRvd1Byb3BUeXBlc0lPUzsKfSwxNDEsWzEyMywxMjddLCJTaGFkb3dQcm9wVHlwZXNJT1MiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBSZWFjdFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJwcm9wLXR5cGVzIik7CgogIHZhciBkZXByZWNhdGVkUHJvcFR5cGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiZGVwcmVjYXRlZFByb3BUeXBlIik7CgogIHZhciBUcmFuc2Zvcm1NYXRyaXhQcm9wVHlwZSA9IGZ1bmN0aW9uIFRyYW5zZm9ybU1hdHJpeFByb3BUeXBlKHByb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSkgewogICAgaWYgKHByb3BzW3Byb3BOYW1lXSkgewogICAgICByZXR1cm4gbmV3IEVycm9yKCdUaGUgdHJhbnNmb3JtTWF0cml4IHN0eWxlIHByb3BlcnR5IGlzIGRlcHJlY2F0ZWQuICcgKyAnVXNlIGB0cmFuc2Zvcm06IFt7IG1hdHJpeDogLi4uIH1dYCBpbnN0ZWFkLicpOwogICAgfQogIH07CgogIHZhciBEZWNvbXBvc2VkTWF0cml4UHJvcFR5cGUgPSBmdW5jdGlvbiBEZWNvbXBvc2VkTWF0cml4UHJvcFR5cGUocHJvcHMsIHByb3BOYW1lLCBjb21wb25lbnROYW1lKSB7CiAgICBpZiAocHJvcHNbcHJvcE5hbWVdKSB7CiAgICAgIHJldHVybiBuZXcgRXJyb3IoJ1RoZSBkZWNvbXBvc2VkTWF0cml4IHN0eWxlIHByb3BlcnR5IGlzIGRlcHJlY2F0ZWQuICcgKyAnVXNlIGB0cmFuc2Zvcm06IFsuLi5dYCBpbnN0ZWFkLicpOwogICAgfQogIH07CgogIHZhciBUcmFuc2Zvcm1Qcm9wVHlwZXMgPSB7CiAgICB0cmFuc2Zvcm06IFJlYWN0UHJvcFR5cGVzLmFycmF5T2YoUmVhY3RQcm9wVHlwZXMub25lT2ZUeXBlKFtSZWFjdFByb3BUeXBlcy5zaGFwZSh7CiAgICAgIHBlcnNwZWN0aXZlOiBSZWFjdFByb3BUeXBlcy5udW1iZXIKICAgIH0pLCBSZWFjdFByb3BUeXBlcy5zaGFwZSh7CiAgICAgIHJvdGF0ZTogUmVhY3RQcm9wVHlwZXMuc3RyaW5nCiAgICB9KSwgUmVhY3RQcm9wVHlwZXMuc2hhcGUoewogICAgICByb3RhdGVYOiBSZWFjdFByb3BUeXBlcy5zdHJpbmcKICAgIH0pLCBSZWFjdFByb3BUeXBlcy5zaGFwZSh7CiAgICAgIHJvdGF0ZVk6IFJlYWN0UHJvcFR5cGVzLnN0cmluZwogICAgfSksIFJlYWN0UHJvcFR5cGVzLnNoYXBlKHsKICAgICAgcm90YXRlWjogUmVhY3RQcm9wVHlwZXMuc3RyaW5nCiAgICB9KSwgUmVhY3RQcm9wVHlwZXMuc2hhcGUoewogICAgICBzY2FsZTogUmVhY3RQcm9wVHlwZXMubnVtYmVyCiAgICB9KSwgUmVhY3RQcm9wVHlwZXMuc2hhcGUoewogICAgICBzY2FsZVg6IFJlYWN0UHJvcFR5cGVzLm51bWJlcgogICAgfSksIFJlYWN0UHJvcFR5cGVzLnNoYXBlKHsKICAgICAgc2NhbGVZOiBSZWFjdFByb3BUeXBlcy5udW1iZXIKICAgIH0pLCBSZWFjdFByb3BUeXBlcy5zaGFwZSh7CiAgICAgIHRyYW5zbGF0ZVg6IFJlYWN0UHJvcFR5cGVzLm51bWJlcgogICAgfSksIFJlYWN0UHJvcFR5cGVzLnNoYXBlKHsKICAgICAgdHJhbnNsYXRlWTogUmVhY3RQcm9wVHlwZXMubnVtYmVyCiAgICB9KSwgUmVhY3RQcm9wVHlwZXMuc2hhcGUoewogICAgICBza2V3WDogUmVhY3RQcm9wVHlwZXMuc3RyaW5nCiAgICB9KSwgUmVhY3RQcm9wVHlwZXMuc2hhcGUoewogICAgICBza2V3WTogUmVhY3RQcm9wVHlwZXMuc3RyaW5nCiAgICB9KV0pKSwKICAgIHRyYW5zZm9ybU1hdHJpeDogVHJhbnNmb3JtTWF0cml4UHJvcFR5cGUsCiAgICBkZWNvbXBvc2VkTWF0cml4OiBEZWNvbXBvc2VkTWF0cml4UHJvcFR5cGUsCiAgICBzY2FsZVg6IGRlcHJlY2F0ZWRQcm9wVHlwZShSZWFjdFByb3BUeXBlcy5udW1iZXIsICdVc2UgdGhlIHRyYW5zZm9ybSBwcm9wIGluc3RlYWQuJyksCiAgICBzY2FsZVk6IGRlcHJlY2F0ZWRQcm9wVHlwZShSZWFjdFByb3BUeXBlcy5udW1iZXIsICdVc2UgdGhlIHRyYW5zZm9ybSBwcm9wIGluc3RlYWQuJyksCiAgICByb3RhdGlvbjogZGVwcmVjYXRlZFByb3BUeXBlKFJlYWN0UHJvcFR5cGVzLm51bWJlciwgJ1VzZSB0aGUgdHJhbnNmb3JtIHByb3AgaW5zdGVhZC4nKSwKICAgIHRyYW5zbGF0ZVg6IGRlcHJlY2F0ZWRQcm9wVHlwZShSZWFjdFByb3BUeXBlcy5udW1iZXIsICdVc2UgdGhlIHRyYW5zZm9ybSBwcm9wIGluc3RlYWQuJyksCiAgICB0cmFuc2xhdGVZOiBkZXByZWNhdGVkUHJvcFR5cGUoUmVhY3RQcm9wVHlwZXMubnVtYmVyLCAnVXNlIHRoZSB0cmFuc2Zvcm0gcHJvcCBpbnN0ZWFkLicpCiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IFRyYW5zZm9ybVByb3BUeXBlczsKfSwxNDIsWzEyNywxNDNdLCJUcmFuc2Zvcm1Qcm9wVHlwZXMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBVSU1hbmFnZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiVUlNYW5hZ2VyIik7CgogIGZ1bmN0aW9uIGRlcHJlY2F0ZWRQcm9wVHlwZShwcm9wVHlwZSwgZXhwbGFuYXRpb24pIHsKICAgIHJldHVybiBmdW5jdGlvbiB2YWxpZGF0ZShwcm9wcywgcHJvcE5hbWUsIGNvbXBvbmVudE5hbWUpIHsKICAgICAgaWYgKCFVSU1hbmFnZXJbY29tcG9uZW50TmFtZV0gJiYgcHJvcHNbcHJvcE5hbWVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBjb25zb2xlLndhcm4oImAiICsgcHJvcE5hbWUgKyAiYCBzdXBwbGllZCB0byBgIiArIGNvbXBvbmVudE5hbWUgKyAiYCBoYXMgYmVlbiBkZXByZWNhdGVkLiAiICsgZXhwbGFuYXRpb24pOwogICAgICB9CgogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgcmVzdCA9IEFycmF5KF9sZW4gPiAzID8gX2xlbiAtIDMgOiAwKSwgX2tleSA9IDM7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICByZXN0W19rZXkgLSAzXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgfQoKICAgICAgcmV0dXJuIHByb3BUeXBlLmFwcGx5KHVuZGVmaW5lZCwgW3Byb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZV0uY29uY2F0KHJlc3QpKTsKICAgIH07CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGRlcHJlY2F0ZWRQcm9wVHlwZTsKfSwxNDMsWzEwN10sImRlcHJlY2F0ZWRQcm9wVHlwZSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBBY2Nlc3NpYmlsaXR5VHJhaXRzOiBbJ25vbmUnLCAnYnV0dG9uJywgJ2xpbmsnLCAnaGVhZGVyJywgJ3NlYXJjaCcsICdpbWFnZScsICdzZWxlY3RlZCcsICdwbGF5cycsICdrZXknLCAndGV4dCcsICdzdW1tYXJ5JywgJ2Rpc2FibGVkJywgJ2ZyZXF1ZW50VXBkYXRlcycsICdzdGFydHNNZWRpYScsICdhZGp1c3RhYmxlJywgJ2FsbG93c0RpcmVjdEludGVyYWN0aW9uJywgJ3BhZ2VUdXJuJ10sCiAgICBBY2Nlc3NpYmlsaXR5Q29tcG9uZW50VHlwZXM6IFsnbm9uZScsICdidXR0b24nLCAncmFkaW9idXR0b25fY2hlY2tlZCcsICdyYWRpb2J1dHRvbl91bmNoZWNrZWQnXQogIH07Cn0sMTQ0LFtdLCJWaWV3QWNjZXNzaWJpbGl0eSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFBsYXRmb3JtID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlBsYXRmb3JtIik7CgogIHZhciBSZWFjdE5hdGl2ZUJyaWRnZUV2ZW50UGx1Z2luID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlJlYWN0TmF0aXZlQnJpZGdlRXZlbnRQbHVnaW4iKTsKCiAgdmFyIFJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzIik7CgogIHZhciBVSU1hbmFnZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiVUlNYW5hZ2VyIik7CgogIHZhciBjcmVhdGVSZWFjdE5hdGl2ZUNvbXBvbmVudENsYXNzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgImNyZWF0ZVJlYWN0TmF0aXZlQ29tcG9uZW50Q2xhc3MiKTsKCiAgdmFyIGluc2V0c0RpZmZlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJpbnNldHNEaWZmZXIiKTsKCiAgdmFyIG1hdHJpY2VzRGlmZmVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgIm1hdHJpY2VzRGlmZmVyIik7CgogIHZhciBwb2ludHNEaWZmZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAicG9pbnRzRGlmZmVyIik7CgogIHZhciBwcm9jZXNzQ29sb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAicHJvY2Vzc0NvbG9yIik7CgogIHZhciByZXNvbHZlQXNzZXRTb3VyY2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAicmVzb2x2ZUFzc2V0U291cmNlIik7CgogIHZhciBzaXplc0RpZmZlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTBdLCAic2l6ZXNEaWZmZXIiKTsKCiAgdmFyIHZlcmlmeVByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTFdLCAidmVyaWZ5UHJvcFR5cGVzIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEyXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgd2FybmluZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTNdLCAiZmJqcy9saWIvd2FybmluZyIpOwoKICB2YXIgaGFzQXR0YWNoZWREZWZhdWx0RXZlbnRUeXBlcyA9IGZhbHNlOwoKICBmdW5jdGlvbiByZXF1aXJlTmF0aXZlQ29tcG9uZW50KHZpZXdOYW1lLCBjb21wb25lbnRJbnRlcmZhY2UsIGV4dHJhQ29uZmlnKSB7CiAgICBmdW5jdGlvbiBhdHRhY2hEZWZhdWx0RXZlbnRUeXBlcyh2aWV3Q29uZmlnKSB7CiAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICAgICAgaWYgKFVJTWFuYWdlci5WaWV3TWFuYWdlck5hbWVzKSB7CiAgICAgICAgICB2aWV3Q29uZmlnID0gbWVyZ2Uodmlld0NvbmZpZywgVUlNYW5hZ2VyLmdldERlZmF1bHRFdmVudFR5cGVzKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2aWV3Q29uZmlnLmJ1YmJsaW5nRXZlbnRUeXBlcyA9IG1lcmdlKHZpZXdDb25maWcuYnViYmxpbmdFdmVudFR5cGVzLCBVSU1hbmFnZXIuZ2VuZXJpY0J1YmJsaW5nRXZlbnRUeXBlcyk7CiAgICAgICAgICB2aWV3Q29uZmlnLmRpcmVjdEV2ZW50VHlwZXMgPSBtZXJnZSh2aWV3Q29uZmlnLmRpcmVjdEV2ZW50VHlwZXMsIFVJTWFuYWdlci5nZW5lcmljRGlyZWN0RXZlbnRUeXBlcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbWVyZ2UoZGVzdGluYXRpb24sIHNvdXJjZSkgewogICAgICBpZiAoIXNvdXJjZSkgewogICAgICAgIHJldHVybiBkZXN0aW5hdGlvbjsKICAgICAgfQoKICAgICAgaWYgKCFkZXN0aW5hdGlvbikgewogICAgICAgIHJldHVybiBzb3VyY2U7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICBpZiAoIXNvdXJjZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIHZhciBzb3VyY2VWYWx1ZSA9IHNvdXJjZVtrZXldOwoKICAgICAgICBpZiAoZGVzdGluYXRpb24uaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgdmFyIGRlc3RpbmF0aW9uVmFsdWUgPSBkZXN0aW5hdGlvbltrZXldOwoKICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlVmFsdWUgPT09ICdvYmplY3QnICYmIHR5cGVvZiBkZXN0aW5hdGlvblZhbHVlID09PSAnb2JqZWN0JykgewogICAgICAgICAgICBzb3VyY2VWYWx1ZSA9IG1lcmdlKGRlc3RpbmF0aW9uVmFsdWUsIHNvdXJjZVZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGRlc3RpbmF0aW9uW2tleV0gPSBzb3VyY2VWYWx1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFZpZXdDb25maWcoKSB7CiAgICAgIHZhciB2aWV3Q29uZmlnID0gVUlNYW5hZ2VyW3ZpZXdOYW1lXTsKICAgICAgaW52YXJpYW50KHZpZXdDb25maWcgIT0gbnVsbCAmJiAhdmlld0NvbmZpZy5OYXRpdmVQcm9wcyAhPSBudWxsLCAnTmF0aXZlIGNvbXBvbmVudCBmb3IgIiVzIiBkb2VzIG5vdCBleGlzdCcsIHZpZXdOYW1lKTsKICAgICAgdmlld0NvbmZpZy51aVZpZXdDbGFzc05hbWUgPSB2aWV3TmFtZTsKICAgICAgdmlld0NvbmZpZy52YWxpZEF0dHJpYnV0ZXMgPSB7fTsKCiAgICAgIGlmIChjb21wb25lbnRJbnRlcmZhY2UpIHsKICAgICAgICB2aWV3Q29uZmlnLnByb3BUeXBlcyA9IHR5cGVvZiBjb21wb25lbnRJbnRlcmZhY2UuX19wcm9wVHlwZXNTZWNyZXREb250VXNlVGhlc2VQbGVhc2UgPT09ICdvYmplY3QnID8gY29tcG9uZW50SW50ZXJmYWNlLl9fcHJvcFR5cGVzU2VjcmV0RG9udFVzZVRoZXNlUGxlYXNlIDogY29tcG9uZW50SW50ZXJmYWNlLnByb3BUeXBlczsKICAgICAgfSBlbHNlIHsKICAgICAgICB2aWV3Q29uZmlnLnByb3BUeXBlcyA9IG51bGw7CiAgICAgIH0KCiAgICAgIHZhciBiYXNlTW9kdWxlTmFtZSA9IHZpZXdDb25maWcuYmFzZU1vZHVsZU5hbWU7CiAgICAgIHZhciBuYXRpdmVQcm9wcyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCB2aWV3Q29uZmlnLk5hdGl2ZVByb3BzKTsKCiAgICAgIHdoaWxlIChiYXNlTW9kdWxlTmFtZSkgewogICAgICAgIHZhciBiYXNlTW9kdWxlID0gVUlNYW5hZ2VyW2Jhc2VNb2R1bGVOYW1lXTsKCiAgICAgICAgaWYgKCFiYXNlTW9kdWxlKSB7CiAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAnQmFzZSBtb2R1bGUgIiVzIiBkb2VzIG5vdCBleGlzdCcsIGJhc2VNb2R1bGVOYW1lKTsKICAgICAgICAgIGJhc2VNb2R1bGVOYW1lID0gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbmF0aXZlUHJvcHMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgbmF0aXZlUHJvcHMsIGJhc2VNb2R1bGUuTmF0aXZlUHJvcHMpOwogICAgICAgICAgYmFzZU1vZHVsZU5hbWUgPSBiYXNlTW9kdWxlLmJhc2VNb2R1bGVOYW1lOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yICh2YXIga2V5IGluIG5hdGl2ZVByb3BzKSB7CiAgICAgICAgdmFyIHVzZUF0dHJpYnV0ZSA9IGZhbHNlOwogICAgICAgIHZhciBhdHRyaWJ1dGUgPSB7fTsKICAgICAgICB2YXIgZGlmZmVyID0gVHlwZVRvRGlmZmVyTWFwW25hdGl2ZVByb3BzW2tleV1dOwoKICAgICAgICBpZiAoZGlmZmVyKSB7CiAgICAgICAgICBhdHRyaWJ1dGUuZGlmZiA9IGRpZmZlcjsKICAgICAgICAgIHVzZUF0dHJpYnV0ZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgcHJvY2Vzc29yID0gVHlwZVRvUHJvY2Vzc29yTWFwW25hdGl2ZVByb3BzW2tleV1dOwoKICAgICAgICBpZiAocHJvY2Vzc29yKSB7CiAgICAgICAgICBhdHRyaWJ1dGUucHJvY2VzcyA9IHByb2Nlc3NvcjsKICAgICAgICAgIHVzZUF0dHJpYnV0ZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB2aWV3Q29uZmlnLnZhbGlkQXR0cmlidXRlc1trZXldID0gdXNlQXR0cmlidXRlID8gYXR0cmlidXRlIDogdHJ1ZTsKICAgICAgfQoKICAgICAgdmlld0NvbmZpZy52YWxpZEF0dHJpYnV0ZXMuc3R5bGUgPSBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlczsKCiAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgY29tcG9uZW50SW50ZXJmYWNlICYmIHZlcmlmeVByb3BUeXBlcyhjb21wb25lbnRJbnRlcmZhY2UsIHZpZXdDb25maWcsIGV4dHJhQ29uZmlnICYmIGV4dHJhQ29uZmlnLm5hdGl2ZU9ubHkpOwogICAgICB9CgogICAgICBpZiAoIWhhc0F0dGFjaGVkRGVmYXVsdEV2ZW50VHlwZXMpIHsKICAgICAgICBhdHRhY2hEZWZhdWx0RXZlbnRUeXBlcyh2aWV3Q29uZmlnKTsKICAgICAgICBoYXNBdHRhY2hlZERlZmF1bHRFdmVudFR5cGVzID0gdHJ1ZTsKICAgICAgfQoKICAgICAgUmVhY3ROYXRpdmVCcmlkZ2VFdmVudFBsdWdpbi5wcm9jZXNzRXZlbnRUeXBlcyh2aWV3Q29uZmlnKTsKICAgICAgcmV0dXJuIHZpZXdDb25maWc7CiAgICB9CgogICAgcmV0dXJuIGNyZWF0ZVJlYWN0TmF0aXZlQ29tcG9uZW50Q2xhc3Modmlld05hbWUsIGdldFZpZXdDb25maWcpOwogIH0KCiAgdmFyIFR5cGVUb0RpZmZlck1hcCA9IHsKICAgIENBVHJhbnNmb3JtM0Q6IG1hdHJpY2VzRGlmZmVyLAogICAgQ0dQb2ludDogcG9pbnRzRGlmZmVyLAogICAgQ0dTaXplOiBzaXplc0RpZmZlciwKICAgIFVJRWRnZUluc2V0czogaW5zZXRzRGlmZmVyCiAgfTsKCiAgZnVuY3Rpb24gcHJvY2Vzc0NvbG9yQXJyYXkoY29sb3JzKSB7CiAgICByZXR1cm4gY29sb3JzICYmIGNvbG9ycy5tYXAocHJvY2Vzc0NvbG9yKTsKICB9CgogIHZhciBUeXBlVG9Qcm9jZXNzb3JNYXAgPSB7CiAgICBDR0NvbG9yOiBwcm9jZXNzQ29sb3IsCiAgICBDR0NvbG9yQXJyYXk6IHByb2Nlc3NDb2xvckFycmF5LAogICAgVUlDb2xvcjogcHJvY2Vzc0NvbG9yLAogICAgVUlDb2xvckFycmF5OiBwcm9jZXNzQ29sb3JBcnJheSwKICAgIENHSW1hZ2U6IHJlc29sdmVBc3NldFNvdXJjZSwKICAgIFVJSW1hZ2U6IHJlc29sdmVBc3NldFNvdXJjZSwKICAgIFJDVEltYWdlU291cmNlOiByZXNvbHZlQXNzZXRTb3VyY2UsCiAgICBDb2xvcjogcHJvY2Vzc0NvbG9yLAogICAgQ29sb3JBcnJheTogcHJvY2Vzc0NvbG9yQXJyYXkKICB9OwogIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZU5hdGl2ZUNvbXBvbmVudDsKfSwxNDUsWzUyLDE0NiwxNDcsMTA3LDE1NiwxNTcsMTU4LDE1OSwxNTIsMTYwLDE1NSwxNjcsMTMsNTZdLCJyZXF1aXJlTmF0aXZlQ29tcG9uZW50Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX3JlcXVpcmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiUmVhY3ROYXRpdmUiKSwKICAgICAgX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQgPSBfcmVxdWlyZS5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRDsKCiAgbW9kdWxlLmV4cG9ydHMgPSBfX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRC5SZWFjdE5hdGl2ZUJyaWRnZUV2ZW50UGx1Z2luOwp9LDE0NixbMjFdLCJSZWFjdE5hdGl2ZUJyaWRnZUV2ZW50UGx1Z2luIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgSW1hZ2VTdHlsZVByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJJbWFnZVN0eWxlUHJvcFR5cGVzIik7CgogIHZhciBUZXh0U3R5bGVQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiVGV4dFN0eWxlUHJvcFR5cGVzIik7CgogIHZhciBWaWV3U3R5bGVQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiVmlld1N0eWxlUHJvcFR5cGVzIik7CgogIHZhciBrZXlNaXJyb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiZmJqcy9saWIva2V5TWlycm9yIik7CgogIHZhciBwcm9jZXNzQ29sb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAicHJvY2Vzc0NvbG9yIik7CgogIHZhciBwcm9jZXNzVHJhbnNmb3JtID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgInByb2Nlc3NUcmFuc2Zvcm0iKTsKCiAgdmFyIHNpemVzRGlmZmVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgInNpemVzRGlmZmVyIik7CgogIHZhciBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlcyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBrZXlNaXJyb3IoVmlld1N0eWxlUHJvcFR5cGVzKSwga2V5TWlycm9yKFRleHRTdHlsZVByb3BUeXBlcyksIGtleU1pcnJvcihJbWFnZVN0eWxlUHJvcFR5cGVzKSk7CiAgUmVhY3ROYXRpdmVTdHlsZUF0dHJpYnV0ZXMudHJhbnNmb3JtID0gewogICAgcHJvY2VzczogcHJvY2Vzc1RyYW5zZm9ybQogIH07CiAgUmVhY3ROYXRpdmVTdHlsZUF0dHJpYnV0ZXMuc2hhZG93T2Zmc2V0ID0gewogICAgZGlmZjogc2l6ZXNEaWZmZXIKICB9OwogIHZhciBjb2xvckF0dHJpYnV0ZXMgPSB7CiAgICBwcm9jZXNzOiBwcm9jZXNzQ29sb3IKICB9OwogIFJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzLmJhY2tncm91bmRDb2xvciA9IGNvbG9yQXR0cmlidXRlczsKICBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlcy5ib3JkZXJCb3R0b21Db2xvciA9IGNvbG9yQXR0cmlidXRlczsKICBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlcy5ib3JkZXJDb2xvciA9IGNvbG9yQXR0cmlidXRlczsKICBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlcy5ib3JkZXJMZWZ0Q29sb3IgPSBjb2xvckF0dHJpYnV0ZXM7CiAgUmVhY3ROYXRpdmVTdHlsZUF0dHJpYnV0ZXMuYm9yZGVyUmlnaHRDb2xvciA9IGNvbG9yQXR0cmlidXRlczsKICBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlcy5ib3JkZXJUb3BDb2xvciA9IGNvbG9yQXR0cmlidXRlczsKICBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlcy5ib3JkZXJTdGFydENvbG9yID0gY29sb3JBdHRyaWJ1dGVzOwogIFJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzLmJvcmRlckVuZENvbG9yID0gY29sb3JBdHRyaWJ1dGVzOwogIFJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzLmNvbG9yID0gY29sb3JBdHRyaWJ1dGVzOwogIFJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzLnNoYWRvd0NvbG9yID0gY29sb3JBdHRyaWJ1dGVzOwogIFJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzLnRleHREZWNvcmF0aW9uQ29sb3IgPSBjb2xvckF0dHJpYnV0ZXM7CiAgUmVhY3ROYXRpdmVTdHlsZUF0dHJpYnV0ZXMudGludENvbG9yID0gY29sb3JBdHRyaWJ1dGVzOwogIFJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzLnRleHRTaGFkb3dDb2xvciA9IGNvbG9yQXR0cmlidXRlczsKICBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlcy5vdmVybGF5Q29sb3IgPSBjb2xvckF0dHJpYnV0ZXM7CiAgbW9kdWxlLmV4cG9ydHMgPSBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlczsKfSwxNDcsWzE0OCwxNTEsMTM5LDE1MCwxNTIsMTUzLDE1NV0sIlJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBJbWFnZVJlc2l6ZU1vZGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiSW1hZ2VSZXNpemVNb2RlIik7CgogIHZhciBMYXlvdXRQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiTGF5b3V0UHJvcFR5cGVzIik7CgogIHZhciBSZWFjdFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJwcm9wLXR5cGVzIik7CgogIHZhciBTaGFkb3dQcm9wVHlwZXNJT1MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiU2hhZG93UHJvcFR5cGVzSU9TIik7CgogIHZhciBUcmFuc2Zvcm1Qcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiVHJhbnNmb3JtUHJvcFR5cGVzIik7CgogIHZhciBJbWFnZVN0eWxlUHJvcFR5cGVzID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIExheW91dFByb3BUeXBlcywgU2hhZG93UHJvcFR5cGVzSU9TLCBUcmFuc2Zvcm1Qcm9wVHlwZXMsIHsKICAgIHJlc2l6ZU1vZGU6IFJlYWN0UHJvcFR5cGVzLm9uZU9mKE9iamVjdC5rZXlzKEltYWdlUmVzaXplTW9kZSkpLAogICAgYmFja2ZhY2VWaXNpYmlsaXR5OiBSZWFjdFByb3BUeXBlcy5vbmVPZihbJ3Zpc2libGUnLCAnaGlkZGVuJ10pLAogICAgYmFja2dyb3VuZENvbG9yOiBDb2xvclByb3BUeXBlLAogICAgYm9yZGVyQ29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICBib3JkZXJXaWR0aDogUmVhY3RQcm9wVHlwZXMubnVtYmVyLAogICAgYm9yZGVyUmFkaXVzOiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICBvdmVyZmxvdzogUmVhY3RQcm9wVHlwZXMub25lT2YoWyd2aXNpYmxlJywgJ2hpZGRlbiddKSwKICAgIHRpbnRDb2xvcjogQ29sb3JQcm9wVHlwZSwKICAgIG9wYWNpdHk6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIG92ZXJsYXlDb2xvcjogUmVhY3RQcm9wVHlwZXMuc3RyaW5nLAogICAgYm9yZGVyVG9wTGVmdFJhZGl1czogUmVhY3RQcm9wVHlwZXMubnVtYmVyLAogICAgYm9yZGVyVG9wUmlnaHRSYWRpdXM6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGJvcmRlckJvdHRvbUxlZnRSYWRpdXM6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGJvcmRlckJvdHRvbVJpZ2h0UmFkaXVzOiBSZWFjdFByb3BUeXBlcy5udW1iZXIKICB9KTsKICBtb2R1bGUuZXhwb3J0cyA9IEltYWdlU3R5bGVQcm9wVHlwZXM7Cn0sMTQ4LFsxMjMsMTQ5LDE0MCwxMjcsMTQxLDE0Ml0sIkltYWdlU3R5bGVQcm9wVHlwZXMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBrZXlNaXJyb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiZmJqcy9saWIva2V5TWlycm9yIik7CgogIHZhciBJbWFnZVJlc2l6ZU1vZGUgPSBrZXlNaXJyb3IoewogICAgY29udGFpbjogbnVsbCwKICAgIGNvdmVyOiBudWxsLAogICAgc3RyZXRjaDogbnVsbCwKICAgIGNlbnRlcjogbnVsbCwKICAgIHJlcGVhdDogbnVsbAogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gSW1hZ2VSZXNpemVNb2RlOwp9LDE0OSxbMTUwXSwiSW1hZ2VSZXNpemVNb2RlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgJy4vaW52YXJpYW50Jyk7CgogIHZhciBrZXlNaXJyb3IgPSBmdW5jdGlvbiBrZXlNaXJyb3Iob2JqKSB7CiAgICB2YXIgcmV0ID0ge307CiAgICB2YXIga2V5OwogICAgIShvYmogaW5zdGFuY2VvZiBPYmplY3QgJiYgIUFycmF5LmlzQXJyYXkob2JqKSkgPyBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gaW52YXJpYW50KGZhbHNlLCAna2V5TWlycm9yKC4uLik6IEFyZ3VtZW50IG11c3QgYmUgYW4gb2JqZWN0LicpIDogaW52YXJpYW50KGZhbHNlKSA6IHZvaWQgMDsKCiAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgaWYgKCFvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICByZXRba2V5XSA9IGtleTsKICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH07CgogIG1vZHVsZS5leHBvcnRzID0ga2V5TWlycm9yOwp9LDE1MCxbMTNdLCJmYmpzL2xpYi9rZXlNaXJyb3IuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBDb2xvclByb3BUeXBlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkNvbG9yUHJvcFR5cGUiKTsKCiAgdmFyIFJlYWN0UHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgInByb3AtdHlwZXMiKTsKCiAgdmFyIFZpZXdTdHlsZVByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJWaWV3U3R5bGVQcm9wVHlwZXMiKTsKCiAgdmFyIFRleHRTdHlsZVByb3BUeXBlcyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBWaWV3U3R5bGVQcm9wVHlwZXMsIHsKICAgIGNvbG9yOiBDb2xvclByb3BUeXBlLAogICAgZm9udEZhbWlseTogUmVhY3RQcm9wVHlwZXMuc3RyaW5nLAogICAgZm9udFNpemU6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGZvbnRTdHlsZTogUmVhY3RQcm9wVHlwZXMub25lT2YoWydub3JtYWwnLCAnaXRhbGljJ10pLAogICAgZm9udFdlaWdodDogUmVhY3RQcm9wVHlwZXMub25lT2YoWydub3JtYWwnLCAnYm9sZCcsICcxMDAnLCAnMjAwJywgJzMwMCcsICc0MDAnLCAnNTAwJywgJzYwMCcsICc3MDAnLCAnODAwJywgJzkwMCddKSwKICAgIGZvbnRWYXJpYW50OiBSZWFjdFByb3BUeXBlcy5hcnJheU9mKFJlYWN0UHJvcFR5cGVzLm9uZU9mKFsnc21hbGwtY2FwcycsICdvbGRzdHlsZS1udW1zJywgJ2xpbmluZy1udW1zJywgJ3RhYnVsYXItbnVtcycsICdwcm9wb3J0aW9uYWwtbnVtcyddKSksCiAgICB0ZXh0U2hhZG93T2Zmc2V0OiBSZWFjdFByb3BUeXBlcy5zaGFwZSh7CiAgICAgIHdpZHRoOiBSZWFjdFByb3BUeXBlcy5udW1iZXIsCiAgICAgIGhlaWdodDogUmVhY3RQcm9wVHlwZXMubnVtYmVyCiAgICB9KSwKICAgIHRleHRTaGFkb3dSYWRpdXM6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIHRleHRTaGFkb3dDb2xvcjogQ29sb3JQcm9wVHlwZSwKICAgIGxldHRlclNwYWNpbmc6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIGxpbmVIZWlnaHQ6IFJlYWN0UHJvcFR5cGVzLm51bWJlciwKICAgIHRleHRBbGlnbjogUmVhY3RQcm9wVHlwZXMub25lT2YoWydhdXRvJywgJ2xlZnQnLCAncmlnaHQnLCAnY2VudGVyJywgJ2p1c3RpZnknXSksCiAgICB0ZXh0QWxpZ25WZXJ0aWNhbDogUmVhY3RQcm9wVHlwZXMub25lT2YoWydhdXRvJywgJ3RvcCcsICdib3R0b20nLCAnY2VudGVyJ10pLAogICAgaW5jbHVkZUZvbnRQYWRkaW5nOiBSZWFjdFByb3BUeXBlcy5ib29sLAogICAgdGV4dERlY29yYXRpb25MaW5lOiBSZWFjdFByb3BUeXBlcy5vbmVPZihbJ25vbmUnLCAndW5kZXJsaW5lJywgJ2xpbmUtdGhyb3VnaCcsICd1bmRlcmxpbmUgbGluZS10aHJvdWdoJ10pLAogICAgdGV4dERlY29yYXRpb25TdHlsZTogUmVhY3RQcm9wVHlwZXMub25lT2YoWydzb2xpZCcsICdkb3VibGUnLCAnZG90dGVkJywgJ2Rhc2hlZCddKSwKICAgIHRleHREZWNvcmF0aW9uQ29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICB3cml0aW5nRGlyZWN0aW9uOiBSZWFjdFByb3BUeXBlcy5vbmVPZihbJ2F1dG8nLCAnbHRyJywgJ3J0bCddKQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gVGV4dFN0eWxlUHJvcFR5cGVzOwp9LDE1MSxbMTIzLDEyNywxMzldLCJUZXh0U3R5bGVQcm9wVHlwZXMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJQbGF0Zm9ybSIpOwoKICB2YXIgbm9ybWFsaXplQ29sb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAibm9ybWFsaXplQ29sb3IiKTsKCiAgZnVuY3Rpb24gcHJvY2Vzc0NvbG9yKGNvbG9yKSB7CiAgICBpZiAoY29sb3IgPT09IHVuZGVmaW5lZCB8fCBjb2xvciA9PT0gbnVsbCkgewogICAgICByZXR1cm4gY29sb3I7CiAgICB9CgogICAgdmFyIGludDMyQ29sb3IgPSBub3JtYWxpemVDb2xvcihjb2xvcik7CgogICAgaWYgKGludDMyQ29sb3IgPT09IG51bGwgfHwgaW50MzJDb2xvciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9CgogICAgaW50MzJDb2xvciA9IChpbnQzMkNvbG9yIDw8IDI0IHwgaW50MzJDb2xvciA+Pj4gOCkgPj4+IDA7CgogICAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHsKICAgICAgaW50MzJDb2xvciA9IGludDMyQ29sb3IgfCAweDA7CiAgICB9CgogICAgcmV0dXJuIGludDMyQ29sb3I7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IHByb2Nlc3NDb2xvcjsKfSwxNTIsWzUyLDEyNF0sInByb2Nlc3NDb2xvciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIE1hdHJpeE1hdGggPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTWF0cml4TWF0aCIpOwoKICB2YXIgUGxhdGZvcm0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUGxhdGZvcm0iKTsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIHN0cmluZ2lmeVNhZmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAic3RyaW5naWZ5U2FmZSIpOwoKICBmdW5jdGlvbiBwcm9jZXNzVHJhbnNmb3JtKHRyYW5zZm9ybSkgewogICAgaWYgKF9fREVWX18pIHsKICAgICAgX3ZhbGlkYXRlVHJhbnNmb3Jtcyh0cmFuc2Zvcm0pOwogICAgfQoKICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnIHx8IFBsYXRmb3JtLk9TID09PSAnaW9zJykgewogICAgICByZXR1cm4gdHJhbnNmb3JtOwogICAgfQoKICAgIHZhciByZXN1bHQgPSBNYXRyaXhNYXRoLmNyZWF0ZUlkZW50aXR5TWF0cml4KCk7CiAgICB0cmFuc2Zvcm0uZm9yRWFjaChmdW5jdGlvbiAodHJhbnNmb3JtYXRpb24pIHsKICAgICAgdmFyIGtleSA9IE9iamVjdC5rZXlzKHRyYW5zZm9ybWF0aW9uKVswXTsKICAgICAgdmFyIHZhbHVlID0gdHJhbnNmb3JtYXRpb25ba2V5XTsKCiAgICAgIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgY2FzZSAnbWF0cml4JzoKICAgICAgICAgIE1hdHJpeE1hdGgubXVsdGlwbHlJbnRvKHJlc3VsdCwgcmVzdWx0LCB2YWx1ZSk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAncGVyc3BlY3RpdmUnOgogICAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVBlcnNwZWN0aXZlQ29tbWFuZCwgW3ZhbHVlXSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3JvdGF0ZVgnOgogICAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVJvdGF0ZVhDb21tYW5kLCBbX2NvbnZlcnRUb1JhZGlhbnModmFsdWUpXSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3JvdGF0ZVknOgogICAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVJvdGF0ZVlDb21tYW5kLCBbX2NvbnZlcnRUb1JhZGlhbnModmFsdWUpXSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3JvdGF0ZSc6CiAgICAgICAgY2FzZSAncm90YXRlWic6CiAgICAgICAgICBfbXVsdGlwbHlUcmFuc2Zvcm0ocmVzdWx0LCBNYXRyaXhNYXRoLnJldXNlUm90YXRlWkNvbW1hbmQsIFtfY29udmVydFRvUmFkaWFucyh2YWx1ZSldKTsKCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnc2NhbGUnOgogICAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVNjYWxlQ29tbWFuZCwgW3ZhbHVlXSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3NjYWxlWCc6CiAgICAgICAgICBfbXVsdGlwbHlUcmFuc2Zvcm0ocmVzdWx0LCBNYXRyaXhNYXRoLnJldXNlU2NhbGVYQ29tbWFuZCwgW3ZhbHVlXSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3NjYWxlWSc6CiAgICAgICAgICBfbXVsdGlwbHlUcmFuc2Zvcm0ocmVzdWx0LCBNYXRyaXhNYXRoLnJldXNlU2NhbGVZQ29tbWFuZCwgW3ZhbHVlXSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3RyYW5zbGF0ZSc6CiAgICAgICAgICBfbXVsdGlwbHlUcmFuc2Zvcm0ocmVzdWx0LCBNYXRyaXhNYXRoLnJldXNlVHJhbnNsYXRlM2RDb21tYW5kLCBbdmFsdWVbMF0sIHZhbHVlWzFdLCB2YWx1ZVsyXSB8fCAwXSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3RyYW5zbGF0ZVgnOgogICAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVRyYW5zbGF0ZTJkQ29tbWFuZCwgW3ZhbHVlLCAwXSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3RyYW5zbGF0ZVknOgogICAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVRyYW5zbGF0ZTJkQ29tbWFuZCwgWzAsIHZhbHVlXSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3NrZXdYJzoKICAgICAgICAgIF9tdWx0aXBseVRyYW5zZm9ybShyZXN1bHQsIE1hdHJpeE1hdGgucmV1c2VTa2V3WENvbW1hbmQsIFtfY29udmVydFRvUmFkaWFucyh2YWx1ZSldKTsKCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnc2tld1knOgogICAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVNrZXdZQ29tbWFuZCwgW19jb252ZXJ0VG9SYWRpYW5zKHZhbHVlKV0pOwoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHRyYW5zZm9ybSBuYW1lOiAnICsga2V5KTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgZnVuY3Rpb24gX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgbWF0cml4TWF0aEZ1bmN0aW9uLCBhcmdzKSB7CiAgICB2YXIgbWF0cml4VG9BcHBseSA9IE1hdHJpeE1hdGguY3JlYXRlSWRlbnRpdHlNYXRyaXgoKTsKICAgIHZhciBhcmdzV2l0aElkZW50aXR5ID0gW21hdHJpeFRvQXBwbHldLmNvbmNhdChhcmdzKTsKICAgIG1hdHJpeE1hdGhGdW5jdGlvbi5hcHBseSh0aGlzLCBhcmdzV2l0aElkZW50aXR5KTsKICAgIE1hdHJpeE1hdGgubXVsdGlwbHlJbnRvKHJlc3VsdCwgcmVzdWx0LCBtYXRyaXhUb0FwcGx5KTsKICB9CgogIGZ1bmN0aW9uIF9jb252ZXJ0VG9SYWRpYW5zKHZhbHVlKSB7CiAgICB2YXIgZmxvYXRWYWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpOwogICAgcmV0dXJuIHZhbHVlLmluZGV4T2YoJ3JhZCcpID4gLTEgPyBmbG9hdFZhbHVlIDogZmxvYXRWYWx1ZSAqIE1hdGguUEkgLyAxODA7CiAgfQoKICBmdW5jdGlvbiBfdmFsaWRhdGVUcmFuc2Zvcm1zKHRyYW5zZm9ybSkgewogICAgdHJhbnNmb3JtLmZvckVhY2goZnVuY3Rpb24gKHRyYW5zZm9ybWF0aW9uKSB7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModHJhbnNmb3JtYXRpb24pOwogICAgICBpbnZhcmlhbnQoa2V5cy5sZW5ndGggPT09IDEsICdZb3UgbXVzdCBzcGVjaWZ5IGV4YWN0bHkgb25lIHByb3BlcnR5IHBlciB0cmFuc2Zvcm0gb2JqZWN0LiBQYXNzZWQgcHJvcGVydGllczogJXMnLCBzdHJpbmdpZnlTYWZlKHRyYW5zZm9ybWF0aW9uKSk7CiAgICAgIHZhciBrZXkgPSBrZXlzWzBdOwogICAgICB2YXIgdmFsdWUgPSB0cmFuc2Zvcm1hdGlvbltrZXldOwoKICAgICAgX3ZhbGlkYXRlVHJhbnNmb3JtKGtleSwgdmFsdWUsIHRyYW5zZm9ybWF0aW9uKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gX3ZhbGlkYXRlVHJhbnNmb3JtKGtleSwgdmFsdWUsIHRyYW5zZm9ybWF0aW9uKSB7CiAgICBpbnZhcmlhbnQoIXZhbHVlLmdldFZhbHVlLCAnWW91IHBhc3NlZCBhbiBBbmltYXRlZC5WYWx1ZSB0byBhIG5vcm1hbCBjb21wb25lbnQuICcgKyAnWW91IG5lZWQgdG8gd3JhcCB0aGF0IGNvbXBvbmVudCBpbiBhbiBBbmltYXRlZC4gRm9yIGV4YW1wbGUsICcgKyAncmVwbGFjZSA8VmlldyAvPiBieSA8QW5pbWF0ZWQuVmlldyAvPi4nKTsKICAgIHZhciBtdWx0aXZhbHVlVHJhbnNmb3JtcyA9IFsnbWF0cml4JywgJ3RyYW5zbGF0ZSddOwoKICAgIGlmIChtdWx0aXZhbHVlVHJhbnNmb3Jtcy5pbmRleE9mKGtleSkgIT09IC0xKSB7CiAgICAgIGludmFyaWFudChBcnJheS5pc0FycmF5KHZhbHVlKSwgJ1RyYW5zZm9ybSB3aXRoIGtleSBvZiAlcyBtdXN0IGhhdmUgYW4gYXJyYXkgYXMgdGhlIHZhbHVlOiAlcycsIGtleSwgc3RyaW5naWZ5U2FmZSh0cmFuc2Zvcm1hdGlvbikpOwogICAgfQoKICAgIHN3aXRjaCAoa2V5KSB7CiAgICAgIGNhc2UgJ21hdHJpeCc6CiAgICAgICAgaW52YXJpYW50KHZhbHVlLmxlbmd0aCA9PT0gOSB8fCB2YWx1ZS5sZW5ndGggPT09IDE2LCAnTWF0cml4IHRyYW5zZm9ybSBtdXN0IGhhdmUgYSBsZW5ndGggb2YgOSAoMmQpIG9yIDE2ICgzZCkuICcgKyAnUHJvdmlkZWQgbWF0cml4IGhhcyBhIGxlbmd0aCBvZiAlczogJXMnLCB2YWx1ZS5sZW5ndGgsIHN0cmluZ2lmeVNhZmUodHJhbnNmb3JtYXRpb24pKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3RyYW5zbGF0ZSc6CiAgICAgICAgaW52YXJpYW50KHZhbHVlLmxlbmd0aCA9PT0gMiB8fCB2YWx1ZS5sZW5ndGggPT09IDMsICdUcmFuc2Zvcm0gd2l0aCBrZXkgdHJhbnNsYXRlIG11c3QgYmUgYW4gYXJyYXkgb2YgbGVuZ3RoIDIgb3IgMywgZm91bmQgJXM6ICVzJywgdmFsdWUubGVuZ3RoLCBzdHJpbmdpZnlTYWZlKHRyYW5zZm9ybWF0aW9uKSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdyb3RhdGVYJzoKICAgICAgY2FzZSAncm90YXRlWSc6CiAgICAgIGNhc2UgJ3JvdGF0ZVonOgogICAgICBjYXNlICdyb3RhdGUnOgogICAgICBjYXNlICdza2V3WCc6CiAgICAgIGNhc2UgJ3NrZXdZJzoKICAgICAgICBpbnZhcmlhbnQodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJywgJ1RyYW5zZm9ybSB3aXRoIGtleSBvZiAiJXMiIG11c3QgYmUgYSBzdHJpbmc6ICVzJywga2V5LCBzdHJpbmdpZnlTYWZlKHRyYW5zZm9ybWF0aW9uKSk7CiAgICAgICAgaW52YXJpYW50KHZhbHVlLmluZGV4T2YoJ2RlZycpID4gLTEgfHwgdmFsdWUuaW5kZXhPZigncmFkJykgPiAtMSwgJ1JvdGF0ZSB0cmFuc2Zvcm0gbXVzdCBiZSBleHByZXNzZWQgaW4gZGVncmVlcyAoZGVnKSBvciByYWRpYW5zICcgKyAnKHJhZCk6ICVzJywgc3RyaW5naWZ5U2FmZSh0cmFuc2Zvcm1hdGlvbikpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAncGVyc3BlY3RpdmUnOgogICAgICAgIGludmFyaWFudCh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInLCAnVHJhbnNmb3JtIHdpdGgga2V5IG9mICIlcyIgbXVzdCBiZSBhIG51bWJlcjogJXMnLCBrZXksIHN0cmluZ2lmeVNhZmUodHJhbnNmb3JtYXRpb24pKTsKICAgICAgICBpbnZhcmlhbnQodmFsdWUgIT09IDAsICdUcmFuc2Zvcm0gd2l0aCBrZXkgb2YgIiVzIiBjYW5ub3QgYmUgemVybzogJXMnLCBrZXksIHN0cmluZ2lmeVNhZmUodHJhbnNmb3JtYXRpb24pKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3RyYW5zbGF0ZVgnOgogICAgICBjYXNlICd0cmFuc2xhdGVZJzoKICAgICAgY2FzZSAnc2NhbGUnOgogICAgICBjYXNlICdzY2FsZVgnOgogICAgICBjYXNlICdzY2FsZVknOgogICAgICAgIGludmFyaWFudCh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInLCAnVHJhbnNmb3JtIHdpdGgga2V5IG9mICIlcyIgbXVzdCBiZSBhIG51bWJlcjogJXMnLCBrZXksIHN0cmluZ2lmeVNhZmUodHJhbnNmb3JtYXRpb24pKTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaW52YXJpYW50KGZhbHNlLCAnSW52YWxpZCB0cmFuc2Zvcm0gJXM6ICVzJywga2V5LCBzdHJpbmdpZnlTYWZlKHRyYW5zZm9ybWF0aW9uKSk7CiAgICB9CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IHByb2Nlc3NUcmFuc2Zvcm07Cn0sMTUzLFsxNTQsNTIsMTMsMzldLCJwcm9jZXNzVHJhbnNmb3JtIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgTWF0cml4TWF0aCA9IHsKICAgIGNyZWF0ZUlkZW50aXR5TWF0cml4OiBmdW5jdGlvbiBjcmVhdGVJZGVudGl0eU1hdHJpeCgpIHsKICAgICAgcmV0dXJuIFsxLCAwLCAwLCAwLCAwLCAxLCAwLCAwLCAwLCAwLCAxLCAwLCAwLCAwLCAwLCAxXTsKICAgIH0sCiAgICBjcmVhdGVDb3B5OiBmdW5jdGlvbiBjcmVhdGVDb3B5KG0pIHsKICAgICAgcmV0dXJuIFttWzBdLCBtWzFdLCBtWzJdLCBtWzNdLCBtWzRdLCBtWzVdLCBtWzZdLCBtWzddLCBtWzhdLCBtWzldLCBtWzEwXSwgbVsxMV0sIG1bMTJdLCBtWzEzXSwgbVsxNF0sIG1bMTVdXTsKICAgIH0sCiAgICBjcmVhdGVPcnRob2dyYXBoaWM6IGZ1bmN0aW9uIGNyZWF0ZU9ydGhvZ3JhcGhpYyhsZWZ0LCByaWdodCwgYm90dG9tLCB0b3AsIG5lYXIsIGZhcikgewogICAgICB2YXIgYSA9IDIgLyAocmlnaHQgLSBsZWZ0KTsKICAgICAgdmFyIGIgPSAyIC8gKHRvcCAtIGJvdHRvbSk7CiAgICAgIHZhciBjID0gLTIgLyAoZmFyIC0gbmVhcik7CiAgICAgIHZhciB0eCA9IC0ocmlnaHQgKyBsZWZ0KSAvIChyaWdodCAtIGxlZnQpOwogICAgICB2YXIgdHkgPSAtKHRvcCArIGJvdHRvbSkgLyAodG9wIC0gYm90dG9tKTsKICAgICAgdmFyIHR6ID0gLShmYXIgKyBuZWFyKSAvIChmYXIgLSBuZWFyKTsKICAgICAgcmV0dXJuIFthLCAwLCAwLCAwLCAwLCBiLCAwLCAwLCAwLCAwLCBjLCAwLCB0eCwgdHksIHR6LCAxXTsKICAgIH0sCiAgICBjcmVhdGVGcnVzdHVtOiBmdW5jdGlvbiBjcmVhdGVGcnVzdHVtKGxlZnQsIHJpZ2h0LCBib3R0b20sIHRvcCwgbmVhciwgZmFyKSB7CiAgICAgIHZhciByX3dpZHRoID0gMSAvIChyaWdodCAtIGxlZnQpOwogICAgICB2YXIgcl9oZWlnaHQgPSAxIC8gKHRvcCAtIGJvdHRvbSk7CiAgICAgIHZhciByX2RlcHRoID0gMSAvIChuZWFyIC0gZmFyKTsKICAgICAgdmFyIHggPSAyICogKG5lYXIgKiByX3dpZHRoKTsKICAgICAgdmFyIHkgPSAyICogKG5lYXIgKiByX2hlaWdodCk7CiAgICAgIHZhciBBID0gKHJpZ2h0ICsgbGVmdCkgKiByX3dpZHRoOwogICAgICB2YXIgQiA9ICh0b3AgKyBib3R0b20pICogcl9oZWlnaHQ7CiAgICAgIHZhciBDID0gKGZhciArIG5lYXIpICogcl9kZXB0aDsKICAgICAgdmFyIEQgPSAyICogKGZhciAqIG5lYXIgKiByX2RlcHRoKTsKICAgICAgcmV0dXJuIFt4LCAwLCAwLCAwLCAwLCB5LCAwLCAwLCBBLCBCLCBDLCAtMSwgMCwgMCwgRCwgMF07CiAgICB9LAogICAgY3JlYXRlUGVyc3BlY3RpdmU6IGZ1bmN0aW9uIGNyZWF0ZVBlcnNwZWN0aXZlKGZvdkluUmFkaWFucywgYXNwZWN0LCBuZWFyLCBmYXIpIHsKICAgICAgdmFyIGggPSAxIC8gTWF0aC50YW4oZm92SW5SYWRpYW5zIC8gMik7CiAgICAgIHZhciByX2RlcHRoID0gMSAvIChuZWFyIC0gZmFyKTsKICAgICAgdmFyIEMgPSAoZmFyICsgbmVhcikgKiByX2RlcHRoOwogICAgICB2YXIgRCA9IDIgKiAoZmFyICogbmVhciAqIHJfZGVwdGgpOwogICAgICByZXR1cm4gW2ggLyBhc3BlY3QsIDAsIDAsIDAsIDAsIGgsIDAsIDAsIDAsIDAsIEMsIC0xLCAwLCAwLCBELCAwXTsKICAgIH0sCiAgICBjcmVhdGVUcmFuc2xhdGUyZDogZnVuY3Rpb24gY3JlYXRlVHJhbnNsYXRlMmQoeCwgeSkgewogICAgICB2YXIgbWF0ID0gTWF0cml4TWF0aC5jcmVhdGVJZGVudGl0eU1hdHJpeCgpOwogICAgICBNYXRyaXhNYXRoLnJldXNlVHJhbnNsYXRlMmRDb21tYW5kKG1hdCwgeCwgeSk7CiAgICAgIHJldHVybiBtYXQ7CiAgICB9LAogICAgcmV1c2VUcmFuc2xhdGUyZENvbW1hbmQ6IGZ1bmN0aW9uIHJldXNlVHJhbnNsYXRlMmRDb21tYW5kKG1hdHJpeENvbW1hbmQsIHgsIHkpIHsKICAgICAgbWF0cml4Q29tbWFuZFsxMl0gPSB4OwogICAgICBtYXRyaXhDb21tYW5kWzEzXSA9IHk7CiAgICB9LAogICAgcmV1c2VUcmFuc2xhdGUzZENvbW1hbmQ6IGZ1bmN0aW9uIHJldXNlVHJhbnNsYXRlM2RDb21tYW5kKG1hdHJpeENvbW1hbmQsIHgsIHksIHopIHsKICAgICAgbWF0cml4Q29tbWFuZFsxMl0gPSB4OwogICAgICBtYXRyaXhDb21tYW5kWzEzXSA9IHk7CiAgICAgIG1hdHJpeENvbW1hbmRbMTRdID0gejsKICAgIH0sCiAgICBjcmVhdGVTY2FsZTogZnVuY3Rpb24gY3JlYXRlU2NhbGUoZmFjdG9yKSB7CiAgICAgIHZhciBtYXQgPSBNYXRyaXhNYXRoLmNyZWF0ZUlkZW50aXR5TWF0cml4KCk7CiAgICAgIE1hdHJpeE1hdGgucmV1c2VTY2FsZUNvbW1hbmQobWF0LCBmYWN0b3IpOwogICAgICByZXR1cm4gbWF0OwogICAgfSwKICAgIHJldXNlU2NhbGVDb21tYW5kOiBmdW5jdGlvbiByZXVzZVNjYWxlQ29tbWFuZChtYXRyaXhDb21tYW5kLCBmYWN0b3IpIHsKICAgICAgbWF0cml4Q29tbWFuZFswXSA9IGZhY3RvcjsKICAgICAgbWF0cml4Q29tbWFuZFs1XSA9IGZhY3RvcjsKICAgIH0sCiAgICByZXVzZVNjYWxlM2RDb21tYW5kOiBmdW5jdGlvbiByZXVzZVNjYWxlM2RDb21tYW5kKG1hdHJpeENvbW1hbmQsIHgsIHksIHopIHsKICAgICAgbWF0cml4Q29tbWFuZFswXSA9IHg7CiAgICAgIG1hdHJpeENvbW1hbmRbNV0gPSB5OwogICAgICBtYXRyaXhDb21tYW5kWzEwXSA9IHo7CiAgICB9LAogICAgcmV1c2VQZXJzcGVjdGl2ZUNvbW1hbmQ6IGZ1bmN0aW9uIHJldXNlUGVyc3BlY3RpdmVDb21tYW5kKG1hdHJpeENvbW1hbmQsIHApIHsKICAgICAgbWF0cml4Q29tbWFuZFsxMV0gPSAtMSAvIHA7CiAgICB9LAogICAgcmV1c2VTY2FsZVhDb21tYW5kOiBmdW5jdGlvbiByZXVzZVNjYWxlWENvbW1hbmQobWF0cml4Q29tbWFuZCwgZmFjdG9yKSB7CiAgICAgIG1hdHJpeENvbW1hbmRbMF0gPSBmYWN0b3I7CiAgICB9LAogICAgcmV1c2VTY2FsZVlDb21tYW5kOiBmdW5jdGlvbiByZXVzZVNjYWxlWUNvbW1hbmQobWF0cml4Q29tbWFuZCwgZmFjdG9yKSB7CiAgICAgIG1hdHJpeENvbW1hbmRbNV0gPSBmYWN0b3I7CiAgICB9LAogICAgcmV1c2VTY2FsZVpDb21tYW5kOiBmdW5jdGlvbiByZXVzZVNjYWxlWkNvbW1hbmQobWF0cml4Q29tbWFuZCwgZmFjdG9yKSB7CiAgICAgIG1hdHJpeENvbW1hbmRbMTBdID0gZmFjdG9yOwogICAgfSwKICAgIHJldXNlUm90YXRlWENvbW1hbmQ6IGZ1bmN0aW9uIHJldXNlUm90YXRlWENvbW1hbmQobWF0cml4Q29tbWFuZCwgcmFkaWFucykgewogICAgICBtYXRyaXhDb21tYW5kWzVdID0gTWF0aC5jb3MocmFkaWFucyk7CiAgICAgIG1hdHJpeENvbW1hbmRbNl0gPSBNYXRoLnNpbihyYWRpYW5zKTsKICAgICAgbWF0cml4Q29tbWFuZFs5XSA9IC1NYXRoLnNpbihyYWRpYW5zKTsKICAgICAgbWF0cml4Q29tbWFuZFsxMF0gPSBNYXRoLmNvcyhyYWRpYW5zKTsKICAgIH0sCiAgICByZXVzZVJvdGF0ZVlDb21tYW5kOiBmdW5jdGlvbiByZXVzZVJvdGF0ZVlDb21tYW5kKG1hdHJpeENvbW1hbmQsIGFtb3VudCkgewogICAgICBtYXRyaXhDb21tYW5kWzBdID0gTWF0aC5jb3MoYW1vdW50KTsKICAgICAgbWF0cml4Q29tbWFuZFsyXSA9IC1NYXRoLnNpbihhbW91bnQpOwogICAgICBtYXRyaXhDb21tYW5kWzhdID0gTWF0aC5zaW4oYW1vdW50KTsKICAgICAgbWF0cml4Q29tbWFuZFsxMF0gPSBNYXRoLmNvcyhhbW91bnQpOwogICAgfSwKICAgIHJldXNlUm90YXRlWkNvbW1hbmQ6IGZ1bmN0aW9uIHJldXNlUm90YXRlWkNvbW1hbmQobWF0cml4Q29tbWFuZCwgcmFkaWFucykgewogICAgICBtYXRyaXhDb21tYW5kWzBdID0gTWF0aC5jb3MocmFkaWFucyk7CiAgICAgIG1hdHJpeENvbW1hbmRbMV0gPSBNYXRoLnNpbihyYWRpYW5zKTsKICAgICAgbWF0cml4Q29tbWFuZFs0XSA9IC1NYXRoLnNpbihyYWRpYW5zKTsKICAgICAgbWF0cml4Q29tbWFuZFs1XSA9IE1hdGguY29zKHJhZGlhbnMpOwogICAgfSwKICAgIGNyZWF0ZVJvdGF0ZVo6IGZ1bmN0aW9uIGNyZWF0ZVJvdGF0ZVoocmFkaWFucykgewogICAgICB2YXIgbWF0ID0gTWF0cml4TWF0aC5jcmVhdGVJZGVudGl0eU1hdHJpeCgpOwogICAgICBNYXRyaXhNYXRoLnJldXNlUm90YXRlWkNvbW1hbmQobWF0LCByYWRpYW5zKTsKICAgICAgcmV0dXJuIG1hdDsKICAgIH0sCiAgICByZXVzZVNrZXdYQ29tbWFuZDogZnVuY3Rpb24gcmV1c2VTa2V3WENvbW1hbmQobWF0cml4Q29tbWFuZCwgcmFkaWFucykgewogICAgICBtYXRyaXhDb21tYW5kWzRdID0gTWF0aC50YW4ocmFkaWFucyk7CiAgICB9LAogICAgcmV1c2VTa2V3WUNvbW1hbmQ6IGZ1bmN0aW9uIHJldXNlU2tld1lDb21tYW5kKG1hdHJpeENvbW1hbmQsIHJhZGlhbnMpIHsKICAgICAgbWF0cml4Q29tbWFuZFsxXSA9IE1hdGgudGFuKHJhZGlhbnMpOwogICAgfSwKICAgIG11bHRpcGx5SW50bzogZnVuY3Rpb24gbXVsdGlwbHlJbnRvKG91dCwgYSwgYikgewogICAgICB2YXIgYTAwID0gYVswXSwKICAgICAgICAgIGEwMSA9IGFbMV0sCiAgICAgICAgICBhMDIgPSBhWzJdLAogICAgICAgICAgYTAzID0gYVszXSwKICAgICAgICAgIGExMCA9IGFbNF0sCiAgICAgICAgICBhMTEgPSBhWzVdLAogICAgICAgICAgYTEyID0gYVs2XSwKICAgICAgICAgIGExMyA9IGFbN10sCiAgICAgICAgICBhMjAgPSBhWzhdLAogICAgICAgICAgYTIxID0gYVs5XSwKICAgICAgICAgIGEyMiA9IGFbMTBdLAogICAgICAgICAgYTIzID0gYVsxMV0sCiAgICAgICAgICBhMzAgPSBhWzEyXSwKICAgICAgICAgIGEzMSA9IGFbMTNdLAogICAgICAgICAgYTMyID0gYVsxNF0sCiAgICAgICAgICBhMzMgPSBhWzE1XTsKICAgICAgdmFyIGIwID0gYlswXSwKICAgICAgICAgIGIxID0gYlsxXSwKICAgICAgICAgIGIyID0gYlsyXSwKICAgICAgICAgIGIzID0gYlszXTsKICAgICAgb3V0WzBdID0gYjAgKiBhMDAgKyBiMSAqIGExMCArIGIyICogYTIwICsgYjMgKiBhMzA7CiAgICAgIG91dFsxXSA9IGIwICogYTAxICsgYjEgKiBhMTEgKyBiMiAqIGEyMSArIGIzICogYTMxOwogICAgICBvdXRbMl0gPSBiMCAqIGEwMiArIGIxICogYTEyICsgYjIgKiBhMjIgKyBiMyAqIGEzMjsKICAgICAgb3V0WzNdID0gYjAgKiBhMDMgKyBiMSAqIGExMyArIGIyICogYTIzICsgYjMgKiBhMzM7CiAgICAgIGIwID0gYls0XTsKICAgICAgYjEgPSBiWzVdOwogICAgICBiMiA9IGJbNl07CiAgICAgIGIzID0gYls3XTsKICAgICAgb3V0WzRdID0gYjAgKiBhMDAgKyBiMSAqIGExMCArIGIyICogYTIwICsgYjMgKiBhMzA7CiAgICAgIG91dFs1XSA9IGIwICogYTAxICsgYjEgKiBhMTEgKyBiMiAqIGEyMSArIGIzICogYTMxOwogICAgICBvdXRbNl0gPSBiMCAqIGEwMiArIGIxICogYTEyICsgYjIgKiBhMjIgKyBiMyAqIGEzMjsKICAgICAgb3V0WzddID0gYjAgKiBhMDMgKyBiMSAqIGExMyArIGIyICogYTIzICsgYjMgKiBhMzM7CiAgICAgIGIwID0gYls4XTsKICAgICAgYjEgPSBiWzldOwogICAgICBiMiA9IGJbMTBdOwogICAgICBiMyA9IGJbMTFdOwogICAgICBvdXRbOF0gPSBiMCAqIGEwMCArIGIxICogYTEwICsgYjIgKiBhMjAgKyBiMyAqIGEzMDsKICAgICAgb3V0WzldID0gYjAgKiBhMDEgKyBiMSAqIGExMSArIGIyICogYTIxICsgYjMgKiBhMzE7CiAgICAgIG91dFsxMF0gPSBiMCAqIGEwMiArIGIxICogYTEyICsgYjIgKiBhMjIgKyBiMyAqIGEzMjsKICAgICAgb3V0WzExXSA9IGIwICogYTAzICsgYjEgKiBhMTMgKyBiMiAqIGEyMyArIGIzICogYTMzOwogICAgICBiMCA9IGJbMTJdOwogICAgICBiMSA9IGJbMTNdOwogICAgICBiMiA9IGJbMTRdOwogICAgICBiMyA9IGJbMTVdOwogICAgICBvdXRbMTJdID0gYjAgKiBhMDAgKyBiMSAqIGExMCArIGIyICogYTIwICsgYjMgKiBhMzA7CiAgICAgIG91dFsxM10gPSBiMCAqIGEwMSArIGIxICogYTExICsgYjIgKiBhMjEgKyBiMyAqIGEzMTsKICAgICAgb3V0WzE0XSA9IGIwICogYTAyICsgYjEgKiBhMTIgKyBiMiAqIGEyMiArIGIzICogYTMyOwogICAgICBvdXRbMTVdID0gYjAgKiBhMDMgKyBiMSAqIGExMyArIGIyICogYTIzICsgYjMgKiBhMzM7CiAgICB9LAogICAgZGV0ZXJtaW5hbnQ6IGZ1bmN0aW9uIGRldGVybWluYW50KG1hdHJpeCkgewogICAgICB2YXIgX21hdHJpeCA9IGJhYmVsSGVscGVycy5zbGljZWRUb0FycmF5KG1hdHJpeCwgMTYpLAogICAgICAgICAgbTAwID0gX21hdHJpeFswXSwKICAgICAgICAgIG0wMSA9IF9tYXRyaXhbMV0sCiAgICAgICAgICBtMDIgPSBfbWF0cml4WzJdLAogICAgICAgICAgbTAzID0gX21hdHJpeFszXSwKICAgICAgICAgIG0xMCA9IF9tYXRyaXhbNF0sCiAgICAgICAgICBtMTEgPSBfbWF0cml4WzVdLAogICAgICAgICAgbTEyID0gX21hdHJpeFs2XSwKICAgICAgICAgIG0xMyA9IF9tYXRyaXhbN10sCiAgICAgICAgICBtMjAgPSBfbWF0cml4WzhdLAogICAgICAgICAgbTIxID0gX21hdHJpeFs5XSwKICAgICAgICAgIG0yMiA9IF9tYXRyaXhbMTBdLAogICAgICAgICAgbTIzID0gX21hdHJpeFsxMV0sCiAgICAgICAgICBtMzAgPSBfbWF0cml4WzEyXSwKICAgICAgICAgIG0zMSA9IF9tYXRyaXhbMTNdLAogICAgICAgICAgbTMyID0gX21hdHJpeFsxNF0sCiAgICAgICAgICBtMzMgPSBfbWF0cml4WzE1XTsKCiAgICAgIHJldHVybiBtMDMgKiBtMTIgKiBtMjEgKiBtMzAgLSBtMDIgKiBtMTMgKiBtMjEgKiBtMzAgLSBtMDMgKiBtMTEgKiBtMjIgKiBtMzAgKyBtMDEgKiBtMTMgKiBtMjIgKiBtMzAgKyBtMDIgKiBtMTEgKiBtMjMgKiBtMzAgLSBtMDEgKiBtMTIgKiBtMjMgKiBtMzAgLSBtMDMgKiBtMTIgKiBtMjAgKiBtMzEgKyBtMDIgKiBtMTMgKiBtMjAgKiBtMzEgKyBtMDMgKiBtMTAgKiBtMjIgKiBtMzEgLSBtMDAgKiBtMTMgKiBtMjIgKiBtMzEgLSBtMDIgKiBtMTAgKiBtMjMgKiBtMzEgKyBtMDAgKiBtMTIgKiBtMjMgKiBtMzEgKyBtMDMgKiBtMTEgKiBtMjAgKiBtMzIgLSBtMDEgKiBtMTMgKiBtMjAgKiBtMzIgLSBtMDMgKiBtMTAgKiBtMjEgKiBtMzIgKyBtMDAgKiBtMTMgKiBtMjEgKiBtMzIgKyBtMDEgKiBtMTAgKiBtMjMgKiBtMzIgLSBtMDAgKiBtMTEgKiBtMjMgKiBtMzIgLSBtMDIgKiBtMTEgKiBtMjAgKiBtMzMgKyBtMDEgKiBtMTIgKiBtMjAgKiBtMzMgKyBtMDIgKiBtMTAgKiBtMjEgKiBtMzMgLSBtMDAgKiBtMTIgKiBtMjEgKiBtMzMgLSBtMDEgKiBtMTAgKiBtMjIgKiBtMzMgKyBtMDAgKiBtMTEgKiBtMjIgKiBtMzM7CiAgICB9LAogICAgaW52ZXJzZTogZnVuY3Rpb24gaW52ZXJzZShtYXRyaXgpIHsKICAgICAgdmFyIGRldCA9IE1hdHJpeE1hdGguZGV0ZXJtaW5hbnQobWF0cml4KTsKCiAgICAgIGlmICghZGV0KSB7CiAgICAgICAgcmV0dXJuIG1hdHJpeDsKICAgICAgfQoKICAgICAgdmFyIF9tYXRyaXgyID0gYmFiZWxIZWxwZXJzLnNsaWNlZFRvQXJyYXkobWF0cml4LCAxNiksCiAgICAgICAgICBtMDAgPSBfbWF0cml4MlswXSwKICAgICAgICAgIG0wMSA9IF9tYXRyaXgyWzFdLAogICAgICAgICAgbTAyID0gX21hdHJpeDJbMl0sCiAgICAgICAgICBtMDMgPSBfbWF0cml4MlszXSwKICAgICAgICAgIG0xMCA9IF9tYXRyaXgyWzRdLAogICAgICAgICAgbTExID0gX21hdHJpeDJbNV0sCiAgICAgICAgICBtMTIgPSBfbWF0cml4Mls2XSwKICAgICAgICAgIG0xMyA9IF9tYXRyaXgyWzddLAogICAgICAgICAgbTIwID0gX21hdHJpeDJbOF0sCiAgICAgICAgICBtMjEgPSBfbWF0cml4Mls5XSwKICAgICAgICAgIG0yMiA9IF9tYXRyaXgyWzEwXSwKICAgICAgICAgIG0yMyA9IF9tYXRyaXgyWzExXSwKICAgICAgICAgIG0zMCA9IF9tYXRyaXgyWzEyXSwKICAgICAgICAgIG0zMSA9IF9tYXRyaXgyWzEzXSwKICAgICAgICAgIG0zMiA9IF9tYXRyaXgyWzE0XSwKICAgICAgICAgIG0zMyA9IF9tYXRyaXgyWzE1XTsKCiAgICAgIHJldHVybiBbKG0xMiAqIG0yMyAqIG0zMSAtIG0xMyAqIG0yMiAqIG0zMSArIG0xMyAqIG0yMSAqIG0zMiAtIG0xMSAqIG0yMyAqIG0zMiAtIG0xMiAqIG0yMSAqIG0zMyArIG0xMSAqIG0yMiAqIG0zMykgLyBkZXQsIChtMDMgKiBtMjIgKiBtMzEgLSBtMDIgKiBtMjMgKiBtMzEgLSBtMDMgKiBtMjEgKiBtMzIgKyBtMDEgKiBtMjMgKiBtMzIgKyBtMDIgKiBtMjEgKiBtMzMgLSBtMDEgKiBtMjIgKiBtMzMpIC8gZGV0LCAobTAyICogbTEzICogbTMxIC0gbTAzICogbTEyICogbTMxICsgbTAzICogbTExICogbTMyIC0gbTAxICogbTEzICogbTMyIC0gbTAyICogbTExICogbTMzICsgbTAxICogbTEyICogbTMzKSAvIGRldCwgKG0wMyAqIG0xMiAqIG0yMSAtIG0wMiAqIG0xMyAqIG0yMSAtIG0wMyAqIG0xMSAqIG0yMiArIG0wMSAqIG0xMyAqIG0yMiArIG0wMiAqIG0xMSAqIG0yMyAtIG0wMSAqIG0xMiAqIG0yMykgLyBkZXQsIChtMTMgKiBtMjIgKiBtMzAgLSBtMTIgKiBtMjMgKiBtMzAgLSBtMTMgKiBtMjAgKiBtMzIgKyBtMTAgKiBtMjMgKiBtMzIgKyBtMTIgKiBtMjAgKiBtMzMgLSBtMTAgKiBtMjIgKiBtMzMpIC8gZGV0LCAobTAyICogbTIzICogbTMwIC0gbTAzICogbTIyICogbTMwICsgbTAzICogbTIwICogbTMyIC0gbTAwICogbTIzICogbTMyIC0gbTAyICogbTIwICogbTMzICsgbTAwICogbTIyICogbTMzKSAvIGRldCwgKG0wMyAqIG0xMiAqIG0zMCAtIG0wMiAqIG0xMyAqIG0zMCAtIG0wMyAqIG0xMCAqIG0zMiArIG0wMCAqIG0xMyAqIG0zMiArIG0wMiAqIG0xMCAqIG0zMyAtIG0wMCAqIG0xMiAqIG0zMykgLyBkZXQsIChtMDIgKiBtMTMgKiBtMjAgLSBtMDMgKiBtMTIgKiBtMjAgKyBtMDMgKiBtMTAgKiBtMjIgLSBtMDAgKiBtMTMgKiBtMjIgLSBtMDIgKiBtMTAgKiBtMjMgKyBtMDAgKiBtMTIgKiBtMjMpIC8gZGV0LCAobTExICogbTIzICogbTMwIC0gbTEzICogbTIxICogbTMwICsgbTEzICogbTIwICogbTMxIC0gbTEwICogbTIzICogbTMxIC0gbTExICogbTIwICogbTMzICsgbTEwICogbTIxICogbTMzKSAvIGRldCwgKG0wMyAqIG0yMSAqIG0zMCAtIG0wMSAqIG0yMyAqIG0zMCAtIG0wMyAqIG0yMCAqIG0zMSArIG0wMCAqIG0yMyAqIG0zMSArIG0wMSAqIG0yMCAqIG0zMyAtIG0wMCAqIG0yMSAqIG0zMykgLyBkZXQsIChtMDEgKiBtMTMgKiBtMzAgLSBtMDMgKiBtMTEgKiBtMzAgKyBtMDMgKiBtMTAgKiBtMzEgLSBtMDAgKiBtMTMgKiBtMzEgLSBtMDEgKiBtMTAgKiBtMzMgKyBtMDAgKiBtMTEgKiBtMzMpIC8gZGV0LCAobTAzICogbTExICogbTIwIC0gbTAxICogbTEzICogbTIwIC0gbTAzICogbTEwICogbTIxICsgbTAwICogbTEzICogbTIxICsgbTAxICogbTEwICogbTIzIC0gbTAwICogbTExICogbTIzKSAvIGRldCwgKG0xMiAqIG0yMSAqIG0zMCAtIG0xMSAqIG0yMiAqIG0zMCAtIG0xMiAqIG0yMCAqIG0zMSArIG0xMCAqIG0yMiAqIG0zMSArIG0xMSAqIG0yMCAqIG0zMiAtIG0xMCAqIG0yMSAqIG0zMikgLyBkZXQsIChtMDEgKiBtMjIgKiBtMzAgLSBtMDIgKiBtMjEgKiBtMzAgKyBtMDIgKiBtMjAgKiBtMzEgLSBtMDAgKiBtMjIgKiBtMzEgLSBtMDEgKiBtMjAgKiBtMzIgKyBtMDAgKiBtMjEgKiBtMzIpIC8gZGV0LCAobTAyICogbTExICogbTMwIC0gbTAxICogbTEyICogbTMwIC0gbTAyICogbTEwICogbTMxICsgbTAwICogbTEyICogbTMxICsgbTAxICogbTEwICogbTMyIC0gbTAwICogbTExICogbTMyKSAvIGRldCwgKG0wMSAqIG0xMiAqIG0yMCAtIG0wMiAqIG0xMSAqIG0yMCArIG0wMiAqIG0xMCAqIG0yMSAtIG0wMCAqIG0xMiAqIG0yMSAtIG0wMSAqIG0xMCAqIG0yMiArIG0wMCAqIG0xMSAqIG0yMikgLyBkZXRdOwogICAgfSwKICAgIHRyYW5zcG9zZTogZnVuY3Rpb24gdHJhbnNwb3NlKG0pIHsKICAgICAgcmV0dXJuIFttWzBdLCBtWzRdLCBtWzhdLCBtWzEyXSwgbVsxXSwgbVs1XSwgbVs5XSwgbVsxM10sIG1bMl0sIG1bNl0sIG1bMTBdLCBtWzE0XSwgbVszXSwgbVs3XSwgbVsxMV0sIG1bMTVdXTsKICAgIH0sCiAgICBtdWx0aXBseVZlY3RvckJ5TWF0cml4OiBmdW5jdGlvbiBtdWx0aXBseVZlY3RvckJ5TWF0cml4KHYsIG0pIHsKICAgICAgdmFyIF92ID0gYmFiZWxIZWxwZXJzLnNsaWNlZFRvQXJyYXkodiwgNCksCiAgICAgICAgICB2eCA9IF92WzBdLAogICAgICAgICAgdnkgPSBfdlsxXSwKICAgICAgICAgIHZ6ID0gX3ZbMl0sCiAgICAgICAgICB2dyA9IF92WzNdOwoKICAgICAgcmV0dXJuIFt2eCAqIG1bMF0gKyB2eSAqIG1bNF0gKyB2eiAqIG1bOF0gKyB2dyAqIG1bMTJdLCB2eCAqIG1bMV0gKyB2eSAqIG1bNV0gKyB2eiAqIG1bOV0gKyB2dyAqIG1bMTNdLCB2eCAqIG1bMl0gKyB2eSAqIG1bNl0gKyB2eiAqIG1bMTBdICsgdncgKiBtWzE0XSwgdnggKiBtWzNdICsgdnkgKiBtWzddICsgdnogKiBtWzExXSArIHZ3ICogbVsxNV1dOwogICAgfSwKICAgIHYzTGVuZ3RoOiBmdW5jdGlvbiB2M0xlbmd0aChhKSB7CiAgICAgIHJldHVybiBNYXRoLnNxcnQoYVswXSAqIGFbMF0gKyBhWzFdICogYVsxXSArIGFbMl0gKiBhWzJdKTsKICAgIH0sCiAgICB2M05vcm1hbGl6ZTogZnVuY3Rpb24gdjNOb3JtYWxpemUodmVjdG9yLCB2M0xlbmd0aCkgewogICAgICB2YXIgaW0gPSAxIC8gKHYzTGVuZ3RoIHx8IE1hdHJpeE1hdGgudjNMZW5ndGgodmVjdG9yKSk7CiAgICAgIHJldHVybiBbdmVjdG9yWzBdICogaW0sIHZlY3RvclsxXSAqIGltLCB2ZWN0b3JbMl0gKiBpbV07CiAgICB9LAogICAgdjNEb3Q6IGZ1bmN0aW9uIHYzRG90KGEsIGIpIHsKICAgICAgcmV0dXJuIGFbMF0gKiBiWzBdICsgYVsxXSAqIGJbMV0gKyBhWzJdICogYlsyXTsKICAgIH0sCiAgICB2M0NvbWJpbmU6IGZ1bmN0aW9uIHYzQ29tYmluZShhLCBiLCBhU2NhbGUsIGJTY2FsZSkgewogICAgICByZXR1cm4gW2FTY2FsZSAqIGFbMF0gKyBiU2NhbGUgKiBiWzBdLCBhU2NhbGUgKiBhWzFdICsgYlNjYWxlICogYlsxXSwgYVNjYWxlICogYVsyXSArIGJTY2FsZSAqIGJbMl1dOwogICAgfSwKICAgIHYzQ3Jvc3M6IGZ1bmN0aW9uIHYzQ3Jvc3MoYSwgYikgewogICAgICByZXR1cm4gW2FbMV0gKiBiWzJdIC0gYVsyXSAqIGJbMV0sIGFbMl0gKiBiWzBdIC0gYVswXSAqIGJbMl0sIGFbMF0gKiBiWzFdIC0gYVsxXSAqIGJbMF1dOwogICAgfSwKICAgIHF1YXRlcm5pb25Ub0RlZ3JlZXNYWVo6IGZ1bmN0aW9uIHF1YXRlcm5pb25Ub0RlZ3JlZXNYWVoocSwgbWF0cml4LCByb3cpIHsKICAgICAgdmFyIF9xID0gYmFiZWxIZWxwZXJzLnNsaWNlZFRvQXJyYXkocSwgNCksCiAgICAgICAgICBxeCA9IF9xWzBdLAogICAgICAgICAgcXkgPSBfcVsxXSwKICAgICAgICAgIHF6ID0gX3FbMl0sCiAgICAgICAgICBxdyA9IF9xWzNdOwoKICAgICAgdmFyIHF3MiA9IHF3ICogcXc7CiAgICAgIHZhciBxeDIgPSBxeCAqIHF4OwogICAgICB2YXIgcXkyID0gcXkgKiBxeTsKICAgICAgdmFyIHF6MiA9IHF6ICogcXo7CiAgICAgIHZhciB0ZXN0ID0gcXggKiBxeSArIHF6ICogcXc7CiAgICAgIHZhciB1bml0ID0gcXcyICsgcXgyICsgcXkyICsgcXoyOwogICAgICB2YXIgY29udiA9IDE4MCAvIE1hdGguUEk7CgogICAgICBpZiAodGVzdCA+IDAuNDk5OTkgKiB1bml0KSB7CiAgICAgICAgcmV0dXJuIFswLCAyICogTWF0aC5hdGFuMihxeCwgcXcpICogY29udiwgOTBdOwogICAgICB9CgogICAgICBpZiAodGVzdCA8IC0wLjQ5OTk5ICogdW5pdCkgewogICAgICAgIHJldHVybiBbMCwgLTIgKiBNYXRoLmF0YW4yKHF4LCBxdykgKiBjb252LCAtOTBdOwogICAgICB9CgogICAgICByZXR1cm4gW01hdHJpeE1hdGgucm91bmRUbzNQbGFjZXMoTWF0aC5hdGFuMigyICogcXggKiBxdyAtIDIgKiBxeSAqIHF6LCAxIC0gMiAqIHF4MiAtIDIgKiBxejIpICogY29udiksIE1hdHJpeE1hdGgucm91bmRUbzNQbGFjZXMoTWF0aC5hdGFuMigyICogcXkgKiBxdyAtIDIgKiBxeCAqIHF6LCAxIC0gMiAqIHF5MiAtIDIgKiBxejIpICogY29udiksIE1hdHJpeE1hdGgucm91bmRUbzNQbGFjZXMoTWF0aC5hc2luKDIgKiBxeCAqIHF5ICsgMiAqIHF6ICogcXcpICogY29udildOwogICAgfSwKICAgIHJvdW5kVG8zUGxhY2VzOiBmdW5jdGlvbiByb3VuZFRvM1BsYWNlcyhuKSB7CiAgICAgIHZhciBhcnIgPSBuLnRvU3RyaW5nKCkuc3BsaXQoJ2UnKTsKICAgICAgcmV0dXJuIE1hdGgucm91bmQoYXJyWzBdICsgJ2UnICsgKGFyclsxXSA/ICthcnJbMV0gLSAzIDogMykpICogMC4wMDE7CiAgICB9LAogICAgZGVjb21wb3NlTWF0cml4OiBmdW5jdGlvbiBkZWNvbXBvc2VNYXRyaXgodHJhbnNmb3JtTWF0cml4KSB7CiAgICAgIGludmFyaWFudCh0cmFuc2Zvcm1NYXRyaXgubGVuZ3RoID09PSAxNiwgJ01hdHJpeCBkZWNvbXBvc2l0aW9uIG5lZWRzIGEgbGlzdCBvZiAzZCBtYXRyaXggdmFsdWVzLCByZWNlaXZlZCAlcycsIHRyYW5zZm9ybU1hdHJpeCk7CiAgICAgIHZhciBwZXJzcGVjdGl2ZSA9IFtdOwogICAgICB2YXIgcXVhdGVybmlvbiA9IFtdOwogICAgICB2YXIgc2NhbGUgPSBbXTsKICAgICAgdmFyIHNrZXcgPSBbXTsKICAgICAgdmFyIHRyYW5zbGF0aW9uID0gW107CgogICAgICBpZiAoIXRyYW5zZm9ybU1hdHJpeFsxNV0pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBtYXRyaXggPSBbXTsKICAgICAgdmFyIHBlcnNwZWN0aXZlTWF0cml4ID0gW107CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICAgIG1hdHJpeC5wdXNoKFtdKTsKCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCA0OyBqKyspIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHRyYW5zZm9ybU1hdHJpeFtpICogNCArIGpdIC8gdHJhbnNmb3JtTWF0cml4WzE1XTsKICAgICAgICAgIG1hdHJpeFtpXS5wdXNoKHZhbHVlKTsKICAgICAgICAgIHBlcnNwZWN0aXZlTWF0cml4LnB1c2goaiA9PT0gMyA/IDAgOiB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBwZXJzcGVjdGl2ZU1hdHJpeFsxNV0gPSAxOwoKICAgICAgaWYgKCFNYXRyaXhNYXRoLmRldGVybWluYW50KHBlcnNwZWN0aXZlTWF0cml4KSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKG1hdHJpeFswXVszXSAhPT0gMCB8fCBtYXRyaXhbMV1bM10gIT09IDAgfHwgbWF0cml4WzJdWzNdICE9PSAwKSB7CiAgICAgICAgdmFyIHJpZ2h0SGFuZFNpZGUgPSBbbWF0cml4WzBdWzNdLCBtYXRyaXhbMV1bM10sIG1hdHJpeFsyXVszXSwgbWF0cml4WzNdWzNdXTsKICAgICAgICB2YXIgaW52ZXJzZVBlcnNwZWN0aXZlTWF0cml4ID0gTWF0cml4TWF0aC5pbnZlcnNlKHBlcnNwZWN0aXZlTWF0cml4KTsKICAgICAgICB2YXIgdHJhbnNwb3NlZEludmVyc2VQZXJzcGVjdGl2ZU1hdHJpeCA9IE1hdHJpeE1hdGgudHJhbnNwb3NlKGludmVyc2VQZXJzcGVjdGl2ZU1hdHJpeCk7CiAgICAgICAgdmFyIHBlcnNwZWN0aXZlID0gTWF0cml4TWF0aC5tdWx0aXBseVZlY3RvckJ5TWF0cml4KHJpZ2h0SGFuZFNpZGUsIHRyYW5zcG9zZWRJbnZlcnNlUGVyc3BlY3RpdmVNYXRyaXgpOwogICAgICB9IGVsc2UgewogICAgICAgIHBlcnNwZWN0aXZlWzBdID0gcGVyc3BlY3RpdmVbMV0gPSBwZXJzcGVjdGl2ZVsyXSA9IDA7CiAgICAgICAgcGVyc3BlY3RpdmVbM10gPSAxOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKykgewogICAgICAgIHRyYW5zbGF0aW9uW2ldID0gbWF0cml4WzNdW2ldOwogICAgICB9CgogICAgICB2YXIgcm93ID0gW107CgogICAgICBmb3IgKGkgPSAwOyBpIDwgMzsgaSsrKSB7CiAgICAgICAgcm93W2ldID0gW21hdHJpeFtpXVswXSwgbWF0cml4W2ldWzFdLCBtYXRyaXhbaV1bMl1dOwogICAgICB9CgogICAgICBzY2FsZVswXSA9IE1hdHJpeE1hdGgudjNMZW5ndGgocm93WzBdKTsKICAgICAgcm93WzBdID0gTWF0cml4TWF0aC52M05vcm1hbGl6ZShyb3dbMF0sIHNjYWxlWzBdKTsKICAgICAgc2tld1swXSA9IE1hdHJpeE1hdGgudjNEb3Qocm93WzBdLCByb3dbMV0pOwogICAgICByb3dbMV0gPSBNYXRyaXhNYXRoLnYzQ29tYmluZShyb3dbMV0sIHJvd1swXSwgMS4wLCAtc2tld1swXSk7CiAgICAgIHNrZXdbMF0gPSBNYXRyaXhNYXRoLnYzRG90KHJvd1swXSwgcm93WzFdKTsKICAgICAgcm93WzFdID0gTWF0cml4TWF0aC52M0NvbWJpbmUocm93WzFdLCByb3dbMF0sIDEuMCwgLXNrZXdbMF0pOwogICAgICBzY2FsZVsxXSA9IE1hdHJpeE1hdGgudjNMZW5ndGgocm93WzFdKTsKICAgICAgcm93WzFdID0gTWF0cml4TWF0aC52M05vcm1hbGl6ZShyb3dbMV0sIHNjYWxlWzFdKTsKICAgICAgc2tld1swXSAvPSBzY2FsZVsxXTsKICAgICAgc2tld1sxXSA9IE1hdHJpeE1hdGgudjNEb3Qocm93WzBdLCByb3dbMl0pOwogICAgICByb3dbMl0gPSBNYXRyaXhNYXRoLnYzQ29tYmluZShyb3dbMl0sIHJvd1swXSwgMS4wLCAtc2tld1sxXSk7CiAgICAgIHNrZXdbMl0gPSBNYXRyaXhNYXRoLnYzRG90KHJvd1sxXSwgcm93WzJdKTsKICAgICAgcm93WzJdID0gTWF0cml4TWF0aC52M0NvbWJpbmUocm93WzJdLCByb3dbMV0sIDEuMCwgLXNrZXdbMl0pOwogICAgICBzY2FsZVsyXSA9IE1hdHJpeE1hdGgudjNMZW5ndGgocm93WzJdKTsKICAgICAgcm93WzJdID0gTWF0cml4TWF0aC52M05vcm1hbGl6ZShyb3dbMl0sIHNjYWxlWzJdKTsKICAgICAgc2tld1sxXSAvPSBzY2FsZVsyXTsKICAgICAgc2tld1syXSAvPSBzY2FsZVsyXTsKICAgICAgdmFyIHBkdW0zID0gTWF0cml4TWF0aC52M0Nyb3NzKHJvd1sxXSwgcm93WzJdKTsKCiAgICAgIGlmIChNYXRyaXhNYXRoLnYzRG90KHJvd1swXSwgcGR1bTMpIDwgMCkgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgICAgICAgIHNjYWxlW2ldICo9IC0xOwogICAgICAgICAgcm93W2ldWzBdICo9IC0xOwogICAgICAgICAgcm93W2ldWzFdICo9IC0xOwogICAgICAgICAgcm93W2ldWzJdICo9IC0xOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcXVhdGVybmlvblswXSA9IDAuNSAqIE1hdGguc3FydChNYXRoLm1heCgxICsgcm93WzBdWzBdIC0gcm93WzFdWzFdIC0gcm93WzJdWzJdLCAwKSk7CiAgICAgIHF1YXRlcm5pb25bMV0gPSAwLjUgKiBNYXRoLnNxcnQoTWF0aC5tYXgoMSAtIHJvd1swXVswXSArIHJvd1sxXVsxXSAtIHJvd1syXVsyXSwgMCkpOwogICAgICBxdWF0ZXJuaW9uWzJdID0gMC41ICogTWF0aC5zcXJ0KE1hdGgubWF4KDEgLSByb3dbMF1bMF0gLSByb3dbMV1bMV0gKyByb3dbMl1bMl0sIDApKTsKICAgICAgcXVhdGVybmlvblszXSA9IDAuNSAqIE1hdGguc3FydChNYXRoLm1heCgxICsgcm93WzBdWzBdICsgcm93WzFdWzFdICsgcm93WzJdWzJdLCAwKSk7CgogICAgICBpZiAocm93WzJdWzFdID4gcm93WzFdWzJdKSB7CiAgICAgICAgcXVhdGVybmlvblswXSA9IC1xdWF0ZXJuaW9uWzBdOwogICAgICB9CgogICAgICBpZiAocm93WzBdWzJdID4gcm93WzJdWzBdKSB7CiAgICAgICAgcXVhdGVybmlvblsxXSA9IC1xdWF0ZXJuaW9uWzFdOwogICAgICB9CgogICAgICBpZiAocm93WzFdWzBdID4gcm93WzBdWzFdKSB7CiAgICAgICAgcXVhdGVybmlvblsyXSA9IC1xdWF0ZXJuaW9uWzJdOwogICAgICB9CgogICAgICB2YXIgcm90YXRpb25EZWdyZWVzOwoKICAgICAgaWYgKHF1YXRlcm5pb25bMF0gPCAwLjAwMSAmJiBxdWF0ZXJuaW9uWzBdID49IDAgJiYgcXVhdGVybmlvblsxXSA8IDAuMDAxICYmIHF1YXRlcm5pb25bMV0gPj0gMCkgewogICAgICAgIHJvdGF0aW9uRGVncmVlcyA9IFswLCAwLCBNYXRyaXhNYXRoLnJvdW5kVG8zUGxhY2VzKE1hdGguYXRhbjIocm93WzBdWzFdLCByb3dbMF1bMF0pICogMTgwIC8gTWF0aC5QSSldOwogICAgICB9IGVsc2UgewogICAgICAgIHJvdGF0aW9uRGVncmVlcyA9IE1hdHJpeE1hdGgucXVhdGVybmlvblRvRGVncmVlc1hZWihxdWF0ZXJuaW9uLCBtYXRyaXgsIHJvdyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgcm90YXRpb25EZWdyZWVzOiByb3RhdGlvbkRlZ3JlZXMsCiAgICAgICAgcGVyc3BlY3RpdmU6IHBlcnNwZWN0aXZlLAogICAgICAgIHF1YXRlcm5pb246IHF1YXRlcm5pb24sCiAgICAgICAgc2NhbGU6IHNjYWxlLAogICAgICAgIHNrZXc6IHNrZXcsCiAgICAgICAgdHJhbnNsYXRpb246IHRyYW5zbGF0aW9uLAogICAgICAgIHJvdGF0ZTogcm90YXRpb25EZWdyZWVzWzJdLAogICAgICAgIHJvdGF0ZVg6IHJvdGF0aW9uRGVncmVlc1swXSwKICAgICAgICByb3RhdGVZOiByb3RhdGlvbkRlZ3JlZXNbMV0sCiAgICAgICAgc2NhbGVYOiBzY2FsZVswXSwKICAgICAgICBzY2FsZVk6IHNjYWxlWzFdLAogICAgICAgIHRyYW5zbGF0ZVg6IHRyYW5zbGF0aW9uWzBdLAogICAgICAgIHRyYW5zbGF0ZVk6IHRyYW5zbGF0aW9uWzFdCiAgICAgIH07CiAgICB9CiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IE1hdHJpeE1hdGg7Cn0sMTU0LFsxM10sIk1hdHJpeE1hdGgiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBkdW1teVNpemUgPSB7CiAgICB3aWR0aDogdW5kZWZpbmVkLAogICAgaGVpZ2h0OiB1bmRlZmluZWQKICB9OwoKICB2YXIgc2l6ZXNEaWZmZXIgPSBmdW5jdGlvbiBzaXplc0RpZmZlcihvbmUsIHR3bykgewogICAgb25lID0gb25lIHx8IGR1bW15U2l6ZTsKICAgIHR3byA9IHR3byB8fCBkdW1teVNpemU7CiAgICByZXR1cm4gb25lICE9PSB0d28gJiYgKG9uZS53aWR0aCAhPT0gdHdvLndpZHRoIHx8IG9uZS5oZWlnaHQgIT09IHR3by5oZWlnaHQpOwogIH07CgogIG1vZHVsZS5leHBvcnRzID0gc2l6ZXNEaWZmZXI7Cn0sMTU1LFtdLCJzaXplc0RpZmZlciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0TmF0aXZlIiksCiAgICAgIF9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEID0gX3JlcXVpcmUuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CgogIG1vZHVsZS5leHBvcnRzID0gX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQuY3JlYXRlUmVhY3ROYXRpdmVDb21wb25lbnRDbGFzczsKfSwxNTYsWzIxXSwiY3JlYXRlUmVhY3ROYXRpdmVDb21wb25lbnRDbGFzcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGR1bW15SW5zZXRzID0gewogICAgdG9wOiB1bmRlZmluZWQsCiAgICBsZWZ0OiB1bmRlZmluZWQsCiAgICByaWdodDogdW5kZWZpbmVkLAogICAgYm90dG9tOiB1bmRlZmluZWQKICB9OwoKICB2YXIgaW5zZXRzRGlmZmVyID0gZnVuY3Rpb24gaW5zZXRzRGlmZmVyKG9uZSwgdHdvKSB7CiAgICBvbmUgPSBvbmUgfHwgZHVtbXlJbnNldHM7CiAgICB0d28gPSB0d28gfHwgZHVtbXlJbnNldHM7CiAgICByZXR1cm4gb25lICE9PSB0d28gJiYgKG9uZS50b3AgIT09IHR3by50b3AgfHwgb25lLmxlZnQgIT09IHR3by5sZWZ0IHx8IG9uZS5yaWdodCAhPT0gdHdvLnJpZ2h0IHx8IG9uZS5ib3R0b20gIT09IHR3by5ib3R0b20pOwogIH07CgogIG1vZHVsZS5leHBvcnRzID0gaW5zZXRzRGlmZmVyOwp9LDE1NyxbXSwiaW5zZXRzRGlmZmVyIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgbWF0cmljZXNEaWZmZXIgPSBmdW5jdGlvbiBtYXRyaWNlc0RpZmZlcihvbmUsIHR3bykgewogICAgaWYgKG9uZSA9PT0gdHdvKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gIW9uZSB8fCAhdHdvIHx8IG9uZVsxMl0gIT09IHR3b1sxMl0gfHwgb25lWzEzXSAhPT0gdHdvWzEzXSB8fCBvbmVbMTRdICE9PSB0d29bMTRdIHx8IG9uZVs1XSAhPT0gdHdvWzVdIHx8IG9uZVsxMF0gIT09IHR3b1sxMF0gfHwgb25lWzFdICE9PSB0d29bMV0gfHwgb25lWzJdICE9PSB0d29bMl0gfHwgb25lWzNdICE9PSB0d29bM10gfHwgb25lWzRdICE9PSB0d29bNF0gfHwgb25lWzZdICE9PSB0d29bNl0gfHwgb25lWzddICE9PSB0d29bN10gfHwgb25lWzhdICE9PSB0d29bOF0gfHwgb25lWzldICE9PSB0d29bOV0gfHwgb25lWzExXSAhPT0gdHdvWzExXSB8fCBvbmVbMTVdICE9PSB0d29bMTVdOwogIH07CgogIG1vZHVsZS5leHBvcnRzID0gbWF0cmljZXNEaWZmZXI7Cn0sMTU4LFtdLCJtYXRyaWNlc0RpZmZlciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGR1bW15UG9pbnQgPSB7CiAgICB4OiB1bmRlZmluZWQsCiAgICB5OiB1bmRlZmluZWQKICB9OwoKICB2YXIgcG9pbnRzRGlmZmVyID0gZnVuY3Rpb24gcG9pbnRzRGlmZmVyKG9uZSwgdHdvKSB7CiAgICBvbmUgPSBvbmUgfHwgZHVtbXlQb2ludDsKICAgIHR3byA9IHR3byB8fCBkdW1teVBvaW50OwogICAgcmV0dXJuIG9uZSAhPT0gdHdvICYmIChvbmUueCAhPT0gdHdvLnggfHwgb25lLnkgIT09IHR3by55KTsKICB9OwoKICBtb2R1bGUuZXhwb3J0cyA9IHBvaW50c0RpZmZlcjsKfSwxNTksW10sInBvaW50c0RpZmZlciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEFzc2V0UmVnaXN0cnkgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQXNzZXRSZWdpc3RyeSIpOwoKICB2YXIgQXNzZXRTb3VyY2VSZXNvbHZlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJBc3NldFNvdXJjZVJlc29sdmVyIik7CgogIHZhciBOYXRpdmVNb2R1bGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIk5hdGl2ZU1vZHVsZXMiKTsKCiAgdmFyIF9jdXN0b21Tb3VyY2VUcmFuc2Zvcm1lciA9IHZvaWQgMCwKICAgICAgX3NlcnZlclVSTCA9IHZvaWQgMCwKICAgICAgX3NjcmlwdFVSTCA9IHZvaWQgMCwKICAgICAgX2VtYmVkZGVkQnVuZGxlVVJMID0gdm9pZCAwOwoKICBmdW5jdGlvbiBnZXREZXZTZXJ2ZXJVUkwoKSB7CiAgICBpZiAoX3NlcnZlclVSTCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhciBzY3JpcHRVUkwgPSBOYXRpdmVNb2R1bGVzLlNvdXJjZUNvZGUuc2NyaXB0VVJMOwogICAgICB2YXIgbWF0Y2ggPSBzY3JpcHRVUkwgJiYgc2NyaXB0VVJMLm1hdGNoKC9eaHR0cHM/OlwvXC8uKj9cLy8pOwoKICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgX3NlcnZlclVSTCA9IG1hdGNoWzBdOwogICAgICB9IGVsc2UgewogICAgICAgIF9zZXJ2ZXJVUkwgPSBudWxsOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIF9zZXJ2ZXJVUkw7CiAgfQoKICBmdW5jdGlvbiBfY29lcmNlTG9jYWxTY3JpcHRVUkwoc2NyaXB0VVJMKSB7CiAgICBpZiAoc2NyaXB0VVJMKSB7CiAgICAgIGlmIChzY3JpcHRVUkwuc3RhcnRzV2l0aCgnYXNzZXRzOi8vJykpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgc2NyaXB0VVJMID0gc2NyaXB0VVJMLnN1YnN0cmluZygwLCBzY3JpcHRVUkwubGFzdEluZGV4T2YoJy8nKSArIDEpOwoKICAgICAgaWYgKCFzY3JpcHRVUkwuaW5jbHVkZXMoJzovLycpKSB7CiAgICAgICAgc2NyaXB0VVJMID0gJ2ZpbGU6Ly8nICsgc2NyaXB0VVJMOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHNjcmlwdFVSTDsKICB9CgogIGZ1bmN0aW9uIGdldFNjcmlwdFVSTCgpIHsKICAgIGlmIChfc2NyaXB0VVJMID09PSB1bmRlZmluZWQpIHsKICAgICAgdmFyIHNjcmlwdFVSTCA9IE5hdGl2ZU1vZHVsZXMuU291cmNlQ29kZS5zY3JpcHRVUkw7CiAgICAgIF9zY3JpcHRVUkwgPSBfY29lcmNlTG9jYWxTY3JpcHRVUkwoc2NyaXB0VVJMKTsKICAgIH0KCiAgICByZXR1cm4gX3NjcmlwdFVSTDsKICB9CgogIGZ1bmN0aW9uIGdldEVtYmVkZGVkQnVuZGxlZFVSTCgpIHsKICAgIHZhciBzY3JpcHRVUkwgPSBOYXRpdmVNb2R1bGVzLlNvdXJjZUNvZGUuZW1iZWRkZWRCdW5kbGVVUkw7CiAgICBfZW1iZWRkZWRCdW5kbGVVUkwgPSBfY29lcmNlTG9jYWxTY3JpcHRVUkwoc2NyaXB0VVJMKTsKICAgIHJldHVybiBfZW1iZWRkZWRCdW5kbGVVUkw7CiAgfQoKICBmdW5jdGlvbiBzZXRDdXN0b21Tb3VyY2VUcmFuc2Zvcm1lcih0cmFuc2Zvcm1lcikgewogICAgX2N1c3RvbVNvdXJjZVRyYW5zZm9ybWVyID0gdHJhbnNmb3JtZXI7CiAgfQoKICBmdW5jdGlvbiByZXNvbHZlQXNzZXRTb3VyY2Uoc291cmNlKSB7CiAgICBpZiAodHlwZW9mIHNvdXJjZSA9PT0gJ29iamVjdCcpIHsKICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0KCiAgICB2YXIgYXNzZXQgPSBBc3NldFJlZ2lzdHJ5LmdldEFzc2V0QnlJRChzb3VyY2UpOwoKICAgIGlmICghYXNzZXQpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgdmFyIHJlc29sdmVyID0gbmV3IEFzc2V0U291cmNlUmVzb2x2ZXIoZ2V0RGV2U2VydmVyVVJMKCksIGdldFNjcmlwdFVSTCgpLCBnZXRFbWJlZGRlZEJ1bmRsZWRVUkwoKSwgYXNzZXQpOwoKICAgIGlmIChfY3VzdG9tU291cmNlVHJhbnNmb3JtZXIpIHsKICAgICAgcmV0dXJuIF9jdXN0b21Tb3VyY2VUcmFuc2Zvcm1lcihyZXNvbHZlcik7CiAgICB9CgogICAgcmV0dXJuIHJlc29sdmVyLmRlZmF1bHRBc3NldCgpOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSByZXNvbHZlQXNzZXRTb3VyY2U7CiAgbW9kdWxlLmV4cG9ydHMucGlja1NjYWxlID0gQXNzZXRTb3VyY2VSZXNvbHZlci5waWNrU2NhbGU7CiAgbW9kdWxlLmV4cG9ydHMuc2V0Q3VzdG9tU291cmNlVHJhbnNmb3JtZXIgPSBzZXRDdXN0b21Tb3VyY2VUcmFuc2Zvcm1lcjsKfSwxNjAsWzE2MSwxNjIsMTVdLCJyZXNvbHZlQXNzZXRTb3VyY2UiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBhc3NldHMgPSBbXTsKCiAgZnVuY3Rpb24gcmVnaXN0ZXJBc3NldChhc3NldCkgewogICAgcmV0dXJuIGFzc2V0cy5wdXNoKGFzc2V0KTsKICB9CgogIGZ1bmN0aW9uIGdldEFzc2V0QnlJRChhc3NldElkKSB7CiAgICByZXR1cm4gYXNzZXRzW2Fzc2V0SWQgLSAxXTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gewogICAgcmVnaXN0ZXJBc3NldDogcmVnaXN0ZXJBc3NldCwKICAgIGdldEFzc2V0QnlJRDogZ2V0QXNzZXRCeUlECiAgfTsKfSwxNjEsW10sIkFzc2V0UmVnaXN0cnkiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBQaXhlbFJhdGlvID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlBpeGVsUmF0aW8iKTsKCiAgdmFyIFBsYXRmb3JtID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlBsYXRmb3JtIik7CgogIHZhciBhc3NldFBhdGhVdGlscyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICcuLi8uLi9sb2NhbC1jbGkvYnVuZGxlL2Fzc2V0UGF0aFV0aWxzJyk7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIGZ1bmN0aW9uIGdldFNjYWxlZEFzc2V0UGF0aChhc3NldCkgewogICAgdmFyIHNjYWxlID0gQXNzZXRTb3VyY2VSZXNvbHZlci5waWNrU2NhbGUoYXNzZXQuc2NhbGVzLCBQaXhlbFJhdGlvLmdldCgpKTsKICAgIHZhciBzY2FsZVN1ZmZpeCA9IHNjYWxlID09PSAxID8gJycgOiAnQCcgKyBzY2FsZSArICd4JzsKICAgIHZhciBhc3NldERpciA9IGFzc2V0UGF0aFV0aWxzLmdldEJhc2VQYXRoKGFzc2V0KTsKICAgIHJldHVybiBhc3NldERpciArICcvJyArIGFzc2V0Lm5hbWUgKyBzY2FsZVN1ZmZpeCArICcuJyArIGFzc2V0LnR5cGU7CiAgfQoKICBmdW5jdGlvbiBnZXRBc3NldFBhdGhJbkRyYXdhYmxlRm9sZGVyKGFzc2V0KSB7CiAgICB2YXIgc2NhbGUgPSBBc3NldFNvdXJjZVJlc29sdmVyLnBpY2tTY2FsZShhc3NldC5zY2FsZXMsIFBpeGVsUmF0aW8uZ2V0KCkpOwogICAgdmFyIGRyYXdibGVGb2xkZXIgPSBhc3NldFBhdGhVdGlscy5nZXRBbmRyb2lkUmVzb3VyY2VGb2xkZXJOYW1lKGFzc2V0LCBzY2FsZSk7CiAgICB2YXIgZmlsZU5hbWUgPSBhc3NldFBhdGhVdGlscy5nZXRBbmRyb2lkUmVzb3VyY2VJZGVudGlmaWVyKGFzc2V0KTsKICAgIHJldHVybiBkcmF3YmxlRm9sZGVyICsgJy8nICsgZmlsZU5hbWUgKyAnLicgKyBhc3NldC50eXBlOwogIH0KCiAgdmFyIEFzc2V0U291cmNlUmVzb2x2ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBBc3NldFNvdXJjZVJlc29sdmVyKHNlcnZlclVybCwganNidW5kbGVVcmwsIGVtYmVkZGVkQnVuZGxlVXJsLCBhc3NldCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQXNzZXRTb3VyY2VSZXNvbHZlcik7CiAgICAgIHRoaXMuc2VydmVyVXJsID0gc2VydmVyVXJsOwogICAgICB0aGlzLmpzYnVuZGxlVXJsID0ganNidW5kbGVVcmw7CiAgICAgIHRoaXMuZW1iZWRkZWRCdW5kbGVVcmwgPSBlbWJlZGRlZEJ1bmRsZVVybDsKICAgICAgdGhpcy5hc3NldCA9IGFzc2V0OwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhBc3NldFNvdXJjZVJlc29sdmVyLCBbewogICAgICBrZXk6ICJpc0xvYWRlZEZyb21TZXJ2ZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gaXNMb2FkZWRGcm9tU2VydmVyKCkgewogICAgICAgIHJldHVybiAhIXRoaXMuc2VydmVyVXJsOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImlzTG9hZGVkRnJvbUZpbGVTeXN0ZW0iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gaXNMb2FkZWRGcm9tRmlsZVN5c3RlbSgpIHsKICAgICAgICByZXR1cm4gISEodGhpcy5qc2J1bmRsZVVybCAmJiB0aGlzLmpzYnVuZGxlVXJsLnN0YXJ0c1dpdGgoJ2ZpbGU6Ly8nKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY2FuTG9hZEZyb21FbWJlZGRlZEJ1bmRsZWRMb2NhdGlvbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjYW5Mb2FkRnJvbUVtYmVkZGVkQnVuZGxlZExvY2F0aW9uKCkgewogICAgICAgIHJldHVybiAhIXRoaXMuZW1iZWRkZWRCdW5kbGVVcmw7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZGVmYXVsdEFzc2V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGRlZmF1bHRBc3NldCgpIHsKICAgICAgICBpZiAodGhpcy5pc0xvYWRlZEZyb21TZXJ2ZXIoKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuYXNzZXRTZXJ2ZXJVUkwoKTsKICAgICAgICB9CgogICAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5pc0xvYWRlZEZyb21GaWxlU3lzdGVtKCkgPyB0aGlzLmRyYXdhYmxlRm9sZGVySW5CdW5kbGUoKSA6IHRoaXMucmVzb3VyY2VJZGVudGlmaWVyV2l0aG91dFNjYWxlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB0aGlzLnNjYWxlZEFzc2V0VVJMTmVhckJ1bmRsZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJhc3NldFNlcnZlclVSTCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhc3NldFNlcnZlclVSTCgpIHsKICAgICAgICBpbnZhcmlhbnQoISF0aGlzLnNlcnZlclVybCwgJ25lZWQgc2VydmVyIHRvIGxvYWQgZnJvbScpOwogICAgICAgIHJldHVybiB0aGlzLmZyb21Tb3VyY2UodGhpcy5zZXJ2ZXJVcmwgKyBnZXRTY2FsZWRBc3NldFBhdGgodGhpcy5hc3NldCkgKyAnP3BsYXRmb3JtPScgKyBQbGF0Zm9ybS5PUyArICcmaGFzaD0nICsgdGhpcy5hc3NldC5oYXNoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzY2FsZWRBc3NldFBhdGgiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2NhbGVkQXNzZXRQYXRoKCkgewogICAgICAgIHJldHVybiB0aGlzLmZyb21Tb3VyY2UoZ2V0U2NhbGVkQXNzZXRQYXRoKHRoaXMuYXNzZXQpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzY2FsZWRBc3NldFVSTE5lYXJCdW5kbGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2NhbGVkQXNzZXRVUkxOZWFyQnVuZGxlKCkgewogICAgICAgIHZhciBwYXRoID0gdGhpcy5qc2J1bmRsZVVybCB8fCAnZmlsZTovLyc7CiAgICAgICAgcmV0dXJuIHRoaXMuZnJvbVNvdXJjZShwYXRoICsgZ2V0U2NhbGVkQXNzZXRQYXRoKHRoaXMuYXNzZXQpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzY2FsZWRBc3NldFVSTEluRW1iZWRkZWRCdW5kbGVVcmwiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2NhbGVkQXNzZXRVUkxJbkVtYmVkZGVkQnVuZGxlVXJsKCkgewogICAgICAgIHZhciBwYXRoID0gdGhpcy5lbWJlZGRlZEJ1bmRsZVVybCB8fCAnZmlsZTovLyc7CiAgICAgICAgcmV0dXJuIHRoaXMuZnJvbVNvdXJjZShwYXRoICsgZ2V0U2NhbGVkQXNzZXRQYXRoKHRoaXMuYXNzZXQpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZXNvdXJjZUlkZW50aWZpZXJXaXRob3V0U2NhbGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVzb3VyY2VJZGVudGlmaWVyV2l0aG91dFNjYWxlKCkgewogICAgICAgIGludmFyaWFudChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnLCAncmVzb3VyY2UgaWRlbnRpZmllcnMgd29yayBvbiBBbmRyb2lkJyk7CiAgICAgICAgcmV0dXJuIHRoaXMuZnJvbVNvdXJjZShhc3NldFBhdGhVdGlscy5nZXRBbmRyb2lkUmVzb3VyY2VJZGVudGlmaWVyKHRoaXMuYXNzZXQpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJkcmF3YWJsZUZvbGRlckluQnVuZGxlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGRyYXdhYmxlRm9sZGVySW5CdW5kbGUoKSB7CiAgICAgICAgdmFyIHBhdGggPSB0aGlzLmpzYnVuZGxlVXJsIHx8ICdmaWxlOi8vJzsKICAgICAgICByZXR1cm4gdGhpcy5mcm9tU291cmNlKHBhdGggKyBnZXRBc3NldFBhdGhJbkRyYXdhYmxlRm9sZGVyKHRoaXMuYXNzZXQpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJmcm9tU291cmNlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGZyb21Tb3VyY2Uoc291cmNlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIF9fcGFja2FnZXJfYXNzZXQ6IHRydWUsCiAgICAgICAgICB3aWR0aDogdGhpcy5hc3NldC53aWR0aCwKICAgICAgICAgIGhlaWdodDogdGhpcy5hc3NldC5oZWlnaHQsCiAgICAgICAgICB1cmk6IHNvdXJjZSwKICAgICAgICAgIHNjYWxlOiBBc3NldFNvdXJjZVJlc29sdmVyLnBpY2tTY2FsZSh0aGlzLmFzc2V0LnNjYWxlcywgUGl4ZWxSYXRpby5nZXQoKSkKICAgICAgICB9OwogICAgICB9CiAgICB9XSwgW3sKICAgICAga2V5OiAicGlja1NjYWxlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHBpY2tTY2FsZShzY2FsZXMsIGRldmljZVNjYWxlKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzY2FsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChzY2FsZXNbaV0gPj0gZGV2aWNlU2NhbGUpIHsKICAgICAgICAgICAgcmV0dXJuIHNjYWxlc1tpXTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBzY2FsZXNbc2NhbGVzLmxlbmd0aCAtIDFdIHx8IDE7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBBc3NldFNvdXJjZVJlc29sdmVyOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBBc3NldFNvdXJjZVJlc29sdmVyOwp9LDE2MixbMTYzLDUyLDE2NiwxM10sIkFzc2V0U291cmNlUmVzb2x2ZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBEaW1lbnNpb25zID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkRpbWVuc2lvbnMiKTsKCiAgdmFyIFBpeGVsUmF0aW8gPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBQaXhlbFJhdGlvKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgUGl4ZWxSYXRpbyk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFBpeGVsUmF0aW8sIG51bGwsIFt7CiAgICAgIGtleTogImdldCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIERpbWVuc2lvbnMuZ2V0KCd3aW5kb3cnKS5zY2FsZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRGb250U2NhbGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0Rm9udFNjYWxlKCkgewogICAgICAgIHJldHVybiBEaW1lbnNpb25zLmdldCgnd2luZG93JykuZm9udFNjYWxlIHx8IFBpeGVsUmF0aW8uZ2V0KCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0UGl4ZWxTaXplRm9yTGF5b3V0U2l6ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRQaXhlbFNpemVGb3JMYXlvdXRTaXplKGxheW91dFNpemUpIHsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChsYXlvdXRTaXplICogUGl4ZWxSYXRpby5nZXQoKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicm91bmRUb05lYXJlc3RQaXhlbCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByb3VuZFRvTmVhcmVzdFBpeGVsKGxheW91dFNpemUpIHsKICAgICAgICB2YXIgcmF0aW8gPSBQaXhlbFJhdGlvLmdldCgpOwogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKGxheW91dFNpemUgKiByYXRpbykgLyByYXRpbzsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzdGFydERldGVjdGluZyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzdGFydERldGVjdGluZygpIHt9CiAgICB9XSk7CiAgICByZXR1cm4gUGl4ZWxSYXRpbzsKICB9KCk7CgogIG1vZHVsZS5leHBvcnRzID0gUGl4ZWxSYXRpbzsKfSwxNjMsWzE2NF0sIlBpeGVsUmF0aW8iKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBEZXZpY2VJbmZvID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkRldmljZUluZm8iKTsKCiAgdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJFdmVudEVtaXR0ZXIiKTsKCiAgdmFyIFBsYXRmb3JtID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlBsYXRmb3JtIik7CgogIHZhciBSQ1REZXZpY2VFdmVudEVtaXR0ZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUkNURGV2aWNlRXZlbnRFbWl0dGVyIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBldmVudEVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7CiAgdmFyIGRpbWVuc2lvbnNJbml0aWFsaXplZCA9IGZhbHNlOwogIHZhciBkaW1lbnNpb25zID0ge307CgogIHZhciBEaW1lbnNpb25zID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRGltZW5zaW9ucygpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIERpbWVuc2lvbnMpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhEaW1lbnNpb25zLCBudWxsLCBbewogICAgICBrZXk6ICJzZXQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0KGRpbXMpIHsKICAgICAgICBpZiAoZGltcyAmJiBkaW1zLndpbmRvd1BoeXNpY2FsUGl4ZWxzKSB7CiAgICAgICAgICBkaW1zID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShkaW1zKSk7CiAgICAgICAgICB2YXIgd2luZG93UGh5c2ljYWxQaXhlbHMgPSBkaW1zLndpbmRvd1BoeXNpY2FsUGl4ZWxzOwogICAgICAgICAgZGltcy53aW5kb3cgPSB7CiAgICAgICAgICAgIHdpZHRoOiB3aW5kb3dQaHlzaWNhbFBpeGVscy53aWR0aCAvIHdpbmRvd1BoeXNpY2FsUGl4ZWxzLnNjYWxlLAogICAgICAgICAgICBoZWlnaHQ6IHdpbmRvd1BoeXNpY2FsUGl4ZWxzLmhlaWdodCAvIHdpbmRvd1BoeXNpY2FsUGl4ZWxzLnNjYWxlLAogICAgICAgICAgICBzY2FsZTogd2luZG93UGh5c2ljYWxQaXhlbHMuc2NhbGUsCiAgICAgICAgICAgIGZvbnRTY2FsZTogd2luZG93UGh5c2ljYWxQaXhlbHMuZm9udFNjYWxlCiAgICAgICAgICB9OwoKICAgICAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICAgICAgICAgIHZhciBzY3JlZW5QaHlzaWNhbFBpeGVscyA9IGRpbXMuc2NyZWVuUGh5c2ljYWxQaXhlbHM7CiAgICAgICAgICAgIGRpbXMuc2NyZWVuID0gewogICAgICAgICAgICAgIHdpZHRoOiBzY3JlZW5QaHlzaWNhbFBpeGVscy53aWR0aCAvIHNjcmVlblBoeXNpY2FsUGl4ZWxzLnNjYWxlLAogICAgICAgICAgICAgIGhlaWdodDogc2NyZWVuUGh5c2ljYWxQaXhlbHMuaGVpZ2h0IC8gc2NyZWVuUGh5c2ljYWxQaXhlbHMuc2NhbGUsCiAgICAgICAgICAgICAgc2NhbGU6IHNjcmVlblBoeXNpY2FsUGl4ZWxzLnNjYWxlLAogICAgICAgICAgICAgIGZvbnRTY2FsZTogc2NyZWVuUGh5c2ljYWxQaXhlbHMuZm9udFNjYWxlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGRlbGV0ZSBkaW1zLnNjcmVlblBoeXNpY2FsUGl4ZWxzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGltcy5zY3JlZW4gPSBkaW1zLndpbmRvdzsKICAgICAgICAgIH0KCiAgICAgICAgICBkZWxldGUgZGltcy53aW5kb3dQaHlzaWNhbFBpeGVsczsKICAgICAgICB9CgogICAgICAgIGJhYmVsSGVscGVycy5leHRlbmRzKGRpbWVuc2lvbnMsIGRpbXMpOwoKICAgICAgICBpZiAoZGltZW5zaW9uc0luaXRpYWxpemVkKSB7CiAgICAgICAgICBldmVudEVtaXR0ZXIuZW1pdCgnY2hhbmdlJywgewogICAgICAgICAgICB3aW5kb3c6IGRpbWVuc2lvbnMud2luZG93LAogICAgICAgICAgICBzY3JlZW46IGRpbWVuc2lvbnMuc2NyZWVuCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGltZW5zaW9uc0luaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldChkaW0pIHsKICAgICAgICBpbnZhcmlhbnQoZGltZW5zaW9uc1tkaW1dLCAnTm8gZGltZW5zaW9uIHNldCBmb3Iga2V5ICcgKyBkaW0pOwogICAgICAgIHJldHVybiBkaW1lbnNpb25zW2RpbV07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYWRkRXZlbnRMaXN0ZW5lciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZXIpIHsKICAgICAgICBpbnZhcmlhbnQodHlwZSA9PT0gJ2NoYW5nZScsICdUcnlpbmcgdG8gc3Vic2NyaWJlIHRvIHVua25vd24gZXZlbnQ6ICIlcyInLCB0eXBlKTsKICAgICAgICBldmVudEVtaXR0ZXIuYWRkTGlzdGVuZXIodHlwZSwgaGFuZGxlcik7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVtb3ZlRXZlbnRMaXN0ZW5lciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZXIpIHsKICAgICAgICBpbnZhcmlhbnQodHlwZSA9PT0gJ2NoYW5nZScsICdUcnlpbmcgdG8gcmVtb3ZlIGxpc3RlbmVyIGZvciB1bmtub3duIGV2ZW50OiAiJXMiJywgdHlwZSk7CiAgICAgICAgZXZlbnRFbWl0dGVyLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGhhbmRsZXIpOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gRGltZW5zaW9uczsKICB9KCk7CgogIERpbWVuc2lvbnMuc2V0KERldmljZUluZm8uRGltZW5zaW9ucyk7CiAgUkNURGV2aWNlRXZlbnRFbWl0dGVyLmFkZExpc3RlbmVyKCdkaWRVcGRhdGVEaW1lbnNpb25zJywgZnVuY3Rpb24gKHVwZGF0ZSkgewogICAgRGltZW5zaW9ucy5zZXQodXBkYXRlKTsKICB9KTsKICBtb2R1bGUuZXhwb3J0cyA9IERpbWVuc2lvbnM7Cn0sMTY0LFsxNjUsNjcsNTIsNzAsMTNdLCJEaW1lbnNpb25zIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgRGV2aWNlSW5mbyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIikuRGV2aWNlSW5mbzsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgaW52YXJpYW50KERldmljZUluZm8sICdEZXZpY2VJbmZvIG5hdGl2ZSBtb2R1bGUgaXMgbm90IGluc3RhbGxlZCBjb3JyZWN0bHknKTsKICBtb2R1bGUuZXhwb3J0cyA9IERldmljZUluZm87Cn0sMTY1LFsxNSwxM10sIkRldmljZUluZm8iKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIGZ1bmN0aW9uIGdldEFuZHJvaWRBc3NldFN1ZmZpeChzY2FsZSkgewogICAgc3dpdGNoIChzY2FsZSkgewogICAgICBjYXNlIDAuNzU6CiAgICAgICAgcmV0dXJuICdsZHBpJzsKCiAgICAgIGNhc2UgMToKICAgICAgICByZXR1cm4gJ21kcGknOwoKICAgICAgY2FzZSAxLjU6CiAgICAgICAgcmV0dXJuICdoZHBpJzsKCiAgICAgIGNhc2UgMjoKICAgICAgICByZXR1cm4gJ3hoZHBpJzsKCiAgICAgIGNhc2UgMzoKICAgICAgICByZXR1cm4gJ3h4aGRwaSc7CgogICAgICBjYXNlIDQ6CiAgICAgICAgcmV0dXJuICd4eHhoZHBpJzsKICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ25vIHN1Y2ggc2NhbGUnKTsKICB9CgogIHZhciBkcmF3YWJsZUZpbGVUeXBlcyA9IG5ldyBTZXQoWydnaWYnLCAnanBlZycsICdqcGcnLCAncG5nJywgJ3N2ZycsICd3ZWJwJywgJ3htbCddKTsKCiAgZnVuY3Rpb24gZ2V0QW5kcm9pZFJlc291cmNlRm9sZGVyTmFtZShhc3NldCwgc2NhbGUpIHsKICAgIGlmICghZHJhd2FibGVGaWxlVHlwZXMuaGFzKGFzc2V0LnR5cGUpKSB7CiAgICAgIHJldHVybiAncmF3JzsKICAgIH0KCiAgICB2YXIgc3VmZml4ID0gZ2V0QW5kcm9pZEFzc2V0U3VmZml4KHNjYWxlKTsKCiAgICBpZiAoIXN1ZmZpeCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvblwndCBrbm93IHdoaWNoIGFuZHJvaWQgZHJhd2FibGUgc3VmZml4IHRvIHVzZSBmb3IgYXNzZXQ6ICcgKyBKU09OLnN0cmluZ2lmeShhc3NldCkpOwogICAgfQoKICAgIHZhciBhbmRyb2lkRm9sZGVyID0gJ2RyYXdhYmxlLScgKyBzdWZmaXg7CiAgICByZXR1cm4gYW5kcm9pZEZvbGRlcjsKICB9CgogIGZ1bmN0aW9uIGdldEFuZHJvaWRSZXNvdXJjZUlkZW50aWZpZXIoYXNzZXQpIHsKICAgIHZhciBmb2xkZXJQYXRoID0gZ2V0QmFzZVBhdGgoYXNzZXQpOwogICAgcmV0dXJuIChmb2xkZXJQYXRoICsgJy8nICsgYXNzZXQubmFtZSkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9cLy9nLCAnXycpLnJlcGxhY2UoLyhbXmEtejAtOV9dKS9nLCAnJykucmVwbGFjZSgvXmFzc2V0c18vLCAnJyk7CiAgfQoKICBmdW5jdGlvbiBnZXRCYXNlUGF0aChhc3NldCkgewogICAgdmFyIGJhc2VQYXRoID0gYXNzZXQuaHR0cFNlcnZlckxvY2F0aW9uOwoKICAgIGlmIChiYXNlUGF0aFswXSA9PT0gJy8nKSB7CiAgICAgIGJhc2VQYXRoID0gYmFzZVBhdGguc3Vic3RyKDEpOwogICAgfQoKICAgIHJldHVybiBiYXNlUGF0aDsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gewogICAgZ2V0QW5kcm9pZEFzc2V0U3VmZml4OiBnZXRBbmRyb2lkQXNzZXRTdWZmaXgsCiAgICBnZXRBbmRyb2lkUmVzb3VyY2VGb2xkZXJOYW1lOiBnZXRBbmRyb2lkUmVzb3VyY2VGb2xkZXJOYW1lLAogICAgZ2V0QW5kcm9pZFJlc291cmNlSWRlbnRpZmllcjogZ2V0QW5kcm9pZFJlc291cmNlSWRlbnRpZmllciwKICAgIGdldEJhc2VQYXRoOiBnZXRCYXNlUGF0aAogIH07Cn0sMTY2LFtdLCJyZWFjdC1uYXRpdmUvbG9jYWwtY2xpL2J1bmRsZS9hc3NldFBhdGhVdGlscy5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzIik7CgogIGZ1bmN0aW9uIHZlcmlmeVByb3BUeXBlcyhjb21wb25lbnRJbnRlcmZhY2UsIHZpZXdDb25maWcsIG5hdGl2ZVByb3BzVG9JZ25vcmUpIHsKICAgIGlmICghdmlld0NvbmZpZykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNvbXBvbmVudE5hbWUgPSBjb21wb25lbnRJbnRlcmZhY2UuZGlzcGxheU5hbWUgfHwgY29tcG9uZW50SW50ZXJmYWNlLm5hbWUgfHwgJ3Vua25vd24nOwogICAgdmFyIHByb3BUeXBlcyA9IGNvbXBvbmVudEludGVyZmFjZS5fX3Byb3BUeXBlc1NlY3JldERvbnRVc2VUaGVzZVBsZWFzZSB8fCBjb21wb25lbnRJbnRlcmZhY2UucHJvcFR5cGVzOwoKICAgIGlmICghcHJvcFR5cGVzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignYCcgKyBjb21wb25lbnROYW1lICsgJ2AgaGFzIG5vIHByb3BUeXBlcyBkZWZpbmVkYCcpOwogICAgfQoKICAgIHZhciBuYXRpdmVQcm9wcyA9IHZpZXdDb25maWcuTmF0aXZlUHJvcHM7CgogICAgZm9yICh2YXIgcHJvcCBpbiBuYXRpdmVQcm9wcykgewogICAgICBpZiAoIXByb3BUeXBlc1twcm9wXSAmJiAhUmVhY3ROYXRpdmVTdHlsZUF0dHJpYnV0ZXNbcHJvcF0gJiYgKCFuYXRpdmVQcm9wc1RvSWdub3JlIHx8ICFuYXRpdmVQcm9wc1RvSWdub3JlW3Byb3BdKSkgewogICAgICAgIHZhciBtZXNzYWdlOwoKICAgICAgICBpZiAocHJvcFR5cGVzLmhhc093blByb3BlcnR5KHByb3ApKSB7CiAgICAgICAgICBtZXNzYWdlID0gJ2AnICsgY29tcG9uZW50TmFtZSArICdgIGhhcyBpbmNvcnJlY3RseSBkZWZpbmVkIHByb3BUeXBlIGZvciBuYXRpdmUgcHJvcCBgJyArIHZpZXdDb25maWcudWlWaWV3Q2xhc3NOYW1lICsgJy4nICsgcHJvcCArICdgIG9mIG5hdGl2ZSB0eXBlIGAnICsgbmF0aXZlUHJvcHNbcHJvcF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1lc3NhZ2UgPSAnYCcgKyBjb21wb25lbnROYW1lICsgJ2AgaGFzIG5vIHByb3BUeXBlIGZvciBuYXRpdmUgcHJvcCBgJyArIHZpZXdDb25maWcudWlWaWV3Q2xhc3NOYW1lICsgJy4nICsgcHJvcCArICdgIG9mIG5hdGl2ZSB0eXBlIGAnICsgbmF0aXZlUHJvcHNbcHJvcF0gKyAnYCc7CiAgICAgICAgfQoKICAgICAgICBtZXNzYWdlICs9ICJcbklmIHlvdSBoYXZlbid0IGNoYW5nZWQgdGhpcyBwcm9wIHlvdXJzZWxmLCB0aGlzIHVzdWFsbHkgbWVhbnMgdGhhdCAiICsgJ3lvdXIgdmVyc2lvbnMgb2YgdGhlIG5hdGl2ZSBjb2RlIGFuZCBKYXZhU2NyaXB0IGNvZGUgYXJlIG91dCBvZiBzeW5jLiBVcGRhdGluZyBib3RoICcgKyAnc2hvdWxkIG1ha2UgdGhpcyBlcnJvciBnbyBhd2F5Lic7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICB9CiAgICB9CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IHZlcmlmeVByb3BUeXBlczsKfSwxNjcsWzE0N10sInZlcmlmeVByb3BUeXBlcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFBpeGVsUmF0aW8gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiUGl4ZWxSYXRpbyIpOwoKICB2YXIgUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnkgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUmVhY3ROYXRpdmVQcm9wUmVnaXN0cnkiKTsKCiAgdmFyIFJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlJlYWN0TmF0aXZlU3R5bGVBdHRyaWJ1dGVzIik7CgogIHZhciBTdHlsZVNoZWV0VmFsaWRhdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJTdHlsZVNoZWV0VmFsaWRhdGlvbiIpOwoKICB2YXIgZmxhdHRlbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJmbGF0dGVuU3R5bGUiKTsKCiAgdmFyIGhhaXJsaW5lV2lkdGggPSBQaXhlbFJhdGlvLnJvdW5kVG9OZWFyZXN0UGl4ZWwoMC40KTsKCiAgaWYgKGhhaXJsaW5lV2lkdGggPT09IDApIHsKICAgIGhhaXJsaW5lV2lkdGggPSAxIC8gUGl4ZWxSYXRpby5nZXQoKTsKICB9CgogIHZhciBhYnNvbHV0ZUZpbGxPYmplY3QgPSB7CiAgICBwb3NpdGlvbjogJ2Fic29sdXRlJywKICAgIGxlZnQ6IDAsCiAgICByaWdodDogMCwKICAgIHRvcDogMCwKICAgIGJvdHRvbTogMAogIH07CiAgdmFyIGFic29sdXRlRmlsbCA9IFJlYWN0TmF0aXZlUHJvcFJlZ2lzdHJ5LnJlZ2lzdGVyKGFic29sdXRlRmlsbE9iamVjdCk7CiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBoYWlybGluZVdpZHRoOiBoYWlybGluZVdpZHRoLAogICAgYWJzb2x1dGVGaWxsOiBhYnNvbHV0ZUZpbGwsCiAgICBhYnNvbHV0ZUZpbGxPYmplY3Q6IGFic29sdXRlRmlsbE9iamVjdCwKICAgIGNvbXBvc2U6IGZ1bmN0aW9uIGNvbXBvc2Uoc3R5bGUxLCBzdHlsZTIpIHsKICAgICAgaWYgKHN0eWxlMSAmJiBzdHlsZTIpIHsKICAgICAgICByZXR1cm4gW3N0eWxlMSwgc3R5bGUyXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gc3R5bGUxIHx8IHN0eWxlMjsKICAgICAgfQogICAgfSwKICAgIGZsYXR0ZW46IGZsYXR0ZW4sCiAgICBzZXRTdHlsZUF0dHJpYnV0ZVByZXByb2Nlc3NvcjogZnVuY3Rpb24gc2V0U3R5bGVBdHRyaWJ1dGVQcmVwcm9jZXNzb3IocHJvcGVydHksIHByb2Nlc3MpIHsKICAgICAgdmFyIHZhbHVlID0gdm9pZCAwOwoKICAgICAgaWYgKHR5cGVvZiBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlc1twcm9wZXJ0eV0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdmFsdWUgPSB7fTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgUmVhY3ROYXRpdmVTdHlsZUF0dHJpYnV0ZXNbcHJvcGVydHldID09PSAnb2JqZWN0JykgewogICAgICAgIHZhbHVlID0gUmVhY3ROYXRpdmVTdHlsZUF0dHJpYnV0ZXNbcHJvcGVydHldOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IocHJvcGVydHkgKyAiIGlzIG5vdCBhIHZhbGlkIHN0eWxlIGF0dHJpYnV0ZSIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKF9fREVWX18gJiYgdHlwZW9mIHZhbHVlLnByb2Nlc3MgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjb25zb2xlLndhcm4oIk92ZXJ3cml0aW5nICIgKyBwcm9wZXJ0eSArICIgc3R5bGUgYXR0cmlidXRlIHByZXByb2Nlc3NvciIpOwogICAgICB9CgogICAgICBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlc1twcm9wZXJ0eV0gPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdmFsdWUsIHsKICAgICAgICBwcm9jZXNzOiBwcm9jZXNzCiAgICAgIH0pOwogICAgfSwKICAgIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlKG9iaikgewogICAgICB2YXIgcmVzdWx0ID0ge307CgogICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgICAgU3R5bGVTaGVldFZhbGlkYXRpb24udmFsaWRhdGVTdHlsZShrZXksIG9iaik7CiAgICAgICAgcmVzdWx0W2tleV0gPSBvYmpba2V5XSAmJiBSZWFjdE5hdGl2ZVByb3BSZWdpc3RyeS5yZWdpc3RlcihvYmpba2V5XSk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgfTsKfSwxNjgsWzE2MywxMDIsMTQ3LDE2OSwxMDFdLCJTdHlsZVNoZWV0Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgSW1hZ2VTdHlsZVByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJJbWFnZVN0eWxlUHJvcFR5cGVzIik7CgogIHZhciBUZXh0U3R5bGVQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiVGV4dFN0eWxlUHJvcFR5cGVzIik7CgogIHZhciBWaWV3U3R5bGVQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiVmlld1N0eWxlUHJvcFR5cGVzIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBSZWFjdFByb3BUeXBlc1NlY3JldCA9ICdTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCc7CgogIHZhciBTdHlsZVNoZWV0VmFsaWRhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFN0eWxlU2hlZXRWYWxpZGF0aW9uKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgU3R5bGVTaGVldFZhbGlkYXRpb24pOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhTdHlsZVNoZWV0VmFsaWRhdGlvbiwgbnVsbCwgW3sKICAgICAga2V5OiAidmFsaWRhdGVTdHlsZVByb3AiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsaWRhdGVTdHlsZVByb3AocHJvcCwgc3R5bGUsIGNhbGxlcikgewogICAgICAgIGlmICghX19ERVZfXykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGFsbFN0eWxlUHJvcFR5cGVzW3Byb3BdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciBtZXNzYWdlMSA9ICciJyArIHByb3AgKyAnIiBpcyBub3QgYSB2YWxpZCBzdHlsZSBwcm9wZXJ0eS4nOwogICAgICAgICAgdmFyIG1lc3NhZ2UyID0gJ1xuVmFsaWQgc3R5bGUgcHJvcHM6ICcgKyBKU09OLnN0cmluZ2lmeShPYmplY3Qua2V5cyhhbGxTdHlsZVByb3BUeXBlcykuc29ydCgpLCBudWxsLCAnICAnKTsKICAgICAgICAgIHN0eWxlRXJyb3IobWVzc2FnZTEsIHN0eWxlLCBjYWxsZXIsIG1lc3NhZ2UyKTsKICAgICAgICB9CgogICAgICAgIHZhciBlcnJvciA9IGFsbFN0eWxlUHJvcFR5cGVzW3Byb3BdKHN0eWxlLCBwcm9wLCBjYWxsZXIsICdwcm9wJywgbnVsbCwgUmVhY3RQcm9wVHlwZXNTZWNyZXQpOwoKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIHN0eWxlRXJyb3IoZXJyb3IubWVzc2FnZSwgc3R5bGUsIGNhbGxlcik7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInZhbGlkYXRlU3R5bGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsaWRhdGVTdHlsZShuYW1lLCBzdHlsZXMpIHsKICAgICAgICBpZiAoIV9fREVWX18pIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIHByb3AgaW4gc3R5bGVzW25hbWVdKSB7CiAgICAgICAgICBTdHlsZVNoZWV0VmFsaWRhdGlvbi52YWxpZGF0ZVN0eWxlUHJvcChwcm9wLCBzdHlsZXNbbmFtZV0sICdTdHlsZVNoZWV0ICcgKyBuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYWRkVmFsaWRTdHlsZVByb3BUeXBlcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRWYWxpZFN0eWxlUHJvcFR5cGVzKHN0eWxlUHJvcFR5cGVzKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlUHJvcFR5cGVzKSB7CiAgICAgICAgICBhbGxTdHlsZVByb3BUeXBlc1trZXldID0gc3R5bGVQcm9wVHlwZXNba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBTdHlsZVNoZWV0VmFsaWRhdGlvbjsKICB9KCk7CgogIHZhciBzdHlsZUVycm9yID0gZnVuY3Rpb24gc3R5bGVFcnJvcihtZXNzYWdlMSwgc3R5bGUsIGNhbGxlciwgbWVzc2FnZTIpIHsKICAgIGludmFyaWFudChmYWxzZSwgbWVzc2FnZTEgKyAnXG4nICsgKGNhbGxlciB8fCAnPDx1bmtub3duPj4nKSArICc6ICcgKyBKU09OLnN0cmluZ2lmeShzdHlsZSwgbnVsbCwgJyAgJykgKyAobWVzc2FnZTIgfHwgJycpKTsKICB9OwoKICB2YXIgYWxsU3R5bGVQcm9wVHlwZXMgPSB7fTsKICBTdHlsZVNoZWV0VmFsaWRhdGlvbi5hZGRWYWxpZFN0eWxlUHJvcFR5cGVzKEltYWdlU3R5bGVQcm9wVHlwZXMpOwogIFN0eWxlU2hlZXRWYWxpZGF0aW9uLmFkZFZhbGlkU3R5bGVQcm9wVHlwZXMoVGV4dFN0eWxlUHJvcFR5cGVzKTsKICBTdHlsZVNoZWV0VmFsaWRhdGlvbi5hZGRWYWxpZFN0eWxlUHJvcFR5cGVzKFZpZXdTdHlsZVByb3BUeXBlcyk7CiAgbW9kdWxlLmV4cG9ydHMgPSBTdHlsZVNoZWV0VmFsaWRhdGlvbjsKfSwxNjksWzE0OCwxNTEsMTM5LDEzXSwiU3R5bGVTaGVldFZhbGlkYXRpb24iKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9Db21wb25lbnRzL1ZpZXcvVmlldy5qcyI7CgogIHZhciBOYXRpdmVNZXRob2RzTWl4aW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTmF0aXZlTWV0aG9kc01peGluIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJQbGF0Zm9ybSIpOwoKICB2YXIgUHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgInByb3AtdHlwZXMiKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlJlYWN0Iik7CgogIHZhciBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlcyIpOwoKICB2YXIgUmVhY3ROYXRpdmVWaWV3QXR0cmlidXRlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzIik7CgogIHZhciBWaWV3UHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgIlZpZXdQcm9wVHlwZXMiKTsKCiAgdmFyIGNyZWF0ZVJlYWN0Q2xhc3MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiY3JlYXRlLXJlYWN0LWNsYXNzIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciByZXF1aXJlTmF0aXZlQ29tcG9uZW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs5XSwgInJlcXVpcmVOYXRpdmVDb21wb25lbnQiKTsKCiAgdmFyIFZpZXcgPSBjcmVhdGVSZWFjdENsYXNzKHsKICAgIGRpc3BsYXlOYW1lOiAnVmlldycsCiAgICBtaXhpbnM6IFtOYXRpdmVNZXRob2RzTWl4aW5dLAogICAgcHJvcFR5cGVzOiBWaWV3UHJvcFR5cGVzLAogICAgdmlld0NvbmZpZzogewogICAgICB1aVZpZXdDbGFzc05hbWU6ICdSQ1RWaWV3JywKICAgICAgdmFsaWRBdHRyaWJ1dGVzOiBSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzLlJDVFZpZXcKICAgIH0sCiAgICBjb250ZXh0VHlwZXM6IHsKICAgICAgaXNJbkFQYXJlbnRUZXh0OiBQcm9wVHlwZXMuYm9vbAogICAgfSwKICAgIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICBpbnZhcmlhbnQoISh0aGlzLmNvbnRleHQuaXNJbkFQYXJlbnRUZXh0ICYmIFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpLCAnTmVzdGluZyBvZiA8Vmlldz4gd2l0aGluIDxUZXh0PiBpcyBub3Qgc3VwcG9ydGVkIG9uIEFuZHJvaWQuJyk7CiAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFJDVFZpZXcsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCB0aGlzLnByb3BzLCB7CiAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICBsaW5lTnVtYmVyOiA3MQogICAgICAgIH0KICAgICAgfSkpOwogICAgfQogIH0pOwogIHZhciBSQ1RWaWV3ID0gcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCgnUkNUVmlldycsIFZpZXcsIHsKICAgIG5hdGl2ZU9ubHk6IHsKICAgICAgbmF0aXZlQmFja2dyb3VuZEFuZHJvaWQ6IHRydWUsCiAgICAgIG5hdGl2ZUZvcmVncm91bmRBbmRyb2lkOiB0cnVlCiAgICB9CiAgfSk7CgogIGlmIChfX0RFVl9fKSB7CiAgICB2YXIgVUlNYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMF0sICJVSU1hbmFnZXIiKTsKCiAgICB2YXIgdmlld0NvbmZpZyA9IFVJTWFuYWdlci52aWV3Q29uZmlncyAmJiBVSU1hbmFnZXIudmlld0NvbmZpZ3MuUkNUVmlldyB8fCB7fTsKCiAgICBmb3IgKHZhciBwcm9wIGluIHZpZXdDb25maWcubmF0aXZlUHJvcHMpIHsKICAgICAgdmFyIHZpZXdBbnkgPSBWaWV3OwoKICAgICAgaWYgKCF2aWV3QW55LnByb3BUeXBlc1twcm9wXSAmJiAhUmVhY3ROYXRpdmVTdHlsZUF0dHJpYnV0ZXNbcHJvcF0pIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1ZpZXcgaXMgbWlzc2luZyBwcm9wVHlwZSBmb3IgbmF0aXZlIHByb3AgYCcgKyBwcm9wICsgJ2AnKTsKICAgICAgfQogICAgfQogIH0KCiAgdmFyIFZpZXdUb0V4cG9ydCA9IFJDVFZpZXc7CgogIGlmIChfX0RFVl9fKSB7CiAgICBWaWV3VG9FeHBvcnQgPSBWaWV3OwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBWaWV3VG9FeHBvcnQ7Cn0sMTcwLFsxMjUsNTIsMTI3LDEzMCwxNDcsMTcxLDEzMSwxNzIsMTMsMTQ1LDEwN10sIlZpZXciKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJSZWFjdE5hdGl2ZVN0eWxlQXR0cmlidXRlcyIpOwoKICB2YXIgUmVhY3ROYXRpdmVWaWV3QXR0cmlidXRlcyA9IHt9OwogIFJlYWN0TmF0aXZlVmlld0F0dHJpYnV0ZXMuVUlWaWV3ID0gewogICAgcG9pbnRlckV2ZW50czogdHJ1ZSwKICAgIGFjY2Vzc2libGU6IHRydWUsCiAgICBhY2Nlc3NpYmlsaXR5QWN0aW9uczogdHJ1ZSwKICAgIGFjY2Vzc2liaWxpdHlMYWJlbDogdHJ1ZSwKICAgIGFjY2Vzc2liaWxpdHlDb21wb25lbnRUeXBlOiB0cnVlLAogICAgYWNjZXNzaWJpbGl0eUxpdmVSZWdpb246IHRydWUsCiAgICBhY2Nlc3NpYmlsaXR5VHJhaXRzOiB0cnVlLAogICAgaW1wb3J0YW50Rm9yQWNjZXNzaWJpbGl0eTogdHJ1ZSwKICAgIG5hdGl2ZUlEOiB0cnVlLAogICAgdGVzdElEOiB0cnVlLAogICAgcmVuZGVyVG9IYXJkd2FyZVRleHR1cmVBbmRyb2lkOiB0cnVlLAogICAgc2hvdWxkUmFzdGVyaXplSU9TOiB0cnVlLAogICAgb25MYXlvdXQ6IHRydWUsCiAgICBvbkFjY2Vzc2liaWxpdHlBY3Rpb246IHRydWUsCiAgICBvbkFjY2Vzc2liaWxpdHlUYXA6IHRydWUsCiAgICBvbk1hZ2ljVGFwOiB0cnVlLAogICAgY29sbGFwc2FibGU6IHRydWUsCiAgICBuZWVkc09mZnNjcmVlbkFscGhhQ29tcG9zaXRpbmc6IHRydWUsCiAgICBzdHlsZTogUmVhY3ROYXRpdmVTdHlsZUF0dHJpYnV0ZXMKICB9OwogIFJlYWN0TmF0aXZlVmlld0F0dHJpYnV0ZXMuUkNUVmlldyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzLlVJVmlldywgewogICAgcmVtb3ZlQ2xpcHBlZFN1YnZpZXdzOiB0cnVlCiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzOwp9LDE3MSxbMTQ3XSwiUmVhY3ROYXRpdmVWaWV3QXR0cmlidXRlcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgInJlYWN0Iik7CgogIHZhciBmYWN0b3J5ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vZmFjdG9yeScpOwoKICBpZiAodHlwZW9mIFJlYWN0ID09PSAndW5kZWZpbmVkJykgewogICAgdGhyb3cgRXJyb3IoJ2NyZWF0ZS1yZWFjdC1jbGFzcyBjb3VsZCBub3QgZmluZCB0aGUgUmVhY3Qgb2JqZWN0LiBJZiB5b3UgYXJlIHVzaW5nIHNjcmlwdCB0YWdzLCAnICsgJ21ha2Ugc3VyZSB0aGF0IFJlYWN0IGlzIGJlaW5nIGxvYWRlZCBiZWZvcmUgY3JlYXRlLXJlYWN0LWNsYXNzLicpOwogIH0KCiAgdmFyIFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlID0gbmV3IFJlYWN0LkNvbXBvbmVudCgpLnVwZGF0ZXI7CiAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KFJlYWN0LkNvbXBvbmVudCwgUmVhY3QuaXNWYWxpZEVsZW1lbnQsIFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlKTsKfSwxNzIsWzEwOCwxNzNdLCJjcmVhdGUtcmVhY3QtY2xhc3MvaW5kZXguanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfYXNzaWduID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIm9iamVjdC1hc3NpZ24iKTsKCiAgdmFyIGVtcHR5T2JqZWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImZianMvbGliL2VtcHR5T2JqZWN0Iik7CgogIHZhciBfaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgdmFyIHdhcm5pbmcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiZmJqcy9saWIvd2FybmluZyIpOwogIH0KCiAgdmFyIE1JWElOU19LRVkgPSAnbWl4aW5zJzsKCiAgZnVuY3Rpb24gaWRlbnRpdHkoZm4pIHsKICAgIHJldHVybiBmbjsKICB9CgogIHZhciBSZWFjdFByb3BUeXBlTG9jYXRpb25OYW1lczsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIFJlYWN0UHJvcFR5cGVMb2NhdGlvbk5hbWVzID0gewogICAgICBwcm9wOiAncHJvcCcsCiAgICAgIGNvbnRleHQ6ICdjb250ZXh0JywKICAgICAgY2hpbGRDb250ZXh0OiAnY2hpbGQgY29udGV4dCcKICAgIH07CiAgfSBlbHNlIHsKICAgIFJlYWN0UHJvcFR5cGVMb2NhdGlvbk5hbWVzID0ge307CiAgfQoKICBmdW5jdGlvbiBmYWN0b3J5KFJlYWN0Q29tcG9uZW50LCBpc1ZhbGlkRWxlbWVudCwgUmVhY3ROb29wVXBkYXRlUXVldWUpIHsKICAgIHZhciBpbmplY3RlZE1peGlucyA9IFtdOwogICAgdmFyIFJlYWN0Q2xhc3NJbnRlcmZhY2UgPSB7CiAgICAgIG1peGluczogJ0RFRklORV9NQU5ZJywKICAgICAgc3RhdGljczogJ0RFRklORV9NQU5ZJywKICAgICAgcHJvcFR5cGVzOiAnREVGSU5FX01BTlknLAogICAgICBjb250ZXh0VHlwZXM6ICdERUZJTkVfTUFOWScsCiAgICAgIGNoaWxkQ29udGV4dFR5cGVzOiAnREVGSU5FX01BTlknLAogICAgICBnZXREZWZhdWx0UHJvcHM6ICdERUZJTkVfTUFOWV9NRVJHRUQnLAogICAgICBnZXRJbml0aWFsU3RhdGU6ICdERUZJTkVfTUFOWV9NRVJHRUQnLAogICAgICBnZXRDaGlsZENvbnRleHQ6ICdERUZJTkVfTUFOWV9NRVJHRUQnLAogICAgICByZW5kZXI6ICdERUZJTkVfT05DRScsCiAgICAgIGNvbXBvbmVudFdpbGxNb3VudDogJ0RFRklORV9NQU5ZJywKICAgICAgY29tcG9uZW50RGlkTW91bnQ6ICdERUZJTkVfTUFOWScsCiAgICAgIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHM6ICdERUZJTkVfTUFOWScsCiAgICAgIHNob3VsZENvbXBvbmVudFVwZGF0ZTogJ0RFRklORV9PTkNFJywKICAgICAgY29tcG9uZW50V2lsbFVwZGF0ZTogJ0RFRklORV9NQU5ZJywKICAgICAgY29tcG9uZW50RGlkVXBkYXRlOiAnREVGSU5FX01BTlknLAogICAgICBjb21wb25lbnRXaWxsVW5tb3VudDogJ0RFRklORV9NQU5ZJywKICAgICAgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudDogJ0RFRklORV9NQU5ZJywKICAgICAgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHM6ICdERUZJTkVfTUFOWScsCiAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlOiAnREVGSU5FX01BTlknLAogICAgICB1cGRhdGVDb21wb25lbnQ6ICdPVkVSUklERV9CQVNFJwogICAgfTsKICAgIHZhciBSZWFjdENsYXNzU3RhdGljSW50ZXJmYWNlID0gewogICAgICBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM6ICdERUZJTkVfTUFOWV9NRVJHRUQnCiAgICB9OwogICAgdmFyIFJFU0VSVkVEX1NQRUNfS0VZUyA9IHsKICAgICAgZGlzcGxheU5hbWU6IGZ1bmN0aW9uIGRpc3BsYXlOYW1lKENvbnN0cnVjdG9yLCBfZGlzcGxheU5hbWUpIHsKICAgICAgICBDb25zdHJ1Y3Rvci5kaXNwbGF5TmFtZSA9IF9kaXNwbGF5TmFtZTsKICAgICAgfSwKICAgICAgbWl4aW5zOiBmdW5jdGlvbiBtaXhpbnMoQ29uc3RydWN0b3IsIF9taXhpbnMpIHsKICAgICAgICBpZiAoX21peGlucykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBfbWl4aW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIG1peFNwZWNJbnRvQ29tcG9uZW50KENvbnN0cnVjdG9yLCBfbWl4aW5zW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNoaWxkQ29udGV4dFR5cGVzOiBmdW5jdGlvbiBjaGlsZENvbnRleHRUeXBlcyhDb25zdHJ1Y3RvciwgX2NoaWxkQ29udGV4dFR5cGVzKSB7CiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgIHZhbGlkYXRlVHlwZURlZihDb25zdHJ1Y3RvciwgX2NoaWxkQ29udGV4dFR5cGVzLCAnY2hpbGRDb250ZXh0Jyk7CiAgICAgICAgfQoKICAgICAgICBDb25zdHJ1Y3Rvci5jaGlsZENvbnRleHRUeXBlcyA9IF9hc3NpZ24oe30sIENvbnN0cnVjdG9yLmNoaWxkQ29udGV4dFR5cGVzLCBfY2hpbGRDb250ZXh0VHlwZXMpOwogICAgICB9LAogICAgICBjb250ZXh0VHlwZXM6IGZ1bmN0aW9uIGNvbnRleHRUeXBlcyhDb25zdHJ1Y3RvciwgX2NvbnRleHRUeXBlcykgewogICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICB2YWxpZGF0ZVR5cGVEZWYoQ29uc3RydWN0b3IsIF9jb250ZXh0VHlwZXMsICdjb250ZXh0Jyk7CiAgICAgICAgfQoKICAgICAgICBDb25zdHJ1Y3Rvci5jb250ZXh0VHlwZXMgPSBfYXNzaWduKHt9LCBDb25zdHJ1Y3Rvci5jb250ZXh0VHlwZXMsIF9jb250ZXh0VHlwZXMpOwogICAgICB9LAogICAgICBnZXREZWZhdWx0UHJvcHM6IGZ1bmN0aW9uIGdldERlZmF1bHRQcm9wcyhDb25zdHJ1Y3RvciwgX2dldERlZmF1bHRQcm9wcykgewogICAgICAgIGlmIChDb25zdHJ1Y3Rvci5nZXREZWZhdWx0UHJvcHMpIHsKICAgICAgICAgIENvbnN0cnVjdG9yLmdldERlZmF1bHRQcm9wcyA9IGNyZWF0ZU1lcmdlZFJlc3VsdEZ1bmN0aW9uKENvbnN0cnVjdG9yLmdldERlZmF1bHRQcm9wcywgX2dldERlZmF1bHRQcm9wcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENvbnN0cnVjdG9yLmdldERlZmF1bHRQcm9wcyA9IF9nZXREZWZhdWx0UHJvcHM7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcm9wVHlwZXM6IGZ1bmN0aW9uIHByb3BUeXBlcyhDb25zdHJ1Y3RvciwgX3Byb3BUeXBlcykgewogICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICB2YWxpZGF0ZVR5cGVEZWYoQ29uc3RydWN0b3IsIF9wcm9wVHlwZXMsICdwcm9wJyk7CiAgICAgICAgfQoKICAgICAgICBDb25zdHJ1Y3Rvci5wcm9wVHlwZXMgPSBfYXNzaWduKHt9LCBDb25zdHJ1Y3Rvci5wcm9wVHlwZXMsIF9wcm9wVHlwZXMpOwogICAgICB9LAogICAgICBzdGF0aWNzOiBmdW5jdGlvbiBzdGF0aWNzKENvbnN0cnVjdG9yLCBfc3RhdGljcykgewogICAgICAgIG1peFN0YXRpY1NwZWNJbnRvQ29tcG9uZW50KENvbnN0cnVjdG9yLCBfc3RhdGljcyk7CiAgICAgIH0sCiAgICAgIGF1dG9iaW5kOiBmdW5jdGlvbiBhdXRvYmluZCgpIHt9CiAgICB9OwoKICAgIGZ1bmN0aW9uIHZhbGlkYXRlVHlwZURlZihDb25zdHJ1Y3RvciwgdHlwZURlZiwgbG9jYXRpb24pIHsKICAgICAgZm9yICh2YXIgcHJvcE5hbWUgaW4gdHlwZURlZikgewogICAgICAgIGlmICh0eXBlRGVmLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgICAgd2FybmluZyh0eXBlb2YgdHlwZURlZltwcm9wTmFtZV0gPT09ICdmdW5jdGlvbicsICclczogJXMgdHlwZSBgJXNgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tICcgKyAnUmVhY3QuUHJvcFR5cGVzLicsIENvbnN0cnVjdG9yLmRpc3BsYXlOYW1lIHx8ICdSZWFjdENsYXNzJywgUmVhY3RQcm9wVHlwZUxvY2F0aW9uTmFtZXNbbG9jYXRpb25dLCBwcm9wTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdmFsaWRhdGVNZXRob2RPdmVycmlkZShpc0FscmVhZHlEZWZpbmVkLCBuYW1lKSB7CiAgICAgIHZhciBzcGVjUG9saWN5ID0gUmVhY3RDbGFzc0ludGVyZmFjZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSA/IFJlYWN0Q2xhc3NJbnRlcmZhY2VbbmFtZV0gOiBudWxsOwoKICAgICAgaWYgKFJlYWN0Q2xhc3NNaXhpbi5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIF9pbnZhcmlhbnQoc3BlY1BvbGljeSA9PT0gJ09WRVJSSURFX0JBU0UnLCAnUmVhY3RDbGFzc0ludGVyZmFjZTogWW91IGFyZSBhdHRlbXB0aW5nIHRvIG92ZXJyaWRlICcgKyAnYCVzYCBmcm9tIHlvdXIgY2xhc3Mgc3BlY2lmaWNhdGlvbi4gRW5zdXJlIHRoYXQgeW91ciBtZXRob2QgbmFtZXMgJyArICdkbyBub3Qgb3ZlcmxhcCB3aXRoIFJlYWN0IG1ldGhvZHMuJywgbmFtZSk7CiAgICAgIH0KCiAgICAgIGlmIChpc0FscmVhZHlEZWZpbmVkKSB7CiAgICAgICAgX2ludmFyaWFudChzcGVjUG9saWN5ID09PSAnREVGSU5FX01BTlknIHx8IHNwZWNQb2xpY3kgPT09ICdERUZJTkVfTUFOWV9NRVJHRUQnLCAnUmVhY3RDbGFzc0ludGVyZmFjZTogWW91IGFyZSBhdHRlbXB0aW5nIHRvIGRlZmluZSAnICsgJ2Alc2Agb24geW91ciBjb21wb25lbnQgbW9yZSB0aGFuIG9uY2UuIFRoaXMgY29uZmxpY3QgbWF5IGJlIGR1ZSAnICsgJ3RvIGEgbWl4aW4uJywgbmFtZSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBtaXhTcGVjSW50b0NvbXBvbmVudChDb25zdHJ1Y3Rvciwgc3BlYykgewogICAgICBpZiAoIXNwZWMpIHsKICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgICAgdmFyIHR5cGVvZlNwZWMgPSB0eXBlb2Ygc3BlYzsKICAgICAgICAgIHZhciBpc01peGluVmFsaWQgPSB0eXBlb2ZTcGVjID09PSAnb2JqZWN0JyAmJiBzcGVjICE9PSBudWxsOwoKICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICAgIHdhcm5pbmcoaXNNaXhpblZhbGlkLCAiJXM6IFlvdSdyZSBhdHRlbXB0aW5nIHRvIGluY2x1ZGUgYSBtaXhpbiB0aGF0IGlzIGVpdGhlciBudWxsICIgKyAnb3Igbm90IGFuIG9iamVjdC4gQ2hlY2sgdGhlIG1peGlucyBpbmNsdWRlZCBieSB0aGUgY29tcG9uZW50LCAnICsgJ2FzIHdlbGwgYXMgYW55IG1peGlucyB0aGV5IGluY2x1ZGUgdGhlbXNlbHZlcy4gJyArICdFeHBlY3RlZCBvYmplY3QgYnV0IGdvdCAlcy4nLCBDb25zdHJ1Y3Rvci5kaXNwbGF5TmFtZSB8fCAnUmVhY3RDbGFzcycsIHNwZWMgPT09IG51bGwgPyBudWxsIDogdHlwZW9mU3BlYyk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIF9pbnZhcmlhbnQodHlwZW9mIHNwZWMgIT09ICdmdW5jdGlvbicsICJSZWFjdENsYXNzOiBZb3UncmUgYXR0ZW1wdGluZyB0byAiICsgJ3VzZSBhIGNvbXBvbmVudCBjbGFzcyBvciBmdW5jdGlvbiBhcyBhIG1peGluLiBJbnN0ZWFkLCBqdXN0IHVzZSBhICcgKyAncmVndWxhciBvYmplY3QuJyk7CgogICAgICBfaW52YXJpYW50KCFpc1ZhbGlkRWxlbWVudChzcGVjKSwgIlJlYWN0Q2xhc3M6IFlvdSdyZSBhdHRlbXB0aW5nIHRvICIgKyAndXNlIGEgY29tcG9uZW50IGFzIGEgbWl4aW4uIEluc3RlYWQsIGp1c3QgdXNlIGEgcmVndWxhciBvYmplY3QuJyk7CgogICAgICB2YXIgcHJvdG8gPSBDb25zdHJ1Y3Rvci5wcm90b3R5cGU7CiAgICAgIHZhciBhdXRvQmluZFBhaXJzID0gcHJvdG8uX19yZWFjdEF1dG9CaW5kUGFpcnM7CgogICAgICBpZiAoc3BlYy5oYXNPd25Qcm9wZXJ0eShNSVhJTlNfS0VZKSkgewogICAgICAgIFJFU0VSVkVEX1NQRUNfS0VZUy5taXhpbnMoQ29uc3RydWN0b3IsIHNwZWMubWl4aW5zKTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgbmFtZSBpbiBzcGVjKSB7CiAgICAgICAgaWYgKCFzcGVjLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGlmIChuYW1lID09PSBNSVhJTlNfS0VZKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIHZhciBwcm9wZXJ0eSA9IHNwZWNbbmFtZV07CiAgICAgICAgdmFyIGlzQWxyZWFkeURlZmluZWQgPSBwcm90by5oYXNPd25Qcm9wZXJ0eShuYW1lKTsKICAgICAgICB2YWxpZGF0ZU1ldGhvZE92ZXJyaWRlKGlzQWxyZWFkeURlZmluZWQsIG5hbWUpOwoKICAgICAgICBpZiAoUkVTRVJWRURfU1BFQ19LRVlTLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICBSRVNFUlZFRF9TUEVDX0tFWVNbbmFtZV0oQ29uc3RydWN0b3IsIHByb3BlcnR5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGlzUmVhY3RDbGFzc01ldGhvZCA9IFJlYWN0Q2xhc3NJbnRlcmZhY2UuaGFzT3duUHJvcGVydHkobmFtZSk7CiAgICAgICAgICB2YXIgaXNGdW5jdGlvbiA9IHR5cGVvZiBwcm9wZXJ0eSA9PT0gJ2Z1bmN0aW9uJzsKICAgICAgICAgIHZhciBzaG91bGRBdXRvQmluZCA9IGlzRnVuY3Rpb24gJiYgIWlzUmVhY3RDbGFzc01ldGhvZCAmJiAhaXNBbHJlYWR5RGVmaW5lZCAmJiBzcGVjLmF1dG9iaW5kICE9PSBmYWxzZTsKCiAgICAgICAgICBpZiAoc2hvdWxkQXV0b0JpbmQpIHsKICAgICAgICAgICAgYXV0b0JpbmRQYWlycy5wdXNoKG5hbWUsIHByb3BlcnR5KTsKICAgICAgICAgICAgcHJvdG9bbmFtZV0gPSBwcm9wZXJ0eTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChpc0FscmVhZHlEZWZpbmVkKSB7CiAgICAgICAgICAgICAgdmFyIHNwZWNQb2xpY3kgPSBSZWFjdENsYXNzSW50ZXJmYWNlW25hbWVdOwoKICAgICAgICAgICAgICBfaW52YXJpYW50KGlzUmVhY3RDbGFzc01ldGhvZCAmJiAoc3BlY1BvbGljeSA9PT0gJ0RFRklORV9NQU5ZX01FUkdFRCcgfHwgc3BlY1BvbGljeSA9PT0gJ0RFRklORV9NQU5ZJyksICdSZWFjdENsYXNzOiBVbmV4cGVjdGVkIHNwZWMgcG9saWN5ICVzIGZvciBrZXkgJXMgJyArICd3aGVuIG1peGluZyBpbiBjb21wb25lbnQgc3BlY3MuJywgc3BlY1BvbGljeSwgbmFtZSk7CgogICAgICAgICAgICAgIGlmIChzcGVjUG9saWN5ID09PSAnREVGSU5FX01BTllfTUVSR0VEJykgewogICAgICAgICAgICAgICAgcHJvdG9bbmFtZV0gPSBjcmVhdGVNZXJnZWRSZXN1bHRGdW5jdGlvbihwcm90b1tuYW1lXSwgcHJvcGVydHkpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3BlY1BvbGljeSA9PT0gJ0RFRklORV9NQU5ZJykgewogICAgICAgICAgICAgICAgcHJvdG9bbmFtZV0gPSBjcmVhdGVDaGFpbmVkRnVuY3Rpb24ocHJvdG9bbmFtZV0sIHByb3BlcnR5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcHJvdG9bbmFtZV0gPSBwcm9wZXJ0eTsKCiAgICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcGVydHkgPT09ICdmdW5jdGlvbicgJiYgc3BlYy5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICBwcm90b1tuYW1lXS5kaXNwbGF5TmFtZSA9IHNwZWMuZGlzcGxheU5hbWUgKyAnXycgKyBuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG1peFN0YXRpY1NwZWNJbnRvQ29tcG9uZW50KENvbnN0cnVjdG9yLCBzdGF0aWNzKSB7CiAgICAgIGlmICghc3RhdGljcykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgZm9yICh2YXIgbmFtZSBpbiBzdGF0aWNzKSB7CiAgICAgICAgdmFyIHByb3BlcnR5ID0gc3RhdGljc1tuYW1lXTsKCiAgICAgICAgaWYgKCFzdGF0aWNzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIHZhciBpc1Jlc2VydmVkID0gbmFtZSBpbiBSRVNFUlZFRF9TUEVDX0tFWVM7CgogICAgICAgIF9pbnZhcmlhbnQoIWlzUmVzZXJ2ZWQsICdSZWFjdENsYXNzOiBZb3UgYXJlIGF0dGVtcHRpbmcgdG8gZGVmaW5lIGEgcmVzZXJ2ZWQgJyArICdwcm9wZXJ0eSwgYCVzYCwgdGhhdCBzaG91bGRuXCd0IGJlIG9uIHRoZSAic3RhdGljcyIga2V5LiBEZWZpbmUgaXQgJyArICdhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBpbnN0ZWFkOyBpdCB3aWxsIHN0aWxsIGJlIGFjY2Vzc2libGUgb24gdGhlICcgKyAnY29uc3RydWN0b3IuJywgbmFtZSk7CgogICAgICAgIHZhciBpc0FscmVhZHlEZWZpbmVkID0gbmFtZSBpbiBDb25zdHJ1Y3RvcjsKCiAgICAgICAgaWYgKGlzQWxyZWFkeURlZmluZWQpIHsKICAgICAgICAgIHZhciBzcGVjUG9saWN5ID0gUmVhY3RDbGFzc1N0YXRpY0ludGVyZmFjZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSA/IFJlYWN0Q2xhc3NTdGF0aWNJbnRlcmZhY2VbbmFtZV0gOiBudWxsOwoKICAgICAgICAgIF9pbnZhcmlhbnQoc3BlY1BvbGljeSA9PT0gJ0RFRklORV9NQU5ZX01FUkdFRCcsICdSZWFjdENsYXNzOiBZb3UgYXJlIGF0dGVtcHRpbmcgdG8gZGVmaW5lICcgKyAnYCVzYCBvbiB5b3VyIGNvbXBvbmVudCBtb3JlIHRoYW4gb25jZS4gVGhpcyBjb25mbGljdCBtYXkgYmUgJyArICdkdWUgdG8gYSBtaXhpbi4nLCBuYW1lKTsKCiAgICAgICAgICBDb25zdHJ1Y3RvcltuYW1lXSA9IGNyZWF0ZU1lcmdlZFJlc3VsdEZ1bmN0aW9uKENvbnN0cnVjdG9yW25hbWVdLCBwcm9wZXJ0eSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBDb25zdHJ1Y3RvcltuYW1lXSA9IHByb3BlcnR5OwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbWVyZ2VJbnRvV2l0aE5vRHVwbGljYXRlS2V5cyhvbmUsIHR3bykgewogICAgICBfaW52YXJpYW50KG9uZSAmJiB0d28gJiYgdHlwZW9mIG9uZSA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHR3byA9PT0gJ29iamVjdCcsICdtZXJnZUludG9XaXRoTm9EdXBsaWNhdGVLZXlzKCk6IENhbm5vdCBtZXJnZSBub24tb2JqZWN0cy4nKTsKCiAgICAgIGZvciAodmFyIGtleSBpbiB0d28pIHsKICAgICAgICBpZiAodHdvLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgIF9pbnZhcmlhbnQob25lW2tleV0gPT09IHVuZGVmaW5lZCwgJ21lcmdlSW50b1dpdGhOb0R1cGxpY2F0ZUtleXMoKTogJyArICdUcmllZCB0byBtZXJnZSB0d28gb2JqZWN0cyB3aXRoIHRoZSBzYW1lIGtleTogYCVzYC4gVGhpcyBjb25mbGljdCAnICsgJ21heSBiZSBkdWUgdG8gYSBtaXhpbjsgaW4gcGFydGljdWxhciwgdGhpcyBtYXkgYmUgY2F1c2VkIGJ5IHR3byAnICsgJ2dldEluaXRpYWxTdGF0ZSgpIG9yIGdldERlZmF1bHRQcm9wcygpIG1ldGhvZHMgcmV0dXJuaW5nIG9iamVjdHMgJyArICd3aXRoIGNsYXNoaW5nIGtleXMuJywga2V5KTsKCiAgICAgICAgICBvbmVba2V5XSA9IHR3b1trZXldOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG9uZTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVNZXJnZWRSZXN1bHRGdW5jdGlvbihvbmUsIHR3bykgewogICAgICByZXR1cm4gZnVuY3Rpb24gbWVyZ2VkUmVzdWx0KCkgewogICAgICAgIHZhciBhID0gb25lLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgdmFyIGIgPSB0d28uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgaWYgKGEgPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGI7CiAgICAgICAgfSBlbHNlIGlmIChiID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBhOwogICAgICAgIH0KCiAgICAgICAgdmFyIGMgPSB7fTsKICAgICAgICBtZXJnZUludG9XaXRoTm9EdXBsaWNhdGVLZXlzKGMsIGEpOwogICAgICAgIG1lcmdlSW50b1dpdGhOb0R1cGxpY2F0ZUtleXMoYywgYik7CiAgICAgICAgcmV0dXJuIGM7CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlQ2hhaW5lZEZ1bmN0aW9uKG9uZSwgdHdvKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiBjaGFpbmVkRnVuY3Rpb24oKSB7CiAgICAgICAgb25lLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgdHdvLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gYmluZEF1dG9CaW5kTWV0aG9kKGNvbXBvbmVudCwgbWV0aG9kKSB7CiAgICAgIHZhciBib3VuZE1ldGhvZCA9IG1ldGhvZC5iaW5kKGNvbXBvbmVudCk7CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIGJvdW5kTWV0aG9kLl9fcmVhY3RCb3VuZENvbnRleHQgPSBjb21wb25lbnQ7CiAgICAgICAgYm91bmRNZXRob2QuX19yZWFjdEJvdW5kTWV0aG9kID0gbWV0aG9kOwogICAgICAgIGJvdW5kTWV0aG9kLl9fcmVhY3RCb3VuZEFyZ3VtZW50cyA9IG51bGw7CiAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBjb21wb25lbnQuY29uc3RydWN0b3IuZGlzcGxheU5hbWU7CiAgICAgICAgdmFyIF9iaW5kID0gYm91bmRNZXRob2QuYmluZDsKCiAgICAgICAgYm91bmRNZXRob2QuYmluZCA9IGZ1bmN0aW9uIChuZXdUaGlzKSB7CiAgICAgICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG5ld1RoaXMgIT09IGNvbXBvbmVudCAmJiBuZXdUaGlzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICAgICAgd2FybmluZyhmYWxzZSwgJ2JpbmQoKTogUmVhY3QgY29tcG9uZW50IG1ldGhvZHMgbWF5IG9ubHkgYmUgYm91bmQgdG8gdGhlICcgKyAnY29tcG9uZW50IGluc3RhbmNlLiBTZWUgJXMnLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICghYXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgICAgICB3YXJuaW5nKGZhbHNlLCAnYmluZCgpOiBZb3UgYXJlIGJpbmRpbmcgYSBjb21wb25lbnQgbWV0aG9kIHRvIHRoZSBjb21wb25lbnQuICcgKyAnUmVhY3QgZG9lcyB0aGlzIGZvciB5b3UgYXV0b21hdGljYWxseSBpbiBhIGhpZ2gtcGVyZm9ybWFuY2UgJyArICd3YXksIHNvIHlvdSBjYW4gc2FmZWx5IHJlbW92ZSB0aGlzIGNhbGwuIFNlZSAlcycsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYm91bmRNZXRob2Q7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHJlYm91bmRNZXRob2QgPSBfYmluZC5hcHBseShib3VuZE1ldGhvZCwgYXJndW1lbnRzKTsKCiAgICAgICAgICByZWJvdW5kTWV0aG9kLl9fcmVhY3RCb3VuZENvbnRleHQgPSBjb21wb25lbnQ7CiAgICAgICAgICByZWJvdW5kTWV0aG9kLl9fcmVhY3RCb3VuZE1ldGhvZCA9IG1ldGhvZDsKICAgICAgICAgIHJlYm91bmRNZXRob2QuX19yZWFjdEJvdW5kQXJndW1lbnRzID0gYXJnczsKICAgICAgICAgIHJldHVybiByZWJvdW5kTWV0aG9kOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiBib3VuZE1ldGhvZDsKICAgIH0KCiAgICBmdW5jdGlvbiBiaW5kQXV0b0JpbmRNZXRob2RzKGNvbXBvbmVudCkgewogICAgICB2YXIgcGFpcnMgPSBjb21wb25lbnQuX19yZWFjdEF1dG9CaW5kUGFpcnM7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhaXJzLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgdmFyIGF1dG9CaW5kS2V5ID0gcGFpcnNbaV07CiAgICAgICAgdmFyIG1ldGhvZCA9IHBhaXJzW2kgKyAxXTsKICAgICAgICBjb21wb25lbnRbYXV0b0JpbmRLZXldID0gYmluZEF1dG9CaW5kTWV0aG9kKGNvbXBvbmVudCwgbWV0aG9kKTsKICAgICAgfQogICAgfQoKICAgIHZhciBJc01vdW50ZWRQcmVNaXhpbiA9IHsKICAgICAgY29tcG9uZW50RGlkTW91bnQ6IGZ1bmN0aW9uIGNvbXBvbmVudERpZE1vdW50KCkgewogICAgICAgIHRoaXMuX19pc01vdW50ZWQgPSB0cnVlOwogICAgICB9CiAgICB9OwogICAgdmFyIElzTW91bnRlZFBvc3RNaXhpbiA9IHsKICAgICAgY29tcG9uZW50V2lsbFVubW91bnQ6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICAgIHRoaXMuX19pc01vdW50ZWQgPSBmYWxzZTsKICAgICAgfQogICAgfTsKICAgIHZhciBSZWFjdENsYXNzTWl4aW4gPSB7CiAgICAgIHJlcGxhY2VTdGF0ZTogZnVuY3Rpb24gcmVwbGFjZVN0YXRlKG5ld1N0YXRlLCBjYWxsYmFjaykgewogICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlUmVwbGFjZVN0YXRlKHRoaXMsIG5ld1N0YXRlLCBjYWxsYmFjayk7CiAgICAgIH0sCiAgICAgIGlzTW91bnRlZDogZnVuY3Rpb24gaXNNb3VudGVkKCkgewogICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICB3YXJuaW5nKHRoaXMuX19kaWRXYXJuSXNNb3VudGVkLCAnJXM6IGlzTW91bnRlZCBpcyBkZXByZWNhdGVkLiBJbnN0ZWFkLCBtYWtlIHN1cmUgdG8gY2xlYW4gdXAgJyArICdzdWJzY3JpcHRpb25zIGFuZCBwZW5kaW5nIHJlcXVlc3RzIGluIGNvbXBvbmVudFdpbGxVbm1vdW50IHRvICcgKyAncHJldmVudCBtZW1vcnkgbGVha3MuJywgdGhpcy5jb25zdHJ1Y3RvciAmJiB0aGlzLmNvbnN0cnVjdG9yLmRpc3BsYXlOYW1lIHx8IHRoaXMubmFtZSB8fCAnQ29tcG9uZW50Jyk7CiAgICAgICAgICB0aGlzLl9fZGlkV2FybklzTW91bnRlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gISF0aGlzLl9faXNNb3VudGVkOwogICAgICB9CiAgICB9OwoKICAgIHZhciBSZWFjdENsYXNzQ29tcG9uZW50ID0gZnVuY3Rpb24gUmVhY3RDbGFzc0NvbXBvbmVudCgpIHt9OwoKICAgIF9hc3NpZ24oUmVhY3RDbGFzc0NvbXBvbmVudC5wcm90b3R5cGUsIFJlYWN0Q29tcG9uZW50LnByb3RvdHlwZSwgUmVhY3RDbGFzc01peGluKTsKCiAgICBmdW5jdGlvbiBjcmVhdGVDbGFzcyhzcGVjKSB7CiAgICAgIHZhciBDb25zdHJ1Y3RvciA9IGlkZW50aXR5KGZ1bmN0aW9uIChwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICB3YXJuaW5nKHRoaXMgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvciwgJ1NvbWV0aGluZyBpcyBjYWxsaW5nIGEgUmVhY3QgY29tcG9uZW50IGRpcmVjdGx5LiBVc2UgYSBmYWN0b3J5IG9yICcgKyAnSlNYIGluc3RlYWQuIFNlZTogaHR0cHM6Ly9mYi5tZS9yZWFjdC1sZWdhY3lmYWN0b3J5Jyk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fX3JlYWN0QXV0b0JpbmRQYWlycy5sZW5ndGgpIHsKICAgICAgICAgIGJpbmRBdXRvQmluZE1ldGhvZHModGhpcyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnByb3BzID0gcHJvcHM7CiAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICB0aGlzLnJlZnMgPSBlbXB0eU9iamVjdDsKICAgICAgICB0aGlzLnVwZGF0ZXIgPSB1cGRhdGVyIHx8IFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlOwogICAgICAgIHRoaXMuc3RhdGUgPSBudWxsOwogICAgICAgIHZhciBpbml0aWFsU3RhdGUgPSB0aGlzLmdldEluaXRpYWxTdGF0ZSA/IHRoaXMuZ2V0SW5pdGlhbFN0YXRlKCkgOiBudWxsOwoKICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgICAgaWYgKGluaXRpYWxTdGF0ZSA9PT0gdW5kZWZpbmVkICYmIHRoaXMuZ2V0SW5pdGlhbFN0YXRlLl9pc01vY2tGdW5jdGlvbikgewogICAgICAgICAgICBpbml0aWFsU3RhdGUgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgX2ludmFyaWFudCh0eXBlb2YgaW5pdGlhbFN0YXRlID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheShpbml0aWFsU3RhdGUpLCAnJXMuZ2V0SW5pdGlhbFN0YXRlKCk6IG11c3QgcmV0dXJuIGFuIG9iamVjdCBvciBudWxsJywgQ29uc3RydWN0b3IuZGlzcGxheU5hbWUgfHwgJ1JlYWN0Q29tcG9zaXRlQ29tcG9uZW50Jyk7CgogICAgICAgIHRoaXMuc3RhdGUgPSBpbml0aWFsU3RhdGU7CiAgICAgIH0pOwogICAgICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSBuZXcgUmVhY3RDbGFzc0NvbXBvbmVudCgpOwogICAgICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDb25zdHJ1Y3RvcjsKICAgICAgQ29uc3RydWN0b3IucHJvdG90eXBlLl9fcmVhY3RBdXRvQmluZFBhaXJzID0gW107CiAgICAgIGluamVjdGVkTWl4aW5zLmZvckVhY2gobWl4U3BlY0ludG9Db21wb25lbnQuYmluZChudWxsLCBDb25zdHJ1Y3RvcikpOwogICAgICBtaXhTcGVjSW50b0NvbXBvbmVudChDb25zdHJ1Y3RvciwgSXNNb3VudGVkUHJlTWl4aW4pOwogICAgICBtaXhTcGVjSW50b0NvbXBvbmVudChDb25zdHJ1Y3Rvciwgc3BlYyk7CiAgICAgIG1peFNwZWNJbnRvQ29tcG9uZW50KENvbnN0cnVjdG9yLCBJc01vdW50ZWRQb3N0TWl4aW4pOwoKICAgICAgaWYgKENvbnN0cnVjdG9yLmdldERlZmF1bHRQcm9wcykgewogICAgICAgIENvbnN0cnVjdG9yLmRlZmF1bHRQcm9wcyA9IENvbnN0cnVjdG9yLmdldERlZmF1bHRQcm9wcygpOwogICAgICB9CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIGlmIChDb25zdHJ1Y3Rvci5nZXREZWZhdWx0UHJvcHMpIHsKICAgICAgICAgIENvbnN0cnVjdG9yLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCA9IHt9OwogICAgICAgIH0KCiAgICAgICAgaWYgKENvbnN0cnVjdG9yLnByb3RvdHlwZS5nZXRJbml0aWFsU3RhdGUpIHsKICAgICAgICAgIENvbnN0cnVjdG9yLnByb3RvdHlwZS5nZXRJbml0aWFsU3RhdGUuaXNSZWFjdENsYXNzQXBwcm92ZWQgPSB7fTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIF9pbnZhcmlhbnQoQ29uc3RydWN0b3IucHJvdG90eXBlLnJlbmRlciwgJ2NyZWF0ZUNsYXNzKC4uLik6IENsYXNzIHNwZWNpZmljYXRpb24gbXVzdCBpbXBsZW1lbnQgYSBgcmVuZGVyYCBtZXRob2QuJyk7CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIHdhcm5pbmcoIUNvbnN0cnVjdG9yLnByb3RvdHlwZS5jb21wb25lbnRTaG91bGRVcGRhdGUsICclcyBoYXMgYSBtZXRob2QgY2FsbGVkICcgKyAnY29tcG9uZW50U2hvdWxkVXBkYXRlKCkuIERpZCB5b3UgbWVhbiBzaG91bGRDb21wb25lbnRVcGRhdGUoKT8gJyArICdUaGUgbmFtZSBpcyBwaHJhc2VkIGFzIGEgcXVlc3Rpb24gYmVjYXVzZSB0aGUgZnVuY3Rpb24gaXMgJyArICdleHBlY3RlZCB0byByZXR1cm4gYSB2YWx1ZS4nLCBzcGVjLmRpc3BsYXlOYW1lIHx8ICdBIGNvbXBvbmVudCcpOwogICAgICAgIHdhcm5pbmcoIUNvbnN0cnVjdG9yLnByb3RvdHlwZS5jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzLCAnJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCAnICsgJ2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMoKS4gRGlkIHlvdSBtZWFuIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8nLCBzcGVjLmRpc3BsYXlOYW1lIHx8ICdBIGNvbXBvbmVudCcpOwogICAgICAgIHdhcm5pbmcoIUNvbnN0cnVjdG9yLnByb3RvdHlwZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcywgJyVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMoKS4gJyArICdEaWQgeW91IG1lYW4gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8nLCBzcGVjLmRpc3BsYXlOYW1lIHx8ICdBIGNvbXBvbmVudCcpOwogICAgICB9CgogICAgICBmb3IgKHZhciBtZXRob2ROYW1lIGluIFJlYWN0Q2xhc3NJbnRlcmZhY2UpIHsKICAgICAgICBpZiAoIUNvbnN0cnVjdG9yLnByb3RvdHlwZVttZXRob2ROYW1lXSkgewogICAgICAgICAgQ29uc3RydWN0b3IucHJvdG90eXBlW21ldGhvZE5hbWVdID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBDb25zdHJ1Y3RvcjsKICAgIH0KCiAgICByZXR1cm4gY3JlYXRlQ2xhc3M7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGZhY3Rvcnk7Cn0sMTczLFsxMTAsMTExLDEzLDU2XSwiY3JlYXRlLXJlYWN0LWNsYXNzL2ZhY3RvcnkuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfY2xhc3MsCiAgICAgIF90ZW1wLAogICAgICBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9BUlQvUmVhY3ROYXRpdmVBUlQuanMiLAogICAgICBfY2xhc3MyLAogICAgICBfdGVtcDI7CgogIHZhciBDb2xvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJhcnQvY29yZS9jb2xvciIpOwoKICB2YXIgUGF0aCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJBUlRTZXJpYWxpemFibGVQYXRoIik7CgogIHZhciBUcmFuc2Zvcm0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiYXJ0L2NvcmUvdHJhbnNmb3JtIik7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJSZWFjdCIpOwoKICB2YXIgUHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgInByb3AtdHlwZXMiKTsKCiAgdmFyIFJlYWN0TmF0aXZlVmlld0F0dHJpYnV0ZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiUmVhY3ROYXRpdmVWaWV3QXR0cmlidXRlcyIpOwoKICB2YXIgY3JlYXRlUmVhY3ROYXRpdmVDb21wb25lbnRDbGFzcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJjcmVhdGVSZWFjdE5hdGl2ZUNvbXBvbmVudENsYXNzIik7CgogIHZhciBtZXJnZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJtZXJnZSIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4XSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICBmdW5jdGlvbiBhcnJheURpZmZlcihhLCBiKSB7CiAgICBpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykgewogICAgICBpZiAoYVtpXSAhPT0gYltpXSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgZnVuY3Rpb24gZm9udEFuZExpbmVzRGlmZmVyKGEsIGIpIHsKICAgIGlmIChhID09PSBiKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZiAoYS5mb250ICE9PSBiLmZvbnQpIHsKICAgICAgaWYgKGEuZm9udCA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBpZiAoYi5mb250ID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIGlmIChhLmZvbnQuZm9udEZhbWlseSAhPT0gYi5mb250LmZvbnRGYW1pbHkgfHwgYS5mb250LmZvbnRTaXplICE9PSBiLmZvbnQuZm9udFNpemUgfHwgYS5mb250LmZvbnRXZWlnaHQgIT09IGIuZm9udC5mb250V2VpZ2h0IHx8IGEuZm9udC5mb250U3R5bGUgIT09IGIuZm9udC5mb250U3R5bGUpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBhcnJheURpZmZlcihhLmxpbmVzLCBiLmxpbmVzKTsKICB9CgogIHZhciBTdXJmYWNlVmlld0F0dHJpYnV0ZXMgPSBtZXJnZShSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzLlVJVmlldywge30pOwogIHZhciBOb2RlQXR0cmlidXRlcyA9IHsKICAgIHRyYW5zZm9ybTogewogICAgICBkaWZmOiBhcnJheURpZmZlcgogICAgfSwKICAgIG9wYWNpdHk6IHRydWUKICB9OwogIHZhciBHcm91cEF0dHJpYnV0ZXMgPSBtZXJnZShOb2RlQXR0cmlidXRlcywgewogICAgY2xpcHBpbmc6IHsKICAgICAgZGlmZjogYXJyYXlEaWZmZXIKICAgIH0KICB9KTsKICB2YXIgUmVuZGVyYWJsZUF0dHJpYnV0ZXMgPSBtZXJnZShOb2RlQXR0cmlidXRlcywgewogICAgZmlsbDogewogICAgICBkaWZmOiBhcnJheURpZmZlcgogICAgfSwKICAgIHN0cm9rZTogewogICAgICBkaWZmOiBhcnJheURpZmZlcgogICAgfSwKICAgIHN0cm9rZVdpZHRoOiB0cnVlLAogICAgc3Ryb2tlQ2FwOiB0cnVlLAogICAgc3Ryb2tlSm9pbjogdHJ1ZSwKICAgIHN0cm9rZURhc2g6IHsKICAgICAgZGlmZjogYXJyYXlEaWZmZXIKICAgIH0KICB9KTsKICB2YXIgU2hhcGVBdHRyaWJ1dGVzID0gbWVyZ2UoUmVuZGVyYWJsZUF0dHJpYnV0ZXMsIHsKICAgIGQ6IHsKICAgICAgZGlmZjogYXJyYXlEaWZmZXIKICAgIH0KICB9KTsKICB2YXIgVGV4dEF0dHJpYnV0ZXMgPSBtZXJnZShSZW5kZXJhYmxlQXR0cmlidXRlcywgewogICAgYWxpZ25tZW50OiB0cnVlLAogICAgZnJhbWU6IHsKICAgICAgZGlmZjogZm9udEFuZExpbmVzRGlmZmVyCiAgICB9LAogICAgcGF0aDogewogICAgICBkaWZmOiBhcnJheURpZmZlcgogICAgfQogIH0pOwogIHZhciBOYXRpdmVTdXJmYWNlVmlldyA9IGNyZWF0ZVJlYWN0TmF0aXZlQ29tcG9uZW50Q2xhc3MoJ0FSVFN1cmZhY2VWaWV3JywgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHsKICAgICAgdmFsaWRBdHRyaWJ1dGVzOiBTdXJmYWNlVmlld0F0dHJpYnV0ZXMsCiAgICAgIHVpVmlld0NsYXNzTmFtZTogJ0FSVFN1cmZhY2VWaWV3JwogICAgfTsKICB9KTsKICB2YXIgTmF0aXZlR3JvdXAgPSBjcmVhdGVSZWFjdE5hdGl2ZUNvbXBvbmVudENsYXNzKCdBUlRHcm91cCcsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB7CiAgICAgIHZhbGlkQXR0cmlidXRlczogR3JvdXBBdHRyaWJ1dGVzLAogICAgICB1aVZpZXdDbGFzc05hbWU6ICdBUlRHcm91cCcKICAgIH07CiAgfSk7CiAgdmFyIE5hdGl2ZVNoYXBlID0gY3JlYXRlUmVhY3ROYXRpdmVDb21wb25lbnRDbGFzcygnQVJUU2hhcGUnLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gewogICAgICB2YWxpZEF0dHJpYnV0ZXM6IFNoYXBlQXR0cmlidXRlcywKICAgICAgdWlWaWV3Q2xhc3NOYW1lOiAnQVJUU2hhcGUnCiAgICB9OwogIH0pOwogIHZhciBOYXRpdmVUZXh0ID0gY3JlYXRlUmVhY3ROYXRpdmVDb21wb25lbnRDbGFzcygnQVJUVGV4dCcsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB7CiAgICAgIHZhbGlkQXR0cmlidXRlczogVGV4dEF0dHJpYnV0ZXMsCiAgICAgIHVpVmlld0NsYXNzTmFtZTogJ0FSVFRleHQnCiAgICB9OwogIH0pOwoKICBmdW5jdGlvbiBjaGlsZHJlbkFzU3RyaW5nKGNoaWxkcmVuKSB7CiAgICBpZiAoIWNoaWxkcmVuKSB7CiAgICAgIHJldHVybiAnJzsKICAgIH0KCiAgICBpZiAodHlwZW9mIGNoaWxkcmVuID09PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gY2hpbGRyZW47CiAgICB9CgogICAgaWYgKGNoaWxkcmVuLmxlbmd0aCkgewogICAgICByZXR1cm4gY2hpbGRyZW4uam9pbignXG4nKTsKICAgIH0KCiAgICByZXR1cm4gJyc7CiAgfQoKICB2YXIgU3VyZmFjZSA9IChfdGVtcCA9IF9jbGFzcyA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoU3VyZmFjZSwgX1JlYWN0JENvbXBvbmVudCk7CgogICAgZnVuY3Rpb24gU3VyZmFjZSgpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFN1cmZhY2UpOwogICAgICByZXR1cm4gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKFN1cmZhY2UuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihTdXJmYWNlKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFN1cmZhY2UsIFt7CiAgICAgIGtleTogImdldENoaWxkQ29udGV4dCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRDaGlsZENvbnRleHQoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGlzSW5TdXJmYWNlOiB0cnVlCiAgICAgICAgfTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBwcm9wcyA9IHRoaXMucHJvcHM7CiAgICAgICAgdmFyIHcgPSBleHRyYWN0TnVtYmVyKHByb3BzLndpZHRoLCAwKTsKICAgICAgICB2YXIgaCA9IGV4dHJhY3ROdW1iZXIocHJvcHMuaGVpZ2h0LCAwKTsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgIE5hdGl2ZVN1cmZhY2VWaWV3LAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogW3Byb3BzLnN0eWxlLCB7CiAgICAgICAgICAgICAgd2lkdGg6IHcsCiAgICAgICAgICAgICAgaGVpZ2h0OiBoCiAgICAgICAgICAgIH1dLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMTU5CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICB0aGlzLnByb3BzLmNoaWxkcmVuCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFN1cmZhY2U7CiAgfShSZWFjdC5Db21wb25lbnQpLCBfY2xhc3MuY2hpbGRDb250ZXh0VHlwZXMgPSB7CiAgICBpc0luU3VyZmFjZTogUHJvcFR5cGVzLmJvb2wKICB9LCBfdGVtcCk7CgogIGZ1bmN0aW9uIGV4dHJhY3ROdW1iZXIodmFsdWUsIGRlZmF1bHRWYWx1ZSkgewogICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIH0KCiAgICByZXR1cm4gK3ZhbHVlOwogIH0KCiAgdmFyIHBvb2xlZFRyYW5zZm9ybSA9IG5ldyBUcmFuc2Zvcm0oKTsKCiAgZnVuY3Rpb24gZXh0cmFjdFRyYW5zZm9ybShwcm9wcykgewogICAgdmFyIHNjYWxlWCA9IHByb3BzLnNjYWxlWCAhPSBudWxsID8gcHJvcHMuc2NhbGVYIDogcHJvcHMuc2NhbGUgIT0gbnVsbCA/IHByb3BzLnNjYWxlIDogMTsKICAgIHZhciBzY2FsZVkgPSBwcm9wcy5zY2FsZVkgIT0gbnVsbCA/IHByb3BzLnNjYWxlWSA6IHByb3BzLnNjYWxlICE9IG51bGwgPyBwcm9wcy5zY2FsZSA6IDE7CiAgICBwb29sZWRUcmFuc2Zvcm0udHJhbnNmb3JtVG8oMSwgMCwgMCwgMSwgMCwgMCkubW92ZShwcm9wcy54IHx8IDAsIHByb3BzLnkgfHwgMCkucm90YXRlKHByb3BzLnJvdGF0aW9uIHx8IDAsIHByb3BzLm9yaWdpblgsIHByb3BzLm9yaWdpblkpLnNjYWxlKHNjYWxlWCwgc2NhbGVZLCBwcm9wcy5vcmlnaW5YLCBwcm9wcy5vcmlnaW5ZKTsKCiAgICBpZiAocHJvcHMudHJhbnNmb3JtICE9IG51bGwpIHsKICAgICAgcG9vbGVkVHJhbnNmb3JtLnRyYW5zZm9ybShwcm9wcy50cmFuc2Zvcm0pOwogICAgfQoKICAgIHJldHVybiBbcG9vbGVkVHJhbnNmb3JtLnh4LCBwb29sZWRUcmFuc2Zvcm0ueXgsIHBvb2xlZFRyYW5zZm9ybS54eSwgcG9vbGVkVHJhbnNmb3JtLnl5LCBwb29sZWRUcmFuc2Zvcm0ueCwgcG9vbGVkVHJhbnNmb3JtLnldOwogIH0KCiAgZnVuY3Rpb24gZXh0cmFjdE9wYWNpdHkocHJvcHMpIHsKICAgIGlmIChwcm9wcy52aXNpYmxlID09PSBmYWxzZSkgewogICAgICByZXR1cm4gMDsKICAgIH0KCiAgICBpZiAocHJvcHMub3BhY2l0eSA9PSBudWxsKSB7CiAgICAgIHJldHVybiAxOwogICAgfQoKICAgIHJldHVybiArcHJvcHMub3BhY2l0eTsKICB9CgogIHZhciBHcm91cCA9IChfdGVtcDIgPSBfY2xhc3MyID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQyKSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoR3JvdXAsIF9SZWFjdCRDb21wb25lbnQyKTsKCiAgICBmdW5jdGlvbiBHcm91cCgpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEdyb3VwKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChHcm91cC5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEdyb3VwKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEdyb3VwLCBbewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBwcm9wcyA9IHRoaXMucHJvcHM7CiAgICAgICAgaW52YXJpYW50KHRoaXMuY29udGV4dC5pc0luU3VyZmFjZSwgJ0FSVDogPEdyb3VwIC8+IG11c3QgYmUgYSBjaGlsZCBvZiBhIDxTdXJmYWNlIC8+Jyk7CiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBOYXRpdmVHcm91cCwKICAgICAgICAgIHsKICAgICAgICAgICAgb3BhY2l0eTogZXh0cmFjdE9wYWNpdHkocHJvcHMpLAogICAgICAgICAgICB0cmFuc2Zvcm06IGV4dHJhY3RUcmFuc2Zvcm0ocHJvcHMpLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMjMxCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICB0aGlzLnByb3BzLmNoaWxkcmVuCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEdyb3VwOwogIH0oUmVhY3QuQ29tcG9uZW50KSwgX2NsYXNzMi5jb250ZXh0VHlwZXMgPSB7CiAgICBpc0luU3VyZmFjZTogUHJvcFR5cGVzLmJvb2wuaXNSZXF1aXJlZAogIH0sIF90ZW1wMik7CgogIHZhciBDbGlwcGluZ1JlY3RhbmdsZSA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50MykgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKENsaXBwaW5nUmVjdGFuZ2xlLCBfUmVhY3QkQ29tcG9uZW50Myk7CgogICAgZnVuY3Rpb24gQ2xpcHBpbmdSZWN0YW5nbGUoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBDbGlwcGluZ1JlY3RhbmdsZSk7CiAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoQ2xpcHBpbmdSZWN0YW5nbGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihDbGlwcGluZ1JlY3RhbmdsZSkpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhDbGlwcGluZ1JlY3RhbmdsZSwgW3sKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICB2YXIgcHJvcHMgPSB0aGlzLnByb3BzOwogICAgICAgIHZhciB4ID0gZXh0cmFjdE51bWJlcihwcm9wcy54LCAwKTsKICAgICAgICB2YXIgeSA9IGV4dHJhY3ROdW1iZXIocHJvcHMueSwgMCk7CiAgICAgICAgdmFyIHcgPSBleHRyYWN0TnVtYmVyKHByb3BzLndpZHRoLCAwKTsKICAgICAgICB2YXIgaCA9IGV4dHJhY3ROdW1iZXIocHJvcHMuaGVpZ2h0LCAwKTsKICAgICAgICB2YXIgY2xpcHBpbmcgPSBbeCwgeSwgdywgaF07CiAgICAgICAgdmFyIHByb3BzRXhjbHVkaW5nWEFuZFkgPSBtZXJnZShwcm9wcyk7CiAgICAgICAgZGVsZXRlIHByb3BzRXhjbHVkaW5nWEFuZFkueDsKICAgICAgICBkZWxldGUgcHJvcHNFeGNsdWRpbmdYQW5kWS55OwogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgTmF0aXZlR3JvdXAsCiAgICAgICAgICB7CiAgICAgICAgICAgIGNsaXBwaW5nOiBjbGlwcGluZywKICAgICAgICAgICAgb3BhY2l0eTogZXh0cmFjdE9wYWNpdHkocHJvcHMpLAogICAgICAgICAgICB0cmFuc2Zvcm06IGV4dHJhY3RUcmFuc2Zvcm0ocHJvcHNFeGNsdWRpbmdYQW5kWSksCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAyNTMKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHRoaXMucHJvcHMuY2hpbGRyZW4KICAgICAgICApOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQ2xpcHBpbmdSZWN0YW5nbGU7CiAgfShSZWFjdC5Db21wb25lbnQpOwoKICB2YXIgU09MSURfQ09MT1IgPSAwOwogIHZhciBMSU5FQVJfR1JBRElFTlQgPSAxOwogIHZhciBSQURJQUxfR1JBRElFTlQgPSAyOwogIHZhciBQQVRURVJOID0gMzsKCiAgZnVuY3Rpb24gaW5zZXJ0Q29sb3JJbnRvQXJyYXkoY29sb3IsIHRhcmdldEFycmF5LCBhdEluZGV4KSB7CiAgICB2YXIgYyA9IG5ldyBDb2xvcihjb2xvcik7CiAgICB0YXJnZXRBcnJheVthdEluZGV4ICsgMF0gPSBjLnJlZCAvIDI1NTsKICAgIHRhcmdldEFycmF5W2F0SW5kZXggKyAxXSA9IGMuZ3JlZW4gLyAyNTU7CiAgICB0YXJnZXRBcnJheVthdEluZGV4ICsgMl0gPSBjLmJsdWUgLyAyNTU7CiAgICB0YXJnZXRBcnJheVthdEluZGV4ICsgM10gPSBjLmFscGhhOwogIH0KCiAgZnVuY3Rpb24gaW5zZXJ0Q29sb3JzSW50b0FycmF5KHN0b3BzLCB0YXJnZXRBcnJheSwgYXRJbmRleCkgewogICAgdmFyIGkgPSAwOwoKICAgIGlmICgnbGVuZ3RoJyBpbiBzdG9wcykgewogICAgICB3aGlsZSAoaSA8IHN0b3BzLmxlbmd0aCkgewogICAgICAgIGluc2VydENvbG9ySW50b0FycmF5KHN0b3BzW2ldLCB0YXJnZXRBcnJheSwgYXRJbmRleCArIGkgKiA0KTsKICAgICAgICBpKys7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAodmFyIG9mZnNldCBpbiBzdG9wcykgewogICAgICAgIGluc2VydENvbG9ySW50b0FycmF5KHN0b3BzW29mZnNldF0sIHRhcmdldEFycmF5LCBhdEluZGV4ICsgaSAqIDQpOwogICAgICAgIGkrKzsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBhdEluZGV4ICsgaSAqIDQ7CiAgfQoKICBmdW5jdGlvbiBpbnNlcnRPZmZzZXRzSW50b0FycmF5KHN0b3BzLCB0YXJnZXRBcnJheSwgYXRJbmRleCwgbXVsdGksIHJldmVyc2UpIHsKICAgIHZhciBvZmZzZXROdW1iZXI7CiAgICB2YXIgaSA9IDA7CgogICAgaWYgKCdsZW5ndGgnIGluIHN0b3BzKSB7CiAgICAgIHdoaWxlIChpIDwgc3RvcHMubGVuZ3RoKSB7CiAgICAgICAgb2Zmc2V0TnVtYmVyID0gaSAvIChzdG9wcy5sZW5ndGggLSAxKSAqIG11bHRpOwogICAgICAgIHRhcmdldEFycmF5W2F0SW5kZXggKyBpXSA9IHJldmVyc2UgPyAxIC0gb2Zmc2V0TnVtYmVyIDogb2Zmc2V0TnVtYmVyOwogICAgICAgIGkrKzsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yICh2YXIgb2Zmc2V0U3RyaW5nIGluIHN0b3BzKSB7CiAgICAgICAgb2Zmc2V0TnVtYmVyID0gK29mZnNldFN0cmluZyAqIG11bHRpOwogICAgICAgIHRhcmdldEFycmF5W2F0SW5kZXggKyBpXSA9IHJldmVyc2UgPyAxIC0gb2Zmc2V0TnVtYmVyIDogb2Zmc2V0TnVtYmVyOwogICAgICAgIGkrKzsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBhdEluZGV4ICsgaTsKICB9CgogIGZ1bmN0aW9uIGluc2VydENvbG9yU3RvcHNJbnRvQXJyYXkoc3RvcHMsIHRhcmdldEFycmF5LCBhdEluZGV4KSB7CiAgICB2YXIgbGFzdEluZGV4ID0gaW5zZXJ0Q29sb3JzSW50b0FycmF5KHN0b3BzLCB0YXJnZXRBcnJheSwgYXRJbmRleCk7CiAgICBpbnNlcnRPZmZzZXRzSW50b0FycmF5KHN0b3BzLCB0YXJnZXRBcnJheSwgbGFzdEluZGV4LCAxLCBmYWxzZSk7CiAgfQoKICBmdW5jdGlvbiBpbnNlcnREb3VibGVDb2xvclN0b3BzSW50b0FycmF5KHN0b3BzLCB0YXJnZXRBcnJheSwgYXRJbmRleCkgewogICAgdmFyIGxhc3RJbmRleCA9IGluc2VydENvbG9yc0ludG9BcnJheShzdG9wcywgdGFyZ2V0QXJyYXksIGF0SW5kZXgpOwogICAgbGFzdEluZGV4ID0gaW5zZXJ0Q29sb3JzSW50b0FycmF5KHN0b3BzLCB0YXJnZXRBcnJheSwgbGFzdEluZGV4KTsKICAgIGxhc3RJbmRleCA9IGluc2VydE9mZnNldHNJbnRvQXJyYXkoc3RvcHMsIHRhcmdldEFycmF5LCBsYXN0SW5kZXgsIDAuNSwgZmFsc2UpOwogICAgaW5zZXJ0T2Zmc2V0c0ludG9BcnJheShzdG9wcywgdGFyZ2V0QXJyYXksIGxhc3RJbmRleCwgMC41LCB0cnVlKTsKICB9CgogIGZ1bmN0aW9uIGFwcGx5Qm91bmRpbmdCb3hUb0JydXNoRGF0YShicnVzaERhdGEsIHByb3BzKSB7CiAgICB2YXIgdHlwZSA9IGJydXNoRGF0YVswXTsKICAgIHZhciB3aWR0aCA9ICtwcm9wcy53aWR0aDsKICAgIHZhciBoZWlnaHQgPSArcHJvcHMuaGVpZ2h0OwoKICAgIGlmICh0eXBlID09PSBMSU5FQVJfR1JBRElFTlQpIHsKICAgICAgYnJ1c2hEYXRhWzFdICo9IHdpZHRoOwogICAgICBicnVzaERhdGFbMl0gKj0gaGVpZ2h0OwogICAgICBicnVzaERhdGFbM10gKj0gd2lkdGg7CiAgICAgIGJydXNoRGF0YVs0XSAqPSBoZWlnaHQ7CiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IFJBRElBTF9HUkFESUVOVCkgewogICAgICBicnVzaERhdGFbMV0gKj0gd2lkdGg7CiAgICAgIGJydXNoRGF0YVsyXSAqPSBoZWlnaHQ7CiAgICAgIGJydXNoRGF0YVszXSAqPSB3aWR0aDsKICAgICAgYnJ1c2hEYXRhWzRdICo9IGhlaWdodDsKICAgICAgYnJ1c2hEYXRhWzVdICo9IHdpZHRoOwogICAgICBicnVzaERhdGFbNl0gKj0gaGVpZ2h0OwogICAgfSBlbHNlIGlmICh0eXBlID09PSBQQVRURVJOKSB7fQogIH0KCiAgZnVuY3Rpb24gZXh0cmFjdEJydXNoKGNvbG9yT3JCcnVzaCwgcHJvcHMpIHsKICAgIGlmIChjb2xvck9yQnJ1c2ggPT0gbnVsbCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBpZiAoY29sb3JPckJydXNoLl9icnVzaCkgewogICAgICBpZiAoY29sb3JPckJydXNoLl9iYikgewogICAgICAgIGFwcGx5Qm91bmRpbmdCb3hUb0JydXNoRGF0YShjb2xvck9yQnJ1c2guX2JydXNoLCBwcm9wcyk7CiAgICAgICAgY29sb3JPckJydXNoLl9iYiA9IGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gY29sb3JPckJydXNoLl9icnVzaDsKICAgIH0KCiAgICB2YXIgYyA9IG5ldyBDb2xvcihjb2xvck9yQnJ1c2gpOwogICAgcmV0dXJuIFtTT0xJRF9DT0xPUiwgYy5yZWQgLyAyNTUsIGMuZ3JlZW4gLyAyNTUsIGMuYmx1ZSAvIDI1NSwgYy5hbHBoYV07CiAgfQoKICBmdW5jdGlvbiBleHRyYWN0Q29sb3IoY29sb3IpIHsKICAgIGlmIChjb2xvciA9PSBudWxsKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHZhciBjID0gbmV3IENvbG9yKGNvbG9yKTsKICAgIHJldHVybiBbYy5yZWQgLyAyNTUsIGMuZ3JlZW4gLyAyNTUsIGMuYmx1ZSAvIDI1NSwgYy5hbHBoYV07CiAgfQoKICBmdW5jdGlvbiBleHRyYWN0U3Ryb2tlQ2FwKHN0cm9rZUNhcCkgewogICAgc3dpdGNoIChzdHJva2VDYXApIHsKICAgICAgY2FzZSAnYnV0dCc6CiAgICAgICAgcmV0dXJuIDA7CgogICAgICBjYXNlICdzcXVhcmUnOgogICAgICAgIHJldHVybiAyOwoKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gMTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGV4dHJhY3RTdHJva2VKb2luKHN0cm9rZUpvaW4pIHsKICAgIHN3aXRjaCAoc3Ryb2tlSm9pbikgewogICAgICBjYXNlICdtaXRlcic6CiAgICAgICAgcmV0dXJuIDA7CgogICAgICBjYXNlICdiZXZlbCc6CiAgICAgICAgcmV0dXJuIDI7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiAxOwogICAgfQogIH0KCiAgdmFyIFNoYXBlID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQ0KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoU2hhcGUsIF9SZWFjdCRDb21wb25lbnQ0KTsKCiAgICBmdW5jdGlvbiBTaGFwZSgpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFNoYXBlKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChTaGFwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKFNoYXBlKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFNoYXBlLCBbewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBwcm9wcyA9IHRoaXMucHJvcHM7CiAgICAgICAgdmFyIHBhdGggPSBwcm9wcy5kIHx8IGNoaWxkcmVuQXNTdHJpbmcocHJvcHMuY2hpbGRyZW4pOwogICAgICAgIHZhciBkID0gKHBhdGggaW5zdGFuY2VvZiBQYXRoID8gcGF0aCA6IG5ldyBQYXRoKHBhdGgpKS50b0pTT04oKTsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChOYXRpdmVTaGFwZSwgewogICAgICAgICAgZmlsbDogZXh0cmFjdEJydXNoKHByb3BzLmZpbGwsIHByb3BzKSwKICAgICAgICAgIG9wYWNpdHk6IGV4dHJhY3RPcGFjaXR5KHByb3BzKSwKICAgICAgICAgIHN0cm9rZTogZXh0cmFjdENvbG9yKHByb3BzLnN0cm9rZSksCiAgICAgICAgICBzdHJva2VDYXA6IGV4dHJhY3RTdHJva2VDYXAocHJvcHMuc3Ryb2tlQ2FwKSwKICAgICAgICAgIHN0cm9rZURhc2g6IHByb3BzLnN0cm9rZURhc2ggfHwgbnVsbCwKICAgICAgICAgIHN0cm9rZUpvaW46IGV4dHJhY3RTdHJva2VKb2luKHByb3BzLnN0cm9rZUpvaW4pLAogICAgICAgICAgc3Ryb2tlV2lkdGg6IGV4dHJhY3ROdW1iZXIocHJvcHMuc3Ryb2tlV2lkdGgsIDEpLAogICAgICAgICAgdHJhbnNmb3JtOiBleHRyYWN0VHJhbnNmb3JtKHByb3BzKSwKICAgICAgICAgIGQ6IGQsCiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiA0MDEKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFNoYXBlOwogIH0oUmVhY3QuQ29tcG9uZW50KTsKCiAgdmFyIGNhY2hlZEZvbnRPYmplY3RzRnJvbVN0cmluZyA9IHt9OwogIHZhciBmb250RmFtaWx5UHJlZml4ID0gL15bXHMiJ10qLzsKICB2YXIgZm9udEZhbWlseVN1ZmZpeCA9IC9bXHMiJ10qJC87CgogIGZ1bmN0aW9uIGV4dHJhY3RTaW5nbGVGb250RmFtaWx5KGZvbnRGYW1pbHlTdHJpbmcpIHsKICAgIHJldHVybiBmb250RmFtaWx5U3RyaW5nLnNwbGl0KCcsJylbMF0ucmVwbGFjZShmb250RmFtaWx5UHJlZml4LCAnJykucmVwbGFjZShmb250RmFtaWx5U3VmZml4LCAnJyk7CiAgfQoKICBmdW5jdGlvbiBwYXJzZUZvbnRTdHJpbmcoZm9udCkgewogICAgaWYgKGNhY2hlZEZvbnRPYmplY3RzRnJvbVN0cmluZy5oYXNPd25Qcm9wZXJ0eShmb250KSkgewogICAgICByZXR1cm4gY2FjaGVkRm9udE9iamVjdHNGcm9tU3RyaW5nW2ZvbnRdOwogICAgfQoKICAgIHZhciByZWdleHAgPSAvXlxzKigoPzooPzpub3JtYWx8Ym9sZHxpdGFsaWMpXHMrKSopKD86KFxkKyg/OlwuXGQrKT8pW3B0ZXhtXCVdKig/OlxzKlwvLio/KT9ccyspP1xzKlwiPyhbXlwiXSopL2k7CiAgICB2YXIgbWF0Y2ggPSByZWdleHAuZXhlYyhmb250KTsKCiAgICBpZiAoIW1hdGNoKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHZhciBmb250RmFtaWx5ID0gZXh0cmFjdFNpbmdsZUZvbnRGYW1pbHkobWF0Y2hbM10pOwogICAgdmFyIGZvbnRTaXplID0gK21hdGNoWzJdIHx8IDEyOwogICAgdmFyIGlzQm9sZCA9IC9ib2xkLy5leGVjKG1hdGNoWzFdKTsKICAgIHZhciBpc0l0YWxpYyA9IC9pdGFsaWMvLmV4ZWMobWF0Y2hbMV0pOwogICAgY2FjaGVkRm9udE9iamVjdHNGcm9tU3RyaW5nW2ZvbnRdID0gewogICAgICBmb250RmFtaWx5OiBmb250RmFtaWx5LAogICAgICBmb250U2l6ZTogZm9udFNpemUsCiAgICAgIGZvbnRXZWlnaHQ6IGlzQm9sZCA/ICdib2xkJyA6ICdub3JtYWwnLAogICAgICBmb250U3R5bGU6IGlzSXRhbGljID8gJ2l0YWxpYycgOiAnbm9ybWFsJwogICAgfTsKICAgIHJldHVybiBjYWNoZWRGb250T2JqZWN0c0Zyb21TdHJpbmdbZm9udF07CiAgfQoKICBmdW5jdGlvbiBleHRyYWN0Rm9udChmb250KSB7CiAgICBpZiAoZm9udCA9PSBudWxsKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGlmICh0eXBlb2YgZm9udCA9PT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuIHBhcnNlRm9udFN0cmluZyhmb250KTsKICAgIH0KCiAgICB2YXIgZm9udEZhbWlseSA9IGV4dHJhY3RTaW5nbGVGb250RmFtaWx5KGZvbnQuZm9udEZhbWlseSk7CiAgICB2YXIgZm9udFNpemUgPSArZm9udC5mb250U2l6ZSB8fCAxMjsKICAgIHZhciBmb250V2VpZ2h0ID0gZm9udC5mb250V2VpZ2h0ICE9IG51bGwgPyBmb250LmZvbnRXZWlnaHQudG9TdHJpbmcoKSA6ICc0MDAnOwogICAgcmV0dXJuIHsKICAgICAgZm9udEZhbWlseTogZm9udEZhbWlseSwKICAgICAgZm9udFNpemU6IGZvbnRTaXplLAogICAgICBmb250V2VpZ2h0OiBmb250V2VpZ2h0LAogICAgICBmb250U3R5bGU6IGZvbnQuZm9udFN0eWxlCiAgICB9OwogIH0KCiAgdmFyIG5ld0xpbmUgPSAvXG4vZzsKCiAgZnVuY3Rpb24gZXh0cmFjdEZvbnRBbmRMaW5lcyhmb250LCB0ZXh0KSB7CiAgICByZXR1cm4gewogICAgICBmb250OiBleHRyYWN0Rm9udChmb250KSwKICAgICAgbGluZXM6IHRleHQuc3BsaXQobmV3TGluZSkKICAgIH07CiAgfQoKICBmdW5jdGlvbiBleHRyYWN0QWxpZ25tZW50KGFsaWdubWVudCkgewogICAgc3dpdGNoIChhbGlnbm1lbnQpIHsKICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgIHJldHVybiAxOwoKICAgICAgY2FzZSAnY2VudGVyJzoKICAgICAgICByZXR1cm4gMjsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CiAgfQoKICB2YXIgVGV4dCA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50NSkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKFRleHQsIF9SZWFjdCRDb21wb25lbnQ1KTsKCiAgICBmdW5jdGlvbiBUZXh0KCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgVGV4dCk7CiAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoVGV4dC5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKFRleHQpKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoVGV4dCwgW3sKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICB2YXIgcHJvcHMgPSB0aGlzLnByb3BzOwogICAgICAgIHZhciBwYXRoID0gcHJvcHMucGF0aDsKICAgICAgICB2YXIgdGV4dFBhdGggPSBwYXRoID8gKHBhdGggaW5zdGFuY2VvZiBQYXRoID8gcGF0aCA6IG5ldyBQYXRoKHBhdGgpKS50b0pTT04oKSA6IG51bGw7CiAgICAgICAgdmFyIHRleHRGcmFtZSA9IGV4dHJhY3RGb250QW5kTGluZXMocHJvcHMuZm9udCwgY2hpbGRyZW5Bc1N0cmluZyhwcm9wcy5jaGlsZHJlbikpOwogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KE5hdGl2ZVRleHQsIHsKICAgICAgICAgIGZpbGw6IGV4dHJhY3RCcnVzaChwcm9wcy5maWxsLCBwcm9wcyksCiAgICAgICAgICBvcGFjaXR5OiBleHRyYWN0T3BhY2l0eShwcm9wcyksCiAgICAgICAgICBzdHJva2U6IGV4dHJhY3RDb2xvcihwcm9wcy5zdHJva2UpLAogICAgICAgICAgc3Ryb2tlQ2FwOiBleHRyYWN0U3Ryb2tlQ2FwKHByb3BzLnN0cm9rZUNhcCksCiAgICAgICAgICBzdHJva2VEYXNoOiBwcm9wcy5zdHJva2VEYXNoIHx8IG51bGwsCiAgICAgICAgICBzdHJva2VKb2luOiBleHRyYWN0U3Ryb2tlSm9pbihwcm9wcy5zdHJva2VKb2luKSwKICAgICAgICAgIHN0cm9rZVdpZHRoOiBleHRyYWN0TnVtYmVyKHByb3BzLnN0cm9rZVdpZHRoLCAxKSwKICAgICAgICAgIHRyYW5zZm9ybTogZXh0cmFjdFRyYW5zZm9ybShwcm9wcyksCiAgICAgICAgICBhbGlnbm1lbnQ6IGV4dHJhY3RBbGlnbm1lbnQocHJvcHMuYWxpZ25tZW50KSwKICAgICAgICAgIGZyYW1lOiB0ZXh0RnJhbWUsCiAgICAgICAgICBwYXRoOiB0ZXh0UGF0aCwKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDUwMAogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gVGV4dDsKICB9KFJlYWN0LkNvbXBvbmVudCk7CgogIGZ1bmN0aW9uIExpbmVhckdyYWRpZW50KHN0b3BzLCB4MSwgeTEsIHgyLCB5MikgewogICAgdmFyIHR5cGUgPSBMSU5FQVJfR1JBRElFTlQ7CgogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCA1KSB7CiAgICAgIHZhciBhbmdsZSA9ICh4MSA9PSBudWxsID8gMjcwIDogeDEpICogTWF0aC5QSSAvIDE4MDsKICAgICAgdmFyIHggPSBNYXRoLmNvcyhhbmdsZSk7CiAgICAgIHZhciB5ID0gLU1hdGguc2luKGFuZ2xlKTsKICAgICAgdmFyIGwgPSAoTWF0aC5hYnMoeCkgKyBNYXRoLmFicyh5KSkgLyAyOwogICAgICB4ICo9IGw7CiAgICAgIHkgKj0gbDsKICAgICAgeDEgPSAwLjUgLSB4OwogICAgICB4MiA9IDAuNSArIHg7CiAgICAgIHkxID0gMC41IC0geTsKICAgICAgeTIgPSAwLjUgKyB5OwogICAgICB0aGlzLl9iYiA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9iYiA9IGZhbHNlOwogICAgfQoKICAgIHZhciBicnVzaERhdGEgPSBbdHlwZSwgK3gxLCAreTEsICt4MiwgK3kyXTsKICAgIGluc2VydENvbG9yU3RvcHNJbnRvQXJyYXkoc3RvcHMsIGJydXNoRGF0YSwgNSk7CiAgICB0aGlzLl9icnVzaCA9IGJydXNoRGF0YTsKICB9CgogIGZ1bmN0aW9uIFJhZGlhbEdyYWRpZW50KHN0b3BzLCBmeCwgZnksIHJ4LCByeSwgY3gsIGN5KSB7CiAgICBpZiAocnkgPT0gbnVsbCkgewogICAgICByeSA9IHJ4OwogICAgfQoKICAgIGlmIChjeCA9PSBudWxsKSB7CiAgICAgIGN4ID0gZng7CiAgICB9CgogICAgaWYgKGN5ID09IG51bGwpIHsKICAgICAgY3kgPSBmeTsKICAgIH0KCiAgICBpZiAoZnggPT0gbnVsbCkgewogICAgICBmeCA9IGZ5ID0gcnggPSByeSA9IGN4ID0gY3kgPSAwLjU7CiAgICAgIHRoaXMuX2JiID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2JiID0gZmFsc2U7CiAgICB9CgogICAgdmFyIGJydXNoRGF0YSA9IFtSQURJQUxfR1JBRElFTlQsICtmeCwgK2Z5LCArcnggKiAyLCArcnkgKiAyLCArY3gsICtjeV07CiAgICBpbnNlcnREb3VibGVDb2xvclN0b3BzSW50b0FycmF5KHN0b3BzLCBicnVzaERhdGEsIDcpOwogICAgdGhpcy5fYnJ1c2ggPSBicnVzaERhdGE7CiAgfQoKICBmdW5jdGlvbiBQYXR0ZXJuKHVybCwgd2lkdGgsIGhlaWdodCwgbGVmdCwgdG9wKSB7CiAgICB0aGlzLl9icnVzaCA9IFtQQVRURVJOLCB1cmwsICtsZWZ0IHx8IDAsICt0b3AgfHwgMCwgK3dpZHRoLCAraGVpZ2h0XTsKICB9CgogIHZhciBSZWFjdEFSVCA9IHsKICAgIExpbmVhckdyYWRpZW50OiBMaW5lYXJHcmFkaWVudCwKICAgIFJhZGlhbEdyYWRpZW50OiBSYWRpYWxHcmFkaWVudCwKICAgIFBhdHRlcm46IFBhdHRlcm4sCiAgICBUcmFuc2Zvcm06IFRyYW5zZm9ybSwKICAgIFBhdGg6IFBhdGgsCiAgICBTdXJmYWNlOiBTdXJmYWNlLAogICAgR3JvdXA6IEdyb3VwLAogICAgQ2xpcHBpbmdSZWN0YW5nbGU6IENsaXBwaW5nUmVjdGFuZ2xlLAogICAgU2hhcGU6IFNoYXBlLAogICAgVGV4dDogVGV4dAogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBSZWFjdEFSVDsKfSwxNzQsWzE3NSwxNzYsMTc5LDEzMCwxMjcsMTcxLDE1NiwxMzQsMTNdLCJSZWFjdE5hdGl2ZUFSVCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewoJdmFyIGNvbG9ycyA9IHsKCQltYXJvb246ICcjODAwMDAwJywKCQlyZWQ6ICcjZmYwMDAwJywKCQlvcmFuZ2U6ICcjZmZBNTAwJywKCQl5ZWxsb3c6ICcjZmZmZjAwJywKCQlvbGl2ZTogJyM4MDgwMDAnLAoJCXB1cnBsZTogJyM4MDAwODAnLAoJCWZ1Y2hzaWE6ICIjZmYwMGZmIiwKCQl3aGl0ZTogJyNmZmZmZmYnLAoJCWxpbWU6ICcjMDBmZjAwJywKCQlncmVlbjogJyMwMDgwMDAnLAoJCW5hdnk6ICcjMDAwMDgwJywKCQlibHVlOiAnIzAwMDBmZicsCgkJYXF1YTogJyMwMGZmZmYnLAoJCXRlYWw6ICcjMDA4MDgwJywKCQlibGFjazogJyMwMDAwMDAnLAoJCXNpbHZlcjogJyNjMGMwYzAnLAoJCWdyYXk6ICcjODA4MDgwJwoJfTsKCgl2YXIgbWFwID0gZnVuY3Rpb24gbWFwKGFycmF5LCBmbikgewoJCXZhciByZXN1bHRzID0gW107CgoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkJCXJlc3VsdHNbaV0gPSBmbihhcnJheVtpXSwgaSk7CgkJfQoKCQlyZXR1cm4gcmVzdWx0czsKCX07CgoJdmFyIENvbG9yID0gZnVuY3Rpb24gQ29sb3IoY29sb3IsIHR5cGUpIHsKCQlpZiAoY29sb3IuaXNDb2xvcikgewoJCQl0aGlzLnJlZCA9IGNvbG9yLnJlZDsKCQkJdGhpcy5ncmVlbiA9IGNvbG9yLmdyZWVuOwoJCQl0aGlzLmJsdWUgPSBjb2xvci5ibHVlOwoJCQl0aGlzLmFscGhhID0gY29sb3IuYWxwaGE7CgkJfSBlbHNlIHsKCQkJdmFyIG5hbWVkQ29sb3IgPSBjb2xvcnNbY29sb3JdOwoKCQkJaWYgKG5hbWVkQ29sb3IpIHsKCQkJCWNvbG9yID0gbmFtZWRDb2xvcjsKCQkJCXR5cGUgPSAnaGV4JzsKCQkJfQoKCQkJc3dpdGNoICh0eXBlb2YgY29sb3IpIHsKCQkJCWNhc2UgJ3N0cmluZyc6CgkJCQkJaWYgKCF0eXBlKSB0eXBlID0gKHR5cGUgPSBjb2xvci5tYXRjaCgvXnJnYnxeaHNifF5oc2wvKSkgPyB0eXBlWzBdIDogJ2hleCc7CgkJCQkJYnJlYWs7CgoJCQkJY2FzZSAnb2JqZWN0JzoKCQkJCQl0eXBlID0gdHlwZSB8fCAncmdiJzsKCQkJCQljb2xvciA9IGNvbG9yLnRvU3RyaW5nKCk7CgkJCQkJYnJlYWs7CgoJCQkJY2FzZSAnbnVtYmVyJzoKCQkJCQl0eXBlID0gJ2hleCc7CgkJCQkJY29sb3IgPSBjb2xvci50b1N0cmluZygxNik7CgkJCQkJYnJlYWs7CgkJCX0KCgkJCWNvbG9yID0gQ29sb3JbJ3BhcnNlJyArIHR5cGUudG9VcHBlckNhc2UoKV0oY29sb3IpOwoJCQl0aGlzLnJlZCA9IGNvbG9yWzBdOwoJCQl0aGlzLmdyZWVuID0gY29sb3JbMV07CgkJCXRoaXMuYmx1ZSA9IGNvbG9yWzJdOwoJCQl0aGlzLmFscGhhID0gY29sb3JbM107CgkJfQoKCQl0aGlzLmlzQ29sb3IgPSB0cnVlOwoJfTsKCgl2YXIgbGltaXQgPSBmdW5jdGlvbiBsaW1pdChudW1iZXIsIG1pbiwgbWF4KSB7CgkJcmV0dXJuIE1hdGgubWluKG1heCwgTWF0aC5tYXgobWluLCBudW1iZXIpKTsKCX07CgoJdmFyIGxpc3RNYXRjaCA9IC8oWy0uXGRdK1wlPylccyosXHMqKFstLlxkXStcJT8pXHMqLFxzKihbLS5cZF0rXCU/KVxzKiw/XHMqKFstLlxkXSpcJT8pLzsKCXZhciBoZXhNYXRjaCA9IC9eIz8oW2EtZjAtOV17MSwyfSkoW2EtZjAtOV17MSwyfSkoW2EtZjAtOV17MSwyfSkoW2EtZjAtOV17MCwyfSkkL2k7CgoJQ29sb3IucGFyc2VSR0IgPSBmdW5jdGlvbiAoY29sb3IpIHsKCQlyZXR1cm4gbWFwKGNvbG9yLm1hdGNoKGxpc3RNYXRjaCkuc2xpY2UoMSksIGZ1bmN0aW9uIChiaXQsIGkpIHsKCQkJaWYgKGJpdCkgYml0ID0gcGFyc2VGbG9hdChiaXQpICogKGJpdFtiaXQubGVuZ3RoIC0gMV0gPT0gJyUnID8gMi41NSA6IDEpOwoJCQlyZXR1cm4gaSA8IDMgPyBNYXRoLnJvdW5kKChiaXQgJT0gMjU2KSA8IDAgPyBiaXQgKyAyNTYgOiBiaXQpIDogbGltaXQoYml0ID09PSAnJyA/IDEgOiBOdW1iZXIoYml0KSwgMCwgMSk7CgkJfSk7Cgl9OwoKCUNvbG9yLnBhcnNlSEVYID0gZnVuY3Rpb24gKGNvbG9yKSB7CgkJaWYgKGNvbG9yLmxlbmd0aCA9PSAxKSBjb2xvciA9IGNvbG9yICsgY29sb3IgKyBjb2xvcjsKCQlyZXR1cm4gbWFwKGNvbG9yLm1hdGNoKGhleE1hdGNoKS5zbGljZSgxKSwgZnVuY3Rpb24gKGJpdCwgaSkgewoJCQlpZiAoaSA9PSAzKSByZXR1cm4gYml0ID8gcGFyc2VJbnQoYml0LCAxNikgLyAyNTUgOiAxOwoJCQlyZXR1cm4gcGFyc2VJbnQoYml0Lmxlbmd0aCA9PSAxID8gYml0ICsgYml0IDogYml0LCAxNik7CgkJfSk7Cgl9OwoKCUNvbG9yLnBhcnNlSFNCID0gZnVuY3Rpb24gKGNvbG9yKSB7CgkJdmFyIGhzYiA9IG1hcChjb2xvci5tYXRjaChsaXN0TWF0Y2gpLnNsaWNlKDEpLCBmdW5jdGlvbiAoYml0LCBpKSB7CgkJCWlmIChiaXQpIGJpdCA9IHBhcnNlRmxvYXQoYml0KTsKCQkJaWYgKGkgPT09IDApIHJldHVybiBNYXRoLnJvdW5kKChiaXQgJT0gMzYwKSA8IDAgPyBiaXQgKyAzNjAgOiBiaXQpO2Vsc2UgaWYgKGkgPCAzKSByZXR1cm4gbGltaXQoTWF0aC5yb3VuZChiaXQpLCAwLCAxMDApO2Vsc2UgcmV0dXJuIGxpbWl0KGJpdCA9PT0gJycgPyAxIDogTnVtYmVyKGJpdCksIDAsIDEpOwoJCX0pOwoJCXZhciBhID0gaHNiWzNdOwoJCXZhciBiciA9IE1hdGgucm91bmQoaHNiWzJdIC8gMTAwICogMjU1KTsKCQlpZiAoaHNiWzFdID09IDApIHJldHVybiBbYnIsIGJyLCBiciwgYV07CgkJdmFyIGh1ZSA9IGhzYlswXTsKCQl2YXIgZiA9IGh1ZSAlIDYwOwoJCXZhciBwID0gTWF0aC5yb3VuZChoc2JbMl0gKiAoMTAwIC0gaHNiWzFdKSAvIDEwMDAwICogMjU1KTsKCQl2YXIgcSA9IE1hdGgucm91bmQoaHNiWzJdICogKDYwMDAgLSBoc2JbMV0gKiBmKSAvIDYwMDAwMCAqIDI1NSk7CgkJdmFyIHQgPSBNYXRoLnJvdW5kKGhzYlsyXSAqICg2MDAwIC0gaHNiWzFdICogKDYwIC0gZikpIC8gNjAwMDAwICogMjU1KTsKCgkJc3dpdGNoIChNYXRoLmZsb29yKGh1ZSAvIDYwKSkgewoJCQljYXNlIDA6CgkJCQlyZXR1cm4gW2JyLCB0LCBwLCBhXTsKCgkJCWNhc2UgMToKCQkJCXJldHVybiBbcSwgYnIsIHAsIGFdOwoKCQkJY2FzZSAyOgoJCQkJcmV0dXJuIFtwLCBiciwgdCwgYV07CgoJCQljYXNlIDM6CgkJCQlyZXR1cm4gW3AsIHEsIGJyLCBhXTsKCgkJCWNhc2UgNDoKCQkJCXJldHVybiBbdCwgcCwgYnIsIGFdOwoKCQkJZGVmYXVsdDoKCQkJCXJldHVybiBbYnIsIHAsIHEsIGFdOwoJCX0KCX07CgoJQ29sb3IucGFyc2VIU0wgPSBmdW5jdGlvbiAoY29sb3IpIHsKCQl2YXIgaHNiID0gbWFwKGNvbG9yLm1hdGNoKGxpc3RNYXRjaCkuc2xpY2UoMSksIGZ1bmN0aW9uIChiaXQsIGkpIHsKCQkJaWYgKGJpdCkgYml0ID0gcGFyc2VGbG9hdChiaXQpOwoJCQlpZiAoaSA9PT0gMCkgcmV0dXJuIE1hdGgucm91bmQoKGJpdCAlPSAzNjApIDwgMCA/IGJpdCArIDM2MCA6IGJpdCk7ZWxzZSBpZiAoaSA8IDMpIHJldHVybiBsaW1pdChNYXRoLnJvdW5kKGJpdCksIDAsIDEwMCk7ZWxzZSByZXR1cm4gbGltaXQoYml0ID09PSAnJyA/IDEgOiBOdW1iZXIoYml0KSwgMCwgMSk7CgkJfSk7CgkJdmFyIGggPSBoc2JbMF0gLyA2MDsKCQl2YXIgcyA9IGhzYlsxXSAvIDEwMDsKCQl2YXIgbCA9IGhzYlsyXSAvIDEwMDsKCQl2YXIgYSA9IGhzYlszXTsKCQl2YXIgYyA9ICgxIC0gTWF0aC5hYnMoMiAqIGwgLSAxKSkgKiBzOwoJCXZhciB4ID0gYyAqICgxIC0gTWF0aC5hYnMoaCAlIDIgLSAxKSk7CgkJdmFyIG0gPSBsIC0gYyAvIDI7CgkJdmFyIHAgPSBNYXRoLnJvdW5kKChjICsgbSkgKiAyNTUpOwoJCXZhciBxID0gTWF0aC5yb3VuZCgoeCArIG0pICogMjU1KTsKCQl2YXIgdCA9IE1hdGgucm91bmQobSAqIDI1NSk7CgoJCXN3aXRjaCAoTWF0aC5mbG9vcihoKSkgewoJCQljYXNlIDA6CgkJCQlyZXR1cm4gW3AsIHEsIHQsIGFdOwoKCQkJY2FzZSAxOgoJCQkJcmV0dXJuIFtxLCBwLCB0LCBhXTsKCgkJCWNhc2UgMjoKCQkJCXJldHVybiBbdCwgcCwgcSwgYV07CgoJCQljYXNlIDM6CgkJCQlyZXR1cm4gW3QsIHEsIHAsIGFdOwoKCQkJY2FzZSA0OgoJCQkJcmV0dXJuIFtxLCB0LCBwLCBhXTsKCgkJCWRlZmF1bHQ6CgkJCQlyZXR1cm4gW3AsIHQsIHEsIGFdOwoJCX0KCX07CgoJdmFyIHRvU3RyaW5nID0gZnVuY3Rpb24gdG9TdHJpbmcodHlwZSwgYXJyYXkpIHsKCQlpZiAoYXJyYXlbM10gIT0gMSkgdHlwZSArPSAnYSc7ZWxzZSBhcnJheS5wb3AoKTsKCQlyZXR1cm4gdHlwZSArICcoJyArIGFycmF5LmpvaW4oJywgJykgKyAnKSc7Cgl9OwoKCUNvbG9yLnByb3RvdHlwZSA9IHsKCQl0b0hTQjogZnVuY3Rpb24gdG9IU0IoYXJyYXkpIHsKCQkJdmFyIHJlZCA9IHRoaXMucmVkLAoJCQkgICAgZ3JlZW4gPSB0aGlzLmdyZWVuLAoJCQkgICAgYmx1ZSA9IHRoaXMuYmx1ZSwKCQkJICAgIGFscGhhID0gdGhpcy5hbHBoYTsKCQkJdmFyIG1heCA9IE1hdGgubWF4KHJlZCwgZ3JlZW4sIGJsdWUpLAoJCQkgICAgbWluID0gTWF0aC5taW4ocmVkLCBncmVlbiwgYmx1ZSksCgkJCSAgICBkZWx0YSA9IG1heCAtIG1pbjsKCQkJdmFyIGh1ZSA9IDAsCgkJCSAgICBzYXR1cmF0aW9uID0gZGVsdGEgIT0gMCA/IGRlbHRhIC8gbWF4IDogMCwKCQkJICAgIGJyaWdodG5lc3MgPSBtYXggLyAyNTU7CgoJCQlpZiAoc2F0dXJhdGlvbikgewoJCQkJdmFyIHJyID0gKG1heCAtIHJlZCkgLyBkZWx0YSwKCQkJCSAgICBnciA9IChtYXggLSBncmVlbikgLyBkZWx0YSwKCQkJCSAgICBiciA9IChtYXggLSBibHVlKSAvIGRlbHRhOwoJCQkJaHVlID0gcmVkID09IG1heCA/IGJyIC0gZ3IgOiBncmVlbiA9PSBtYXggPyAyICsgcnIgLSBiciA6IDQgKyBnciAtIHJyOwoJCQkJaWYgKChodWUgLz0gNikgPCAwKSBodWUrKzsKCQkJfQoKCQkJdmFyIGhzYiA9IFtNYXRoLnJvdW5kKGh1ZSAqIDM2MCksIE1hdGgucm91bmQoc2F0dXJhdGlvbiAqIDEwMCksIE1hdGgucm91bmQoYnJpZ2h0bmVzcyAqIDEwMCksIGFscGhhXTsKCQkJcmV0dXJuIGFycmF5ID8gaHNiIDogdG9TdHJpbmcoJ2hzYicsIGhzYik7CgkJfSwKCQl0b0hTTDogZnVuY3Rpb24gdG9IU0woYXJyYXkpIHsKCQkJdmFyIHJlZCA9IHRoaXMucmVkLAoJCQkgICAgZ3JlZW4gPSB0aGlzLmdyZWVuLAoJCQkgICAgYmx1ZSA9IHRoaXMuYmx1ZSwKCQkJICAgIGFscGhhID0gdGhpcy5hbHBoYTsKCQkJdmFyIG1heCA9IE1hdGgubWF4KHJlZCwgZ3JlZW4sIGJsdWUpLAoJCQkgICAgbWluID0gTWF0aC5taW4ocmVkLCBncmVlbiwgYmx1ZSksCgkJCSAgICBkZWx0YSA9IG1heCAtIG1pbjsKCQkJdmFyIGh1ZSA9IDAsCgkJCSAgICBzYXR1cmF0aW9uID0gZGVsdGEgIT0gMCA/IGRlbHRhIC8gKDI1NSAtIE1hdGguYWJzKG1heCArIG1pbiAtIDI1NSkpIDogMCwKCQkJICAgIGxpZ2h0bmVzcyA9IChtYXggKyBtaW4pIC8gNTEyOwoKCQkJaWYgKHNhdHVyYXRpb24pIHsKCQkJCXZhciByciA9IChtYXggLSByZWQpIC8gZGVsdGEsCgkJCQkgICAgZ3IgPSAobWF4IC0gZ3JlZW4pIC8gZGVsdGEsCgkJCQkgICAgYnIgPSAobWF4IC0gYmx1ZSkgLyBkZWx0YTsKCQkJCWh1ZSA9IHJlZCA9PSBtYXggPyBiciAtIGdyIDogZ3JlZW4gPT0gbWF4ID8gMiArIHJyIC0gYnIgOiA0ICsgZ3IgLSBycjsKCQkJCWlmICgoaHVlIC89IDYpIDwgMCkgaHVlKys7CgkJCX0KCgkJCXZhciBoc2wgPSBbTWF0aC5yb3VuZChodWUgKiAzNjApLCBNYXRoLnJvdW5kKHNhdHVyYXRpb24gKiAxMDApLCBNYXRoLnJvdW5kKGxpZ2h0bmVzcyAqIDEwMCksIGFscGhhXTsKCQkJcmV0dXJuIGFycmF5ID8gaHNsIDogdG9TdHJpbmcoJ2hzbCcsIGhzbCk7CgkJfSwKCQl0b0hFWDogZnVuY3Rpb24gdG9IRVgoYXJyYXkpIHsKCQkJdmFyIGEgPSB0aGlzLmFscGhhOwoJCQl2YXIgYWxwaGEgPSAoYSA9IE1hdGgucm91bmQoYSAqIDI1NSkudG9TdHJpbmcoMTYpKS5sZW5ndGggPT0gMSA/IGEgKyBhIDogYTsKCQkJdmFyIGhleCA9IG1hcChbdGhpcy5yZWQsIHRoaXMuZ3JlZW4sIHRoaXMuYmx1ZV0sIGZ1bmN0aW9uIChiaXQpIHsKCQkJCWJpdCA9IGJpdC50b1N0cmluZygxNik7CgkJCQlyZXR1cm4gYml0Lmxlbmd0aCA9PSAxID8gJzAnICsgYml0IDogYml0OwoJCQl9KTsKCQkJcmV0dXJuIGFycmF5ID8gaGV4LmNvbmNhdChhbHBoYSkgOiAnIycgKyBoZXguam9pbignJykgKyAoYWxwaGEgPT0gJ2ZmJyA/ICcnIDogYWxwaGEpOwoJCX0sCgkJdG9SR0I6IGZ1bmN0aW9uIHRvUkdCKGFycmF5KSB7CgkJCXZhciByZ2IgPSBbdGhpcy5yZWQsIHRoaXMuZ3JlZW4sIHRoaXMuYmx1ZSwgdGhpcy5hbHBoYV07CgkJCXJldHVybiBhcnJheSA/IHJnYiA6IHRvU3RyaW5nKCdyZ2InLCByZ2IpOwoJCX0KCX07CglDb2xvci5wcm90b3R5cGUudG9TdHJpbmcgPSBDb2xvci5wcm90b3R5cGUudG9SR0I7CgoJQ29sb3IuaGV4ID0gZnVuY3Rpb24gKGhleCkgewoJCXJldHVybiBuZXcgQ29sb3IoaGV4LCAnaGV4Jyk7Cgl9OwoKCWlmICh0aGlzLmhleCA9PSBudWxsKSB0aGlzLmhleCA9IENvbG9yLmhleDsKCglDb2xvci5oc2IgPSBmdW5jdGlvbiAoaCwgcywgYiwgYSkgewoJCXJldHVybiBuZXcgQ29sb3IoW2ggfHwgMCwgcyB8fCAwLCBiIHx8IDAsIGEgPT0gbnVsbCA/IDEgOiBhXSwgJ2hzYicpOwoJfTsKCglpZiAodGhpcy5oc2IgPT0gbnVsbCkgdGhpcy5oc2IgPSBDb2xvci5oc2I7CgoJQ29sb3IuaHNsID0gZnVuY3Rpb24gKGgsIHMsIGwsIGEpIHsKCQlyZXR1cm4gbmV3IENvbG9yKFtoIHx8IDAsIHMgfHwgMCwgbCB8fCAwLCBhID09IG51bGwgPyAxIDogYV0sICdoc2wnKTsKCX07CgoJaWYgKHRoaXMuaHNsID09IG51bGwpIHRoaXMuaHNsID0gQ29sb3IuaHNsOwoKCUNvbG9yLnJnYiA9IGZ1bmN0aW9uIChyLCBnLCBiLCBhKSB7CgkJcmV0dXJuIG5ldyBDb2xvcihbciB8fCAwLCBnIHx8IDAsIGIgfHwgMCwgYSA9PSBudWxsID8gMSA6IGFdLCAncmdiJyk7Cgl9OwoKCWlmICh0aGlzLnJnYiA9PSBudWxsKSB0aGlzLnJnYiA9IENvbG9yLnJnYjsKCglDb2xvci5kZXRhY2ggPSBmdW5jdGlvbiAoY29sb3IpIHsKCQljb2xvciA9IG5ldyBDb2xvcihjb2xvcik7CgkJcmV0dXJuIFtDb2xvci5yZ2IoY29sb3IucmVkLCBjb2xvci5ncmVlbiwgY29sb3IuYmx1ZSkudG9TdHJpbmcoKSwgY29sb3IuYWxwaGFdOwoJfTsKCgltb2R1bGUuZXhwb3J0cyA9IENvbG9yOwp9LDE3NSxbXSwiYXJ0L2NvcmUvY29sb3IuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBDbGFzcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJhcnQvY29yZS9jbGFzcy5qcyIpOwoKICB2YXIgUGF0aCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJhcnQvY29yZS9wYXRoLmpzIik7CgogIHZhciBNT1ZFX1RPID0gMDsKICB2YXIgQ0xPU0UgPSAxOwogIHZhciBMSU5FX1RPID0gMjsKICB2YXIgQ1VSVkVfVE8gPSAzOwogIHZhciBBUkMgPSA0OwogIHZhciBTZXJpYWxpemFibGVQYXRoID0gQ2xhc3MoUGF0aCwgewogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gaW5pdGlhbGl6ZShwYXRoKSB7CiAgICAgIHRoaXMucmVzZXQoKTsKCiAgICAgIGlmIChwYXRoIGluc3RhbmNlb2YgU2VyaWFsaXphYmxlUGF0aCkgewogICAgICAgIHRoaXMucGF0aCA9IHBhdGgucGF0aC5zbGljZSgwKTsKICAgICAgfSBlbHNlIGlmIChwYXRoKSB7CiAgICAgICAgaWYgKHBhdGguYXBwbHlUb1BhdGgpIHsKICAgICAgICAgIHBhdGguYXBwbHlUb1BhdGgodGhpcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucHVzaChwYXRoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBvblJlc2V0OiBmdW5jdGlvbiBvblJlc2V0KCkgewogICAgICB0aGlzLnBhdGggPSBbXTsKICAgIH0sCiAgICBvbk1vdmU6IGZ1bmN0aW9uIG9uTW92ZShzeCwgc3ksIHgsIHkpIHsKICAgICAgdGhpcy5wYXRoLnB1c2goTU9WRV9UTywgeCwgeSk7CiAgICB9LAogICAgb25MaW5lOiBmdW5jdGlvbiBvbkxpbmUoc3gsIHN5LCB4LCB5KSB7CiAgICAgIHRoaXMucGF0aC5wdXNoKExJTkVfVE8sIHgsIHkpOwogICAgfSwKICAgIG9uQmV6aWVyQ3VydmU6IGZ1bmN0aW9uIG9uQmV6aWVyQ3VydmUoc3gsIHN5LCBwMXgsIHAxeSwgcDJ4LCBwMnksIHgsIHkpIHsKICAgICAgdGhpcy5wYXRoLnB1c2goQ1VSVkVfVE8sIHAxeCwgcDF5LCBwMngsIHAyeSwgeCwgeSk7CiAgICB9LAogICAgX2FyY1RvQmV6aWVyOiBQYXRoLnByb3RvdHlwZS5vbkFyYywKICAgIG9uQXJjOiBmdW5jdGlvbiBvbkFyYyhzeCwgc3ksIGV4LCBleSwgY3gsIGN5LCByeCwgcnksIHNhLCBlYSwgY2N3LCByb3RhdGlvbikgewogICAgICBpZiAocnggIT09IHJ5IHx8IHJvdGF0aW9uKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2FyY1RvQmV6aWVyKHN4LCBzeSwgZXgsIGV5LCBjeCwgY3ksIHJ4LCByeSwgc2EsIGVhLCBjY3csIHJvdGF0aW9uKTsKICAgICAgfQoKICAgICAgdGhpcy5wYXRoLnB1c2goQVJDLCBjeCwgY3ksIHJ4LCBzYSwgZWEsIGNjdyA/IDAgOiAxKTsKICAgIH0sCiAgICBvbkNsb3NlOiBmdW5jdGlvbiBvbkNsb3NlKCkgewogICAgICB0aGlzLnBhdGgucHVzaChDTE9TRSk7CiAgICB9LAogICAgdG9KU09OOiBmdW5jdGlvbiB0b0pTT04oKSB7CiAgICAgIHJldHVybiB0aGlzLnBhdGg7CiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBTZXJpYWxpemFibGVQYXRoOwp9LDE3NixbMTc3LDE3OF0sIkFSVFNlcmlhbGl6YWJsZVBhdGgiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKCW1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKG1peGlucykgewoJCXZhciBwcm90byA9IHt9OwoKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCQkJdmFyIG1peGluID0gYXJndW1lbnRzW2ldOwoJCQlpZiAodHlwZW9mIG1peGluID09ICdmdW5jdGlvbicpIG1peGluID0gbWl4aW4ucHJvdG90eXBlOwoKCQkJZm9yICh2YXIga2V5IGluIG1peGluKSB7CgkJCQlwcm90b1trZXldID0gbWl4aW5ba2V5XTsKCQkJfQoJCX0KCgkJaWYgKCFwcm90by5pbml0aWFsaXplKSBwcm90by5pbml0aWFsaXplID0gZnVuY3Rpb24gKCkge307CgoJCXByb3RvLmNvbnN0cnVjdG9yID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQsIGUsIGYsIGcsIGgpIHsKCQkJcmV0dXJuIG5ldyBwcm90by5pbml0aWFsaXplKGEsIGIsIGMsIGQsIGUsIGYsIGcsIGgpOwoJCX07CgoJCXByb3RvLmNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IHByb3RvLmluaXRpYWxpemUucHJvdG90eXBlID0gcHJvdG87CgkJcmV0dXJuIHByb3RvLmNvbnN0cnVjdG9yOwoJfTsKfSwxNzcsW10sImFydC9jb3JlL2NsYXNzLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7Cgl2YXIgQ2xhc3MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9jbGFzcycpOwoKCW1vZHVsZS5leHBvcnRzID0gQ2xhc3MoewoJCWluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUocGF0aCkgewoJCQl0aGlzLnJlc2V0KCkucHVzaChwYXRoKTsKCQl9LAoJCXB1c2g6IGZ1bmN0aW9uIHB1c2goKSB7CgkJCXZhciBwID0gQXJyYXkucHJvdG90eXBlLmpvaW4uY2FsbChhcmd1bWVudHMsICcgJykubWF0Y2goL1thLWRmLXpdfFtcLStdPyg/OltcZFwuXWVbXC0rXT98W15cc1wtKyxhLXpdKSsvaWcpOwoJCQlpZiAoIXApIHJldHVybiB0aGlzOwoJCQl2YXIgbGFzdCwKCQkJICAgIGNtZCA9IHBbMF0sCgkJCSAgICBpID0gMTsKCgkJCXdoaWxlIChjbWQpIHsKCQkJCXN3aXRjaCAoY21kKSB7CgkJCQkJY2FzZSAnbSc6CgkJCQkJCXRoaXMubW92ZShwW2krK10sIHBbaSsrXSk7CgkJCQkJCWJyZWFrOwoKCQkJCQljYXNlICdsJzoKCQkJCQkJdGhpcy5saW5lKHBbaSsrXSwgcFtpKytdKTsKCQkJCQkJYnJlYWs7CgoJCQkJCWNhc2UgJ2MnOgoJCQkJCQl0aGlzLmN1cnZlKHBbaSsrXSwgcFtpKytdLCBwW2krK10sIHBbaSsrXSwgcFtpKytdLCBwW2krK10pOwoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSAncyc6CgkJCQkJCXRoaXMuY3VydmUocFtpKytdLCBwW2krK10sIG51bGwsIG51bGwsIHBbaSsrXSwgcFtpKytdKTsKCQkJCQkJYnJlYWs7CgoJCQkJCWNhc2UgJ3EnOgoJCQkJCQl0aGlzLmN1cnZlKHBbaSsrXSwgcFtpKytdLCBwW2krK10sIHBbaSsrXSk7CgkJCQkJCWJyZWFrOwoKCQkJCQljYXNlICd0JzoKCQkJCQkJdGhpcy5jdXJ2ZShwW2krK10sIHBbaSsrXSk7CgkJCQkJCWJyZWFrOwoKCQkJCQljYXNlICdhJzoKCQkJCQkJdGhpcy5hcmMocFtpICsgNV0sIHBbaSArIDZdLCBwW2ldLCBwW2kgKyAxXSwgcFtpICsgM10sICErcFtpICsgNF0sIHBbaSArIDJdKTsKCQkJCQkJaSArPSA3OwoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSAnaCc6CgkJCQkJCXRoaXMubGluZShwW2krK10sIDApOwoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSAndic6CgkJCQkJCXRoaXMubGluZSgwLCBwW2krK10pOwoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSAnTSc6CgkJCQkJCXRoaXMubW92ZVRvKHBbaSsrXSwgcFtpKytdKTsKCQkJCQkJYnJlYWs7CgoJCQkJCWNhc2UgJ0wnOgoJCQkJCQl0aGlzLmxpbmVUbyhwW2krK10sIHBbaSsrXSk7CgkJCQkJCWJyZWFrOwoKCQkJCQljYXNlICdDJzoKCQkJCQkJdGhpcy5jdXJ2ZVRvKHBbaSsrXSwgcFtpKytdLCBwW2krK10sIHBbaSsrXSwgcFtpKytdLCBwW2krK10pOwoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSAnUyc6CgkJCQkJCXRoaXMuY3VydmVUbyhwW2krK10sIHBbaSsrXSwgbnVsbCwgbnVsbCwgcFtpKytdLCBwW2krK10pOwoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSAnUSc6CgkJCQkJCXRoaXMuY3VydmVUbyhwW2krK10sIHBbaSsrXSwgcFtpKytdLCBwW2krK10pOwoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSAnVCc6CgkJCQkJCXRoaXMuY3VydmVUbyhwW2krK10sIHBbaSsrXSk7CgkJCQkJCWJyZWFrOwoKCQkJCQljYXNlICdBJzoKCQkJCQkJdGhpcy5hcmNUbyhwW2kgKyA1XSwgcFtpICsgNl0sIHBbaV0sIHBbaSArIDFdLCBwW2kgKyAzXSwgIStwW2kgKyA0XSwgcFtpICsgMl0pOwoJCQkJCQlpICs9IDc7CgkJCQkJCWJyZWFrOwoKCQkJCQljYXNlICdIJzoKCQkJCQkJdGhpcy5saW5lVG8ocFtpKytdLCB0aGlzLnBlblkpOwoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSAnVic6CgkJCQkJCXRoaXMubGluZVRvKHRoaXMucGVuWCwgcFtpKytdKTsKCQkJCQkJYnJlYWs7CgoJCQkJCWNhc2UgJ1onOgoJCQkJCWNhc2UgJ3onOgoJCQkJCQl0aGlzLmNsb3NlKCk7CgkJCQkJCWJyZWFrOwoKCQkJCQlkZWZhdWx0OgoJCQkJCQljbWQgPSBsYXN0OwoJCQkJCQlpLS07CgkJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCWxhc3QgPSBjbWQ7CgkJCQlpZiAobGFzdCA9PSAnbScpIGxhc3QgPSAnbCc7ZWxzZSBpZiAobGFzdCA9PSAnTScpIGxhc3QgPSAnTCc7CgkJCQljbWQgPSBwW2krK107CgkJCX0KCgkJCXJldHVybiB0aGlzOwoJCX0sCgkJcmVzZXQ6IGZ1bmN0aW9uIHJlc2V0KCkgewoJCQl0aGlzLnBlblggPSB0aGlzLnBlblkgPSAwOwoJCQl0aGlzLnBlbkRvd25YID0gdGhpcy5wZW5Eb3duWSA9IG51bGw7CgkJCXRoaXMuX3Bpdm90WCA9IHRoaXMuX3Bpdm90WSA9IDA7CgkJCXRoaXMub25SZXNldCgpOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoJCW1vdmU6IGZ1bmN0aW9uIG1vdmUoeCwgeSkgewoJCQl0aGlzLm9uTW92ZSh0aGlzLnBlblgsIHRoaXMucGVuWSwgdGhpcy5fcGl2b3RYID0gdGhpcy5wZW5YICs9ICt4LCB0aGlzLl9waXZvdFkgPSB0aGlzLnBlblkgKz0gK3kpOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoJCW1vdmVUbzogZnVuY3Rpb24gbW92ZVRvKHgsIHkpIHsKCQkJdGhpcy5vbk1vdmUodGhpcy5wZW5YLCB0aGlzLnBlblksIHRoaXMuX3Bpdm90WCA9IHRoaXMucGVuWCA9ICt4LCB0aGlzLl9waXZvdFkgPSB0aGlzLnBlblkgPSAreSk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgkJbGluZTogZnVuY3Rpb24gbGluZSh4LCB5KSB7CgkJCXJldHVybiB0aGlzLmxpbmVUbyh0aGlzLnBlblggKyAreCwgdGhpcy5wZW5ZICsgK3kpOwoJCX0sCgkJbGluZVRvOiBmdW5jdGlvbiBsaW5lVG8oeCwgeSkgewoJCQlpZiAodGhpcy5wZW5Eb3duWCA9PSBudWxsKSB7CgkJCQl0aGlzLnBlbkRvd25YID0gdGhpcy5wZW5YOwoJCQkJdGhpcy5wZW5Eb3duWSA9IHRoaXMucGVuWTsKCQkJfQoKCQkJdGhpcy5vbkxpbmUodGhpcy5wZW5YLCB0aGlzLnBlblksIHRoaXMuX3Bpdm90WCA9IHRoaXMucGVuWCA9ICt4LCB0aGlzLl9waXZvdFkgPSB0aGlzLnBlblkgPSAreSk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgkJY3VydmU6IGZ1bmN0aW9uIGN1cnZlKGMxeCwgYzF5LCBjMngsIGMyeSwgZXgsIGV5KSB7CgkJCXZhciB4ID0gdGhpcy5wZW5YLAoJCQkgICAgeSA9IHRoaXMucGVuWTsKCQkJcmV0dXJuIHRoaXMuY3VydmVUbyh4ICsgK2MxeCwgeSArICtjMXksIGMyeCA9PSBudWxsID8gbnVsbCA6IHggKyArYzJ4LCBjMnkgPT0gbnVsbCA/IG51bGwgOiB5ICsgK2MyeSwgZXggPT0gbnVsbCA/IG51bGwgOiB4ICsgK2V4LCBleSA9PSBudWxsID8gbnVsbCA6IHkgKyArZXkpOwoJCX0sCgkJY3VydmVUbzogZnVuY3Rpb24gY3VydmVUbyhjMXgsIGMxeSwgYzJ4LCBjMnksIGV4LCBleSkgewoJCQl2YXIgeCA9IHRoaXMucGVuWCwKCQkJICAgIHkgPSB0aGlzLnBlblk7CgoJCQlpZiAoYzJ4ID09IG51bGwpIHsKCQkJCWMyeCA9ICtjMXg7CgkJCQljMnkgPSArYzF5OwoJCQkJYzF4ID0geCAqIDIgLSAodGhpcy5fcGl2b3RYIHx8IDApOwoJCQkJYzF5ID0geSAqIDIgLSAodGhpcy5fcGl2b3RZIHx8IDApOwoJCQl9CgoJCQlpZiAoZXggPT0gbnVsbCkgewoJCQkJdGhpcy5fcGl2b3RYID0gK2MxeDsKCQkJCXRoaXMuX3Bpdm90WSA9ICtjMXk7CgkJCQlleCA9ICtjMng7CgkJCQlleSA9ICtjMnk7CgkJCQljMnggPSAoZXggKyArYzF4ICogMikgLyAzOwoJCQkJYzJ5ID0gKGV5ICsgK2MxeSAqIDIpIC8gMzsKCQkJCWMxeCA9ICh4ICsgK2MxeCAqIDIpIC8gMzsKCQkJCWMxeSA9ICh5ICsgK2MxeSAqIDIpIC8gMzsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX3Bpdm90WCA9ICtjMng7CgkJCQl0aGlzLl9waXZvdFkgPSArYzJ5OwoJCQl9CgoJCQlpZiAodGhpcy5wZW5Eb3duWCA9PSBudWxsKSB7CgkJCQl0aGlzLnBlbkRvd25YID0geDsKCQkJCXRoaXMucGVuRG93blkgPSB5OwoJCQl9CgoJCQl0aGlzLm9uQmV6aWVyQ3VydmUoeCwgeSwgK2MxeCwgK2MxeSwgK2MyeCwgK2MyeSwgdGhpcy5wZW5YID0gK2V4LCB0aGlzLnBlblkgPSArZXkpOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoJCWFyYzogZnVuY3Rpb24gYXJjKHgsIHksIHJ4LCByeSwgb3V0ZXIsIGNvdW50ZXJDbG9ja3dpc2UsIHJvdGF0aW9uKSB7CgkJCXJldHVybiB0aGlzLmFyY1RvKHRoaXMucGVuWCArICt4LCB0aGlzLnBlblkgKyAreSwgcngsIHJ5LCBvdXRlciwgY291bnRlckNsb2Nrd2lzZSwgcm90YXRpb24pOwoJCX0sCgkJYXJjVG86IGZ1bmN0aW9uIGFyY1RvKHgsIHksIHJ4LCByeSwgb3V0ZXIsIGNvdW50ZXJDbG9ja3dpc2UsIHJvdGF0aW9uKSB7CgkJCXJ5ID0gTWF0aC5hYnMoK3J5IHx8ICtyeCB8fCAreSAtIHRoaXMucGVuWSk7CgkJCXJ4ID0gTWF0aC5hYnMoK3J4IHx8ICt4IC0gdGhpcy5wZW5YKTsKCQkJaWYgKCFyeCB8fCAhcnkgfHwgeCA9PSB0aGlzLnBlblggJiYgeSA9PSB0aGlzLnBlblkpIHJldHVybiB0aGlzLmxpbmVUbyh4LCB5KTsKCQkJdmFyIHRYID0gdGhpcy5wZW5YLAoJCQkgICAgdFkgPSB0aGlzLnBlblksCgkJCSAgICBjbG9ja3dpc2UgPSAhK2NvdW50ZXJDbG9ja3dpc2UsCgkJCSAgICBsYXJnZSA9ICEhK291dGVyOwoJCQl2YXIgcmFkID0gcm90YXRpb24gPyByb3RhdGlvbiAqIE1hdGguUEkgLyAxODAgOiAwLAoJCQkgICAgY29zID0gTWF0aC5jb3MocmFkKSwKCQkJICAgIHNpbiA9IE1hdGguc2luKHJhZCk7CgkJCXggLT0gdFg7CgkJCXkgLT0gdFk7CgkJCXZhciBjeCA9IGNvcyAqIHggLyAyICsgc2luICogeSAvIDIsCgkJCSAgICBjeSA9IC1zaW4gKiB4IC8gMiArIGNvcyAqIHkgLyAyLAoJCQkgICAgcnhyeSA9IHJ4ICogcnggKiByeSAqIHJ5LAoJCQkgICAgcnljeCA9IHJ5ICogcnkgKiBjeCAqIGN4LAoJCQkgICAgcnhjeSA9IHJ4ICogcnggKiBjeSAqIGN5LAoJCQkgICAgYSA9IHJ4cnkgLSByeGN5IC0gcnljeDsKCgkJCWlmIChhIDwgMCkgewoJCQkJYSA9IE1hdGguc3FydCgxIC0gYSAvIHJ4cnkpOwoJCQkJcnggKj0gYTsKCQkJCXJ5ICo9IGE7CgkJCQljeCA9IHggLyAyOwoJCQkJY3kgPSB5IC8gMjsKCQkJfSBlbHNlIHsKCQkJCWEgPSBNYXRoLnNxcnQoYSAvIChyeGN5ICsgcnljeCkpOwoJCQkJaWYgKGxhcmdlID09IGNsb2Nrd2lzZSkgYSA9IC1hOwoJCQkJdmFyIGN4ZCA9IC1hICogY3kgKiByeCAvIHJ5LAoJCQkJICAgIGN5ZCA9IGEgKiBjeCAqIHJ5IC8gcng7CgkJCQljeCA9IGNvcyAqIGN4ZCAtIHNpbiAqIGN5ZCArIHggLyAyOwoJCQkJY3kgPSBzaW4gKiBjeGQgKyBjb3MgKiBjeWQgKyB5IC8gMjsKCQkJfQoKCQkJdmFyIHh4ID0gY29zIC8gcngsCgkJCSAgICB5eCA9IHNpbiAvIHJ4LAoJCQkgICAgeHkgPSAtc2luIC8gcnksCgkJCSAgICB5eSA9IGNvcyAvIHJ5OwoJCQl2YXIgc2EgPSBNYXRoLmF0YW4yKHh5ICogLWN4ICsgeXkgKiAtY3ksIHh4ICogLWN4ICsgeXggKiAtY3kpLAoJCQkgICAgZWEgPSBNYXRoLmF0YW4yKHh5ICogKHggLSBjeCkgKyB5eSAqICh5IC0gY3kpLCB4eCAqICh4IC0gY3gpICsgeXggKiAoeSAtIGN5KSk7CgkJCWN4ICs9IHRYOwoJCQljeSArPSB0WTsKCQkJeCArPSB0WDsKCQkJeSArPSB0WTsKCgkJCWlmICh0aGlzLnBlbkRvd25YID09IG51bGwpIHsKCQkJCXRoaXMucGVuRG93blggPSB0aGlzLnBlblg7CgkJCQl0aGlzLnBlbkRvd25ZID0gdGhpcy5wZW5ZOwoJCQl9CgoJCQl0aGlzLm9uQXJjKHRYLCB0WSwgdGhpcy5fcGl2b3RYID0gdGhpcy5wZW5YID0geCwgdGhpcy5fcGl2b3RZID0gdGhpcy5wZW5ZID0geSwgY3gsIGN5LCByeCwgcnksIHNhLCBlYSwgIWNsb2Nrd2lzZSwgcm90YXRpb24pOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoJCWNvdW50ZXJBcmM6IGZ1bmN0aW9uIGNvdW50ZXJBcmMoeCwgeSwgcngsIHJ5LCBvdXRlcikgewoJCQlyZXR1cm4gdGhpcy5hcmMoeCwgeSwgcngsIHJ5LCBvdXRlciwgdHJ1ZSk7CgkJfSwKCQljb3VudGVyQXJjVG86IGZ1bmN0aW9uIGNvdW50ZXJBcmNUbyh4LCB5LCByeCwgcnksIG91dGVyKSB7CgkJCXJldHVybiB0aGlzLmFyY1RvKHgsIHksIHJ4LCByeSwgb3V0ZXIsIHRydWUpOwoJCX0sCgkJY2xvc2U6IGZ1bmN0aW9uIGNsb3NlKCkgewoJCQlpZiAodGhpcy5wZW5Eb3duWCAhPSBudWxsKSB7CgkJCQl0aGlzLm9uQ2xvc2UodGhpcy5wZW5YLCB0aGlzLnBlblksIHRoaXMucGVuWCA9IHRoaXMucGVuRG93blgsIHRoaXMucGVuWSA9IHRoaXMucGVuRG93blkpOwoJCQkJdGhpcy5wZW5Eb3duWCA9IG51bGw7CgkJCX0KCgkJCXJldHVybiB0aGlzOwoJCX0sCgkJb25SZXNldDogZnVuY3Rpb24gb25SZXNldCgpIHt9LAoJCW9uTW92ZTogZnVuY3Rpb24gb25Nb3ZlKHN4LCBzeSwgZXgsIGV5KSB7fSwKCQlvbkxpbmU6IGZ1bmN0aW9uIG9uTGluZShzeCwgc3ksIGV4LCBleSkgewoJCQl0aGlzLm9uQmV6aWVyQ3VydmUoc3gsIHN5LCBzeCwgc3ksIGV4LCBleSwgZXgsIGV5KTsKCQl9LAoJCW9uQmV6aWVyQ3VydmU6IGZ1bmN0aW9uIG9uQmV6aWVyQ3VydmUoc3gsIHN5LCBjMXgsIGMxeSwgYzJ4LCBjMnksIGV4LCBleSkgewoJCQl2YXIgZ3ggPSBleCAtIHN4LAoJCQkgICAgZ3kgPSBleSAtIHN5LAoJCQkgICAgZyA9IGd4ICogZ3ggKyBneSAqIGd5LAoJCQkgICAgdjEsCgkJCSAgICB2MiwKCQkJICAgIGN4LAoJCQkgICAgY3ksCgkJCSAgICB1OwoJCQljeCA9IGMxeCAtIHN4OwoJCQljeSA9IGMxeSAtIHN5OwoJCQl1ID0gY3ggKiBneCArIGN5ICogZ3k7CgoJCQlpZiAodSA+IGcpIHsKCQkJCWN4IC09IGd4OwoJCQkJY3kgLT0gZ3k7CgkJCX0gZWxzZSBpZiAodSA+IDAgJiYgZyAhPSAwKSB7CgkJCQljeCAtPSB1IC8gZyAqIGd4OwoJCQkJY3kgLT0gdSAvIGcgKiBneTsKCQkJfQoKCQkJdjEgPSBjeCAqIGN4ICsgY3kgKiBjeTsKCQkJY3ggPSBjMnggLSBzeDsKCQkJY3kgPSBjMnkgLSBzeTsKCQkJdSA9IGN4ICogZ3ggKyBjeSAqIGd5OwoKCQkJaWYgKHUgPiBnKSB7CgkJCQljeCAtPSBneDsKCQkJCWN5IC09IGd5OwoJCQl9IGVsc2UgaWYgKHUgPiAwICYmIGcgIT0gMCkgewoJCQkJY3ggLT0gdSAvIGcgKiBneDsKCQkJCWN5IC09IHUgLyBnICogZ3k7CgkJCX0KCgkJCXYyID0gY3ggKiBjeCArIGN5ICogY3k7CgoJCQlpZiAodjEgPCAwLjAxICYmIHYyIDwgMC4wMSkgewoJCQkJdGhpcy5vbkxpbmUoc3gsIHN5LCBleCwgZXkpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoaXNOYU4odjEpIHx8IGlzTmFOKHYyKSkgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdCYWQgaW5wdXQnKTsKCQkJfQoKCQkJdmFyIHMxeCA9IChjMXggKyBjMngpICogMC41LAoJCQkgICAgczF5ID0gKGMxeSArIGMyeSkgKiAwLjUsCgkJCSAgICBsMXggPSAoYzF4ICsgc3gpICogMC41LAoJCQkgICAgbDF5ID0gKGMxeSArIHN5KSAqIDAuNSwKCQkJICAgIGwyeCA9IChsMXggKyBzMXgpICogMC41LAoJCQkgICAgbDJ5ID0gKGwxeSArIHMxeSkgKiAwLjUsCgkJCSAgICByMnggPSAoZXggKyBjMngpICogMC41LAoJCQkgICAgcjJ5ID0gKGV5ICsgYzJ5KSAqIDAuNSwKCQkJICAgIHIxeCA9IChyMnggKyBzMXgpICogMC41LAoJCQkgICAgcjF5ID0gKHIyeSArIHMxeSkgKiAwLjUsCgkJCSAgICBsMnIxeCA9IChsMnggKyByMXgpICogMC41LAoJCQkgICAgbDJyMXkgPSAobDJ5ICsgcjF5KSAqIDAuNTsKCQkJdGhpcy5vbkJlemllckN1cnZlKHN4LCBzeSwgbDF4LCBsMXksIGwyeCwgbDJ5LCBsMnIxeCwgbDJyMXkpOwoJCQl0aGlzLm9uQmV6aWVyQ3VydmUobDJyMXgsIGwycjF5LCByMXgsIHIxeSwgcjJ4LCByMnksIGV4LCBleSk7CgkJfSwKCQlvbkFyYzogZnVuY3Rpb24gb25BcmMoc3gsIHN5LCBleCwgZXksIGN4LCBjeSwgcngsIHJ5LCBzYSwgZWEsIGNjdywgcm90YXRpb24pIHsKCQkJdmFyIHJhZCA9IHJvdGF0aW9uID8gcm90YXRpb24gKiBNYXRoLlBJIC8gMTgwIDogMCwKCQkJICAgIGNvcyA9IE1hdGguY29zKHJhZCksCgkJCSAgICBzaW4gPSBNYXRoLnNpbihyYWQpLAoJCQkgICAgeHggPSBjb3MgKiByeCwKCQkJICAgIHl4ID0gLXNpbiAqIHJ5LAoJCQkgICAgeHkgPSBzaW4gKiByeCwKCQkJICAgIHl5ID0gY29zICogcnk7CgkJCXZhciBhcmMgPSBlYSAtIHNhOwoJCQlpZiAoYXJjIDwgMCAmJiAhY2N3KSBhcmMgKz0gTWF0aC5QSSAqIDI7ZWxzZSBpZiAoYXJjID4gMCAmJiBjY3cpIGFyYyAtPSBNYXRoLlBJICogMjsKCQkJdmFyIG4gPSBNYXRoLmNlaWwoTWF0aC5hYnMoYXJjIC8gKE1hdGguUEkgLyAyKSkpLAoJCQkgICAgc3RlcCA9IGFyYyAvIG4sCgkJCSAgICBrID0gNCAvIDMgKiBNYXRoLnRhbihzdGVwIC8gNCk7CgkJCXZhciB4ID0gTWF0aC5jb3Moc2EpLAoJCQkgICAgeSA9IE1hdGguc2luKHNhKTsKCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSB7CgkJCQl2YXIgY3AxeCA9IHggLSBrICogeSwKCQkJCSAgICBjcDF5ID0geSArIGsgKiB4OwoJCQkJc2EgKz0gc3RlcDsKCQkJCXggPSBNYXRoLmNvcyhzYSk7CgkJCQl5ID0gTWF0aC5zaW4oc2EpOwoJCQkJdmFyIGNwMnggPSB4ICsgayAqIHksCgkJCQkgICAgY3AyeSA9IHkgLSBrICogeDsKCQkJCXRoaXMub25CZXppZXJDdXJ2ZShzeCwgc3ksIGN4ICsgeHggKiBjcDF4ICsgeXggKiBjcDF5LCBjeSArIHh5ICogY3AxeCArIHl5ICogY3AxeSwgY3ggKyB4eCAqIGNwMnggKyB5eCAqIGNwMnksIGN5ICsgeHkgKiBjcDJ4ICsgeXkgKiBjcDJ5LCBzeCA9IGN4ICsgeHggKiB4ICsgeXggKiB5LCBzeSA9IGN5ICsgeHkgKiB4ICsgeXkgKiB5KTsKCQkJfQoJCX0sCgkJb25DbG9zZTogZnVuY3Rpb24gb25DbG9zZShzeCwgc3ksIGV4LCBleSkgewoJCQl0aGlzLm9uTGluZShzeCwgc3ksIGV4LCBleSk7CgkJfQoJfSk7Cn0sMTc4LFsxNzddLCJhcnQvY29yZS9wYXRoLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7Cgl2YXIgQ2xhc3MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9jbGFzcycpOwoKCWZ1bmN0aW9uIFRyYW5zZm9ybSh4eCwgeXgsIHh5LCB5eSwgeCwgeSkgewoJCWlmICh4eCAmJiB0eXBlb2YgeHggPT0gJ29iamVjdCcpIHsKCQkJeXggPSB4eC55eDsKCQkJeXkgPSB4eC55eTsKCQkJeSA9IHh4Lnk7CgkJCXh5ID0geHgueHk7CgkJCXggPSB4eC54OwoJCQl4eCA9IHh4Lnh4OwoJCX0KCgkJdGhpcy54eCA9IHh4ID09IG51bGwgPyAxIDogeHg7CgkJdGhpcy55eCA9IHl4IHx8IDA7CgkJdGhpcy54eSA9IHh5IHx8IDA7CgkJdGhpcy55eSA9IHl5ID09IG51bGwgPyAxIDogeXk7CgkJdGhpcy54ID0gKHggPT0gbnVsbCA/IHRoaXMueCA6IHgpIHx8IDA7CgkJdGhpcy55ID0gKHkgPT0gbnVsbCA/IHRoaXMueSA6IHkpIHx8IDA7CgoJCXRoaXMuX3RyYW5zZm9ybSgpOwoKCQlyZXR1cm4gdGhpczsKCX0KCgk7Cgltb2R1bGUuZXhwb3J0cyA9IENsYXNzKHsKCQlpbml0aWFsaXplOiBUcmFuc2Zvcm0sCgkJX3RyYW5zZm9ybTogZnVuY3Rpb24gX3RyYW5zZm9ybSgpIHt9LAoJCXh4OiAxLAoJCXl4OiAwLAoJCXg6IDAsCgkJeHk6IDAsCgkJeXk6IDEsCgkJeTogMCwKCQl0cmFuc2Zvcm06IGZ1bmN0aW9uIHRyYW5zZm9ybSh4eCwgeXgsIHh5LCB5eSwgeCwgeSkgewoJCQl2YXIgbSA9IHRoaXM7CgoJCQlpZiAoeHggJiYgdHlwZW9mIHh4ID09ICdvYmplY3QnKSB7CgkJCQl5eCA9IHh4Lnl4OwoJCQkJeXkgPSB4eC55eTsKCQkJCXkgPSB4eC55OwoJCQkJeHkgPSB4eC54eTsKCQkJCXggPSB4eC54OwoJCQkJeHggPSB4eC54eDsKCQkJfQoKCQkJaWYgKCF4KSB4ID0gMDsKCQkJaWYgKCF5KSB5ID0gMDsKCQkJcmV0dXJuIHRoaXMudHJhbnNmb3JtVG8obS54eCAqIHh4ICsgbS54eSAqIHl4LCBtLnl4ICogeHggKyBtLnl5ICogeXgsIG0ueHggKiB4eSArIG0ueHkgKiB5eSwgbS55eCAqIHh5ICsgbS55eSAqIHl5LCBtLnh4ICogeCArIG0ueHkgKiB5ICsgbS54LCBtLnl4ICogeCArIG0ueXkgKiB5ICsgbS55KTsKCQl9LAoJCXRyYW5zZm9ybVRvOiBUcmFuc2Zvcm0sCgkJdHJhbnNsYXRlOiBmdW5jdGlvbiB0cmFuc2xhdGUoeCwgeSkgewoJCQlyZXR1cm4gdGhpcy50cmFuc2Zvcm0oMSwgMCwgMCwgMSwgeCwgeSk7CgkJfSwKCQltb3ZlOiBmdW5jdGlvbiBtb3ZlKHgsIHkpIHsKCQkJdGhpcy54ICs9IHggfHwgMDsKCQkJdGhpcy55ICs9IHkgfHwgMDsKCgkJCXRoaXMuX3RyYW5zZm9ybSgpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCQlzY2FsZTogZnVuY3Rpb24gc2NhbGUoeCwgeSkgewoJCQlpZiAoeSA9PSBudWxsKSB5ID0geDsKCQkJcmV0dXJuIHRoaXMudHJhbnNmb3JtKHgsIDAsIDAsIHksIDAsIDApOwoJCX0sCgkJcm90YXRlOiBmdW5jdGlvbiByb3RhdGUoZGVnLCB4LCB5KSB7CgkJCWlmICh4ID09IG51bGwgfHwgeSA9PSBudWxsKSB7CgkJCQl4ID0gKHRoaXMubGVmdCB8fCAwKSArICh0aGlzLndpZHRoIHx8IDApIC8gMjsKCQkJCXkgPSAodGhpcy50b3AgfHwgMCkgKyAodGhpcy5oZWlnaHQgfHwgMCkgLyAyOwoJCQl9CgoJCQl2YXIgcmFkID0gZGVnICogTWF0aC5QSSAvIDE4MCwKCQkJICAgIHNpbiA9IE1hdGguc2luKHJhZCksCgkJCSAgICBjb3MgPSBNYXRoLmNvcyhyYWQpOwoJCQl0aGlzLnRyYW5zZm9ybSgxLCAwLCAwLCAxLCB4LCB5KTsKCQkJdmFyIG0gPSB0aGlzOwoJCQlyZXR1cm4gdGhpcy50cmFuc2Zvcm1Ubyhjb3MgKiBtLnh4IC0gc2luICogbS55eCwgc2luICogbS54eCArIGNvcyAqIG0ueXgsIGNvcyAqIG0ueHkgLSBzaW4gKiBtLnl5LCBzaW4gKiBtLnh5ICsgY29zICogbS55eSwgbS54LCBtLnkpLnRyYW5zZm9ybSgxLCAwLCAwLCAxLCAteCwgLXkpOwoJCX0sCgkJbW92ZVRvOiBmdW5jdGlvbiBtb3ZlVG8oeCwgeSkgewoJCQl2YXIgbSA9IHRoaXM7CgkJCXJldHVybiB0aGlzLnRyYW5zZm9ybVRvKG0ueHgsIG0ueXgsIG0ueHksIG0ueXksIHgsIHkpOwoJCX0sCgkJcm90YXRlVG86IGZ1bmN0aW9uIHJvdGF0ZVRvKGRlZywgeCwgeSkgewoJCQl2YXIgbSA9IHRoaXM7CgkJCXZhciBmbGlwID0gbS55eCAvIG0ueHggPiBtLnl5IC8gbS54eSA/IC0xIDogMTsKCQkJaWYgKG0ueHggPCAwID8gbS54eSA+PSAwIDogbS54eSA8IDApIGZsaXAgPSAtZmxpcDsKCQkJcmV0dXJuIHRoaXMucm90YXRlKGRlZyAtIE1hdGguYXRhbjIoZmxpcCAqIG0ueXgsIGZsaXAgKiBtLnh4KSAqIDE4MCAvIE1hdGguUEksIHgsIHkpOwoJCX0sCgkJc2NhbGVUbzogZnVuY3Rpb24gc2NhbGVUbyh4LCB5KSB7CgkJCXZhciBtID0gdGhpczsKCQkJdmFyIGggPSBNYXRoLnNxcnQobS54eCAqIG0ueHggKyBtLnl4ICogbS55eCk7CgkJCW0ueHggLz0gaDsKCQkJbS55eCAvPSBoOwoJCQloID0gTWF0aC5zcXJ0KG0ueXkgKiBtLnl5ICsgbS54eSAqIG0ueHkpOwoJCQltLnl5IC89IGg7CgkJCW0ueHkgLz0gaDsKCQkJcmV0dXJuIHRoaXMuc2NhbGUoeCwgeSk7CgkJfSwKCQlyZXNpemVUbzogZnVuY3Rpb24gcmVzaXplVG8od2lkdGgsIGhlaWdodCkgewoJCQl2YXIgdyA9IHRoaXMud2lkdGgsCgkJCSAgICBoID0gdGhpcy5oZWlnaHQ7CgkJCWlmICghdyB8fCAhaCkgcmV0dXJuIHRoaXM7CgkJCXJldHVybiB0aGlzLnNjYWxlVG8od2lkdGggLyB3LCBoZWlnaHQgLyBoKTsKCQl9LAoJCWludmVyc2VQb2ludDogZnVuY3Rpb24gaW52ZXJzZVBvaW50KHgsIHkpIHsKCQkJdmFyIGEgPSB0aGlzLnh4LAoJCQkgICAgYiA9IHRoaXMueXgsCgkJCSAgICBjID0gdGhpcy54eSwKCQkJICAgIGQgPSB0aGlzLnl5LAoJCQkgICAgZSA9IHRoaXMueCwKCQkJICAgIGYgPSB0aGlzLnk7CgkJCXZhciBkZXQgPSBiICogYyAtIGEgKiBkOwoJCQlpZiAoZGV0ID09IDApIHJldHVybiBudWxsOwoJCQlyZXR1cm4gewoJCQkJeDogKGQgKiAoZSAtIHgpICsgYyAqICh5IC0gZikpIC8gZGV0LAoJCQkJeTogKGEgKiAoZiAtIHkpICsgYiAqICh4IC0gZSkpIC8gZGV0CgkJCX07CgkJfSwKCQlwb2ludDogZnVuY3Rpb24gcG9pbnQoeCwgeSkgewoJCQl2YXIgbSA9IHRoaXM7CgkJCXJldHVybiB7CgkJCQl4OiBtLnh4ICogeCArIG0ueHkgKiB5ICsgbS54LAoJCQkJeTogbS55eCAqIHggKyBtLnl5ICogeSArIG0ueQoJCQl9OwoJCX0KCX0pOwp9LDE3OSxbMTc3XSwiYXJ0L2NvcmUvdHJhbnNmb3JtLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2NsYXNzLAogICAgICBfdGVtcCwKICAgICAgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29tcG9uZW50cy9CdXR0b24uanMiOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJQbGF0Zm9ybSIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUmVhY3QiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJwcm9wLXR5cGVzIik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFRleHQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiVGV4dCIpOwoKICB2YXIgVG91Y2hhYmxlTmF0aXZlRmVlZGJhY2sgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAiVG91Y2hhYmxlTmF0aXZlRmVlZGJhY2siKTsKCiAgdmFyIFRvdWNoYWJsZU9wYWNpdHkgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiVG91Y2hhYmxlT3BhY2l0eSIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJWaWV3Iik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBCdXR0b24gPSAoX3RlbXAgPSBfY2xhc3MgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKEJ1dHRvbiwgX1JlYWN0JENvbXBvbmVudCk7CgogICAgZnVuY3Rpb24gQnV0dG9uKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQnV0dG9uKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChCdXR0b24uX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihCdXR0b24pKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQnV0dG9uLCBbewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBfcHJvcHMgPSB0aGlzLnByb3BzLAogICAgICAgICAgICBhY2Nlc3NpYmlsaXR5TGFiZWwgPSBfcHJvcHMuYWNjZXNzaWJpbGl0eUxhYmVsLAogICAgICAgICAgICBjb2xvciA9IF9wcm9wcy5jb2xvciwKICAgICAgICAgICAgb25QcmVzcyA9IF9wcm9wcy5vblByZXNzLAogICAgICAgICAgICB0aXRsZSA9IF9wcm9wcy50aXRsZSwKICAgICAgICAgICAgaGFzVFZQcmVmZXJyZWRGb2N1cyA9IF9wcm9wcy5oYXNUVlByZWZlcnJlZEZvY3VzLAogICAgICAgICAgICBkaXNhYmxlZCA9IF9wcm9wcy5kaXNhYmxlZCwKICAgICAgICAgICAgdGVzdElEID0gX3Byb3BzLnRlc3RJRDsKICAgICAgICB2YXIgYnV0dG9uU3R5bGVzID0gW3N0eWxlcy5idXR0b25dOwogICAgICAgIHZhciB0ZXh0U3R5bGVzID0gW3N0eWxlcy50ZXh0XTsKCiAgICAgICAgaWYgKGNvbG9yKSB7CiAgICAgICAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICdpb3MnKSB7CiAgICAgICAgICAgIHRleHRTdHlsZXMucHVzaCh7CiAgICAgICAgICAgICAgY29sb3I6IGNvbG9yCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnV0dG9uU3R5bGVzLnB1c2goewogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogY29sb3IKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgYWNjZXNzaWJpbGl0eVRyYWl0cyA9IFsnYnV0dG9uJ107CgogICAgICAgIGlmIChkaXNhYmxlZCkgewogICAgICAgICAgYnV0dG9uU3R5bGVzLnB1c2goc3R5bGVzLmJ1dHRvbkRpc2FibGVkKTsKICAgICAgICAgIHRleHRTdHlsZXMucHVzaChzdHlsZXMudGV4dERpc2FibGVkKTsKICAgICAgICAgIGFjY2Vzc2liaWxpdHlUcmFpdHMucHVzaCgnZGlzYWJsZWQnKTsKICAgICAgICB9CgogICAgICAgIGludmFyaWFudCh0eXBlb2YgdGl0bGUgPT09ICdzdHJpbmcnLCAnVGhlIHRpdGxlIHByb3Agb2YgYSBCdXR0b24gbXVzdCBiZSBhIHN0cmluZycpOwogICAgICAgIHZhciBmb3JtYXR0ZWRUaXRsZSA9IFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcgPyB0aXRsZS50b1VwcGVyQ2FzZSgpIDogdGl0bGU7CiAgICAgICAgdmFyIFRvdWNoYWJsZSA9IFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcgPyBUb3VjaGFibGVOYXRpdmVGZWVkYmFjayA6IFRvdWNoYWJsZU9wYWNpdHk7CiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBUb3VjaGFibGUsCiAgICAgICAgICB7CiAgICAgICAgICAgIGFjY2Vzc2liaWxpdHlDb21wb25lbnRUeXBlOiAiYnV0dG9uIiwKICAgICAgICAgICAgYWNjZXNzaWJpbGl0eUxhYmVsOiBhY2Nlc3NpYmlsaXR5TGFiZWwsCiAgICAgICAgICAgIGFjY2Vzc2liaWxpdHlUcmFpdHM6IGFjY2Vzc2liaWxpdHlUcmFpdHMsCiAgICAgICAgICAgIGhhc1RWUHJlZmVycmVkRm9jdXM6IGhhc1RWUHJlZmVycmVkRm9jdXMsCiAgICAgICAgICAgIHRlc3RJRDogdGVzdElELAogICAgICAgICAgICBkaXNhYmxlZDogZGlzYWJsZWQsCiAgICAgICAgICAgIG9uUHJlc3M6IG9uUHJlc3MsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAxMjgKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFZpZXcsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogYnV0dG9uU3R5bGVzLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMTM2CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3R5bGU6IHRleHRTdHlsZXMsCiAgICAgICAgICAgICAgICBkaXNhYmxlZDogZGlzYWJsZWQsCiAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAxMzcKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZvcm1hdHRlZFRpdGxlCiAgICAgICAgICAgICkKICAgICAgICAgICkKICAgICAgICApOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQnV0dG9uOwogIH0oUmVhY3QuQ29tcG9uZW50KSwgX2NsYXNzLnByb3BUeXBlcyA9IHsKICAgIHRpdGxlOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsCiAgICBhY2Nlc3NpYmlsaXR5TGFiZWw6IFByb3BUeXBlcy5zdHJpbmcsCiAgICBjb2xvcjogQ29sb3JQcm9wVHlwZSwKICAgIGRpc2FibGVkOiBQcm9wVHlwZXMuYm9vbCwKICAgIG9uUHJlc3M6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsCiAgICB0ZXN0SUQ6IFByb3BUeXBlcy5zdHJpbmcsCiAgICBoYXNUVlByZWZlcnJlZEZvY3VzOiBQcm9wVHlwZXMuYm9vbAogIH0sIF90ZW1wKTsKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgYnV0dG9uOiBQbGF0Zm9ybS5zZWxlY3QoewogICAgICBpb3M6IHt9LAogICAgICBhbmRyb2lkOiB7CiAgICAgICAgZWxldmF0aW9uOiA0LAogICAgICAgIGJhY2tncm91bmRDb2xvcjogJyMyMTk2RjMnLAogICAgICAgIGJvcmRlclJhZGl1czogMgogICAgICB9CiAgICB9KSwKICAgIHRleHQ6IFBsYXRmb3JtLnNlbGVjdCh7CiAgICAgIGlvczogewogICAgICAgIGNvbG9yOiAnIzAwN0FGRicsCiAgICAgICAgdGV4dEFsaWduOiAnY2VudGVyJywKICAgICAgICBwYWRkaW5nOiA4LAogICAgICAgIGZvbnRTaXplOiAxOAogICAgICB9LAogICAgICBhbmRyb2lkOiB7CiAgICAgICAgY29sb3I6ICd3aGl0ZScsCiAgICAgICAgdGV4dEFsaWduOiAnY2VudGVyJywKICAgICAgICBwYWRkaW5nOiA4LAogICAgICAgIGZvbnRXZWlnaHQ6ICc1MDAnCiAgICAgIH0KICAgIH0pLAogICAgYnV0dG9uRGlzYWJsZWQ6IFBsYXRmb3JtLnNlbGVjdCh7CiAgICAgIGlvczoge30sCiAgICAgIGFuZHJvaWQ6IHsKICAgICAgICBlbGV2YXRpb246IDAsCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiAnI2RmZGZkZicKICAgICAgfQogICAgfSksCiAgICB0ZXh0RGlzYWJsZWQ6IFBsYXRmb3JtLnNlbGVjdCh7CiAgICAgIGlvczogewogICAgICAgIGNvbG9yOiAnI2NkY2RjZCcKICAgICAgfSwKICAgICAgYW5kcm9pZDogewogICAgICAgIGNvbG9yOiAnI2ExYTFhMScKICAgICAgfQogICAgfSkKICB9KTsKICBtb2R1bGUuZXhwb3J0cyA9IEJ1dHRvbjsKfSwxODAsWzEyMyw1MiwxMzAsMTI3LDE2OCwxODEsMTg5LDE5MywxNzAsMTNdLCJCdXR0b24iKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9UZXh0L1RleHQuanMiOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBFZGdlSW5zZXRzUHJvcFR5cGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiRWRnZUluc2V0c1Byb3BUeXBlIik7CgogIHZhciBOYXRpdmVNZXRob2RzTWl4aW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiTmF0aXZlTWV0aG9kc01peGluIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJQbGF0Zm9ybSIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiUmVhY3QiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJwcm9wLXR5cGVzIik7CgogIHZhciBSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgIlJlYWN0TmF0aXZlVmlld0F0dHJpYnV0ZXMiKTsKCiAgdmFyIFN0eWxlU2hlZXRQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJTdHlsZVNoZWV0UHJvcFR5cGUiKTsKCiAgdmFyIFRleHRTdHlsZVByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJUZXh0U3R5bGVQcm9wVHlwZXMiKTsKCiAgdmFyIFRvdWNoYWJsZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOV0sICJUb3VjaGFibGUiKTsKCiAgdmFyIGNyZWF0ZVJlYWN0Q2xhc3MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEwXSwgImNyZWF0ZS1yZWFjdC1jbGFzcyIpOwoKICB2YXIgY3JlYXRlUmVhY3ROYXRpdmVDb21wb25lbnRDbGFzcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTFdLCAiY3JlYXRlUmVhY3ROYXRpdmVDb21wb25lbnRDbGFzcyIpOwoKICB2YXIgbWVyZ2VGYXN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMl0sICJtZXJnZUZhc3QiKTsKCiAgdmFyIHByb2Nlc3NDb2xvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTNdLCAicHJvY2Vzc0NvbG9yIik7CgogIHZhciBzdHlsZVByb3BUeXBlID0gU3R5bGVTaGVldFByb3BUeXBlKFRleHRTdHlsZVByb3BUeXBlcyk7CiAgdmFyIHZpZXdDb25maWcgPSB7CiAgICB2YWxpZEF0dHJpYnV0ZXM6IG1lcmdlRmFzdChSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzLlVJVmlldywgewogICAgICBpc0hpZ2hsaWdodGVkOiB0cnVlLAogICAgICBudW1iZXJPZkxpbmVzOiB0cnVlLAogICAgICBlbGxpcHNpemVNb2RlOiB0cnVlLAogICAgICBhbGxvd0ZvbnRTY2FsaW5nOiB0cnVlLAogICAgICBkaXNhYmxlZDogdHJ1ZSwKICAgICAgc2VsZWN0YWJsZTogdHJ1ZSwKICAgICAgc2VsZWN0aW9uQ29sb3I6IHRydWUsCiAgICAgIGFkanVzdHNGb250U2l6ZVRvRml0OiB0cnVlLAogICAgICBtaW5pbXVtRm9udFNjYWxlOiB0cnVlLAogICAgICB0ZXh0QnJlYWtTdHJhdGVneTogdHJ1ZQogICAgfSksCiAgICB1aVZpZXdDbGFzc05hbWU6ICdSQ1RUZXh0JwogIH07CiAgdmFyIFRleHQgPSBjcmVhdGVSZWFjdENsYXNzKHsKICAgIGRpc3BsYXlOYW1lOiAnVGV4dCcsCiAgICBwcm9wVHlwZXM6IHsKICAgICAgZWxsaXBzaXplTW9kZTogUHJvcFR5cGVzLm9uZU9mKFsnaGVhZCcsICdtaWRkbGUnLCAndGFpbCcsICdjbGlwJ10pLAogICAgICBudW1iZXJPZkxpbmVzOiBQcm9wVHlwZXMubnVtYmVyLAogICAgICB0ZXh0QnJlYWtTdHJhdGVneTogUHJvcFR5cGVzLm9uZU9mKFsnc2ltcGxlJywgJ2hpZ2hRdWFsaXR5JywgJ2JhbGFuY2VkJ10pLAogICAgICBvbkxheW91dDogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uUHJlc3M6IFByb3BUeXBlcy5mdW5jLAogICAgICBvbkxvbmdQcmVzczogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIHByZXNzUmV0ZW50aW9uT2Zmc2V0OiBFZGdlSW5zZXRzUHJvcFR5cGUsCiAgICAgIHNlbGVjdGFibGU6IFByb3BUeXBlcy5ib29sLAogICAgICBzZWxlY3Rpb25Db2xvcjogQ29sb3JQcm9wVHlwZSwKICAgICAgc3VwcHJlc3NIaWdobGlnaHRpbmc6IFByb3BUeXBlcy5ib29sLAogICAgICBzdHlsZTogc3R5bGVQcm9wVHlwZSwKICAgICAgdGVzdElEOiBQcm9wVHlwZXMuc3RyaW5nLAogICAgICBuYXRpdmVJRDogUHJvcFR5cGVzLnN0cmluZywKICAgICAgYWxsb3dGb250U2NhbGluZzogUHJvcFR5cGVzLmJvb2wsCiAgICAgIGFjY2Vzc2libGU6IFByb3BUeXBlcy5ib29sLAogICAgICBhZGp1c3RzRm9udFNpemVUb0ZpdDogUHJvcFR5cGVzLmJvb2wsCiAgICAgIG1pbmltdW1Gb250U2NhbGU6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgIGRpc2FibGVkOiBQcm9wVHlwZXMuYm9vbAogICAgfSwKICAgIGdldERlZmF1bHRQcm9wczogZnVuY3Rpb24gZ2V0RGVmYXVsdFByb3BzKCkgewogICAgICByZXR1cm4gewogICAgICAgIGFjY2Vzc2libGU6IHRydWUsCiAgICAgICAgYWxsb3dGb250U2NhbGluZzogdHJ1ZSwKICAgICAgICBlbGxpcHNpemVNb2RlOiAndGFpbCcKICAgICAgfTsKICAgIH0sCiAgICBnZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uIGdldEluaXRpYWxTdGF0ZSgpIHsKICAgICAgcmV0dXJuIG1lcmdlRmFzdChUb3VjaGFibGUuTWl4aW4udG91Y2hhYmxlR2V0SW5pdGlhbFN0YXRlKCksIHsKICAgICAgICBpc0hpZ2hsaWdodGVkOiBmYWxzZQogICAgICB9KTsKICAgIH0sCiAgICBtaXhpbnM6IFtOYXRpdmVNZXRob2RzTWl4aW5dLAogICAgdmlld0NvbmZpZzogdmlld0NvbmZpZywKICAgIGdldENoaWxkQ29udGV4dDogZnVuY3Rpb24gZ2V0Q2hpbGRDb250ZXh0KCkgewogICAgICByZXR1cm4gewogICAgICAgIGlzSW5BUGFyZW50VGV4dDogdHJ1ZQogICAgICB9OwogICAgfSwKICAgIGNoaWxkQ29udGV4dFR5cGVzOiB7CiAgICAgIGlzSW5BUGFyZW50VGV4dDogUHJvcFR5cGVzLmJvb2wKICAgIH0sCiAgICBjb250ZXh0VHlwZXM6IHsKICAgICAgaXNJbkFQYXJlbnRUZXh0OiBQcm9wVHlwZXMuYm9vbAogICAgfSwKICAgIF9oYW5kbGVyczogbnVsbCwKICAgIF9oYXNQcmVzc0hhbmRsZXI6IGZ1bmN0aW9uIF9oYXNQcmVzc0hhbmRsZXIoKSB7CiAgICAgIHJldHVybiAhIXRoaXMucHJvcHMub25QcmVzcyB8fCAhIXRoaXMucHJvcHMub25Mb25nUHJlc3M7CiAgICB9LAogICAgdG91Y2hhYmxlSGFuZGxlQWN0aXZlUHJlc3NJbjogbnVsbCwKICAgIHRvdWNoYWJsZUhhbmRsZUFjdGl2ZVByZXNzT3V0OiBudWxsLAogICAgdG91Y2hhYmxlSGFuZGxlUHJlc3M6IG51bGwsCiAgICB0b3VjaGFibGVIYW5kbGVMb25nUHJlc3M6IG51bGwsCiAgICB0b3VjaGFibGVHZXRQcmVzc1JlY3RPZmZzZXQ6IG51bGwsCiAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBuZXdQcm9wcyA9IHRoaXMucHJvcHM7CgogICAgICBpZiAodGhpcy5wcm9wcy5vblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyIHx8IHRoaXMuX2hhc1ByZXNzSGFuZGxlcigpKSB7CiAgICAgICAgaWYgKCF0aGlzLl9oYW5kbGVycykgewogICAgICAgICAgdGhpcy5faGFuZGxlcnMgPSB7CiAgICAgICAgICAgIG9uU3RhcnRTaG91bGRTZXRSZXNwb25kZXI6IGZ1bmN0aW9uIG9uU3RhcnRTaG91bGRTZXRSZXNwb25kZXIoKSB7CiAgICAgICAgICAgICAgdmFyIHNob3VsZFNldEZyb21Qcm9wcyA9IF90aGlzLnByb3BzLm9uU3RhcnRTaG91bGRTZXRSZXNwb25kZXIgJiYgX3RoaXMucHJvcHMub25TdGFydFNob3VsZFNldFJlc3BvbmRlcigpOwoKICAgICAgICAgICAgICB2YXIgc2V0UmVzcG9uZGVyID0gc2hvdWxkU2V0RnJvbVByb3BzIHx8IF90aGlzLl9oYXNQcmVzc0hhbmRsZXIoKTsKCiAgICAgICAgICAgICAgaWYgKHNldFJlc3BvbmRlciAmJiAhX3RoaXMudG91Y2hhYmxlSGFuZGxlQWN0aXZlUHJlc3NJbikgewogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIFRvdWNoYWJsZS5NaXhpbikgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIFRvdWNoYWJsZS5NaXhpbltrZXldID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXNba2V5XSA9IFRvdWNoYWJsZS5NaXhpbltrZXldLmJpbmQoX3RoaXMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgX3RoaXMudG91Y2hhYmxlSGFuZGxlQWN0aXZlUHJlc3NJbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLnByb3BzLnN1cHByZXNzSGlnaGxpZ2h0aW5nIHx8ICFfdGhpcy5faGFzUHJlc3NIYW5kbGVyKCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIF90aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICBpc0hpZ2hsaWdodGVkOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBfdGhpcy50b3VjaGFibGVIYW5kbGVBY3RpdmVQcmVzc091dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLnByb3BzLnN1cHByZXNzSGlnaGxpZ2h0aW5nIHx8ICFfdGhpcy5faGFzUHJlc3NIYW5kbGVyKCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIF90aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICBpc0hpZ2hsaWdodGVkOiBmYWxzZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgX3RoaXMudG91Y2hhYmxlSGFuZGxlUHJlc3MgPSBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICBfdGhpcy5wcm9wcy5vblByZXNzICYmIF90aGlzLnByb3BzLm9uUHJlc3MoZSk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIF90aGlzLnRvdWNoYWJsZUhhbmRsZUxvbmdQcmVzcyA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgIF90aGlzLnByb3BzLm9uTG9uZ1ByZXNzICYmIF90aGlzLnByb3BzLm9uTG9uZ1ByZXNzKGUpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBfdGhpcy50b3VjaGFibGVHZXRQcmVzc1JlY3RPZmZzZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLnByZXNzUmV0ZW50aW9uT2Zmc2V0IHx8IFBSRVNTX1JFQ1RfT0ZGU0VUOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBzZXRSZXNwb25kZXI7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uUmVzcG9uZGVyR3JhbnQ6IGZ1bmN0aW9uIChlLCBkaXNwYXRjaElEKSB7CiAgICAgICAgICAgICAgdGhpcy50b3VjaGFibGVIYW5kbGVSZXNwb25kZXJHcmFudChlLCBkaXNwYXRjaElEKTsKICAgICAgICAgICAgICB0aGlzLnByb3BzLm9uUmVzcG9uZGVyR3JhbnQgJiYgdGhpcy5wcm9wcy5vblJlc3BvbmRlckdyYW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0uYmluZCh0aGlzKSwKICAgICAgICAgICAgb25SZXNwb25kZXJNb3ZlOiBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgIHRoaXMudG91Y2hhYmxlSGFuZGxlUmVzcG9uZGVyTW92ZShlKTsKICAgICAgICAgICAgICB0aGlzLnByb3BzLm9uUmVzcG9uZGVyTW92ZSAmJiB0aGlzLnByb3BzLm9uUmVzcG9uZGVyTW92ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9LmJpbmQodGhpcyksCiAgICAgICAgICAgIG9uUmVzcG9uZGVyUmVsZWFzZTogZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICB0aGlzLnRvdWNoYWJsZUhhbmRsZVJlc3BvbmRlclJlbGVhc2UoZSk7CiAgICAgICAgICAgICAgdGhpcy5wcm9wcy5vblJlc3BvbmRlclJlbGVhc2UgJiYgdGhpcy5wcm9wcy5vblJlc3BvbmRlclJlbGVhc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfS5iaW5kKHRoaXMpLAogICAgICAgICAgICBvblJlc3BvbmRlclRlcm1pbmF0ZTogZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICB0aGlzLnRvdWNoYWJsZUhhbmRsZVJlc3BvbmRlclRlcm1pbmF0ZShlKTsKICAgICAgICAgICAgICB0aGlzLnByb3BzLm9uUmVzcG9uZGVyVGVybWluYXRlICYmIHRoaXMucHJvcHMub25SZXNwb25kZXJUZXJtaW5hdGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfS5iaW5kKHRoaXMpLAogICAgICAgICAgICBvblJlc3BvbmRlclRlcm1pbmF0aW9uUmVxdWVzdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHZhciBhbGxvd1Rlcm1pbmF0aW9uID0gdGhpcy50b3VjaGFibGVIYW5kbGVSZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3QoKTsKCiAgICAgICAgICAgICAgaWYgKGFsbG93VGVybWluYXRpb24gJiYgdGhpcy5wcm9wcy5vblJlc3BvbmRlclRlcm1pbmF0aW9uUmVxdWVzdCkgewogICAgICAgICAgICAgICAgYWxsb3dUZXJtaW5hdGlvbiA9IHRoaXMucHJvcHMub25SZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBhbGxvd1Rlcm1pbmF0aW9uOwogICAgICAgICAgICB9LmJpbmQodGhpcykKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBuZXdQcm9wcyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCB0aGlzLnByb3BzLCB0aGlzLl9oYW5kbGVycywgewogICAgICAgICAgaXNIaWdobGlnaHRlZDogdGhpcy5zdGF0ZS5pc0hpZ2hsaWdodGVkCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmIChuZXdQcm9wcy5zZWxlY3Rpb25Db2xvciAhPSBudWxsKSB7CiAgICAgICAgbmV3UHJvcHMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgbmV3UHJvcHMsIHsKICAgICAgICAgIHNlbGVjdGlvbkNvbG9yOiBwcm9jZXNzQ29sb3IobmV3UHJvcHMuc2VsZWN0aW9uQ29sb3IpCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmIChUb3VjaGFibGUuVE9VQ0hfVEFSR0VUX0RFQlVHICYmIG5ld1Byb3BzLm9uUHJlc3MpIHsKICAgICAgICBuZXdQcm9wcyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBuZXdQcm9wcywgewogICAgICAgICAgc3R5bGU6IFt0aGlzLnByb3BzLnN0eWxlLCB7CiAgICAgICAgICAgIGNvbG9yOiAnbWFnZW50YScKICAgICAgICAgIH1dCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmNvbnRleHQuaXNJbkFQYXJlbnRUZXh0KSB7CiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoUkNUVmlydHVhbFRleHQsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBuZXdQcm9wcywgewogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogNTQ2CiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFJDVFRleHQsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBuZXdQcm9wcywgewogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogNTQ4CiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9CiAgICB9CiAgfSk7CiAgdmFyIFBSRVNTX1JFQ1RfT0ZGU0VUID0gewogICAgdG9wOiAyMCwKICAgIGxlZnQ6IDIwLAogICAgcmlnaHQ6IDIwLAogICAgYm90dG9tOiAzMAogIH07CiAgdmFyIFJDVFRleHQgPSBjcmVhdGVSZWFjdE5hdGl2ZUNvbXBvbmVudENsYXNzKHZpZXdDb25maWcudWlWaWV3Q2xhc3NOYW1lLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdmlld0NvbmZpZzsKICB9KTsKICB2YXIgUkNUVmlydHVhbFRleHQgPSBSQ1RUZXh0OwoKICBpZiAoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJykgewogICAgUkNUVmlydHVhbFRleHQgPSBjcmVhdGVSZWFjdE5hdGl2ZUNvbXBvbmVudENsYXNzKCdSQ1RWaXJ0dWFsVGV4dCcsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWxpZEF0dHJpYnV0ZXM6IG1lcmdlRmFzdChSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzLlVJVmlldywgewogICAgICAgICAgaXNIaWdobGlnaHRlZDogdHJ1ZQogICAgICAgIH0pLAogICAgICAgIHVpVmlld0NsYXNzTmFtZTogJ1JDVFZpcnR1YWxUZXh0JwogICAgICB9OwogICAgfSk7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IFRleHQ7Cn0sMTgxLFsxMjMsMTMyLDEyNSw1MiwxMzAsMTI3LDE3MSwxMzgsMTUxLDE4MiwxNzIsMTU2LDE4OCwxNTJdLCJUZXh0Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29tcG9uZW50cy9Ub3VjaGFibGUvVG91Y2hhYmxlLmpzIjsKCiAgdmFyIEJvdW5kaW5nRGltZW5zaW9ucyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJCb3VuZGluZ0RpbWVuc2lvbnMiKTsKCiAgdmFyIFBsYXRmb3JtID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlBsYXRmb3JtIik7CgogIHZhciBQb3NpdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJQb3NpdGlvbiIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUmVhY3QiKTsKCiAgdmFyIFJlYWN0TmF0aXZlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlJlYWN0TmF0aXZlIik7CgogIHZhciBUVkV2ZW50SGFuZGxlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJUVkV2ZW50SGFuZGxlciIpOwoKICB2YXIgVG91Y2hFdmVudFV0aWxzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgImZianMvbGliL1RvdWNoRXZlbnRVdGlscyIpOwoKICB2YXIgVUlNYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgIlVJTWFuYWdlciIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJWaWV3Iik7CgogIHZhciBrZXlNaXJyb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAiZmJqcy9saWIva2V5TWlycm9yIik7CgogIHZhciBub3JtYWxpemVDb2xvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTBdLCAibm9ybWFsaXplQ29sb3IiKTsKCiAgdmFyIFN0YXRlcyA9IGtleU1pcnJvcih7CiAgICBOT1RfUkVTUE9OREVSOiBudWxsLAogICAgUkVTUE9OREVSX0lOQUNUSVZFX1BSRVNTX0lOOiBudWxsLAogICAgUkVTUE9OREVSX0lOQUNUSVZFX1BSRVNTX09VVDogbnVsbCwKICAgIFJFU1BPTkRFUl9BQ1RJVkVfUFJFU1NfSU46IG51bGwsCiAgICBSRVNQT05ERVJfQUNUSVZFX1BSRVNTX09VVDogbnVsbCwKICAgIFJFU1BPTkRFUl9BQ1RJVkVfTE9OR19QUkVTU19JTjogbnVsbCwKICAgIFJFU1BPTkRFUl9BQ1RJVkVfTE9OR19QUkVTU19PVVQ6IG51bGwsCiAgICBFUlJPUjogbnVsbAogIH0pOwogIHZhciBJc0FjdGl2ZSA9IHsKICAgIFJFU1BPTkRFUl9BQ1RJVkVfUFJFU1NfT1VUOiB0cnVlLAogICAgUkVTUE9OREVSX0FDVElWRV9QUkVTU19JTjogdHJ1ZQogIH07CiAgdmFyIElzUHJlc3NpbmdJbiA9IHsKICAgIFJFU1BPTkRFUl9JTkFDVElWRV9QUkVTU19JTjogdHJ1ZSwKICAgIFJFU1BPTkRFUl9BQ1RJVkVfUFJFU1NfSU46IHRydWUsCiAgICBSRVNQT05ERVJfQUNUSVZFX0xPTkdfUFJFU1NfSU46IHRydWUKICB9OwogIHZhciBJc0xvbmdQcmVzc2luZ0luID0gewogICAgUkVTUE9OREVSX0FDVElWRV9MT05HX1BSRVNTX0lOOiB0cnVlCiAgfTsKICB2YXIgU2lnbmFscyA9IGtleU1pcnJvcih7CiAgICBERUxBWTogbnVsbCwKICAgIFJFU1BPTkRFUl9HUkFOVDogbnVsbCwKICAgIFJFU1BPTkRFUl9SRUxFQVNFOiBudWxsLAogICAgUkVTUE9OREVSX1RFUk1JTkFURUQ6IG51bGwsCiAgICBFTlRFUl9QUkVTU19SRUNUOiBudWxsLAogICAgTEVBVkVfUFJFU1NfUkVDVDogbnVsbCwKICAgIExPTkdfUFJFU1NfREVURUNURUQ6IG51bGwKICB9KTsKICB2YXIgVHJhbnNpdGlvbnMgPSB7CiAgICBOT1RfUkVTUE9OREVSOiB7CiAgICAgIERFTEFZOiBTdGF0ZXMuRVJST1IsCiAgICAgIFJFU1BPTkRFUl9HUkFOVDogU3RhdGVzLlJFU1BPTkRFUl9JTkFDVElWRV9QUkVTU19JTiwKICAgICAgUkVTUE9OREVSX1JFTEVBU0U6IFN0YXRlcy5FUlJPUiwKICAgICAgUkVTUE9OREVSX1RFUk1JTkFURUQ6IFN0YXRlcy5FUlJPUiwKICAgICAgRU5URVJfUFJFU1NfUkVDVDogU3RhdGVzLkVSUk9SLAogICAgICBMRUFWRV9QUkVTU19SRUNUOiBTdGF0ZXMuRVJST1IsCiAgICAgIExPTkdfUFJFU1NfREVURUNURUQ6IFN0YXRlcy5FUlJPUgogICAgfSwKICAgIFJFU1BPTkRFUl9JTkFDVElWRV9QUkVTU19JTjogewogICAgICBERUxBWTogU3RhdGVzLlJFU1BPTkRFUl9BQ1RJVkVfUFJFU1NfSU4sCiAgICAgIFJFU1BPTkRFUl9HUkFOVDogU3RhdGVzLkVSUk9SLAogICAgICBSRVNQT05ERVJfUkVMRUFTRTogU3RhdGVzLk5PVF9SRVNQT05ERVIsCiAgICAgIFJFU1BPTkRFUl9URVJNSU5BVEVEOiBTdGF0ZXMuTk9UX1JFU1BPTkRFUiwKICAgICAgRU5URVJfUFJFU1NfUkVDVDogU3RhdGVzLlJFU1BPTkRFUl9JTkFDVElWRV9QUkVTU19JTiwKICAgICAgTEVBVkVfUFJFU1NfUkVDVDogU3RhdGVzLlJFU1BPTkRFUl9JTkFDVElWRV9QUkVTU19PVVQsCiAgICAgIExPTkdfUFJFU1NfREVURUNURUQ6IFN0YXRlcy5FUlJPUgogICAgfSwKICAgIFJFU1BPTkRFUl9JTkFDVElWRV9QUkVTU19PVVQ6IHsKICAgICAgREVMQVk6IFN0YXRlcy5SRVNQT05ERVJfQUNUSVZFX1BSRVNTX09VVCwKICAgICAgUkVTUE9OREVSX0dSQU5UOiBTdGF0ZXMuRVJST1IsCiAgICAgIFJFU1BPTkRFUl9SRUxFQVNFOiBTdGF0ZXMuTk9UX1JFU1BPTkRFUiwKICAgICAgUkVTUE9OREVSX1RFUk1JTkFURUQ6IFN0YXRlcy5OT1RfUkVTUE9OREVSLAogICAgICBFTlRFUl9QUkVTU19SRUNUOiBTdGF0ZXMuUkVTUE9OREVSX0lOQUNUSVZFX1BSRVNTX0lOLAogICAgICBMRUFWRV9QUkVTU19SRUNUOiBTdGF0ZXMuUkVTUE9OREVSX0lOQUNUSVZFX1BSRVNTX09VVCwKICAgICAgTE9OR19QUkVTU19ERVRFQ1RFRDogU3RhdGVzLkVSUk9SCiAgICB9LAogICAgUkVTUE9OREVSX0FDVElWRV9QUkVTU19JTjogewogICAgICBERUxBWTogU3RhdGVzLkVSUk9SLAogICAgICBSRVNQT05ERVJfR1JBTlQ6IFN0YXRlcy5FUlJPUiwKICAgICAgUkVTUE9OREVSX1JFTEVBU0U6IFN0YXRlcy5OT1RfUkVTUE9OREVSLAogICAgICBSRVNQT05ERVJfVEVSTUlOQVRFRDogU3RhdGVzLk5PVF9SRVNQT05ERVIsCiAgICAgIEVOVEVSX1BSRVNTX1JFQ1Q6IFN0YXRlcy5SRVNQT05ERVJfQUNUSVZFX1BSRVNTX0lOLAogICAgICBMRUFWRV9QUkVTU19SRUNUOiBTdGF0ZXMuUkVTUE9OREVSX0FDVElWRV9QUkVTU19PVVQsCiAgICAgIExPTkdfUFJFU1NfREVURUNURUQ6IFN0YXRlcy5SRVNQT05ERVJfQUNUSVZFX0xPTkdfUFJFU1NfSU4KICAgIH0sCiAgICBSRVNQT05ERVJfQUNUSVZFX1BSRVNTX09VVDogewogICAgICBERUxBWTogU3RhdGVzLkVSUk9SLAogICAgICBSRVNQT05ERVJfR1JBTlQ6IFN0YXRlcy5FUlJPUiwKICAgICAgUkVTUE9OREVSX1JFTEVBU0U6IFN0YXRlcy5OT1RfUkVTUE9OREVSLAogICAgICBSRVNQT05ERVJfVEVSTUlOQVRFRDogU3RhdGVzLk5PVF9SRVNQT05ERVIsCiAgICAgIEVOVEVSX1BSRVNTX1JFQ1Q6IFN0YXRlcy5SRVNQT05ERVJfQUNUSVZFX1BSRVNTX0lOLAogICAgICBMRUFWRV9QUkVTU19SRUNUOiBTdGF0ZXMuUkVTUE9OREVSX0FDVElWRV9QUkVTU19PVVQsCiAgICAgIExPTkdfUFJFU1NfREVURUNURUQ6IFN0YXRlcy5FUlJPUgogICAgfSwKICAgIFJFU1BPTkRFUl9BQ1RJVkVfTE9OR19QUkVTU19JTjogewogICAgICBERUxBWTogU3RhdGVzLkVSUk9SLAogICAgICBSRVNQT05ERVJfR1JBTlQ6IFN0YXRlcy5FUlJPUiwKICAgICAgUkVTUE9OREVSX1JFTEVBU0U6IFN0YXRlcy5OT1RfUkVTUE9OREVSLAogICAgICBSRVNQT05ERVJfVEVSTUlOQVRFRDogU3RhdGVzLk5PVF9SRVNQT05ERVIsCiAgICAgIEVOVEVSX1BSRVNTX1JFQ1Q6IFN0YXRlcy5SRVNQT05ERVJfQUNUSVZFX0xPTkdfUFJFU1NfSU4sCiAgICAgIExFQVZFX1BSRVNTX1JFQ1Q6IFN0YXRlcy5SRVNQT05ERVJfQUNUSVZFX0xPTkdfUFJFU1NfT1VULAogICAgICBMT05HX1BSRVNTX0RFVEVDVEVEOiBTdGF0ZXMuUkVTUE9OREVSX0FDVElWRV9MT05HX1BSRVNTX0lOCiAgICB9LAogICAgUkVTUE9OREVSX0FDVElWRV9MT05HX1BSRVNTX09VVDogewogICAgICBERUxBWTogU3RhdGVzLkVSUk9SLAogICAgICBSRVNQT05ERVJfR1JBTlQ6IFN0YXRlcy5FUlJPUiwKICAgICAgUkVTUE9OREVSX1JFTEVBU0U6IFN0YXRlcy5OT1RfUkVTUE9OREVSLAogICAgICBSRVNQT05ERVJfVEVSTUlOQVRFRDogU3RhdGVzLk5PVF9SRVNQT05ERVIsCiAgICAgIEVOVEVSX1BSRVNTX1JFQ1Q6IFN0YXRlcy5SRVNQT05ERVJfQUNUSVZFX0xPTkdfUFJFU1NfSU4sCiAgICAgIExFQVZFX1BSRVNTX1JFQ1Q6IFN0YXRlcy5SRVNQT05ERVJfQUNUSVZFX0xPTkdfUFJFU1NfT1VULAogICAgICBMT05HX1BSRVNTX0RFVEVDVEVEOiBTdGF0ZXMuRVJST1IKICAgIH0sCiAgICBlcnJvcjogewogICAgICBERUxBWTogU3RhdGVzLk5PVF9SRVNQT05ERVIsCiAgICAgIFJFU1BPTkRFUl9HUkFOVDogU3RhdGVzLlJFU1BPTkRFUl9JTkFDVElWRV9QUkVTU19JTiwKICAgICAgUkVTUE9OREVSX1JFTEVBU0U6IFN0YXRlcy5OT1RfUkVTUE9OREVSLAogICAgICBSRVNQT05ERVJfVEVSTUlOQVRFRDogU3RhdGVzLk5PVF9SRVNQT05ERVIsCiAgICAgIEVOVEVSX1BSRVNTX1JFQ1Q6IFN0YXRlcy5OT1RfUkVTUE9OREVSLAogICAgICBMRUFWRV9QUkVTU19SRUNUOiBTdGF0ZXMuTk9UX1JFU1BPTkRFUiwKICAgICAgTE9OR19QUkVTU19ERVRFQ1RFRDogU3RhdGVzLk5PVF9SRVNQT05ERVIKICAgIH0KICB9OwogIHZhciBISUdITElHSFRfREVMQVlfTVMgPSAxMzA7CiAgdmFyIFBSRVNTX0VYUEFORF9QWCA9IDIwOwogIHZhciBMT05HX1BSRVNTX1RIUkVTSE9MRCA9IDUwMDsKICB2YXIgTE9OR19QUkVTU19ERUxBWV9NUyA9IExPTkdfUFJFU1NfVEhSRVNIT0xEIC0gSElHSExJR0hUX0RFTEFZX01TOwogIHZhciBMT05HX1BSRVNTX0FMTE9XRURfTU9WRU1FTlQgPSAxMDsKICB2YXIgVG91Y2hhYmxlTWl4aW4gPSB7CiAgICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24gY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgIGlmICghUGxhdGZvcm0uaXNUVk9TKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl90dkV2ZW50SGFuZGxlciA9IG5ldyBUVkV2ZW50SGFuZGxlcigpOwoKICAgICAgdGhpcy5fdHZFdmVudEhhbmRsZXIuZW5hYmxlKHRoaXMsIGZ1bmN0aW9uIChjbXAsIGV2dCkgewogICAgICAgIHZhciBteVRhZyA9IFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKGNtcCk7CiAgICAgICAgZXZ0LmRpc3BhdGNoQ29uZmlnID0ge307CgogICAgICAgIGlmIChteVRhZyA9PT0gZXZ0LnRhZykgewogICAgICAgICAgaWYgKGV2dC5ldmVudFR5cGUgPT09ICdmb2N1cycpIHsKICAgICAgICAgICAgY21wLnRvdWNoYWJsZUhhbmRsZUFjdGl2ZVByZXNzSW4gJiYgY21wLnRvdWNoYWJsZUhhbmRsZUFjdGl2ZVByZXNzSW4oZXZ0KTsKICAgICAgICAgIH0gZWxzZSBpZiAoZXZ0LmV2ZW50VHlwZSA9PT0gJ2JsdXInKSB7CiAgICAgICAgICAgIGNtcC50b3VjaGFibGVIYW5kbGVBY3RpdmVQcmVzc091dCAmJiBjbXAudG91Y2hhYmxlSGFuZGxlQWN0aXZlUHJlc3NPdXQoZXZ0KTsKICAgICAgICAgIH0gZWxzZSBpZiAoZXZ0LmV2ZW50VHlwZSA9PT0gJ3NlbGVjdCcpIHsKICAgICAgICAgICAgY21wLnRvdWNoYWJsZUhhbmRsZVByZXNzICYmIGNtcC50b3VjaGFibGVIYW5kbGVQcmVzcyhldnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgY29tcG9uZW50V2lsbFVubW91bnQ6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICBpZiAodGhpcy5fdHZFdmVudEhhbmRsZXIpIHsKICAgICAgICB0aGlzLl90dkV2ZW50SGFuZGxlci5kaXNhYmxlKCk7CgogICAgICAgIGRlbGV0ZSB0aGlzLl90dkV2ZW50SGFuZGxlcjsKICAgICAgfQoKICAgICAgdGhpcy50b3VjaGFibGVEZWxheVRpbWVvdXQgJiYgY2xlYXJUaW1lb3V0KHRoaXMudG91Y2hhYmxlRGVsYXlUaW1lb3V0KTsKICAgICAgdGhpcy5sb25nUHJlc3NEZWxheVRpbWVvdXQgJiYgY2xlYXJUaW1lb3V0KHRoaXMubG9uZ1ByZXNzRGVsYXlUaW1lb3V0KTsKICAgICAgdGhpcy5wcmVzc091dERlbGF5VGltZW91dCAmJiBjbGVhclRpbWVvdXQodGhpcy5wcmVzc091dERlbGF5VGltZW91dCk7CiAgICB9LAogICAgdG91Y2hhYmxlR2V0SW5pdGlhbFN0YXRlOiBmdW5jdGlvbiB0b3VjaGFibGVHZXRJbml0aWFsU3RhdGUoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdG91Y2hhYmxlOiB7CiAgICAgICAgICB0b3VjaFN0YXRlOiB1bmRlZmluZWQsCiAgICAgICAgICByZXNwb25kZXJJRDogbnVsbAogICAgICAgIH0KICAgICAgfTsKICAgIH0sCiAgICB0b3VjaGFibGVIYW5kbGVSZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3Q6IGZ1bmN0aW9uIHRvdWNoYWJsZUhhbmRsZVJlc3BvbmRlclRlcm1pbmF0aW9uUmVxdWVzdCgpIHsKICAgICAgcmV0dXJuICF0aGlzLnByb3BzLnJlamVjdFJlc3BvbmRlclRlcm1pbmF0aW9uOwogICAgfSwKICAgIHRvdWNoYWJsZUhhbmRsZVN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyOiBmdW5jdGlvbiB0b3VjaGFibGVIYW5kbGVTdGFydFNob3VsZFNldFJlc3BvbmRlcigpIHsKICAgICAgcmV0dXJuICF0aGlzLnByb3BzLmRpc2FibGVkOwogICAgfSwKICAgIHRvdWNoYWJsZUxvbmdQcmVzc0NhbmNlbHNQcmVzczogZnVuY3Rpb24gdG91Y2hhYmxlTG9uZ1ByZXNzQ2FuY2Vsc1ByZXNzKCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICB0b3VjaGFibGVIYW5kbGVSZXNwb25kZXJHcmFudDogZnVuY3Rpb24gdG91Y2hhYmxlSGFuZGxlUmVzcG9uZGVyR3JhbnQoZSkgewogICAgICB2YXIgZGlzcGF0Y2hJRCA9IGUuY3VycmVudFRhcmdldDsKICAgICAgZS5wZXJzaXN0KCk7CiAgICAgIHRoaXMucHJlc3NPdXREZWxheVRpbWVvdXQgJiYgY2xlYXJUaW1lb3V0KHRoaXMucHJlc3NPdXREZWxheVRpbWVvdXQpOwogICAgICB0aGlzLnByZXNzT3V0RGVsYXlUaW1lb3V0ID0gbnVsbDsKICAgICAgdGhpcy5zdGF0ZS50b3VjaGFibGUudG91Y2hTdGF0ZSA9IFN0YXRlcy5OT1RfUkVTUE9OREVSOwogICAgICB0aGlzLnN0YXRlLnRvdWNoYWJsZS5yZXNwb25kZXJJRCA9IGRpc3BhdGNoSUQ7CgogICAgICB0aGlzLl9yZWNlaXZlU2lnbmFsKFNpZ25hbHMuUkVTUE9OREVSX0dSQU5ULCBlKTsKCiAgICAgIHZhciBkZWxheU1TID0gdGhpcy50b3VjaGFibGVHZXRIaWdobGlnaHREZWxheU1TICE9PSB1bmRlZmluZWQgPyBNYXRoLm1heCh0aGlzLnRvdWNoYWJsZUdldEhpZ2hsaWdodERlbGF5TVMoKSwgMCkgOiBISUdITElHSFRfREVMQVlfTVM7CiAgICAgIGRlbGF5TVMgPSBpc05hTihkZWxheU1TKSA/IEhJR0hMSUdIVF9ERUxBWV9NUyA6IGRlbGF5TVM7CgogICAgICBpZiAoZGVsYXlNUyAhPT0gMCkgewogICAgICAgIHRoaXMudG91Y2hhYmxlRGVsYXlUaW1lb3V0ID0gc2V0VGltZW91dCh0aGlzLl9oYW5kbGVEZWxheS5iaW5kKHRoaXMsIGUpLCBkZWxheU1TKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9oYW5kbGVEZWxheShlKTsKICAgICAgfQoKICAgICAgdmFyIGxvbmdEZWxheU1TID0gdGhpcy50b3VjaGFibGVHZXRMb25nUHJlc3NEZWxheU1TICE9PSB1bmRlZmluZWQgPyBNYXRoLm1heCh0aGlzLnRvdWNoYWJsZUdldExvbmdQcmVzc0RlbGF5TVMoKSwgMTApIDogTE9OR19QUkVTU19ERUxBWV9NUzsKICAgICAgbG9uZ0RlbGF5TVMgPSBpc05hTihsb25nRGVsYXlNUykgPyBMT05HX1BSRVNTX0RFTEFZX01TIDogbG9uZ0RlbGF5TVM7CiAgICAgIHRoaXMubG9uZ1ByZXNzRGVsYXlUaW1lb3V0ID0gc2V0VGltZW91dCh0aGlzLl9oYW5kbGVMb25nRGVsYXkuYmluZCh0aGlzLCBlKSwgbG9uZ0RlbGF5TVMgKyBkZWxheU1TKTsKICAgIH0sCiAgICB0b3VjaGFibGVIYW5kbGVSZXNwb25kZXJSZWxlYXNlOiBmdW5jdGlvbiB0b3VjaGFibGVIYW5kbGVSZXNwb25kZXJSZWxlYXNlKGUpIHsKICAgICAgdGhpcy5fcmVjZWl2ZVNpZ25hbChTaWduYWxzLlJFU1BPTkRFUl9SRUxFQVNFLCBlKTsKICAgIH0sCiAgICB0b3VjaGFibGVIYW5kbGVSZXNwb25kZXJUZXJtaW5hdGU6IGZ1bmN0aW9uIHRvdWNoYWJsZUhhbmRsZVJlc3BvbmRlclRlcm1pbmF0ZShlKSB7CiAgICAgIHRoaXMuX3JlY2VpdmVTaWduYWwoU2lnbmFscy5SRVNQT05ERVJfVEVSTUlOQVRFRCwgZSk7CiAgICB9LAogICAgdG91Y2hhYmxlSGFuZGxlUmVzcG9uZGVyTW92ZTogZnVuY3Rpb24gdG91Y2hhYmxlSGFuZGxlUmVzcG9uZGVyTW92ZShlKSB7CiAgICAgIGlmICh0aGlzLnN0YXRlLnRvdWNoYWJsZS50b3VjaFN0YXRlID09PSBTdGF0ZXMuUkVTUE9OREVSX0lOQUNUSVZFX1BSRVNTX0lOKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuc3RhdGUudG91Y2hhYmxlLnBvc2l0aW9uT25BY3RpdmF0ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHBvc2l0aW9uT25BY3RpdmF0ZSA9IHRoaXMuc3RhdGUudG91Y2hhYmxlLnBvc2l0aW9uT25BY3RpdmF0ZTsKICAgICAgdmFyIGRpbWVuc2lvbnNPbkFjdGl2YXRlID0gdGhpcy5zdGF0ZS50b3VjaGFibGUuZGltZW5zaW9uc09uQWN0aXZhdGU7CiAgICAgIHZhciBwcmVzc1JlY3RPZmZzZXQgPSB0aGlzLnRvdWNoYWJsZUdldFByZXNzUmVjdE9mZnNldCA/IHRoaXMudG91Y2hhYmxlR2V0UHJlc3NSZWN0T2Zmc2V0KCkgOiB7CiAgICAgICAgbGVmdDogUFJFU1NfRVhQQU5EX1BYLAogICAgICAgIHJpZ2h0OiBQUkVTU19FWFBBTkRfUFgsCiAgICAgICAgdG9wOiBQUkVTU19FWFBBTkRfUFgsCiAgICAgICAgYm90dG9tOiBQUkVTU19FWFBBTkRfUFgKICAgICAgfTsKICAgICAgdmFyIHByZXNzRXhwYW5kTGVmdCA9IHByZXNzUmVjdE9mZnNldC5sZWZ0OwogICAgICB2YXIgcHJlc3NFeHBhbmRUb3AgPSBwcmVzc1JlY3RPZmZzZXQudG9wOwogICAgICB2YXIgcHJlc3NFeHBhbmRSaWdodCA9IHByZXNzUmVjdE9mZnNldC5yaWdodDsKICAgICAgdmFyIHByZXNzRXhwYW5kQm90dG9tID0gcHJlc3NSZWN0T2Zmc2V0LmJvdHRvbTsKICAgICAgdmFyIGhpdFNsb3AgPSB0aGlzLnRvdWNoYWJsZUdldEhpdFNsb3AgPyB0aGlzLnRvdWNoYWJsZUdldEhpdFNsb3AoKSA6IG51bGw7CgogICAgICBpZiAoaGl0U2xvcCkgewogICAgICAgIHByZXNzRXhwYW5kTGVmdCArPSBoaXRTbG9wLmxlZnQ7CiAgICAgICAgcHJlc3NFeHBhbmRUb3AgKz0gaGl0U2xvcC50b3A7CiAgICAgICAgcHJlc3NFeHBhbmRSaWdodCArPSBoaXRTbG9wLnJpZ2h0OwogICAgICAgIHByZXNzRXhwYW5kQm90dG9tICs9IGhpdFNsb3AuYm90dG9tOwogICAgICB9CgogICAgICB2YXIgdG91Y2ggPSBUb3VjaEV2ZW50VXRpbHMuZXh0cmFjdFNpbmdsZVRvdWNoKGUubmF0aXZlRXZlbnQpOwogICAgICB2YXIgcGFnZVggPSB0b3VjaCAmJiB0b3VjaC5wYWdlWDsKICAgICAgdmFyIHBhZ2VZID0gdG91Y2ggJiYgdG91Y2gucGFnZVk7CgogICAgICBpZiAodGhpcy5wcmVzc0luTG9jYXRpb24pIHsKICAgICAgICB2YXIgbW92ZWREaXN0YW5jZSA9IHRoaXMuX2dldERpc3RhbmNlQmV0d2VlblBvaW50cyhwYWdlWCwgcGFnZVksIHRoaXMucHJlc3NJbkxvY2F0aW9uLnBhZ2VYLCB0aGlzLnByZXNzSW5Mb2NhdGlvbi5wYWdlWSk7CgogICAgICAgIGlmIChtb3ZlZERpc3RhbmNlID4gTE9OR19QUkVTU19BTExPV0VEX01PVkVNRU5UKSB7CiAgICAgICAgICB0aGlzLl9jYW5jZWxMb25nUHJlc3NEZWxheVRpbWVvdXQoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBpc1RvdWNoV2l0aGluQWN0aXZlID0gcGFnZVggPiBwb3NpdGlvbk9uQWN0aXZhdGUubGVmdCAtIHByZXNzRXhwYW5kTGVmdCAmJiBwYWdlWSA+IHBvc2l0aW9uT25BY3RpdmF0ZS50b3AgLSBwcmVzc0V4cGFuZFRvcCAmJiBwYWdlWCA8IHBvc2l0aW9uT25BY3RpdmF0ZS5sZWZ0ICsgZGltZW5zaW9uc09uQWN0aXZhdGUud2lkdGggKyBwcmVzc0V4cGFuZFJpZ2h0ICYmIHBhZ2VZIDwgcG9zaXRpb25PbkFjdGl2YXRlLnRvcCArIGRpbWVuc2lvbnNPbkFjdGl2YXRlLmhlaWdodCArIHByZXNzRXhwYW5kQm90dG9tOwoKICAgICAgaWYgKGlzVG91Y2hXaXRoaW5BY3RpdmUpIHsKICAgICAgICB0aGlzLl9yZWNlaXZlU2lnbmFsKFNpZ25hbHMuRU5URVJfUFJFU1NfUkVDVCwgZSk7CgogICAgICAgIHZhciBjdXJTdGF0ZSA9IHRoaXMuc3RhdGUudG91Y2hhYmxlLnRvdWNoU3RhdGU7CgogICAgICAgIGlmIChjdXJTdGF0ZSA9PT0gU3RhdGVzLlJFU1BPTkRFUl9JTkFDVElWRV9QUkVTU19JTikgewogICAgICAgICAgdGhpcy5fY2FuY2VsTG9uZ1ByZXNzRGVsYXlUaW1lb3V0KCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX2NhbmNlbExvbmdQcmVzc0RlbGF5VGltZW91dCgpOwoKICAgICAgICB0aGlzLl9yZWNlaXZlU2lnbmFsKFNpZ25hbHMuTEVBVkVfUFJFU1NfUkVDVCwgZSk7CiAgICAgIH0KICAgIH0sCiAgICBfcmVtZWFzdXJlTWV0cmljc09uQWN0aXZhdGlvbjogZnVuY3Rpb24gX3JlbWVhc3VyZU1ldHJpY3NPbkFjdGl2YXRpb24oKSB7CiAgICAgIHZhciB0YWcgPSB0aGlzLnN0YXRlLnRvdWNoYWJsZS5yZXNwb25kZXJJRDsKCiAgICAgIGlmICh0YWcgPT0gbnVsbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgVUlNYW5hZ2VyLm1lYXN1cmUodGFnLCB0aGlzLl9oYW5kbGVRdWVyeUxheW91dCk7CiAgICB9LAogICAgX2hhbmRsZVF1ZXJ5TGF5b3V0OiBmdW5jdGlvbiBfaGFuZGxlUXVlcnlMYXlvdXQobCwgdCwgdywgaCwgZ2xvYmFsWCwgZ2xvYmFsWSkgewogICAgICBpZiAoIWwgJiYgIXQgJiYgIXcgJiYgIWggJiYgIWdsb2JhbFggJiYgIWdsb2JhbFkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuc3RhdGUudG91Y2hhYmxlLnBvc2l0aW9uT25BY3RpdmF0ZSAmJiBQb3NpdGlvbi5yZWxlYXNlKHRoaXMuc3RhdGUudG91Y2hhYmxlLnBvc2l0aW9uT25BY3RpdmF0ZSk7CiAgICAgIHRoaXMuc3RhdGUudG91Y2hhYmxlLmRpbWVuc2lvbnNPbkFjdGl2YXRlICYmIEJvdW5kaW5nRGltZW5zaW9ucy5yZWxlYXNlKHRoaXMuc3RhdGUudG91Y2hhYmxlLmRpbWVuc2lvbnNPbkFjdGl2YXRlKTsKICAgICAgdGhpcy5zdGF0ZS50b3VjaGFibGUucG9zaXRpb25PbkFjdGl2YXRlID0gUG9zaXRpb24uZ2V0UG9vbGVkKGdsb2JhbFgsIGdsb2JhbFkpOwogICAgICB0aGlzLnN0YXRlLnRvdWNoYWJsZS5kaW1lbnNpb25zT25BY3RpdmF0ZSA9IEJvdW5kaW5nRGltZW5zaW9ucy5nZXRQb29sZWQodywgaCk7CiAgICB9LAogICAgX2hhbmRsZURlbGF5OiBmdW5jdGlvbiBfaGFuZGxlRGVsYXkoZSkgewogICAgICB0aGlzLnRvdWNoYWJsZURlbGF5VGltZW91dCA9IG51bGw7CgogICAgICB0aGlzLl9yZWNlaXZlU2lnbmFsKFNpZ25hbHMuREVMQVksIGUpOwogICAgfSwKICAgIF9oYW5kbGVMb25nRGVsYXk6IGZ1bmN0aW9uIF9oYW5kbGVMb25nRGVsYXkoZSkgewogICAgICB0aGlzLmxvbmdQcmVzc0RlbGF5VGltZW91dCA9IG51bGw7CiAgICAgIHZhciBjdXJTdGF0ZSA9IHRoaXMuc3RhdGUudG91Y2hhYmxlLnRvdWNoU3RhdGU7CgogICAgICBpZiAoY3VyU3RhdGUgIT09IFN0YXRlcy5SRVNQT05ERVJfQUNUSVZFX1BSRVNTX0lOICYmIGN1clN0YXRlICE9PSBTdGF0ZXMuUkVTUE9OREVSX0FDVElWRV9MT05HX1BSRVNTX0lOKSB7CiAgICAgICAgY29uc29sZS5lcnJvcignQXR0ZW1wdGVkIHRvIHRyYW5zaXRpb24gZnJvbSBzdGF0ZSBgJyArIGN1clN0YXRlICsgJ2AgdG8gYCcgKyBTdGF0ZXMuUkVTUE9OREVSX0FDVElWRV9MT05HX1BSRVNTX0lOICsgJ2AsIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQuIFRoaXMgaXMgJyArICdtb3N0IGxpa2VseSBkdWUgdG8gYFRvdWNoYWJsZS5sb25nUHJlc3NEZWxheVRpbWVvdXRgIG5vdCBiZWluZyBjYW5jZWxsZWQuJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fcmVjZWl2ZVNpZ25hbChTaWduYWxzLkxPTkdfUFJFU1NfREVURUNURUQsIGUpOwogICAgICB9CiAgICB9LAogICAgX3JlY2VpdmVTaWduYWw6IGZ1bmN0aW9uIF9yZWNlaXZlU2lnbmFsKHNpZ25hbCwgZSkgewogICAgICB2YXIgcmVzcG9uZGVySUQgPSB0aGlzLnN0YXRlLnRvdWNoYWJsZS5yZXNwb25kZXJJRDsKICAgICAgdmFyIGN1clN0YXRlID0gdGhpcy5zdGF0ZS50b3VjaGFibGUudG91Y2hTdGF0ZTsKICAgICAgdmFyIG5leHRTdGF0ZSA9IFRyYW5zaXRpb25zW2N1clN0YXRlXSAmJiBUcmFuc2l0aW9uc1tjdXJTdGF0ZV1bc2lnbmFsXTsKCiAgICAgIGlmICghcmVzcG9uZGVySUQgJiYgc2lnbmFsID09PSBTaWduYWxzLlJFU1BPTkRFUl9SRUxFQVNFKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIW5leHRTdGF0ZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWNvZ25pemVkIHNpZ25hbCBgJyArIHNpZ25hbCArICdgIG9yIHN0YXRlIGAnICsgY3VyU3RhdGUgKyAnYCBmb3IgVG91Y2hhYmxlIHJlc3BvbmRlciBgJyArIHJlc3BvbmRlcklEICsgJ2AnKTsKICAgICAgfQoKICAgICAgaWYgKG5leHRTdGF0ZSA9PT0gU3RhdGVzLkVSUk9SKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUb3VjaGFibGUgY2Fubm90IHRyYW5zaXRpb24gZnJvbSBgJyArIGN1clN0YXRlICsgJ2AgdG8gYCcgKyBzaWduYWwgKyAnYCBmb3IgcmVzcG9uZGVyIGAnICsgcmVzcG9uZGVySUQgKyAnYCcpOwogICAgICB9CgogICAgICBpZiAoY3VyU3RhdGUgIT09IG5leHRTdGF0ZSkgewogICAgICAgIHRoaXMuX3BlcmZvcm1TaWRlRWZmZWN0c0ZvclRyYW5zaXRpb24oY3VyU3RhdGUsIG5leHRTdGF0ZSwgc2lnbmFsLCBlKTsKCiAgICAgICAgdGhpcy5zdGF0ZS50b3VjaGFibGUudG91Y2hTdGF0ZSA9IG5leHRTdGF0ZTsKICAgICAgfQogICAgfSwKICAgIF9jYW5jZWxMb25nUHJlc3NEZWxheVRpbWVvdXQ6IGZ1bmN0aW9uIF9jYW5jZWxMb25nUHJlc3NEZWxheVRpbWVvdXQoKSB7CiAgICAgIHRoaXMubG9uZ1ByZXNzRGVsYXlUaW1lb3V0ICYmIGNsZWFyVGltZW91dCh0aGlzLmxvbmdQcmVzc0RlbGF5VGltZW91dCk7CiAgICAgIHRoaXMubG9uZ1ByZXNzRGVsYXlUaW1lb3V0ID0gbnVsbDsKICAgIH0sCiAgICBfaXNIaWdobGlnaHQ6IGZ1bmN0aW9uIF9pc0hpZ2hsaWdodChzdGF0ZSkgewogICAgICByZXR1cm4gc3RhdGUgPT09IFN0YXRlcy5SRVNQT05ERVJfQUNUSVZFX1BSRVNTX0lOIHx8IHN0YXRlID09PSBTdGF0ZXMuUkVTUE9OREVSX0FDVElWRV9MT05HX1BSRVNTX0lOOwogICAgfSwKICAgIF9zYXZlUHJlc3NJbkxvY2F0aW9uOiBmdW5jdGlvbiBfc2F2ZVByZXNzSW5Mb2NhdGlvbihlKSB7CiAgICAgIHZhciB0b3VjaCA9IFRvdWNoRXZlbnRVdGlscy5leHRyYWN0U2luZ2xlVG91Y2goZS5uYXRpdmVFdmVudCk7CiAgICAgIHZhciBwYWdlWCA9IHRvdWNoICYmIHRvdWNoLnBhZ2VYOwogICAgICB2YXIgcGFnZVkgPSB0b3VjaCAmJiB0b3VjaC5wYWdlWTsKICAgICAgdmFyIGxvY2F0aW9uWCA9IHRvdWNoICYmIHRvdWNoLmxvY2F0aW9uWDsKICAgICAgdmFyIGxvY2F0aW9uWSA9IHRvdWNoICYmIHRvdWNoLmxvY2F0aW9uWTsKICAgICAgdGhpcy5wcmVzc0luTG9jYXRpb24gPSB7CiAgICAgICAgcGFnZVg6IHBhZ2VYLAogICAgICAgIHBhZ2VZOiBwYWdlWSwKICAgICAgICBsb2NhdGlvblg6IGxvY2F0aW9uWCwKICAgICAgICBsb2NhdGlvblk6IGxvY2F0aW9uWQogICAgICB9OwogICAgfSwKICAgIF9nZXREaXN0YW5jZUJldHdlZW5Qb2ludHM6IGZ1bmN0aW9uIF9nZXREaXN0YW5jZUJldHdlZW5Qb2ludHMoYVgsIGFZLCBiWCwgYlkpIHsKICAgICAgdmFyIGRlbHRhWCA9IGFYIC0gYlg7CiAgICAgIHZhciBkZWx0YVkgPSBhWSAtIGJZOwogICAgICByZXR1cm4gTWF0aC5zcXJ0KGRlbHRhWCAqIGRlbHRhWCArIGRlbHRhWSAqIGRlbHRhWSk7CiAgICB9LAogICAgX3BlcmZvcm1TaWRlRWZmZWN0c0ZvclRyYW5zaXRpb246IGZ1bmN0aW9uIF9wZXJmb3JtU2lkZUVmZmVjdHNGb3JUcmFuc2l0aW9uKGN1clN0YXRlLCBuZXh0U3RhdGUsIHNpZ25hbCwgZSkgewogICAgICB2YXIgY3VySXNIaWdobGlnaHQgPSB0aGlzLl9pc0hpZ2hsaWdodChjdXJTdGF0ZSk7CgogICAgICB2YXIgbmV3SXNIaWdobGlnaHQgPSB0aGlzLl9pc0hpZ2hsaWdodChuZXh0U3RhdGUpOwoKICAgICAgdmFyIGlzRmluYWxTaWduYWwgPSBzaWduYWwgPT09IFNpZ25hbHMuUkVTUE9OREVSX1RFUk1JTkFURUQgfHwgc2lnbmFsID09PSBTaWduYWxzLlJFU1BPTkRFUl9SRUxFQVNFOwoKICAgICAgaWYgKGlzRmluYWxTaWduYWwpIHsKICAgICAgICB0aGlzLl9jYW5jZWxMb25nUHJlc3NEZWxheVRpbWVvdXQoKTsKICAgICAgfQoKICAgICAgaWYgKCFJc0FjdGl2ZVtjdXJTdGF0ZV0gJiYgSXNBY3RpdmVbbmV4dFN0YXRlXSkgewogICAgICAgIHRoaXMuX3JlbWVhc3VyZU1ldHJpY3NPbkFjdGl2YXRpb24oKTsKICAgICAgfQoKICAgICAgaWYgKElzUHJlc3NpbmdJbltjdXJTdGF0ZV0gJiYgc2lnbmFsID09PSBTaWduYWxzLkxPTkdfUFJFU1NfREVURUNURUQpIHsKICAgICAgICB0aGlzLnRvdWNoYWJsZUhhbmRsZUxvbmdQcmVzcyAmJiB0aGlzLnRvdWNoYWJsZUhhbmRsZUxvbmdQcmVzcyhlKTsKICAgICAgfQoKICAgICAgaWYgKG5ld0lzSGlnaGxpZ2h0ICYmICFjdXJJc0hpZ2hsaWdodCkgewogICAgICAgIHRoaXMuX3N0YXJ0SGlnaGxpZ2h0KGUpOwogICAgICB9IGVsc2UgaWYgKCFuZXdJc0hpZ2hsaWdodCAmJiBjdXJJc0hpZ2hsaWdodCkgewogICAgICAgIHRoaXMuX2VuZEhpZ2hsaWdodChlKTsKICAgICAgfQoKICAgICAgaWYgKElzUHJlc3NpbmdJbltjdXJTdGF0ZV0gJiYgc2lnbmFsID09PSBTaWduYWxzLlJFU1BPTkRFUl9SRUxFQVNFKSB7CiAgICAgICAgdmFyIGhhc0xvbmdQcmVzc0hhbmRsZXIgPSAhIXRoaXMucHJvcHMub25Mb25nUHJlc3M7CiAgICAgICAgdmFyIHByZXNzSXNMb25nQnV0U3RpbGxDYWxsT25QcmVzcyA9IElzTG9uZ1ByZXNzaW5nSW5bY3VyU3RhdGVdICYmICghaGFzTG9uZ1ByZXNzSGFuZGxlciB8fCAhdGhpcy50b3VjaGFibGVMb25nUHJlc3NDYW5jZWxzUHJlc3MoKSk7CiAgICAgICAgdmFyIHNob3VsZEludm9rZVByZXNzID0gIUlzTG9uZ1ByZXNzaW5nSW5bY3VyU3RhdGVdIHx8IHByZXNzSXNMb25nQnV0U3RpbGxDYWxsT25QcmVzczsKCiAgICAgICAgaWYgKHNob3VsZEludm9rZVByZXNzICYmIHRoaXMudG91Y2hhYmxlSGFuZGxlUHJlc3MpIHsKICAgICAgICAgIGlmICghbmV3SXNIaWdobGlnaHQgJiYgIWN1cklzSGlnaGxpZ2h0KSB7CiAgICAgICAgICAgIHRoaXMuX3N0YXJ0SGlnaGxpZ2h0KGUpOwoKICAgICAgICAgICAgdGhpcy5fZW5kSGlnaGxpZ2h0KGUpOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMudG91Y2hhYmxlSGFuZGxlUHJlc3MoZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnRvdWNoYWJsZURlbGF5VGltZW91dCAmJiBjbGVhclRpbWVvdXQodGhpcy50b3VjaGFibGVEZWxheVRpbWVvdXQpOwogICAgICB0aGlzLnRvdWNoYWJsZURlbGF5VGltZW91dCA9IG51bGw7CiAgICB9LAogICAgX3N0YXJ0SGlnaGxpZ2h0OiBmdW5jdGlvbiBfc3RhcnRIaWdobGlnaHQoZSkgewogICAgICB0aGlzLl9zYXZlUHJlc3NJbkxvY2F0aW9uKGUpOwoKICAgICAgdGhpcy50b3VjaGFibGVIYW5kbGVBY3RpdmVQcmVzc0luICYmIHRoaXMudG91Y2hhYmxlSGFuZGxlQWN0aXZlUHJlc3NJbihlKTsKICAgIH0sCiAgICBfZW5kSGlnaGxpZ2h0OiBmdW5jdGlvbiBfZW5kSGlnaGxpZ2h0KGUpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGlmICh0aGlzLnRvdWNoYWJsZUhhbmRsZUFjdGl2ZVByZXNzT3V0KSB7CiAgICAgICAgaWYgKHRoaXMudG91Y2hhYmxlR2V0UHJlc3NPdXREZWxheU1TICYmIHRoaXMudG91Y2hhYmxlR2V0UHJlc3NPdXREZWxheU1TKCkpIHsKICAgICAgICAgIHRoaXMucHJlc3NPdXREZWxheVRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgX3RoaXMudG91Y2hhYmxlSGFuZGxlQWN0aXZlUHJlc3NPdXQoZSk7CiAgICAgICAgICB9LCB0aGlzLnRvdWNoYWJsZUdldFByZXNzT3V0RGVsYXlNUygpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy50b3VjaGFibGVIYW5kbGVBY3RpdmVQcmVzc091dChlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwogIHZhciBUb3VjaGFibGUgPSB7CiAgICBNaXhpbjogVG91Y2hhYmxlTWl4aW4sCiAgICBUT1VDSF9UQVJHRVRfREVCVUc6IGZhbHNlLAogICAgcmVuZGVyRGVidWdWaWV3OiBmdW5jdGlvbiByZW5kZXJEZWJ1Z1ZpZXcoX3JlZikgewogICAgICB2YXIgY29sb3IgPSBfcmVmLmNvbG9yLAogICAgICAgICAgaGl0U2xvcCA9IF9yZWYuaGl0U2xvcDsKCiAgICAgIGlmICghVG91Y2hhYmxlLlRPVUNIX1RBUkdFVF9ERUJVRykgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICBpZiAoIV9fREVWX18pIHsKICAgICAgICB0aHJvdyBFcnJvcignVG91Y2hhYmxlLlRPVUNIX1RBUkdFVF9ERUJVRyBzaG91bGQgbm90IGJlIGVuYWJsZWQgaW4gcHJvZCEnKTsKICAgICAgfQoKICAgICAgdmFyIGRlYnVnSGl0U2xvcFN0eWxlID0ge307CiAgICAgIGhpdFNsb3AgPSBoaXRTbG9wIHx8IHsKICAgICAgICB0b3A6IDAsCiAgICAgICAgYm90dG9tOiAwLAogICAgICAgIGxlZnQ6IDAsCiAgICAgICAgcmlnaHQ6IDAKICAgICAgfTsKCiAgICAgIGZvciAodmFyIGtleSBpbiBoaXRTbG9wKSB7CiAgICAgICAgZGVidWdIaXRTbG9wU3R5bGVba2V5XSA9IC1oaXRTbG9wW2tleV07CiAgICAgIH0KCiAgICAgIHZhciBoZXhDb2xvciA9ICcjJyArICgnMDAwMDAwMDAnICsgbm9ybWFsaXplQ29sb3IoY29sb3IpLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC04KTsKICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoVmlldywgewogICAgICAgIHBvaW50ZXJFdmVudHM6ICJub25lIiwKICAgICAgICBzdHlsZTogYmFiZWxIZWxwZXJzLmV4dGVuZHMoewogICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAgICAgICAgICBib3JkZXJDb2xvcjogaGV4Q29sb3Iuc2xpY2UoMCwgLTIpICsgJzU1JywKICAgICAgICAgIGJvcmRlcldpZHRoOiAxLAogICAgICAgICAgYm9yZGVyU3R5bGU6ICdkYXNoZWQnLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBoZXhDb2xvci5zbGljZSgwLCAtMikgKyAnMEYnCiAgICAgICAgfSwgZGVidWdIaXRTbG9wU3R5bGUpLAogICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgbGluZU51bWJlcjogNzkzCiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwogIG1vZHVsZS5leHBvcnRzID0gVG91Y2hhYmxlOwp9LDE4MixbMTgzLDUyLDE4NSwxMzAsMjEsMTg2LDE4NywxMDcsMTcwLDE1MCwxMjRdLCJUb3VjaGFibGUiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBQb29sZWRDbGFzcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJQb29sZWRDbGFzcyIpOwoKICB2YXIgdHdvQXJndW1lbnRQb29sZXIgPSBQb29sZWRDbGFzcy50d29Bcmd1bWVudFBvb2xlcjsKCiAgZnVuY3Rpb24gQm91bmRpbmdEaW1lbnNpb25zKHdpZHRoLCBoZWlnaHQpIHsKICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwogIH0KCiAgQm91bmRpbmdEaW1lbnNpb25zLnByb3RvdHlwZS5kZXN0cnVjdG9yID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy53aWR0aCA9IG51bGw7CiAgICB0aGlzLmhlaWdodCA9IG51bGw7CiAgfTsKCiAgQm91bmRpbmdEaW1lbnNpb25zLmdldFBvb2xlZEZyb21FbGVtZW50ID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgIHJldHVybiBCb3VuZGluZ0RpbWVuc2lvbnMuZ2V0UG9vbGVkKGVsZW1lbnQub2Zmc2V0V2lkdGgsIGVsZW1lbnQub2Zmc2V0SGVpZ2h0KTsKICB9OwoKICBQb29sZWRDbGFzcy5hZGRQb29saW5nVG8oQm91bmRpbmdEaW1lbnNpb25zLCB0d29Bcmd1bWVudFBvb2xlcik7CiAgbW9kdWxlLmV4cG9ydHMgPSBCb3VuZGluZ0RpbWVuc2lvbnM7Cn0sMTgzLFsxODRdLCJCb3VuZGluZ0RpbWVuc2lvbnMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBvbmVBcmd1bWVudFBvb2xlciA9IGZ1bmN0aW9uIG9uZUFyZ3VtZW50UG9vbGVyKGNvcHlGaWVsZHNGcm9tKSB7CiAgICB2YXIgS2xhc3MgPSB0aGlzOwoKICAgIGlmIChLbGFzcy5pbnN0YW5jZVBvb2wubGVuZ3RoKSB7CiAgICAgIHZhciBpbnN0YW5jZSA9IEtsYXNzLmluc3RhbmNlUG9vbC5wb3AoKTsKICAgICAgS2xhc3MuY2FsbChpbnN0YW5jZSwgY29weUZpZWxkc0Zyb20pOwogICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IEtsYXNzKGNvcHlGaWVsZHNGcm9tKTsKICAgIH0KICB9OwoKICB2YXIgdHdvQXJndW1lbnRQb29sZXIgPSBmdW5jdGlvbiB0d29Bcmd1bWVudFBvb2xlcihhMSwgYTIpIHsKICAgIHZhciBLbGFzcyA9IHRoaXM7CgogICAgaWYgKEtsYXNzLmluc3RhbmNlUG9vbC5sZW5ndGgpIHsKICAgICAgdmFyIGluc3RhbmNlID0gS2xhc3MuaW5zdGFuY2VQb29sLnBvcCgpOwogICAgICBLbGFzcy5jYWxsKGluc3RhbmNlLCBhMSwgYTIpOwogICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IEtsYXNzKGExLCBhMik7CiAgICB9CiAgfTsKCiAgdmFyIHRocmVlQXJndW1lbnRQb29sZXIgPSBmdW5jdGlvbiB0aHJlZUFyZ3VtZW50UG9vbGVyKGExLCBhMiwgYTMpIHsKICAgIHZhciBLbGFzcyA9IHRoaXM7CgogICAgaWYgKEtsYXNzLmluc3RhbmNlUG9vbC5sZW5ndGgpIHsKICAgICAgdmFyIGluc3RhbmNlID0gS2xhc3MuaW5zdGFuY2VQb29sLnBvcCgpOwogICAgICBLbGFzcy5jYWxsKGluc3RhbmNlLCBhMSwgYTIsIGEzKTsKICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5ldyBLbGFzcyhhMSwgYTIsIGEzKTsKICAgIH0KICB9OwoKICB2YXIgZm91ckFyZ3VtZW50UG9vbGVyID0gZnVuY3Rpb24gZm91ckFyZ3VtZW50UG9vbGVyKGExLCBhMiwgYTMsIGE0KSB7CiAgICB2YXIgS2xhc3MgPSB0aGlzOwoKICAgIGlmIChLbGFzcy5pbnN0YW5jZVBvb2wubGVuZ3RoKSB7CiAgICAgIHZhciBpbnN0YW5jZSA9IEtsYXNzLmluc3RhbmNlUG9vbC5wb3AoKTsKICAgICAgS2xhc3MuY2FsbChpbnN0YW5jZSwgYTEsIGEyLCBhMywgYTQpOwogICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IEtsYXNzKGExLCBhMiwgYTMsIGE0KTsKICAgIH0KICB9OwoKICB2YXIgc3RhbmRhcmRSZWxlYXNlciA9IGZ1bmN0aW9uIHN0YW5kYXJkUmVsZWFzZXIoaW5zdGFuY2UpIHsKICAgIHZhciBLbGFzcyA9IHRoaXM7CiAgICBpbnZhcmlhbnQoaW5zdGFuY2UgaW5zdGFuY2VvZiBLbGFzcywgJ1RyeWluZyB0byByZWxlYXNlIGFuIGluc3RhbmNlIGludG8gYSBwb29sIG9mIGEgZGlmZmVyZW50IHR5cGUuJyk7CiAgICBpbnN0YW5jZS5kZXN0cnVjdG9yKCk7CgogICAgaWYgKEtsYXNzLmluc3RhbmNlUG9vbC5sZW5ndGggPCBLbGFzcy5wb29sU2l6ZSkgewogICAgICBLbGFzcy5pbnN0YW5jZVBvb2wucHVzaChpbnN0YW5jZSk7CiAgICB9CiAgfTsKCiAgdmFyIERFRkFVTFRfUE9PTF9TSVpFID0gMTA7CiAgdmFyIERFRkFVTFRfUE9PTEVSID0gb25lQXJndW1lbnRQb29sZXI7CgogIHZhciBhZGRQb29saW5nVG8gPSBmdW5jdGlvbiBhZGRQb29saW5nVG8oQ29weUNvbnN0cnVjdG9yLCBwb29sZXIpIHsKICAgIHZhciBOZXdLbGFzcyA9IENvcHlDb25zdHJ1Y3RvcjsKICAgIE5ld0tsYXNzLmluc3RhbmNlUG9vbCA9IFtdOwogICAgTmV3S2xhc3MuZ2V0UG9vbGVkID0gcG9vbGVyIHx8IERFRkFVTFRfUE9PTEVSOwoKICAgIGlmICghTmV3S2xhc3MucG9vbFNpemUpIHsKICAgICAgTmV3S2xhc3MucG9vbFNpemUgPSBERUZBVUxUX1BPT0xfU0laRTsKICAgIH0KCiAgICBOZXdLbGFzcy5yZWxlYXNlID0gc3RhbmRhcmRSZWxlYXNlcjsKICAgIHJldHVybiBOZXdLbGFzczsKICB9OwoKICB2YXIgUG9vbGVkQ2xhc3MgPSB7CiAgICBhZGRQb29saW5nVG86IGFkZFBvb2xpbmdUbywKICAgIG9uZUFyZ3VtZW50UG9vbGVyOiBvbmVBcmd1bWVudFBvb2xlciwKICAgIHR3b0FyZ3VtZW50UG9vbGVyOiB0d29Bcmd1bWVudFBvb2xlciwKICAgIHRocmVlQXJndW1lbnRQb29sZXI6IHRocmVlQXJndW1lbnRQb29sZXIsCiAgICBmb3VyQXJndW1lbnRQb29sZXI6IGZvdXJBcmd1bWVudFBvb2xlcgogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBQb29sZWRDbGFzczsKfSwxODQsWzEzXSwiUG9vbGVkQ2xhc3MiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBQb29sZWRDbGFzcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJQb29sZWRDbGFzcyIpOwoKICB2YXIgdHdvQXJndW1lbnRQb29sZXIgPSBQb29sZWRDbGFzcy50d29Bcmd1bWVudFBvb2xlcjsKCiAgZnVuY3Rpb24gUG9zaXRpb24obGVmdCwgdG9wKSB7CiAgICB0aGlzLmxlZnQgPSBsZWZ0OwogICAgdGhpcy50b3AgPSB0b3A7CiAgfQoKICBQb3NpdGlvbi5wcm90b3R5cGUuZGVzdHJ1Y3RvciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMubGVmdCA9IG51bGw7CiAgICB0aGlzLnRvcCA9IG51bGw7CiAgfTsKCiAgUG9vbGVkQ2xhc3MuYWRkUG9vbGluZ1RvKFBvc2l0aW9uLCB0d29Bcmd1bWVudFBvb2xlcik7CiAgbW9kdWxlLmV4cG9ydHMgPSBQb3NpdGlvbjsKfSwxODUsWzE4NF0sIlBvc2l0aW9uIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBUVkV2ZW50SGFuZGxlcigpIHt9CgogIFRWRXZlbnRIYW5kbGVyLnByb3RvdHlwZS5lbmFibGUgPSBmdW5jdGlvbiAoY29tcG9uZW50LCBjYWxsYmFjaykge307CgogIFRWRXZlbnRIYW5kbGVyLnByb3RvdHlwZS5kaXNhYmxlID0gZnVuY3Rpb24gKCkge307CgogIG1vZHVsZS5leHBvcnRzID0gVFZFdmVudEhhbmRsZXI7Cn0sMTg2LFtdLCJUVkV2ZW50SGFuZGxlciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIFRvdWNoRXZlbnRVdGlscyA9IHsKICAgIGV4dHJhY3RTaW5nbGVUb3VjaDogZnVuY3Rpb24gZXh0cmFjdFNpbmdsZVRvdWNoKG5hdGl2ZUV2ZW50KSB7CiAgICAgIHZhciB0b3VjaGVzID0gbmF0aXZlRXZlbnQudG91Y2hlczsKICAgICAgdmFyIGNoYW5nZWRUb3VjaGVzID0gbmF0aXZlRXZlbnQuY2hhbmdlZFRvdWNoZXM7CiAgICAgIHZhciBoYXNUb3VjaGVzID0gdG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCA+IDA7CiAgICAgIHZhciBoYXNDaGFuZ2VkVG91Y2hlcyA9IGNoYW5nZWRUb3VjaGVzICYmIGNoYW5nZWRUb3VjaGVzLmxlbmd0aCA+IDA7CiAgICAgIHJldHVybiAhaGFzVG91Y2hlcyAmJiBoYXNDaGFuZ2VkVG91Y2hlcyA/IGNoYW5nZWRUb3VjaGVzWzBdIDogaGFzVG91Y2hlcyA/IHRvdWNoZXNbMF0gOiBuYXRpdmVFdmVudDsKICAgIH0KICB9OwogIG1vZHVsZS5leHBvcnRzID0gVG91Y2hFdmVudFV0aWxzOwp9LDE4NyxbXSwiZmJqcy9saWIvVG91Y2hFdmVudFV0aWxzLmpzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgbWVyZ2VGYXN0ID0gZnVuY3Rpb24gbWVyZ2VGYXN0KG9uZSwgdHdvKSB7CiAgICB2YXIgcmV0ID0ge307CgogICAgZm9yICh2YXIga2V5T25lIGluIG9uZSkgewogICAgICByZXRba2V5T25lXSA9IG9uZVtrZXlPbmVdOwogICAgfQoKICAgIGZvciAodmFyIGtleVR3byBpbiB0d28pIHsKICAgICAgcmV0W2tleVR3b10gPSB0d29ba2V5VHdvXTsKICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH07CgogIG1vZHVsZS5leHBvcnRzID0gbWVyZ2VGYXN0Owp9LDE4OCxbXSwibWVyZ2VGYXN0Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgUGxhdGZvcm0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiUGxhdGZvcm0iKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlJlYWN0Iik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgUmVhY3ROYXRpdmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUmVhY3ROYXRpdmUiKTsKCiAgdmFyIFRvdWNoYWJsZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJUb3VjaGFibGUiKTsKCiAgdmFyIFRvdWNoYWJsZVdpdGhvdXRGZWVkYmFjayA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJUb3VjaGFibGVXaXRob3V0RmVlZGJhY2siKTsKCiAgdmFyIFVJTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJVSU1hbmFnZXIiKTsKCiAgdmFyIGNyZWF0ZVJlYWN0Q2xhc3MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiY3JlYXRlLXJlYWN0LWNsYXNzIik7CgogIHZhciBlbnN1cmVQb3NpdGl2ZURlbGF5UHJvcHMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAiZW5zdXJlUG9zaXRpdmVEZWxheVByb3BzIik7CgogIHZhciBwcm9jZXNzQ29sb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAicHJvY2Vzc0NvbG9yIik7CgogIHZhciByaXBwbGVCYWNrZ3JvdW5kUHJvcFR5cGUgPSBQcm9wVHlwZXMuc2hhcGUoewogICAgdHlwZTogUHJvcFR5cGVzLm9uZU9mKFsnUmlwcGxlQW5kcm9pZCddKSwKICAgIGNvbG9yOiBQcm9wVHlwZXMubnVtYmVyLAogICAgYm9yZGVybGVzczogUHJvcFR5cGVzLmJvb2wKICB9KTsKICB2YXIgdGhlbWVBdHRyaWJ1dGVCYWNrZ3JvdW5kUHJvcFR5cGUgPSBQcm9wVHlwZXMuc2hhcGUoewogICAgdHlwZTogUHJvcFR5cGVzLm9uZU9mKFsnVGhlbWVBdHRyQW5kcm9pZCddKSwKICAgIGF0dHJpYnV0ZTogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkCiAgfSk7CiAgdmFyIGJhY2tncm91bmRQcm9wVHlwZSA9IFByb3BUeXBlcy5vbmVPZlR5cGUoW3JpcHBsZUJhY2tncm91bmRQcm9wVHlwZSwgdGhlbWVBdHRyaWJ1dGVCYWNrZ3JvdW5kUHJvcFR5cGVdKTsKICB2YXIgUFJFU1NfUkVURU5USU9OX09GRlNFVCA9IHsKICAgIHRvcDogMjAsCiAgICBsZWZ0OiAyMCwKICAgIHJpZ2h0OiAyMCwKICAgIGJvdHRvbTogMzAKICB9OwogIHZhciBUb3VjaGFibGVOYXRpdmVGZWVkYmFjayA9IGNyZWF0ZVJlYWN0Q2xhc3MoewogICAgZGlzcGxheU5hbWU6ICdUb3VjaGFibGVOYXRpdmVGZWVkYmFjaycsCiAgICBwcm9wVHlwZXM6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBUb3VjaGFibGVXaXRob3V0RmVlZGJhY2sucHJvcFR5cGVzLCB7CiAgICAgIGJhY2tncm91bmQ6IGJhY2tncm91bmRQcm9wVHlwZSwKICAgICAgdXNlRm9yZWdyb3VuZDogUHJvcFR5cGVzLmJvb2wKICAgIH0pLAogICAgc3RhdGljczogewogICAgICBTZWxlY3RhYmxlQmFja2dyb3VuZDogZnVuY3Rpb24gU2VsZWN0YWJsZUJhY2tncm91bmQoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICdUaGVtZUF0dHJBbmRyb2lkJywKICAgICAgICAgIGF0dHJpYnV0ZTogJ3NlbGVjdGFibGVJdGVtQmFja2dyb3VuZCcKICAgICAgICB9OwogICAgICB9LAogICAgICBTZWxlY3RhYmxlQmFja2dyb3VuZEJvcmRlcmxlc3M6IGZ1bmN0aW9uIFNlbGVjdGFibGVCYWNrZ3JvdW5kQm9yZGVybGVzcygpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogJ1RoZW1lQXR0ckFuZHJvaWQnLAogICAgICAgICAgYXR0cmlidXRlOiAnc2VsZWN0YWJsZUl0ZW1CYWNrZ3JvdW5kQm9yZGVybGVzcycKICAgICAgICB9OwogICAgICB9LAogICAgICBSaXBwbGU6IGZ1bmN0aW9uIFJpcHBsZShjb2xvciwgYm9yZGVybGVzcykgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAnUmlwcGxlQW5kcm9pZCcsCiAgICAgICAgICBjb2xvcjogcHJvY2Vzc0NvbG9yKGNvbG9yKSwKICAgICAgICAgIGJvcmRlcmxlc3M6IGJvcmRlcmxlc3MKICAgICAgICB9OwogICAgICB9LAogICAgICBjYW5Vc2VOYXRpdmVGb3JlZ3JvdW5kOiBmdW5jdGlvbiBjYW5Vc2VOYXRpdmVGb3JlZ3JvdW5kKCkgewogICAgICAgIHJldHVybiBQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnICYmIFBsYXRmb3JtLlZlcnNpb24gPj0gMjM7CiAgICAgIH0KICAgIH0sCiAgICBtaXhpbnM6IFtUb3VjaGFibGUuTWl4aW5dLAogICAgZ2V0RGVmYXVsdFByb3BzOiBmdW5jdGlvbiBnZXREZWZhdWx0UHJvcHMoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgYmFja2dyb3VuZDogdGhpcy5TZWxlY3RhYmxlQmFja2dyb3VuZCgpCiAgICAgIH07CiAgICB9LAogICAgZ2V0SW5pdGlhbFN0YXRlOiBmdW5jdGlvbiBnZXRJbml0aWFsU3RhdGUoKSB7CiAgICAgIHJldHVybiB0aGlzLnRvdWNoYWJsZUdldEluaXRpYWxTdGF0ZSgpOwogICAgfSwKICAgIGNvbXBvbmVudERpZE1vdW50OiBmdW5jdGlvbiBjb21wb25lbnREaWRNb3VudCgpIHsKICAgICAgZW5zdXJlUG9zaXRpdmVEZWxheVByb3BzKHRoaXMucHJvcHMpOwogICAgfSwKICAgIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHM6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzKSB7CiAgICAgIGVuc3VyZVBvc2l0aXZlRGVsYXlQcm9wcyhuZXh0UHJvcHMpOwogICAgfSwKICAgIHRvdWNoYWJsZUhhbmRsZUFjdGl2ZVByZXNzSW46IGZ1bmN0aW9uIHRvdWNoYWJsZUhhbmRsZUFjdGl2ZVByZXNzSW4oZSkgewogICAgICB0aGlzLnByb3BzLm9uUHJlc3NJbiAmJiB0aGlzLnByb3BzLm9uUHJlc3NJbihlKTsKCiAgICAgIHRoaXMuX2Rpc3BhdGNoUHJlc3NlZFN0YXRlQ2hhbmdlKHRydWUpOwoKICAgICAgdGhpcy5fZGlzcGF0Y2hIb3RzcG90VXBkYXRlKHRoaXMucHJlc3NJbkxvY2F0aW9uLmxvY2F0aW9uWCwgdGhpcy5wcmVzc0luTG9jYXRpb24ubG9jYXRpb25ZKTsKICAgIH0sCiAgICB0b3VjaGFibGVIYW5kbGVBY3RpdmVQcmVzc091dDogZnVuY3Rpb24gdG91Y2hhYmxlSGFuZGxlQWN0aXZlUHJlc3NPdXQoZSkgewogICAgICB0aGlzLnByb3BzLm9uUHJlc3NPdXQgJiYgdGhpcy5wcm9wcy5vblByZXNzT3V0KGUpOwoKICAgICAgdGhpcy5fZGlzcGF0Y2hQcmVzc2VkU3RhdGVDaGFuZ2UoZmFsc2UpOwogICAgfSwKICAgIHRvdWNoYWJsZUhhbmRsZVByZXNzOiBmdW5jdGlvbiB0b3VjaGFibGVIYW5kbGVQcmVzcyhlKSB7CiAgICAgIHRoaXMucHJvcHMub25QcmVzcyAmJiB0aGlzLnByb3BzLm9uUHJlc3MoZSk7CiAgICB9LAogICAgdG91Y2hhYmxlSGFuZGxlTG9uZ1ByZXNzOiBmdW5jdGlvbiB0b3VjaGFibGVIYW5kbGVMb25nUHJlc3MoZSkgewogICAgICB0aGlzLnByb3BzLm9uTG9uZ1ByZXNzICYmIHRoaXMucHJvcHMub25Mb25nUHJlc3MoZSk7CiAgICB9LAogICAgdG91Y2hhYmxlR2V0UHJlc3NSZWN0T2Zmc2V0OiBmdW5jdGlvbiB0b3VjaGFibGVHZXRQcmVzc1JlY3RPZmZzZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLnByb3BzLnByZXNzUmV0ZW50aW9uT2Zmc2V0IHx8IFBSRVNTX1JFVEVOVElPTl9PRkZTRVQ7CiAgICB9LAogICAgdG91Y2hhYmxlR2V0SGl0U2xvcDogZnVuY3Rpb24gdG91Y2hhYmxlR2V0SGl0U2xvcCgpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvcHMuaGl0U2xvcDsKICAgIH0sCiAgICB0b3VjaGFibGVHZXRIaWdobGlnaHREZWxheU1TOiBmdW5jdGlvbiB0b3VjaGFibGVHZXRIaWdobGlnaHREZWxheU1TKCkgewogICAgICByZXR1cm4gdGhpcy5wcm9wcy5kZWxheVByZXNzSW47CiAgICB9LAogICAgdG91Y2hhYmxlR2V0TG9uZ1ByZXNzRGVsYXlNUzogZnVuY3Rpb24gdG91Y2hhYmxlR2V0TG9uZ1ByZXNzRGVsYXlNUygpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvcHMuZGVsYXlMb25nUHJlc3M7CiAgICB9LAogICAgdG91Y2hhYmxlR2V0UHJlc3NPdXREZWxheU1TOiBmdW5jdGlvbiB0b3VjaGFibGVHZXRQcmVzc091dERlbGF5TVMoKSB7CiAgICAgIHJldHVybiB0aGlzLnByb3BzLmRlbGF5UHJlc3NPdXQ7CiAgICB9LAogICAgX2hhbmRsZVJlc3BvbmRlck1vdmU6IGZ1bmN0aW9uIF9oYW5kbGVSZXNwb25kZXJNb3ZlKGUpIHsKICAgICAgdGhpcy50b3VjaGFibGVIYW5kbGVSZXNwb25kZXJNb3ZlKGUpOwoKICAgICAgdGhpcy5fZGlzcGF0Y2hIb3RzcG90VXBkYXRlKGUubmF0aXZlRXZlbnQubG9jYXRpb25YLCBlLm5hdGl2ZUV2ZW50LmxvY2F0aW9uWSk7CiAgICB9LAogICAgX2Rpc3BhdGNoSG90c3BvdFVwZGF0ZTogZnVuY3Rpb24gX2Rpc3BhdGNoSG90c3BvdFVwZGF0ZShkZXN0WCwgZGVzdFkpIHsKICAgICAgVUlNYW5hZ2VyLmRpc3BhdGNoVmlld01hbmFnZXJDb21tYW5kKFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKHRoaXMpLCBVSU1hbmFnZXIuUkNUVmlldy5Db21tYW5kcy5ob3RzcG90VXBkYXRlLCBbZGVzdFggfHwgMCwgZGVzdFkgfHwgMF0pOwogICAgfSwKICAgIF9kaXNwYXRjaFByZXNzZWRTdGF0ZUNoYW5nZTogZnVuY3Rpb24gX2Rpc3BhdGNoUHJlc3NlZFN0YXRlQ2hhbmdlKHByZXNzZWQpIHsKICAgICAgVUlNYW5hZ2VyLmRpc3BhdGNoVmlld01hbmFnZXJDb21tYW5kKFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKHRoaXMpLCBVSU1hbmFnZXIuUkNUVmlldy5Db21tYW5kcy5zZXRQcmVzc2VkLCBbcHJlc3NlZF0pOwogICAgfSwKICAgIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICB2YXIgX2JhYmVsSGVscGVycyRleHRlbmRzOwoKICAgICAgdmFyIGNoaWxkID0gUmVhY3QuQ2hpbGRyZW4ub25seSh0aGlzLnByb3BzLmNoaWxkcmVuKTsKICAgICAgdmFyIGNoaWxkcmVuID0gY2hpbGQucHJvcHMuY2hpbGRyZW47CgogICAgICBpZiAoVG91Y2hhYmxlLlRPVUNIX1RBUkdFVF9ERUJVRyAmJiBjaGlsZC50eXBlLmRpc3BsYXlOYW1lID09PSAnVmlldycpIHsKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoY2hpbGRyZW4pKSB7CiAgICAgICAgICBjaGlsZHJlbiA9IFtjaGlsZHJlbl07CiAgICAgICAgfQoKICAgICAgICBjaGlsZHJlbi5wdXNoKFRvdWNoYWJsZS5yZW5kZXJEZWJ1Z1ZpZXcoewogICAgICAgICAgY29sb3I6ICdicm93bicsCiAgICAgICAgICBoaXRTbG9wOiB0aGlzLnByb3BzLmhpdFNsb3AKICAgICAgICB9KSk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnByb3BzLnVzZUZvcmVncm91bmQgJiYgIVRvdWNoYWJsZU5hdGl2ZUZlZWRiYWNrLmNhblVzZU5hdGl2ZUZvcmVncm91bmQoKSkgewogICAgICAgIGNvbnNvbGUud2FybignUmVxdWVzdGVkIGZvcmVncm91bmQgcmlwcGxlLCBidXQgaXQgaXMgbm90IGF2YWlsYWJsZSBvbiB0aGlzIHZlcnNpb24gb2YgQW5kcm9pZC4gJyArICdDb25zaWRlciBjYWxsaW5nIFRvdWNoYWJsZU5hdGl2ZUZlZWRiYWNrLmNhblVzZU5hdGl2ZUZvcmVncm91bmQoKSBhbmQgdXNpbmcgYSBkaWZmZXJlbnQgJyArICdUb3VjaGFibGUgaWYgdGhlIHJlc3VsdCBpcyBmYWxzZS4nKTsKICAgICAgfQoKICAgICAgdmFyIGRyYXdhYmxlUHJvcCA9IHRoaXMucHJvcHMudXNlRm9yZWdyb3VuZCAmJiBUb3VjaGFibGVOYXRpdmVGZWVkYmFjay5jYW5Vc2VOYXRpdmVGb3JlZ3JvdW5kKCkgPyAnbmF0aXZlRm9yZWdyb3VuZEFuZHJvaWQnIDogJ25hdGl2ZUJhY2tncm91bmRBbmRyb2lkJzsKICAgICAgdmFyIGNoaWxkUHJvcHMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgY2hpbGQucHJvcHMsIChfYmFiZWxIZWxwZXJzJGV4dGVuZHMgPSB7fSwgYmFiZWxIZWxwZXJzLmRlZmluZVByb3BlcnR5KF9iYWJlbEhlbHBlcnMkZXh0ZW5kcywgZHJhd2FibGVQcm9wLCB0aGlzLnByb3BzLmJhY2tncm91bmQpLCBiYWJlbEhlbHBlcnMuZGVmaW5lUHJvcGVydHkoX2JhYmVsSGVscGVycyRleHRlbmRzLCAiYWNjZXNzaWJsZSIsIHRoaXMucHJvcHMuYWNjZXNzaWJsZSAhPT0gZmFsc2UpLCBiYWJlbEhlbHBlcnMuZGVmaW5lUHJvcGVydHkoX2JhYmVsSGVscGVycyRleHRlbmRzLCAiYWNjZXNzaWJpbGl0eUxhYmVsIiwgdGhpcy5wcm9wcy5hY2Nlc3NpYmlsaXR5TGFiZWwpLCBiYWJlbEhlbHBlcnMuZGVmaW5lUHJvcGVydHkoX2JhYmVsSGVscGVycyRleHRlbmRzLCAiYWNjZXNzaWJpbGl0eUNvbXBvbmVudFR5cGUiLCB0aGlzLnByb3BzLmFjY2Vzc2liaWxpdHlDb21wb25lbnRUeXBlKSwgYmFiZWxIZWxwZXJzLmRlZmluZVByb3BlcnR5KF9iYWJlbEhlbHBlcnMkZXh0ZW5kcywgImFjY2Vzc2liaWxpdHlUcmFpdHMiLCB0aGlzLnByb3BzLmFjY2Vzc2liaWxpdHlUcmFpdHMpLCBiYWJlbEhlbHBlcnMuZGVmaW5lUHJvcGVydHkoX2JhYmVsSGVscGVycyRleHRlbmRzLCAiY2hpbGRyZW4iLCBjaGlsZHJlbiksIGJhYmVsSGVscGVycy5kZWZpbmVQcm9wZXJ0eShfYmFiZWxIZWxwZXJzJGV4dGVuZHMsICJ0ZXN0SUQiLCB0aGlzLnByb3BzLnRlc3RJRCksIGJhYmVsSGVscGVycy5kZWZpbmVQcm9wZXJ0eShfYmFiZWxIZWxwZXJzJGV4dGVuZHMsICJvbkxheW91dCIsIHRoaXMucHJvcHMub25MYXlvdXQpLCBiYWJlbEhlbHBlcnMuZGVmaW5lUHJvcGVydHkoX2JhYmVsSGVscGVycyRleHRlbmRzLCAiaGl0U2xvcCIsIHRoaXMucHJvcHMuaGl0U2xvcCksIGJhYmVsSGVscGVycy5kZWZpbmVQcm9wZXJ0eShfYmFiZWxIZWxwZXJzJGV4dGVuZHMsICJvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyIiwgdGhpcy50b3VjaGFibGVIYW5kbGVTdGFydFNob3VsZFNldFJlc3BvbmRlciksIGJhYmVsSGVscGVycy5kZWZpbmVQcm9wZXJ0eShfYmFiZWxIZWxwZXJzJGV4dGVuZHMsICJvblJlc3BvbmRlclRlcm1pbmF0aW9uUmVxdWVzdCIsIHRoaXMudG91Y2hhYmxlSGFuZGxlUmVzcG9uZGVyVGVybWluYXRpb25SZXF1ZXN0KSwgYmFiZWxIZWxwZXJzLmRlZmluZVByb3BlcnR5KF9iYWJlbEhlbHBlcnMkZXh0ZW5kcywgIm9uUmVzcG9uZGVyR3JhbnQiLCB0aGlzLnRvdWNoYWJsZUhhbmRsZVJlc3BvbmRlckdyYW50KSwgYmFiZWxIZWxwZXJzLmRlZmluZVByb3BlcnR5KF9iYWJlbEhlbHBlcnMkZXh0ZW5kcywgIm9uUmVzcG9uZGVyTW92ZSIsIHRoaXMuX2hhbmRsZVJlc3BvbmRlck1vdmUpLCBiYWJlbEhlbHBlcnMuZGVmaW5lUHJvcGVydHkoX2JhYmVsSGVscGVycyRleHRlbmRzLCAib25SZXNwb25kZXJSZWxlYXNlIiwgdGhpcy50b3VjaGFibGVIYW5kbGVSZXNwb25kZXJSZWxlYXNlKSwgYmFiZWxIZWxwZXJzLmRlZmluZVByb3BlcnR5KF9iYWJlbEhlbHBlcnMkZXh0ZW5kcywgIm9uUmVzcG9uZGVyVGVybWluYXRlIiwgdGhpcy50b3VjaGFibGVIYW5kbGVSZXNwb25kZXJUZXJtaW5hdGUpLCBfYmFiZWxIZWxwZXJzJGV4dGVuZHMpKTsKICAgICAgcmV0dXJuIFJlYWN0LmNsb25lRWxlbWVudChjaGlsZCwgY2hpbGRQcm9wcyk7CiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBUb3VjaGFibGVOYXRpdmVGZWVkYmFjazsKfSwxODksWzUyLDEzMCwxMjcsMjEsMTgyLDE5MCwxMDcsMTcyLDE5MiwxNTJdLCJUb3VjaGFibGVOYXRpdmVGZWVkYmFjayIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEVkZ2VJbnNldHNQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJFZGdlSW5zZXRzUHJvcFR5cGUiKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlJlYWN0Iik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgVGltZXJNaXhpbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJyZWFjdC10aW1lci1taXhpbiIpOwoKICB2YXIgVG91Y2hhYmxlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlRvdWNoYWJsZSIpOwoKICB2YXIgY3JlYXRlUmVhY3RDbGFzcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJjcmVhdGUtcmVhY3QtY2xhc3MiKTsKCiAgdmFyIGVuc3VyZVBvc2l0aXZlRGVsYXlQcm9wcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJlbnN1cmVQb3NpdGl2ZURlbGF5UHJvcHMiKTsKCiAgdmFyIHdhcm5pbmcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiZmJqcy9saWIvd2FybmluZyIpOwoKICB2YXIgX3JlcXVpcmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAiVmlld0FjY2Vzc2liaWxpdHkiKSwKICAgICAgQWNjZXNzaWJpbGl0eUNvbXBvbmVudFR5cGVzID0gX3JlcXVpcmUuQWNjZXNzaWJpbGl0eUNvbXBvbmVudFR5cGVzLAogICAgICBBY2Nlc3NpYmlsaXR5VHJhaXRzID0gX3JlcXVpcmUuQWNjZXNzaWJpbGl0eVRyYWl0czsKCiAgdmFyIFBSRVNTX1JFVEVOVElPTl9PRkZTRVQgPSB7CiAgICB0b3A6IDIwLAogICAgbGVmdDogMjAsCiAgICByaWdodDogMjAsCiAgICBib3R0b206IDMwCiAgfTsKICB2YXIgVG91Y2hhYmxlV2l0aG91dEZlZWRiYWNrID0gY3JlYXRlUmVhY3RDbGFzcyh7CiAgICBkaXNwbGF5TmFtZTogJ1RvdWNoYWJsZVdpdGhvdXRGZWVkYmFjaycsCiAgICBtaXhpbnM6IFtUaW1lck1peGluLCBUb3VjaGFibGUuTWl4aW5dLAogICAgcHJvcFR5cGVzOiB7CiAgICAgIGFjY2Vzc2libGU6IFByb3BUeXBlcy5ib29sLAogICAgICBhY2Nlc3NpYmlsaXR5Q29tcG9uZW50VHlwZTogUHJvcFR5cGVzLm9uZU9mKEFjY2Vzc2liaWxpdHlDb21wb25lbnRUeXBlcyksCiAgICAgIGFjY2Vzc2liaWxpdHlUcmFpdHM6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5vbmVPZihBY2Nlc3NpYmlsaXR5VHJhaXRzKSwgUHJvcFR5cGVzLmFycmF5T2YoUHJvcFR5cGVzLm9uZU9mKEFjY2Vzc2liaWxpdHlUcmFpdHMpKV0pLAogICAgICBkaXNhYmxlZDogUHJvcFR5cGVzLmJvb2wsCiAgICAgIG9uUHJlc3M6IFByb3BUeXBlcy5mdW5jLAogICAgICBvblByZXNzSW46IFByb3BUeXBlcy5mdW5jLAogICAgICBvblByZXNzT3V0OiBQcm9wVHlwZXMuZnVuYywKICAgICAgb25MYXlvdXQ6IFByb3BUeXBlcy5mdW5jLAogICAgICBvbkxvbmdQcmVzczogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIGRlbGF5UHJlc3NJbjogUHJvcFR5cGVzLm51bWJlciwKICAgICAgZGVsYXlQcmVzc091dDogUHJvcFR5cGVzLm51bWJlciwKICAgICAgZGVsYXlMb25nUHJlc3M6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgIHByZXNzUmV0ZW50aW9uT2Zmc2V0OiBFZGdlSW5zZXRzUHJvcFR5cGUsCiAgICAgIGhpdFNsb3A6IEVkZ2VJbnNldHNQcm9wVHlwZQogICAgfSwKICAgIGdldEluaXRpYWxTdGF0ZTogZnVuY3Rpb24gZ2V0SW5pdGlhbFN0YXRlKCkgewogICAgICByZXR1cm4gdGhpcy50b3VjaGFibGVHZXRJbml0aWFsU3RhdGUoKTsKICAgIH0sCiAgICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24gY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgIGVuc3VyZVBvc2l0aXZlRGVsYXlQcm9wcyh0aGlzLnByb3BzKTsKICAgIH0sCiAgICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzOiBmdW5jdGlvbiBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wcykgewogICAgICBlbnN1cmVQb3NpdGl2ZURlbGF5UHJvcHMobmV4dFByb3BzKTsKICAgIH0sCiAgICB0b3VjaGFibGVIYW5kbGVQcmVzczogZnVuY3Rpb24gdG91Y2hhYmxlSGFuZGxlUHJlc3MoZSkgewogICAgICB0aGlzLnByb3BzLm9uUHJlc3MgJiYgdGhpcy5wcm9wcy5vblByZXNzKGUpOwogICAgfSwKICAgIHRvdWNoYWJsZUhhbmRsZUFjdGl2ZVByZXNzSW46IGZ1bmN0aW9uIHRvdWNoYWJsZUhhbmRsZUFjdGl2ZVByZXNzSW4oZSkgewogICAgICB0aGlzLnByb3BzLm9uUHJlc3NJbiAmJiB0aGlzLnByb3BzLm9uUHJlc3NJbihlKTsKICAgIH0sCiAgICB0b3VjaGFibGVIYW5kbGVBY3RpdmVQcmVzc091dDogZnVuY3Rpb24gdG91Y2hhYmxlSGFuZGxlQWN0aXZlUHJlc3NPdXQoZSkgewogICAgICB0aGlzLnByb3BzLm9uUHJlc3NPdXQgJiYgdGhpcy5wcm9wcy5vblByZXNzT3V0KGUpOwogICAgfSwKICAgIHRvdWNoYWJsZUhhbmRsZUxvbmdQcmVzczogZnVuY3Rpb24gdG91Y2hhYmxlSGFuZGxlTG9uZ1ByZXNzKGUpIHsKICAgICAgdGhpcy5wcm9wcy5vbkxvbmdQcmVzcyAmJiB0aGlzLnByb3BzLm9uTG9uZ1ByZXNzKGUpOwogICAgfSwKICAgIHRvdWNoYWJsZUdldFByZXNzUmVjdE9mZnNldDogZnVuY3Rpb24gdG91Y2hhYmxlR2V0UHJlc3NSZWN0T2Zmc2V0KCkgewogICAgICByZXR1cm4gdGhpcy5wcm9wcy5wcmVzc1JldGVudGlvbk9mZnNldCB8fCBQUkVTU19SRVRFTlRJT05fT0ZGU0VUOwogICAgfSwKICAgIHRvdWNoYWJsZUdldEhpdFNsb3A6IGZ1bmN0aW9uIHRvdWNoYWJsZUdldEhpdFNsb3AoKSB7CiAgICAgIHJldHVybiB0aGlzLnByb3BzLmhpdFNsb3A7CiAgICB9LAogICAgdG91Y2hhYmxlR2V0SGlnaGxpZ2h0RGVsYXlNUzogZnVuY3Rpb24gdG91Y2hhYmxlR2V0SGlnaGxpZ2h0RGVsYXlNUygpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvcHMuZGVsYXlQcmVzc0luIHx8IDA7CiAgICB9LAogICAgdG91Y2hhYmxlR2V0TG9uZ1ByZXNzRGVsYXlNUzogZnVuY3Rpb24gdG91Y2hhYmxlR2V0TG9uZ1ByZXNzRGVsYXlNUygpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvcHMuZGVsYXlMb25nUHJlc3MgPT09IDAgPyAwIDogdGhpcy5wcm9wcy5kZWxheUxvbmdQcmVzcyB8fCA1MDA7CiAgICB9LAogICAgdG91Y2hhYmxlR2V0UHJlc3NPdXREZWxheU1TOiBmdW5jdGlvbiB0b3VjaGFibGVHZXRQcmVzc091dERlbGF5TVMoKSB7CiAgICAgIHJldHVybiB0aGlzLnByb3BzLmRlbGF5UHJlc3NPdXQgfHwgMDsKICAgIH0sCiAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgdmFyIGNoaWxkID0gUmVhY3QuQ2hpbGRyZW4ub25seSh0aGlzLnByb3BzLmNoaWxkcmVuKTsKICAgICAgdmFyIGNoaWxkcmVuID0gY2hpbGQucHJvcHMuY2hpbGRyZW47CiAgICAgIHdhcm5pbmcoIWNoaWxkLnR5cGUgfHwgY2hpbGQudHlwZS5kaXNwbGF5TmFtZSAhPT0gJ1RleHQnLCAnVG91Y2hhYmxlV2l0aG91dEZlZWRiYWNrIGRvZXMgbm90IHdvcmsgd2VsbCB3aXRoIFRleHQgY2hpbGRyZW4uIFdyYXAgY2hpbGRyZW4gaW4gYSBWaWV3IGluc3RlYWQuIFNlZSAnICsgKGNoaWxkLl9vd25lciAmJiBjaGlsZC5fb3duZXIuZ2V0TmFtZSAmJiBjaGlsZC5fb3duZXIuZ2V0TmFtZSgpIHx8ICc8dW5rbm93bj4nKSk7CgogICAgICBpZiAoVG91Y2hhYmxlLlRPVUNIX1RBUkdFVF9ERUJVRyAmJiBjaGlsZC50eXBlICYmIGNoaWxkLnR5cGUuZGlzcGxheU5hbWUgPT09ICdWaWV3JykgewogICAgICAgIGNoaWxkcmVuID0gUmVhY3QuQ2hpbGRyZW4udG9BcnJheShjaGlsZHJlbik7CiAgICAgICAgY2hpbGRyZW4ucHVzaChUb3VjaGFibGUucmVuZGVyRGVidWdWaWV3KHsKICAgICAgICAgIGNvbG9yOiAncmVkJywKICAgICAgICAgIGhpdFNsb3A6IHRoaXMucHJvcHMuaGl0U2xvcAogICAgICAgIH0pKTsKICAgICAgfQoKICAgICAgdmFyIHN0eWxlID0gVG91Y2hhYmxlLlRPVUNIX1RBUkdFVF9ERUJVRyAmJiBjaGlsZC50eXBlICYmIGNoaWxkLnR5cGUuZGlzcGxheU5hbWUgPT09ICdUZXh0JyA/IFtjaGlsZC5wcm9wcy5zdHlsZSwgewogICAgICAgIGNvbG9yOiAncmVkJwogICAgICB9XSA6IGNoaWxkLnByb3BzLnN0eWxlOwogICAgICByZXR1cm4gUmVhY3QuY2xvbmVFbGVtZW50KGNoaWxkLCB7CiAgICAgICAgYWNjZXNzaWJsZTogdGhpcy5wcm9wcy5hY2Nlc3NpYmxlICE9PSBmYWxzZSwKICAgICAgICBhY2Nlc3NpYmlsaXR5TGFiZWw6IHRoaXMucHJvcHMuYWNjZXNzaWJpbGl0eUxhYmVsLAogICAgICAgIGFjY2Vzc2liaWxpdHlDb21wb25lbnRUeXBlOiB0aGlzLnByb3BzLmFjY2Vzc2liaWxpdHlDb21wb25lbnRUeXBlLAogICAgICAgIGFjY2Vzc2liaWxpdHlUcmFpdHM6IHRoaXMucHJvcHMuYWNjZXNzaWJpbGl0eVRyYWl0cywKICAgICAgICBuYXRpdmVJRDogdGhpcy5wcm9wcy5uYXRpdmVJRCwKICAgICAgICB0ZXN0SUQ6IHRoaXMucHJvcHMudGVzdElELAogICAgICAgIG9uTGF5b3V0OiB0aGlzLnByb3BzLm9uTGF5b3V0LAogICAgICAgIGhpdFNsb3A6IHRoaXMucHJvcHMuaGl0U2xvcCwKICAgICAgICBvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyOiB0aGlzLnRvdWNoYWJsZUhhbmRsZVN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyLAogICAgICAgIG9uUmVzcG9uZGVyVGVybWluYXRpb25SZXF1ZXN0OiB0aGlzLnRvdWNoYWJsZUhhbmRsZVJlc3BvbmRlclRlcm1pbmF0aW9uUmVxdWVzdCwKICAgICAgICBvblJlc3BvbmRlckdyYW50OiB0aGlzLnRvdWNoYWJsZUhhbmRsZVJlc3BvbmRlckdyYW50LAogICAgICAgIG9uUmVzcG9uZGVyTW92ZTogdGhpcy50b3VjaGFibGVIYW5kbGVSZXNwb25kZXJNb3ZlLAogICAgICAgIG9uUmVzcG9uZGVyUmVsZWFzZTogdGhpcy50b3VjaGFibGVIYW5kbGVSZXNwb25kZXJSZWxlYXNlLAogICAgICAgIG9uUmVzcG9uZGVyVGVybWluYXRlOiB0aGlzLnRvdWNoYWJsZUhhbmRsZVJlc3BvbmRlclRlcm1pbmF0ZSwKICAgICAgICBzdHlsZTogc3R5bGUsCiAgICAgICAgY2hpbGRyZW46IGNoaWxkcmVuCiAgICAgIH0pOwogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gVG91Y2hhYmxlV2l0aG91dEZlZWRiYWNrOwp9LDE5MCxbMTMyLDEzMCwxMjcsMTkxLDE4MiwxNzIsMTkyLDU2LDE0NF0sIlRvdWNoYWJsZVdpdGhvdXRGZWVkYmFjayIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEdMT0JBTCA9IHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnID8gZ2xvYmFsIDogd2luZG93OwoKICB2YXIgc2V0dGVyID0gZnVuY3Rpb24gc2V0dGVyKF9zZXR0ZXIsIF9jbGVhcmVyLCBhcnJheSkgewogICAgcmV0dXJuIGZ1bmN0aW9uIChjYWxsYmFjaywgZGVsdGEpIHsKICAgICAgdmFyIGlkID0gX3NldHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgX2NsZWFyZXIuY2FsbCh0aGlzLCBpZCk7CgogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0uYmluZCh0aGlzKSwgZGVsdGEpOwoKICAgICAgaWYgKCF0aGlzW2FycmF5XSkgewogICAgICAgIHRoaXNbYXJyYXldID0gW2lkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzW2FycmF5XS5wdXNoKGlkKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGlkOwogICAgfTsKICB9OwoKICB2YXIgY2xlYXJlciA9IGZ1bmN0aW9uIGNsZWFyZXIoX2NsZWFyZXIsIGFycmF5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKGlkKSB7CiAgICAgIGlmICh0aGlzW2FycmF5XSkgewogICAgICAgIHZhciBpbmRleCA9IHRoaXNbYXJyYXldLmluZGV4T2YoaWQpOwoKICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgICB0aGlzW2FycmF5XS5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgX2NsZWFyZXIoaWQpOwogICAgfTsKICB9OwoKICB2YXIgX3RpbWVvdXRzID0gJ1RpbWVyTWl4aW5fdGltZW91dHMnOwoKICB2YXIgX2NsZWFyVGltZW91dCA9IGNsZWFyZXIoR0xPQkFMLmNsZWFyVGltZW91dCwgX3RpbWVvdXRzKTsKCiAgdmFyIF9zZXRUaW1lb3V0ID0gc2V0dGVyKEdMT0JBTC5zZXRUaW1lb3V0LCBfY2xlYXJUaW1lb3V0LCBfdGltZW91dHMpOwoKICB2YXIgX2ludGVydmFscyA9ICdUaW1lck1peGluX2ludGVydmFscyc7CgogIHZhciBfY2xlYXJJbnRlcnZhbCA9IGNsZWFyZXIoR0xPQkFMLmNsZWFySW50ZXJ2YWwsIF9pbnRlcnZhbHMpOwoKICB2YXIgX3NldEludGVydmFsID0gc2V0dGVyKEdMT0JBTC5zZXRJbnRlcnZhbCwgZnVuY3Rpb24gKCkge30sIF9pbnRlcnZhbHMpOwoKICB2YXIgX2ltbWVkaWF0ZXMgPSAnVGltZXJNaXhpbl9pbW1lZGlhdGVzJzsKCiAgdmFyIF9jbGVhckltbWVkaWF0ZSA9IGNsZWFyZXIoR0xPQkFMLmNsZWFySW1tZWRpYXRlLCBfaW1tZWRpYXRlcyk7CgogIHZhciBfc2V0SW1tZWRpYXRlID0gc2V0dGVyKEdMT0JBTC5zZXRJbW1lZGlhdGUsIF9jbGVhckltbWVkaWF0ZSwgX2ltbWVkaWF0ZXMpOwoKICB2YXIgX3JhZnMgPSAnVGltZXJNaXhpbl9yYWZzJzsKCiAgdmFyIF9jYW5jZWxBbmltYXRpb25GcmFtZSA9IGNsZWFyZXIoR0xPQkFMLmNhbmNlbEFuaW1hdGlvbkZyYW1lLCBfcmFmcyk7CgogIHZhciBfcmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gc2V0dGVyKEdMT0JBTC5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUsIF9jYW5jZWxBbmltYXRpb25GcmFtZSwgX3JhZnMpOwoKICB2YXIgVGltZXJNaXhpbiA9IHsKICAgIGNvbXBvbmVudFdpbGxVbm1vdW50OiBmdW5jdGlvbiBjb21wb25lbnRXaWxsVW5tb3VudCgpIHsKICAgICAgdGhpc1tfdGltZW91dHNdICYmIHRoaXNbX3RpbWVvdXRzXS5mb3JFYWNoKGZ1bmN0aW9uIChpZCkgewogICAgICAgIEdMT0JBTC5jbGVhclRpbWVvdXQoaWQpOwogICAgICB9KTsKICAgICAgdGhpc1tfdGltZW91dHNdID0gbnVsbDsKICAgICAgdGhpc1tfaW50ZXJ2YWxzXSAmJiB0aGlzW19pbnRlcnZhbHNdLmZvckVhY2goZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgR0xPQkFMLmNsZWFySW50ZXJ2YWwoaWQpOwogICAgICB9KTsKICAgICAgdGhpc1tfaW50ZXJ2YWxzXSA9IG51bGw7CiAgICAgIHRoaXNbX2ltbWVkaWF0ZXNdICYmIHRoaXNbX2ltbWVkaWF0ZXNdLmZvckVhY2goZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgR0xPQkFMLmNsZWFySW1tZWRpYXRlKGlkKTsKICAgICAgfSk7CiAgICAgIHRoaXNbX2ltbWVkaWF0ZXNdID0gbnVsbDsKICAgICAgdGhpc1tfcmFmc10gJiYgdGhpc1tfcmFmc10uZm9yRWFjaChmdW5jdGlvbiAoaWQpIHsKICAgICAgICBHTE9CQUwuY2FuY2VsQW5pbWF0aW9uRnJhbWUoaWQpOwogICAgICB9KTsKICAgICAgdGhpc1tfcmFmc10gPSBudWxsOwogICAgfSwKICAgIHNldFRpbWVvdXQ6IF9zZXRUaW1lb3V0LAogICAgY2xlYXJUaW1lb3V0OiBfY2xlYXJUaW1lb3V0LAogICAgc2V0SW50ZXJ2YWw6IF9zZXRJbnRlcnZhbCwKICAgIGNsZWFySW50ZXJ2YWw6IF9jbGVhckludGVydmFsLAogICAgc2V0SW1tZWRpYXRlOiBfc2V0SW1tZWRpYXRlLAogICAgY2xlYXJJbW1lZGlhdGU6IF9jbGVhckltbWVkaWF0ZSwKICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZTogX3JlcXVlc3RBbmltYXRpb25GcmFtZSwKICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lOiBfY2FuY2VsQW5pbWF0aW9uRnJhbWUKICB9OwogIG1vZHVsZS5leHBvcnRzID0gVGltZXJNaXhpbjsKfSwxOTEsW10sInJlYWN0LXRpbWVyLW1peGluL1RpbWVyTWl4aW4uanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBlbnN1cmVQb3NpdGl2ZURlbGF5UHJvcHMgPSBmdW5jdGlvbiBlbnN1cmVQb3NpdGl2ZURlbGF5UHJvcHMocHJvcHMpIHsKICAgIGludmFyaWFudCghKHByb3BzLmRlbGF5UHJlc3NJbiA8IDAgfHwgcHJvcHMuZGVsYXlQcmVzc091dCA8IDAgfHwgcHJvcHMuZGVsYXlMb25nUHJlc3MgPCAwKSwgJ1RvdWNoYWJsZSBjb21wb25lbnRzIGNhbm5vdCBoYXZlIG5lZ2F0aXZlIGRlbGF5IHByb3BlcnRpZXMnKTsKICB9OwoKICBtb2R1bGUuZXhwb3J0cyA9IGVuc3VyZVBvc2l0aXZlRGVsYXlQcm9wczsKfSwxOTIsWzEzXSwiZW5zdXJlUG9zaXRpdmVEZWxheVByb3BzIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29tcG9uZW50cy9Ub3VjaGFibGUvVG91Y2hhYmxlT3BhY2l0eS5qcyI7CgogIHZhciBBbmltYXRlZCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJBbmltYXRlZCIpOwoKICB2YXIgRWFzaW5nID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkVhc2luZyIpOwoKICB2YXIgTmF0aXZlTWV0aG9kc01peGluID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIk5hdGl2ZU1ldGhvZHNNaXhpbiIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUmVhY3QiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJwcm9wLXR5cGVzIik7CgogIHZhciBUaW1lck1peGluID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgInJlYWN0LXRpbWVyLW1peGluIik7CgogIHZhciBUb3VjaGFibGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAiVG91Y2hhYmxlIik7CgogIHZhciBUb3VjaGFibGVXaXRob3V0RmVlZGJhY2sgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiVG91Y2hhYmxlV2l0aG91dEZlZWRiYWNrIik7CgogIHZhciBjcmVhdGVSZWFjdENsYXNzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4XSwgImNyZWF0ZS1yZWFjdC1jbGFzcyIpOwoKICB2YXIgZW5zdXJlUG9zaXRpdmVEZWxheVByb3BzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs5XSwgImVuc3VyZVBvc2l0aXZlRGVsYXlQcm9wcyIpOwoKICB2YXIgZmxhdHRlblN0eWxlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMF0sICJmbGF0dGVuU3R5bGUiKTsKCiAgdmFyIFBSRVNTX1JFVEVOVElPTl9PRkZTRVQgPSB7CiAgICB0b3A6IDIwLAogICAgbGVmdDogMjAsCiAgICByaWdodDogMjAsCiAgICBib3R0b206IDMwCiAgfTsKICB2YXIgVG91Y2hhYmxlT3BhY2l0eSA9IGNyZWF0ZVJlYWN0Q2xhc3MoewogICAgZGlzcGxheU5hbWU6ICdUb3VjaGFibGVPcGFjaXR5JywKICAgIG1peGluczogW1RpbWVyTWl4aW4sIFRvdWNoYWJsZS5NaXhpbiwgTmF0aXZlTWV0aG9kc01peGluXSwKICAgIHByb3BUeXBlczogYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIFRvdWNoYWJsZVdpdGhvdXRGZWVkYmFjay5wcm9wVHlwZXMsIHsKICAgICAgYWN0aXZlT3BhY2l0eTogUHJvcFR5cGVzLm51bWJlciwKICAgICAgaGFzVFZQcmVmZXJyZWRGb2N1czogUHJvcFR5cGVzLmJvb2wsCiAgICAgIHR2UGFyYWxsYXhQcm9wZXJ0aWVzOiBQcm9wVHlwZXMub2JqZWN0CiAgICB9KSwKICAgIGdldERlZmF1bHRQcm9wczogZnVuY3Rpb24gZ2V0RGVmYXVsdFByb3BzKCkgewogICAgICByZXR1cm4gewogICAgICAgIGFjdGl2ZU9wYWNpdHk6IDAuMgogICAgICB9OwogICAgfSwKICAgIGdldEluaXRpYWxTdGF0ZTogZnVuY3Rpb24gZ2V0SW5pdGlhbFN0YXRlKCkgewogICAgICByZXR1cm4gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHRoaXMudG91Y2hhYmxlR2V0SW5pdGlhbFN0YXRlKCksIHsKICAgICAgICBhbmltOiBuZXcgQW5pbWF0ZWQuVmFsdWUodGhpcy5fZ2V0Q2hpbGRTdHlsZU9wYWNpdHlXaXRoRGVmYXVsdCgpKQogICAgICB9KTsKICAgIH0sCiAgICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24gY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgIGVuc3VyZVBvc2l0aXZlRGVsYXlQcm9wcyh0aGlzLnByb3BzKTsKICAgIH0sCiAgICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzOiBmdW5jdGlvbiBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wcykgewogICAgICBlbnN1cmVQb3NpdGl2ZURlbGF5UHJvcHMobmV4dFByb3BzKTsKICAgIH0sCiAgICBzZXRPcGFjaXR5VG86IGZ1bmN0aW9uIHNldE9wYWNpdHlUbyh2YWx1ZSwgZHVyYXRpb24pIHsKICAgICAgQW5pbWF0ZWQudGltaW5nKHRoaXMuc3RhdGUuYW5pbSwgewogICAgICAgIHRvVmFsdWU6IHZhbHVlLAogICAgICAgIGR1cmF0aW9uOiBkdXJhdGlvbiwKICAgICAgICBlYXNpbmc6IEVhc2luZy5pbk91dChFYXNpbmcucXVhZCksCiAgICAgICAgdXNlTmF0aXZlRHJpdmVyOiB0cnVlCiAgICAgIH0pLnN0YXJ0KCk7CiAgICB9LAogICAgdG91Y2hhYmxlSGFuZGxlQWN0aXZlUHJlc3NJbjogZnVuY3Rpb24gdG91Y2hhYmxlSGFuZGxlQWN0aXZlUHJlc3NJbihlKSB7CiAgICAgIGlmIChlLmRpc3BhdGNoQ29uZmlnLnJlZ2lzdHJhdGlvbk5hbWUgPT09ICdvblJlc3BvbmRlckdyYW50JykgewogICAgICAgIHRoaXMuX29wYWNpdHlBY3RpdmUoMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fb3BhY2l0eUFjdGl2ZSgxNTApOwogICAgICB9CgogICAgICB0aGlzLnByb3BzLm9uUHJlc3NJbiAmJiB0aGlzLnByb3BzLm9uUHJlc3NJbihlKTsKICAgIH0sCiAgICB0b3VjaGFibGVIYW5kbGVBY3RpdmVQcmVzc091dDogZnVuY3Rpb24gdG91Y2hhYmxlSGFuZGxlQWN0aXZlUHJlc3NPdXQoZSkgewogICAgICB0aGlzLl9vcGFjaXR5SW5hY3RpdmUoMjUwKTsKCiAgICAgIHRoaXMucHJvcHMub25QcmVzc091dCAmJiB0aGlzLnByb3BzLm9uUHJlc3NPdXQoZSk7CiAgICB9LAogICAgdG91Y2hhYmxlSGFuZGxlUHJlc3M6IGZ1bmN0aW9uIHRvdWNoYWJsZUhhbmRsZVByZXNzKGUpIHsKICAgICAgdGhpcy5wcm9wcy5vblByZXNzICYmIHRoaXMucHJvcHMub25QcmVzcyhlKTsKICAgIH0sCiAgICB0b3VjaGFibGVIYW5kbGVMb25nUHJlc3M6IGZ1bmN0aW9uIHRvdWNoYWJsZUhhbmRsZUxvbmdQcmVzcyhlKSB7CiAgICAgIHRoaXMucHJvcHMub25Mb25nUHJlc3MgJiYgdGhpcy5wcm9wcy5vbkxvbmdQcmVzcyhlKTsKICAgIH0sCiAgICB0b3VjaGFibGVHZXRQcmVzc1JlY3RPZmZzZXQ6IGZ1bmN0aW9uIHRvdWNoYWJsZUdldFByZXNzUmVjdE9mZnNldCgpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvcHMucHJlc3NSZXRlbnRpb25PZmZzZXQgfHwgUFJFU1NfUkVURU5USU9OX09GRlNFVDsKICAgIH0sCiAgICB0b3VjaGFibGVHZXRIaXRTbG9wOiBmdW5jdGlvbiB0b3VjaGFibGVHZXRIaXRTbG9wKCkgewogICAgICByZXR1cm4gdGhpcy5wcm9wcy5oaXRTbG9wOwogICAgfSwKICAgIHRvdWNoYWJsZUdldEhpZ2hsaWdodERlbGF5TVM6IGZ1bmN0aW9uIHRvdWNoYWJsZUdldEhpZ2hsaWdodERlbGF5TVMoKSB7CiAgICAgIHJldHVybiB0aGlzLnByb3BzLmRlbGF5UHJlc3NJbiB8fCAwOwogICAgfSwKICAgIHRvdWNoYWJsZUdldExvbmdQcmVzc0RlbGF5TVM6IGZ1bmN0aW9uIHRvdWNoYWJsZUdldExvbmdQcmVzc0RlbGF5TVMoKSB7CiAgICAgIHJldHVybiB0aGlzLnByb3BzLmRlbGF5TG9uZ1ByZXNzID09PSAwID8gMCA6IHRoaXMucHJvcHMuZGVsYXlMb25nUHJlc3MgfHwgNTAwOwogICAgfSwKICAgIHRvdWNoYWJsZUdldFByZXNzT3V0RGVsYXlNUzogZnVuY3Rpb24gdG91Y2hhYmxlR2V0UHJlc3NPdXREZWxheU1TKCkgewogICAgICByZXR1cm4gdGhpcy5wcm9wcy5kZWxheVByZXNzT3V0OwogICAgfSwKICAgIF9vcGFjaXR5QWN0aXZlOiBmdW5jdGlvbiBfb3BhY2l0eUFjdGl2ZShkdXJhdGlvbikgewogICAgICB0aGlzLnNldE9wYWNpdHlUbyh0aGlzLnByb3BzLmFjdGl2ZU9wYWNpdHksIGR1cmF0aW9uKTsKICAgIH0sCiAgICBfb3BhY2l0eUluYWN0aXZlOiBmdW5jdGlvbiBfb3BhY2l0eUluYWN0aXZlKGR1cmF0aW9uKSB7CiAgICAgIHRoaXMuc2V0T3BhY2l0eVRvKHRoaXMuX2dldENoaWxkU3R5bGVPcGFjaXR5V2l0aERlZmF1bHQoKSwgZHVyYXRpb24pOwogICAgfSwKICAgIF9nZXRDaGlsZFN0eWxlT3BhY2l0eVdpdGhEZWZhdWx0OiBmdW5jdGlvbiBfZ2V0Q2hpbGRTdHlsZU9wYWNpdHlXaXRoRGVmYXVsdCgpIHsKICAgICAgdmFyIGNoaWxkU3R5bGUgPSBmbGF0dGVuU3R5bGUodGhpcy5wcm9wcy5zdHlsZSkgfHwge307CiAgICAgIHJldHVybiBjaGlsZFN0eWxlLm9wYWNpdHkgPT0gdW5kZWZpbmVkID8gMSA6IGNoaWxkU3R5bGUub3BhY2l0eTsKICAgIH0sCiAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgQW5pbWF0ZWQuVmlldywKICAgICAgICB7CiAgICAgICAgICBhY2Nlc3NpYmxlOiB0aGlzLnByb3BzLmFjY2Vzc2libGUgIT09IGZhbHNlLAogICAgICAgICAgYWNjZXNzaWJpbGl0eUxhYmVsOiB0aGlzLnByb3BzLmFjY2Vzc2liaWxpdHlMYWJlbCwKICAgICAgICAgIGFjY2Vzc2liaWxpdHlDb21wb25lbnRUeXBlOiB0aGlzLnByb3BzLmFjY2Vzc2liaWxpdHlDb21wb25lbnRUeXBlLAogICAgICAgICAgYWNjZXNzaWJpbGl0eVRyYWl0czogdGhpcy5wcm9wcy5hY2Nlc3NpYmlsaXR5VHJhaXRzLAogICAgICAgICAgc3R5bGU6IFt0aGlzLnByb3BzLnN0eWxlLCB7CiAgICAgICAgICAgIG9wYWNpdHk6IHRoaXMuc3RhdGUuYW5pbQogICAgICAgICAgfV0sCiAgICAgICAgICBuYXRpdmVJRDogdGhpcy5wcm9wcy5uYXRpdmVJRCwKICAgICAgICAgIHRlc3RJRDogdGhpcy5wcm9wcy50ZXN0SUQsCiAgICAgICAgICBvbkxheW91dDogdGhpcy5wcm9wcy5vbkxheW91dCwKICAgICAgICAgIGlzVFZTZWxlY3RhYmxlOiB0cnVlLAogICAgICAgICAgaGFzVFZQcmVmZXJyZWRGb2N1czogdGhpcy5wcm9wcy5oYXNUVlByZWZlcnJlZEZvY3VzLAogICAgICAgICAgdHZQYXJhbGxheFByb3BlcnRpZXM6IHRoaXMucHJvcHMudHZQYXJhbGxheFByb3BlcnRpZXMsCiAgICAgICAgICBoaXRTbG9wOiB0aGlzLnByb3BzLmhpdFNsb3AsCiAgICAgICAgICBvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyOiB0aGlzLnRvdWNoYWJsZUhhbmRsZVN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyLAogICAgICAgICAgb25SZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3Q6IHRoaXMudG91Y2hhYmxlSGFuZGxlUmVzcG9uZGVyVGVybWluYXRpb25SZXF1ZXN0LAogICAgICAgICAgb25SZXNwb25kZXJHcmFudDogdGhpcy50b3VjaGFibGVIYW5kbGVSZXNwb25kZXJHcmFudCwKICAgICAgICAgIG9uUmVzcG9uZGVyTW92ZTogdGhpcy50b3VjaGFibGVIYW5kbGVSZXNwb25kZXJNb3ZlLAogICAgICAgICAgb25SZXNwb25kZXJSZWxlYXNlOiB0aGlzLnRvdWNoYWJsZUhhbmRsZVJlc3BvbmRlclJlbGVhc2UsCiAgICAgICAgICBvblJlc3BvbmRlclRlcm1pbmF0ZTogdGhpcy50b3VjaGFibGVIYW5kbGVSZXNwb25kZXJUZXJtaW5hdGUsCiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiAyNDUKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHRoaXMucHJvcHMuY2hpbGRyZW4sCiAgICAgICAgVG91Y2hhYmxlLnJlbmRlckRlYnVnVmlldyh7CiAgICAgICAgICBjb2xvcjogJ2N5YW4nLAogICAgICAgICAgaGl0U2xvcDogdGhpcy5wcm9wcy5oaXRTbG9wCiAgICAgICAgfSkKICAgICAgKTsKICAgIH0KICB9KTsKICBtb2R1bGUuZXhwb3J0cyA9IFRvdWNoYWJsZU9wYWNpdHk7Cn0sMTkzLFsxOTQsMjE5LDEyNSwxMzAsMTI3LDE5MSwxODIsMTkwLDE3MiwxOTIsMTAxXSwiVG91Y2hhYmxlT3BhY2l0eSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEFuaW1hdGVkSW1wbGVtZW50YXRpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQW5pbWF0ZWRJbXBsZW1lbnRhdGlvbiIpOwoKICB2YXIgSW1hZ2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiSW1hZ2UiKTsKCiAgdmFyIFRleHQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiVGV4dCIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJWaWV3Iik7CgogIHZhciBBbmltYXRlZFNjcm9sbFZpZXcgPSB2b2lkIDA7CiAgdmFyIEFuaW1hdGVkID0gewogICAgVmlldzogQW5pbWF0ZWRJbXBsZW1lbnRhdGlvbi5jcmVhdGVBbmltYXRlZENvbXBvbmVudChWaWV3KSwKICAgIFRleHQ6IEFuaW1hdGVkSW1wbGVtZW50YXRpb24uY3JlYXRlQW5pbWF0ZWRDb21wb25lbnQoVGV4dCksCiAgICBJbWFnZTogQW5pbWF0ZWRJbXBsZW1lbnRhdGlvbi5jcmVhdGVBbmltYXRlZENvbXBvbmVudChJbWFnZSksCgogICAgZ2V0IFNjcm9sbFZpZXcoKSB7CiAgICAgIGlmICghQW5pbWF0ZWRTY3JvbGxWaWV3KSB7CiAgICAgICAgQW5pbWF0ZWRTY3JvbGxWaWV3ID0gQW5pbWF0ZWRJbXBsZW1lbnRhdGlvbi5jcmVhdGVBbmltYXRlZENvbXBvbmVudChyZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiU2Nyb2xsVmlldyIpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIEFuaW1hdGVkU2Nyb2xsVmlldzsKICAgIH0KCiAgfTsKICBiYWJlbEhlbHBlcnMuZXh0ZW5kcyhBbmltYXRlZCwgQW5pbWF0ZWRJbXBsZW1lbnRhdGlvbik7CiAgbW9kdWxlLmV4cG9ydHMgPSBBbmltYXRlZDsKfSwxOTQsWzE5NSwyMjIsMTgxLDE3MCwyMjRdLCJBbmltYXRlZCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgJy4vQW5pbWF0ZWRFdmVudCcpLAogICAgICBBbmltYXRlZEV2ZW50ID0gX3JlcXVpcmUuQW5pbWF0ZWRFdmVudCwKICAgICAgYXR0YWNoTmF0aXZlRXZlbnQgPSBfcmVxdWlyZS5hdHRhY2hOYXRpdmVFdmVudDsKCiAgdmFyIEFuaW1hdGVkQWRkaXRpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAnLi9ub2Rlcy9BbmltYXRlZEFkZGl0aW9uJyk7CgogIHZhciBBbmltYXRlZERpZmZDbGFtcCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICcuL25vZGVzL0FuaW1hdGVkRGlmZkNsYW1wJyk7CgogIHZhciBBbmltYXRlZERpdmlzaW9uID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgJy4vbm9kZXMvQW5pbWF0ZWREaXZpc2lvbicpOwoKICB2YXIgQW5pbWF0ZWRJbnRlcnBvbGF0aW9uID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgJy4vbm9kZXMvQW5pbWF0ZWRJbnRlcnBvbGF0aW9uJyk7CgogIHZhciBBbmltYXRlZE1vZHVsbyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICcuL25vZGVzL0FuaW1hdGVkTW9kdWxvJyk7CgogIHZhciBBbmltYXRlZE11bHRpcGxpY2F0aW9uID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgJy4vbm9kZXMvQW5pbWF0ZWRNdWx0aXBsaWNhdGlvbicpOwoKICB2YXIgQW5pbWF0ZWROb2RlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgJy4vbm9kZXMvQW5pbWF0ZWROb2RlJyk7CgogIHZhciBBbmltYXRlZFByb3BzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4XSwgJy4vbm9kZXMvQW5pbWF0ZWRQcm9wcycpOwoKICB2YXIgQW5pbWF0ZWRUcmFja2luZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOV0sICcuL25vZGVzL0FuaW1hdGVkVHJhY2tpbmcnKTsKCiAgdmFyIEFuaW1hdGVkVmFsdWUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEwXSwgJy4vbm9kZXMvQW5pbWF0ZWRWYWx1ZScpOwoKICB2YXIgQW5pbWF0ZWRWYWx1ZVhZID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMV0sICcuL25vZGVzL0FuaW1hdGVkVmFsdWVYWScpOwoKICB2YXIgRGVjYXlBbmltYXRpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEyXSwgJy4vYW5pbWF0aW9ucy9EZWNheUFuaW1hdGlvbicpOwoKICB2YXIgU3ByaW5nQW5pbWF0aW9uID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxM10sICcuL2FuaW1hdGlvbnMvU3ByaW5nQW5pbWF0aW9uJyk7CgogIHZhciBUaW1pbmdBbmltYXRpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE0XSwgJy4vYW5pbWF0aW9ucy9UaW1pbmdBbmltYXRpb24nKTsKCiAgdmFyIGNyZWF0ZUFuaW1hdGVkQ29tcG9uZW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxNV0sICcuL2NyZWF0ZUFuaW1hdGVkQ29tcG9uZW50Jyk7CgogIHZhciBhZGQgPSBmdW5jdGlvbiBhZGQoYSwgYikgewogICAgcmV0dXJuIG5ldyBBbmltYXRlZEFkZGl0aW9uKGEsIGIpOwogIH07CgogIHZhciBkaXZpZGUgPSBmdW5jdGlvbiBkaXZpZGUoYSwgYikgewogICAgcmV0dXJuIG5ldyBBbmltYXRlZERpdmlzaW9uKGEsIGIpOwogIH07CgogIHZhciBtdWx0aXBseSA9IGZ1bmN0aW9uIG11bHRpcGx5KGEsIGIpIHsKICAgIHJldHVybiBuZXcgQW5pbWF0ZWRNdWx0aXBsaWNhdGlvbihhLCBiKTsKICB9OwoKICB2YXIgbW9kdWxvID0gZnVuY3Rpb24gbW9kdWxvKGEsIG1vZHVsdXMpIHsKICAgIHJldHVybiBuZXcgQW5pbWF0ZWRNb2R1bG8oYSwgbW9kdWx1cyk7CiAgfTsKCiAgdmFyIGRpZmZDbGFtcCA9IGZ1bmN0aW9uIGRpZmZDbGFtcChhLCBtaW4sIG1heCkgewogICAgcmV0dXJuIG5ldyBBbmltYXRlZERpZmZDbGFtcChhLCBtaW4sIG1heCk7CiAgfTsKCiAgdmFyIF9jb21iaW5lQ2FsbGJhY2tzID0gZnVuY3Rpb24gX2NvbWJpbmVDYWxsYmFja3MoY2FsbGJhY2ssIGNvbmZpZykgewogICAgaWYgKGNhbGxiYWNrICYmIGNvbmZpZy5vbkNvbXBsZXRlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgY29uZmlnLm9uQ29tcGxldGUgJiYgY29uZmlnLm9uQ29tcGxldGUuYXBwbHkoY29uZmlnLCBhcmd1bWVudHMpOwogICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmFwcGx5KHVuZGVmaW5lZCwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBjYWxsYmFjayB8fCBjb25maWcub25Db21wbGV0ZTsKICAgIH0KICB9OwoKICB2YXIgbWF5YmVWZWN0b3JBbmltID0gZnVuY3Rpb24gbWF5YmVWZWN0b3JBbmltKHZhbHVlLCBjb25maWcsIGFuaW0pIHsKICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkVmFsdWVYWSkgewogICAgICB2YXIgY29uZmlnWCA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBjb25maWcpOwogICAgICB2YXIgY29uZmlnWSA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBjb25maWcpOwoKICAgICAgZm9yICh2YXIga2V5IGluIGNvbmZpZykgewogICAgICAgIHZhciBfY29uZmlnJGtleSA9IGNvbmZpZ1trZXldLAogICAgICAgICAgICB4ID0gX2NvbmZpZyRrZXkueCwKICAgICAgICAgICAgeSA9IF9jb25maWcka2V5Lnk7CgogICAgICAgIGlmICh4ICE9PSB1bmRlZmluZWQgJiYgeSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBjb25maWdYW2tleV0gPSB4OwogICAgICAgICAgY29uZmlnWVtrZXldID0geTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBhWCA9IGFuaW0odmFsdWUueCwgY29uZmlnWCk7CiAgICAgIHZhciBhWSA9IGFuaW0odmFsdWUueSwgY29uZmlnWSk7CiAgICAgIHJldHVybiBwYXJhbGxlbChbYVgsIGFZXSwgewogICAgICAgIHN0b3BUb2dldGhlcjogZmFsc2UKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfTsKCiAgdmFyIHNwcmluZyA9IGZ1bmN0aW9uIHNwcmluZyh2YWx1ZSwgY29uZmlnKSB7CiAgICB2YXIgc3RhcnQgPSBmdW5jdGlvbiBzdGFydChhbmltYXRlZFZhbHVlLCBjb25maWd1cmF0aW9uLCBjYWxsYmFjaykgewogICAgICBjYWxsYmFjayA9IF9jb21iaW5lQ2FsbGJhY2tzKGNhbGxiYWNrLCBjb25maWd1cmF0aW9uKTsKICAgICAgdmFyIHNpbmdsZVZhbHVlID0gYW5pbWF0ZWRWYWx1ZTsKICAgICAgdmFyIHNpbmdsZUNvbmZpZyA9IGNvbmZpZ3VyYXRpb247CiAgICAgIHNpbmdsZVZhbHVlLnN0b3BUcmFja2luZygpOwoKICAgICAgaWYgKGNvbmZpZ3VyYXRpb24udG9WYWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkTm9kZSkgewogICAgICAgIHNpbmdsZVZhbHVlLnRyYWNrKG5ldyBBbmltYXRlZFRyYWNraW5nKHNpbmdsZVZhbHVlLCBjb25maWd1cmF0aW9uLnRvVmFsdWUsIFNwcmluZ0FuaW1hdGlvbiwgc2luZ2xlQ29uZmlnLCBjYWxsYmFjaykpOwogICAgICB9IGVsc2UgewogICAgICAgIHNpbmdsZVZhbHVlLmFuaW1hdGUobmV3IFNwcmluZ0FuaW1hdGlvbihzaW5nbGVDb25maWcpLCBjYWxsYmFjayk7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIG1heWJlVmVjdG9yQW5pbSh2YWx1ZSwgY29uZmlnLCBzcHJpbmcpIHx8IHsKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChfc3RhcnQpIHsKICAgICAgICBmdW5jdGlvbiBzdGFydChfeCkgewogICAgICAgICAgcmV0dXJuIF9zdGFydC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KCiAgICAgICAgc3RhcnQudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gX3N0YXJ0LnRvU3RyaW5nKCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIHN0YXJ0OwogICAgICB9KGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgIHN0YXJ0KHZhbHVlLCBjb25maWcsIGNhbGxiYWNrKTsKICAgICAgfSksCiAgICAgIHN0b3A6IGZ1bmN0aW9uIHN0b3AoKSB7CiAgICAgICAgdmFsdWUuc3RvcEFuaW1hdGlvbigpOwogICAgICB9LAogICAgICByZXNldDogZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgICAgdmFsdWUucmVzZXRBbmltYXRpb24oKTsKICAgICAgfSwKICAgICAgX3N0YXJ0TmF0aXZlTG9vcDogZnVuY3Rpb24gX3N0YXJ0TmF0aXZlTG9vcChpdGVyYXRpb25zKSB7CiAgICAgICAgdmFyIHNpbmdsZUNvbmZpZyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBjb25maWcsIHsKICAgICAgICAgIGl0ZXJhdGlvbnM6IGl0ZXJhdGlvbnMKICAgICAgICB9KTsKICAgICAgICBzdGFydCh2YWx1ZSwgc2luZ2xlQ29uZmlnKTsKICAgICAgfSwKICAgICAgX2lzVXNpbmdOYXRpdmVEcml2ZXI6IGZ1bmN0aW9uIF9pc1VzaW5nTmF0aXZlRHJpdmVyKCkgewogICAgICAgIHJldHVybiBjb25maWcudXNlTmF0aXZlRHJpdmVyIHx8IGZhbHNlOwogICAgICB9CiAgICB9OwogIH07CgogIHZhciB0aW1pbmcgPSBmdW5jdGlvbiB0aW1pbmcodmFsdWUsIGNvbmZpZykgewogICAgdmFyIHN0YXJ0ID0gZnVuY3Rpb24gc3RhcnQoYW5pbWF0ZWRWYWx1ZSwgY29uZmlndXJhdGlvbiwgY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2sgPSBfY29tYmluZUNhbGxiYWNrcyhjYWxsYmFjaywgY29uZmlndXJhdGlvbik7CiAgICAgIHZhciBzaW5nbGVWYWx1ZSA9IGFuaW1hdGVkVmFsdWU7CiAgICAgIHZhciBzaW5nbGVDb25maWcgPSBjb25maWd1cmF0aW9uOwogICAgICBzaW5nbGVWYWx1ZS5zdG9wVHJhY2tpbmcoKTsKCiAgICAgIGlmIChjb25maWd1cmF0aW9uLnRvVmFsdWUgaW5zdGFuY2VvZiBBbmltYXRlZE5vZGUpIHsKICAgICAgICBzaW5nbGVWYWx1ZS50cmFjayhuZXcgQW5pbWF0ZWRUcmFja2luZyhzaW5nbGVWYWx1ZSwgY29uZmlndXJhdGlvbi50b1ZhbHVlLCBUaW1pbmdBbmltYXRpb24sIHNpbmdsZUNvbmZpZywgY2FsbGJhY2spKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzaW5nbGVWYWx1ZS5hbmltYXRlKG5ldyBUaW1pbmdBbmltYXRpb24oc2luZ2xlQ29uZmlnKSwgY2FsbGJhY2spOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBtYXliZVZlY3RvckFuaW0odmFsdWUsIGNvbmZpZywgdGltaW5nKSB8fCB7CiAgICAgIHN0YXJ0OiBmdW5jdGlvbiAoX3N0YXJ0MikgewogICAgICAgIGZ1bmN0aW9uIHN0YXJ0KF94MikgewogICAgICAgICAgcmV0dXJuIF9zdGFydDIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0LnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIF9zdGFydDIudG9TdHJpbmcoKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gc3RhcnQ7CiAgICAgIH0oZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgc3RhcnQodmFsdWUsIGNvbmZpZywgY2FsbGJhY2spOwogICAgICB9KSwKICAgICAgc3RvcDogZnVuY3Rpb24gc3RvcCgpIHsKICAgICAgICB2YWx1ZS5zdG9wQW5pbWF0aW9uKCk7CiAgICAgIH0sCiAgICAgIHJlc2V0OiBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgICB2YWx1ZS5yZXNldEFuaW1hdGlvbigpOwogICAgICB9LAogICAgICBfc3RhcnROYXRpdmVMb29wOiBmdW5jdGlvbiBfc3RhcnROYXRpdmVMb29wKGl0ZXJhdGlvbnMpIHsKICAgICAgICB2YXIgc2luZ2xlQ29uZmlnID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIGNvbmZpZywgewogICAgICAgICAgaXRlcmF0aW9uczogaXRlcmF0aW9ucwogICAgICAgIH0pOwogICAgICAgIHN0YXJ0KHZhbHVlLCBzaW5nbGVDb25maWcpOwogICAgICB9LAogICAgICBfaXNVc2luZ05hdGl2ZURyaXZlcjogZnVuY3Rpb24gX2lzVXNpbmdOYXRpdmVEcml2ZXIoKSB7CiAgICAgICAgcmV0dXJuIGNvbmZpZy51c2VOYXRpdmVEcml2ZXIgfHwgZmFsc2U7CiAgICAgIH0KICAgIH07CiAgfTsKCiAgdmFyIGRlY2F5ID0gZnVuY3Rpb24gZGVjYXkodmFsdWUsIGNvbmZpZykgewogICAgdmFyIHN0YXJ0ID0gZnVuY3Rpb24gc3RhcnQoYW5pbWF0ZWRWYWx1ZSwgY29uZmlndXJhdGlvbiwgY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2sgPSBfY29tYmluZUNhbGxiYWNrcyhjYWxsYmFjaywgY29uZmlndXJhdGlvbik7CiAgICAgIHZhciBzaW5nbGVWYWx1ZSA9IGFuaW1hdGVkVmFsdWU7CiAgICAgIHZhciBzaW5nbGVDb25maWcgPSBjb25maWd1cmF0aW9uOwogICAgICBzaW5nbGVWYWx1ZS5zdG9wVHJhY2tpbmcoKTsKICAgICAgc2luZ2xlVmFsdWUuYW5pbWF0ZShuZXcgRGVjYXlBbmltYXRpb24oc2luZ2xlQ29uZmlnKSwgY2FsbGJhY2spOwogICAgfTsKCiAgICByZXR1cm4gbWF5YmVWZWN0b3JBbmltKHZhbHVlLCBjb25maWcsIGRlY2F5KSB8fCB7CiAgICAgIHN0YXJ0OiBmdW5jdGlvbiAoX3N0YXJ0MykgewogICAgICAgIGZ1bmN0aW9uIHN0YXJ0KF94MykgewogICAgICAgICAgcmV0dXJuIF9zdGFydDMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CgogICAgICAgIHN0YXJ0LnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIF9zdGFydDMudG9TdHJpbmcoKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gc3RhcnQ7CiAgICAgIH0oZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgc3RhcnQodmFsdWUsIGNvbmZpZywgY2FsbGJhY2spOwogICAgICB9KSwKICAgICAgc3RvcDogZnVuY3Rpb24gc3RvcCgpIHsKICAgICAgICB2YWx1ZS5zdG9wQW5pbWF0aW9uKCk7CiAgICAgIH0sCiAgICAgIHJlc2V0OiBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgICB2YWx1ZS5yZXNldEFuaW1hdGlvbigpOwogICAgICB9LAogICAgICBfc3RhcnROYXRpdmVMb29wOiBmdW5jdGlvbiBfc3RhcnROYXRpdmVMb29wKGl0ZXJhdGlvbnMpIHsKICAgICAgICB2YXIgc2luZ2xlQ29uZmlnID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIGNvbmZpZywgewogICAgICAgICAgaXRlcmF0aW9uczogaXRlcmF0aW9ucwogICAgICAgIH0pOwogICAgICAgIHN0YXJ0KHZhbHVlLCBzaW5nbGVDb25maWcpOwogICAgICB9LAogICAgICBfaXNVc2luZ05hdGl2ZURyaXZlcjogZnVuY3Rpb24gX2lzVXNpbmdOYXRpdmVEcml2ZXIoKSB7CiAgICAgICAgcmV0dXJuIGNvbmZpZy51c2VOYXRpdmVEcml2ZXIgfHwgZmFsc2U7CiAgICAgIH0KICAgIH07CiAgfTsKCiAgdmFyIHNlcXVlbmNlID0gZnVuY3Rpb24gc2VxdWVuY2UoYW5pbWF0aW9ucykgewogICAgdmFyIGN1cnJlbnQgPSAwOwogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIHN0YXJ0KGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIG9uQ29tcGxldGUgPSBmdW5jdGlvbiBvbkNvbXBsZXRlKHJlc3VsdCkgewogICAgICAgICAgaWYgKCFyZXN1bHQuZmluaXNoZWQpIHsKICAgICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2socmVzdWx0KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGN1cnJlbnQrKzsKCiAgICAgICAgICBpZiAoY3VycmVudCA9PT0gYW5pbWF0aW9ucy5sZW5ndGgpIHsKICAgICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2socmVzdWx0KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGFuaW1hdGlvbnNbY3VycmVudF0uc3RhcnQob25Db21wbGV0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKGFuaW1hdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayh7CiAgICAgICAgICAgIGZpbmlzaGVkOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYW5pbWF0aW9uc1tjdXJyZW50XS5zdGFydChvbkNvbXBsZXRlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHN0b3A6IGZ1bmN0aW9uIHN0b3AoKSB7CiAgICAgICAgaWYgKGN1cnJlbnQgPCBhbmltYXRpb25zLmxlbmd0aCkgewogICAgICAgICAgYW5pbWF0aW9uc1tjdXJyZW50XS5zdG9wKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICByZXNldDogZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgICAgYW5pbWF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYXRpb24sIGlkeCkgewogICAgICAgICAgaWYgKGlkeCA8PSBjdXJyZW50KSB7CiAgICAgICAgICAgIGFuaW1hdGlvbi5yZXNldCgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGN1cnJlbnQgPSAwOwogICAgICB9LAogICAgICBfc3RhcnROYXRpdmVMb29wOiBmdW5jdGlvbiBfc3RhcnROYXRpdmVMb29wKCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignTG9vcHMgcnVuIHVzaW5nIHRoZSBuYXRpdmUgZHJpdmVyIGNhbm5vdCBjb250YWluIEFuaW1hdGVkLnNlcXVlbmNlIGFuaW1hdGlvbnMnKTsKICAgICAgfSwKICAgICAgX2lzVXNpbmdOYXRpdmVEcml2ZXI6IGZ1bmN0aW9uIF9pc1VzaW5nTmF0aXZlRHJpdmVyKCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfTsKICB9OwoKICB2YXIgcGFyYWxsZWwgPSBmdW5jdGlvbiBwYXJhbGxlbChhbmltYXRpb25zLCBjb25maWcpIHsKICAgIHZhciBkb25lQ291bnQgPSAwOwogICAgdmFyIGhhc0VuZGVkID0ge307CiAgICB2YXIgc3RvcFRvZ2V0aGVyID0gIShjb25maWcgJiYgY29uZmlnLnN0b3BUb2dldGhlciA9PT0gZmFsc2UpOwogICAgdmFyIHJlc3VsdCA9IHsKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIHN0YXJ0KGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKGRvbmVDb3VudCA9PT0gYW5pbWF0aW9ucy5sZW5ndGgpIHsKICAgICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKHsKICAgICAgICAgICAgZmluaXNoZWQ6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgYW5pbWF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYXRpb24sIGlkeCkgewogICAgICAgICAgdmFyIGNiID0gZnVuY3Rpb24gY2IoZW5kUmVzdWx0KSB7CiAgICAgICAgICAgIGhhc0VuZGVkW2lkeF0gPSB0cnVlOwogICAgICAgICAgICBkb25lQ291bnQrKzsKCiAgICAgICAgICAgIGlmIChkb25lQ291bnQgPT09IGFuaW1hdGlvbnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZG9uZUNvdW50ID0gMDsKICAgICAgICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayhlbmRSZXN1bHQpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFlbmRSZXN1bHQuZmluaXNoZWQgJiYgc3RvcFRvZ2V0aGVyKSB7CiAgICAgICAgICAgICAgcmVzdWx0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICBpZiAoIWFuaW1hdGlvbikgewogICAgICAgICAgICBjYih7CiAgICAgICAgICAgICAgZmluaXNoZWQ6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhbmltYXRpb24uc3RhcnQoY2IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiBzdG9wKCkgewogICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAoYW5pbWF0aW9uLCBpZHgpIHsKICAgICAgICAgICFoYXNFbmRlZFtpZHhdICYmIGFuaW1hdGlvbi5zdG9wKCk7CiAgICAgICAgICBoYXNFbmRlZFtpZHhdID0gdHJ1ZTsKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgcmVzZXQ6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgIGFuaW1hdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAoYW5pbWF0aW9uLCBpZHgpIHsKICAgICAgICAgIGFuaW1hdGlvbi5yZXNldCgpOwogICAgICAgICAgaGFzRW5kZWRbaWR4XSA9IGZhbHNlOwogICAgICAgICAgZG9uZUNvdW50ID0gMDsKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgX3N0YXJ0TmF0aXZlTG9vcDogZnVuY3Rpb24gX3N0YXJ0TmF0aXZlTG9vcCgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvb3BzIHJ1biB1c2luZyB0aGUgbmF0aXZlIGRyaXZlciBjYW5ub3QgY29udGFpbiBBbmltYXRlZC5wYXJhbGxlbCBhbmltYXRpb25zJyk7CiAgICAgIH0sCiAgICAgIF9pc1VzaW5nTmF0aXZlRHJpdmVyOiBmdW5jdGlvbiBfaXNVc2luZ05hdGl2ZURyaXZlcigpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIHZhciBkZWxheSA9IGZ1bmN0aW9uIGRlbGF5KHRpbWUpIHsKICAgIHJldHVybiB0aW1pbmcobmV3IEFuaW1hdGVkVmFsdWUoMCksIHsKICAgICAgdG9WYWx1ZTogMCwKICAgICAgZGVsYXk6IHRpbWUsCiAgICAgIGR1cmF0aW9uOiAwCiAgICB9KTsKICB9OwoKICB2YXIgc3RhZ2dlciA9IGZ1bmN0aW9uIHN0YWdnZXIodGltZSwgYW5pbWF0aW9ucykgewogICAgcmV0dXJuIHBhcmFsbGVsKGFuaW1hdGlvbnMubWFwKGZ1bmN0aW9uIChhbmltYXRpb24sIGkpIHsKICAgICAgcmV0dXJuIHNlcXVlbmNlKFtkZWxheSh0aW1lICogaSksIGFuaW1hdGlvbl0pOwogICAgfSkpOwogIH07CgogIHZhciBsb29wID0gZnVuY3Rpb24gbG9vcChhbmltYXRpb24pIHsKICAgIHZhciBfcmVmID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiB7fSwKICAgICAgICBfcmVmJGl0ZXJhdGlvbnMgPSBfcmVmLml0ZXJhdGlvbnMsCiAgICAgICAgaXRlcmF0aW9ucyA9IF9yZWYkaXRlcmF0aW9ucyA9PT0gdW5kZWZpbmVkID8gLTEgOiBfcmVmJGl0ZXJhdGlvbnM7CgogICAgdmFyIGlzRmluaXNoZWQgPSBmYWxzZTsKICAgIHZhciBpdGVyYXRpb25zU29GYXIgPSAwOwogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIHN0YXJ0KGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHJlc3RhcnQgPSBmdW5jdGlvbiByZXN0YXJ0KCkgewogICAgICAgICAgdmFyIHJlc3VsdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogewogICAgICAgICAgICBmaW5pc2hlZDogdHJ1ZQogICAgICAgICAgfTsKCiAgICAgICAgICBpZiAoaXNGaW5pc2hlZCB8fCBpdGVyYXRpb25zU29GYXIgPT09IGl0ZXJhdGlvbnMgfHwgcmVzdWx0LmZpbmlzaGVkID09PSBmYWxzZSkgewogICAgICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayhyZXN1bHQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXRlcmF0aW9uc1NvRmFyKys7CiAgICAgICAgICAgIGFuaW1hdGlvbi5yZXNldCgpOwogICAgICAgICAgICBhbmltYXRpb24uc3RhcnQocmVzdGFydCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgaWYgKCFhbmltYXRpb24gfHwgaXRlcmF0aW9ucyA9PT0gMCkgewogICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soewogICAgICAgICAgICBmaW5pc2hlZDogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChhbmltYXRpb24uX2lzVXNpbmdOYXRpdmVEcml2ZXIoKSkgewogICAgICAgICAgICBhbmltYXRpb24uX3N0YXJ0TmF0aXZlTG9vcChpdGVyYXRpb25zKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3RhcnQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIHN0b3A6IGZ1bmN0aW9uIHN0b3AoKSB7CiAgICAgICAgaXNGaW5pc2hlZCA9IHRydWU7CiAgICAgICAgYW5pbWF0aW9uLnN0b3AoKTsKICAgICAgfSwKICAgICAgcmVzZXQ6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgIGl0ZXJhdGlvbnNTb0ZhciA9IDA7CiAgICAgICAgaXNGaW5pc2hlZCA9IGZhbHNlOwogICAgICAgIGFuaW1hdGlvbi5yZXNldCgpOwogICAgICB9LAogICAgICBfc3RhcnROYXRpdmVMb29wOiBmdW5jdGlvbiBfc3RhcnROYXRpdmVMb29wKCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignTG9vcHMgcnVuIHVzaW5nIHRoZSBuYXRpdmUgZHJpdmVyIGNhbm5vdCBjb250YWluIEFuaW1hdGVkLmxvb3AgYW5pbWF0aW9ucycpOwogICAgICB9LAogICAgICBfaXNVc2luZ05hdGl2ZURyaXZlcjogZnVuY3Rpb24gX2lzVXNpbmdOYXRpdmVEcml2ZXIoKSB7CiAgICAgICAgcmV0dXJuIGFuaW1hdGlvbi5faXNVc2luZ05hdGl2ZURyaXZlcigpOwogICAgICB9CiAgICB9OwogIH07CgogIGZ1bmN0aW9uIGZvcmtFdmVudChldmVudCwgbGlzdGVuZXIpIHsKICAgIGlmICghZXZlbnQpIHsKICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgfSBlbHNlIGlmIChldmVudCBpbnN0YW5jZW9mIEFuaW1hdGVkRXZlbnQpIHsKICAgICAgZXZlbnQuX19hZGRMaXN0ZW5lcihsaXN0ZW5lcik7CgogICAgICByZXR1cm4gZXZlbnQ7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHR5cGVvZiBldmVudCA9PT0gJ2Z1bmN0aW9uJyAmJiBldmVudC5hcHBseSh1bmRlZmluZWQsIGFyZ3VtZW50cyk7CiAgICAgICAgbGlzdGVuZXIuYXBwbHkodW5kZWZpbmVkLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogIH0KCiAgZnVuY3Rpb24gdW5mb3JrRXZlbnQoZXZlbnQsIGxpc3RlbmVyKSB7CiAgICBpZiAoZXZlbnQgJiYgZXZlbnQgaW5zdGFuY2VvZiBBbmltYXRlZEV2ZW50KSB7CiAgICAgIGV2ZW50Ll9fcmVtb3ZlTGlzdGVuZXIobGlzdGVuZXIpOwogICAgfQogIH0KCiAgdmFyIGV2ZW50ID0gZnVuY3Rpb24gZXZlbnQoYXJnTWFwcGluZywgY29uZmlnKSB7CiAgICB2YXIgYW5pbWF0ZWRFdmVudCA9IG5ldyBBbmltYXRlZEV2ZW50KGFyZ01hcHBpbmcsIGNvbmZpZyk7CgogICAgaWYgKGFuaW1hdGVkRXZlbnQuX19pc05hdGl2ZSkgewogICAgICByZXR1cm4gYW5pbWF0ZWRFdmVudDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBhbmltYXRlZEV2ZW50Ll9fZ2V0SGFuZGxlcigpOwogICAgfQogIH07CgogIG1vZHVsZS5leHBvcnRzID0gewogICAgVmFsdWU6IEFuaW1hdGVkVmFsdWUsCiAgICBWYWx1ZVhZOiBBbmltYXRlZFZhbHVlWFksCiAgICBJbnRlcnBvbGF0aW9uOiBBbmltYXRlZEludGVycG9sYXRpb24sCiAgICBOb2RlOiBBbmltYXRlZE5vZGUsCiAgICBkZWNheTogZGVjYXksCiAgICB0aW1pbmc6IHRpbWluZywKICAgIHNwcmluZzogc3ByaW5nLAogICAgYWRkOiBhZGQsCiAgICBkaXZpZGU6IGRpdmlkZSwKICAgIG11bHRpcGx5OiBtdWx0aXBseSwKICAgIG1vZHVsbzogbW9kdWxvLAogICAgZGlmZkNsYW1wOiBkaWZmQ2xhbXAsCiAgICBkZWxheTogZGVsYXksCiAgICBzZXF1ZW5jZTogc2VxdWVuY2UsCiAgICBwYXJhbGxlbDogcGFyYWxsZWwsCiAgICBzdGFnZ2VyOiBzdGFnZ2VyLAogICAgbG9vcDogbG9vcCwKICAgIGV2ZW50OiBldmVudCwKICAgIGNyZWF0ZUFuaW1hdGVkQ29tcG9uZW50OiBjcmVhdGVBbmltYXRlZENvbXBvbmVudCwKICAgIGF0dGFjaE5hdGl2ZUV2ZW50OiBhdHRhY2hOYXRpdmVFdmVudCwKICAgIGZvcmtFdmVudDogZm9ya0V2ZW50LAogICAgdW5mb3JrRXZlbnQ6IHVuZm9ya0V2ZW50LAogICAgX19Qcm9wc09ubHlGb3JUZXN0czogQW5pbWF0ZWRQcm9wcwogIH07Cn0sMTk1LFsxOTYsMjA0LDIwNSwyMDYsMTk4LDIwNywyMDgsMTk5LDIwOSwyMTIsMTk3LDIxMywyMTQsMjE2LDIxOCwyMjFdLCJBbmltYXRlZEltcGxlbWVudGF0aW9uIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgQW5pbWF0ZWRWYWx1ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL25vZGVzL0FuaW1hdGVkVmFsdWUnKTsKCiAgdmFyIE5hdGl2ZUFuaW1hdGVkSGVscGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vTmF0aXZlQW5pbWF0ZWRIZWxwZXInKTsKCiAgdmFyIFJlYWN0TmF0aXZlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlJlYWN0TmF0aXZlIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBfcmVxdWlyZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICcuL05hdGl2ZUFuaW1hdGVkSGVscGVyJyksCiAgICAgIHNob3VsZFVzZU5hdGl2ZURyaXZlciA9IF9yZXF1aXJlLnNob3VsZFVzZU5hdGl2ZURyaXZlcjsKCiAgZnVuY3Rpb24gYXR0YWNoTmF0aXZlRXZlbnQodmlld1JlZiwgZXZlbnROYW1lLCBhcmdNYXBwaW5nKSB7CiAgICB2YXIgZXZlbnRNYXBwaW5ncyA9IFtdOwoKICAgIHZhciB0cmF2ZXJzZSA9IGZ1bmN0aW9uIHRyYXZlcnNlKHZhbHVlLCBwYXRoKSB7CiAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkVmFsdWUpIHsKICAgICAgICB2YWx1ZS5fX21ha2VOYXRpdmUoKTsKCiAgICAgICAgZXZlbnRNYXBwaW5ncy5wdXNoKHsKICAgICAgICAgIG5hdGl2ZUV2ZW50UGF0aDogcGF0aCwKICAgICAgICAgIGFuaW1hdGVkVmFsdWVUYWc6IHZhbHVlLl9fZ2V0TmF0aXZlVGFnKCkKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7CiAgICAgICAgZm9yICh2YXIgX2tleSBpbiB2YWx1ZSkgewogICAgICAgICAgdHJhdmVyc2UodmFsdWVbX2tleV0sIHBhdGguY29uY2F0KF9rZXkpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgaW52YXJpYW50KGFyZ01hcHBpbmdbMF0gJiYgYXJnTWFwcGluZ1swXS5uYXRpdmVFdmVudCwgJ05hdGl2ZSBkcml2ZW4gZXZlbnRzIG9ubHkgc3VwcG9ydCBhbmltYXRlZCB2YWx1ZXMgY29udGFpbmVkIGluc2lkZSBgbmF0aXZlRXZlbnRgLicpOwogICAgdHJhdmVyc2UoYXJnTWFwcGluZ1swXS5uYXRpdmVFdmVudCwgW10pOwogICAgdmFyIHZpZXdUYWcgPSBSZWFjdE5hdGl2ZS5maW5kTm9kZUhhbmRsZSh2aWV3UmVmKTsKICAgIGV2ZW50TWFwcGluZ3MuZm9yRWFjaChmdW5jdGlvbiAobWFwcGluZykgewogICAgICBOYXRpdmVBbmltYXRlZEhlbHBlci5BUEkuYWRkQW5pbWF0ZWRFdmVudFRvVmlldyh2aWV3VGFnLCBldmVudE5hbWUsIG1hcHBpbmcpOwogICAgfSk7CiAgICByZXR1cm4gewogICAgICBkZXRhY2g6IGZ1bmN0aW9uIGRldGFjaCgpIHsKICAgICAgICBldmVudE1hcHBpbmdzLmZvckVhY2goZnVuY3Rpb24gKG1hcHBpbmcpIHsKICAgICAgICAgIE5hdGl2ZUFuaW1hdGVkSGVscGVyLkFQSS5yZW1vdmVBbmltYXRlZEV2ZW50RnJvbVZpZXcodmlld1RhZywgZXZlbnROYW1lLCBtYXBwaW5nLmFuaW1hdGVkVmFsdWVUYWcpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogIH0KCiAgdmFyIEFuaW1hdGVkRXZlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBBbmltYXRlZEV2ZW50KGFyZ01hcHBpbmcpIHsKICAgICAgdmFyIGNvbmZpZyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDoge307CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBBbmltYXRlZEV2ZW50KTsKICAgICAgdGhpcy5fbGlzdGVuZXJzID0gW107CiAgICAgIHRoaXMuX2FyZ01hcHBpbmcgPSBhcmdNYXBwaW5nOwoKICAgICAgaWYgKGNvbmZpZy5saXN0ZW5lcikgewogICAgICAgIHRoaXMuX19hZGRMaXN0ZW5lcihjb25maWcubGlzdGVuZXIpOwogICAgICB9CgogICAgICB0aGlzLl9jYWxsTGlzdGVuZXJzID0gdGhpcy5fY2FsbExpc3RlbmVycy5iaW5kKHRoaXMpOwogICAgICB0aGlzLl9hdHRhY2hlZEV2ZW50ID0gbnVsbDsKICAgICAgdGhpcy5fX2lzTmF0aXZlID0gc2hvdWxkVXNlTmF0aXZlRHJpdmVyKGNvbmZpZyk7CgogICAgICBpZiAoX19ERVZfXykgewogICAgICAgIHRoaXMuX3ZhbGlkYXRlTWFwcGluZygpOwogICAgICB9CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEFuaW1hdGVkRXZlbnQsIFt7CiAgICAgIGtleTogIl9fYWRkTGlzdGVuZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19hZGRMaXN0ZW5lcihjYWxsYmFjaykgewogICAgICAgIHRoaXMuX2xpc3RlbmVycy5wdXNoKGNhbGxiYWNrKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX3JlbW92ZUxpc3RlbmVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fcmVtb3ZlTGlzdGVuZXIoY2FsbGJhY2spIHsKICAgICAgICB0aGlzLl9saXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnMuZmlsdGVyKGZ1bmN0aW9uIChsaXN0ZW5lcikgewogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyICE9PSBjYWxsYmFjazsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2F0dGFjaCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2F0dGFjaCh2aWV3UmVmLCBldmVudE5hbWUpIHsKICAgICAgICBpbnZhcmlhbnQodGhpcy5fX2lzTmF0aXZlLCAnT25seSBuYXRpdmUgZHJpdmVuIGV2ZW50cyBuZWVkIHRvIGJlIGF0dGFjaGVkLicpOwogICAgICAgIHRoaXMuX2F0dGFjaGVkRXZlbnQgPSBhdHRhY2hOYXRpdmVFdmVudCh2aWV3UmVmLCBldmVudE5hbWUsIHRoaXMuX2FyZ01hcHBpbmcpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZGV0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZGV0YWNoKHZpZXdUYWcsIGV2ZW50TmFtZSkgewogICAgICAgIGludmFyaWFudCh0aGlzLl9faXNOYXRpdmUsICdPbmx5IG5hdGl2ZSBkcml2ZW4gZXZlbnRzIG5lZWQgdG8gYmUgZGV0YWNoZWQuJyk7CiAgICAgICAgdGhpcy5fYXR0YWNoZWRFdmVudCAmJiB0aGlzLl9hdHRhY2hlZEV2ZW50LmRldGFjaCgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ2V0SGFuZGxlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2dldEhhbmRsZXIoKSB7CiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgaWYgKHRoaXMuX19pc05hdGl2ZSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX2NhbGxMaXN0ZW5lcnM7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleTIgPSAwOyBfa2V5MiA8IF9sZW47IF9rZXkyKyspIHsKICAgICAgICAgICAgYXJnc1tfa2V5Ml0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciB0cmF2ZXJzZSA9IGZ1bmN0aW9uIHRyYXZlcnNlKHJlY01hcHBpbmcsIHJlY0V2dCwga2V5KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVjRXZ0ID09PSAnbnVtYmVyJyAmJiByZWNNYXBwaW5nIGluc3RhbmNlb2YgQW5pbWF0ZWRWYWx1ZSkgewogICAgICAgICAgICAgIHJlY01hcHBpbmcuc2V0VmFsdWUocmVjRXZ0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVjTWFwcGluZyA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBtYXBwaW5nS2V5IGluIHJlY01hcHBpbmcpIHsKICAgICAgICAgICAgICAgIHRyYXZlcnNlKHJlY01hcHBpbmdbbWFwcGluZ0tleV0sIHJlY0V2dFttYXBwaW5nS2V5XSwgbWFwcGluZ0tleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIGlmICghX3RoaXMuX19pc05hdGl2ZSkgewogICAgICAgICAgICBfdGhpcy5fYXJnTWFwcGluZy5mb3JFYWNoKGZ1bmN0aW9uIChtYXBwaW5nLCBpZHgpIHsKICAgICAgICAgICAgICB0cmF2ZXJzZShtYXBwaW5nLCBhcmdzW2lkeF0sICdhcmcnICsgaWR4KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgX3RoaXMuX2NhbGxMaXN0ZW5lcnMuYXBwbHkoX3RoaXMsIGJhYmVsSGVscGVycy50b0NvbnN1bWFibGVBcnJheShhcmdzKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfY2FsbExpc3RlbmVycyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfY2FsbExpc3RlbmVycygpIHsKICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMiksIF9rZXkzID0gMDsgX2tleTMgPCBfbGVuMjsgX2tleTMrKykgewogICAgICAgICAgYXJnc1tfa2V5M10gPSBhcmd1bWVudHNbX2tleTNdOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fbGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24gKGxpc3RlbmVyKSB7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfdmFsaWRhdGVNYXBwaW5nIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF92YWxpZGF0ZU1hcHBpbmcoKSB7CiAgICAgICAgdmFyIHRyYXZlcnNlID0gZnVuY3Rpb24gdHJhdmVyc2UocmVjTWFwcGluZywgcmVjRXZ0LCBrZXkpIHsKICAgICAgICAgIGlmICh0eXBlb2YgcmVjRXZ0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICBpbnZhcmlhbnQocmVjTWFwcGluZyBpbnN0YW5jZW9mIEFuaW1hdGVkVmFsdWUsICdCYWQgbWFwcGluZyBvZiB0eXBlICcgKyB0eXBlb2YgcmVjTWFwcGluZyArICcgZm9yIGtleSAnICsga2V5ICsgJywgZXZlbnQgdmFsdWUgbXVzdCBtYXAgdG8gQW5pbWF0ZWRWYWx1ZScpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgaW52YXJpYW50KHR5cGVvZiByZWNNYXBwaW5nID09PSAnb2JqZWN0JywgJ0JhZCBtYXBwaW5nIG9mIHR5cGUgJyArIHR5cGVvZiByZWNNYXBwaW5nICsgJyBmb3Iga2V5ICcgKyBrZXkpOwogICAgICAgICAgaW52YXJpYW50KHR5cGVvZiByZWNFdnQgPT09ICdvYmplY3QnLCAnQmFkIGV2ZW50IG9mIHR5cGUgJyArIHR5cGVvZiByZWNFdnQgKyAnIGZvciBrZXkgJyArIGtleSk7CgogICAgICAgICAgZm9yICh2YXIgbWFwcGluZ0tleSBpbiByZWNNYXBwaW5nKSB7CiAgICAgICAgICAgIHRyYXZlcnNlKHJlY01hcHBpbmdbbWFwcGluZ0tleV0sIHJlY0V2dFttYXBwaW5nS2V5XSwgbWFwcGluZ0tleSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEFuaW1hdGVkRXZlbnQ7CiAgfSgpOwoKICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIEFuaW1hdGVkRXZlbnQ6IEFuaW1hdGVkRXZlbnQsCiAgICBhdHRhY2hOYXRpdmVFdmVudDogYXR0YWNoTmF0aXZlRXZlbnQKICB9Owp9LDE5NixbMTk3LDIwMCwyMSwxM10sIkFuaW1hdGVkRXZlbnQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBBbmltYXRlZEludGVycG9sYXRpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9BbmltYXRlZEludGVycG9sYXRpb24nKTsKCiAgdmFyIEFuaW1hdGVkTm9kZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICcuL0FuaW1hdGVkTm9kZScpOwoKICB2YXIgQW5pbWF0ZWRXaXRoQ2hpbGRyZW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAnLi9BbmltYXRlZFdpdGhDaGlsZHJlbicpOwoKICB2YXIgSW50ZXJhY3Rpb25NYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIkludGVyYWN0aW9uTWFuYWdlciIpOwoKICB2YXIgTmF0aXZlQW5pbWF0ZWRIZWxwZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAnLi4vTmF0aXZlQW5pbWF0ZWRIZWxwZXInKTsKCiAgdmFyIE5hdGl2ZUFuaW1hdGVkQVBJID0gTmF0aXZlQW5pbWF0ZWRIZWxwZXIuQVBJOwogIHZhciBfdW5pcXVlSWQgPSAxOwoKICBmdW5jdGlvbiBfZmx1c2gocm9vdE5vZGUpIHsKICAgIHZhciBhbmltYXRlZFN0eWxlcyA9IG5ldyBTZXQoKTsKCiAgICBmdW5jdGlvbiBmaW5kQW5pbWF0ZWRTdHlsZXMobm9kZSkgewogICAgICBpZiAodHlwZW9mIG5vZGUudXBkYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgYW5pbWF0ZWRTdHlsZXMuYWRkKG5vZGUpOwogICAgICB9IGVsc2UgewogICAgICAgIG5vZGUuX19nZXRDaGlsZHJlbigpLmZvckVhY2goZmluZEFuaW1hdGVkU3R5bGVzKTsKICAgICAgfQogICAgfQoKICAgIGZpbmRBbmltYXRlZFN0eWxlcyhyb290Tm9kZSk7CiAgICBhbmltYXRlZFN0eWxlcy5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYXRlZFN0eWxlKSB7CiAgICAgIHJldHVybiBhbmltYXRlZFN0eWxlLnVwZGF0ZSgpOwogICAgfSk7CiAgfQoKICB2YXIgQW5pbWF0ZWRWYWx1ZSA9IGZ1bmN0aW9uIChfQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhBbmltYXRlZFZhbHVlLCBfQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pOwoKICAgIGZ1bmN0aW9uIEFuaW1hdGVkVmFsdWUodmFsdWUpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEFuaW1hdGVkVmFsdWUpOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKEFuaW1hdGVkVmFsdWUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBbmltYXRlZFZhbHVlKSkuY2FsbCh0aGlzKSk7CgogICAgICBfdGhpcy5fc3RhcnRpbmdWYWx1ZSA9IF90aGlzLl92YWx1ZSA9IHZhbHVlOwogICAgICBfdGhpcy5fb2Zmc2V0ID0gMDsKICAgICAgX3RoaXMuX2FuaW1hdGlvbiA9IG51bGw7CiAgICAgIF90aGlzLl9saXN0ZW5lcnMgPSB7fTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhBbmltYXRlZFZhbHVlLCBbewogICAgICBrZXk6ICJfX2RldGFjaCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2RldGFjaCgpIHsKICAgICAgICB0aGlzLnN0b3BBbmltYXRpb24oKTsKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KEFuaW1hdGVkVmFsdWUucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWRWYWx1ZS5wcm90b3R5cGUpLCAiX19kZXRhY2giLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ2V0VmFsdWUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXRWYWx1ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdmFsdWUgKyB0aGlzLl9vZmZzZXQ7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19tYWtlTmF0aXZlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fbWFrZU5hdGl2ZSgpIHsKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KEFuaW1hdGVkVmFsdWUucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWRWYWx1ZS5wcm90b3R5cGUpLCAiX19tYWtlTmF0aXZlIiwgdGhpcykuY2FsbCh0aGlzKTsKCiAgICAgICAgaWYgKE9iamVjdC5rZXlzKHRoaXMuX2xpc3RlbmVycykubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLl9zdGFydExpc3RlbmluZ1RvTmF0aXZlVmFsdWVVcGRhdGVzKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNldFZhbHVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgaWYgKHRoaXMuX2FuaW1hdGlvbikgewogICAgICAgICAgdGhpcy5fYW5pbWF0aW9uLnN0b3AoKTsKCiAgICAgICAgICB0aGlzLl9hbmltYXRpb24gPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fdXBkYXRlVmFsdWUodmFsdWUsICF0aGlzLl9faXNOYXRpdmUpOwoKICAgICAgICBpZiAodGhpcy5fX2lzTmF0aXZlKSB7CiAgICAgICAgICBOYXRpdmVBbmltYXRlZEFQSS5zZXRBbmltYXRlZE5vZGVWYWx1ZSh0aGlzLl9fZ2V0TmF0aXZlVGFnKCksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2V0T2Zmc2V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldE9mZnNldChvZmZzZXQpIHsKICAgICAgICB0aGlzLl9vZmZzZXQgPSBvZmZzZXQ7CgogICAgICAgIGlmICh0aGlzLl9faXNOYXRpdmUpIHsKICAgICAgICAgIE5hdGl2ZUFuaW1hdGVkQVBJLnNldEFuaW1hdGVkTm9kZU9mZnNldCh0aGlzLl9fZ2V0TmF0aXZlVGFnKCksIG9mZnNldCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImZsYXR0ZW5PZmZzZXQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZmxhdHRlbk9mZnNldCgpIHsKICAgICAgICB0aGlzLl92YWx1ZSArPSB0aGlzLl9vZmZzZXQ7CiAgICAgICAgdGhpcy5fb2Zmc2V0ID0gMDsKCiAgICAgICAgaWYgKHRoaXMuX19pc05hdGl2ZSkgewogICAgICAgICAgTmF0aXZlQW5pbWF0ZWRBUEkuZmxhdHRlbkFuaW1hdGVkTm9kZU9mZnNldCh0aGlzLl9fZ2V0TmF0aXZlVGFnKCkpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJleHRyYWN0T2Zmc2V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGV4dHJhY3RPZmZzZXQoKSB7CiAgICAgICAgdGhpcy5fb2Zmc2V0ICs9IHRoaXMuX3ZhbHVlOwogICAgICAgIHRoaXMuX3ZhbHVlID0gMDsKCiAgICAgICAgaWYgKHRoaXMuX19pc05hdGl2ZSkgewogICAgICAgICAgTmF0aXZlQW5pbWF0ZWRBUEkuZXh0cmFjdEFuaW1hdGVkTm9kZU9mZnNldCh0aGlzLl9fZ2V0TmF0aXZlVGFnKCkpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJhZGRMaXN0ZW5lciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRMaXN0ZW5lcihjYWxsYmFjaykgewogICAgICAgIHZhciBpZCA9IFN0cmluZyhfdW5pcXVlSWQrKyk7CiAgICAgICAgdGhpcy5fbGlzdGVuZXJzW2lkXSA9IGNhbGxiYWNrOwoKICAgICAgICBpZiAodGhpcy5fX2lzTmF0aXZlKSB7CiAgICAgICAgICB0aGlzLl9zdGFydExpc3RlbmluZ1RvTmF0aXZlVmFsdWVVcGRhdGVzKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaWQ7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVtb3ZlTGlzdGVuZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIoaWQpIHsKICAgICAgICBkZWxldGUgdGhpcy5fbGlzdGVuZXJzW2lkXTsKCiAgICAgICAgaWYgKHRoaXMuX19pc05hdGl2ZSAmJiBPYmplY3Qua2V5cyh0aGlzLl9saXN0ZW5lcnMpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgdGhpcy5fc3RvcExpc3RlbmluZ0Zvck5hdGl2ZVZhbHVlVXBkYXRlcygpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW1vdmVBbGxMaXN0ZW5lcnMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKCkgewogICAgICAgIHRoaXMuX2xpc3RlbmVycyA9IHt9OwoKICAgICAgICBpZiAodGhpcy5fX2lzTmF0aXZlKSB7CiAgICAgICAgICB0aGlzLl9zdG9wTGlzdGVuaW5nRm9yTmF0aXZlVmFsdWVVcGRhdGVzKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9zdGFydExpc3RlbmluZ1RvTmF0aXZlVmFsdWVVcGRhdGVzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9zdGFydExpc3RlbmluZ1RvTmF0aXZlVmFsdWVVcGRhdGVzKCkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICBpZiAodGhpcy5fX25hdGl2ZUFuaW1hdGVkVmFsdWVMaXN0ZW5lcikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgTmF0aXZlQW5pbWF0ZWRBUEkuc3RhcnRMaXN0ZW5pbmdUb0FuaW1hdGVkTm9kZVZhbHVlKHRoaXMuX19nZXROYXRpdmVUYWcoKSk7CiAgICAgICAgdGhpcy5fX25hdGl2ZUFuaW1hdGVkVmFsdWVMaXN0ZW5lciA9IE5hdGl2ZUFuaW1hdGVkSGVscGVyLm5hdGl2ZUV2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcignb25BbmltYXRlZFZhbHVlVXBkYXRlJywgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLnRhZyAhPT0gX3RoaXMyLl9fZ2V0TmF0aXZlVGFnKCkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIF90aGlzMi5fdXBkYXRlVmFsdWUoZGF0YS52YWx1ZSwgZmFsc2UpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9zdG9wTGlzdGVuaW5nRm9yTmF0aXZlVmFsdWVVcGRhdGVzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9zdG9wTGlzdGVuaW5nRm9yTmF0aXZlVmFsdWVVcGRhdGVzKCkgewogICAgICAgIGlmICghdGhpcy5fX25hdGl2ZUFuaW1hdGVkVmFsdWVMaXN0ZW5lcikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fX25hdGl2ZUFuaW1hdGVkVmFsdWVMaXN0ZW5lci5yZW1vdmUoKTsKCiAgICAgICAgdGhpcy5fX25hdGl2ZUFuaW1hdGVkVmFsdWVMaXN0ZW5lciA9IG51bGw7CiAgICAgICAgTmF0aXZlQW5pbWF0ZWRBUEkuc3RvcExpc3RlbmluZ1RvQW5pbWF0ZWROb2RlVmFsdWUodGhpcy5fX2dldE5hdGl2ZVRhZygpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzdG9wQW5pbWF0aW9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHN0b3BBbmltYXRpb24oY2FsbGJhY2spIHsKICAgICAgICB0aGlzLnN0b3BUcmFja2luZygpOwogICAgICAgIHRoaXMuX2FuaW1hdGlvbiAmJiB0aGlzLl9hbmltYXRpb24uc3RvcCgpOwogICAgICAgIHRoaXMuX2FuaW1hdGlvbiA9IG51bGw7CiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2sodGhpcy5fX2dldFZhbHVlKCkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlc2V0QW5pbWF0aW9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlc2V0QW5pbWF0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5zdG9wQW5pbWF0aW9uKGNhbGxiYWNrKTsKICAgICAgICB0aGlzLl92YWx1ZSA9IHRoaXMuX3N0YXJ0aW5nVmFsdWU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaW50ZXJwb2xhdGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gaW50ZXJwb2xhdGUoY29uZmlnKSB7CiAgICAgICAgcmV0dXJuIG5ldyBBbmltYXRlZEludGVycG9sYXRpb24odGhpcywgY29uZmlnKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJhbmltYXRlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGFuaW1hdGUoYW5pbWF0aW9uLCBjYWxsYmFjaykgewogICAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgICB2YXIgaGFuZGxlID0gbnVsbDsKCiAgICAgICAgaWYgKGFuaW1hdGlvbi5fX2lzSW50ZXJhY3Rpb24pIHsKICAgICAgICAgIGhhbmRsZSA9IEludGVyYWN0aW9uTWFuYWdlci5jcmVhdGVJbnRlcmFjdGlvbkhhbmRsZSgpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHByZXZpb3VzQW5pbWF0aW9uID0gdGhpcy5fYW5pbWF0aW9uOwogICAgICAgIHRoaXMuX2FuaW1hdGlvbiAmJiB0aGlzLl9hbmltYXRpb24uc3RvcCgpOwogICAgICAgIHRoaXMuX2FuaW1hdGlvbiA9IGFuaW1hdGlvbjsKICAgICAgICBhbmltYXRpb24uc3RhcnQodGhpcy5fdmFsdWUsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgX3RoaXMzLl91cGRhdGVWYWx1ZSh2YWx1ZSwgdHJ1ZSk7CiAgICAgICAgfSwgZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgX3RoaXMzLl9hbmltYXRpb24gPSBudWxsOwoKICAgICAgICAgIGlmIChoYW5kbGUgIT09IG51bGwpIHsKICAgICAgICAgICAgSW50ZXJhY3Rpb25NYW5hZ2VyLmNsZWFySW50ZXJhY3Rpb25IYW5kbGUoaGFuZGxlKTsKICAgICAgICAgIH0KCiAgICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayhyZXN1bHQpOwogICAgICAgIH0sIHByZXZpb3VzQW5pbWF0aW9uLCB0aGlzKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzdG9wVHJhY2tpbmciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc3RvcFRyYWNraW5nKCkgewogICAgICAgIHRoaXMuX3RyYWNraW5nICYmIHRoaXMuX3RyYWNraW5nLl9fZGV0YWNoKCk7CiAgICAgICAgdGhpcy5fdHJhY2tpbmcgPSBudWxsOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInRyYWNrIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHRyYWNrKHRyYWNraW5nKSB7CiAgICAgICAgdGhpcy5zdG9wVHJhY2tpbmcoKTsKICAgICAgICB0aGlzLl90cmFja2luZyA9IHRyYWNraW5nOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl91cGRhdGVWYWx1ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfdXBkYXRlVmFsdWUodmFsdWUsIGZsdXNoKSB7CiAgICAgICAgdGhpcy5fdmFsdWUgPSB2YWx1ZTsKCiAgICAgICAgaWYgKGZsdXNoKSB7CiAgICAgICAgICBfZmx1c2godGhpcyk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBfa2V5IGluIHRoaXMuX2xpc3RlbmVycykgewogICAgICAgICAgdGhpcy5fbGlzdGVuZXJzW19rZXldKHsKICAgICAgICAgICAgdmFsdWU6IHRoaXMuX19nZXRWYWx1ZSgpCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXROYXRpdmVDb25maWciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXROYXRpdmVDb25maWcoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICd2YWx1ZScsCiAgICAgICAgICB2YWx1ZTogdGhpcy5fdmFsdWUsCiAgICAgICAgICBvZmZzZXQ6IHRoaXMuX29mZnNldAogICAgICAgIH07CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBBbmltYXRlZFZhbHVlOwogIH0oQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pOwoKICBtb2R1bGUuZXhwb3J0cyA9IEFuaW1hdGVkVmFsdWU7Cn0sMTk3LFsxOTgsMTk5LDIwMSwyMDIsMjAwXSwiQW5pbWF0ZWRWYWx1ZSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9jbGFzcywgX3RlbXA7CgogIHZhciBBbmltYXRlZE5vZGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9BbmltYXRlZE5vZGUnKTsKCiAgdmFyIEFuaW1hdGVkV2l0aENoaWxkcmVuID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vQW5pbWF0ZWRXaXRoQ2hpbGRyZW4nKTsKCiAgdmFyIE5hdGl2ZUFuaW1hdGVkSGVscGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgJy4uL05hdGl2ZUFuaW1hdGVkSGVscGVyJyk7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBub3JtYWxpemVDb2xvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJub3JtYWxpemVDb2xvciIpOwoKICB2YXIgbGluZWFyID0gZnVuY3Rpb24gbGluZWFyKHQpIHsKICAgIHJldHVybiB0OwogIH07CgogIGZ1bmN0aW9uIGNyZWF0ZUludGVycG9sYXRpb24oY29uZmlnKSB7CiAgICBpZiAoY29uZmlnLm91dHB1dFJhbmdlICYmIHR5cGVvZiBjb25maWcub3V0cHV0UmFuZ2VbMF0gPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBjcmVhdGVJbnRlcnBvbGF0aW9uRnJvbVN0cmluZ091dHB1dFJhbmdlKGNvbmZpZyk7CiAgICB9CgogICAgdmFyIG91dHB1dFJhbmdlID0gY29uZmlnLm91dHB1dFJhbmdlOwogICAgY2hlY2tJbmZpbml0ZVJhbmdlKCdvdXRwdXRSYW5nZScsIG91dHB1dFJhbmdlKTsKICAgIHZhciBpbnB1dFJhbmdlID0gY29uZmlnLmlucHV0UmFuZ2U7CiAgICBjaGVja0luZmluaXRlUmFuZ2UoJ2lucHV0UmFuZ2UnLCBpbnB1dFJhbmdlKTsKICAgIGNoZWNrVmFsaWRJbnB1dFJhbmdlKGlucHV0UmFuZ2UpOwogICAgaW52YXJpYW50KGlucHV0UmFuZ2UubGVuZ3RoID09PSBvdXRwdXRSYW5nZS5sZW5ndGgsICdpbnB1dFJhbmdlICgnICsgaW5wdXRSYW5nZS5sZW5ndGggKyAnKSBhbmQgb3V0cHV0UmFuZ2UgKCcgKyBvdXRwdXRSYW5nZS5sZW5ndGggKyAnKSBtdXN0IGhhdmUgdGhlIHNhbWUgbGVuZ3RoJyk7CiAgICB2YXIgZWFzaW5nID0gY29uZmlnLmVhc2luZyB8fCBsaW5lYXI7CiAgICB2YXIgZXh0cmFwb2xhdGVMZWZ0ID0gJ2V4dGVuZCc7CgogICAgaWYgKGNvbmZpZy5leHRyYXBvbGF0ZUxlZnQgIT09IHVuZGVmaW5lZCkgewogICAgICBleHRyYXBvbGF0ZUxlZnQgPSBjb25maWcuZXh0cmFwb2xhdGVMZWZ0OwogICAgfSBlbHNlIGlmIChjb25maWcuZXh0cmFwb2xhdGUgIT09IHVuZGVmaW5lZCkgewogICAgICBleHRyYXBvbGF0ZUxlZnQgPSBjb25maWcuZXh0cmFwb2xhdGU7CiAgICB9CgogICAgdmFyIGV4dHJhcG9sYXRlUmlnaHQgPSAnZXh0ZW5kJzsKCiAgICBpZiAoY29uZmlnLmV4dHJhcG9sYXRlUmlnaHQgIT09IHVuZGVmaW5lZCkgewogICAgICBleHRyYXBvbGF0ZVJpZ2h0ID0gY29uZmlnLmV4dHJhcG9sYXRlUmlnaHQ7CiAgICB9IGVsc2UgaWYgKGNvbmZpZy5leHRyYXBvbGF0ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGV4dHJhcG9sYXRlUmlnaHQgPSBjb25maWcuZXh0cmFwb2xhdGU7CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uIChpbnB1dCkgewogICAgICBpbnZhcmlhbnQodHlwZW9mIGlucHV0ID09PSAnbnVtYmVyJywgJ0Nhbm5vdCBpbnRlcnBvbGF0aW9uIGFuIGlucHV0IHdoaWNoIGlzIG5vdCBhIG51bWJlcicpOwogICAgICB2YXIgcmFuZ2UgPSBmaW5kUmFuZ2UoaW5wdXQsIGlucHV0UmFuZ2UpOwogICAgICByZXR1cm4gaW50ZXJwb2xhdGUoaW5wdXQsIGlucHV0UmFuZ2VbcmFuZ2VdLCBpbnB1dFJhbmdlW3JhbmdlICsgMV0sIG91dHB1dFJhbmdlW3JhbmdlXSwgb3V0cHV0UmFuZ2VbcmFuZ2UgKyAxXSwgZWFzaW5nLCBleHRyYXBvbGF0ZUxlZnQsIGV4dHJhcG9sYXRlUmlnaHQpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGludGVycG9sYXRlKGlucHV0LCBpbnB1dE1pbiwgaW5wdXRNYXgsIG91dHB1dE1pbiwgb3V0cHV0TWF4LCBlYXNpbmcsIGV4dHJhcG9sYXRlTGVmdCwgZXh0cmFwb2xhdGVSaWdodCkgewogICAgdmFyIHJlc3VsdCA9IGlucHV0OwoKICAgIGlmIChyZXN1bHQgPCBpbnB1dE1pbikgewogICAgICBpZiAoZXh0cmFwb2xhdGVMZWZ0ID09PSAnaWRlbnRpdHknKSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSBlbHNlIGlmIChleHRyYXBvbGF0ZUxlZnQgPT09ICdjbGFtcCcpIHsKICAgICAgICByZXN1bHQgPSBpbnB1dE1pbjsKICAgICAgfSBlbHNlIGlmIChleHRyYXBvbGF0ZUxlZnQgPT09ICdleHRlbmQnKSB7fQogICAgfQoKICAgIGlmIChyZXN1bHQgPiBpbnB1dE1heCkgewogICAgICBpZiAoZXh0cmFwb2xhdGVSaWdodCA9PT0gJ2lkZW50aXR5JykgewogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0gZWxzZSBpZiAoZXh0cmFwb2xhdGVSaWdodCA9PT0gJ2NsYW1wJykgewogICAgICAgIHJlc3VsdCA9IGlucHV0TWF4OwogICAgICB9IGVsc2UgaWYgKGV4dHJhcG9sYXRlUmlnaHQgPT09ICdleHRlbmQnKSB7fQogICAgfQoKICAgIGlmIChvdXRwdXRNaW4gPT09IG91dHB1dE1heCkgewogICAgICByZXR1cm4gb3V0cHV0TWluOwogICAgfQoKICAgIGlmIChpbnB1dE1pbiA9PT0gaW5wdXRNYXgpIHsKICAgICAgaWYgKGlucHV0IDw9IGlucHV0TWluKSB7CiAgICAgICAgcmV0dXJuIG91dHB1dE1pbjsKICAgICAgfQoKICAgICAgcmV0dXJuIG91dHB1dE1heDsKICAgIH0KCiAgICBpZiAoaW5wdXRNaW4gPT09IC1JbmZpbml0eSkgewogICAgICByZXN1bHQgPSAtcmVzdWx0OwogICAgfSBlbHNlIGlmIChpbnB1dE1heCA9PT0gSW5maW5pdHkpIHsKICAgICAgcmVzdWx0ID0gcmVzdWx0IC0gaW5wdXRNaW47CiAgICB9IGVsc2UgewogICAgICByZXN1bHQgPSAocmVzdWx0IC0gaW5wdXRNaW4pIC8gKGlucHV0TWF4IC0gaW5wdXRNaW4pOwogICAgfQoKICAgIHJlc3VsdCA9IGVhc2luZyhyZXN1bHQpOwoKICAgIGlmIChvdXRwdXRNaW4gPT09IC1JbmZpbml0eSkgewogICAgICByZXN1bHQgPSAtcmVzdWx0OwogICAgfSBlbHNlIGlmIChvdXRwdXRNYXggPT09IEluZmluaXR5KSB7CiAgICAgIHJlc3VsdCA9IHJlc3VsdCArIG91dHB1dE1pbjsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IHJlc3VsdCAqIChvdXRwdXRNYXggLSBvdXRwdXRNaW4pICsgb3V0cHV0TWluOwogICAgfQoKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiBjb2xvclRvUmdiYShpbnB1dCkgewogICAgdmFyIGludDMyQ29sb3IgPSBub3JtYWxpemVDb2xvcihpbnB1dCk7CgogICAgaWYgKGludDMyQ29sb3IgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIGlucHV0OwogICAgfQoKICAgIGludDMyQ29sb3IgPSBpbnQzMkNvbG9yIHx8IDA7CiAgICB2YXIgciA9IChpbnQzMkNvbG9yICYgMHhmZjAwMDAwMCkgPj4+IDI0OwogICAgdmFyIGcgPSAoaW50MzJDb2xvciAmIDB4MDBmZjAwMDApID4+PiAxNjsKICAgIHZhciBiID0gKGludDMyQ29sb3IgJiAweDAwMDBmZjAwKSA+Pj4gODsKICAgIHZhciBhID0gKGludDMyQ29sb3IgJiAweDAwMDAwMGZmKSAvIDI1NTsKICAgIHJldHVybiAicmdiYSgiICsgciArICIsICIgKyBnICsgIiwgIiArIGIgKyAiLCAiICsgYSArICIpIjsKICB9CgogIHZhciBzdHJpbmdTaGFwZVJlZ2V4ID0gL1swLTlcLi1dKy9nOwoKICBmdW5jdGlvbiBjcmVhdGVJbnRlcnBvbGF0aW9uRnJvbVN0cmluZ091dHB1dFJhbmdlKGNvbmZpZykgewogICAgdmFyIG91dHB1dFJhbmdlID0gY29uZmlnLm91dHB1dFJhbmdlOwogICAgaW52YXJpYW50KG91dHB1dFJhbmdlLmxlbmd0aCA+PSAyLCAnQmFkIG91dHB1dCByYW5nZScpOwogICAgb3V0cHV0UmFuZ2UgPSBvdXRwdXRSYW5nZS5tYXAoY29sb3JUb1JnYmEpOwogICAgY2hlY2tQYXR0ZXJuKG91dHB1dFJhbmdlKTsKICAgIHZhciBvdXRwdXRSYW5nZXMgPSBvdXRwdXRSYW5nZVswXS5tYXRjaChzdHJpbmdTaGFwZVJlZ2V4KS5tYXAoZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gW107CiAgICB9KTsKICAgIG91dHB1dFJhbmdlLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHZhbHVlLm1hdGNoKHN0cmluZ1NoYXBlUmVnZXgpLmZvckVhY2goZnVuY3Rpb24gKG51bWJlciwgaSkgewogICAgICAgIG91dHB1dFJhbmdlc1tpXS5wdXNoKCtudW1iZXIpOwogICAgICB9KTsKICAgIH0pOwogICAgdmFyIGludGVycG9sYXRpb25zID0gb3V0cHV0UmFuZ2VbMF0ubWF0Y2goc3RyaW5nU2hhcGVSZWdleCkubWFwKGZ1bmN0aW9uICh2YWx1ZSwgaSkgewogICAgICByZXR1cm4gY3JlYXRlSW50ZXJwb2xhdGlvbihiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgY29uZmlnLCB7CiAgICAgICAgb3V0cHV0UmFuZ2U6IG91dHB1dFJhbmdlc1tpXQogICAgICB9KSk7CiAgICB9KTsKICAgIHZhciBzaG91bGRSb3VuZCA9IGlzUmdiT3JSZ2JhKG91dHB1dFJhbmdlWzBdKTsKICAgIHJldHVybiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgdmFyIGkgPSAwOwogICAgICByZXR1cm4gb3V0cHV0UmFuZ2VbMF0ucmVwbGFjZShzdHJpbmdTaGFwZVJlZ2V4LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHZhbCA9ICtpbnRlcnBvbGF0aW9uc1tpKytdKGlucHV0KTsKICAgICAgICB2YXIgcm91bmRlZCA9IHNob3VsZFJvdW5kICYmIGkgPCA0ID8gTWF0aC5yb3VuZCh2YWwpIDogTWF0aC5yb3VuZCh2YWwgKiAxMDAwKSAvIDEwMDA7CiAgICAgICAgcmV0dXJuIFN0cmluZyhyb3VuZGVkKTsKICAgICAgfSk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gaXNSZ2JPclJnYmEocmFuZ2UpIHsKICAgIHJldHVybiB0eXBlb2YgcmFuZ2UgPT09ICdzdHJpbmcnICYmIHJhbmdlLnN0YXJ0c1dpdGgoJ3JnYicpOwogIH0KCiAgZnVuY3Rpb24gY2hlY2tQYXR0ZXJuKGFycikgewogICAgdmFyIHBhdHRlcm4gPSBhcnJbMF0ucmVwbGFjZShzdHJpbmdTaGFwZVJlZ2V4LCAnJyk7CgogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcnIubGVuZ3RoOyArK2kpIHsKICAgICAgaW52YXJpYW50KHBhdHRlcm4gPT09IGFycltpXS5yZXBsYWNlKHN0cmluZ1NoYXBlUmVnZXgsICcnKSwgJ2ludmFsaWQgcGF0dGVybiAnICsgYXJyWzBdICsgJyBhbmQgJyArIGFycltpXSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBmaW5kUmFuZ2UoaW5wdXQsIGlucHV0UmFuZ2UpIHsKICAgIHZhciBpID0gdm9pZCAwOwoKICAgIGZvciAoaSA9IDE7IGkgPCBpbnB1dFJhbmdlLmxlbmd0aCAtIDE7ICsraSkgewogICAgICBpZiAoaW5wdXRSYW5nZVtpXSA+PSBpbnB1dCkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGkgLSAxOwogIH0KCiAgZnVuY3Rpb24gY2hlY2tWYWxpZElucHV0UmFuZ2UoYXJyKSB7CiAgICBpbnZhcmlhbnQoYXJyLmxlbmd0aCA+PSAyLCAnaW5wdXRSYW5nZSBtdXN0IGhhdmUgYXQgbGVhc3QgMiBlbGVtZW50cycpOwoKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJyLmxlbmd0aDsgKytpKSB7CiAgICAgIGludmFyaWFudChhcnJbaV0gPj0gYXJyW2kgLSAxXSwgJ2lucHV0UmFuZ2UgbXVzdCBiZSBtb25vdG9uaWNhbGx5IGluY3JlYXNpbmcgJyArIGFycik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjaGVja0luZmluaXRlUmFuZ2UobmFtZSwgYXJyKSB7CiAgICBpbnZhcmlhbnQoYXJyLmxlbmd0aCA+PSAyLCBuYW1lICsgJyBtdXN0IGhhdmUgYXQgbGVhc3QgMiBlbGVtZW50cycpOwogICAgaW52YXJpYW50KGFyci5sZW5ndGggIT09IDIgfHwgYXJyWzBdICE9PSAtSW5maW5pdHkgfHwgYXJyWzFdICE9PSBJbmZpbml0eSwgbmFtZSArICdjYW5ub3QgYmUgXS1pbmZpbml0eTsraW5maW5pdHlbICcgKyBhcnIpOwogIH0KCiAgdmFyIEFuaW1hdGVkSW50ZXJwb2xhdGlvbiA9IChfdGVtcCA9IF9jbGFzcyA9IGZ1bmN0aW9uIChfQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhBbmltYXRlZEludGVycG9sYXRpb24sIF9BbmltYXRlZFdpdGhDaGlsZHJlbik7CgogICAgZnVuY3Rpb24gQW5pbWF0ZWRJbnRlcnBvbGF0aW9uKHBhcmVudCwgY29uZmlnKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBBbmltYXRlZEludGVycG9sYXRpb24pOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKEFuaW1hdGVkSW50ZXJwb2xhdGlvbi5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEFuaW1hdGVkSW50ZXJwb2xhdGlvbikpLmNhbGwodGhpcykpOwoKICAgICAgX3RoaXMuX3BhcmVudCA9IHBhcmVudDsKICAgICAgX3RoaXMuX2NvbmZpZyA9IGNvbmZpZzsKICAgICAgX3RoaXMuX2ludGVycG9sYXRpb24gPSBjcmVhdGVJbnRlcnBvbGF0aW9uKGNvbmZpZyk7CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQW5pbWF0ZWRJbnRlcnBvbGF0aW9uLCBbewogICAgICBrZXk6ICJfX21ha2VOYXRpdmUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19tYWtlTmF0aXZlKCkgewogICAgICAgIHRoaXMuX3BhcmVudC5fX21ha2VOYXRpdmUoKTsKCiAgICAgICAgYmFiZWxIZWxwZXJzLmdldChBbmltYXRlZEludGVycG9sYXRpb24ucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWRJbnRlcnBvbGF0aW9uLnByb3RvdHlwZSksICJfX21ha2VOYXRpdmUiLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ2V0VmFsdWUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXRWYWx1ZSgpIHsKICAgICAgICB2YXIgcGFyZW50VmFsdWUgPSB0aGlzLl9wYXJlbnQuX19nZXRWYWx1ZSgpOwoKICAgICAgICBpbnZhcmlhbnQodHlwZW9mIHBhcmVudFZhbHVlID09PSAnbnVtYmVyJywgJ0Nhbm5vdCBpbnRlcnBvbGF0ZSBhbiBpbnB1dCB3aGljaCBpcyBub3QgYSBudW1iZXIuJyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ludGVycG9sYXRpb24ocGFyZW50VmFsdWUpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImludGVycG9sYXRlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGludGVycG9sYXRlKGNvbmZpZykgewogICAgICAgIHJldHVybiBuZXcgQW5pbWF0ZWRJbnRlcnBvbGF0aW9uKHRoaXMsIGNvbmZpZyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19hdHRhY2giLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19hdHRhY2goKSB7CiAgICAgICAgdGhpcy5fcGFyZW50Ll9fYWRkQ2hpbGQodGhpcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19kZXRhY2giLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19kZXRhY2goKSB7CiAgICAgICAgdGhpcy5fcGFyZW50Ll9fcmVtb3ZlQ2hpbGQodGhpcyk7CgogICAgICAgIGJhYmVsSGVscGVycy5nZXQoQW5pbWF0ZWRJbnRlcnBvbGF0aW9uLnByb3RvdHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEFuaW1hdGVkSW50ZXJwb2xhdGlvbi5wcm90b3R5cGUpLCAiX19kZXRhY2giLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fdHJhbnNmb3JtRGF0YVR5cGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX190cmFuc2Zvcm1EYXRhVHlwZShyYW5nZSkgewogICAgICAgIHJldHVybiByYW5nZS5tYXAoZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKC9kZWckLy50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICB2YXIgZGVncmVlcyA9IHBhcnNlRmxvYXQodmFsdWUpIHx8IDA7CiAgICAgICAgICAgIHZhciByYWRpYW5zID0gZGVncmVlcyAqIE1hdGguUEkgLyAxODAuMDsKICAgICAgICAgICAgcmV0dXJuIHJhZGlhbnM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcGFyc2VGbG9hdCh2YWx1ZSkgfHwgMDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2dldE5hdGl2ZUNvbmZpZyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2dldE5hdGl2ZUNvbmZpZygpIHsKICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgTmF0aXZlQW5pbWF0ZWRIZWxwZXIudmFsaWRhdGVJbnRlcnBvbGF0aW9uKHRoaXMuX2NvbmZpZyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgaW5wdXRSYW5nZTogdGhpcy5fY29uZmlnLmlucHV0UmFuZ2UsCiAgICAgICAgICBvdXRwdXRSYW5nZTogdGhpcy5fX3RyYW5zZm9ybURhdGFUeXBlKHRoaXMuX2NvbmZpZy5vdXRwdXRSYW5nZSksCiAgICAgICAgICBleHRyYXBvbGF0ZUxlZnQ6IHRoaXMuX2NvbmZpZy5leHRyYXBvbGF0ZUxlZnQgfHwgdGhpcy5fY29uZmlnLmV4dHJhcG9sYXRlIHx8ICdleHRlbmQnLAogICAgICAgICAgZXh0cmFwb2xhdGVSaWdodDogdGhpcy5fY29uZmlnLmV4dHJhcG9sYXRlUmlnaHQgfHwgdGhpcy5fY29uZmlnLmV4dHJhcG9sYXRlIHx8ICdleHRlbmQnLAogICAgICAgICAgdHlwZTogJ2ludGVycG9sYXRpb24nCiAgICAgICAgfTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEFuaW1hdGVkSW50ZXJwb2xhdGlvbjsKICB9KEFuaW1hdGVkV2l0aENoaWxkcmVuKSwgX2NsYXNzLl9fY3JlYXRlSW50ZXJwb2xhdGlvbiA9IGNyZWF0ZUludGVycG9sYXRpb24sIF90ZW1wKTsKICBtb2R1bGUuZXhwb3J0cyA9IEFuaW1hdGVkSW50ZXJwb2xhdGlvbjsKfSwxOTgsWzE5OSwyMDEsMjAwLDEzLDEyNF0sIkFuaW1hdGVkSW50ZXJwb2xhdGlvbiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIE5hdGl2ZUFuaW1hdGVkSGVscGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgJy4uL05hdGl2ZUFuaW1hdGVkSGVscGVyJyk7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBBbmltYXRlZE5vZGUgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBBbmltYXRlZE5vZGUoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBBbmltYXRlZE5vZGUpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhBbmltYXRlZE5vZGUsIFt7CiAgICAgIGtleTogIl9fYXR0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fYXR0YWNoKCkge30KICAgIH0sIHsKICAgICAga2V5OiAiX19kZXRhY2giLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19kZXRhY2goKSB7CiAgICAgICAgaWYgKHRoaXMuX19pc05hdGl2ZSAmJiB0aGlzLl9fbmF0aXZlVGFnICE9IG51bGwpIHsKICAgICAgICAgIE5hdGl2ZUFuaW1hdGVkSGVscGVyLkFQSS5kcm9wQW5pbWF0ZWROb2RlKHRoaXMuX19uYXRpdmVUYWcpOwogICAgICAgICAgdGhpcy5fX25hdGl2ZVRhZyA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXRWYWx1ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2dldFZhbHVlKCkge30KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXRBbmltYXRlZFZhbHVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0QW5pbWF0ZWRWYWx1ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fX2dldFZhbHVlKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19hZGRDaGlsZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2FkZENoaWxkKGNoaWxkKSB7fQogICAgfSwgewogICAgICBrZXk6ICJfX3JlbW92ZUNoaWxkIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fcmVtb3ZlQ2hpbGQoY2hpbGQpIHt9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ2V0Q2hpbGRyZW4iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXRDaGlsZHJlbigpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19tYWtlTmF0aXZlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fbWFrZU5hdGl2ZSgpIHsKICAgICAgICBpZiAoIXRoaXMuX19pc05hdGl2ZSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGlzIG5vZGUgY2Fubm90IGJlIG1hZGUgYSAibmF0aXZlIiBhbmltYXRlZCBub2RlJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ2V0TmF0aXZlVGFnIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0TmF0aXZlVGFnKCkgewogICAgICAgIE5hdGl2ZUFuaW1hdGVkSGVscGVyLmFzc2VydE5hdGl2ZUFuaW1hdGVkTW9kdWxlKCk7CiAgICAgICAgaW52YXJpYW50KHRoaXMuX19pc05hdGl2ZSwgJ0F0dGVtcHQgdG8gZ2V0IG5hdGl2ZSB0YWcgZnJvbSBub2RlIG5vdCBtYXJrZWQgYXMgIm5hdGl2ZSInKTsKCiAgICAgICAgaWYgKHRoaXMuX19uYXRpdmVUYWcgPT0gbnVsbCkgewogICAgICAgICAgdmFyIG5hdGl2ZVRhZyA9IE5hdGl2ZUFuaW1hdGVkSGVscGVyLmdlbmVyYXRlTmV3Tm9kZVRhZygpOwogICAgICAgICAgTmF0aXZlQW5pbWF0ZWRIZWxwZXIuQVBJLmNyZWF0ZUFuaW1hdGVkTm9kZShuYXRpdmVUYWcsIHRoaXMuX19nZXROYXRpdmVDb25maWcoKSk7CiAgICAgICAgICB0aGlzLl9fbmF0aXZlVGFnID0gbmF0aXZlVGFnOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuX19uYXRpdmVUYWc7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXROYXRpdmVDb25maWciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXROYXRpdmVDb25maWcoKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGlzIEpTIGFuaW1hdGVkIG5vZGUgdHlwZSBjYW5ub3QgYmUgdXNlZCBhcyBuYXRpdmUgYW5pbWF0ZWQgbm9kZScpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInRvSlNPTiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiB0b0pTT04oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX19nZXRWYWx1ZSgpOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQW5pbWF0ZWROb2RlOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBBbmltYXRlZE5vZGU7Cn0sMTk5LFsyMDAsMTNdLCJBbmltYXRlZE5vZGUiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBOYXRpdmVBbmltYXRlZE1vZHVsZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIikuTmF0aXZlQW5pbWF0ZWRNb2R1bGU7CgogIHZhciBOYXRpdmVFdmVudEVtaXR0ZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiTmF0aXZlRXZlbnRFbWl0dGVyIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBfX25hdGl2ZUFuaW1hdGVkTm9kZVRhZ0NvdW50ID0gMTsKICB2YXIgX19uYXRpdmVBbmltYXRpb25JZENvdW50ID0gMTsKICB2YXIgbmF0aXZlRXZlbnRFbWl0dGVyID0gdm9pZCAwOwogIHZhciBBUEkgPSB7CiAgICBjcmVhdGVBbmltYXRlZE5vZGU6IGZ1bmN0aW9uIGNyZWF0ZUFuaW1hdGVkTm9kZSh0YWcsIGNvbmZpZykgewogICAgICBhc3NlcnROYXRpdmVBbmltYXRlZE1vZHVsZSgpOwogICAgICBOYXRpdmVBbmltYXRlZE1vZHVsZS5jcmVhdGVBbmltYXRlZE5vZGUodGFnLCBjb25maWcpOwogICAgfSwKICAgIHN0YXJ0TGlzdGVuaW5nVG9BbmltYXRlZE5vZGVWYWx1ZTogZnVuY3Rpb24gc3RhcnRMaXN0ZW5pbmdUb0FuaW1hdGVkTm9kZVZhbHVlKHRhZykgewogICAgICBhc3NlcnROYXRpdmVBbmltYXRlZE1vZHVsZSgpOwogICAgICBOYXRpdmVBbmltYXRlZE1vZHVsZS5zdGFydExpc3RlbmluZ1RvQW5pbWF0ZWROb2RlVmFsdWUodGFnKTsKICAgIH0sCiAgICBzdG9wTGlzdGVuaW5nVG9BbmltYXRlZE5vZGVWYWx1ZTogZnVuY3Rpb24gc3RvcExpc3RlbmluZ1RvQW5pbWF0ZWROb2RlVmFsdWUodGFnKSB7CiAgICAgIGFzc2VydE5hdGl2ZUFuaW1hdGVkTW9kdWxlKCk7CiAgICAgIE5hdGl2ZUFuaW1hdGVkTW9kdWxlLnN0b3BMaXN0ZW5pbmdUb0FuaW1hdGVkTm9kZVZhbHVlKHRhZyk7CiAgICB9LAogICAgY29ubmVjdEFuaW1hdGVkTm9kZXM6IGZ1bmN0aW9uIGNvbm5lY3RBbmltYXRlZE5vZGVzKHBhcmVudFRhZywgY2hpbGRUYWcpIHsKICAgICAgYXNzZXJ0TmF0aXZlQW5pbWF0ZWRNb2R1bGUoKTsKICAgICAgTmF0aXZlQW5pbWF0ZWRNb2R1bGUuY29ubmVjdEFuaW1hdGVkTm9kZXMocGFyZW50VGFnLCBjaGlsZFRhZyk7CiAgICB9LAogICAgZGlzY29ubmVjdEFuaW1hdGVkTm9kZXM6IGZ1bmN0aW9uIGRpc2Nvbm5lY3RBbmltYXRlZE5vZGVzKHBhcmVudFRhZywgY2hpbGRUYWcpIHsKICAgICAgYXNzZXJ0TmF0aXZlQW5pbWF0ZWRNb2R1bGUoKTsKICAgICAgTmF0aXZlQW5pbWF0ZWRNb2R1bGUuZGlzY29ubmVjdEFuaW1hdGVkTm9kZXMocGFyZW50VGFnLCBjaGlsZFRhZyk7CiAgICB9LAogICAgc3RhcnRBbmltYXRpbmdOb2RlOiBmdW5jdGlvbiBzdGFydEFuaW1hdGluZ05vZGUoYW5pbWF0aW9uSWQsIG5vZGVUYWcsIGNvbmZpZywgZW5kQ2FsbGJhY2spIHsKICAgICAgYXNzZXJ0TmF0aXZlQW5pbWF0ZWRNb2R1bGUoKTsKICAgICAgTmF0aXZlQW5pbWF0ZWRNb2R1bGUuc3RhcnRBbmltYXRpbmdOb2RlKGFuaW1hdGlvbklkLCBub2RlVGFnLCBjb25maWcsIGVuZENhbGxiYWNrKTsKICAgIH0sCiAgICBzdG9wQW5pbWF0aW9uOiBmdW5jdGlvbiBzdG9wQW5pbWF0aW9uKGFuaW1hdGlvbklkKSB7CiAgICAgIGFzc2VydE5hdGl2ZUFuaW1hdGVkTW9kdWxlKCk7CiAgICAgIE5hdGl2ZUFuaW1hdGVkTW9kdWxlLnN0b3BBbmltYXRpb24oYW5pbWF0aW9uSWQpOwogICAgfSwKICAgIHNldEFuaW1hdGVkTm9kZVZhbHVlOiBmdW5jdGlvbiBzZXRBbmltYXRlZE5vZGVWYWx1ZShub2RlVGFnLCB2YWx1ZSkgewogICAgICBhc3NlcnROYXRpdmVBbmltYXRlZE1vZHVsZSgpOwogICAgICBOYXRpdmVBbmltYXRlZE1vZHVsZS5zZXRBbmltYXRlZE5vZGVWYWx1ZShub2RlVGFnLCB2YWx1ZSk7CiAgICB9LAogICAgc2V0QW5pbWF0ZWROb2RlT2Zmc2V0OiBmdW5jdGlvbiBzZXRBbmltYXRlZE5vZGVPZmZzZXQobm9kZVRhZywgb2Zmc2V0KSB7CiAgICAgIGFzc2VydE5hdGl2ZUFuaW1hdGVkTW9kdWxlKCk7CiAgICAgIE5hdGl2ZUFuaW1hdGVkTW9kdWxlLnNldEFuaW1hdGVkTm9kZU9mZnNldChub2RlVGFnLCBvZmZzZXQpOwogICAgfSwKICAgIGZsYXR0ZW5BbmltYXRlZE5vZGVPZmZzZXQ6IGZ1bmN0aW9uIGZsYXR0ZW5BbmltYXRlZE5vZGVPZmZzZXQobm9kZVRhZykgewogICAgICBhc3NlcnROYXRpdmVBbmltYXRlZE1vZHVsZSgpOwogICAgICBOYXRpdmVBbmltYXRlZE1vZHVsZS5mbGF0dGVuQW5pbWF0ZWROb2RlT2Zmc2V0KG5vZGVUYWcpOwogICAgfSwKICAgIGV4dHJhY3RBbmltYXRlZE5vZGVPZmZzZXQ6IGZ1bmN0aW9uIGV4dHJhY3RBbmltYXRlZE5vZGVPZmZzZXQobm9kZVRhZykgewogICAgICBhc3NlcnROYXRpdmVBbmltYXRlZE1vZHVsZSgpOwogICAgICBOYXRpdmVBbmltYXRlZE1vZHVsZS5leHRyYWN0QW5pbWF0ZWROb2RlT2Zmc2V0KG5vZGVUYWcpOwogICAgfSwKICAgIGNvbm5lY3RBbmltYXRlZE5vZGVUb1ZpZXc6IGZ1bmN0aW9uIGNvbm5lY3RBbmltYXRlZE5vZGVUb1ZpZXcobm9kZVRhZywgdmlld1RhZykgewogICAgICBhc3NlcnROYXRpdmVBbmltYXRlZE1vZHVsZSgpOwogICAgICBOYXRpdmVBbmltYXRlZE1vZHVsZS5jb25uZWN0QW5pbWF0ZWROb2RlVG9WaWV3KG5vZGVUYWcsIHZpZXdUYWcpOwogICAgfSwKICAgIGRpc2Nvbm5lY3RBbmltYXRlZE5vZGVGcm9tVmlldzogZnVuY3Rpb24gZGlzY29ubmVjdEFuaW1hdGVkTm9kZUZyb21WaWV3KG5vZGVUYWcsIHZpZXdUYWcpIHsKICAgICAgYXNzZXJ0TmF0aXZlQW5pbWF0ZWRNb2R1bGUoKTsKICAgICAgTmF0aXZlQW5pbWF0ZWRNb2R1bGUuZGlzY29ubmVjdEFuaW1hdGVkTm9kZUZyb21WaWV3KG5vZGVUYWcsIHZpZXdUYWcpOwogICAgfSwKICAgIGRyb3BBbmltYXRlZE5vZGU6IGZ1bmN0aW9uIGRyb3BBbmltYXRlZE5vZGUodGFnKSB7CiAgICAgIGFzc2VydE5hdGl2ZUFuaW1hdGVkTW9kdWxlKCk7CiAgICAgIE5hdGl2ZUFuaW1hdGVkTW9kdWxlLmRyb3BBbmltYXRlZE5vZGUodGFnKTsKICAgIH0sCiAgICBhZGRBbmltYXRlZEV2ZW50VG9WaWV3OiBmdW5jdGlvbiBhZGRBbmltYXRlZEV2ZW50VG9WaWV3KHZpZXdUYWcsIGV2ZW50TmFtZSwgZXZlbnRNYXBwaW5nKSB7CiAgICAgIGFzc2VydE5hdGl2ZUFuaW1hdGVkTW9kdWxlKCk7CiAgICAgIE5hdGl2ZUFuaW1hdGVkTW9kdWxlLmFkZEFuaW1hdGVkRXZlbnRUb1ZpZXcodmlld1RhZywgZXZlbnROYW1lLCBldmVudE1hcHBpbmcpOwogICAgfSwKICAgIHJlbW92ZUFuaW1hdGVkRXZlbnRGcm9tVmlldzogZnVuY3Rpb24gcmVtb3ZlQW5pbWF0ZWRFdmVudEZyb21WaWV3KHZpZXdUYWcsIGV2ZW50TmFtZSwgYW5pbWF0ZWROb2RlVGFnKSB7CiAgICAgIGFzc2VydE5hdGl2ZUFuaW1hdGVkTW9kdWxlKCk7CiAgICAgIE5hdGl2ZUFuaW1hdGVkTW9kdWxlLnJlbW92ZUFuaW1hdGVkRXZlbnRGcm9tVmlldyh2aWV3VGFnLCBldmVudE5hbWUsIGFuaW1hdGVkTm9kZVRhZyk7CiAgICB9CiAgfTsKICB2YXIgU1RZTEVTX1dISVRFTElTVCA9IHsKICAgIG9wYWNpdHk6IHRydWUsCiAgICB0cmFuc2Zvcm06IHRydWUsCiAgICBzaGFkb3dPcGFjaXR5OiB0cnVlLAogICAgc2hhZG93UmFkaXVzOiB0cnVlLAogICAgc2NhbGVYOiB0cnVlLAogICAgc2NhbGVZOiB0cnVlLAogICAgdHJhbnNsYXRlWDogdHJ1ZSwKICAgIHRyYW5zbGF0ZVk6IHRydWUKICB9OwogIHZhciBUUkFOU0ZPUk1fV0hJVEVMSVNUID0gewogICAgdHJhbnNsYXRlWDogdHJ1ZSwKICAgIHRyYW5zbGF0ZVk6IHRydWUsCiAgICBzY2FsZTogdHJ1ZSwKICAgIHNjYWxlWDogdHJ1ZSwKICAgIHNjYWxlWTogdHJ1ZSwKICAgIHJvdGF0ZTogdHJ1ZSwKICAgIHJvdGF0ZVg6IHRydWUsCiAgICByb3RhdGVZOiB0cnVlLAogICAgcGVyc3BlY3RpdmU6IHRydWUKICB9OwogIHZhciBTVVBQT1JURURfSU5URVJQT0xBVElPTl9QQVJBTVMgPSB7CiAgICBpbnB1dFJhbmdlOiB0cnVlLAogICAgb3V0cHV0UmFuZ2U6IHRydWUsCiAgICBleHRyYXBvbGF0ZTogdHJ1ZSwKICAgIGV4dHJhcG9sYXRlUmlnaHQ6IHRydWUsCiAgICBleHRyYXBvbGF0ZUxlZnQ6IHRydWUKICB9OwoKICBmdW5jdGlvbiBhZGRXaGl0ZWxpc3RlZFN0eWxlUHJvcChwcm9wKSB7CiAgICBTVFlMRVNfV0hJVEVMSVNUW3Byb3BdID0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGFkZFdoaXRlbGlzdGVkVHJhbnNmb3JtUHJvcChwcm9wKSB7CiAgICBUUkFOU0ZPUk1fV0hJVEVMSVNUW3Byb3BdID0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGFkZFdoaXRlbGlzdGVkSW50ZXJwb2xhdGlvblBhcmFtKHBhcmFtKSB7CiAgICBTVVBQT1JURURfSU5URVJQT0xBVElPTl9QQVJBTVNbcGFyYW1dID0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIHZhbGlkYXRlVHJhbnNmb3JtKGNvbmZpZ3MpIHsKICAgIGNvbmZpZ3MuZm9yRWFjaChmdW5jdGlvbiAoY29uZmlnKSB7CiAgICAgIGlmICghVFJBTlNGT1JNX1dISVRFTElTVC5oYXNPd25Qcm9wZXJ0eShjb25maWcucHJvcGVydHkpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQcm9wZXJ0eSAnIiArIGNvbmZpZy5wcm9wZXJ0eSArICInIGlzIG5vdCBzdXBwb3J0ZWQgYnkgbmF0aXZlIGFuaW1hdGVkIG1vZHVsZSIpOwogICAgICB9CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHZhbGlkYXRlU3R5bGVzKHN0eWxlcykgewogICAgZm9yICh2YXIga2V5IGluIHN0eWxlcykgewogICAgICBpZiAoIVNUWUxFU19XSElURUxJU1QuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiU3R5bGUgcHJvcGVydHkgJyIgKyBrZXkgKyAiJyBpcyBub3Qgc3VwcG9ydGVkIGJ5IG5hdGl2ZSBhbmltYXRlZCBtb2R1bGUiKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gdmFsaWRhdGVJbnRlcnBvbGF0aW9uKGNvbmZpZykgewogICAgZm9yICh2YXIga2V5IGluIGNvbmZpZykgewogICAgICBpZiAoIVNVUFBPUlRFRF9JTlRFUlBPTEFUSU9OX1BBUkFNUy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnRlcnBvbGF0aW9uIHByb3BlcnR5ICciICsga2V5ICsgIicgaXMgbm90IHN1cHBvcnRlZCBieSBuYXRpdmUgYW5pbWF0ZWQgbW9kdWxlIik7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGdlbmVyYXRlTmV3Tm9kZVRhZygpIHsKICAgIHJldHVybiBfX25hdGl2ZUFuaW1hdGVkTm9kZVRhZ0NvdW50Kys7CiAgfQoKICBmdW5jdGlvbiBnZW5lcmF0ZU5ld0FuaW1hdGlvbklkKCkgewogICAgcmV0dXJuIF9fbmF0aXZlQW5pbWF0aW9uSWRDb3VudCsrOwogIH0KCiAgZnVuY3Rpb24gYXNzZXJ0TmF0aXZlQW5pbWF0ZWRNb2R1bGUoKSB7CiAgICBpbnZhcmlhbnQoTmF0aXZlQW5pbWF0ZWRNb2R1bGUsICdOYXRpdmUgYW5pbWF0ZWQgbW9kdWxlIGlzIG5vdCBhdmFpbGFibGUnKTsKICB9CgogIHZhciBfd2FybmVkTWlzc2luZ05hdGl2ZUFuaW1hdGVkID0gZmFsc2U7CgogIGZ1bmN0aW9uIHNob3VsZFVzZU5hdGl2ZURyaXZlcihjb25maWcpIHsKICAgIGlmIChjb25maWcudXNlTmF0aXZlRHJpdmVyICYmICFOYXRpdmVBbmltYXRlZE1vZHVsZSkgewogICAgICBpZiAoIV93YXJuZWRNaXNzaW5nTmF0aXZlQW5pbWF0ZWQpIHsKICAgICAgICBjb25zb2xlLndhcm4oJ0FuaW1hdGVkOiBgdXNlTmF0aXZlRHJpdmVyYCBpcyBub3Qgc3VwcG9ydGVkIGJlY2F1c2UgdGhlIG5hdGl2ZSAnICsgJ2FuaW1hdGVkIG1vZHVsZSBpcyBtaXNzaW5nLiBGYWxsaW5nIGJhY2sgdG8gSlMtYmFzZWQgYW5pbWF0aW9uLiBUbyAnICsgJ3Jlc29sdmUgdGhpcywgYWRkIGBSQ1RBbmltYXRpb25gIG1vZHVsZSB0byB0aGlzIGFwcCwgb3IgcmVtb3ZlICcgKyAnYHVzZU5hdGl2ZURyaXZlcmAuICcgKyAnTW9yZSBpbmZvOiBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QtbmF0aXZlL2lzc3Vlcy8xMTA5NCNpc3N1ZWNvbW1lbnQtMjYzMjQwNDIwJyk7CiAgICAgICAgX3dhcm5lZE1pc3NpbmdOYXRpdmVBbmltYXRlZCA9IHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gY29uZmlnLnVzZU5hdGl2ZURyaXZlciB8fCBmYWxzZTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gewogICAgQVBJOiBBUEksCiAgICBhZGRXaGl0ZWxpc3RlZFN0eWxlUHJvcDogYWRkV2hpdGVsaXN0ZWRTdHlsZVByb3AsCiAgICBhZGRXaGl0ZWxpc3RlZFRyYW5zZm9ybVByb3A6IGFkZFdoaXRlbGlzdGVkVHJhbnNmb3JtUHJvcCwKICAgIGFkZFdoaXRlbGlzdGVkSW50ZXJwb2xhdGlvblBhcmFtOiBhZGRXaGl0ZWxpc3RlZEludGVycG9sYXRpb25QYXJhbSwKICAgIHZhbGlkYXRlU3R5bGVzOiB2YWxpZGF0ZVN0eWxlcywKICAgIHZhbGlkYXRlVHJhbnNmb3JtOiB2YWxpZGF0ZVRyYW5zZm9ybSwKICAgIHZhbGlkYXRlSW50ZXJwb2xhdGlvbjogdmFsaWRhdGVJbnRlcnBvbGF0aW9uLAogICAgZ2VuZXJhdGVOZXdOb2RlVGFnOiBnZW5lcmF0ZU5ld05vZGVUYWcsCiAgICBnZW5lcmF0ZU5ld0FuaW1hdGlvbklkOiBnZW5lcmF0ZU5ld0FuaW1hdGlvbklkLAogICAgYXNzZXJ0TmF0aXZlQW5pbWF0ZWRNb2R1bGU6IGFzc2VydE5hdGl2ZUFuaW1hdGVkTW9kdWxlLAogICAgc2hvdWxkVXNlTmF0aXZlRHJpdmVyOiBzaG91bGRVc2VOYXRpdmVEcml2ZXIsCgogICAgZ2V0IG5hdGl2ZUV2ZW50RW1pdHRlcigpIHsKICAgICAgaWYgKCFuYXRpdmVFdmVudEVtaXR0ZXIpIHsKICAgICAgICBuYXRpdmVFdmVudEVtaXR0ZXIgPSBuZXcgTmF0aXZlRXZlbnRFbWl0dGVyKE5hdGl2ZUFuaW1hdGVkTW9kdWxlKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5hdGl2ZUV2ZW50RW1pdHRlcjsKICAgIH0KCiAgfTsKfSwyMDAsWzE1LDY5LDEzXSwiTmF0aXZlQW5pbWF0ZWRIZWxwZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBBbmltYXRlZE5vZGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9BbmltYXRlZE5vZGUnKTsKCiAgdmFyIE5hdGl2ZUFuaW1hdGVkSGVscGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4uL05hdGl2ZUFuaW1hdGVkSGVscGVyJyk7CgogIHZhciBBbmltYXRlZFdpdGhDaGlsZHJlbiA9IGZ1bmN0aW9uIChfQW5pbWF0ZWROb2RlKSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoQW5pbWF0ZWRXaXRoQ2hpbGRyZW4sIF9BbmltYXRlZE5vZGUpOwoKICAgIGZ1bmN0aW9uIEFuaW1hdGVkV2l0aENoaWxkcmVuKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKEFuaW1hdGVkV2l0aENoaWxkcmVuLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pKS5jYWxsKHRoaXMpKTsKCiAgICAgIF90aGlzLl9jaGlsZHJlbiA9IFtdOwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEFuaW1hdGVkV2l0aENoaWxkcmVuLCBbewogICAgICBrZXk6ICJfX21ha2VOYXRpdmUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19tYWtlTmF0aXZlKCkgewogICAgICAgIGlmICghdGhpcy5fX2lzTmF0aXZlKSB7CiAgICAgICAgICB0aGlzLl9faXNOYXRpdmUgPSB0cnVlOwoKICAgICAgICAgIGZvciAodmFyIF9pdGVyYXRvciA9IHRoaXMuX2NoaWxkcmVuLCBfaXNBcnJheSA9IEFycmF5LmlzQXJyYXkoX2l0ZXJhdG9yKSwgX2kgPSAwLCBfaXRlcmF0b3IgPSBfaXNBcnJheSA/IF9pdGVyYXRvciA6IF9pdGVyYXRvclt0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLml0ZXJhdG9yIDogIkBAaXRlcmF0b3IiXSgpOzspIHsKICAgICAgICAgICAgdmFyIF9yZWY7CgogICAgICAgICAgICBpZiAoX2lzQXJyYXkpIHsKICAgICAgICAgICAgICBpZiAoX2kgPj0gX2l0ZXJhdG9yLmxlbmd0aCkgYnJlYWs7CiAgICAgICAgICAgICAgX3JlZiA9IF9pdGVyYXRvcltfaSsrXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBfaSA9IF9pdGVyYXRvci5uZXh0KCk7CiAgICAgICAgICAgICAgaWYgKF9pLmRvbmUpIGJyZWFrOwogICAgICAgICAgICAgIF9yZWYgPSBfaS52YWx1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNoaWxkID0gX3JlZjsKCiAgICAgICAgICAgIGNoaWxkLl9fbWFrZU5hdGl2ZSgpOwoKICAgICAgICAgICAgTmF0aXZlQW5pbWF0ZWRIZWxwZXIuQVBJLmNvbm5lY3RBbmltYXRlZE5vZGVzKHRoaXMuX19nZXROYXRpdmVUYWcoKSwgY2hpbGQuX19nZXROYXRpdmVUYWcoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fYWRkQ2hpbGQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19hZGRDaGlsZChjaGlsZCkgewogICAgICAgIGlmICh0aGlzLl9jaGlsZHJlbi5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHRoaXMuX19hdHRhY2goKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2NoaWxkcmVuLnB1c2goY2hpbGQpOwoKICAgICAgICBpZiAodGhpcy5fX2lzTmF0aXZlKSB7CiAgICAgICAgICBjaGlsZC5fX21ha2VOYXRpdmUoKTsKCiAgICAgICAgICBOYXRpdmVBbmltYXRlZEhlbHBlci5BUEkuY29ubmVjdEFuaW1hdGVkTm9kZXModGhpcy5fX2dldE5hdGl2ZVRhZygpLCBjaGlsZC5fX2dldE5hdGl2ZVRhZygpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19yZW1vdmVDaGlsZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX3JlbW92ZUNoaWxkKGNoaWxkKSB7CiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5fY2hpbGRyZW4uaW5kZXhPZihjaGlsZCk7CgogICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHsKICAgICAgICAgIGNvbnNvbGUud2FybigiVHJ5aW5nIHRvIHJlbW92ZSBhIGNoaWxkIHRoYXQgZG9lc24ndCBleGlzdCIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX19pc05hdGl2ZSAmJiBjaGlsZC5fX2lzTmF0aXZlKSB7CiAgICAgICAgICBOYXRpdmVBbmltYXRlZEhlbHBlci5BUEkuZGlzY29ubmVjdEFuaW1hdGVkTm9kZXModGhpcy5fX2dldE5hdGl2ZVRhZygpLCBjaGlsZC5fX2dldE5hdGl2ZVRhZygpKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2NoaWxkcmVuLnNwbGljZShpbmRleCwgMSk7CgogICAgICAgIGlmICh0aGlzLl9jaGlsZHJlbi5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHRoaXMuX19kZXRhY2goKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXRDaGlsZHJlbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2dldENoaWxkcmVuKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jaGlsZHJlbjsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEFuaW1hdGVkV2l0aENoaWxkcmVuOwogIH0oQW5pbWF0ZWROb2RlKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBBbmltYXRlZFdpdGhDaGlsZHJlbjsKfSwyMDEsWzE5OSwyMDBdLCJBbmltYXRlZFdpdGhDaGlsZHJlbiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEJhdGNoZWRCcmlkZ2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQmF0Y2hlZEJyaWRnZSIpOwoKICB2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkV2ZW50RW1pdHRlciIpOwoKICB2YXIgU2V0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlNldCIpOwoKICB2YXIgVGFza1F1ZXVlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlRhc2tRdWV1ZSIpOwoKICB2YXIgaW5mb0xvZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJpbmZvTG9nIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBrZXlNaXJyb3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAiZmJqcy9saWIva2V5TWlycm9yIik7CgogIHZhciBfZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTsKCiAgdmFyIERFQlVHX0RFTEFZID0gMDsKICB2YXIgREVCVUcgPSBmYWxzZTsKICB2YXIgSW50ZXJhY3Rpb25NYW5hZ2VyID0gewogICAgRXZlbnRzOiBrZXlNaXJyb3IoewogICAgICBpbnRlcmFjdGlvblN0YXJ0OiB0cnVlLAogICAgICBpbnRlcmFjdGlvbkNvbXBsZXRlOiB0cnVlCiAgICB9KSwKICAgIHJ1bkFmdGVySW50ZXJhY3Rpb25zOiBmdW5jdGlvbiBydW5BZnRlckludGVyYWN0aW9ucyh0YXNrKSB7CiAgICAgIHZhciB0YXNrcyA9IFtdOwogICAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgICAgX3NjaGVkdWxlVXBkYXRlKCk7CgogICAgICAgIGlmICh0YXNrKSB7CiAgICAgICAgICB0YXNrcy5wdXNoKHRhc2spOwogICAgICAgIH0KCiAgICAgICAgdGFza3MucHVzaCh7CiAgICAgICAgICBydW46IHJlc29sdmUsCiAgICAgICAgICBuYW1lOiAncmVzb2x2ZSAnICsgKHRhc2sgJiYgdGFzay5uYW1lIHx8ICc/JykKICAgICAgICB9KTsKCiAgICAgICAgX3Rhc2tRdWV1ZS5lbnF1ZXVlVGFza3ModGFza3MpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHsKICAgICAgICB0aGVuOiBwcm9taXNlLnRoZW4uYmluZChwcm9taXNlKSwKICAgICAgICBkb25lOiBmdW5jdGlvbiBkb25lKCkgewogICAgICAgICAgaWYgKHByb21pc2UuZG9uZSkgewogICAgICAgICAgICByZXR1cm4gcHJvbWlzZS5kb25lLmFwcGx5KHByb21pc2UsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1RyaWVkIHRvIGNhbGwgZG9uZSB3aGVuIG5vdCBzdXBwb3J0ZWQgYnkgY3VycmVudCBQcm9taXNlIGltcGxlbWVudGF0aW9uLicpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY2FuY2VsOiBmdW5jdGlvbiBjYW5jZWwoKSB7CiAgICAgICAgICBfdGFza1F1ZXVlLmNhbmNlbFRhc2tzKHRhc2tzKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9LAogICAgY3JlYXRlSW50ZXJhY3Rpb25IYW5kbGU6IGZ1bmN0aW9uIGNyZWF0ZUludGVyYWN0aW9uSGFuZGxlKCkgewogICAgICBERUJVRyAmJiBpbmZvTG9nKCdjcmVhdGUgaW50ZXJhY3Rpb24gaGFuZGxlJyk7CgogICAgICBfc2NoZWR1bGVVcGRhdGUoKTsKCiAgICAgIHZhciBoYW5kbGUgPSArK19pbmM7CgogICAgICBfYWRkSW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSk7CgogICAgICByZXR1cm4gaGFuZGxlOwogICAgfSwKICAgIGNsZWFySW50ZXJhY3Rpb25IYW5kbGU6IGZ1bmN0aW9uIGNsZWFySW50ZXJhY3Rpb25IYW5kbGUoaGFuZGxlKSB7CiAgICAgIERFQlVHICYmIGluZm9Mb2coJ2NsZWFyIGludGVyYWN0aW9uIGhhbmRsZScpOwogICAgICBpbnZhcmlhbnQoISFoYW5kbGUsICdNdXN0IHByb3ZpZGUgYSBoYW5kbGUgdG8gY2xlYXIuJyk7CgogICAgICBfc2NoZWR1bGVVcGRhdGUoKTsKCiAgICAgIF9hZGRJbnRlcmFjdGlvblNldC5kZWxldGUoaGFuZGxlKTsKCiAgICAgIF9kZWxldGVJbnRlcmFjdGlvblNldC5hZGQoaGFuZGxlKTsKICAgIH0sCiAgICBhZGRMaXN0ZW5lcjogX2VtaXR0ZXIuYWRkTGlzdGVuZXIuYmluZChfZW1pdHRlciksCiAgICBzZXREZWFkbGluZTogZnVuY3Rpb24gc2V0RGVhZGxpbmUoZGVhZGxpbmUpIHsKICAgICAgX2RlYWRsaW5lID0gZGVhZGxpbmU7CiAgICB9CiAgfTsKCiAgdmFyIF9pbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTsKCiAgdmFyIF9hZGRJbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTsKCiAgdmFyIF9kZWxldGVJbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTsKCiAgdmFyIF90YXNrUXVldWUgPSBuZXcgVGFza1F1ZXVlKHsKICAgIG9uTW9yZVRhc2tzOiBfc2NoZWR1bGVVcGRhdGUKICB9KTsKCiAgdmFyIF9uZXh0VXBkYXRlSGFuZGxlID0gMDsKICB2YXIgX2luYyA9IDA7CgogIHZhciBfZGVhZGxpbmUgPSAtMTsKCiAgZnVuY3Rpb24gX3NjaGVkdWxlVXBkYXRlKCkgewogICAgaWYgKCFfbmV4dFVwZGF0ZUhhbmRsZSkgewogICAgICBpZiAoX2RlYWRsaW5lID4gMCkgewogICAgICAgIF9uZXh0VXBkYXRlSGFuZGxlID0gc2V0VGltZW91dChfcHJvY2Vzc1VwZGF0ZSwgMCArIERFQlVHX0RFTEFZKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBfbmV4dFVwZGF0ZUhhbmRsZSA9IHNldEltbWVkaWF0ZShfcHJvY2Vzc1VwZGF0ZSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIF9wcm9jZXNzVXBkYXRlKCkgewogICAgX25leHRVcGRhdGVIYW5kbGUgPSAwOwogICAgdmFyIGludGVyYWN0aW9uQ291bnQgPSBfaW50ZXJhY3Rpb25TZXQuc2l6ZTsKCiAgICBfYWRkSW50ZXJhY3Rpb25TZXQuZm9yRWFjaChmdW5jdGlvbiAoaGFuZGxlKSB7CiAgICAgIHJldHVybiBfaW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSk7CiAgICB9KTsKCiAgICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuZm9yRWFjaChmdW5jdGlvbiAoaGFuZGxlKSB7CiAgICAgIHJldHVybiBfaW50ZXJhY3Rpb25TZXQuZGVsZXRlKGhhbmRsZSk7CiAgICB9KTsKCiAgICB2YXIgbmV4dEludGVyYWN0aW9uQ291bnQgPSBfaW50ZXJhY3Rpb25TZXQuc2l6ZTsKCiAgICBpZiAoaW50ZXJhY3Rpb25Db3VudCAhPT0gMCAmJiBuZXh0SW50ZXJhY3Rpb25Db3VudCA9PT0gMCkgewogICAgICBfZW1pdHRlci5lbWl0KEludGVyYWN0aW9uTWFuYWdlci5FdmVudHMuaW50ZXJhY3Rpb25Db21wbGV0ZSk7CiAgICB9IGVsc2UgaWYgKGludGVyYWN0aW9uQ291bnQgPT09IDAgJiYgbmV4dEludGVyYWN0aW9uQ291bnQgIT09IDApIHsKICAgICAgX2VtaXR0ZXIuZW1pdChJbnRlcmFjdGlvbk1hbmFnZXIuRXZlbnRzLmludGVyYWN0aW9uU3RhcnQpOwogICAgfQoKICAgIGlmIChuZXh0SW50ZXJhY3Rpb25Db3VudCA9PT0gMCkgewogICAgICB3aGlsZSAoX3Rhc2tRdWV1ZS5oYXNUYXNrc1RvUHJvY2VzcygpKSB7CiAgICAgICAgX3Rhc2tRdWV1ZS5wcm9jZXNzTmV4dCgpOwoKICAgICAgICBpZiAoX2RlYWRsaW5lID4gMCAmJiBCYXRjaGVkQnJpZGdlLmdldEV2ZW50TG9vcFJ1bm5pbmdUaW1lKCkgPj0gX2RlYWRsaW5lKSB7CiAgICAgICAgICBfc2NoZWR1bGVVcGRhdGUoKTsKCiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBfYWRkSW50ZXJhY3Rpb25TZXQuY2xlYXIoKTsKCiAgICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuY2xlYXIoKTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gSW50ZXJhY3Rpb25NYW5hZ2VyOwp9LDIwMixbMTYsNjcsMzAsMjAzLDk0LDEzLDE1MF0sIkludGVyYWN0aW9uTWFuYWdlciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGluZm9Mb2cgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiaW5mb0xvZyIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgREVCVUcgPSBmYWxzZTsKCiAgdmFyIFRhc2tRdWV1ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFRhc2tRdWV1ZShfcmVmKSB7CiAgICAgIHZhciBvbk1vcmVUYXNrcyA9IF9yZWYub25Nb3JlVGFza3M7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBUYXNrUXVldWUpOwogICAgICB0aGlzLl9vbk1vcmVUYXNrcyA9IG9uTW9yZVRhc2tzOwogICAgICB0aGlzLl9xdWV1ZVN0YWNrID0gW3sKICAgICAgICB0YXNrczogW10sCiAgICAgICAgcG9wYWJsZTogZmFsc2UKICAgICAgfV07CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFRhc2tRdWV1ZSwgW3sKICAgICAga2V5OiAiZW5xdWV1ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBlbnF1ZXVlKHRhc2spIHsKICAgICAgICB0aGlzLl9nZXRDdXJyZW50UXVldWUoKS5wdXNoKHRhc2spOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImVucXVldWVUYXNrcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBlbnF1ZXVlVGFza3ModGFza3MpIHsKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICB0YXNrcy5mb3JFYWNoKGZ1bmN0aW9uICh0YXNrKSB7CiAgICAgICAgICByZXR1cm4gX3RoaXMuZW5xdWV1ZSh0YXNrKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjYW5jZWxUYXNrcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjYW5jZWxUYXNrcyh0YXNrc1RvQ2FuY2VsKSB7CiAgICAgICAgdGhpcy5fcXVldWVTdGFjayA9IHRoaXMuX3F1ZXVlU3RhY2subWFwKGZ1bmN0aW9uIChxdWV1ZSkgewogICAgICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBxdWV1ZSwgewogICAgICAgICAgICB0YXNrczogcXVldWUudGFza3MuZmlsdGVyKGZ1bmN0aW9uICh0YXNrKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRhc2tzVG9DYW5jZWwuaW5kZXhPZih0YXNrKSA9PT0gLTE7CiAgICAgICAgICAgIH0pCiAgICAgICAgICB9KTsKICAgICAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKHF1ZXVlLCBpZHgpIHsKICAgICAgICAgIHJldHVybiBxdWV1ZS50YXNrcy5sZW5ndGggPiAwIHx8IGlkeCA9PT0gMDsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJoYXNUYXNrc1RvUHJvY2VzcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBoYXNUYXNrc1RvUHJvY2VzcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q3VycmVudFF1ZXVlKCkubGVuZ3RoID4gMDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJwcm9jZXNzTmV4dCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBwcm9jZXNzTmV4dCgpIHsKICAgICAgICB2YXIgcXVldWUgPSB0aGlzLl9nZXRDdXJyZW50UXVldWUoKTsKCiAgICAgICAgaWYgKHF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgdmFyIHRhc2sgPSBxdWV1ZS5zaGlmdCgpOwoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmICh0YXNrLmdlbikgewogICAgICAgICAgICAgIERFQlVHICYmIGluZm9Mb2coJ2dlblByb21pc2UgZm9yIHRhc2sgJyArIHRhc2submFtZSk7CgogICAgICAgICAgICAgIHRoaXMuX2dlblByb21pc2UodGFzayk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGFzay5ydW4pIHsKICAgICAgICAgICAgICBERUJVRyAmJiBpbmZvTG9nKCdydW4gdGFzayAnICsgdGFzay5uYW1lKTsKICAgICAgICAgICAgICB0YXNrLnJ1bigpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGludmFyaWFudCh0eXBlb2YgdGFzayA9PT0gJ2Z1bmN0aW9uJywgJ0V4cGVjdGVkIEZ1bmN0aW9uLCBTaW1wbGVUYXNrLCBvciBQcm9taXNlVGFzaywgYnV0IGdvdDpcbicgKyBKU09OLnN0cmluZ2lmeSh0YXNrLCBudWxsLCAyKSk7CiAgICAgICAgICAgICAgREVCVUcgJiYgaW5mb0xvZygncnVuIGFub255bW91cyB0YXNrJyk7CiAgICAgICAgICAgICAgdGFzaygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGUubWVzc2FnZSA9ICdUYXNrUXVldWU6IEVycm9yIHdpdGggdGFzayAnICsgKHRhc2submFtZSB8fCAnJykgKyAnOiAnICsgZS5tZXNzYWdlOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfZ2V0Q3VycmVudFF1ZXVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRDdXJyZW50UXVldWUoKSB7CiAgICAgICAgdmFyIHN0YWNrSWR4ID0gdGhpcy5fcXVldWVTdGFjay5sZW5ndGggLSAxOwogICAgICAgIHZhciBxdWV1ZSA9IHRoaXMuX3F1ZXVlU3RhY2tbc3RhY2tJZHhdOwoKICAgICAgICBpZiAocXVldWUucG9wYWJsZSAmJiBxdWV1ZS50YXNrcy5sZW5ndGggPT09IDAgJiYgdGhpcy5fcXVldWVTdGFjay5sZW5ndGggPiAxKSB7CiAgICAgICAgICB0aGlzLl9xdWV1ZVN0YWNrLnBvcCgpOwoKICAgICAgICAgIERFQlVHICYmIGluZm9Mb2coJ3BvcHBlZCBxdWV1ZTogJywgewogICAgICAgICAgICBzdGFja0lkeDogc3RhY2tJZHgsCiAgICAgICAgICAgIHF1ZXVlU3RhY2tTaXplOiB0aGlzLl9xdWV1ZVN0YWNrLmxlbmd0aAogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q3VycmVudFF1ZXVlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBxdWV1ZS50YXNrczsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX2dlblByb21pc2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2dlblByb21pc2UodGFzaykgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICB0aGlzLl9xdWV1ZVN0YWNrLnB1c2goewogICAgICAgICAgdGFza3M6IFtdLAogICAgICAgICAgcG9wYWJsZTogZmFsc2UKICAgICAgICB9KTsKCiAgICAgICAgdmFyIHN0YWNrSWR4ID0gdGhpcy5fcXVldWVTdGFjay5sZW5ndGggLSAxOwogICAgICAgIERFQlVHICYmIGluZm9Mb2coJ3B1c2ggbmV3IHF1ZXVlOiAnLCB7CiAgICAgICAgICBzdGFja0lkeDogc3RhY2tJZHgKICAgICAgICB9KTsKICAgICAgICBERUJVRyAmJiBpbmZvTG9nKCdleGVjIGdlbiB0YXNrICcgKyB0YXNrLm5hbWUpOwogICAgICAgIHRhc2suZ2VuKCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICBERUJVRyAmJiBpbmZvTG9nKCdvblRoZW4gZm9yIGdlbiB0YXNrICcgKyB0YXNrLm5hbWUsIHsKICAgICAgICAgICAgc3RhY2tJZHg6IHN0YWNrSWR4LAogICAgICAgICAgICBxdWV1ZVN0YWNrU2l6ZTogX3RoaXMyLl9xdWV1ZVN0YWNrLmxlbmd0aAogICAgICAgICAgfSk7CiAgICAgICAgICBfdGhpczIuX3F1ZXVlU3RhY2tbc3RhY2tJZHhdLnBvcGFibGUgPSB0cnVlOwogICAgICAgICAgX3RoaXMyLmhhc1Rhc2tzVG9Qcm9jZXNzKCkgJiYgX3RoaXMyLl9vbk1vcmVUYXNrcygpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChleCkgewogICAgICAgICAgZXgubWVzc2FnZSA9ICJUYXNrUXVldWU6IEVycm9yIHJlc29sdmluZyBQcm9taXNlIGluIHRhc2sgIiArIHRhc2submFtZSArICI6ICIgKyBleC5tZXNzYWdlOwogICAgICAgICAgdGhyb3cgZXg7CiAgICAgICAgfSkuZG9uZSgpOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gVGFza1F1ZXVlOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBUYXNrUXVldWU7Cn0sMjAzLFs5NCwxM10sIlRhc2tRdWV1ZSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEFuaW1hdGVkSW50ZXJwb2xhdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL0FuaW1hdGVkSW50ZXJwb2xhdGlvbicpOwoKICB2YXIgQW5pbWF0ZWROb2RlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vQW5pbWF0ZWROb2RlJyk7CgogIHZhciBBbmltYXRlZFZhbHVlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgJy4vQW5pbWF0ZWRWYWx1ZScpOwoKICB2YXIgQW5pbWF0ZWRXaXRoQ2hpbGRyZW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAnLi9BbmltYXRlZFdpdGhDaGlsZHJlbicpOwoKICB2YXIgQW5pbWF0ZWRBZGRpdGlvbiA9IGZ1bmN0aW9uIChfQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhBbmltYXRlZEFkZGl0aW9uLCBfQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pOwoKICAgIGZ1bmN0aW9uIEFuaW1hdGVkQWRkaXRpb24oYSwgYikgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQW5pbWF0ZWRBZGRpdGlvbik7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoQW5pbWF0ZWRBZGRpdGlvbi5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEFuaW1hdGVkQWRkaXRpb24pKS5jYWxsKHRoaXMpKTsKCiAgICAgIF90aGlzLl9hID0gdHlwZW9mIGEgPT09ICdudW1iZXInID8gbmV3IEFuaW1hdGVkVmFsdWUoYSkgOiBhOwogICAgICBfdGhpcy5fYiA9IHR5cGVvZiBiID09PSAnbnVtYmVyJyA/IG5ldyBBbmltYXRlZFZhbHVlKGIpIDogYjsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhBbmltYXRlZEFkZGl0aW9uLCBbewogICAgICBrZXk6ICJfX21ha2VOYXRpdmUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19tYWtlTmF0aXZlKCkgewogICAgICAgIHRoaXMuX2EuX19tYWtlTmF0aXZlKCk7CgogICAgICAgIHRoaXMuX2IuX19tYWtlTmF0aXZlKCk7CgogICAgICAgIGJhYmVsSGVscGVycy5nZXQoQW5pbWF0ZWRBZGRpdGlvbi5wcm90b3R5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBbmltYXRlZEFkZGl0aW9uLnByb3RvdHlwZSksICJfX21ha2VOYXRpdmUiLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ2V0VmFsdWUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXRWYWx1ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYS5fX2dldFZhbHVlKCkgKyB0aGlzLl9iLl9fZ2V0VmFsdWUoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJpbnRlcnBvbGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBpbnRlcnBvbGF0ZShjb25maWcpIHsKICAgICAgICByZXR1cm4gbmV3IEFuaW1hdGVkSW50ZXJwb2xhdGlvbih0aGlzLCBjb25maWcpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fYXR0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fYXR0YWNoKCkgewogICAgICAgIHRoaXMuX2EuX19hZGRDaGlsZCh0aGlzKTsKCiAgICAgICAgdGhpcy5fYi5fX2FkZENoaWxkKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZGV0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZGV0YWNoKCkgewogICAgICAgIHRoaXMuX2EuX19yZW1vdmVDaGlsZCh0aGlzKTsKCiAgICAgICAgdGhpcy5fYi5fX3JlbW92ZUNoaWxkKHRoaXMpOwoKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KEFuaW1hdGVkQWRkaXRpb24ucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWRBZGRpdGlvbi5wcm90b3R5cGUpLCAiX19kZXRhY2giLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ2V0TmF0aXZlQ29uZmlnIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0TmF0aXZlQ29uZmlnKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAnYWRkaXRpb24nLAogICAgICAgICAgaW5wdXQ6IFt0aGlzLl9hLl9fZ2V0TmF0aXZlVGFnKCksIHRoaXMuX2IuX19nZXROYXRpdmVUYWcoKV0KICAgICAgICB9OwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQW5pbWF0ZWRBZGRpdGlvbjsKICB9KEFuaW1hdGVkV2l0aENoaWxkcmVuKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBBbmltYXRlZEFkZGl0aW9uOwp9LDIwNCxbMTk4LDE5OSwxOTcsMjAxXSwiQW5pbWF0ZWRBZGRpdGlvbiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEFuaW1hdGVkSW50ZXJwb2xhdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL0FuaW1hdGVkSW50ZXJwb2xhdGlvbicpOwoKICB2YXIgQW5pbWF0ZWROb2RlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vQW5pbWF0ZWROb2RlJyk7CgogIHZhciBBbmltYXRlZFdpdGhDaGlsZHJlbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICcuL0FuaW1hdGVkV2l0aENoaWxkcmVuJyk7CgogIHZhciBBbmltYXRlZERpZmZDbGFtcCA9IGZ1bmN0aW9uIChfQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhBbmltYXRlZERpZmZDbGFtcCwgX0FuaW1hdGVkV2l0aENoaWxkcmVuKTsKCiAgICBmdW5jdGlvbiBBbmltYXRlZERpZmZDbGFtcChhLCBtaW4sIG1heCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQW5pbWF0ZWREaWZmQ2xhbXApOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKEFuaW1hdGVkRGlmZkNsYW1wLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWREaWZmQ2xhbXApKS5jYWxsKHRoaXMpKTsKCiAgICAgIF90aGlzLl9hID0gYTsKICAgICAgX3RoaXMuX21pbiA9IG1pbjsKICAgICAgX3RoaXMuX21heCA9IG1heDsKICAgICAgX3RoaXMuX3ZhbHVlID0gX3RoaXMuX2xhc3RWYWx1ZSA9IF90aGlzLl9hLl9fZ2V0VmFsdWUoKTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhBbmltYXRlZERpZmZDbGFtcCwgW3sKICAgICAga2V5OiAiX19tYWtlTmF0aXZlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fbWFrZU5hdGl2ZSgpIHsKICAgICAgICB0aGlzLl9hLl9fbWFrZU5hdGl2ZSgpOwoKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KEFuaW1hdGVkRGlmZkNsYW1wLnByb3RvdHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEFuaW1hdGVkRGlmZkNsYW1wLnByb3RvdHlwZSksICJfX21ha2VOYXRpdmUiLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImludGVycG9sYXRlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGludGVycG9sYXRlKGNvbmZpZykgewogICAgICAgIHJldHVybiBuZXcgQW5pbWF0ZWRJbnRlcnBvbGF0aW9uKHRoaXMsIGNvbmZpZyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXRWYWx1ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2dldFZhbHVlKCkgewogICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX2EuX19nZXRWYWx1ZSgpOwoKICAgICAgICB2YXIgZGlmZiA9IHZhbHVlIC0gdGhpcy5fbGFzdFZhbHVlOwogICAgICAgIHRoaXMuX2xhc3RWYWx1ZSA9IHZhbHVlOwogICAgICAgIHRoaXMuX3ZhbHVlID0gTWF0aC5taW4oTWF0aC5tYXgodGhpcy5fdmFsdWUgKyBkaWZmLCB0aGlzLl9taW4pLCB0aGlzLl9tYXgpOwogICAgICAgIHJldHVybiB0aGlzLl92YWx1ZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2F0dGFjaCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2F0dGFjaCgpIHsKICAgICAgICB0aGlzLl9hLl9fYWRkQ2hpbGQodGhpcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19kZXRhY2giLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19kZXRhY2goKSB7CiAgICAgICAgdGhpcy5fYS5fX3JlbW92ZUNoaWxkKHRoaXMpOwoKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KEFuaW1hdGVkRGlmZkNsYW1wLnByb3RvdHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEFuaW1hdGVkRGlmZkNsYW1wLnByb3RvdHlwZSksICJfX2RldGFjaCIsIHRoaXMpLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXROYXRpdmVDb25maWciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXROYXRpdmVDb25maWcoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICdkaWZmY2xhbXAnLAogICAgICAgICAgaW5wdXQ6IHRoaXMuX2EuX19nZXROYXRpdmVUYWcoKSwKICAgICAgICAgIG1pbjogdGhpcy5fbWluLAogICAgICAgICAgbWF4OiB0aGlzLl9tYXgKICAgICAgICB9OwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQW5pbWF0ZWREaWZmQ2xhbXA7CiAgfShBbmltYXRlZFdpdGhDaGlsZHJlbik7CgogIG1vZHVsZS5leHBvcnRzID0gQW5pbWF0ZWREaWZmQ2xhbXA7Cn0sMjA1LFsxOTgsMTk5LDIwMV0sIkFuaW1hdGVkRGlmZkNsYW1wIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgQW5pbWF0ZWRJbnRlcnBvbGF0aW9uID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgJy4vQW5pbWF0ZWRJbnRlcnBvbGF0aW9uJyk7CgogIHZhciBBbmltYXRlZE5vZGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAnLi9BbmltYXRlZE5vZGUnKTsKCiAgdmFyIEFuaW1hdGVkVmFsdWUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAnLi9BbmltYXRlZFZhbHVlJyk7CgogIHZhciBBbmltYXRlZFdpdGhDaGlsZHJlbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICcuL0FuaW1hdGVkV2l0aENoaWxkcmVuJyk7CgogIHZhciBBbmltYXRlZERpdmlzaW9uID0gZnVuY3Rpb24gKF9BbmltYXRlZFdpdGhDaGlsZHJlbikgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKEFuaW1hdGVkRGl2aXNpb24sIF9BbmltYXRlZFdpdGhDaGlsZHJlbik7CgogICAgZnVuY3Rpb24gQW5pbWF0ZWREaXZpc2lvbihhLCBiKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBBbmltYXRlZERpdmlzaW9uKTsKCiAgICAgIHZhciBfdGhpcyA9IGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChBbmltYXRlZERpdmlzaW9uLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWREaXZpc2lvbikpLmNhbGwodGhpcykpOwoKICAgICAgX3RoaXMuX2EgPSB0eXBlb2YgYSA9PT0gJ251bWJlcicgPyBuZXcgQW5pbWF0ZWRWYWx1ZShhKSA6IGE7CiAgICAgIF90aGlzLl9iID0gdHlwZW9mIGIgPT09ICdudW1iZXInID8gbmV3IEFuaW1hdGVkVmFsdWUoYikgOiBiOwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEFuaW1hdGVkRGl2aXNpb24sIFt7CiAgICAgIGtleTogIl9fbWFrZU5hdGl2ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX21ha2VOYXRpdmUoKSB7CiAgICAgICAgdGhpcy5fYS5fX21ha2VOYXRpdmUoKTsKCiAgICAgICAgdGhpcy5fYi5fX21ha2VOYXRpdmUoKTsKCiAgICAgICAgYmFiZWxIZWxwZXJzLmdldChBbmltYXRlZERpdmlzaW9uLnByb3RvdHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEFuaW1hdGVkRGl2aXNpb24ucHJvdG90eXBlKSwgIl9fbWFrZU5hdGl2ZSIsIHRoaXMpLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXRWYWx1ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2dldFZhbHVlKCkgewogICAgICAgIHZhciBhID0gdGhpcy5fYS5fX2dldFZhbHVlKCk7CgogICAgICAgIHZhciBiID0gdGhpcy5fYi5fX2dldFZhbHVlKCk7CgogICAgICAgIGlmIChiID09PSAwKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCdEZXRlY3RlZCBkaXZpc2lvbiBieSB6ZXJvIGluIEFuaW1hdGVkRGl2aXNpb24nKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhIC8gYjsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJpbnRlcnBvbGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBpbnRlcnBvbGF0ZShjb25maWcpIHsKICAgICAgICByZXR1cm4gbmV3IEFuaW1hdGVkSW50ZXJwb2xhdGlvbih0aGlzLCBjb25maWcpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fYXR0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fYXR0YWNoKCkgewogICAgICAgIHRoaXMuX2EuX19hZGRDaGlsZCh0aGlzKTsKCiAgICAgICAgdGhpcy5fYi5fX2FkZENoaWxkKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZGV0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZGV0YWNoKCkgewogICAgICAgIHRoaXMuX2EuX19yZW1vdmVDaGlsZCh0aGlzKTsKCiAgICAgICAgdGhpcy5fYi5fX3JlbW92ZUNoaWxkKHRoaXMpOwoKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KEFuaW1hdGVkRGl2aXNpb24ucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWREaXZpc2lvbi5wcm90b3R5cGUpLCAiX19kZXRhY2giLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ2V0TmF0aXZlQ29uZmlnIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0TmF0aXZlQ29uZmlnKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAnZGl2aXNpb24nLAogICAgICAgICAgaW5wdXQ6IFt0aGlzLl9hLl9fZ2V0TmF0aXZlVGFnKCksIHRoaXMuX2IuX19nZXROYXRpdmVUYWcoKV0KICAgICAgICB9OwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQW5pbWF0ZWREaXZpc2lvbjsKICB9KEFuaW1hdGVkV2l0aENoaWxkcmVuKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBBbmltYXRlZERpdmlzaW9uOwp9LDIwNixbMTk4LDE5OSwxOTcsMjAxXSwiQW5pbWF0ZWREaXZpc2lvbiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEFuaW1hdGVkSW50ZXJwb2xhdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL0FuaW1hdGVkSW50ZXJwb2xhdGlvbicpOwoKICB2YXIgQW5pbWF0ZWROb2RlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vQW5pbWF0ZWROb2RlJyk7CgogIHZhciBBbmltYXRlZFdpdGhDaGlsZHJlbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICcuL0FuaW1hdGVkV2l0aENoaWxkcmVuJyk7CgogIHZhciBBbmltYXRlZE1vZHVsbyA9IGZ1bmN0aW9uIChfQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhBbmltYXRlZE1vZHVsbywgX0FuaW1hdGVkV2l0aENoaWxkcmVuKTsKCiAgICBmdW5jdGlvbiBBbmltYXRlZE1vZHVsbyhhLCBtb2R1bHVzKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBBbmltYXRlZE1vZHVsbyk7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoQW5pbWF0ZWRNb2R1bG8uX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBbmltYXRlZE1vZHVsbykpLmNhbGwodGhpcykpOwoKICAgICAgX3RoaXMuX2EgPSBhOwogICAgICBfdGhpcy5fbW9kdWx1cyA9IG1vZHVsdXM7CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQW5pbWF0ZWRNb2R1bG8sIFt7CiAgICAgIGtleTogIl9fbWFrZU5hdGl2ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX21ha2VOYXRpdmUoKSB7CiAgICAgICAgdGhpcy5fYS5fX21ha2VOYXRpdmUoKTsKCiAgICAgICAgYmFiZWxIZWxwZXJzLmdldChBbmltYXRlZE1vZHVsby5wcm90b3R5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBbmltYXRlZE1vZHVsby5wcm90b3R5cGUpLCAiX19tYWtlTmF0aXZlIiwgdGhpcykuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2dldFZhbHVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0VmFsdWUoKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLl9hLl9fZ2V0VmFsdWUoKSAlIHRoaXMuX21vZHVsdXMgKyB0aGlzLl9tb2R1bHVzKSAlIHRoaXMuX21vZHVsdXM7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaW50ZXJwb2xhdGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gaW50ZXJwb2xhdGUoY29uZmlnKSB7CiAgICAgICAgcmV0dXJuIG5ldyBBbmltYXRlZEludGVycG9sYXRpb24odGhpcywgY29uZmlnKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2F0dGFjaCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2F0dGFjaCgpIHsKICAgICAgICB0aGlzLl9hLl9fYWRkQ2hpbGQodGhpcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19kZXRhY2giLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19kZXRhY2goKSB7CiAgICAgICAgdGhpcy5fYS5fX3JlbW92ZUNoaWxkKHRoaXMpOwoKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KEFuaW1hdGVkTW9kdWxvLnByb3RvdHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEFuaW1hdGVkTW9kdWxvLnByb3RvdHlwZSksICJfX2RldGFjaCIsIHRoaXMpLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXROYXRpdmVDb25maWciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXROYXRpdmVDb25maWcoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICdtb2R1bHVzJywKICAgICAgICAgIGlucHV0OiB0aGlzLl9hLl9fZ2V0TmF0aXZlVGFnKCksCiAgICAgICAgICBtb2R1bHVzOiB0aGlzLl9tb2R1bHVzCiAgICAgICAgfTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEFuaW1hdGVkTW9kdWxvOwogIH0oQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pOwoKICBtb2R1bGUuZXhwb3J0cyA9IEFuaW1hdGVkTW9kdWxvOwp9LDIwNyxbMTk4LDE5OSwyMDFdLCJBbmltYXRlZE1vZHVsbyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEFuaW1hdGVkSW50ZXJwb2xhdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL0FuaW1hdGVkSW50ZXJwb2xhdGlvbicpOwoKICB2YXIgQW5pbWF0ZWROb2RlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vQW5pbWF0ZWROb2RlJyk7CgogIHZhciBBbmltYXRlZFZhbHVlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgJy4vQW5pbWF0ZWRWYWx1ZScpOwoKICB2YXIgQW5pbWF0ZWRXaXRoQ2hpbGRyZW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAnLi9BbmltYXRlZFdpdGhDaGlsZHJlbicpOwoKICB2YXIgQW5pbWF0ZWRNdWx0aXBsaWNhdGlvbiA9IGZ1bmN0aW9uIChfQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhBbmltYXRlZE11bHRpcGxpY2F0aW9uLCBfQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pOwoKICAgIGZ1bmN0aW9uIEFuaW1hdGVkTXVsdGlwbGljYXRpb24oYSwgYikgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQW5pbWF0ZWRNdWx0aXBsaWNhdGlvbik7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoQW5pbWF0ZWRNdWx0aXBsaWNhdGlvbi5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEFuaW1hdGVkTXVsdGlwbGljYXRpb24pKS5jYWxsKHRoaXMpKTsKCiAgICAgIF90aGlzLl9hID0gdHlwZW9mIGEgPT09ICdudW1iZXInID8gbmV3IEFuaW1hdGVkVmFsdWUoYSkgOiBhOwogICAgICBfdGhpcy5fYiA9IHR5cGVvZiBiID09PSAnbnVtYmVyJyA/IG5ldyBBbmltYXRlZFZhbHVlKGIpIDogYjsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhBbmltYXRlZE11bHRpcGxpY2F0aW9uLCBbewogICAgICBrZXk6ICJfX21ha2VOYXRpdmUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19tYWtlTmF0aXZlKCkgewogICAgICAgIHRoaXMuX2EuX19tYWtlTmF0aXZlKCk7CgogICAgICAgIHRoaXMuX2IuX19tYWtlTmF0aXZlKCk7CgogICAgICAgIGJhYmVsSGVscGVycy5nZXQoQW5pbWF0ZWRNdWx0aXBsaWNhdGlvbi5wcm90b3R5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBbmltYXRlZE11bHRpcGxpY2F0aW9uLnByb3RvdHlwZSksICJfX21ha2VOYXRpdmUiLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ2V0VmFsdWUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXRWYWx1ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYS5fX2dldFZhbHVlKCkgKiB0aGlzLl9iLl9fZ2V0VmFsdWUoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJpbnRlcnBvbGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBpbnRlcnBvbGF0ZShjb25maWcpIHsKICAgICAgICByZXR1cm4gbmV3IEFuaW1hdGVkSW50ZXJwb2xhdGlvbih0aGlzLCBjb25maWcpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fYXR0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fYXR0YWNoKCkgewogICAgICAgIHRoaXMuX2EuX19hZGRDaGlsZCh0aGlzKTsKCiAgICAgICAgdGhpcy5fYi5fX2FkZENoaWxkKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZGV0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZGV0YWNoKCkgewogICAgICAgIHRoaXMuX2EuX19yZW1vdmVDaGlsZCh0aGlzKTsKCiAgICAgICAgdGhpcy5fYi5fX3JlbW92ZUNoaWxkKHRoaXMpOwoKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KEFuaW1hdGVkTXVsdGlwbGljYXRpb24ucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWRNdWx0aXBsaWNhdGlvbi5wcm90b3R5cGUpLCAiX19kZXRhY2giLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ2V0TmF0aXZlQ29uZmlnIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0TmF0aXZlQ29uZmlnKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAnbXVsdGlwbGljYXRpb24nLAogICAgICAgICAgaW5wdXQ6IFt0aGlzLl9hLl9fZ2V0TmF0aXZlVGFnKCksIHRoaXMuX2IuX19nZXROYXRpdmVUYWcoKV0KICAgICAgICB9OwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQW5pbWF0ZWRNdWx0aXBsaWNhdGlvbjsKICB9KEFuaW1hdGVkV2l0aENoaWxkcmVuKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBBbmltYXRlZE11bHRpcGxpY2F0aW9uOwp9LDIwOCxbMTk4LDE5OSwxOTcsMjAxXSwiQW5pbWF0ZWRNdWx0aXBsaWNhdGlvbiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgJy4uL0FuaW1hdGVkRXZlbnQnKSwKICAgICAgQW5pbWF0ZWRFdmVudCA9IF9yZXF1aXJlLkFuaW1hdGVkRXZlbnQ7CgogIHZhciBBbmltYXRlZE5vZGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAnLi9BbmltYXRlZE5vZGUnKTsKCiAgdmFyIEFuaW1hdGVkU3R5bGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAnLi9BbmltYXRlZFN0eWxlJyk7CgogIHZhciBOYXRpdmVBbmltYXRlZEhlbHBlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICcuLi9OYXRpdmVBbmltYXRlZEhlbHBlcicpOwoKICB2YXIgUmVhY3ROYXRpdmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiUmVhY3ROYXRpdmUiKTsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIEFuaW1hdGVkUHJvcHMgPSBmdW5jdGlvbiAoX0FuaW1hdGVkTm9kZSkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKEFuaW1hdGVkUHJvcHMsIF9BbmltYXRlZE5vZGUpOwoKICAgIGZ1bmN0aW9uIEFuaW1hdGVkUHJvcHMocHJvcHMsIGNhbGxiYWNrKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBBbmltYXRlZFByb3BzKTsKCiAgICAgIHZhciBfdGhpcyA9IGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChBbmltYXRlZFByb3BzLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWRQcm9wcykpLmNhbGwodGhpcykpOwoKICAgICAgaWYgKHByb3BzLnN0eWxlKSB7CiAgICAgICAgcHJvcHMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgcHJvcHMsIHsKICAgICAgICAgIHN0eWxlOiBuZXcgQW5pbWF0ZWRTdHlsZShwcm9wcy5zdHlsZSkKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgX3RoaXMuX3Byb3BzID0gcHJvcHM7CiAgICAgIF90aGlzLl9jYWxsYmFjayA9IGNhbGxiYWNrOwoKICAgICAgX3RoaXMuX19hdHRhY2goKTsKCiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQW5pbWF0ZWRQcm9wcywgW3sKICAgICAga2V5OiAiX19nZXRWYWx1ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2dldFZhbHVlKCkgewogICAgICAgIHZhciBwcm9wcyA9IHt9OwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5fcHJvcHMpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX3Byb3BzW2tleV07CgogICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQW5pbWF0ZWROb2RlKSB7CiAgICAgICAgICAgIGlmICghdmFsdWUuX19pc05hdGl2ZSB8fCB2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkU3R5bGUpIHsKICAgICAgICAgICAgICBwcm9wc1trZXldID0gdmFsdWUuX19nZXRWYWx1ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIGluc3RhbmNlb2YgQW5pbWF0ZWRFdmVudCkgewogICAgICAgICAgICBwcm9wc1trZXldID0gdmFsdWUuX19nZXRIYW5kbGVyKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwcm9wc1trZXldID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcHJvcHM7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXRBbmltYXRlZFZhbHVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0QW5pbWF0ZWRWYWx1ZSgpIHsKICAgICAgICB2YXIgcHJvcHMgPSB7fTsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuX3Byb3BzKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLl9wcm9wc1trZXldOwoKICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkTm9kZSkgewogICAgICAgICAgICBwcm9wc1trZXldID0gdmFsdWUuX19nZXRBbmltYXRlZFZhbHVlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcHJvcHM7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19hdHRhY2giLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19hdHRhY2goKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuX3Byb3BzKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLl9wcm9wc1trZXldOwoKICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkTm9kZSkgewogICAgICAgICAgICB2YWx1ZS5fX2FkZENoaWxkKHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2RldGFjaCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2RldGFjaCgpIHsKICAgICAgICBpZiAodGhpcy5fX2lzTmF0aXZlICYmIHRoaXMuX2FuaW1hdGVkVmlldykgewogICAgICAgICAgdGhpcy5fX2Rpc2Nvbm5lY3RBbmltYXRlZFZpZXcoKTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLl9wcm9wcykgewogICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5fcHJvcHNba2V5XTsKCiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBbmltYXRlZE5vZGUpIHsKICAgICAgICAgICAgdmFsdWUuX19yZW1vdmVDaGlsZCh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGJhYmVsSGVscGVycy5nZXQoQW5pbWF0ZWRQcm9wcy5wcm90b3R5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBbmltYXRlZFByb3BzLnByb3RvdHlwZSksICJfX2RldGFjaCIsIHRoaXMpLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAidXBkYXRlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHVwZGF0ZSgpIHsKICAgICAgICB0aGlzLl9jYWxsYmFjaygpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fbWFrZU5hdGl2ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX21ha2VOYXRpdmUoKSB7CiAgICAgICAgaWYgKCF0aGlzLl9faXNOYXRpdmUpIHsKICAgICAgICAgIHRoaXMuX19pc05hdGl2ZSA9IHRydWU7CgogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuX3Byb3BzKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX3Byb3BzW2tleV07CgogICAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBbmltYXRlZE5vZGUpIHsKICAgICAgICAgICAgICB2YWx1ZS5fX21ha2VOYXRpdmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0aGlzLl9hbmltYXRlZFZpZXcpIHsKICAgICAgICAgICAgdGhpcy5fX2Nvbm5lY3RBbmltYXRlZFZpZXcoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2V0TmF0aXZlVmlldyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXROYXRpdmVWaWV3KGFuaW1hdGVkVmlldykgewogICAgICAgIGlmICh0aGlzLl9hbmltYXRlZFZpZXcgPT09IGFuaW1hdGVkVmlldykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fYW5pbWF0ZWRWaWV3ID0gYW5pbWF0ZWRWaWV3OwoKICAgICAgICBpZiAodGhpcy5fX2lzTmF0aXZlKSB7CiAgICAgICAgICB0aGlzLl9fY29ubmVjdEFuaW1hdGVkVmlldygpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2Nvbm5lY3RBbmltYXRlZFZpZXciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19jb25uZWN0QW5pbWF0ZWRWaWV3KCkgewogICAgICAgIGludmFyaWFudCh0aGlzLl9faXNOYXRpdmUsICdFeHBlY3RlZCBub2RlIHRvIGJlIG1hcmtlZCBhcyAibmF0aXZlIicpOwogICAgICAgIHZhciBuYXRpdmVWaWV3VGFnID0gUmVhY3ROYXRpdmUuZmluZE5vZGVIYW5kbGUodGhpcy5fYW5pbWF0ZWRWaWV3KTsKICAgICAgICBpbnZhcmlhbnQobmF0aXZlVmlld1RhZyAhPSBudWxsLCAnVW5hYmxlIHRvIGxvY2F0ZSBhdHRhY2hlZCB2aWV3IGluIHRoZSBuYXRpdmUgdHJlZScpOwogICAgICAgIE5hdGl2ZUFuaW1hdGVkSGVscGVyLkFQSS5jb25uZWN0QW5pbWF0ZWROb2RlVG9WaWV3KHRoaXMuX19nZXROYXRpdmVUYWcoKSwgbmF0aXZlVmlld1RhZyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19kaXNjb25uZWN0QW5pbWF0ZWRWaWV3IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZGlzY29ubmVjdEFuaW1hdGVkVmlldygpIHsKICAgICAgICBpbnZhcmlhbnQodGhpcy5fX2lzTmF0aXZlLCAnRXhwZWN0ZWQgbm9kZSB0byBiZSBtYXJrZWQgYXMgIm5hdGl2ZSInKTsKICAgICAgICB2YXIgbmF0aXZlVmlld1RhZyA9IFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKHRoaXMuX2FuaW1hdGVkVmlldyk7CiAgICAgICAgaW52YXJpYW50KG5hdGl2ZVZpZXdUYWcgIT0gbnVsbCwgJ1VuYWJsZSB0byBsb2NhdGUgYXR0YWNoZWQgdmlldyBpbiB0aGUgbmF0aXZlIHRyZWUnKTsKICAgICAgICBOYXRpdmVBbmltYXRlZEhlbHBlci5BUEkuZGlzY29ubmVjdEFuaW1hdGVkTm9kZUZyb21WaWV3KHRoaXMuX19nZXROYXRpdmVUYWcoKSwgbmF0aXZlVmlld1RhZyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXROYXRpdmVDb25maWciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXROYXRpdmVDb25maWcoKSB7CiAgICAgICAgdmFyIHByb3BzQ29uZmlnID0ge307CgogICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gdGhpcy5fcHJvcHMpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX3Byb3BzW3Byb3BLZXldOwoKICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkTm9kZSkgewogICAgICAgICAgICBwcm9wc0NvbmZpZ1twcm9wS2V5XSA9IHZhbHVlLl9fZ2V0TmF0aXZlVGFnKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogJ3Byb3BzJywKICAgICAgICAgIHByb3BzOiBwcm9wc0NvbmZpZwogICAgICAgIH07CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBBbmltYXRlZFByb3BzOwogIH0oQW5pbWF0ZWROb2RlKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBBbmltYXRlZFByb3BzOwp9LDIwOSxbMTk2LDE5OSwyMTAsMjAwLDIxLDEzXSwiQW5pbWF0ZWRQcm9wcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEFuaW1hdGVkTm9kZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL0FuaW1hdGVkTm9kZScpOwoKICB2YXIgQW5pbWF0ZWRUcmFuc2Zvcm0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAnLi9BbmltYXRlZFRyYW5zZm9ybScpOwoKICB2YXIgQW5pbWF0ZWRXaXRoQ2hpbGRyZW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAnLi9BbmltYXRlZFdpdGhDaGlsZHJlbicpOwoKICB2YXIgTmF0aXZlQW5pbWF0ZWRIZWxwZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAnLi4vTmF0aXZlQW5pbWF0ZWRIZWxwZXInKTsKCiAgdmFyIGZsYXR0ZW5TdHlsZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJmbGF0dGVuU3R5bGUiKTsKCiAgdmFyIEFuaW1hdGVkU3R5bGUgPSBmdW5jdGlvbiAoX0FuaW1hdGVkV2l0aENoaWxkcmVuKSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoQW5pbWF0ZWRTdHlsZSwgX0FuaW1hdGVkV2l0aENoaWxkcmVuKTsKCiAgICBmdW5jdGlvbiBBbmltYXRlZFN0eWxlKHN0eWxlKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBBbmltYXRlZFN0eWxlKTsKCiAgICAgIHZhciBfdGhpcyA9IGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChBbmltYXRlZFN0eWxlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWRTdHlsZSkpLmNhbGwodGhpcykpOwoKICAgICAgc3R5bGUgPSBmbGF0dGVuU3R5bGUoc3R5bGUpIHx8IHt9OwoKICAgICAgaWYgKHN0eWxlLnRyYW5zZm9ybSkgewogICAgICAgIHN0eWxlID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHN0eWxlLCB7CiAgICAgICAgICB0cmFuc2Zvcm06IG5ldyBBbmltYXRlZFRyYW5zZm9ybShzdHlsZS50cmFuc2Zvcm0pCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIF90aGlzLl9zdHlsZSA9IHN0eWxlOwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEFuaW1hdGVkU3R5bGUsIFt7CiAgICAgIGtleTogIl93YWxrU3R5bGVBbmRHZXRWYWx1ZXMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX3dhbGtTdHlsZUFuZEdldFZhbHVlcyhzdHlsZSkgewogICAgICAgIHZhciB1cGRhdGVkU3R5bGUgPSB7fTsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSBzdHlsZVtrZXldOwoKICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkTm9kZSkgewogICAgICAgICAgICBpZiAoIXZhbHVlLl9faXNOYXRpdmUpIHsKICAgICAgICAgICAgICB1cGRhdGVkU3R5bGVba2V5XSA9IHZhbHVlLl9fZ2V0VmFsdWUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSAmJiAhQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JykgewogICAgICAgICAgICB1cGRhdGVkU3R5bGVba2V5XSA9IHRoaXMuX3dhbGtTdHlsZUFuZEdldFZhbHVlcyh2YWx1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGVkU3R5bGVba2V5XSA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHVwZGF0ZWRTdHlsZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2dldFZhbHVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0VmFsdWUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3dhbGtTdHlsZUFuZEdldFZhbHVlcyh0aGlzLl9zdHlsZSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX3dhbGtTdHlsZUFuZEdldEFuaW1hdGVkVmFsdWVzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF93YWxrU3R5bGVBbmRHZXRBbmltYXRlZFZhbHVlcyhzdHlsZSkgewogICAgICAgIHZhciB1cGRhdGVkU3R5bGUgPSB7fTsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSBzdHlsZVtrZXldOwoKICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkTm9kZSkgewogICAgICAgICAgICB1cGRhdGVkU3R5bGVba2V5XSA9IHZhbHVlLl9fZ2V0QW5pbWF0ZWRWYWx1ZSgpOwogICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSAmJiAhQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JykgewogICAgICAgICAgICB1cGRhdGVkU3R5bGVba2V5XSA9IHRoaXMuX3dhbGtTdHlsZUFuZEdldEFuaW1hdGVkVmFsdWVzKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB1cGRhdGVkU3R5bGU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXRBbmltYXRlZFZhbHVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0QW5pbWF0ZWRWYWx1ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fd2Fsa1N0eWxlQW5kR2V0QW5pbWF0ZWRWYWx1ZXModGhpcy5fc3R5bGUpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fYXR0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fYXR0YWNoKCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLl9zdHlsZSkgewogICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5fc3R5bGVba2V5XTsKCiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBbmltYXRlZE5vZGUpIHsKICAgICAgICAgICAgdmFsdWUuX19hZGRDaGlsZCh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19kZXRhY2giLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19kZXRhY2goKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuX3N0eWxlKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLl9zdHlsZVtrZXldOwoKICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkTm9kZSkgewogICAgICAgICAgICB2YWx1ZS5fX3JlbW92ZUNoaWxkKHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYmFiZWxIZWxwZXJzLmdldChBbmltYXRlZFN0eWxlLnByb3RvdHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEFuaW1hdGVkU3R5bGUucHJvdG90eXBlKSwgIl9fZGV0YWNoIiwgdGhpcykuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX21ha2VOYXRpdmUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19tYWtlTmF0aXZlKCkgewogICAgICAgIGJhYmVsSGVscGVycy5nZXQoQW5pbWF0ZWRTdHlsZS5wcm90b3R5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBbmltYXRlZFN0eWxlLnByb3RvdHlwZSksICJfX21ha2VOYXRpdmUiLCB0aGlzKS5jYWxsKHRoaXMpOwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5fc3R5bGUpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX3N0eWxlW2tleV07CgogICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQW5pbWF0ZWROb2RlKSB7CiAgICAgICAgICAgIHZhbHVlLl9fbWFrZU5hdGl2ZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2dldE5hdGl2ZUNvbmZpZyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2dldE5hdGl2ZUNvbmZpZygpIHsKICAgICAgICB2YXIgc3R5bGVDb25maWcgPSB7fTsKCiAgICAgICAgZm9yICh2YXIgc3R5bGVLZXkgaW4gdGhpcy5fc3R5bGUpIHsKICAgICAgICAgIGlmICh0aGlzLl9zdHlsZVtzdHlsZUtleV0gaW5zdGFuY2VvZiBBbmltYXRlZE5vZGUpIHsKICAgICAgICAgICAgc3R5bGVDb25maWdbc3R5bGVLZXldID0gdGhpcy5fc3R5bGVbc3R5bGVLZXldLl9fZ2V0TmF0aXZlVGFnKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBOYXRpdmVBbmltYXRlZEhlbHBlci52YWxpZGF0ZVN0eWxlcyhzdHlsZUNvbmZpZyk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICdzdHlsZScsCiAgICAgICAgICBzdHlsZTogc3R5bGVDb25maWcKICAgICAgICB9OwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQW5pbWF0ZWRTdHlsZTsKICB9KEFuaW1hdGVkV2l0aENoaWxkcmVuKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBBbmltYXRlZFN0eWxlOwp9LDIxMCxbMTk5LDIxMSwyMDEsMjAwLDEwMV0sIkFuaW1hdGVkU3R5bGUiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBBbmltYXRlZE5vZGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9BbmltYXRlZE5vZGUnKTsKCiAgdmFyIEFuaW1hdGVkV2l0aENoaWxkcmVuID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vQW5pbWF0ZWRXaXRoQ2hpbGRyZW4nKTsKCiAgdmFyIE5hdGl2ZUFuaW1hdGVkSGVscGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgJy4uL05hdGl2ZUFuaW1hdGVkSGVscGVyJyk7CgogIHZhciBBbmltYXRlZFRyYW5zZm9ybSA9IGZ1bmN0aW9uIChfQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhBbmltYXRlZFRyYW5zZm9ybSwgX0FuaW1hdGVkV2l0aENoaWxkcmVuKTsKCiAgICBmdW5jdGlvbiBBbmltYXRlZFRyYW5zZm9ybSh0cmFuc2Zvcm1zKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBBbmltYXRlZFRyYW5zZm9ybSk7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoQW5pbWF0ZWRUcmFuc2Zvcm0uX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBbmltYXRlZFRyYW5zZm9ybSkpLmNhbGwodGhpcykpOwoKICAgICAgX3RoaXMuX3RyYW5zZm9ybXMgPSB0cmFuc2Zvcm1zOwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEFuaW1hdGVkVHJhbnNmb3JtLCBbewogICAgICBrZXk6ICJfX21ha2VOYXRpdmUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19tYWtlTmF0aXZlKCkgewogICAgICAgIGJhYmVsSGVscGVycy5nZXQoQW5pbWF0ZWRUcmFuc2Zvcm0ucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWRUcmFuc2Zvcm0ucHJvdG90eXBlKSwgIl9fbWFrZU5hdGl2ZSIsIHRoaXMpLmNhbGwodGhpcyk7CgogICAgICAgIHRoaXMuX3RyYW5zZm9ybXMuZm9yRWFjaChmdW5jdGlvbiAodHJhbnNmb3JtKSB7CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gdHJhbnNmb3JtKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRyYW5zZm9ybVtrZXldOwoKICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQW5pbWF0ZWROb2RlKSB7CiAgICAgICAgICAgICAgdmFsdWUuX19tYWtlTmF0aXZlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2dldFZhbHVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0VmFsdWUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3RyYW5zZm9ybXMubWFwKGZ1bmN0aW9uICh0cmFuc2Zvcm0pIHsKICAgICAgICAgIHZhciByZXN1bHQgPSB7fTsKCiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gdHJhbnNmb3JtKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRyYW5zZm9ybVtrZXldOwoKICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQW5pbWF0ZWROb2RlKSB7CiAgICAgICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZS5fX2dldFZhbHVlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXRBbmltYXRlZFZhbHVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0QW5pbWF0ZWRWYWx1ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdHJhbnNmb3Jtcy5tYXAoZnVuY3Rpb24gKHRyYW5zZm9ybSkgewogICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwoKICAgICAgICAgIGZvciAodmFyIGtleSBpbiB0cmFuc2Zvcm0pIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdHJhbnNmb3JtW2tleV07CgogICAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBbmltYXRlZE5vZGUpIHsKICAgICAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlLl9fZ2V0QW5pbWF0ZWRWYWx1ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fYXR0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fYXR0YWNoKCkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICB0aGlzLl90cmFuc2Zvcm1zLmZvckVhY2goZnVuY3Rpb24gKHRyYW5zZm9ybSkgewogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRyYW5zZm9ybSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB0cmFuc2Zvcm1ba2V5XTsKCiAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkTm9kZSkgewogICAgICAgICAgICAgIHZhbHVlLl9fYWRkQ2hpbGQoX3RoaXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZGV0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZGV0YWNoKCkgewogICAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgICB0aGlzLl90cmFuc2Zvcm1zLmZvckVhY2goZnVuY3Rpb24gKHRyYW5zZm9ybSkgewogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRyYW5zZm9ybSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB0cmFuc2Zvcm1ba2V5XTsKCiAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkTm9kZSkgewogICAgICAgICAgICAgIHZhbHVlLl9fcmVtb3ZlQ2hpbGQoX3RoaXMzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KEFuaW1hdGVkVHJhbnNmb3JtLnByb3RvdHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEFuaW1hdGVkVHJhbnNmb3JtLnByb3RvdHlwZSksICJfX2RldGFjaCIsIHRoaXMpLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX19nZXROYXRpdmVDb25maWciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXROYXRpdmVDb25maWcoKSB7CiAgICAgICAgdmFyIHRyYW5zQ29uZmlncyA9IFtdOwoKICAgICAgICB0aGlzLl90cmFuc2Zvcm1zLmZvckVhY2goZnVuY3Rpb24gKHRyYW5zZm9ybSkgewogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRyYW5zZm9ybSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB0cmFuc2Zvcm1ba2V5XTsKCiAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkTm9kZSkgewogICAgICAgICAgICAgIHRyYW5zQ29uZmlncy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6ICdhbmltYXRlZCcsCiAgICAgICAgICAgICAgICBwcm9wZXJ0eToga2V5LAogICAgICAgICAgICAgICAgbm9kZVRhZzogdmFsdWUuX19nZXROYXRpdmVUYWcoKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRyYW5zQ29uZmlncy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6ICdzdGF0aWMnLAogICAgICAgICAgICAgICAgcHJvcGVydHk6IGtleSwKICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIE5hdGl2ZUFuaW1hdGVkSGVscGVyLnZhbGlkYXRlVHJhbnNmb3JtKHRyYW5zQ29uZmlncyk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICd0cmFuc2Zvcm0nLAogICAgICAgICAgdHJhbnNmb3JtczogdHJhbnNDb25maWdzCiAgICAgICAgfTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEFuaW1hdGVkVHJhbnNmb3JtOwogIH0oQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pOwoKICBtb2R1bGUuZXhwb3J0cyA9IEFuaW1hdGVkVHJhbnNmb3JtOwp9LDIxMSxbMTk5LDIwMSwyMDBdLCJBbmltYXRlZFRyYW5zZm9ybSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEFuaW1hdGVkVmFsdWUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9BbmltYXRlZFZhbHVlJyk7CgogIHZhciBBbmltYXRlZE5vZGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAnLi9BbmltYXRlZE5vZGUnKTsKCiAgdmFyIEFuaW1hdGVkVHJhY2tpbmcgPSBmdW5jdGlvbiAoX0FuaW1hdGVkTm9kZSkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKEFuaW1hdGVkVHJhY2tpbmcsIF9BbmltYXRlZE5vZGUpOwoKICAgIGZ1bmN0aW9uIEFuaW1hdGVkVHJhY2tpbmcodmFsdWUsIHBhcmVudCwgYW5pbWF0aW9uQ2xhc3MsIGFuaW1hdGlvbkNvbmZpZywgY2FsbGJhY2spIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEFuaW1hdGVkVHJhY2tpbmcpOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKEFuaW1hdGVkVHJhY2tpbmcuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBbmltYXRlZFRyYWNraW5nKSkuY2FsbCh0aGlzKSk7CgogICAgICBfdGhpcy5fdmFsdWUgPSB2YWx1ZTsKICAgICAgX3RoaXMuX3BhcmVudCA9IHBhcmVudDsKICAgICAgX3RoaXMuX2FuaW1hdGlvbkNsYXNzID0gYW5pbWF0aW9uQ2xhc3M7CiAgICAgIF90aGlzLl9hbmltYXRpb25Db25maWcgPSBhbmltYXRpb25Db25maWc7CiAgICAgIF90aGlzLl9jYWxsYmFjayA9IGNhbGxiYWNrOwoKICAgICAgX3RoaXMuX19hdHRhY2goKTsKCiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQW5pbWF0ZWRUcmFja2luZywgW3sKICAgICAga2V5OiAiX19nZXRWYWx1ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2dldFZhbHVlKCkgewogICAgICAgIHJldHVybiB0aGlzLl9wYXJlbnQuX19nZXRWYWx1ZSgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fYXR0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fYXR0YWNoKCkgewogICAgICAgIHRoaXMuX3BhcmVudC5fX2FkZENoaWxkKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZGV0YWNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZGV0YWNoKCkgewogICAgICAgIHRoaXMuX3BhcmVudC5fX3JlbW92ZUNoaWxkKHRoaXMpOwoKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KEFuaW1hdGVkVHJhY2tpbmcucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWRUcmFja2luZy5wcm90b3R5cGUpLCAiX19kZXRhY2giLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInVwZGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiB1cGRhdGUoKSB7CiAgICAgICAgdGhpcy5fdmFsdWUuYW5pbWF0ZShuZXcgdGhpcy5fYW5pbWF0aW9uQ2xhc3MoYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHRoaXMuX2FuaW1hdGlvbkNvbmZpZywgewogICAgICAgICAgdG9WYWx1ZTogdGhpcy5fYW5pbWF0aW9uQ29uZmlnLnRvVmFsdWUuX19nZXRWYWx1ZSgpCiAgICAgICAgfSkpLCB0aGlzLl9jYWxsYmFjayk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBBbmltYXRlZFRyYWNraW5nOwogIH0oQW5pbWF0ZWROb2RlKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBBbmltYXRlZFRyYWNraW5nOwp9LDIxMixbMTk3LDE5OV0sIkFuaW1hdGVkVHJhY2tpbmciKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBBbmltYXRlZFZhbHVlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgJy4vQW5pbWF0ZWRWYWx1ZScpOwoKICB2YXIgQW5pbWF0ZWRXaXRoQ2hpbGRyZW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAnLi9BbmltYXRlZFdpdGhDaGlsZHJlbicpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgX3VuaXF1ZUlkID0gMTsKCiAgdmFyIEFuaW1hdGVkVmFsdWVYWSA9IGZ1bmN0aW9uIChfQW5pbWF0ZWRXaXRoQ2hpbGRyZW4pIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhBbmltYXRlZFZhbHVlWFksIF9BbmltYXRlZFdpdGhDaGlsZHJlbik7CgogICAgZnVuY3Rpb24gQW5pbWF0ZWRWYWx1ZVhZKHZhbHVlSW4pIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEFuaW1hdGVkVmFsdWVYWSk7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoQW5pbWF0ZWRWYWx1ZVhZLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQW5pbWF0ZWRWYWx1ZVhZKSkuY2FsbCh0aGlzKSk7CgogICAgICB2YXIgdmFsdWUgPSB2YWx1ZUluIHx8IHsKICAgICAgICB4OiAwLAogICAgICAgIHk6IDAKICAgICAgfTsKCiAgICAgIGlmICh0eXBlb2YgdmFsdWUueCA9PT0gJ251bWJlcicgJiYgdHlwZW9mIHZhbHVlLnkgPT09ICdudW1iZXInKSB7CiAgICAgICAgX3RoaXMueCA9IG5ldyBBbmltYXRlZFZhbHVlKHZhbHVlLngpOwogICAgICAgIF90aGlzLnkgPSBuZXcgQW5pbWF0ZWRWYWx1ZSh2YWx1ZS55KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbnZhcmlhbnQodmFsdWUueCBpbnN0YW5jZW9mIEFuaW1hdGVkVmFsdWUgJiYgdmFsdWUueSBpbnN0YW5jZW9mIEFuaW1hdGVkVmFsdWUsICdBbmltYXRlZFZhbHVlWFkgbXVzdCBiZSBpbml0YWxpemVkIHdpdGggYW4gb2JqZWN0IG9mIG51bWJlcnMgb3IgJyArICdBbmltYXRlZFZhbHVlcy4nKTsKICAgICAgICBfdGhpcy54ID0gdmFsdWUueDsKICAgICAgICBfdGhpcy55ID0gdmFsdWUueTsKICAgICAgfQoKICAgICAgX3RoaXMuX2xpc3RlbmVycyA9IHt9OwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEFuaW1hdGVkVmFsdWVYWSwgW3sKICAgICAga2V5OiAic2V0VmFsdWUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICB0aGlzLnguc2V0VmFsdWUodmFsdWUueCk7CiAgICAgICAgdGhpcy55LnNldFZhbHVlKHZhbHVlLnkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNldE9mZnNldCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRPZmZzZXQob2Zmc2V0KSB7CiAgICAgICAgdGhpcy54LnNldE9mZnNldChvZmZzZXQueCk7CiAgICAgICAgdGhpcy55LnNldE9mZnNldChvZmZzZXQueSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZmxhdHRlbk9mZnNldCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBmbGF0dGVuT2Zmc2V0KCkgewogICAgICAgIHRoaXMueC5mbGF0dGVuT2Zmc2V0KCk7CiAgICAgICAgdGhpcy55LmZsYXR0ZW5PZmZzZXQoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJleHRyYWN0T2Zmc2V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGV4dHJhY3RPZmZzZXQoKSB7CiAgICAgICAgdGhpcy54LmV4dHJhY3RPZmZzZXQoKTsKICAgICAgICB0aGlzLnkuZXh0cmFjdE9mZnNldCgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9fZ2V0VmFsdWUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXRWYWx1ZSgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgeDogdGhpcy54Ll9fZ2V0VmFsdWUoKSwKICAgICAgICAgIHk6IHRoaXMueS5fX2dldFZhbHVlKCkKICAgICAgICB9OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlc2V0QW5pbWF0aW9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlc2V0QW5pbWF0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdGhpcy54LnJlc2V0QW5pbWF0aW9uKCk7CiAgICAgICAgdGhpcy55LnJlc2V0QW5pbWF0aW9uKCk7CiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2sodGhpcy5fX2dldFZhbHVlKCkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInN0b3BBbmltYXRpb24iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc3RvcEFuaW1hdGlvbihjYWxsYmFjaykgewogICAgICAgIHRoaXMueC5zdG9wQW5pbWF0aW9uKCk7CiAgICAgICAgdGhpcy55LnN0b3BBbmltYXRpb24oKTsKICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayh0aGlzLl9fZ2V0VmFsdWUoKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYWRkTGlzdGVuZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gYWRkTGlzdGVuZXIoY2FsbGJhY2spIHsKICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgICAgdmFyIGlkID0gU3RyaW5nKF91bmlxdWVJZCsrKTsKCiAgICAgICAgdmFyIGpvaW50Q2FsbGJhY2sgPSBmdW5jdGlvbiBqb2ludENhbGxiYWNrKF9yZWYpIHsKICAgICAgICAgIHZhciBudW1iZXIgPSBfcmVmLnZhbHVlOwogICAgICAgICAgY2FsbGJhY2soX3RoaXMyLl9fZ2V0VmFsdWUoKSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5fbGlzdGVuZXJzW2lkXSA9IHsKICAgICAgICAgIHg6IHRoaXMueC5hZGRMaXN0ZW5lcihqb2ludENhbGxiYWNrKSwKICAgICAgICAgIHk6IHRoaXMueS5hZGRMaXN0ZW5lcihqb2ludENhbGxiYWNrKQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGlkOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZUxpc3RlbmVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVyKGlkKSB7CiAgICAgICAgdGhpcy54LnJlbW92ZUxpc3RlbmVyKHRoaXMuX2xpc3RlbmVyc1tpZF0ueCk7CiAgICAgICAgdGhpcy55LnJlbW92ZUxpc3RlbmVyKHRoaXMuX2xpc3RlbmVyc1tpZF0ueSk7CiAgICAgICAgZGVsZXRlIHRoaXMuX2xpc3RlbmVyc1tpZF07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVtb3ZlQWxsTGlzdGVuZXJzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUFsbExpc3RlbmVycygpIHsKICAgICAgICB0aGlzLngucmVtb3ZlQWxsTGlzdGVuZXJzKCk7CiAgICAgICAgdGhpcy55LnJlbW92ZUFsbExpc3RlbmVycygpOwogICAgICAgIHRoaXMuX2xpc3RlbmVycyA9IHt9OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldExheW91dCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRMYXlvdXQoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGxlZnQ6IHRoaXMueCwKICAgICAgICAgIHRvcDogdGhpcy55CiAgICAgICAgfTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRUcmFuc2xhdGVUcmFuc2Zvcm0iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0VHJhbnNsYXRlVHJhbnNmb3JtKCkgewogICAgICAgIHJldHVybiBbewogICAgICAgICAgdHJhbnNsYXRlWDogdGhpcy54CiAgICAgICAgfSwgewogICAgICAgICAgdHJhbnNsYXRlWTogdGhpcy55CiAgICAgICAgfV07CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBBbmltYXRlZFZhbHVlWFk7CiAgfShBbmltYXRlZFdpdGhDaGlsZHJlbik7CgogIG1vZHVsZS5leHBvcnRzID0gQW5pbWF0ZWRWYWx1ZVhZOwp9LDIxMyxbMTk3LDIwMSwxM10sIkFuaW1hdGVkVmFsdWVYWSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEFuaW1hdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL0FuaW1hdGlvbicpOwoKICB2YXIgX3JlcXVpcmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAnLi4vTmF0aXZlQW5pbWF0ZWRIZWxwZXInKSwKICAgICAgc2hvdWxkVXNlTmF0aXZlRHJpdmVyID0gX3JlcXVpcmUuc2hvdWxkVXNlTmF0aXZlRHJpdmVyOwoKICB2YXIgRGVjYXlBbmltYXRpb24gPSBmdW5jdGlvbiAoX0FuaW1hdGlvbikgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKERlY2F5QW5pbWF0aW9uLCBfQW5pbWF0aW9uKTsKCiAgICBmdW5jdGlvbiBEZWNheUFuaW1hdGlvbihjb25maWcpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIERlY2F5QW5pbWF0aW9uKTsKCiAgICAgIHZhciBfdGhpcyA9IGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChEZWNheUFuaW1hdGlvbi5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKERlY2F5QW5pbWF0aW9uKSkuY2FsbCh0aGlzKSk7CgogICAgICBfdGhpcy5fZGVjZWxlcmF0aW9uID0gY29uZmlnLmRlY2VsZXJhdGlvbiAhPT0gdW5kZWZpbmVkID8gY29uZmlnLmRlY2VsZXJhdGlvbiA6IDAuOTk4OwogICAgICBfdGhpcy5fdmVsb2NpdHkgPSBjb25maWcudmVsb2NpdHk7CiAgICAgIF90aGlzLl91c2VOYXRpdmVEcml2ZXIgPSBzaG91bGRVc2VOYXRpdmVEcml2ZXIoY29uZmlnKTsKICAgICAgX3RoaXMuX19pc0ludGVyYWN0aW9uID0gY29uZmlnLmlzSW50ZXJhY3Rpb24gIT09IHVuZGVmaW5lZCA/IGNvbmZpZy5pc0ludGVyYWN0aW9uIDogdHJ1ZTsKICAgICAgX3RoaXMuX19pdGVyYXRpb25zID0gY29uZmlnLml0ZXJhdGlvbnMgIT09IHVuZGVmaW5lZCA/IGNvbmZpZy5pdGVyYXRpb25zIDogMTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhEZWNheUFuaW1hdGlvbiwgW3sKICAgICAga2V5OiAiX19nZXROYXRpdmVBbmltYXRpb25Db25maWciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX19nZXROYXRpdmVBbmltYXRpb25Db25maWcoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICdkZWNheScsCiAgICAgICAgICBkZWNlbGVyYXRpb246IHRoaXMuX2RlY2VsZXJhdGlvbiwKICAgICAgICAgIHZlbG9jaXR5OiB0aGlzLl92ZWxvY2l0eSwKICAgICAgICAgIGl0ZXJhdGlvbnM6IHRoaXMuX19pdGVyYXRpb25zCiAgICAgICAgfTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzdGFydCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzdGFydChmcm9tVmFsdWUsIG9uVXBkYXRlLCBvbkVuZCwgcHJldmlvdXNBbmltYXRpb24sIGFuaW1hdGVkVmFsdWUpIHsKICAgICAgICB0aGlzLl9fYWN0aXZlID0gdHJ1ZTsKICAgICAgICB0aGlzLl9sYXN0VmFsdWUgPSBmcm9tVmFsdWU7CiAgICAgICAgdGhpcy5fZnJvbVZhbHVlID0gZnJvbVZhbHVlOwogICAgICAgIHRoaXMuX29uVXBkYXRlID0gb25VcGRhdGU7CiAgICAgICAgdGhpcy5fX29uRW5kID0gb25FbmQ7CiAgICAgICAgdGhpcy5fc3RhcnRUaW1lID0gRGF0ZS5ub3coKTsKCiAgICAgICAgaWYgKHRoaXMuX3VzZU5hdGl2ZURyaXZlcikgewogICAgICAgICAgdGhpcy5fX3N0YXJ0TmF0aXZlQW5pbWF0aW9uKGFuaW1hdGVkVmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9hbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLm9uVXBkYXRlLmJpbmQodGhpcykpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJvblVwZGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBvblVwZGF0ZSgpIHsKICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLl9mcm9tVmFsdWUgKyB0aGlzLl92ZWxvY2l0eSAvICgxIC0gdGhpcy5fZGVjZWxlcmF0aW9uKSAqICgxIC0gTWF0aC5leHAoLSgxIC0gdGhpcy5fZGVjZWxlcmF0aW9uKSAqIChub3cgLSB0aGlzLl9zdGFydFRpbWUpKSk7CgogICAgICAgIHRoaXMuX29uVXBkYXRlKHZhbHVlKTsKCiAgICAgICAgaWYgKE1hdGguYWJzKHRoaXMuX2xhc3RWYWx1ZSAtIHZhbHVlKSA8IDAuMSkgewogICAgICAgICAgdGhpcy5fX2RlYm91bmNlZE9uRW5kKHsKICAgICAgICAgICAgZmluaXNoZWQ6IHRydWUKICAgICAgICAgIH0pOwoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2xhc3RWYWx1ZSA9IHZhbHVlOwoKICAgICAgICBpZiAodGhpcy5fX2FjdGl2ZSkgewogICAgICAgICAgdGhpcy5fYW5pbWF0aW9uRnJhbWUgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5vblVwZGF0ZS5iaW5kKHRoaXMpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic3RvcCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzdG9wKCkgewogICAgICAgIGJhYmVsSGVscGVycy5nZXQoRGVjYXlBbmltYXRpb24ucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoRGVjYXlBbmltYXRpb24ucHJvdG90eXBlKSwgInN0b3AiLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuX19hY3RpdmUgPSBmYWxzZTsKICAgICAgICBnbG9iYWwuY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5fYW5pbWF0aW9uRnJhbWUpOwoKICAgICAgICB0aGlzLl9fZGVib3VuY2VkT25FbmQoewogICAgICAgICAgZmluaXNoZWQ6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBEZWNheUFuaW1hdGlvbjsKICB9KEFuaW1hdGlvbik7CgogIG1vZHVsZS5leHBvcnRzID0gRGVjYXlBbmltYXRpb247Cn0sMjE0LFsyMTUsMjAwXSwiRGVjYXlBbmltYXRpb24iKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBOYXRpdmVBbmltYXRlZEhlbHBlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVBbmltYXRlZEhlbHBlciIpOwoKICB2YXIgQW5pbWF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQW5pbWF0aW9uKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQW5pbWF0aW9uKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQW5pbWF0aW9uLCBbewogICAgICBrZXk6ICJzdGFydCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzdGFydChmcm9tVmFsdWUsIG9uVXBkYXRlLCBvbkVuZCwgcHJldmlvdXNBbmltYXRpb24sIGFuaW1hdGVkVmFsdWUpIHt9CiAgICB9LCB7CiAgICAgIGtleTogInN0b3AiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc3RvcCgpIHsKICAgICAgICBpZiAodGhpcy5fX25hdGl2ZUlkKSB7CiAgICAgICAgICBOYXRpdmVBbmltYXRlZEhlbHBlci5BUEkuc3RvcEFuaW1hdGlvbih0aGlzLl9fbmF0aXZlSWQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2dldE5hdGl2ZUFuaW1hdGlvbkNvbmZpZyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2dldE5hdGl2ZUFuaW1hdGlvbkNvbmZpZygpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoaXMgYW5pbWF0aW9uIHR5cGUgY2Fubm90IGJlIG9mZmxvYWRlZCB0byBuYXRpdmUnKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX2RlYm91bmNlZE9uRW5kIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZGVib3VuY2VkT25FbmQocmVzdWx0KSB7CiAgICAgICAgdmFyIG9uRW5kID0gdGhpcy5fX29uRW5kOwogICAgICAgIHRoaXMuX19vbkVuZCA9IG51bGw7CiAgICAgICAgb25FbmQgJiYgb25FbmQocmVzdWx0KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfX3N0YXJ0TmF0aXZlQW5pbWF0aW9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fc3RhcnROYXRpdmVBbmltYXRpb24oYW5pbWF0ZWRWYWx1ZSkgewogICAgICAgIGFuaW1hdGVkVmFsdWUuX19tYWtlTmF0aXZlKCk7CgogICAgICAgIHRoaXMuX19uYXRpdmVJZCA9IE5hdGl2ZUFuaW1hdGVkSGVscGVyLmdlbmVyYXRlTmV3QW5pbWF0aW9uSWQoKTsKICAgICAgICBOYXRpdmVBbmltYXRlZEhlbHBlci5BUEkuc3RhcnRBbmltYXRpbmdOb2RlKHRoaXMuX19uYXRpdmVJZCwgYW5pbWF0ZWRWYWx1ZS5fX2dldE5hdGl2ZVRhZygpLCB0aGlzLl9fZ2V0TmF0aXZlQW5pbWF0aW9uQ29uZmlnKCksIHRoaXMuX19kZWJvdW5jZWRPbkVuZC5iaW5kKHRoaXMpKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEFuaW1hdGlvbjsKICB9KCk7CgogIG1vZHVsZS5leHBvcnRzID0gQW5pbWF0aW9uOwp9LDIxNSxbMjAwXSwiQW5pbWF0aW9uIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgQW5pbWF0ZWRWYWx1ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuLi9ub2Rlcy9BbmltYXRlZFZhbHVlJyk7CgogIHZhciBBbmltYXRlZFZhbHVlWFkgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAnLi4vbm9kZXMvQW5pbWF0ZWRWYWx1ZVhZJyk7CgogIHZhciBBbmltYXRpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAnLi9BbmltYXRpb24nKTsKCiAgdmFyIFNwcmluZ0NvbmZpZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICcuLi9TcHJpbmdDb25maWcnKTsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgJy4uL05hdGl2ZUFuaW1hdGVkSGVscGVyJyksCiAgICAgIHNob3VsZFVzZU5hdGl2ZURyaXZlciA9IF9yZXF1aXJlLnNob3VsZFVzZU5hdGl2ZURyaXZlcjsKCiAgZnVuY3Rpb24gd2l0aERlZmF1bHQodmFsdWUsIGRlZmF1bHRWYWx1ZSkgewogICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWU7CiAgfQoKICB2YXIgU3ByaW5nQW5pbWF0aW9uID0gZnVuY3Rpb24gKF9BbmltYXRpb24pIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhTcHJpbmdBbmltYXRpb24sIF9BbmltYXRpb24pOwoKICAgIGZ1bmN0aW9uIFNwcmluZ0FuaW1hdGlvbihjb25maWcpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFNwcmluZ0FuaW1hdGlvbik7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoU3ByaW5nQW5pbWF0aW9uLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoU3ByaW5nQW5pbWF0aW9uKSkuY2FsbCh0aGlzKSk7CgogICAgICBfdGhpcy5fb3ZlcnNob290Q2xhbXBpbmcgPSB3aXRoRGVmYXVsdChjb25maWcub3ZlcnNob290Q2xhbXBpbmcsIGZhbHNlKTsKICAgICAgX3RoaXMuX3Jlc3REaXNwbGFjZW1lbnRUaHJlc2hvbGQgPSB3aXRoRGVmYXVsdChjb25maWcucmVzdERpc3BsYWNlbWVudFRocmVzaG9sZCwgMC4wMDEpOwogICAgICBfdGhpcy5fcmVzdFNwZWVkVGhyZXNob2xkID0gd2l0aERlZmF1bHQoY29uZmlnLnJlc3RTcGVlZFRocmVzaG9sZCwgMC4wMDEpOwogICAgICBfdGhpcy5faW5pdGlhbFZlbG9jaXR5ID0gd2l0aERlZmF1bHQoY29uZmlnLnZlbG9jaXR5LCAwKTsKICAgICAgX3RoaXMuX2xhc3RWZWxvY2l0eSA9IHdpdGhEZWZhdWx0KGNvbmZpZy52ZWxvY2l0eSwgMCk7CiAgICAgIF90aGlzLl90b1ZhbHVlID0gY29uZmlnLnRvVmFsdWU7CiAgICAgIF90aGlzLl9kZWxheSA9IHdpdGhEZWZhdWx0KGNvbmZpZy5kZWxheSwgMCk7CiAgICAgIF90aGlzLl91c2VOYXRpdmVEcml2ZXIgPSBzaG91bGRVc2VOYXRpdmVEcml2ZXIoY29uZmlnKTsKICAgICAgX3RoaXMuX19pc0ludGVyYWN0aW9uID0gY29uZmlnLmlzSW50ZXJhY3Rpb24gIT09IHVuZGVmaW5lZCA/IGNvbmZpZy5pc0ludGVyYWN0aW9uIDogdHJ1ZTsKICAgICAgX3RoaXMuX19pdGVyYXRpb25zID0gY29uZmlnLml0ZXJhdGlvbnMgIT09IHVuZGVmaW5lZCA/IGNvbmZpZy5pdGVyYXRpb25zIDogMTsKCiAgICAgIGlmIChjb25maWcuc3RpZmZuZXNzICE9PSB1bmRlZmluZWQgfHwgY29uZmlnLmRhbXBpbmcgIT09IHVuZGVmaW5lZCB8fCBjb25maWcubWFzcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaW52YXJpYW50KGNvbmZpZy5ib3VuY2luZXNzID09PSB1bmRlZmluZWQgJiYgY29uZmlnLnNwZWVkID09PSB1bmRlZmluZWQgJiYgY29uZmlnLnRlbnNpb24gPT09IHVuZGVmaW5lZCAmJiBjb25maWcuZnJpY3Rpb24gPT09IHVuZGVmaW5lZCwgJ1lvdSBjYW4gZGVmaW5lIG9uZSBvZiBib3VuY2luZXNzL3NwZWVkLCB0ZW5zaW9uL2ZyaWN0aW9uLCBvciBzdGlmZm5lc3MvZGFtcGluZy9tYXNzLCBidXQgbm90IG1vcmUgdGhhbiBvbmUnKTsKICAgICAgICBfdGhpcy5fc3RpZmZuZXNzID0gd2l0aERlZmF1bHQoY29uZmlnLnN0aWZmbmVzcywgMTAwKTsKICAgICAgICBfdGhpcy5fZGFtcGluZyA9IHdpdGhEZWZhdWx0KGNvbmZpZy5kYW1waW5nLCAxMCk7CiAgICAgICAgX3RoaXMuX21hc3MgPSB3aXRoRGVmYXVsdChjb25maWcubWFzcywgMSk7CiAgICAgIH0gZWxzZSBpZiAoY29uZmlnLmJvdW5jaW5lc3MgIT09IHVuZGVmaW5lZCB8fCBjb25maWcuc3BlZWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGludmFyaWFudChjb25maWcudGVuc2lvbiA9PT0gdW5kZWZpbmVkICYmIGNvbmZpZy5mcmljdGlvbiA9PT0gdW5kZWZpbmVkICYmIGNvbmZpZy5zdGlmZm5lc3MgPT09IHVuZGVmaW5lZCAmJiBjb25maWcuZGFtcGluZyA9PT0gdW5kZWZpbmVkICYmIGNvbmZpZy5tYXNzID09PSB1bmRlZmluZWQsICdZb3UgY2FuIGRlZmluZSBvbmUgb2YgYm91bmNpbmVzcy9zcGVlZCwgdGVuc2lvbi9mcmljdGlvbiwgb3Igc3RpZmZuZXNzL2RhbXBpbmcvbWFzcywgYnV0IG5vdCBtb3JlIHRoYW4gb25lJyk7CiAgICAgICAgdmFyIHNwcmluZ0NvbmZpZyA9IFNwcmluZ0NvbmZpZy5mcm9tQm91bmNpbmVzc0FuZFNwZWVkKHdpdGhEZWZhdWx0KGNvbmZpZy5ib3VuY2luZXNzLCA4KSwgd2l0aERlZmF1bHQoY29uZmlnLnNwZWVkLCAxMikpOwogICAgICAgIF90aGlzLl9zdGlmZm5lc3MgPSBzcHJpbmdDb25maWcuc3RpZmZuZXNzOwogICAgICAgIF90aGlzLl9kYW1waW5nID0gc3ByaW5nQ29uZmlnLmRhbXBpbmc7CiAgICAgICAgX3RoaXMuX21hc3MgPSAxOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBfc3ByaW5nQ29uZmlnID0gU3ByaW5nQ29uZmlnLmZyb21PcmlnYW1pVGVuc2lvbkFuZEZyaWN0aW9uKHdpdGhEZWZhdWx0KGNvbmZpZy50ZW5zaW9uLCA0MCksIHdpdGhEZWZhdWx0KGNvbmZpZy5mcmljdGlvbiwgNykpOwoKICAgICAgICBfdGhpcy5fc3RpZmZuZXNzID0gX3NwcmluZ0NvbmZpZy5zdGlmZm5lc3M7CiAgICAgICAgX3RoaXMuX2RhbXBpbmcgPSBfc3ByaW5nQ29uZmlnLmRhbXBpbmc7CiAgICAgICAgX3RoaXMuX21hc3MgPSAxOwogICAgICB9CgogICAgICBpbnZhcmlhbnQoX3RoaXMuX3N0aWZmbmVzcyA+IDAsICdTdGlmZm5lc3MgdmFsdWUgbXVzdCBiZSBncmVhdGVyIHRoYW4gMCcpOwogICAgICBpbnZhcmlhbnQoX3RoaXMuX2RhbXBpbmcgPiAwLCAnRGFtcGluZyB2YWx1ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwJyk7CiAgICAgIGludmFyaWFudChfdGhpcy5fbWFzcyA+IDAsICdNYXNzIHZhbHVlIG11c3QgYmUgZ3JlYXRlciB0aGFuIDAnKTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhTcHJpbmdBbmltYXRpb24sIFt7CiAgICAgIGtleTogIl9fZ2V0TmF0aXZlQW5pbWF0aW9uQ29uZmlnIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9fZ2V0TmF0aXZlQW5pbWF0aW9uQ29uZmlnKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAnc3ByaW5nJywKICAgICAgICAgIG92ZXJzaG9vdENsYW1waW5nOiB0aGlzLl9vdmVyc2hvb3RDbGFtcGluZywKICAgICAgICAgIHJlc3REaXNwbGFjZW1lbnRUaHJlc2hvbGQ6IHRoaXMuX3Jlc3REaXNwbGFjZW1lbnRUaHJlc2hvbGQsCiAgICAgICAgICByZXN0U3BlZWRUaHJlc2hvbGQ6IHRoaXMuX3Jlc3RTcGVlZFRocmVzaG9sZCwKICAgICAgICAgIHN0aWZmbmVzczogdGhpcy5fc3RpZmZuZXNzLAogICAgICAgICAgZGFtcGluZzogdGhpcy5fZGFtcGluZywKICAgICAgICAgIG1hc3M6IHRoaXMuX21hc3MsCiAgICAgICAgICBpbml0aWFsVmVsb2NpdHk6IHdpdGhEZWZhdWx0KHRoaXMuX2luaXRpYWxWZWxvY2l0eSwgdGhpcy5fbGFzdFZlbG9jaXR5KSwKICAgICAgICAgIHRvVmFsdWU6IHRoaXMuX3RvVmFsdWUsCiAgICAgICAgICBpdGVyYXRpb25zOiB0aGlzLl9faXRlcmF0aW9ucwogICAgICAgIH07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic3RhcnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc3RhcnQoZnJvbVZhbHVlLCBvblVwZGF0ZSwgb25FbmQsIHByZXZpb3VzQW5pbWF0aW9uLCBhbmltYXRlZFZhbHVlKSB7CiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICAgIHRoaXMuX19hY3RpdmUgPSB0cnVlOwogICAgICAgIHRoaXMuX3N0YXJ0UG9zaXRpb24gPSBmcm9tVmFsdWU7CiAgICAgICAgdGhpcy5fbGFzdFBvc2l0aW9uID0gdGhpcy5fc3RhcnRQb3NpdGlvbjsKICAgICAgICB0aGlzLl9vblVwZGF0ZSA9IG9uVXBkYXRlOwogICAgICAgIHRoaXMuX19vbkVuZCA9IG9uRW5kOwogICAgICAgIHRoaXMuX2xhc3RUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICB0aGlzLl9mcmFtZVRpbWUgPSAwLjA7CgogICAgICAgIGlmIChwcmV2aW91c0FuaW1hdGlvbiBpbnN0YW5jZW9mIFNwcmluZ0FuaW1hdGlvbikgewogICAgICAgICAgdmFyIGludGVybmFsU3RhdGUgPSBwcmV2aW91c0FuaW1hdGlvbi5nZXRJbnRlcm5hbFN0YXRlKCk7CiAgICAgICAgICB0aGlzLl9sYXN0UG9zaXRpb24gPSBpbnRlcm5hbFN0YXRlLmxhc3RQb3NpdGlvbjsKICAgICAgICAgIHRoaXMuX2xhc3RWZWxvY2l0eSA9IGludGVybmFsU3RhdGUubGFzdFZlbG9jaXR5OwogICAgICAgICAgdGhpcy5faW5pdGlhbFZlbG9jaXR5ID0gdGhpcy5fbGFzdFZlbG9jaXR5OwogICAgICAgICAgdGhpcy5fbGFzdFRpbWUgPSBpbnRlcm5hbFN0YXRlLmxhc3RUaW1lOwogICAgICAgIH0KCiAgICAgICAgdmFyIHN0YXJ0ID0gZnVuY3Rpb24gc3RhcnQoKSB7CiAgICAgICAgICBpZiAoX3RoaXMyLl91c2VOYXRpdmVEcml2ZXIpIHsKICAgICAgICAgICAgX3RoaXMyLl9fc3RhcnROYXRpdmVBbmltYXRpb24oYW5pbWF0ZWRWYWx1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfdGhpczIub25VcGRhdGUoKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBpZiAodGhpcy5fZGVsYXkpIHsKICAgICAgICAgIHRoaXMuX3RpbWVvdXQgPSBzZXRUaW1lb3V0KHN0YXJ0LCB0aGlzLl9kZWxheSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0YXJ0KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldEludGVybmFsU3RhdGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0SW50ZXJuYWxTdGF0ZSgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbGFzdFBvc2l0aW9uOiB0aGlzLl9sYXN0UG9zaXRpb24sCiAgICAgICAgICBsYXN0VmVsb2NpdHk6IHRoaXMuX2xhc3RWZWxvY2l0eSwKICAgICAgICAgIGxhc3RUaW1lOiB0aGlzLl9sYXN0VGltZQogICAgICAgIH07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAib25VcGRhdGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gb25VcGRhdGUoKSB7CiAgICAgICAgdmFyIE1BWF9TVEVQUyA9IDY0OwogICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpOwoKICAgICAgICBpZiAobm93ID4gdGhpcy5fbGFzdFRpbWUgKyBNQVhfU1RFUFMpIHsKICAgICAgICAgIG5vdyA9IHRoaXMuX2xhc3RUaW1lICsgTUFYX1NURVBTOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRlbHRhVGltZSA9IChub3cgLSB0aGlzLl9sYXN0VGltZSkgLyAxMDAwOwogICAgICAgIHRoaXMuX2ZyYW1lVGltZSArPSBkZWx0YVRpbWU7CiAgICAgICAgdmFyIGMgPSB0aGlzLl9kYW1waW5nOwogICAgICAgIHZhciBtID0gdGhpcy5fbWFzczsKICAgICAgICB2YXIgayA9IHRoaXMuX3N0aWZmbmVzczsKICAgICAgICB2YXIgdjAgPSAtdGhpcy5faW5pdGlhbFZlbG9jaXR5OwogICAgICAgIHZhciB6ZXRhID0gYyAvICgyICogTWF0aC5zcXJ0KGsgKiBtKSk7CiAgICAgICAgdmFyIG9tZWdhMCA9IE1hdGguc3FydChrIC8gbSk7CiAgICAgICAgdmFyIG9tZWdhMSA9IG9tZWdhMCAqIE1hdGguc3FydCgxLjAgLSB6ZXRhICogemV0YSk7CiAgICAgICAgdmFyIHgwID0gdGhpcy5fdG9WYWx1ZSAtIHRoaXMuX3N0YXJ0UG9zaXRpb247CiAgICAgICAgdmFyIHBvc2l0aW9uID0gMC4wOwogICAgICAgIHZhciB2ZWxvY2l0eSA9IDAuMDsKICAgICAgICB2YXIgdCA9IHRoaXMuX2ZyYW1lVGltZTsKCiAgICAgICAgaWYgKHpldGEgPCAxKSB7CiAgICAgICAgICB2YXIgZW52ZWxvcGUgPSBNYXRoLmV4cCgtemV0YSAqIG9tZWdhMCAqIHQpOwogICAgICAgICAgcG9zaXRpb24gPSB0aGlzLl90b1ZhbHVlIC0gZW52ZWxvcGUgKiAoKHYwICsgemV0YSAqIG9tZWdhMCAqIHgwKSAvIG9tZWdhMSAqIE1hdGguc2luKG9tZWdhMSAqIHQpICsgeDAgKiBNYXRoLmNvcyhvbWVnYTEgKiB0KSk7CiAgICAgICAgICB2ZWxvY2l0eSA9IHpldGEgKiBvbWVnYTAgKiBlbnZlbG9wZSAqIChNYXRoLnNpbihvbWVnYTEgKiB0KSAqICh2MCArIHpldGEgKiBvbWVnYTAgKiB4MCkgLyBvbWVnYTEgKyB4MCAqIE1hdGguY29zKG9tZWdhMSAqIHQpKSAtIGVudmVsb3BlICogKE1hdGguY29zKG9tZWdhMSAqIHQpICogKHYwICsgemV0YSAqIG9tZWdhMCAqIHgwKSAtIG9tZWdhMSAqIHgwICogTWF0aC5zaW4ob21lZ2ExICogdCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgX2VudmVsb3BlID0gTWF0aC5leHAoLW9tZWdhMCAqIHQpOwoKICAgICAgICAgIHBvc2l0aW9uID0gdGhpcy5fdG9WYWx1ZSAtIF9lbnZlbG9wZSAqICh4MCArICh2MCArIG9tZWdhMCAqIHgwKSAqIHQpOwogICAgICAgICAgdmVsb2NpdHkgPSBfZW52ZWxvcGUgKiAodjAgKiAodCAqIG9tZWdhMCAtIDEpICsgdCAqIHgwICogKG9tZWdhMCAqIG9tZWdhMCkpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fbGFzdFRpbWUgPSBub3c7CiAgICAgICAgdGhpcy5fbGFzdFBvc2l0aW9uID0gcG9zaXRpb247CiAgICAgICAgdGhpcy5fbGFzdFZlbG9jaXR5ID0gdmVsb2NpdHk7CgogICAgICAgIHRoaXMuX29uVXBkYXRlKHBvc2l0aW9uKTsKCiAgICAgICAgaWYgKCF0aGlzLl9fYWN0aXZlKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgaXNPdmVyc2hvb3RpbmcgPSBmYWxzZTsKCiAgICAgICAgaWYgKHRoaXMuX292ZXJzaG9vdENsYW1waW5nICYmIHRoaXMuX3N0aWZmbmVzcyAhPT0gMCkgewogICAgICAgICAgaWYgKHRoaXMuX3N0YXJ0UG9zaXRpb24gPCB0aGlzLl90b1ZhbHVlKSB7CiAgICAgICAgICAgIGlzT3ZlcnNob290aW5nID0gcG9zaXRpb24gPiB0aGlzLl90b1ZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXNPdmVyc2hvb3RpbmcgPSBwb3NpdGlvbiA8IHRoaXMuX3RvVmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgaXNWZWxvY2l0eSA9IE1hdGguYWJzKHZlbG9jaXR5KSA8PSB0aGlzLl9yZXN0U3BlZWRUaHJlc2hvbGQ7CgogICAgICAgIHZhciBpc0Rpc3BsYWNlbWVudCA9IHRydWU7CgogICAgICAgIGlmICh0aGlzLl9zdGlmZm5lc3MgIT09IDApIHsKICAgICAgICAgIGlzRGlzcGxhY2VtZW50ID0gTWF0aC5hYnModGhpcy5fdG9WYWx1ZSAtIHBvc2l0aW9uKSA8PSB0aGlzLl9yZXN0RGlzcGxhY2VtZW50VGhyZXNob2xkOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzT3ZlcnNob290aW5nIHx8IGlzVmVsb2NpdHkgJiYgaXNEaXNwbGFjZW1lbnQpIHsKICAgICAgICAgIGlmICh0aGlzLl9zdGlmZm5lc3MgIT09IDApIHsKICAgICAgICAgICAgdGhpcy5fbGFzdFBvc2l0aW9uID0gdGhpcy5fdG9WYWx1ZTsKICAgICAgICAgICAgdGhpcy5fbGFzdFZlbG9jaXR5ID0gMDsKCiAgICAgICAgICAgIHRoaXMuX29uVXBkYXRlKHRoaXMuX3RvVmFsdWUpOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuX19kZWJvdW5jZWRPbkVuZCh7CiAgICAgICAgICAgIGZpbmlzaGVkOiB0cnVlCiAgICAgICAgICB9KTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9hbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLm9uVXBkYXRlLmJpbmQodGhpcykpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInN0b3AiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc3RvcCgpIHsKICAgICAgICBiYWJlbEhlbHBlcnMuZ2V0KFNwcmluZ0FuaW1hdGlvbi5wcm90b3R5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihTcHJpbmdBbmltYXRpb24ucHJvdG90eXBlKSwgInN0b3AiLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuX19hY3RpdmUgPSBmYWxzZTsKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dCk7CiAgICAgICAgZ2xvYmFsLmNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMuX2FuaW1hdGlvbkZyYW1lKTsKCiAgICAgICAgdGhpcy5fX2RlYm91bmNlZE9uRW5kKHsKICAgICAgICAgIGZpbmlzaGVkOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gU3ByaW5nQW5pbWF0aW9uOwogIH0oQW5pbWF0aW9uKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBTcHJpbmdBbmltYXRpb247Cn0sMjE2LFsxOTcsMjEzLDIxNSwyMTcsMTMsMjAwXSwiU3ByaW5nQW5pbWF0aW9uIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBzdGlmZm5lc3NGcm9tT3JpZ2FtaVZhbHVlKG9WYWx1ZSkgewogICAgcmV0dXJuIChvVmFsdWUgLSAzMCkgKiAzLjYyICsgMTk0OwogIH0KCiAgZnVuY3Rpb24gZGFtcGluZ0Zyb21PcmlnYW1pVmFsdWUob1ZhbHVlKSB7CiAgICByZXR1cm4gKG9WYWx1ZSAtIDgpICogMyArIDI1OwogIH0KCiAgZnVuY3Rpb24gZnJvbU9yaWdhbWlUZW5zaW9uQW5kRnJpY3Rpb24odGVuc2lvbiwgZnJpY3Rpb24pIHsKICAgIHJldHVybiB7CiAgICAgIHN0aWZmbmVzczogc3RpZmZuZXNzRnJvbU9yaWdhbWlWYWx1ZSh0ZW5zaW9uKSwKICAgICAgZGFtcGluZzogZGFtcGluZ0Zyb21PcmlnYW1pVmFsdWUoZnJpY3Rpb24pCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZnJvbUJvdW5jaW5lc3NBbmRTcGVlZChib3VuY2luZXNzLCBzcGVlZCkgewogICAgZnVuY3Rpb24gbm9ybWFsaXplKHZhbHVlLCBzdGFydFZhbHVlLCBlbmRWYWx1ZSkgewogICAgICByZXR1cm4gKHZhbHVlIC0gc3RhcnRWYWx1ZSkgLyAoZW5kVmFsdWUgLSBzdGFydFZhbHVlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwcm9qZWN0Tm9ybWFsKG4sIHN0YXJ0LCBlbmQpIHsKICAgICAgcmV0dXJuIHN0YXJ0ICsgbiAqIChlbmQgLSBzdGFydCk7CiAgICB9CgogICAgZnVuY3Rpb24gbGluZWFySW50ZXJwb2xhdGlvbih0LCBzdGFydCwgZW5kKSB7CiAgICAgIHJldHVybiB0ICogZW5kICsgKDEgLSB0KSAqIHN0YXJ0OwogICAgfQoKICAgIGZ1bmN0aW9uIHF1YWRyYXRpY091dEludGVycG9sYXRpb24odCwgc3RhcnQsIGVuZCkgewogICAgICByZXR1cm4gbGluZWFySW50ZXJwb2xhdGlvbigyICogdCAtIHQgKiB0LCBzdGFydCwgZW5kKTsKICAgIH0KCiAgICBmdW5jdGlvbiBiM0ZyaWN0aW9uMSh4KSB7CiAgICAgIHJldHVybiAwLjAwMDcgKiBNYXRoLnBvdyh4LCAzKSAtIDAuMDMxICogTWF0aC5wb3coeCwgMikgKyAwLjY0ICogeCArIDEuMjg7CiAgICB9CgogICAgZnVuY3Rpb24gYjNGcmljdGlvbjIoeCkgewogICAgICByZXR1cm4gMC4wMDAwNDQgKiBNYXRoLnBvdyh4LCAzKSAtIDAuMDA2ICogTWF0aC5wb3coeCwgMikgKyAwLjM2ICogeCArIDI7CiAgICB9CgogICAgZnVuY3Rpb24gYjNGcmljdGlvbjMoeCkgewogICAgICByZXR1cm4gMC4wMDAwMDA0NSAqIE1hdGgucG93KHgsIDMpIC0gMC4wMDAzMzIgKiBNYXRoLnBvdyh4LCAyKSArIDAuMTA3OCAqIHggKyA1Ljg0OwogICAgfQoKICAgIGZ1bmN0aW9uIGIzTm9ib3VuY2UodGVuc2lvbikgewogICAgICBpZiAodGVuc2lvbiA8PSAxOCkgewogICAgICAgIHJldHVybiBiM0ZyaWN0aW9uMSh0ZW5zaW9uKTsKICAgICAgfSBlbHNlIGlmICh0ZW5zaW9uID4gMTggJiYgdGVuc2lvbiA8PSA0NCkgewogICAgICAgIHJldHVybiBiM0ZyaWN0aW9uMih0ZW5zaW9uKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gYjNGcmljdGlvbjModGVuc2lvbik7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgYiA9IG5vcm1hbGl6ZShib3VuY2luZXNzIC8gMS43LCAwLCAyMCk7CiAgICBiID0gcHJvamVjdE5vcm1hbChiLCAwLCAwLjgpOwogICAgdmFyIHMgPSBub3JtYWxpemUoc3BlZWQgLyAxLjcsIDAsIDIwKTsKICAgIHZhciBib3VuY3lUZW5zaW9uID0gcHJvamVjdE5vcm1hbChzLCAwLjUsIDIwMCk7CiAgICB2YXIgYm91bmN5RnJpY3Rpb24gPSBxdWFkcmF0aWNPdXRJbnRlcnBvbGF0aW9uKGIsIGIzTm9ib3VuY2UoYm91bmN5VGVuc2lvbiksIDAuMDEpOwogICAgcmV0dXJuIHsKICAgICAgc3RpZmZuZXNzOiBzdGlmZm5lc3NGcm9tT3JpZ2FtaVZhbHVlKGJvdW5jeVRlbnNpb24pLAogICAgICBkYW1waW5nOiBkYW1waW5nRnJvbU9yaWdhbWlWYWx1ZShib3VuY3lGcmljdGlvbikKICAgIH07CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGZyb21PcmlnYW1pVGVuc2lvbkFuZEZyaWN0aW9uOiBmcm9tT3JpZ2FtaVRlbnNpb25BbmRGcmljdGlvbiwKICAgIGZyb21Cb3VuY2luZXNzQW5kU3BlZWQ6IGZyb21Cb3VuY2luZXNzQW5kU3BlZWQKICB9Owp9LDIxNyxbXSwiU3ByaW5nQ29uZmlnIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgQW5pbWF0ZWRWYWx1ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuLi9ub2Rlcy9BbmltYXRlZFZhbHVlJyk7CgogIHZhciBBbmltYXRlZFZhbHVlWFkgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAnLi4vbm9kZXMvQW5pbWF0ZWRWYWx1ZVhZJyk7CgogIHZhciBBbmltYXRpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAnLi9BbmltYXRpb24nKTsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgJy4uL05hdGl2ZUFuaW1hdGVkSGVscGVyJyksCiAgICAgIHNob3VsZFVzZU5hdGl2ZURyaXZlciA9IF9yZXF1aXJlLnNob3VsZFVzZU5hdGl2ZURyaXZlcjsKCiAgdmFyIF9lYXNlSW5PdXQgPSB2b2lkIDA7CgogIGZ1bmN0aW9uIGVhc2VJbk91dCgpIHsKICAgIGlmICghX2Vhc2VJbk91dCkgewogICAgICB2YXIgRWFzaW5nID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIkVhc2luZyIpOwoKICAgICAgX2Vhc2VJbk91dCA9IEVhc2luZy5pbk91dChFYXNpbmcuZWFzZSk7CiAgICB9CgogICAgcmV0dXJuIF9lYXNlSW5PdXQ7CiAgfQoKICB2YXIgVGltaW5nQW5pbWF0aW9uID0gZnVuY3Rpb24gKF9BbmltYXRpb24pIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhUaW1pbmdBbmltYXRpb24sIF9BbmltYXRpb24pOwoKICAgIGZ1bmN0aW9uIFRpbWluZ0FuaW1hdGlvbihjb25maWcpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFRpbWluZ0FuaW1hdGlvbik7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoVGltaW5nQW5pbWF0aW9uLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoVGltaW5nQW5pbWF0aW9uKSkuY2FsbCh0aGlzKSk7CgogICAgICBfdGhpcy5fdG9WYWx1ZSA9IGNvbmZpZy50b1ZhbHVlOwogICAgICBfdGhpcy5fZWFzaW5nID0gY29uZmlnLmVhc2luZyAhPT0gdW5kZWZpbmVkID8gY29uZmlnLmVhc2luZyA6IGVhc2VJbk91dCgpOwogICAgICBfdGhpcy5fZHVyYXRpb24gPSBjb25maWcuZHVyYXRpb24gIT09IHVuZGVmaW5lZCA/IGNvbmZpZy5kdXJhdGlvbiA6IDUwMDsKICAgICAgX3RoaXMuX2RlbGF5ID0gY29uZmlnLmRlbGF5ICE9PSB1bmRlZmluZWQgPyBjb25maWcuZGVsYXkgOiAwOwogICAgICBfdGhpcy5fX2l0ZXJhdGlvbnMgPSBjb25maWcuaXRlcmF0aW9ucyAhPT0gdW5kZWZpbmVkID8gY29uZmlnLml0ZXJhdGlvbnMgOiAxOwogICAgICBfdGhpcy5fX2lzSW50ZXJhY3Rpb24gPSBjb25maWcuaXNJbnRlcmFjdGlvbiAhPT0gdW5kZWZpbmVkID8gY29uZmlnLmlzSW50ZXJhY3Rpb24gOiB0cnVlOwogICAgICBfdGhpcy5fdXNlTmF0aXZlRHJpdmVyID0gc2hvdWxkVXNlTmF0aXZlRHJpdmVyKGNvbmZpZyk7CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoVGltaW5nQW5pbWF0aW9uLCBbewogICAgICBrZXk6ICJfX2dldE5hdGl2ZUFuaW1hdGlvbkNvbmZpZyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfX2dldE5hdGl2ZUFuaW1hdGlvbkNvbmZpZygpIHsKICAgICAgICB2YXIgZnJhbWVEdXJhdGlvbiA9IDEwMDAuMCAvIDYwLjA7CiAgICAgICAgdmFyIGZyYW1lcyA9IFtdOwoKICAgICAgICBmb3IgKHZhciBkdCA9IDAuMDsgZHQgPCB0aGlzLl9kdXJhdGlvbjsgZHQgKz0gZnJhbWVEdXJhdGlvbikgewogICAgICAgICAgZnJhbWVzLnB1c2godGhpcy5fZWFzaW5nKGR0IC8gdGhpcy5fZHVyYXRpb24pKTsKICAgICAgICB9CgogICAgICAgIGZyYW1lcy5wdXNoKHRoaXMuX2Vhc2luZygxKSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICdmcmFtZXMnLAogICAgICAgICAgZnJhbWVzOiBmcmFtZXMsCiAgICAgICAgICB0b1ZhbHVlOiB0aGlzLl90b1ZhbHVlLAogICAgICAgICAgaXRlcmF0aW9uczogdGhpcy5fX2l0ZXJhdGlvbnMKICAgICAgICB9OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInN0YXJ0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHN0YXJ0KGZyb21WYWx1ZSwgb25VcGRhdGUsIG9uRW5kLCBwcmV2aW91c0FuaW1hdGlvbiwgYW5pbWF0ZWRWYWx1ZSkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICB0aGlzLl9fYWN0aXZlID0gdHJ1ZTsKICAgICAgICB0aGlzLl9mcm9tVmFsdWUgPSBmcm9tVmFsdWU7CiAgICAgICAgdGhpcy5fb25VcGRhdGUgPSBvblVwZGF0ZTsKICAgICAgICB0aGlzLl9fb25FbmQgPSBvbkVuZDsKCiAgICAgICAgdmFyIHN0YXJ0ID0gZnVuY3Rpb24gc3RhcnQoKSB7CiAgICAgICAgICBpZiAoX3RoaXMyLl9kdXJhdGlvbiA9PT0gMCAmJiAhX3RoaXMyLl91c2VOYXRpdmVEcml2ZXIpIHsKICAgICAgICAgICAgX3RoaXMyLl9vblVwZGF0ZShfdGhpczIuX3RvVmFsdWUpOwoKICAgICAgICAgICAgX3RoaXMyLl9fZGVib3VuY2VkT25FbmQoewogICAgICAgICAgICAgIGZpbmlzaGVkOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX3RoaXMyLl9zdGFydFRpbWUgPSBEYXRlLm5vdygpOwoKICAgICAgICAgICAgaWYgKF90aGlzMi5fdXNlTmF0aXZlRHJpdmVyKSB7CiAgICAgICAgICAgICAgX3RoaXMyLl9fc3RhcnROYXRpdmVBbmltYXRpb24oYW5pbWF0ZWRWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgX3RoaXMyLl9hbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShfdGhpczIub25VcGRhdGUuYmluZChfdGhpczIpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGlmICh0aGlzLl9kZWxheSkgewogICAgICAgICAgdGhpcy5fdGltZW91dCA9IHNldFRpbWVvdXQoc3RhcnQsIHRoaXMuX2RlbGF5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhcnQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAib25VcGRhdGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gb25VcGRhdGUoKSB7CiAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7CgogICAgICAgIGlmIChub3cgPj0gdGhpcy5fc3RhcnRUaW1lICsgdGhpcy5fZHVyYXRpb24pIHsKICAgICAgICAgIGlmICh0aGlzLl9kdXJhdGlvbiA9PT0gMCkgewogICAgICAgICAgICB0aGlzLl9vblVwZGF0ZSh0aGlzLl90b1ZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX29uVXBkYXRlKHRoaXMuX2Zyb21WYWx1ZSArIHRoaXMuX2Vhc2luZygxKSAqICh0aGlzLl90b1ZhbHVlIC0gdGhpcy5fZnJvbVZhbHVlKSk7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5fX2RlYm91bmNlZE9uRW5kKHsKICAgICAgICAgICAgZmluaXNoZWQ6IHRydWUKICAgICAgICAgIH0pOwoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX29uVXBkYXRlKHRoaXMuX2Zyb21WYWx1ZSArIHRoaXMuX2Vhc2luZygobm93IC0gdGhpcy5fc3RhcnRUaW1lKSAvIHRoaXMuX2R1cmF0aW9uKSAqICh0aGlzLl90b1ZhbHVlIC0gdGhpcy5fZnJvbVZhbHVlKSk7CgogICAgICAgIGlmICh0aGlzLl9fYWN0aXZlKSB7CiAgICAgICAgICB0aGlzLl9hbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLm9uVXBkYXRlLmJpbmQodGhpcykpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzdG9wIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHN0b3AoKSB7CiAgICAgICAgYmFiZWxIZWxwZXJzLmdldChUaW1pbmdBbmltYXRpb24ucHJvdG90eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoVGltaW5nQW5pbWF0aW9uLnByb3RvdHlwZSksICJzdG9wIiwgdGhpcykuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLl9fYWN0aXZlID0gZmFsc2U7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXQpOwogICAgICAgIGdsb2JhbC5jYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLl9hbmltYXRpb25GcmFtZSk7CgogICAgICAgIHRoaXMuX19kZWJvdW5jZWRPbkVuZCh7CiAgICAgICAgICBmaW5pc2hlZDogZmFsc2UKICAgICAgICB9KTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFRpbWluZ0FuaW1hdGlvbjsKICB9KEFuaW1hdGlvbik7CgogIG1vZHVsZS5leHBvcnRzID0gVGltaW5nQW5pbWF0aW9uOwp9LDIxOCxbMTk3LDIxMywyMTUsMjAwLDIxOV0sIlRpbWluZ0FuaW1hdGlvbiIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9lYXNlID0gdm9pZCAwOwoKICB2YXIgRWFzaW5nID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRWFzaW5nKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgRWFzaW5nKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoRWFzaW5nLCBudWxsLCBbewogICAgICBrZXk6ICJzdGVwMCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzdGVwMChuKSB7CiAgICAgICAgcmV0dXJuIG4gPiAwID8gMSA6IDA7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic3RlcDEiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc3RlcDEobikgewogICAgICAgIHJldHVybiBuID49IDEgPyAxIDogMDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJsaW5lYXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gbGluZWFyKHQpIHsKICAgICAgICByZXR1cm4gdDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJlYXNlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGVhc2UodCkgewogICAgICAgIGlmICghX2Vhc2UpIHsKICAgICAgICAgIF9lYXNlID0gRWFzaW5nLmJlemllcigwLjQyLCAwLCAxLCAxKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBfZWFzZSh0KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJxdWFkIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHF1YWQodCkgewogICAgICAgIHJldHVybiB0ICogdDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjdWJpYyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjdWJpYyh0KSB7CiAgICAgICAgcmV0dXJuIHQgKiB0ICogdDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJwb2x5IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHBvbHkobikgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodCkgewogICAgICAgICAgcmV0dXJuIE1hdGgucG93KHQsIG4pOwogICAgICAgIH07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2luIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNpbih0KSB7CiAgICAgICAgcmV0dXJuIDEgLSBNYXRoLmNvcyh0ICogTWF0aC5QSSAvIDIpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNpcmNsZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjaXJjbGUodCkgewogICAgICAgIHJldHVybiAxIC0gTWF0aC5zcXJ0KDEgLSB0ICogdCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZXhwIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGV4cCh0KSB7CiAgICAgICAgcmV0dXJuIE1hdGgucG93KDIsIDEwICogKHQgLSAxKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZWxhc3RpYyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBlbGFzdGljKCkgewogICAgICAgIHZhciBib3VuY2luZXNzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiAxOwogICAgICAgIHZhciBwID0gYm91bmNpbmVzcyAqIE1hdGguUEk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICByZXR1cm4gMSAtIE1hdGgucG93KE1hdGguY29zKHQgKiBNYXRoLlBJIC8gMiksIDMpICogTWF0aC5jb3ModCAqIHApOwogICAgICAgIH07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYmFjayIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBiYWNrKHMpIHsKICAgICAgICBpZiAocyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBzID0gMS43MDE1ODsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAodCkgewogICAgICAgICAgcmV0dXJuIHQgKiB0ICogKChzICsgMSkgKiB0IC0gcyk7CiAgICAgICAgfTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJib3VuY2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gYm91bmNlKHQpIHsKICAgICAgICBpZiAodCA8IDEgLyAyLjc1KSB7CiAgICAgICAgICByZXR1cm4gNy41NjI1ICogdCAqIHQ7CiAgICAgICAgfQoKICAgICAgICBpZiAodCA8IDIgLyAyLjc1KSB7CiAgICAgICAgICB0IC09IDEuNSAvIDIuNzU7CiAgICAgICAgICByZXR1cm4gNy41NjI1ICogdCAqIHQgKyAwLjc1OwogICAgICAgIH0KCiAgICAgICAgaWYgKHQgPCAyLjUgLyAyLjc1KSB7CiAgICAgICAgICB0IC09IDIuMjUgLyAyLjc1OwogICAgICAgICAgcmV0dXJuIDcuNTYyNSAqIHQgKiB0ICsgMC45Mzc1OwogICAgICAgIH0KCiAgICAgICAgdCAtPSAyLjYyNSAvIDIuNzU7CiAgICAgICAgcmV0dXJuIDcuNTYyNSAqIHQgKiB0ICsgMC45ODQzNzU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYmV6aWVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGJlemllcih4MSwgeTEsIHgyLCB5MikgewogICAgICAgIHZhciBfYmV6aWVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgImJlemllciIpOwoKICAgICAgICByZXR1cm4gX2Jlemllcih4MSwgeTEsIHgyLCB5Mik7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaW4iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2luKGVhc2luZykgewogICAgICAgIHJldHVybiBlYXNpbmc7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAib3V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIG91dChlYXNpbmcpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHQpIHsKICAgICAgICAgIHJldHVybiAxIC0gZWFzaW5nKDEgLSB0KTsKICAgICAgICB9OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImluT3V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGluT3V0KGVhc2luZykgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodCkgewogICAgICAgICAgaWYgKHQgPCAwLjUpIHsKICAgICAgICAgICAgcmV0dXJuIGVhc2luZyh0ICogMikgLyAyOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiAxIC0gZWFzaW5nKCgxIC0gdCkgKiAyKSAvIDI7CiAgICAgICAgfTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEVhc2luZzsKICB9KCk7CgogIG1vZHVsZS5leHBvcnRzID0gRWFzaW5nOwp9LDIxOSxbMjIwXSwiRWFzaW5nIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgTkVXVE9OX0lURVJBVElPTlMgPSA0OwogIHZhciBORVdUT05fTUlOX1NMT1BFID0gMC4wMDE7CiAgdmFyIFNVQkRJVklTSU9OX1BSRUNJU0lPTiA9IDAuMDAwMDAwMTsKICB2YXIgU1VCRElWSVNJT05fTUFYX0lURVJBVElPTlMgPSAxMDsKICB2YXIga1NwbGluZVRhYmxlU2l6ZSA9IDExOwogIHZhciBrU2FtcGxlU3RlcFNpemUgPSAxLjAgLyAoa1NwbGluZVRhYmxlU2l6ZSAtIDEuMCk7CiAgdmFyIGZsb2F0MzJBcnJheVN1cHBvcnRlZCA9IHR5cGVvZiBGbG9hdDMyQXJyYXkgPT09ICdmdW5jdGlvbic7CgogIGZ1bmN0aW9uIEEoYUExLCBhQTIpIHsKICAgIHJldHVybiAxLjAgLSAzLjAgKiBhQTIgKyAzLjAgKiBhQTE7CiAgfQoKICBmdW5jdGlvbiBCKGFBMSwgYUEyKSB7CiAgICByZXR1cm4gMy4wICogYUEyIC0gNi4wICogYUExOwogIH0KCiAgZnVuY3Rpb24gQyhhQTEpIHsKICAgIHJldHVybiAzLjAgKiBhQTE7CiAgfQoKICBmdW5jdGlvbiBjYWxjQmV6aWVyKGFULCBhQTEsIGFBMikgewogICAgcmV0dXJuICgoQShhQTEsIGFBMikgKiBhVCArIEIoYUExLCBhQTIpKSAqIGFUICsgQyhhQTEpKSAqIGFUOwogIH0KCiAgZnVuY3Rpb24gZ2V0U2xvcGUoYVQsIGFBMSwgYUEyKSB7CiAgICByZXR1cm4gMy4wICogQShhQTEsIGFBMikgKiBhVCAqIGFUICsgMi4wICogQihhQTEsIGFBMikgKiBhVCArIEMoYUExKTsKICB9CgogIGZ1bmN0aW9uIGJpbmFyeVN1YmRpdmlkZShhWCwgYUEsIGFCLCBtWDEsIG1YMikgewogICAgdmFyIGN1cnJlbnRYLAogICAgICAgIGN1cnJlbnRULAogICAgICAgIGkgPSAwOwoKICAgIGRvIHsKICAgICAgY3VycmVudFQgPSBhQSArIChhQiAtIGFBKSAvIDIuMDsKICAgICAgY3VycmVudFggPSBjYWxjQmV6aWVyKGN1cnJlbnRULCBtWDEsIG1YMikgLSBhWDsKCiAgICAgIGlmIChjdXJyZW50WCA+IDAuMCkgewogICAgICAgIGFCID0gY3VycmVudFQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYUEgPSBjdXJyZW50VDsKICAgICAgfQogICAgfSB3aGlsZSAoTWF0aC5hYnMoY3VycmVudFgpID4gU1VCRElWSVNJT05fUFJFQ0lTSU9OICYmICsraSA8IFNVQkRJVklTSU9OX01BWF9JVEVSQVRJT05TKTsKCiAgICByZXR1cm4gY3VycmVudFQ7CiAgfQoKICBmdW5jdGlvbiBuZXd0b25SYXBoc29uSXRlcmF0ZShhWCwgYUd1ZXNzVCwgbVgxLCBtWDIpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgTkVXVE9OX0lURVJBVElPTlM7ICsraSkgewogICAgICB2YXIgY3VycmVudFNsb3BlID0gZ2V0U2xvcGUoYUd1ZXNzVCwgbVgxLCBtWDIpOwoKICAgICAgaWYgKGN1cnJlbnRTbG9wZSA9PT0gMC4wKSB7CiAgICAgICAgcmV0dXJuIGFHdWVzc1Q7CiAgICAgIH0KCiAgICAgIHZhciBjdXJyZW50WCA9IGNhbGNCZXppZXIoYUd1ZXNzVCwgbVgxLCBtWDIpIC0gYVg7CiAgICAgIGFHdWVzc1QgLT0gY3VycmVudFggLyBjdXJyZW50U2xvcGU7CiAgICB9CgogICAgcmV0dXJuIGFHdWVzc1Q7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGJlemllcihtWDEsIG1ZMSwgbVgyLCBtWTIpIHsKICAgIGlmICghKDAgPD0gbVgxICYmIG1YMSA8PSAxICYmIDAgPD0gbVgyICYmIG1YMiA8PSAxKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2JlemllciB4IHZhbHVlcyBtdXN0IGJlIGluIFswLCAxXSByYW5nZScpOwogICAgfQoKICAgIHZhciBzYW1wbGVWYWx1ZXMgPSBmbG9hdDMyQXJyYXlTdXBwb3J0ZWQgPyBuZXcgRmxvYXQzMkFycmF5KGtTcGxpbmVUYWJsZVNpemUpIDogbmV3IEFycmF5KGtTcGxpbmVUYWJsZVNpemUpOwoKICAgIGlmIChtWDEgIT09IG1ZMSB8fCBtWDIgIT09IG1ZMikgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtTcGxpbmVUYWJsZVNpemU7ICsraSkgewogICAgICAgIHNhbXBsZVZhbHVlc1tpXSA9IGNhbGNCZXppZXIoaSAqIGtTYW1wbGVTdGVwU2l6ZSwgbVgxLCBtWDIpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0VEZvclgoYVgpIHsKICAgICAgdmFyIGludGVydmFsU3RhcnQgPSAwLjA7CiAgICAgIHZhciBjdXJyZW50U2FtcGxlID0gMTsKICAgICAgdmFyIGxhc3RTYW1wbGUgPSBrU3BsaW5lVGFibGVTaXplIC0gMTsKCiAgICAgIGZvciAoOyBjdXJyZW50U2FtcGxlICE9PSBsYXN0U2FtcGxlICYmIHNhbXBsZVZhbHVlc1tjdXJyZW50U2FtcGxlXSA8PSBhWDsgKytjdXJyZW50U2FtcGxlKSB7CiAgICAgICAgaW50ZXJ2YWxTdGFydCArPSBrU2FtcGxlU3RlcFNpemU7CiAgICAgIH0KCiAgICAgIC0tY3VycmVudFNhbXBsZTsKICAgICAgdmFyIGRpc3QgPSAoYVggLSBzYW1wbGVWYWx1ZXNbY3VycmVudFNhbXBsZV0pIC8gKHNhbXBsZVZhbHVlc1tjdXJyZW50U2FtcGxlICsgMV0gLSBzYW1wbGVWYWx1ZXNbY3VycmVudFNhbXBsZV0pOwogICAgICB2YXIgZ3Vlc3NGb3JUID0gaW50ZXJ2YWxTdGFydCArIGRpc3QgKiBrU2FtcGxlU3RlcFNpemU7CiAgICAgIHZhciBpbml0aWFsU2xvcGUgPSBnZXRTbG9wZShndWVzc0ZvclQsIG1YMSwgbVgyKTsKCiAgICAgIGlmIChpbml0aWFsU2xvcGUgPj0gTkVXVE9OX01JTl9TTE9QRSkgewogICAgICAgIHJldHVybiBuZXd0b25SYXBoc29uSXRlcmF0ZShhWCwgZ3Vlc3NGb3JULCBtWDEsIG1YMik7CiAgICAgIH0gZWxzZSBpZiAoaW5pdGlhbFNsb3BlID09PSAwLjApIHsKICAgICAgICByZXR1cm4gZ3Vlc3NGb3JUOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBiaW5hcnlTdWJkaXZpZGUoYVgsIGludGVydmFsU3RhcnQsIGludGVydmFsU3RhcnQgKyBrU2FtcGxlU3RlcFNpemUsIG1YMSwgbVgyKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmdW5jdGlvbiBCZXppZXJFYXNpbmcoeCkgewogICAgICBpZiAobVgxID09PSBtWTEgJiYgbVgyID09PSBtWTIpIHsKICAgICAgICByZXR1cm4geDsKICAgICAgfQoKICAgICAgaWYgKHggPT09IDApIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQoKICAgICAgaWYgKHggPT09IDEpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNhbGNCZXppZXIoZ2V0VEZvclgoeCksIG1ZMSwgbVkyKTsKICAgIH07CiAgfTsKfSwyMjAsW10sImJlemllciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0FuaW1hdGVkL3NyYy9jcmVhdGVBbmltYXRlZENvbXBvbmVudC5qcyI7CgogIHZhciBfcmVxdWlyZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICcuL0FuaW1hdGVkRXZlbnQnKSwKICAgICAgQW5pbWF0ZWRFdmVudCA9IF9yZXF1aXJlLkFuaW1hdGVkRXZlbnQ7CgogIHZhciBBbmltYXRlZFByb3BzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgJy4vbm9kZXMvQW5pbWF0ZWRQcm9wcycpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUmVhY3QiKTsKCiAgdmFyIFZpZXdTdHlsZVByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJWaWV3U3R5bGVQcm9wVHlwZXMiKTsKCiAgZnVuY3Rpb24gY3JlYXRlQW5pbWF0ZWRDb21wb25lbnQoQ29tcG9uZW50KSB7CiAgICB2YXIgX2NsYXNzLCBfdGVtcDsKCiAgICB2YXIgQW5pbWF0ZWRDb21wb25lbnQgPSAoX3RlbXAgPSBfY2xhc3MgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoQW5pbWF0ZWRDb21wb25lbnQsIF9SZWFjdCRDb21wb25lbnQpOwoKICAgICAgZnVuY3Rpb24gQW5pbWF0ZWRDb21wb25lbnQocHJvcHMpIHsKICAgICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQW5pbWF0ZWRDb21wb25lbnQpOwoKICAgICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoQW5pbWF0ZWRDb21wb25lbnQuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBbmltYXRlZENvbXBvbmVudCkpLmNhbGwodGhpcywgcHJvcHMpKTsKCiAgICAgICAgX3RoaXMuX2ludm9rZUFuaW1hdGVkUHJvcHNDYWxsYmFja09uTW91bnQgPSBmYWxzZTsKICAgICAgICBfdGhpcy5fZXZlbnREZXRhY2hlcnMgPSBbXTsKCiAgICAgICAgX3RoaXMuX2FuaW1hdGVkUHJvcHNDYWxsYmFjayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChfdGhpcy5fY29tcG9uZW50ID09IG51bGwpIHsKICAgICAgICAgICAgX3RoaXMuX2ludm9rZUFuaW1hdGVkUHJvcHNDYWxsYmFja09uTW91bnQgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChBbmltYXRlZENvbXBvbmVudC5fX3NraXBTZXROYXRpdmVQcm9wc19GT1JfVEVTVFNfT05MWSB8fCB0eXBlb2YgX3RoaXMuX2NvbXBvbmVudC5zZXROYXRpdmVQcm9wcyAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBfdGhpcy5mb3JjZVVwZGF0ZSgpOwogICAgICAgICAgfSBlbHNlIGlmICghX3RoaXMuX3Byb3BzQW5pbWF0ZWQuX19pc05hdGl2ZSkgewogICAgICAgICAgICBfdGhpcy5fY29tcG9uZW50LnNldE5hdGl2ZVByb3BzKF90aGlzLl9wcm9wc0FuaW1hdGVkLl9fZ2V0QW5pbWF0ZWRWYWx1ZSgpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGluZyB0byBydW4gSlMgZHJpdmVuIGFuaW1hdGlvbiBvbiBhbmltYXRlZCAnICsgJ25vZGUgdGhhdCBoYXMgYmVlbiBtb3ZlZCB0byAibmF0aXZlIiBlYXJsaWVyIGJ5IHN0YXJ0aW5nIGFuICcgKyAnYW5pbWF0aW9uIHdpdGggYHVzZU5hdGl2ZURyaXZlcjogdHJ1ZWAnKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBfdGhpcy5fc2V0Q29tcG9uZW50UmVmID0gX3RoaXMuX3NldENvbXBvbmVudFJlZi5iaW5kKF90aGlzKTsKICAgICAgICByZXR1cm4gX3RoaXM7CiAgICAgIH0KCiAgICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhBbmltYXRlZENvbXBvbmVudCwgW3sKICAgICAgICBrZXk6ICJjb21wb25lbnRXaWxsVW5tb3VudCIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICAgICAgdGhpcy5fcHJvcHNBbmltYXRlZCAmJiB0aGlzLl9wcm9wc0FuaW1hdGVkLl9fZGV0YWNoKCk7CgogICAgICAgICAgdGhpcy5fZGV0YWNoTmF0aXZlRXZlbnRzKCk7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAic2V0TmF0aXZlUHJvcHMiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXROYXRpdmVQcm9wcyhwcm9wcykgewogICAgICAgICAgdGhpcy5fY29tcG9uZW50LnNldE5hdGl2ZVByb3BzKHByb3BzKTsKICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBrZXk6ICJjb21wb25lbnRXaWxsTW91bnQiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnRXaWxsTW91bnQoKSB7CiAgICAgICAgICB0aGlzLl9hdHRhY2hQcm9wcyh0aGlzLnByb3BzKTsKICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBrZXk6ICJjb21wb25lbnREaWRNb3VudCIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudERpZE1vdW50KCkgewogICAgICAgICAgaWYgKHRoaXMuX2ludm9rZUFuaW1hdGVkUHJvcHNDYWxsYmFja09uTW91bnQpIHsKICAgICAgICAgICAgdGhpcy5faW52b2tlQW5pbWF0ZWRQcm9wc0NhbGxiYWNrT25Nb3VudCA9IGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5fYW5pbWF0ZWRQcm9wc0NhbGxiYWNrKCk7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5fcHJvcHNBbmltYXRlZC5zZXROYXRpdmVWaWV3KHRoaXMuX2NvbXBvbmVudCk7CgogICAgICAgICAgdGhpcy5fYXR0YWNoTmF0aXZlRXZlbnRzKCk7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAiX2F0dGFjaE5hdGl2ZUV2ZW50cyIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9hdHRhY2hOYXRpdmVFdmVudHMoKSB7CiAgICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgICAgICB2YXIgc2Nyb2xsYWJsZU5vZGUgPSB0aGlzLl9jb21wb25lbnQuZ2V0U2Nyb2xsYWJsZU5vZGUgPyB0aGlzLl9jb21wb25lbnQuZ2V0U2Nyb2xsYWJsZU5vZGUoKSA6IHRoaXMuX2NvbXBvbmVudDsKCiAgICAgICAgICB2YXIgX2xvb3AgPSBmdW5jdGlvbiBfbG9vcChrZXkpIHsKICAgICAgICAgICAgdmFyIHByb3AgPSBfdGhpczIucHJvcHNba2V5XTsKCiAgICAgICAgICAgIGlmIChwcm9wIGluc3RhbmNlb2YgQW5pbWF0ZWRFdmVudCAmJiBwcm9wLl9faXNOYXRpdmUpIHsKICAgICAgICAgICAgICBwcm9wLl9fYXR0YWNoKHNjcm9sbGFibGVOb2RlLCBrZXkpOwoKICAgICAgICAgICAgICBfdGhpczIuX2V2ZW50RGV0YWNoZXJzLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByb3AuX19kZXRhY2goc2Nyb2xsYWJsZU5vZGUsIGtleSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMucHJvcHMpIHsKICAgICAgICAgICAgX2xvb3Aoa2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBrZXk6ICJfZGV0YWNoTmF0aXZlRXZlbnRzIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gX2RldGFjaE5hdGl2ZUV2ZW50cygpIHsKICAgICAgICAgIHRoaXMuX2V2ZW50RGV0YWNoZXJzLmZvckVhY2goZnVuY3Rpb24gKHJlbW92ZSkgewogICAgICAgICAgICByZXR1cm4gcmVtb3ZlKCk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB0aGlzLl9ldmVudERldGFjaGVycyA9IFtdOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogIl9hdHRhY2hQcm9wcyIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9hdHRhY2hQcm9wcyhuZXh0UHJvcHMpIHsKICAgICAgICAgIHZhciBvbGRQcm9wc0FuaW1hdGVkID0gdGhpcy5fcHJvcHNBbmltYXRlZDsKICAgICAgICAgIHRoaXMuX3Byb3BzQW5pbWF0ZWQgPSBuZXcgQW5pbWF0ZWRQcm9wcyhuZXh0UHJvcHMsIHRoaXMuX2FuaW1hdGVkUHJvcHNDYWxsYmFjayk7CiAgICAgICAgICBvbGRQcm9wc0FuaW1hdGVkICYmIG9sZFByb3BzQW5pbWF0ZWQuX19kZXRhY2goKTsKICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBrZXk6ICJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXdQcm9wcykgewogICAgICAgICAgdGhpcy5fYXR0YWNoUHJvcHMobmV3UHJvcHMpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogImNvbXBvbmVudERpZFVwZGF0ZSIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMpIHsKICAgICAgICAgIGlmICh0aGlzLl9jb21wb25lbnQgIT09IHRoaXMuX3ByZXZDb21wb25lbnQpIHsKICAgICAgICAgICAgdGhpcy5fcHJvcHNBbmltYXRlZC5zZXROYXRpdmVWaWV3KHRoaXMuX2NvbXBvbmVudCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHRoaXMuX2NvbXBvbmVudCAhPT0gdGhpcy5fcHJldkNvbXBvbmVudCB8fCBwcmV2UHJvcHMgIT09IHRoaXMucHJvcHMpIHsKICAgICAgICAgICAgdGhpcy5fZGV0YWNoTmF0aXZlRXZlbnRzKCk7CgogICAgICAgICAgICB0aGlzLl9hdHRhY2hOYXRpdmVFdmVudHMoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBrZXk6ICJyZW5kZXIiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgICB2YXIgcHJvcHMgPSB0aGlzLl9wcm9wc0FuaW1hdGVkLl9fZ2V0VmFsdWUoKTsKCiAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChDb21wb25lbnQsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBwcm9wcywgewogICAgICAgICAgICByZWY6IHRoaXMuX3NldENvbXBvbmVudFJlZiwKICAgICAgICAgICAgY29sbGFwc2FibGU6IHRoaXMuX3Byb3BzQW5pbWF0ZWQuX19pc05hdGl2ZSA/IGZhbHNlIDogcHJvcHMuY29sbGFwc2FibGUsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAxNDcKICAgICAgICAgICAgfQogICAgICAgICAgfSkpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogIl9zZXRDb21wb25lbnRSZWYiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBfc2V0Q29tcG9uZW50UmVmKGMpIHsKICAgICAgICAgIHRoaXMuX3ByZXZDb21wb25lbnQgPSB0aGlzLl9jb21wb25lbnQ7CiAgICAgICAgICB0aGlzLl9jb21wb25lbnQgPSBjOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogImdldE5vZGUiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXROb2RlKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbXBvbmVudDsKICAgICAgICB9CiAgICAgIH1dKTsKICAgICAgcmV0dXJuIEFuaW1hdGVkQ29tcG9uZW50OwogICAgfShSZWFjdC5Db21wb25lbnQpLCBfY2xhc3MuX19za2lwU2V0TmF0aXZlUHJvcHNfRk9SX1RFU1RTX09OTFkgPSBmYWxzZSwgX3RlbXApOwogICAgdmFyIHByb3BUeXBlcyA9IENvbXBvbmVudC5wcm9wVHlwZXM7CiAgICBBbmltYXRlZENvbXBvbmVudC5wcm9wVHlwZXMgPSB7CiAgICAgIHN0eWxlOiBmdW5jdGlvbiBzdHlsZShwcm9wcywgcHJvcE5hbWUsIGNvbXBvbmVudE5hbWUpIHsKICAgICAgICBpZiAoIXByb3BUeXBlcykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIga2V5IGluIFZpZXdTdHlsZVByb3BUeXBlcykgewogICAgICAgICAgaWYgKCFwcm9wVHlwZXNba2V5XSAmJiBwcm9wc1trZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdZb3UgYXJlIHNldHRpbmcgdGhlIHN0eWxlIGB7ICcgKyBrZXkgKyAnOiAuLi4gfWAgYXMgYSBwcm9wLiBZb3UgJyArICdzaG91bGQgbmVzdCBpdCBpbiBhIHN0eWxlIG9iamVjdC4gJyArICdFLmcuIGB7IHN0eWxlOiB7ICcgKyBrZXkgKyAnOiAuLi4gfSB9YCcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHJldHVybiBBbmltYXRlZENvbXBvbmVudDsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gY3JlYXRlQW5pbWF0ZWRDb21wb25lbnQ7Cn0sMjIxLFsxOTYsMjA5LDEzMCwxMzldLCJjcmVhdGVBbmltYXRlZENvbXBvbmVudCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0ltYWdlL0ltYWdlLmFuZHJvaWQuanMiOwoKICB2YXIgSW1hZ2VSZXNpemVNb2RlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkltYWdlUmVzaXplTW9kZSIpOwoKICB2YXIgSW1hZ2VTdHlsZVByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJJbWFnZVN0eWxlUHJvcFR5cGVzIik7CgogIHZhciBOYXRpdmVNZXRob2RzTWl4aW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiTmF0aXZlTWV0aG9kc01peGluIik7CgogIHZhciBOYXRpdmVNb2R1bGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIk5hdGl2ZU1vZHVsZXMiKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlJlYWN0Iik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgUmVhY3ROYXRpdmVWaWV3QXR0cmlidXRlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzIik7CgogIHZhciBTZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiU2V0Iik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4XSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFN0eWxlU2hlZXRQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOV0sICJTdHlsZVNoZWV0UHJvcFR5cGUiKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEwXSwgIlZpZXciKTsKCiAgdmFyIFZpZXdQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzExXSwgIlZpZXdQcm9wVHlwZXMiKTsKCiAgdmFyIFZpZXdTdHlsZVByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTJdLCAiVmlld1N0eWxlUHJvcFR5cGVzIik7CgogIHZhciBjcmVhdGVSZWFjdENsYXNzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxM10sICJjcmVhdGUtcmVhY3QtY2xhc3MiKTsKCiAgdmFyIGZpbHRlck9iamVjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTRdLCAiZmJqcy9saWIvZmlsdGVyT2JqZWN0Iik7CgogIHZhciBmbGF0dGVuU3R5bGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE1XSwgImZsYXR0ZW5TdHlsZSIpOwoKICB2YXIgbWVyZ2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE2XSwgIm1lcmdlIik7CgogIHZhciByZXF1aXJlTmF0aXZlQ29tcG9uZW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxN10sICJyZXF1aXJlTmF0aXZlQ29tcG9uZW50Iik7CgogIHZhciByZXNvbHZlQXNzZXRTb3VyY2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE4XSwgInJlc29sdmVBc3NldFNvdXJjZSIpOwoKICB2YXIgSW1hZ2VMb2FkZXIgPSBOYXRpdmVNb2R1bGVzLkltYWdlTG9hZGVyOwogIHZhciBfcmVxdWVzdElkID0gMTsKCiAgZnVuY3Rpb24gZ2VuZXJhdGVSZXF1ZXN0SWQoKSB7CiAgICByZXR1cm4gX3JlcXVlc3RJZCsrOwogIH0KCiAgdmFyIEltYWdlVmlld0F0dHJpYnV0ZXMgPSBtZXJnZShSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzLlVJVmlldywgewogICAgc3JjOiB0cnVlLAogICAgbG9hZGluZ0luZGljYXRvclNyYzogdHJ1ZSwKICAgIHJlc2l6ZU1ldGhvZDogdHJ1ZSwKICAgIHJlc2l6ZU1vZGU6IHRydWUsCiAgICBwcm9ncmVzc2l2ZVJlbmRlcmluZ0VuYWJsZWQ6IHRydWUsCiAgICBmYWRlRHVyYXRpb246IHRydWUsCiAgICBzaG91bGROb3RpZnlMb2FkRXZlbnRzOiB0cnVlCiAgfSk7CiAgdmFyIFZpZXdTdHlsZUtleXMgPSBuZXcgU2V0KE9iamVjdC5rZXlzKFZpZXdTdHlsZVByb3BUeXBlcykpOwogIHZhciBJbWFnZVNwZWNpZmljU3R5bGVLZXlzID0gbmV3IFNldChPYmplY3Qua2V5cyhJbWFnZVN0eWxlUHJvcFR5cGVzKS5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgIHJldHVybiAhVmlld1N0eWxlS2V5cy5oYXMoeCk7CiAgfSkpOwogIHZhciBJbWFnZSA9IGNyZWF0ZVJlYWN0Q2xhc3MoewogICAgZGlzcGxheU5hbWU6ICdJbWFnZScsCiAgICBwcm9wVHlwZXM6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBWaWV3UHJvcFR5cGVzLCB7CiAgICAgIHN0eWxlOiBTdHlsZVNoZWV0UHJvcFR5cGUoSW1hZ2VTdHlsZVByb3BUeXBlcyksCiAgICAgIHNvdXJjZTogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLnNoYXBlKHsKICAgICAgICB1cmk6IFByb3BUeXBlcy5zdHJpbmcsCiAgICAgICAgaGVhZGVyczogUHJvcFR5cGVzLm9iamVjdE9mKFByb3BUeXBlcy5zdHJpbmcpCiAgICAgIH0pLCBQcm9wVHlwZXMubnVtYmVyLCBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMuc2hhcGUoewogICAgICAgIHVyaTogUHJvcFR5cGVzLnN0cmluZywKICAgICAgICB3aWR0aDogUHJvcFR5cGVzLm51bWJlciwKICAgICAgICBoZWlnaHQ6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgICAgaGVhZGVyczogUHJvcFR5cGVzLm9iamVjdE9mKFByb3BUeXBlcy5zdHJpbmcpCiAgICAgIH0pKV0pLAogICAgICBibHVyUmFkaXVzOiBQcm9wVHlwZXMubnVtYmVyLAogICAgICBsb2FkaW5nSW5kaWNhdG9yU291cmNlOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuc2hhcGUoewogICAgICAgIHVyaTogUHJvcFR5cGVzLnN0cmluZwogICAgICB9KSwgUHJvcFR5cGVzLm51bWJlcl0pLAogICAgICBwcm9ncmVzc2l2ZVJlbmRlcmluZ0VuYWJsZWQ6IFByb3BUeXBlcy5ib29sLAogICAgICBmYWRlRHVyYXRpb246IFByb3BUeXBlcy5udW1iZXIsCiAgICAgIG9uTG9hZFN0YXJ0OiBQcm9wVHlwZXMuZnVuYywKICAgICAgb25FcnJvcjogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uTG9hZDogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uTG9hZEVuZDogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIHRlc3RJRDogUHJvcFR5cGVzLnN0cmluZywKICAgICAgcmVzaXplTWV0aG9kOiBQcm9wVHlwZXMub25lT2YoWydhdXRvJywgJ3Jlc2l6ZScsICdzY2FsZSddKSwKICAgICAgcmVzaXplTW9kZTogUHJvcFR5cGVzLm9uZU9mKFsnY292ZXInLCAnY29udGFpbicsICdzdHJldGNoJywgJ2NlbnRlciddKQogICAgfSksCiAgICBzdGF0aWNzOiB7CiAgICAgIHJlc2l6ZU1vZGU6IEltYWdlUmVzaXplTW9kZSwKICAgICAgZ2V0U2l6ZTogZnVuY3Rpb24gZ2V0U2l6ZSh1cmwsIHN1Y2Nlc3MsIGZhaWx1cmUpIHsKICAgICAgICByZXR1cm4gSW1hZ2VMb2FkZXIuZ2V0U2l6ZSh1cmwpLnRoZW4oZnVuY3Rpb24gKHNpemVzKSB7CiAgICAgICAgICBzdWNjZXNzKHNpemVzLndpZHRoLCBzaXplcy5oZWlnaHQpOwogICAgICAgIH0pLmNhdGNoKGZhaWx1cmUgfHwgZnVuY3Rpb24gKCkgewogICAgICAgICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gZ2V0IHNpemUgZm9yIGltYWdlOiAnICsgdXJsKTsKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgcHJlZmV0Y2g6IGZ1bmN0aW9uIHByZWZldGNoKHVybCwgY2FsbGJhY2spIHsKICAgICAgICB2YXIgcmVxdWVzdElkID0gZ2VuZXJhdGVSZXF1ZXN0SWQoKTsKICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayhyZXF1ZXN0SWQpOwogICAgICAgIHJldHVybiBJbWFnZUxvYWRlci5wcmVmZXRjaEltYWdlKHVybCwgcmVxdWVzdElkKTsKICAgICAgfSwKICAgICAgYWJvcnRQcmVmZXRjaDogZnVuY3Rpb24gYWJvcnRQcmVmZXRjaChyZXF1ZXN0SWQpIHsKICAgICAgICBJbWFnZUxvYWRlci5hYm9ydFJlcXVlc3QocmVxdWVzdElkKTsKICAgICAgfSwKICAgICAgcXVlcnlDYWNoZTogZnVuY3Rpb24gcXVlcnlDYWNoZSh1cmxzKSB7CiAgICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS5hc3luYyhmdW5jdGlvbiBxdWVyeUNhY2hlJChfY29udGV4dCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dC5wcmV2ID0gX2NvbnRleHQubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSAyOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS5hd3JhcChJbWFnZUxvYWRlci5xdWVyeUNhY2hlKHVybHMpKTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LmFicnVwdCgicmV0dXJuIiwgX2NvbnRleHQuc2VudCk7CgogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIG51bGwsIHRoaXMpOwogICAgICB9LAogICAgICByZXNvbHZlQXNzZXRTb3VyY2U6IHJlc29sdmVBc3NldFNvdXJjZQogICAgfSwKICAgIG1peGluczogW05hdGl2ZU1ldGhvZHNNaXhpbl0sCiAgICB2aWV3Q29uZmlnOiB7CiAgICAgIHVpVmlld0NsYXNzTmFtZTogJ1JDVFZpZXcnLAogICAgICB2YWxpZEF0dHJpYnV0ZXM6IFJlYWN0TmF0aXZlVmlld0F0dHJpYnV0ZXMuUkNUVmlldwogICAgfSwKICAgIGNvbnRleHRUeXBlczogewogICAgICBpc0luQVBhcmVudFRleHQ6IFByb3BUeXBlcy5ib29sCiAgICB9LAogICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgIHZhciBzb3VyY2UgPSByZXNvbHZlQXNzZXRTb3VyY2UodGhpcy5wcm9wcy5zb3VyY2UpOwogICAgICB2YXIgbG9hZGluZ0luZGljYXRvclNvdXJjZSA9IHJlc29sdmVBc3NldFNvdXJjZSh0aGlzLnByb3BzLmxvYWRpbmdJbmRpY2F0b3JTb3VyY2UpOwoKICAgICAgaWYgKHNvdXJjZSAmJiBzb3VyY2UudXJpID09PSAnJykgewogICAgICAgIGNvbnNvbGUud2Fybignc291cmNlLnVyaSBzaG91bGQgbm90IGJlIGFuIGVtcHR5IHN0cmluZycpOwogICAgICB9CgogICAgICBpZiAodGhpcy5wcm9wcy5zcmMpIHsKICAgICAgICBjb25zb2xlLndhcm4oJ1RoZSA8SW1hZ2U+IGNvbXBvbmVudCByZXF1aXJlcyBhIGBzb3VyY2VgIHByb3BlcnR5IHJhdGhlciB0aGFuIGBzcmNgLicpOwogICAgICB9CgogICAgICBpZiAodGhpcy5wcm9wcy5jaGlsZHJlbikgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIDxJbWFnZT4gY29tcG9uZW50IGNhbm5vdCBjb250YWluIGNoaWxkcmVuLiBJZiB5b3Ugd2FudCB0byByZW5kZXIgY29udGVudCBvbiB0b3Agb2YgdGhlIGltYWdlLCBjb25zaWRlciB1c2luZyB0aGUgPEltYWdlQmFja2dyb3VuZD4gY29tcG9uZW50IG9yIGFic29sdXRlIHBvc2l0aW9uaW5nLicpOwogICAgICB9CgogICAgICBpZiAoc291cmNlICYmIChzb3VyY2UudXJpIHx8IEFycmF5LmlzQXJyYXkoc291cmNlKSkpIHsKICAgICAgICB2YXIgc3R5bGUgPSB2b2lkIDA7CiAgICAgICAgdmFyIHNvdXJjZXMgPSB2b2lkIDA7CgogICAgICAgIGlmIChzb3VyY2UudXJpKSB7CiAgICAgICAgICB2YXIgX3dpZHRoID0gc291cmNlLndpZHRoLAogICAgICAgICAgICAgIF9oZWlnaHQgPSBzb3VyY2UuaGVpZ2h0OwogICAgICAgICAgc3R5bGUgPSBmbGF0dGVuU3R5bGUoW3sKICAgICAgICAgICAgd2lkdGg6IF93aWR0aCwKICAgICAgICAgICAgaGVpZ2h0OiBfaGVpZ2h0CiAgICAgICAgICB9LCBzdHlsZXMuYmFzZSwgdGhpcy5wcm9wcy5zdHlsZV0pOwogICAgICAgICAgc291cmNlcyA9IFt7CiAgICAgICAgICAgIHVyaTogc291cmNlLnVyaQogICAgICAgICAgfV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0eWxlID0gZmxhdHRlblN0eWxlKFtzdHlsZXMuYmFzZSwgdGhpcy5wcm9wcy5zdHlsZV0pOwogICAgICAgICAgc291cmNlcyA9IHNvdXJjZTsKICAgICAgICB9CgogICAgICAgIHZhciBfcHJvcHMgPSB0aGlzLnByb3BzLAogICAgICAgICAgICBvbkxvYWRTdGFydCA9IF9wcm9wcy5vbkxvYWRTdGFydCwKICAgICAgICAgICAgb25Mb2FkID0gX3Byb3BzLm9uTG9hZCwKICAgICAgICAgICAgb25Mb2FkRW5kID0gX3Byb3BzLm9uTG9hZEVuZCwKICAgICAgICAgICAgb25FcnJvciA9IF9wcm9wcy5vbkVycm9yOwogICAgICAgIHZhciBuYXRpdmVQcm9wcyA9IG1lcmdlKHRoaXMucHJvcHMsIHsKICAgICAgICAgIHN0eWxlOiBzdHlsZSwKICAgICAgICAgIHNob3VsZE5vdGlmeUxvYWRFdmVudHM6ICEhKG9uTG9hZFN0YXJ0IHx8IG9uTG9hZCB8fCBvbkxvYWRFbmQgfHwgb25FcnJvciksCiAgICAgICAgICBzcmM6IHNvdXJjZXMsCiAgICAgICAgICBoZWFkZXJzOiBzb3VyY2UuaGVhZGVycywKICAgICAgICAgIGxvYWRpbmdJbmRpY2F0b3JTcmM6IGxvYWRpbmdJbmRpY2F0b3JTb3VyY2UgPyBsb2FkaW5nSW5kaWNhdG9yU291cmNlLnVyaSA6IG51bGwKICAgICAgICB9KTsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dC5pc0luQVBhcmVudFRleHQpIHsKICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFJDVFRleHRJbmxpbmVJbWFnZSwgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIG5hdGl2ZVByb3BzLCB7CiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAzMDIKICAgICAgICAgICAgfQogICAgICAgICAgfSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChSS0ltYWdlLCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgbmF0aXZlUHJvcHMsIHsKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDMwNAogICAgICAgICAgICB9CiAgICAgICAgICB9KSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9KTsKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgYmFzZTogewogICAgICBvdmVyZmxvdzogJ2hpZGRlbicKICAgIH0KICB9KTsKICB2YXIgY2ZnID0gewogICAgbmF0aXZlT25seTogewogICAgICBzcmM6IHRydWUsCiAgICAgIGhlYWRlcnM6IHRydWUsCiAgICAgIGxvYWRpbmdJbmRpY2F0b3JTcmM6IHRydWUsCiAgICAgIHNob3VsZE5vdGlmeUxvYWRFdmVudHM6IHRydWUKICAgIH0KICB9OwogIHZhciBSS0ltYWdlID0gcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCgnUkNUSW1hZ2VWaWV3JywgSW1hZ2UsIGNmZyk7CiAgdmFyIFJDVFRleHRJbmxpbmVJbWFnZSA9IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoJ1JDVFRleHRJbmxpbmVJbWFnZScsIEltYWdlLCBjZmcpOwogIG1vZHVsZS5leHBvcnRzID0gSW1hZ2U7Cn0sMjIyLFsxNDksMTQ4LDEyNSwxNSwxMzAsMTI3LDE3MSwzMCwxNjgsMTM4LDE3MCwxMzEsMTM5LDE3MiwyMjMsMTAxLDEzNCwxNDUsMTYwXSwiSW1hZ2UiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgogIGZ1bmN0aW9uIGZpbHRlck9iamVjdChvYmplY3QsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICBpZiAoIW9iamVjdCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICB2YXIgcmVzdWx0ID0ge307CgogICAgZm9yICh2YXIgbmFtZSBpbiBvYmplY3QpIHsKICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBuYW1lKSAmJiBjYWxsYmFjay5jYWxsKGNvbnRleHQsIG9iamVjdFtuYW1lXSwgbmFtZSwgb2JqZWN0KSkgewogICAgICAgIHJlc3VsdFtuYW1lXSA9IG9iamVjdFtuYW1lXTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGZpbHRlck9iamVjdDsKfSwyMjMsW10sImZianMvbGliL2ZpbHRlck9iamVjdC5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvbXBvbmVudHMvU2Nyb2xsVmlldy9TY3JvbGxWaWV3LmpzIjsKCiAgdmFyIEFuaW1hdGVkID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkFuaW1hdGVkIik7CgogIHZhciBDb2xvclByb3BUeXBlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkNvbG9yUHJvcFR5cGUiKTsKCiAgdmFyIEVkZ2VJbnNldHNQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJFZGdlSW5zZXRzUHJvcFR5cGUiKTsKCiAgdmFyIFBsYXRmb3JtID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlBsYXRmb3JtIik7CgogIHZhciBQb2ludFByb3BUeXBlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlBvaW50UHJvcFR5cGUiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJwcm9wLXR5cGVzIik7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJSZWFjdCIpOwoKICB2YXIgUmVhY3ROYXRpdmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiUmVhY3ROYXRpdmUiKTsKCiAgdmFyIFNjcm9sbFJlc3BvbmRlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJTY3JvbGxSZXNwb25kZXIiKTsKCiAgdmFyIFNjcm9sbFZpZXdTdGlja3lIZWFkZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAiU2Nyb2xsVmlld1N0aWNreUhlYWRlciIpOwoKICB2YXIgU3R5bGVTaGVldCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTBdLCAiU3R5bGVTaGVldCIpOwoKICB2YXIgU3R5bGVTaGVldFByb3BUeXBlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMV0sICJTdHlsZVNoZWV0UHJvcFR5cGUiKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEyXSwgIlZpZXciKTsKCiAgdmFyIFZpZXdQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEzXSwgIlZpZXdQcm9wVHlwZXMiKTsKCiAgdmFyIFZpZXdTdHlsZVByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTRdLCAiVmlld1N0eWxlUHJvcFR5cGVzIik7CgogIHZhciBjcmVhdGVSZWFjdENsYXNzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxNV0sICJjcmVhdGUtcmVhY3QtY2xhc3MiKTsKCiAgdmFyIGRpc21pc3NLZXlib2FyZCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTZdLCAiZGlzbWlzc0tleWJvYXJkIik7CgogIHZhciBmbGF0dGVuU3R5bGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE3XSwgImZsYXR0ZW5TdHlsZSIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxOF0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIHByb2Nlc3NEZWNlbGVyYXRpb25SYXRlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxOV0sICJwcm9jZXNzRGVjZWxlcmF0aW9uUmF0ZSIpOwoKICB2YXIgcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMjBdLCAicmVxdWlyZU5hdGl2ZUNvbXBvbmVudCIpOwoKICB2YXIgd2FybmluZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMjFdLCAiZmJqcy9saWIvd2FybmluZyIpOwoKICB2YXIgU2Nyb2xsVmlldyA9IGNyZWF0ZVJlYWN0Q2xhc3MoewogICAgZGlzcGxheU5hbWU6ICdTY3JvbGxWaWV3JywKICAgIHByb3BUeXBlczogYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIFZpZXdQcm9wVHlwZXMsIHsKICAgICAgYXV0b21hdGljYWxseUFkanVzdENvbnRlbnRJbnNldHM6IFByb3BUeXBlcy5ib29sLAogICAgICBjb250ZW50SW5zZXQ6IEVkZ2VJbnNldHNQcm9wVHlwZSwKICAgICAgY29udGVudE9mZnNldDogUG9pbnRQcm9wVHlwZSwKICAgICAgYm91bmNlczogUHJvcFR5cGVzLmJvb2wsCiAgICAgIGJvdW5jZXNab29tOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgYWx3YXlzQm91bmNlSG9yaXpvbnRhbDogUHJvcFR5cGVzLmJvb2wsCiAgICAgIGFsd2F5c0JvdW5jZVZlcnRpY2FsOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgY2VudGVyQ29udGVudDogUHJvcFR5cGVzLmJvb2wsCiAgICAgIGNvbnRlbnRDb250YWluZXJTdHlsZTogU3R5bGVTaGVldFByb3BUeXBlKFZpZXdTdHlsZVByb3BUeXBlcyksCiAgICAgIGRlY2VsZXJhdGlvblJhdGU6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5vbmVPZihbJ2Zhc3QnLCAnbm9ybWFsJ10pLCBQcm9wVHlwZXMubnVtYmVyXSksCiAgICAgIGhvcml6b250YWw6IFByb3BUeXBlcy5ib29sLAogICAgICBpbmRpY2F0b3JTdHlsZTogUHJvcFR5cGVzLm9uZU9mKFsnZGVmYXVsdCcsICdibGFjaycsICd3aGl0ZSddKSwKICAgICAgZGlyZWN0aW9uYWxMb2NrRW5hYmxlZDogUHJvcFR5cGVzLmJvb2wsCiAgICAgIGNhbkNhbmNlbENvbnRlbnRUb3VjaGVzOiBQcm9wVHlwZXMuYm9vbCwKICAgICAga2V5Ym9hcmREaXNtaXNzTW9kZTogUHJvcFR5cGVzLm9uZU9mKFsnbm9uZScsICdvbi1kcmFnJywgJ2ludGVyYWN0aXZlJ10pLAogICAgICBrZXlib2FyZFNob3VsZFBlcnNpc3RUYXBzOiBQcm9wVHlwZXMub25lT2YoWydhbHdheXMnLCAnbmV2ZXInLCAnaGFuZGxlZCcsIGZhbHNlLCB0cnVlXSksCiAgICAgIG1heGltdW1ab29tU2NhbGU6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgIG1pbmltdW1ab29tU2NhbGU6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgIG9uTW9tZW50dW1TY3JvbGxCZWdpbjogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uTW9tZW50dW1TY3JvbGxFbmQ6IFByb3BUeXBlcy5mdW5jLAogICAgICBvblNjcm9sbDogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uQ29udGVudFNpemVDaGFuZ2U6IFByb3BUeXBlcy5mdW5jLAogICAgICBwYWdpbmdFbmFibGVkOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgcGluY2hHZXN0dXJlRW5hYmxlZDogUHJvcFR5cGVzLmJvb2wsCiAgICAgIHNjcm9sbEVuYWJsZWQ6IFByb3BUeXBlcy5ib29sLAogICAgICBzY3JvbGxFdmVudFRocm90dGxlOiBQcm9wVHlwZXMubnVtYmVyLAogICAgICBzY3JvbGxJbmRpY2F0b3JJbnNldHM6IEVkZ2VJbnNldHNQcm9wVHlwZSwKICAgICAgc2Nyb2xsc1RvVG9wOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgc2hvd3NIb3Jpem9udGFsU2Nyb2xsSW5kaWNhdG9yOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgc2hvd3NWZXJ0aWNhbFNjcm9sbEluZGljYXRvcjogUHJvcFR5cGVzLmJvb2wsCiAgICAgIHN0aWNreUhlYWRlckluZGljZXM6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5udW1iZXIpLAogICAgICBzbmFwVG9JbnRlcnZhbDogUHJvcFR5cGVzLm51bWJlciwKICAgICAgc25hcFRvQWxpZ25tZW50OiBQcm9wVHlwZXMub25lT2YoWydzdGFydCcsICdjZW50ZXInLCAnZW5kJ10pLAogICAgICByZW1vdmVDbGlwcGVkU3Vidmlld3M6IFByb3BUeXBlcy5ib29sLAogICAgICB6b29tU2NhbGU6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgIGNvbnRlbnRJbnNldEFkanVzdG1lbnRCZWhhdmlvcjogUHJvcFR5cGVzLm9uZU9mKFsnYXV0b21hdGljJywgJ3Njcm9sbGFibGVBeGVzJywgJ25ldmVyJywgJ2Fsd2F5cyddKSwKICAgICAgcmVmcmVzaENvbnRyb2w6IFByb3BUeXBlcy5lbGVtZW50LAogICAgICBlbmRGaWxsQ29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICAgIHNjcm9sbFBlcmZUYWc6IFByb3BUeXBlcy5zdHJpbmcsCiAgICAgIG92ZXJTY3JvbGxNb2RlOiBQcm9wVHlwZXMub25lT2YoWydhdXRvJywgJ2Fsd2F5cycsICduZXZlciddKSwKICAgICAgREVQUkVDQVRFRF9zZW5kVXBkYXRlZENoaWxkRnJhbWVzOiBQcm9wVHlwZXMuYm9vbAogICAgfSksCiAgICBtaXhpbnM6IFtTY3JvbGxSZXNwb25kZXIuTWl4aW5dLAogICAgX3Njcm9sbEFuaW1hdGVkVmFsdWU6IG5ldyBBbmltYXRlZC5WYWx1ZSgwKSwKICAgIF9zY3JvbGxBbmltYXRlZFZhbHVlQXR0YWNobWVudDogbnVsbCwKICAgIF9zdGlja3lIZWFkZXJSZWZzOiBuZXcgTWFwKCksCiAgICBfaGVhZGVyTGF5b3V0WXM6IG5ldyBNYXAoKSwKICAgIGdldEluaXRpYWxTdGF0ZTogZnVuY3Rpb24gZ2V0SW5pdGlhbFN0YXRlKCkgewogICAgICByZXR1cm4gdGhpcy5zY3JvbGxSZXNwb25kZXJNaXhpbkdldEluaXRpYWxTdGF0ZSgpOwogICAgfSwKICAgIGNvbXBvbmVudFdpbGxNb3VudDogZnVuY3Rpb24gY29tcG9uZW50V2lsbE1vdW50KCkgewogICAgICB0aGlzLl9zY3JvbGxBbmltYXRlZFZhbHVlID0gbmV3IEFuaW1hdGVkLlZhbHVlKHRoaXMucHJvcHMuY29udGVudE9mZnNldCA/IHRoaXMucHJvcHMuY29udGVudE9mZnNldC55IDogMCk7CgogICAgICB0aGlzLl9zY3JvbGxBbmltYXRlZFZhbHVlLnNldE9mZnNldCh0aGlzLnByb3BzLmNvbnRlbnRJbnNldCA/IHRoaXMucHJvcHMuY29udGVudEluc2V0LnRvcCA6IDApOwoKICAgICAgdGhpcy5fc3RpY2t5SGVhZGVyUmVmcyA9IG5ldyBNYXAoKTsKICAgICAgdGhpcy5faGVhZGVyTGF5b3V0WXMgPSBuZXcgTWFwKCk7CiAgICB9LAogICAgY29tcG9uZW50RGlkTW91bnQ6IGZ1bmN0aW9uIGNvbXBvbmVudERpZE1vdW50KCkgewogICAgICB0aGlzLl91cGRhdGVBbmltYXRlZE5vZGVBdHRhY2htZW50KCk7CiAgICB9LAogICAgY29tcG9uZW50RGlkVXBkYXRlOiBmdW5jdGlvbiBjb21wb25lbnREaWRVcGRhdGUoKSB7CiAgICAgIHRoaXMuX3VwZGF0ZUFuaW1hdGVkTm9kZUF0dGFjaG1lbnQoKTsKICAgIH0sCiAgICBjb21wb25lbnRXaWxsVW5tb3VudDogZnVuY3Rpb24gY29tcG9uZW50V2lsbFVubW91bnQoKSB7CiAgICAgIGlmICh0aGlzLl9zY3JvbGxBbmltYXRlZFZhbHVlQXR0YWNobWVudCkgewogICAgICAgIHRoaXMuX3Njcm9sbEFuaW1hdGVkVmFsdWVBdHRhY2htZW50LmRldGFjaCgpOwogICAgICB9CiAgICB9LAogICAgc2V0TmF0aXZlUHJvcHM6IGZ1bmN0aW9uIHNldE5hdGl2ZVByb3BzKHByb3BzKSB7CiAgICAgIHRoaXMuX3Njcm9sbFZpZXdSZWYgJiYgdGhpcy5fc2Nyb2xsVmlld1JlZi5zZXROYXRpdmVQcm9wcyhwcm9wcyk7CiAgICB9LAogICAgZ2V0U2Nyb2xsUmVzcG9uZGVyOiBmdW5jdGlvbiBnZXRTY3JvbGxSZXNwb25kZXIoKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGdldFNjcm9sbGFibGVOb2RlOiBmdW5jdGlvbiBnZXRTY3JvbGxhYmxlTm9kZSgpIHsKICAgICAgcmV0dXJuIFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKHRoaXMuX3Njcm9sbFZpZXdSZWYpOwogICAgfSwKICAgIGdldElubmVyVmlld05vZGU6IGZ1bmN0aW9uIGdldElubmVyVmlld05vZGUoKSB7CiAgICAgIHJldHVybiBSZWFjdE5hdGl2ZS5maW5kTm9kZUhhbmRsZSh0aGlzLl9pbm5lclZpZXdSZWYpOwogICAgfSwKICAgIHNjcm9sbFRvOiBmdW5jdGlvbiBzY3JvbGxUbyh5LCB4LCBhbmltYXRlZCkgewogICAgICBpZiAodHlwZW9mIHkgPT09ICdudW1iZXInKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdgc2Nyb2xsVG8oeSwgeCwgYW5pbWF0ZWQpYCBpcyBkZXByZWNhdGVkLiBVc2UgYHNjcm9sbFRvKHt4OiA1LCB5OiA1LCAnICsgJ2FuaW1hdGVkOiB0cnVlfSlgIGluc3RlYWQuJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIF9yZWYgPSB5IHx8IHt9OwoKICAgICAgICB4ID0gX3JlZi54OwogICAgICAgIHkgPSBfcmVmLnk7CiAgICAgICAgYW5pbWF0ZWQgPSBfcmVmLmFuaW1hdGVkOwogICAgICB9CgogICAgICB0aGlzLmdldFNjcm9sbFJlc3BvbmRlcigpLnNjcm9sbFJlc3BvbmRlclNjcm9sbFRvKHsKICAgICAgICB4OiB4IHx8IDAsCiAgICAgICAgeTogeSB8fCAwLAogICAgICAgIGFuaW1hdGVkOiBhbmltYXRlZCAhPT0gZmFsc2UKICAgICAgfSk7CiAgICB9LAogICAgc2Nyb2xsVG9FbmQ6IGZ1bmN0aW9uIHNjcm9sbFRvRW5kKG9wdGlvbnMpIHsKICAgICAgdmFyIGFuaW1hdGVkID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5hbmltYXRlZCkgIT09IGZhbHNlOwogICAgICB0aGlzLmdldFNjcm9sbFJlc3BvbmRlcigpLnNjcm9sbFJlc3BvbmRlclNjcm9sbFRvRW5kKHsKICAgICAgICBhbmltYXRlZDogYW5pbWF0ZWQKICAgICAgfSk7CiAgICB9LAogICAgc2Nyb2xsV2l0aG91dEFuaW1hdGlvblRvOiBmdW5jdGlvbiBzY3JvbGxXaXRob3V0QW5pbWF0aW9uVG8oKSB7CiAgICAgIHZhciB5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiAwOwogICAgICB2YXIgeCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogMDsKICAgICAgY29uc29sZS53YXJuKCdgc2Nyb2xsV2l0aG91dEFuaW1hdGlvblRvYCBpcyBkZXByZWNhdGVkLiBVc2UgYHNjcm9sbFRvYCBpbnN0ZWFkJyk7CiAgICAgIHRoaXMuc2Nyb2xsVG8oewogICAgICAgIHg6IHgsCiAgICAgICAgeTogeSwKICAgICAgICBhbmltYXRlZDogZmFsc2UKICAgICAgfSk7CiAgICB9LAogICAgZmxhc2hTY3JvbGxJbmRpY2F0b3JzOiBmdW5jdGlvbiBmbGFzaFNjcm9sbEluZGljYXRvcnMoKSB7CiAgICAgIHRoaXMuZ2V0U2Nyb2xsUmVzcG9uZGVyKCkuc2Nyb2xsUmVzcG9uZGVyRmxhc2hTY3JvbGxJbmRpY2F0b3JzKCk7CiAgICB9LAogICAgX2dldEtleUZvckluZGV4OiBmdW5jdGlvbiBfZ2V0S2V5Rm9ySW5kZXgoaW5kZXgsIGNoaWxkQXJyYXkpIHsKICAgICAgdmFyIGNoaWxkID0gY2hpbGRBcnJheVtpbmRleF07CiAgICAgIHJldHVybiBjaGlsZCAmJiBjaGlsZC5rZXk7CiAgICB9LAogICAgX3VwZGF0ZUFuaW1hdGVkTm9kZUF0dGFjaG1lbnQ6IGZ1bmN0aW9uIF91cGRhdGVBbmltYXRlZE5vZGVBdHRhY2htZW50KCkgewogICAgICBpZiAodGhpcy5fc2Nyb2xsQW5pbWF0ZWRWYWx1ZUF0dGFjaG1lbnQpIHsKICAgICAgICB0aGlzLl9zY3JvbGxBbmltYXRlZFZhbHVlQXR0YWNobWVudC5kZXRhY2goKTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMucHJvcHMuc3RpY2t5SGVhZGVySW5kaWNlcyAmJiB0aGlzLnByb3BzLnN0aWNreUhlYWRlckluZGljZXMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuX3Njcm9sbEFuaW1hdGVkVmFsdWVBdHRhY2htZW50ID0gQW5pbWF0ZWQuYXR0YWNoTmF0aXZlRXZlbnQodGhpcy5fc2Nyb2xsVmlld1JlZiwgJ29uU2Nyb2xsJywgW3sKICAgICAgICAgIG5hdGl2ZUV2ZW50OiB7CiAgICAgICAgICAgIGNvbnRlbnRPZmZzZXQ6IHsKICAgICAgICAgICAgICB5OiB0aGlzLl9zY3JvbGxBbmltYXRlZFZhbHVlCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9XSk7CiAgICAgIH0KICAgIH0sCiAgICBfc2V0U3RpY2t5SGVhZGVyUmVmOiBmdW5jdGlvbiBfc2V0U3RpY2t5SGVhZGVyUmVmKGtleSwgcmVmKSB7CiAgICAgIGlmIChyZWYpIHsKICAgICAgICB0aGlzLl9zdGlja3lIZWFkZXJSZWZzLnNldChrZXksIHJlZik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fc3RpY2t5SGVhZGVyUmVmcy5kZWxldGUoa2V5KTsKICAgICAgfQogICAgfSwKICAgIF9vblN0aWNreUhlYWRlckxheW91dDogZnVuY3Rpb24gX29uU3RpY2t5SGVhZGVyTGF5b3V0KGluZGV4LCBldmVudCwga2V5KSB7CiAgICAgIGlmICghdGhpcy5wcm9wcy5zdGlja3lIZWFkZXJJbmRpY2VzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgY2hpbGRBcnJheSA9IFJlYWN0LkNoaWxkcmVuLnRvQXJyYXkodGhpcy5wcm9wcy5jaGlsZHJlbik7CgogICAgICBpZiAoa2V5ICE9PSB0aGlzLl9nZXRLZXlGb3JJbmRleChpbmRleCwgY2hpbGRBcnJheSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBsYXlvdXRZID0gZXZlbnQubmF0aXZlRXZlbnQubGF5b3V0Lnk7CgogICAgICB0aGlzLl9oZWFkZXJMYXlvdXRZcy5zZXQoa2V5LCBsYXlvdXRZKTsKCiAgICAgIHZhciBpbmRleE9mSW5kZXggPSB0aGlzLnByb3BzLnN0aWNreUhlYWRlckluZGljZXMuaW5kZXhPZihpbmRleCk7CiAgICAgIHZhciBwcmV2aW91c0hlYWRlckluZGV4ID0gdGhpcy5wcm9wcy5zdGlja3lIZWFkZXJJbmRpY2VzW2luZGV4T2ZJbmRleCAtIDFdOwoKICAgICAgaWYgKHByZXZpb3VzSGVhZGVySW5kZXggIT0gbnVsbCkgewogICAgICAgIHZhciBwcmV2aW91c0hlYWRlciA9IHRoaXMuX3N0aWNreUhlYWRlclJlZnMuZ2V0KHRoaXMuX2dldEtleUZvckluZGV4KHByZXZpb3VzSGVhZGVySW5kZXgsIGNoaWxkQXJyYXkpKTsKCiAgICAgICAgcHJldmlvdXNIZWFkZXIgJiYgcHJldmlvdXNIZWFkZXIuc2V0TmV4dEhlYWRlclkobGF5b3V0WSk7CiAgICAgIH0KICAgIH0sCiAgICBfaGFuZGxlU2Nyb2xsOiBmdW5jdGlvbiBfaGFuZGxlU2Nyb2xsKGUpIHsKICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICBpZiAodGhpcy5wcm9wcy5vblNjcm9sbCAmJiB0aGlzLnByb3BzLnNjcm9sbEV2ZW50VGhyb3R0bGUgPT0gbnVsbCAmJiBQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdZb3Ugc3BlY2lmaWVkIGBvblNjcm9sbGAgb24gYSA8U2Nyb2xsVmlldz4gYnV0IG5vdCAnICsgJ2BzY3JvbGxFdmVudFRocm90dGxlYC4gWW91IHdpbGwgb25seSByZWNlaXZlIG9uZSBldmVudC4gJyArICdVc2luZyBgMTZgIHlvdSBnZXQgYWxsIHRoZSBldmVudHMgYnV0IGJlIGF3YXJlIHRoYXQgaXQgbWF5ICcgKyAnY2F1c2UgZnJhbWUgZHJvcHMsIHVzZSBhIGJpZ2dlciBudW1iZXIgaWYgeW91IGRvblwndCBuZWVkIGFzICcgKyAnbXVjaCBwcmVjaXNpb24uJyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJykgewogICAgICAgIGlmICh0aGlzLnByb3BzLmtleWJvYXJkRGlzbWlzc01vZGUgPT09ICdvbi1kcmFnJykgewogICAgICAgICAgZGlzbWlzc0tleWJvYXJkKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnNjcm9sbFJlc3BvbmRlckhhbmRsZVNjcm9sbChlKTsKICAgIH0sCiAgICBfaGFuZGxlQ29udGVudE9uTGF5b3V0OiBmdW5jdGlvbiBfaGFuZGxlQ29udGVudE9uTGF5b3V0KGUpIHsKICAgICAgdmFyIF9lJG5hdGl2ZUV2ZW50JGxheW91dCA9IGUubmF0aXZlRXZlbnQubGF5b3V0LAogICAgICAgICAgd2lkdGggPSBfZSRuYXRpdmVFdmVudCRsYXlvdXQud2lkdGgsCiAgICAgICAgICBoZWlnaHQgPSBfZSRuYXRpdmVFdmVudCRsYXlvdXQuaGVpZ2h0OwogICAgICB0aGlzLnByb3BzLm9uQ29udGVudFNpemVDaGFuZ2UgJiYgdGhpcy5wcm9wcy5vbkNvbnRlbnRTaXplQ2hhbmdlKHdpZHRoLCBoZWlnaHQpOwogICAgfSwKICAgIF9zY3JvbGxWaWV3UmVmOiBudWxsLAogICAgX3NldFNjcm9sbFZpZXdSZWY6IGZ1bmN0aW9uIF9zZXRTY3JvbGxWaWV3UmVmKHJlZikgewogICAgICB0aGlzLl9zY3JvbGxWaWV3UmVmID0gcmVmOwogICAgfSwKICAgIF9pbm5lclZpZXdSZWY6IG51bGwsCiAgICBfc2V0SW5uZXJWaWV3UmVmOiBmdW5jdGlvbiBfc2V0SW5uZXJWaWV3UmVmKHJlZikgewogICAgICB0aGlzLl9pbm5lclZpZXdSZWYgPSByZWY7CiAgICB9LAogICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgU2Nyb2xsVmlld0NsYXNzID0gdm9pZCAwOwogICAgICB2YXIgU2Nyb2xsQ29udGVudENvbnRhaW5lclZpZXdDbGFzcyA9IHZvaWQgMDsKCiAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgICAgICBTY3JvbGxWaWV3Q2xhc3MgPSBSQ1RTY3JvbGxWaWV3OwogICAgICAgIFNjcm9sbENvbnRlbnRDb250YWluZXJWaWV3Q2xhc3MgPSBSQ1RTY3JvbGxDb250ZW50VmlldzsKICAgICAgICB3YXJuaW5nKCF0aGlzLnByb3BzLnNuYXBUb0ludGVydmFsIHx8ICF0aGlzLnByb3BzLnBhZ2luZ0VuYWJsZWQsICdzbmFwVG9JbnRlcnZhbCBpcyBjdXJyZW50bHkgaWdub3JlZCB3aGVuIHBhZ2luZ0VuYWJsZWQgaXMgdHJ1ZS4nKTsKICAgICAgfSBlbHNlIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICAgICAgaWYgKHRoaXMucHJvcHMuaG9yaXpvbnRhbCkgewogICAgICAgICAgU2Nyb2xsVmlld0NsYXNzID0gQW5kcm9pZEhvcml6b250YWxTY3JvbGxWaWV3OwogICAgICAgICAgU2Nyb2xsQ29udGVudENvbnRhaW5lclZpZXdDbGFzcyA9IEFuZHJvaWRIb3Jpem9udGFsU2Nyb2xsQ29udGVudFZpZXc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFNjcm9sbFZpZXdDbGFzcyA9IEFuZHJvaWRTY3JvbGxWaWV3OwogICAgICAgICAgU2Nyb2xsQ29udGVudENvbnRhaW5lclZpZXdDbGFzcyA9IFZpZXc7CiAgICAgICAgfQogICAgICB9CgogICAgICBpbnZhcmlhbnQoU2Nyb2xsVmlld0NsYXNzICE9PSB1bmRlZmluZWQsICdTY3JvbGxWaWV3Q2xhc3MgbXVzdCBub3QgYmUgdW5kZWZpbmVkJyk7CiAgICAgIGludmFyaWFudChTY3JvbGxDb250ZW50Q29udGFpbmVyVmlld0NsYXNzICE9PSB1bmRlZmluZWQsICdTY3JvbGxDb250ZW50Q29udGFpbmVyVmlld0NsYXNzIG11c3Qgbm90IGJlIHVuZGVmaW5lZCcpOwogICAgICB2YXIgY29udGVudENvbnRhaW5lclN0eWxlID0gW3RoaXMucHJvcHMuaG9yaXpvbnRhbCAmJiBzdHlsZXMuY29udGVudENvbnRhaW5lckhvcml6b250YWwsIHRoaXMucHJvcHMuY29udGVudENvbnRhaW5lclN0eWxlXTsKICAgICAgdmFyIHN0eWxlID0gdm9pZCAwLAogICAgICAgICAgY2hpbGRMYXlvdXRQcm9wcyA9IHZvaWQgMDsKCiAgICAgIGlmIChfX0RFVl9fICYmIHRoaXMucHJvcHMuc3R5bGUpIHsKICAgICAgICBzdHlsZSA9IGZsYXR0ZW5TdHlsZSh0aGlzLnByb3BzLnN0eWxlKTsKICAgICAgICBjaGlsZExheW91dFByb3BzID0gWydhbGlnbkl0ZW1zJywgJ2p1c3RpZnlDb250ZW50J10uZmlsdGVyKGZ1bmN0aW9uIChwcm9wKSB7CiAgICAgICAgICByZXR1cm4gc3R5bGUgJiYgc3R5bGVbcHJvcF0gIT09IHVuZGVmaW5lZDsKICAgICAgICB9KTsKICAgICAgICBpbnZhcmlhbnQoY2hpbGRMYXlvdXRQcm9wcy5sZW5ndGggPT09IDAsICdTY3JvbGxWaWV3IGNoaWxkIGxheW91dCAoJyArIEpTT04uc3RyaW5naWZ5KGNoaWxkTGF5b3V0UHJvcHMpICsgJykgbXVzdCBiZSBhcHBsaWVkIHRocm91Z2ggdGhlIGNvbnRlbnRDb250YWluZXJTdHlsZSBwcm9wLicpOwogICAgICB9CgogICAgICB2YXIgY29udGVudFNpemVDaGFuZ2VQcm9wcyA9IHt9OwoKICAgICAgaWYgKHRoaXMucHJvcHMub25Db250ZW50U2l6ZUNoYW5nZSkgewogICAgICAgIGNvbnRlbnRTaXplQ2hhbmdlUHJvcHMgPSB7CiAgICAgICAgICBvbkxheW91dDogdGhpcy5faGFuZGxlQ29udGVudE9uTGF5b3V0CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgdmFyIHN0aWNreUhlYWRlckluZGljZXMgPSB0aGlzLnByb3BzLnN0aWNreUhlYWRlckluZGljZXM7CiAgICAgIHZhciBoYXNTdGlja3lIZWFkZXJzID0gc3RpY2t5SGVhZGVySW5kaWNlcyAmJiBzdGlja3lIZWFkZXJJbmRpY2VzLmxlbmd0aCA+IDA7CiAgICAgIHZhciBjaGlsZEFycmF5ID0gaGFzU3RpY2t5SGVhZGVycyAmJiBSZWFjdC5DaGlsZHJlbi50b0FycmF5KHRoaXMucHJvcHMuY2hpbGRyZW4pOwogICAgICB2YXIgY2hpbGRyZW4gPSBoYXNTdGlja3lIZWFkZXJzID8gY2hpbGRBcnJheS5tYXAoZnVuY3Rpb24gKGNoaWxkLCBpbmRleCkgewogICAgICAgIHZhciBpbmRleE9mSW5kZXggPSBjaGlsZCA/IHN0aWNreUhlYWRlckluZGljZXMuaW5kZXhPZihpbmRleCkgOiAtMTsKCiAgICAgICAgaWYgKGluZGV4T2ZJbmRleCA+IC0xKSB7CiAgICAgICAgICB2YXIga2V5ID0gY2hpbGQua2V5OwogICAgICAgICAgdmFyIG5leHRJbmRleCA9IHN0aWNreUhlYWRlckluZGljZXNbaW5kZXhPZkluZGV4ICsgMV07CiAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgU2Nyb2xsVmlld1N0aWNreUhlYWRlciwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICAgIHJlZjogZnVuY3Rpb24gcmVmKF9yZWYyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX3NldFN0aWNreUhlYWRlclJlZihrZXksIF9yZWYyKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG5leHRIZWFkZXJMYXlvdXRZOiBfdGhpcy5faGVhZGVyTGF5b3V0WXMuZ2V0KF90aGlzLl9nZXRLZXlGb3JJbmRleChuZXh0SW5kZXgsIGNoaWxkQXJyYXkpKSwKICAgICAgICAgICAgICBvbkxheW91dDogZnVuY3Rpb24gb25MYXlvdXQoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5fb25TdGlja3lIZWFkZXJMYXlvdXQoaW5kZXgsIGV2ZW50LCBrZXkpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2Nyb2xsQW5pbWF0ZWRWYWx1ZTogX3RoaXMuX3Njcm9sbEFuaW1hdGVkVmFsdWUsCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA3MDAKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgfQogICAgICB9KSA6IHRoaXMucHJvcHMuY2hpbGRyZW47CiAgICAgIHZhciBjb250ZW50Q29udGFpbmVyID0gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICBTY3JvbGxDb250ZW50Q29udGFpbmVyVmlld0NsYXNzLAogICAgICAgIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBjb250ZW50U2l6ZUNoYW5nZVByb3BzLCB7CiAgICAgICAgICByZWY6IHRoaXMuX3NldElubmVyVmlld1JlZiwKICAgICAgICAgIHN0eWxlOiBjb250ZW50Q29udGFpbmVyU3R5bGUsCiAgICAgICAgICByZW1vdmVDbGlwcGVkU3Vidmlld3M6IFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcgJiYgaGFzU3RpY2t5SGVhZGVycyA/IGZhbHNlIDogdGhpcy5wcm9wcy5yZW1vdmVDbGlwcGVkU3Vidmlld3MsCiAgICAgICAgICBjb2xsYXBzYWJsZTogZmFsc2UsCiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiA3MTcKICAgICAgICAgIH0KICAgICAgICB9KSwKICAgICAgICBjaGlsZHJlbgogICAgICApOwogICAgICB2YXIgYWx3YXlzQm91bmNlSG9yaXpvbnRhbCA9IHRoaXMucHJvcHMuYWx3YXlzQm91bmNlSG9yaXpvbnRhbCAhPT0gdW5kZWZpbmVkID8gdGhpcy5wcm9wcy5hbHdheXNCb3VuY2VIb3Jpem9udGFsIDogdGhpcy5wcm9wcy5ob3Jpem9udGFsOwogICAgICB2YXIgYWx3YXlzQm91bmNlVmVydGljYWwgPSB0aGlzLnByb3BzLmFsd2F5c0JvdW5jZVZlcnRpY2FsICE9PSB1bmRlZmluZWQgPyB0aGlzLnByb3BzLmFsd2F5c0JvdW5jZVZlcnRpY2FsIDogIXRoaXMucHJvcHMuaG9yaXpvbnRhbDsKICAgICAgdmFyIERFUFJFQ0FURURfc2VuZFVwZGF0ZWRDaGlsZEZyYW1lcyA9ICEhdGhpcy5wcm9wcy5ERVBSRUNBVEVEX3NlbmRVcGRhdGVkQ2hpbGRGcmFtZXM7CiAgICAgIHZhciBiYXNlU3R5bGUgPSB0aGlzLnByb3BzLmhvcml6b250YWwgPyBzdHlsZXMuYmFzZUhvcml6b250YWwgOiBzdHlsZXMuYmFzZVZlcnRpY2FsOwogICAgICB2YXIgcHJvcHMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcywgewogICAgICAgIGFsd2F5c0JvdW5jZUhvcml6b250YWw6IGFsd2F5c0JvdW5jZUhvcml6b250YWwsCiAgICAgICAgYWx3YXlzQm91bmNlVmVydGljYWw6IGFsd2F5c0JvdW5jZVZlcnRpY2FsLAogICAgICAgIHN0eWxlOiBbYmFzZVN0eWxlLCB0aGlzLnByb3BzLnN0eWxlXSwKICAgICAgICBvbkNvbnRlbnRTaXplQ2hhbmdlOiBudWxsLAogICAgICAgIG9uTW9tZW50dW1TY3JvbGxCZWdpbjogdGhpcy5zY3JvbGxSZXNwb25kZXJIYW5kbGVNb21lbnR1bVNjcm9sbEJlZ2luLAogICAgICAgIG9uTW9tZW50dW1TY3JvbGxFbmQ6IHRoaXMuc2Nyb2xsUmVzcG9uZGVySGFuZGxlTW9tZW50dW1TY3JvbGxFbmQsCiAgICAgICAgb25SZXNwb25kZXJHcmFudDogdGhpcy5zY3JvbGxSZXNwb25kZXJIYW5kbGVSZXNwb25kZXJHcmFudCwKICAgICAgICBvblJlc3BvbmRlclJlamVjdDogdGhpcy5zY3JvbGxSZXNwb25kZXJIYW5kbGVSZXNwb25kZXJSZWplY3QsCiAgICAgICAgb25SZXNwb25kZXJSZWxlYXNlOiB0aGlzLnNjcm9sbFJlc3BvbmRlckhhbmRsZVJlc3BvbmRlclJlbGVhc2UsCiAgICAgICAgb25SZXNwb25kZXJUZXJtaW5hdGU6IHRoaXMuc2Nyb2xsUmVzcG9uZGVySGFuZGxlVGVybWluYXRlLAogICAgICAgIG9uUmVzcG9uZGVyVGVybWluYXRpb25SZXF1ZXN0OiB0aGlzLnNjcm9sbFJlc3BvbmRlckhhbmRsZVRlcm1pbmF0aW9uUmVxdWVzdCwKICAgICAgICBvblNjcm9sbDogdGhpcy5faGFuZGxlU2Nyb2xsLAogICAgICAgIG9uU2Nyb2xsQmVnaW5EcmFnOiB0aGlzLnNjcm9sbFJlc3BvbmRlckhhbmRsZVNjcm9sbEJlZ2luRHJhZywKICAgICAgICBvblNjcm9sbEVuZERyYWc6IHRoaXMuc2Nyb2xsUmVzcG9uZGVySGFuZGxlU2Nyb2xsRW5kRHJhZywKICAgICAgICBvblNjcm9sbFNob3VsZFNldFJlc3BvbmRlcjogdGhpcy5zY3JvbGxSZXNwb25kZXJIYW5kbGVTY3JvbGxTaG91bGRTZXRSZXNwb25kZXIsCiAgICAgICAgb25TdGFydFNob3VsZFNldFJlc3BvbmRlcjogdGhpcy5zY3JvbGxSZXNwb25kZXJIYW5kbGVTdGFydFNob3VsZFNldFJlc3BvbmRlciwKICAgICAgICBvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyQ2FwdHVyZTogdGhpcy5zY3JvbGxSZXNwb25kZXJIYW5kbGVTdGFydFNob3VsZFNldFJlc3BvbmRlckNhcHR1cmUsCiAgICAgICAgb25Ub3VjaEVuZDogdGhpcy5zY3JvbGxSZXNwb25kZXJIYW5kbGVUb3VjaEVuZCwKICAgICAgICBvblRvdWNoTW92ZTogdGhpcy5zY3JvbGxSZXNwb25kZXJIYW5kbGVUb3VjaE1vdmUsCiAgICAgICAgb25Ub3VjaFN0YXJ0OiB0aGlzLnNjcm9sbFJlc3BvbmRlckhhbmRsZVRvdWNoU3RhcnQsCiAgICAgICAgb25Ub3VjaENhbmNlbDogdGhpcy5zY3JvbGxSZXNwb25kZXJIYW5kbGVUb3VjaENhbmNlbCwKICAgICAgICBzY3JvbGxFdmVudFRocm90dGxlOiBoYXNTdGlja3lIZWFkZXJzID8gMSA6IHRoaXMucHJvcHMuc2Nyb2xsRXZlbnRUaHJvdHRsZSwKICAgICAgICBzZW5kTW9tZW50dW1FdmVudHM6IHRoaXMucHJvcHMub25Nb21lbnR1bVNjcm9sbEJlZ2luIHx8IHRoaXMucHJvcHMub25Nb21lbnR1bVNjcm9sbEVuZCA/IHRydWUgOiBmYWxzZSwKICAgICAgICBERVBSRUNBVEVEX3NlbmRVcGRhdGVkQ2hpbGRGcmFtZXM6IERFUFJFQ0FURURfc2VuZFVwZGF0ZWRDaGlsZEZyYW1lcwogICAgICB9KTsKICAgICAgdmFyIGRlY2VsZXJhdGlvblJhdGUgPSB0aGlzLnByb3BzLmRlY2VsZXJhdGlvblJhdGU7CgogICAgICBpZiAoZGVjZWxlcmF0aW9uUmF0ZSkgewogICAgICAgIHByb3BzLmRlY2VsZXJhdGlvblJhdGUgPSBwcm9jZXNzRGVjZWxlcmF0aW9uUmF0ZShkZWNlbGVyYXRpb25SYXRlKTsKICAgICAgfQoKICAgICAgdmFyIHJlZnJlc2hDb250cm9sID0gdGhpcy5wcm9wcy5yZWZyZXNoQ29udHJvbDsKCiAgICAgIGlmIChyZWZyZXNoQ29udHJvbCkgewogICAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBTY3JvbGxWaWV3Q2xhc3MsCiAgICAgICAgICAgIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBwcm9wcywgewogICAgICAgICAgICAgIHJlZjogdGhpcy5fc2V0U2Nyb2xsVmlld1JlZiwKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDc4OQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSksCiAgICAgICAgICAgIFBsYXRmb3JtLmlzVFZPUyA/IG51bGwgOiByZWZyZXNoQ29udHJvbCwKICAgICAgICAgICAgY29udGVudENvbnRhaW5lcgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHsKICAgICAgICAgIHJldHVybiBSZWFjdC5jbG9uZUVsZW1lbnQocmVmcmVzaENvbnRyb2wsIHsKICAgICAgICAgICAgc3R5bGU6IHByb3BzLnN0eWxlCiAgICAgICAgICB9LCBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBTY3JvbGxWaWV3Q2xhc3MsCiAgICAgICAgICAgIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBwcm9wcywgewogICAgICAgICAgICAgIHN0eWxlOiBiYXNlU3R5bGUsCiAgICAgICAgICAgICAgcmVmOiB0aGlzLl9zZXRTY3JvbGxWaWV3UmVmLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogODA0CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgY29udGVudENvbnRhaW5lcgogICAgICAgICAgKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICBTY3JvbGxWaWV3Q2xhc3MsCiAgICAgICAgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHByb3BzLCB7CiAgICAgICAgICByZWY6IHRoaXMuX3NldFNjcm9sbFZpZXdSZWYsCiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiA4MTEKICAgICAgICAgIH0KICAgICAgICB9KSwKICAgICAgICBjb250ZW50Q29udGFpbmVyCiAgICAgICk7CiAgICB9CiAgfSk7CiAgdmFyIHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHsKICAgIGJhc2VWZXJ0aWNhbDogewogICAgICBmbGV4R3JvdzogMSwKICAgICAgZmxleFNocmluazogMSwKICAgICAgZmxleERpcmVjdGlvbjogJ2NvbHVtbicsCiAgICAgIG92ZXJmbG93OiAnc2Nyb2xsJwogICAgfSwKICAgIGJhc2VIb3Jpem9udGFsOiB7CiAgICAgIGZsZXhHcm93OiAxLAogICAgICBmbGV4U2hyaW5rOiAxLAogICAgICBmbGV4RGlyZWN0aW9uOiAncm93JywKICAgICAgb3ZlcmZsb3c6ICdzY3JvbGwnCiAgICB9LAogICAgY29udGVudENvbnRhaW5lckhvcml6b250YWw6IHsKICAgICAgZmxleERpcmVjdGlvbjogJ3JvdycKICAgIH0KICB9KTsKICB2YXIgbmF0aXZlT25seVByb3BzID0gdm9pZCAwLAogICAgICBBbmRyb2lkU2Nyb2xsVmlldyA9IHZvaWQgMCwKICAgICAgQW5kcm9pZEhvcml6b250YWxTY3JvbGxDb250ZW50VmlldyA9IHZvaWQgMCwKICAgICAgQW5kcm9pZEhvcml6b250YWxTY3JvbGxWaWV3ID0gdm9pZCAwLAogICAgICBSQ1RTY3JvbGxWaWV3ID0gdm9pZCAwLAogICAgICBSQ1RTY3JvbGxDb250ZW50VmlldyA9IHZvaWQgMDsKCiAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHsKICAgIG5hdGl2ZU9ubHlQcm9wcyA9IHsKICAgICAgbmF0aXZlT25seTogewogICAgICAgIHNlbmRNb21lbnR1bUV2ZW50czogdHJ1ZQogICAgICB9CiAgICB9OwogICAgQW5kcm9pZFNjcm9sbFZpZXcgPSByZXF1aXJlTmF0aXZlQ29tcG9uZW50KCdSQ1RTY3JvbGxWaWV3JywgU2Nyb2xsVmlldywgbmF0aXZlT25seVByb3BzKTsKICAgIEFuZHJvaWRIb3Jpem9udGFsU2Nyb2xsVmlldyA9IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoJ0FuZHJvaWRIb3Jpem9udGFsU2Nyb2xsVmlldycsIFNjcm9sbFZpZXcsIG5hdGl2ZU9ubHlQcm9wcyk7CiAgICBBbmRyb2lkSG9yaXpvbnRhbFNjcm9sbENvbnRlbnRWaWV3ID0gcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCgnQW5kcm9pZEhvcml6b250YWxTY3JvbGxDb250ZW50VmlldycpOwogIH0gZWxzZSBpZiAoUGxhdGZvcm0uT1MgPT09ICdpb3MnKSB7CiAgICBuYXRpdmVPbmx5UHJvcHMgPSB7CiAgICAgIG5hdGl2ZU9ubHk6IHsKICAgICAgICBvbk1vbWVudHVtU2Nyb2xsQmVnaW46IHRydWUsCiAgICAgICAgb25Nb21lbnR1bVNjcm9sbEVuZDogdHJ1ZSwKICAgICAgICBvblNjcm9sbEJlZ2luRHJhZzogdHJ1ZSwKICAgICAgICBvblNjcm9sbEVuZERyYWc6IHRydWUKICAgICAgfQogICAgfTsKICAgIFJDVFNjcm9sbFZpZXcgPSByZXF1aXJlTmF0aXZlQ29tcG9uZW50KCdSQ1RTY3JvbGxWaWV3JywgU2Nyb2xsVmlldywgbmF0aXZlT25seVByb3BzKTsKICAgIFJDVFNjcm9sbENvbnRlbnRWaWV3ID0gcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCgnUkNUU2Nyb2xsQ29udGVudFZpZXcnLCBWaWV3KTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gU2Nyb2xsVmlldzsKfSwyMjQsWzE5NCwxMjMsMTMyLDUyLDIyNSwxMjcsMTMwLDIxLDIyNiwyMzMsMTY4LDEzOCwxNzAsMTMxLDEzOSwxNzIsMjI5LDEwMSwxMywyMzQsMTQ1LDU2XSwiU2Nyb2xsVmlldyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJwcm9wLXR5cGVzIik7CgogIHZhciBjcmVhdGVTdHJpY3RTaGFwZVR5cGVDaGVja2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImNyZWF0ZVN0cmljdFNoYXBlVHlwZUNoZWNrZXIiKTsKCiAgdmFyIFBvaW50UHJvcFR5cGUgPSBjcmVhdGVTdHJpY3RTaGFwZVR5cGVDaGVja2VyKHsKICAgIHg6IFByb3BUeXBlcy5udW1iZXIsCiAgICB5OiBQcm9wVHlwZXMubnVtYmVyCiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBQb2ludFByb3BUeXBlOwp9LDIyNSxbMTI3LDEzM10sIlBvaW50UHJvcFR5cGUiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBEaW1lbnNpb25zID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkRpbWVuc2lvbnMiKTsKCiAgdmFyIEZyYW1lUmF0ZUxvZ2dlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJGcmFtZVJhdGVMb2dnZXIiKTsKCiAgdmFyIEtleWJvYXJkID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIktleWJvYXJkIik7CgogIHZhciBSZWFjdE5hdGl2ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJSZWFjdE5hdGl2ZSIpOwoKICB2YXIgU3Vic2NyaWJhYmxlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlN1YnNjcmliYWJsZSIpOwoKICB2YXIgVGV4dElucHV0U3RhdGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiVGV4dElucHV0U3RhdGUiKTsKCiAgdmFyIFVJTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJVSU1hbmFnZXIiKTsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIG51bGx0aHJvd3MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAiZmJqcy9saWIvbnVsbHRocm93cyIpOwoKICB2YXIgcGVyZm9ybWFuY2VOb3cgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAiZmJqcy9saWIvcGVyZm9ybWFuY2VOb3ciKTsKCiAgdmFyIHdhcm5pbmcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEwXSwgImZianMvbGliL3dhcm5pbmciKTsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMV0sICJOYXRpdmVNb2R1bGVzIiksCiAgICAgIFNjcm9sbFZpZXdNYW5hZ2VyID0gX3JlcXVpcmUuU2Nyb2xsVmlld01hbmFnZXI7CgogIHZhciBfcmVxdWlyZTIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEyXSwgIlJlYWN0TmF0aXZlQ29tcG9uZW50VHJlZSIpLAogICAgICBnZXRJbnN0YW5jZUZyb21Ob2RlID0gX3JlcXVpcmUyLmdldEluc3RhbmNlRnJvbU5vZGU7CgogIHZhciBJU19BTklNQVRJTkdfVE9VQ0hfU1RBUlRfVEhSRVNIT0xEX01TID0gMTY7CgogIGZ1bmN0aW9uIGlzVGFnSW5zdGFuY2VPZlRleHRJbnB1dCh0YWcpIHsKICAgIHZhciBpbnN0YW5jZSA9IGdldEluc3RhbmNlRnJvbU5vZGUodGFnKTsKICAgIHJldHVybiBpbnN0YW5jZSAmJiBpbnN0YW5jZS52aWV3Q29uZmlnICYmIChpbnN0YW5jZS52aWV3Q29uZmlnLnVpVmlld0NsYXNzTmFtZSA9PT0gJ0FuZHJvaWRUZXh0SW5wdXQnIHx8IGluc3RhbmNlLnZpZXdDb25maWcudWlWaWV3Q2xhc3NOYW1lID09PSAnUkNUVGV4dFZpZXcnIHx8IGluc3RhbmNlLnZpZXdDb25maWcudWlWaWV3Q2xhc3NOYW1lID09PSAnUkNUVGV4dEZpZWxkJyk7CiAgfQoKICB2YXIgU2Nyb2xsUmVzcG9uZGVyTWl4aW4gPSB7CiAgICBtaXhpbnM6IFtTdWJzY3JpYmFibGUuTWl4aW5dLAogICAgc2Nyb2xsUmVzcG9uZGVyTWl4aW5HZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlck1peGluR2V0SW5pdGlhbFN0YXRlKCkgewogICAgICByZXR1cm4gewogICAgICAgIGlzVG91Y2hpbmc6IGZhbHNlLAogICAgICAgIGxhc3RNb21lbnR1bVNjcm9sbEJlZ2luVGltZTogMCwKICAgICAgICBsYXN0TW9tZW50dW1TY3JvbGxFbmRUaW1lOiAwLAogICAgICAgIG9ic2VydmVkU2Nyb2xsU2luY2VCZWNvbWluZ1Jlc3BvbmRlcjogZmFsc2UsCiAgICAgICAgYmVjYW1lUmVzcG9uZGVyV2hpbGVBbmltYXRpbmc6IGZhbHNlCiAgICAgIH07CiAgICB9LAogICAgc2Nyb2xsUmVzcG9uZGVySGFuZGxlU2Nyb2xsU2hvdWxkU2V0UmVzcG9uZGVyOiBmdW5jdGlvbiBzY3JvbGxSZXNwb25kZXJIYW5kbGVTY3JvbGxTaG91bGRTZXRSZXNwb25kZXIoKSB7CiAgICAgIHJldHVybiB0aGlzLnN0YXRlLmlzVG91Y2hpbmc7CiAgICB9LAogICAgc2Nyb2xsUmVzcG9uZGVySGFuZGxlU3RhcnRTaG91bGRTZXRSZXNwb25kZXI6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlckhhbmRsZVN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyKGUpIHsKICAgICAgdmFyIGN1cnJlbnRseUZvY3VzZWRUZXh0SW5wdXQgPSBUZXh0SW5wdXRTdGF0ZS5jdXJyZW50bHlGb2N1c2VkRmllbGQoKTsKCiAgICAgIGlmICh0aGlzLnByb3BzLmtleWJvYXJkU2hvdWxkUGVyc2lzdFRhcHMgPT09ICdoYW5kbGVkJyAmJiBjdXJyZW50bHlGb2N1c2VkVGV4dElucHV0ICE9IG51bGwgJiYgZS50YXJnZXQgIT09IGN1cnJlbnRseUZvY3VzZWRUZXh0SW5wdXQpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIHNjcm9sbFJlc3BvbmRlckhhbmRsZVN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyQ2FwdHVyZTogZnVuY3Rpb24gc2Nyb2xsUmVzcG9uZGVySGFuZGxlU3RhcnRTaG91bGRTZXRSZXNwb25kZXJDYXB0dXJlKGUpIHsKICAgICAgdmFyIGN1cnJlbnRseUZvY3VzZWRUZXh0SW5wdXQgPSBUZXh0SW5wdXRTdGF0ZS5jdXJyZW50bHlGb2N1c2VkRmllbGQoKTsKICAgICAgdmFyIGtleWJvYXJkU2hvdWxkUGVyc2lzdFRhcHMgPSB0aGlzLnByb3BzLmtleWJvYXJkU2hvdWxkUGVyc2lzdFRhcHM7CiAgICAgIHZhciBrZXlib2FyZE5ldmVyUGVyc2lzdFRhcHMgPSAha2V5Ym9hcmRTaG91bGRQZXJzaXN0VGFwcyB8fCBrZXlib2FyZFNob3VsZFBlcnNpc3RUYXBzID09PSAnbmV2ZXInOwoKICAgICAgaWYgKGtleWJvYXJkTmV2ZXJQZXJzaXN0VGFwcyAmJiBjdXJyZW50bHlGb2N1c2VkVGV4dElucHV0ICE9IG51bGwgJiYgIWlzVGFnSW5zdGFuY2VPZlRleHRJbnB1dChlLnRhcmdldCkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsUmVzcG9uZGVySXNBbmltYXRpbmcoKTsKICAgIH0sCiAgICBzY3JvbGxSZXNwb25kZXJIYW5kbGVSZXNwb25kZXJSZWplY3Q6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlckhhbmRsZVJlc3BvbmRlclJlamVjdCgpIHt9LAogICAgc2Nyb2xsUmVzcG9uZGVySGFuZGxlVGVybWluYXRpb25SZXF1ZXN0OiBmdW5jdGlvbiBzY3JvbGxSZXNwb25kZXJIYW5kbGVUZXJtaW5hdGlvblJlcXVlc3QoKSB7CiAgICAgIHJldHVybiAhdGhpcy5zdGF0ZS5vYnNlcnZlZFNjcm9sbFNpbmNlQmVjb21pbmdSZXNwb25kZXI7CiAgICB9LAogICAgc2Nyb2xsUmVzcG9uZGVySGFuZGxlVG91Y2hFbmQ6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlckhhbmRsZVRvdWNoRW5kKGUpIHsKICAgICAgdmFyIG5hdGl2ZUV2ZW50ID0gZS5uYXRpdmVFdmVudDsKICAgICAgdGhpcy5zdGF0ZS5pc1RvdWNoaW5nID0gbmF0aXZlRXZlbnQudG91Y2hlcy5sZW5ndGggIT09IDA7CiAgICAgIHRoaXMucHJvcHMub25Ub3VjaEVuZCAmJiB0aGlzLnByb3BzLm9uVG91Y2hFbmQoZSk7CiAgICB9LAogICAgc2Nyb2xsUmVzcG9uZGVySGFuZGxlVG91Y2hDYW5jZWw6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlckhhbmRsZVRvdWNoQ2FuY2VsKGUpIHsKICAgICAgdGhpcy5zdGF0ZS5pc1RvdWNoaW5nID0gZmFsc2U7CiAgICAgIHRoaXMucHJvcHMub25Ub3VjaENhbmNlbCAmJiB0aGlzLnByb3BzLm9uVG91Y2hDYW5jZWwoZSk7CiAgICB9LAogICAgc2Nyb2xsUmVzcG9uZGVySGFuZGxlUmVzcG9uZGVyUmVsZWFzZTogZnVuY3Rpb24gc2Nyb2xsUmVzcG9uZGVySGFuZGxlUmVzcG9uZGVyUmVsZWFzZShlKSB7CiAgICAgIHRoaXMucHJvcHMub25SZXNwb25kZXJSZWxlYXNlICYmIHRoaXMucHJvcHMub25SZXNwb25kZXJSZWxlYXNlKGUpOwogICAgICB2YXIgY3VycmVudGx5Rm9jdXNlZFRleHRJbnB1dCA9IFRleHRJbnB1dFN0YXRlLmN1cnJlbnRseUZvY3VzZWRGaWVsZCgpOwoKICAgICAgaWYgKHRoaXMucHJvcHMua2V5Ym9hcmRTaG91bGRQZXJzaXN0VGFwcyAhPT0gdHJ1ZSAmJiB0aGlzLnByb3BzLmtleWJvYXJkU2hvdWxkUGVyc2lzdFRhcHMgIT09ICdhbHdheXMnICYmIGN1cnJlbnRseUZvY3VzZWRUZXh0SW5wdXQgIT0gbnVsbCAmJiBlLnRhcmdldCAhPT0gY3VycmVudGx5Rm9jdXNlZFRleHRJbnB1dCAmJiAhdGhpcy5zdGF0ZS5vYnNlcnZlZFNjcm9sbFNpbmNlQmVjb21pbmdSZXNwb25kZXIgJiYgIXRoaXMuc3RhdGUuYmVjYW1lUmVzcG9uZGVyV2hpbGVBbmltYXRpbmcpIHsKICAgICAgICB0aGlzLnByb3BzLm9uU2Nyb2xsUmVzcG9uZGVyS2V5Ym9hcmREaXNtaXNzZWQgJiYgdGhpcy5wcm9wcy5vblNjcm9sbFJlc3BvbmRlcktleWJvYXJkRGlzbWlzc2VkKGUpOwogICAgICAgIFRleHRJbnB1dFN0YXRlLmJsdXJUZXh0SW5wdXQoY3VycmVudGx5Rm9jdXNlZFRleHRJbnB1dCk7CiAgICAgIH0KICAgIH0sCiAgICBzY3JvbGxSZXNwb25kZXJIYW5kbGVTY3JvbGw6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlckhhbmRsZVNjcm9sbChlKSB7CiAgICAgIHRoaXMuc3RhdGUub2JzZXJ2ZWRTY3JvbGxTaW5jZUJlY29taW5nUmVzcG9uZGVyID0gdHJ1ZTsKICAgICAgdGhpcy5wcm9wcy5vblNjcm9sbCAmJiB0aGlzLnByb3BzLm9uU2Nyb2xsKGUpOwogICAgfSwKICAgIHNjcm9sbFJlc3BvbmRlckhhbmRsZVJlc3BvbmRlckdyYW50OiBmdW5jdGlvbiBzY3JvbGxSZXNwb25kZXJIYW5kbGVSZXNwb25kZXJHcmFudChlKSB7CiAgICAgIHRoaXMuc3RhdGUub2JzZXJ2ZWRTY3JvbGxTaW5jZUJlY29taW5nUmVzcG9uZGVyID0gZmFsc2U7CiAgICAgIHRoaXMucHJvcHMub25SZXNwb25kZXJHcmFudCAmJiB0aGlzLnByb3BzLm9uUmVzcG9uZGVyR3JhbnQoZSk7CiAgICAgIHRoaXMuc3RhdGUuYmVjYW1lUmVzcG9uZGVyV2hpbGVBbmltYXRpbmcgPSB0aGlzLnNjcm9sbFJlc3BvbmRlcklzQW5pbWF0aW5nKCk7CiAgICB9LAogICAgc2Nyb2xsUmVzcG9uZGVySGFuZGxlU2Nyb2xsQmVnaW5EcmFnOiBmdW5jdGlvbiBzY3JvbGxSZXNwb25kZXJIYW5kbGVTY3JvbGxCZWdpbkRyYWcoZSkgewogICAgICBGcmFtZVJhdGVMb2dnZXIuYmVnaW5TY3JvbGwoKTsKICAgICAgdGhpcy5wcm9wcy5vblNjcm9sbEJlZ2luRHJhZyAmJiB0aGlzLnByb3BzLm9uU2Nyb2xsQmVnaW5EcmFnKGUpOwogICAgfSwKICAgIHNjcm9sbFJlc3BvbmRlckhhbmRsZVNjcm9sbEVuZERyYWc6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlckhhbmRsZVNjcm9sbEVuZERyYWcoZSkgewogICAgICB2YXIgdmVsb2NpdHkgPSBlLm5hdGl2ZUV2ZW50LnZlbG9jaXR5OwoKICAgICAgaWYgKCF0aGlzLnNjcm9sbFJlc3BvbmRlcklzQW5pbWF0aW5nKCkgJiYgKCF2ZWxvY2l0eSB8fCB2ZWxvY2l0eS54ID09PSAwICYmIHZlbG9jaXR5LnkgPT09IDApKSB7CiAgICAgICAgRnJhbWVSYXRlTG9nZ2VyLmVuZFNjcm9sbCgpOwogICAgICB9CgogICAgICB0aGlzLnByb3BzLm9uU2Nyb2xsRW5kRHJhZyAmJiB0aGlzLnByb3BzLm9uU2Nyb2xsRW5kRHJhZyhlKTsKICAgIH0sCiAgICBzY3JvbGxSZXNwb25kZXJIYW5kbGVNb21lbnR1bVNjcm9sbEJlZ2luOiBmdW5jdGlvbiBzY3JvbGxSZXNwb25kZXJIYW5kbGVNb21lbnR1bVNjcm9sbEJlZ2luKGUpIHsKICAgICAgdGhpcy5zdGF0ZS5sYXN0TW9tZW50dW1TY3JvbGxCZWdpblRpbWUgPSBwZXJmb3JtYW5jZU5vdygpOwogICAgICB0aGlzLnByb3BzLm9uTW9tZW50dW1TY3JvbGxCZWdpbiAmJiB0aGlzLnByb3BzLm9uTW9tZW50dW1TY3JvbGxCZWdpbihlKTsKICAgIH0sCiAgICBzY3JvbGxSZXNwb25kZXJIYW5kbGVNb21lbnR1bVNjcm9sbEVuZDogZnVuY3Rpb24gc2Nyb2xsUmVzcG9uZGVySGFuZGxlTW9tZW50dW1TY3JvbGxFbmQoZSkgewogICAgICBGcmFtZVJhdGVMb2dnZXIuZW5kU2Nyb2xsKCk7CiAgICAgIHRoaXMuc3RhdGUubGFzdE1vbWVudHVtU2Nyb2xsRW5kVGltZSA9IHBlcmZvcm1hbmNlTm93KCk7CiAgICAgIHRoaXMucHJvcHMub25Nb21lbnR1bVNjcm9sbEVuZCAmJiB0aGlzLnByb3BzLm9uTW9tZW50dW1TY3JvbGxFbmQoZSk7CiAgICB9LAogICAgc2Nyb2xsUmVzcG9uZGVySGFuZGxlVG91Y2hTdGFydDogZnVuY3Rpb24gc2Nyb2xsUmVzcG9uZGVySGFuZGxlVG91Y2hTdGFydChlKSB7CiAgICAgIHRoaXMuc3RhdGUuaXNUb3VjaGluZyA9IHRydWU7CiAgICAgIHRoaXMucHJvcHMub25Ub3VjaFN0YXJ0ICYmIHRoaXMucHJvcHMub25Ub3VjaFN0YXJ0KGUpOwogICAgfSwKICAgIHNjcm9sbFJlc3BvbmRlckhhbmRsZVRvdWNoTW92ZTogZnVuY3Rpb24gc2Nyb2xsUmVzcG9uZGVySGFuZGxlVG91Y2hNb3ZlKGUpIHsKICAgICAgdGhpcy5wcm9wcy5vblRvdWNoTW92ZSAmJiB0aGlzLnByb3BzLm9uVG91Y2hNb3ZlKGUpOwogICAgfSwKICAgIHNjcm9sbFJlc3BvbmRlcklzQW5pbWF0aW5nOiBmdW5jdGlvbiBzY3JvbGxSZXNwb25kZXJJc0FuaW1hdGluZygpIHsKICAgICAgdmFyIG5vdyA9IHBlcmZvcm1hbmNlTm93KCk7CiAgICAgIHZhciB0aW1lU2luY2VMYXN0TW9tZW50dW1TY3JvbGxFbmQgPSBub3cgLSB0aGlzLnN0YXRlLmxhc3RNb21lbnR1bVNjcm9sbEVuZFRpbWU7CiAgICAgIHZhciBpc0FuaW1hdGluZyA9IHRpbWVTaW5jZUxhc3RNb21lbnR1bVNjcm9sbEVuZCA8IElTX0FOSU1BVElOR19UT1VDSF9TVEFSVF9USFJFU0hPTERfTVMgfHwgdGhpcy5zdGF0ZS5sYXN0TW9tZW50dW1TY3JvbGxFbmRUaW1lIDwgdGhpcy5zdGF0ZS5sYXN0TW9tZW50dW1TY3JvbGxCZWdpblRpbWU7CiAgICAgIHJldHVybiBpc0FuaW1hdGluZzsKICAgIH0sCiAgICBzY3JvbGxSZXNwb25kZXJHZXRTY3JvbGxhYmxlTm9kZTogZnVuY3Rpb24gc2Nyb2xsUmVzcG9uZGVyR2V0U2Nyb2xsYWJsZU5vZGUoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldFNjcm9sbGFibGVOb2RlID8gdGhpcy5nZXRTY3JvbGxhYmxlTm9kZSgpIDogUmVhY3ROYXRpdmUuZmluZE5vZGVIYW5kbGUodGhpcyk7CiAgICB9LAogICAgc2Nyb2xsUmVzcG9uZGVyU2Nyb2xsVG86IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlclNjcm9sbFRvKHgsIHksIGFuaW1hdGVkKSB7CiAgICAgIGlmICh0eXBlb2YgeCA9PT0gJ251bWJlcicpIHsKICAgICAgICBjb25zb2xlLndhcm4oJ2BzY3JvbGxSZXNwb25kZXJTY3JvbGxUbyh4LCB5LCBhbmltYXRlZClgIGlzIGRlcHJlY2F0ZWQuIFVzZSBgc2Nyb2xsUmVzcG9uZGVyU2Nyb2xsVG8oe3g6IDUsIHk6IDUsIGFuaW1hdGVkOiB0cnVlfSlgIGluc3RlYWQuJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIF9yZWYgPSB4IHx8IHt9OwoKICAgICAgICB4ID0gX3JlZi54OwogICAgICAgIHkgPSBfcmVmLnk7CiAgICAgICAgYW5pbWF0ZWQgPSBfcmVmLmFuaW1hdGVkOwogICAgICB9CgogICAgICBVSU1hbmFnZXIuZGlzcGF0Y2hWaWV3TWFuYWdlckNvbW1hbmQobnVsbHRocm93cyh0aGlzLnNjcm9sbFJlc3BvbmRlckdldFNjcm9sbGFibGVOb2RlKCkpLCBVSU1hbmFnZXIuUkNUU2Nyb2xsVmlldy5Db21tYW5kcy5zY3JvbGxUbywgW3ggfHwgMCwgeSB8fCAwLCBhbmltYXRlZCAhPT0gZmFsc2VdKTsKICAgIH0sCiAgICBzY3JvbGxSZXNwb25kZXJTY3JvbGxUb0VuZDogZnVuY3Rpb24gc2Nyb2xsUmVzcG9uZGVyU2Nyb2xsVG9FbmQob3B0aW9ucykgewogICAgICB2YXIgYW5pbWF0ZWQgPSAob3B0aW9ucyAmJiBvcHRpb25zLmFuaW1hdGVkKSAhPT0gZmFsc2U7CiAgICAgIFVJTWFuYWdlci5kaXNwYXRjaFZpZXdNYW5hZ2VyQ29tbWFuZCh0aGlzLnNjcm9sbFJlc3BvbmRlckdldFNjcm9sbGFibGVOb2RlKCksIFVJTWFuYWdlci5SQ1RTY3JvbGxWaWV3LkNvbW1hbmRzLnNjcm9sbFRvRW5kLCBbYW5pbWF0ZWRdKTsKICAgIH0sCiAgICBzY3JvbGxSZXNwb25kZXJTY3JvbGxXaXRob3V0QW5pbWF0aW9uVG86IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlclNjcm9sbFdpdGhvdXRBbmltYXRpb25UbyhvZmZzZXRYLCBvZmZzZXRZKSB7CiAgICAgIGNvbnNvbGUud2FybignYHNjcm9sbFJlc3BvbmRlclNjcm9sbFdpdGhvdXRBbmltYXRpb25Ub2AgaXMgZGVwcmVjYXRlZC4gVXNlIGBzY3JvbGxSZXNwb25kZXJTY3JvbGxUb2AgaW5zdGVhZCcpOwogICAgICB0aGlzLnNjcm9sbFJlc3BvbmRlclNjcm9sbFRvKHsKICAgICAgICB4OiBvZmZzZXRYLAogICAgICAgIHk6IG9mZnNldFksCiAgICAgICAgYW5pbWF0ZWQ6IGZhbHNlCiAgICAgIH0pOwogICAgfSwKICAgIHNjcm9sbFJlc3BvbmRlclpvb21UbzogZnVuY3Rpb24gc2Nyb2xsUmVzcG9uZGVyWm9vbVRvKHJlY3QsIGFuaW1hdGVkKSB7CiAgICAgIGludmFyaWFudChTY3JvbGxWaWV3TWFuYWdlciAmJiBTY3JvbGxWaWV3TWFuYWdlci56b29tVG9SZWN0LCAnem9vbVRvUmVjdCBpcyBub3QgaW1wbGVtZW50ZWQnKTsKCiAgICAgIGlmICgnYW5pbWF0ZWQnIGluIHJlY3QpIHsKICAgICAgICB2YXIgYW5pbWF0ZWQgPSByZWN0LmFuaW1hdGVkLAogICAgICAgICAgICByZWN0ID0gYmFiZWxIZWxwZXJzLm9iamVjdFdpdGhvdXRQcm9wZXJ0aWVzKHJlY3QsIFsiYW5pbWF0ZWQiXSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFuaW1hdGVkICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIGNvbnNvbGUud2FybignYHNjcm9sbFJlc3BvbmRlclpvb21Ub2AgYGFuaW1hdGVkYCBhcmd1bWVudCBpcyBkZXByZWNhdGVkLiBVc2UgYG9wdGlvbnMuYW5pbWF0ZWRgIGluc3RlYWQnKTsKICAgICAgfQoKICAgICAgU2Nyb2xsVmlld01hbmFnZXIuem9vbVRvUmVjdCh0aGlzLnNjcm9sbFJlc3BvbmRlckdldFNjcm9sbGFibGVOb2RlKCksIHJlY3QsIGFuaW1hdGVkICE9PSBmYWxzZSk7CiAgICB9LAogICAgc2Nyb2xsUmVzcG9uZGVyRmxhc2hTY3JvbGxJbmRpY2F0b3JzOiBmdW5jdGlvbiBzY3JvbGxSZXNwb25kZXJGbGFzaFNjcm9sbEluZGljYXRvcnMoKSB7CiAgICAgIFVJTWFuYWdlci5kaXNwYXRjaFZpZXdNYW5hZ2VyQ29tbWFuZCh0aGlzLnNjcm9sbFJlc3BvbmRlckdldFNjcm9sbGFibGVOb2RlKCksIFVJTWFuYWdlci5SQ1RTY3JvbGxWaWV3LkNvbW1hbmRzLmZsYXNoU2Nyb2xsSW5kaWNhdG9ycywgW10pOwogICAgfSwKICAgIHNjcm9sbFJlc3BvbmRlclNjcm9sbE5hdGl2ZUhhbmRsZVRvS2V5Ym9hcmQ6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlclNjcm9sbE5hdGl2ZUhhbmRsZVRvS2V5Ym9hcmQobm9kZUhhbmRsZSwgYWRkaXRpb25hbE9mZnNldCwgcHJldmVudE5lZ2F0aXZlU2Nyb2xsT2Zmc2V0KSB7CiAgICAgIHRoaXMuYWRkaXRpb25hbFNjcm9sbE9mZnNldCA9IGFkZGl0aW9uYWxPZmZzZXQgfHwgMDsKICAgICAgdGhpcy5wcmV2ZW50TmVnYXRpdmVTY3JvbGxPZmZzZXQgPSAhIXByZXZlbnROZWdhdGl2ZVNjcm9sbE9mZnNldDsKICAgICAgVUlNYW5hZ2VyLm1lYXN1cmVMYXlvdXQobm9kZUhhbmRsZSwgUmVhY3ROYXRpdmUuZmluZE5vZGVIYW5kbGUodGhpcy5nZXRJbm5lclZpZXdOb2RlKCkpLCB0aGlzLnNjcm9sbFJlc3BvbmRlclRleHRJbnB1dEZvY3VzRXJyb3IsIHRoaXMuc2Nyb2xsUmVzcG9uZGVySW5wdXRNZWFzdXJlQW5kU2Nyb2xsVG9LZXlib2FyZCk7CiAgICB9LAogICAgc2Nyb2xsUmVzcG9uZGVySW5wdXRNZWFzdXJlQW5kU2Nyb2xsVG9LZXlib2FyZDogZnVuY3Rpb24gc2Nyb2xsUmVzcG9uZGVySW5wdXRNZWFzdXJlQW5kU2Nyb2xsVG9LZXlib2FyZChsZWZ0LCB0b3AsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgdmFyIGtleWJvYXJkU2NyZWVuWSA9IERpbWVuc2lvbnMuZ2V0KCd3aW5kb3cnKS5oZWlnaHQ7CgogICAgICBpZiAodGhpcy5rZXlib2FyZFdpbGxPcGVuVG8pIHsKICAgICAgICBrZXlib2FyZFNjcmVlblkgPSB0aGlzLmtleWJvYXJkV2lsbE9wZW5Uby5lbmRDb29yZGluYXRlcy5zY3JlZW5ZOwogICAgICB9CgogICAgICB2YXIgc2Nyb2xsT2Zmc2V0WSA9IHRvcCAtIGtleWJvYXJkU2NyZWVuWSArIGhlaWdodCArIHRoaXMuYWRkaXRpb25hbFNjcm9sbE9mZnNldDsKCiAgICAgIGlmICh0aGlzLnByZXZlbnROZWdhdGl2ZVNjcm9sbE9mZnNldCkgewogICAgICAgIHNjcm9sbE9mZnNldFkgPSBNYXRoLm1heCgwLCBzY3JvbGxPZmZzZXRZKTsKICAgICAgfQoKICAgICAgdGhpcy5zY3JvbGxSZXNwb25kZXJTY3JvbGxUbyh7CiAgICAgICAgeDogMCwKICAgICAgICB5OiBzY3JvbGxPZmZzZXRZLAogICAgICAgIGFuaW1hdGVkOiB0cnVlCiAgICAgIH0pOwogICAgICB0aGlzLmFkZGl0aW9uYWxPZmZzZXQgPSAwOwogICAgICB0aGlzLnByZXZlbnROZWdhdGl2ZVNjcm9sbE9mZnNldCA9IGZhbHNlOwogICAgfSwKICAgIHNjcm9sbFJlc3BvbmRlclRleHRJbnB1dEZvY3VzRXJyb3I6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlclRleHRJbnB1dEZvY3VzRXJyb3IoZSkgewogICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBtZWFzdXJpbmcgdGV4dCBmaWVsZDogJywgZSk7CiAgICB9LAogICAgY29tcG9uZW50V2lsbE1vdW50OiBmdW5jdGlvbiBjb21wb25lbnRXaWxsTW91bnQoKSB7CiAgICAgIHZhciBrZXlib2FyZFNob3VsZFBlcnNpc3RUYXBzID0gdGhpcy5wcm9wcy5rZXlib2FyZFNob3VsZFBlcnNpc3RUYXBzOwogICAgICB3YXJuaW5nKHR5cGVvZiBrZXlib2FyZFNob3VsZFBlcnNpc3RUYXBzICE9PSAnYm9vbGVhbicsICIna2V5Ym9hcmRTaG91bGRQZXJzaXN0VGFwcz17IiArIGtleWJvYXJkU2hvdWxkUGVyc2lzdFRhcHMgKyAifScgaXMgZGVwcmVjYXRlZC4gIiArICgiVXNlICdrZXlib2FyZFNob3VsZFBlcnNpc3RUYXBzPVwiIiArIChrZXlib2FyZFNob3VsZFBlcnNpc3RUYXBzID8gJ2Fsd2F5cycgOiAnbmV2ZXInKSArICJcIicgaW5zdGVhZCIpKTsKICAgICAgdGhpcy5rZXlib2FyZFdpbGxPcGVuVG8gPSBudWxsOwogICAgICB0aGlzLmFkZGl0aW9uYWxTY3JvbGxPZmZzZXQgPSAwOwogICAgICB0aGlzLmFkZExpc3RlbmVyT24oS2V5Ym9hcmQsICdrZXlib2FyZFdpbGxTaG93JywgdGhpcy5zY3JvbGxSZXNwb25kZXJLZXlib2FyZFdpbGxTaG93KTsKICAgICAgdGhpcy5hZGRMaXN0ZW5lck9uKEtleWJvYXJkLCAna2V5Ym9hcmRXaWxsSGlkZScsIHRoaXMuc2Nyb2xsUmVzcG9uZGVyS2V5Ym9hcmRXaWxsSGlkZSk7CiAgICAgIHRoaXMuYWRkTGlzdGVuZXJPbihLZXlib2FyZCwgJ2tleWJvYXJkRGlkU2hvdycsIHRoaXMuc2Nyb2xsUmVzcG9uZGVyS2V5Ym9hcmREaWRTaG93KTsKICAgICAgdGhpcy5hZGRMaXN0ZW5lck9uKEtleWJvYXJkLCAna2V5Ym9hcmREaWRIaWRlJywgdGhpcy5zY3JvbGxSZXNwb25kZXJLZXlib2FyZERpZEhpZGUpOwogICAgfSwKICAgIHNjcm9sbFJlc3BvbmRlcktleWJvYXJkV2lsbFNob3c6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlcktleWJvYXJkV2lsbFNob3coZSkgewogICAgICB0aGlzLmtleWJvYXJkV2lsbE9wZW5UbyA9IGU7CiAgICAgIHRoaXMucHJvcHMub25LZXlib2FyZFdpbGxTaG93ICYmIHRoaXMucHJvcHMub25LZXlib2FyZFdpbGxTaG93KGUpOwogICAgfSwKICAgIHNjcm9sbFJlc3BvbmRlcktleWJvYXJkV2lsbEhpZGU6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlcktleWJvYXJkV2lsbEhpZGUoZSkgewogICAgICB0aGlzLmtleWJvYXJkV2lsbE9wZW5UbyA9IG51bGw7CiAgICAgIHRoaXMucHJvcHMub25LZXlib2FyZFdpbGxIaWRlICYmIHRoaXMucHJvcHMub25LZXlib2FyZFdpbGxIaWRlKGUpOwogICAgfSwKICAgIHNjcm9sbFJlc3BvbmRlcktleWJvYXJkRGlkU2hvdzogZnVuY3Rpb24gc2Nyb2xsUmVzcG9uZGVyS2V5Ym9hcmREaWRTaG93KGUpIHsKICAgICAgaWYgKGUpIHsKICAgICAgICB0aGlzLmtleWJvYXJkV2lsbE9wZW5UbyA9IGU7CiAgICAgIH0KCiAgICAgIHRoaXMucHJvcHMub25LZXlib2FyZERpZFNob3cgJiYgdGhpcy5wcm9wcy5vbktleWJvYXJkRGlkU2hvdyhlKTsKICAgIH0sCiAgICBzY3JvbGxSZXNwb25kZXJLZXlib2FyZERpZEhpZGU6IGZ1bmN0aW9uIHNjcm9sbFJlc3BvbmRlcktleWJvYXJkRGlkSGlkZShlKSB7CiAgICAgIHRoaXMua2V5Ym9hcmRXaWxsT3BlblRvID0gbnVsbDsKICAgICAgdGhpcy5wcm9wcy5vbktleWJvYXJkRGlkSGlkZSAmJiB0aGlzLnByb3BzLm9uS2V5Ym9hcmREaWRIaWRlKGUpOwogICAgfQogIH07CiAgdmFyIFNjcm9sbFJlc3BvbmRlciA9IHsKICAgIE1peGluOiBTY3JvbGxSZXNwb25kZXJNaXhpbgogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBTY3JvbGxSZXNwb25kZXI7Cn0sMjI2LFsxNjQsMjI3LDIyOCwyMSwyMzAsMTE1LDEwNywxMywyMzEsNTMsNTYsMTUsMjMyXSwiU2Nyb2xsUmVzcG9uZGVyIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgTmF0aXZlTW9kdWxlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBGcmFtZVJhdGVMb2dnZXIgPSB7CiAgICBzZXRHbG9iYWxPcHRpb25zOiBmdW5jdGlvbiBzZXRHbG9iYWxPcHRpb25zKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMuZGVidWcgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGludmFyaWFudChOYXRpdmVNb2R1bGVzLkZyYW1lUmF0ZUxvZ2dlciwgJ1RyeWluZyB0byBkZWJ1ZyBGcmFtZVJhdGVMb2dnZXIgd2l0aG91dCB0aGUgbmF0aXZlIG1vZHVsZSEnKTsKICAgICAgfQoKICAgICAgTmF0aXZlTW9kdWxlcy5GcmFtZVJhdGVMb2dnZXIgJiYgTmF0aXZlTW9kdWxlcy5GcmFtZVJhdGVMb2dnZXIuc2V0R2xvYmFsT3B0aW9ucyhvcHRpb25zKTsKICAgIH0sCiAgICBzZXRDb250ZXh0OiBmdW5jdGlvbiBzZXRDb250ZXh0KGNvbnRleHQpIHsKICAgICAgTmF0aXZlTW9kdWxlcy5GcmFtZVJhdGVMb2dnZXIgJiYgTmF0aXZlTW9kdWxlcy5GcmFtZVJhdGVMb2dnZXIuc2V0Q29udGV4dChjb250ZXh0KTsKICAgIH0sCiAgICBiZWdpblNjcm9sbDogZnVuY3Rpb24gYmVnaW5TY3JvbGwoKSB7CiAgICAgIE5hdGl2ZU1vZHVsZXMuRnJhbWVSYXRlTG9nZ2VyICYmIE5hdGl2ZU1vZHVsZXMuRnJhbWVSYXRlTG9nZ2VyLmJlZ2luU2Nyb2xsKCk7CiAgICB9LAogICAgZW5kU2Nyb2xsOiBmdW5jdGlvbiBlbmRTY3JvbGwoKSB7CiAgICAgIE5hdGl2ZU1vZHVsZXMuRnJhbWVSYXRlTG9nZ2VyICYmIE5hdGl2ZU1vZHVsZXMuRnJhbWVSYXRlTG9nZ2VyLmVuZFNjcm9sbCgpOwogICAgfQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBGcmFtZVJhdGVMb2dnZXI7Cn0sMjI3LFsxNSwxM10sIkZyYW1lUmF0ZUxvZ2dlciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIE5hdGl2ZUV2ZW50RW1pdHRlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJOYXRpdmVFdmVudEVtaXR0ZXIiKTsKCiAgdmFyIEtleWJvYXJkT2JzZXJ2ZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiTmF0aXZlTW9kdWxlcyIpLktleWJvYXJkT2JzZXJ2ZXI7CgogIHZhciBkaXNtaXNzS2V5Ym9hcmQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiZGlzbWlzc0tleWJvYXJkIik7CgogIHZhciBLZXlib2FyZEV2ZW50RW1pdHRlciA9IG5ldyBOYXRpdmVFdmVudEVtaXR0ZXIoS2V5Ym9hcmRPYnNlcnZlcik7CiAgdmFyIEtleWJvYXJkID0gewogICAgYWRkTGlzdGVuZXI6IGZ1bmN0aW9uIGFkZExpc3RlbmVyKGV2ZW50TmFtZSwgY2FsbGJhY2spIHsKICAgICAgaW52YXJpYW50KGZhbHNlLCAnRHVtbXkgbWV0aG9kIHVzZWQgZm9yIGRvY3VtZW50YXRpb24nKTsKICAgIH0sCiAgICByZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIoZXZlbnROYW1lLCBjYWxsYmFjaykgewogICAgICBpbnZhcmlhbnQoZmFsc2UsICdEdW1teSBtZXRob2QgdXNlZCBmb3IgZG9jdW1lbnRhdGlvbicpOwogICAgfSwKICAgIHJlbW92ZUFsbExpc3RlbmVyczogZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50TmFtZSkgewogICAgICBpbnZhcmlhbnQoZmFsc2UsICdEdW1teSBtZXRob2QgdXNlZCBmb3IgZG9jdW1lbnRhdGlvbicpOwogICAgfSwKICAgIGRpc21pc3M6IGZ1bmN0aW9uIGRpc21pc3MoKSB7CiAgICAgIGludmFyaWFudChmYWxzZSwgJ0R1bW15IG1ldGhvZCB1c2VkIGZvciBkb2N1bWVudGF0aW9uJyk7CiAgICB9CiAgfTsKICBLZXlib2FyZCA9IEtleWJvYXJkRXZlbnRFbWl0dGVyOwogIEtleWJvYXJkLmRpc21pc3MgPSBkaXNtaXNzS2V5Ym9hcmQ7CiAgbW9kdWxlLmV4cG9ydHMgPSBLZXlib2FyZDsKfSwyMjgsWzEzLDY5LDE1LDIyOV0sIktleWJvYXJkIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgVGV4dElucHV0U3RhdGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiVGV4dElucHV0U3RhdGUiKTsKCiAgZnVuY3Rpb24gZGlzbWlzc0tleWJvYXJkKCkgewogICAgVGV4dElucHV0U3RhdGUuYmx1clRleHRJbnB1dChUZXh0SW5wdXRTdGF0ZS5jdXJyZW50bHlGb2N1c2VkRmllbGQoKSk7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGRpc21pc3NLZXlib2FyZDsKfSwyMjksWzExNV0sImRpc21pc3NLZXlib2FyZCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFN1YnNjcmliYWJsZSA9IHt9OwogIFN1YnNjcmliYWJsZS5NaXhpbiA9IHsKICAgIGNvbXBvbmVudFdpbGxNb3VudDogZnVuY3Rpb24gY29tcG9uZW50V2lsbE1vdW50KCkgewogICAgICB0aGlzLl9zdWJzY3JpYmFibGVTdWJzY3JpcHRpb25zID0gW107CiAgICB9LAogICAgY29tcG9uZW50V2lsbFVubW91bnQ6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICB0aGlzLl9zdWJzY3JpYmFibGVTdWJzY3JpcHRpb25zLmZvckVhY2goZnVuY3Rpb24gKHN1YnNjcmlwdGlvbikgewogICAgICAgIHJldHVybiBzdWJzY3JpcHRpb24ucmVtb3ZlKCk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5fc3Vic2NyaWJhYmxlU3Vic2NyaXB0aW9ucyA9IG51bGw7CiAgICB9LAogICAgYWRkTGlzdGVuZXJPbjogZnVuY3Rpb24gYWRkTGlzdGVuZXJPbihldmVudEVtaXR0ZXIsIGV2ZW50VHlwZSwgbGlzdGVuZXIsIGNvbnRleHQpIHsKICAgICAgdGhpcy5fc3Vic2NyaWJhYmxlU3Vic2NyaXB0aW9ucy5wdXNoKGV2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCBjb250ZXh0KSk7CiAgICB9CiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IFN1YnNjcmliYWJsZTsKfSwyMzAsW10sIlN1YnNjcmliYWJsZSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIG51bGx0aHJvd3MgPSBmdW5jdGlvbiBudWxsdGhyb3dzKHgpIHsKICAgIGlmICh4ICE9IG51bGwpIHsKICAgICAgcmV0dXJuIHg7CiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCJHb3QgdW5leHBlY3RlZCBudWxsIG9yIHVuZGVmaW5lZCIpOwogIH07CgogIG1vZHVsZS5leHBvcnRzID0gbnVsbHRocm93czsKfSwyMzEsW10sImZianMvbGliL251bGx0aHJvd3MuanMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfcmVxdWlyZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJSZWFjdE5hdGl2ZSIpLAogICAgICBfX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IF9yZXF1aXJlLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwoKICBtb2R1bGUuZXhwb3J0cyA9IF9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVELlJlYWN0TmF0aXZlQ29tcG9uZW50VHJlZTsKfSwyMzIsWzIxXSwiUmVhY3ROYXRpdmVDb21wb25lbnRUcmVlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29tcG9uZW50cy9TY3JvbGxWaWV3L1Njcm9sbFZpZXdTdGlja3lIZWFkZXIuanMiOwoKICB2YXIgQW5pbWF0ZWQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQW5pbWF0ZWQiKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlJlYWN0Iik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFNjcm9sbFZpZXdTdGlja3lIZWFkZXIgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKFNjcm9sbFZpZXdTdGlja3lIZWFkZXIsIF9SZWFjdCRDb21wb25lbnQpOwoKICAgIGZ1bmN0aW9uIFNjcm9sbFZpZXdTdGlja3lIZWFkZXIocHJvcHMsIGNvbnRleHQpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFNjcm9sbFZpZXdTdGlja3lIZWFkZXIpOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKFNjcm9sbFZpZXdTdGlja3lIZWFkZXIuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihTY3JvbGxWaWV3U3RpY2t5SGVhZGVyKSkuY2FsbCh0aGlzLCBwcm9wcywgY29udGV4dCkpOwoKICAgICAgX3RoaXMuX29uTGF5b3V0ID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgX3RoaXMuc2V0U3RhdGUoewogICAgICAgICAgbWVhc3VyZWQ6IHRydWUsCiAgICAgICAgICBsYXlvdXRZOiBldmVudC5uYXRpdmVFdmVudC5sYXlvdXQueSwKICAgICAgICAgIGxheW91dEhlaWdodDogZXZlbnQubmF0aXZlRXZlbnQubGF5b3V0LmhlaWdodAogICAgICAgIH0pOwoKICAgICAgICBfdGhpcy5wcm9wcy5vbkxheW91dChldmVudCk7CgogICAgICAgIHZhciBjaGlsZCA9IFJlYWN0LkNoaWxkcmVuLm9ubHkoX3RoaXMucHJvcHMuY2hpbGRyZW4pOwoKICAgICAgICBpZiAoY2hpbGQucHJvcHMub25MYXlvdXQpIHsKICAgICAgICAgIGNoaWxkLnByb3BzLm9uTGF5b3V0KGV2ZW50KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBfdGhpcy5zdGF0ZSA9IHsKICAgICAgICBtZWFzdXJlZDogZmFsc2UsCiAgICAgICAgbGF5b3V0WTogMCwKICAgICAgICBsYXlvdXRIZWlnaHQ6IDAsCiAgICAgICAgbmV4dEhlYWRlckxheW91dFk6IHByb3BzLm5leHRIZWFkZXJMYXlvdXRZCiAgICAgIH07CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoU2Nyb2xsVmlld1N0aWNreUhlYWRlciwgW3sKICAgICAga2V5OiAic2V0TmV4dEhlYWRlclkiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0TmV4dEhlYWRlclkoeSkgewogICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgbmV4dEhlYWRlckxheW91dFk6IHkKICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBfc3RhdGUgPSB0aGlzLnN0YXRlLAogICAgICAgICAgICBtZWFzdXJlZCA9IF9zdGF0ZS5tZWFzdXJlZCwKICAgICAgICAgICAgbGF5b3V0SGVpZ2h0ID0gX3N0YXRlLmxheW91dEhlaWdodCwKICAgICAgICAgICAgbGF5b3V0WSA9IF9zdGF0ZS5sYXlvdXRZLAogICAgICAgICAgICBuZXh0SGVhZGVyTGF5b3V0WSA9IF9zdGF0ZS5uZXh0SGVhZGVyTGF5b3V0WTsKICAgICAgICB2YXIgaW5wdXRSYW5nZSA9IFstMSwgMF07CiAgICAgICAgdmFyIG91dHB1dFJhbmdlID0gWzAsIDBdOwoKICAgICAgICBpZiAobWVhc3VyZWQpIHsKICAgICAgICAgIGlucHV0UmFuZ2UucHVzaChsYXlvdXRZKTsKICAgICAgICAgIG91dHB1dFJhbmdlLnB1c2goMCk7CiAgICAgICAgICB2YXIgY29sbGlzaW9uUG9pbnQgPSAobmV4dEhlYWRlckxheW91dFkgfHwgMCkgLSBsYXlvdXRIZWlnaHQ7CgogICAgICAgICAgaWYgKGNvbGxpc2lvblBvaW50ID49IGxheW91dFkpIHsKICAgICAgICAgICAgaW5wdXRSYW5nZS5wdXNoKGNvbGxpc2lvblBvaW50LCBjb2xsaXNpb25Qb2ludCArIDEpOwogICAgICAgICAgICBvdXRwdXRSYW5nZS5wdXNoKGNvbGxpc2lvblBvaW50IC0gbGF5b3V0WSwgY29sbGlzaW9uUG9pbnQgLSBsYXlvdXRZKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlucHV0UmFuZ2UucHVzaChsYXlvdXRZICsgMSk7CiAgICAgICAgICAgIG91dHB1dFJhbmdlLnB1c2goMSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgdHJhbnNsYXRlWSA9IHRoaXMucHJvcHMuc2Nyb2xsQW5pbWF0ZWRWYWx1ZS5pbnRlcnBvbGF0ZSh7CiAgICAgICAgICBpbnB1dFJhbmdlOiBpbnB1dFJhbmdlLAogICAgICAgICAgb3V0cHV0UmFuZ2U6IG91dHB1dFJhbmdlCiAgICAgICAgfSk7CiAgICAgICAgdmFyIGNoaWxkID0gUmVhY3QuQ2hpbGRyZW4ub25seSh0aGlzLnByb3BzLmNoaWxkcmVuKTsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgIEFuaW1hdGVkLlZpZXcsCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbGxhcHNhYmxlOiBmYWxzZSwKICAgICAgICAgICAgb25MYXlvdXQ6IHRoaXMuX29uTGF5b3V0LAogICAgICAgICAgICBzdHlsZTogW2NoaWxkLnByb3BzLnN0eWxlLCBzdHlsZXMuaGVhZGVyLCB7CiAgICAgICAgICAgICAgdHJhbnNmb3JtOiBbewogICAgICAgICAgICAgICAgdHJhbnNsYXRlWTogdHJhbnNsYXRlWQogICAgICAgICAgICAgIH1dCiAgICAgICAgICAgIH1dLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogOTYKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIFJlYWN0LmNsb25lRWxlbWVudChjaGlsZCwgewogICAgICAgICAgICBzdHlsZTogc3R5bGVzLmZpbGwsCiAgICAgICAgICAgIG9uTGF5b3V0OiB1bmRlZmluZWQKICAgICAgICAgIH0pCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFNjcm9sbFZpZXdTdGlja3lIZWFkZXI7CiAgfShSZWFjdC5Db21wb25lbnQpOwoKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgaGVhZGVyOiB7CiAgICAgIHpJbmRleDogMTAKICAgIH0sCiAgICBmaWxsOiB7CiAgICAgIGZsZXg6IDEKICAgIH0KICB9KTsKICBtb2R1bGUuZXhwb3J0cyA9IFNjcm9sbFZpZXdTdGlja3lIZWFkZXI7Cn0sMjMzLFsxOTQsMTMwLDE2OF0sIlNjcm9sbFZpZXdTdGlja3lIZWFkZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIGZ1bmN0aW9uIHByb2Nlc3NEZWNlbGVyYXRpb25SYXRlKGRlY2VsZXJhdGlvblJhdGUpIHsKICAgIGlmIChkZWNlbGVyYXRpb25SYXRlID09PSAnbm9ybWFsJykgewogICAgICBkZWNlbGVyYXRpb25SYXRlID0gMC45OTg7CiAgICB9IGVsc2UgaWYgKGRlY2VsZXJhdGlvblJhdGUgPT09ICdmYXN0JykgewogICAgICBkZWNlbGVyYXRpb25SYXRlID0gMC45OTsKICAgIH0KCiAgICByZXR1cm4gZGVjZWxlcmF0aW9uUmF0ZTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gcHJvY2Vzc0RlY2VsZXJhdGlvblJhdGU7Cn0sMjM0LFtdLCJwcm9jZXNzRGVjZWxlcmF0aW9uUmF0ZSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvbXBvbmVudHMvQ2hlY2tCb3gvQ2hlY2tCb3guYW5kcm9pZC5qcyI7CgogIHZhciBOYXRpdmVNZXRob2RzTWl4aW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTmF0aXZlTWV0aG9kc01peGluIik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUmVhY3QiKTsKCiAgdmFyIFN0eWxlU2hlZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiU3R5bGVTaGVldCIpOwoKICB2YXIgVmlld1Byb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJWaWV3UHJvcFR5cGVzIik7CgogIHZhciBjcmVhdGVSZWFjdENsYXNzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgImNyZWF0ZS1yZWFjdC1jbGFzcyIpOwoKICB2YXIgcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJyZXF1aXJlTmF0aXZlQ29tcG9uZW50Iik7CgogIHZhciBDaGVja0JveCA9IGNyZWF0ZVJlYWN0Q2xhc3MoewogICAgZGlzcGxheU5hbWU6ICdDaGVja0JveCcsCiAgICBwcm9wVHlwZXM6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBWaWV3UHJvcFR5cGVzLCB7CiAgICAgIHZhbHVlOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgZGlzYWJsZWQ6IFByb3BUeXBlcy5ib29sLAogICAgICBvbkNoYW5nZTogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uVmFsdWVDaGFuZ2U6IFByb3BUeXBlcy5mdW5jLAogICAgICB0ZXN0SUQ6IFByb3BUeXBlcy5zdHJpbmcKICAgIH0pLAogICAgZ2V0RGVmYXVsdFByb3BzOiBmdW5jdGlvbiBnZXREZWZhdWx0UHJvcHMoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IGZhbHNlLAogICAgICAgIGRpc2FibGVkOiBmYWxzZQogICAgICB9OwogICAgfSwKICAgIG1peGluczogW05hdGl2ZU1ldGhvZHNNaXhpbl0sCiAgICBfcmN0Q2hlY2tCb3g6IHt9LAogICAgX29uQ2hhbmdlOiBmdW5jdGlvbiBfb25DaGFuZ2UoZXZlbnQpIHsKICAgICAgdGhpcy5fcmN0Q2hlY2tCb3guc2V0TmF0aXZlUHJvcHMoewogICAgICAgIHZhbHVlOiB0aGlzLnByb3BzLnZhbHVlCiAgICAgIH0pOwoKICAgICAgdGhpcy5wcm9wcy5vbkNoYW5nZSAmJiB0aGlzLnByb3BzLm9uQ2hhbmdlKGV2ZW50KTsKICAgICAgdGhpcy5wcm9wcy5vblZhbHVlQ2hhbmdlICYmIHRoaXMucHJvcHMub25WYWx1ZUNoYW5nZShldmVudC5uYXRpdmVFdmVudC52YWx1ZSk7CiAgICB9LAogICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgcHJvcHMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcyk7CgogICAgICBwcm9wcy5vblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9OwoKICAgICAgcHJvcHMub25SZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9OwoKICAgICAgcHJvcHMuZW5hYmxlZCA9ICF0aGlzLnByb3BzLmRpc2FibGVkOwogICAgICBwcm9wcy5vbiA9IHRoaXMucHJvcHMudmFsdWU7CiAgICAgIHByb3BzLnN0eWxlID0gW3N0eWxlcy5yY3RDaGVja0JveCwgdGhpcy5wcm9wcy5zdHlsZV07CiAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFJDVENoZWNrQm94LCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgcHJvcHMsIHsKICAgICAgICByZWY6IGZ1bmN0aW9uIHJlZihfcmVmKSB7CiAgICAgICAgICBfdGhpcy5fcmN0Q2hlY2tCb3ggPSBfcmVmOwogICAgICAgIH0sCiAgICAgICAgb25DaGFuZ2U6IHRoaXMuX29uQ2hhbmdlLAogICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgbGluZU51bWJlcjogMTQwCiAgICAgICAgfQogICAgICB9KSk7CiAgICB9CiAgfSk7CiAgdmFyIHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHsKICAgIHJjdENoZWNrQm94OiB7CiAgICAgIGhlaWdodDogMzIsCiAgICAgIHdpZHRoOiAzMgogICAgfQogIH0pOwogIHZhciBSQ1RDaGVja0JveCA9IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoJ0FuZHJvaWRDaGVja0JveCcsIENoZWNrQm94LCB7CiAgICBuYXRpdmVPbmx5OiB7CiAgICAgIG9uQ2hhbmdlOiB0cnVlLAogICAgICBvbjogdHJ1ZSwKICAgICAgZW5hYmxlZDogdHJ1ZQogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gQ2hlY2tCb3g7Cn0sMjM1LFsxMjUsMTI3LDEzMCwxNjgsMTMxLDE3MiwxNDVdLCJDaGVja0JveCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvbXBvbmVudHMvRGF0ZVBpY2tlci9EYXRlUGlja2VySU9TLmFuZHJvaWQuanMiOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiUmVhY3QiKTsKCiAgdmFyIFN0eWxlU2hlZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiU3R5bGVTaGVldCIpOwoKICB2YXIgVGV4dCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJUZXh0Iik7CgogIHZhciBWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlZpZXciKTsKCiAgdmFyIER1bW15RGF0ZVBpY2tlcklPUyA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoRHVtbXlEYXRlUGlja2VySU9TLCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBEdW1teURhdGVQaWNrZXJJT1MoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBEdW1teURhdGVQaWNrZXJJT1MpOwogICAgICByZXR1cm4gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKER1bW15RGF0ZVBpY2tlcklPUy5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKER1bW15RGF0ZVBpY2tlcklPUykpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhEdW1teURhdGVQaWNrZXJJT1MsIFt7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBWaWV3LAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogW3N0eWxlcy5kdW1teURhdGVQaWNrZXJJT1MsIHRoaXMucHJvcHMuc3R5bGVdLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMjIKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmRhdGVQaWNrZXJUZXh0LAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjMKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJEYXRlUGlja2VySU9TIGlzIG5vdCBzdXBwb3J0ZWQgb24gdGhpcyBwbGF0Zm9ybSEiCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIER1bW15RGF0ZVBpY2tlcklPUzsKICB9KFJlYWN0LkNvbXBvbmVudCk7CgogIHZhciBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7CiAgICBkdW1teURhdGVQaWNrZXJJT1M6IHsKICAgICAgaGVpZ2h0OiAxMDAsCiAgICAgIHdpZHRoOiAzMDAsCiAgICAgIGJhY2tncm91bmRDb2xvcjogJyNmZmJjYmMnLAogICAgICBib3JkZXJXaWR0aDogMSwKICAgICAgYm9yZGVyQ29sb3I6ICdyZWQnLAogICAgICBhbGlnbkl0ZW1zOiAnY2VudGVyJywKICAgICAganVzdGlmeUNvbnRlbnQ6ICdjZW50ZXInLAogICAgICBtYXJnaW46IDEwCiAgICB9LAogICAgZGF0ZVBpY2tlclRleHQ6IHsKICAgICAgY29sb3I6ICcjMzMzMzMzJywKICAgICAgbWFyZ2luOiAyMAogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gRHVtbXlEYXRlUGlja2VySU9TOwp9LDIzNixbMTMwLDE2OCwxODEsMTcwXSwiRGF0ZVBpY2tlcklPUyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvbXBvbmVudHMvRHJhd2VyQW5kcm9pZC9EcmF3ZXJMYXlvdXRBbmRyb2lkLmFuZHJvaWQuanMiOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBOYXRpdmVNZXRob2RzTWl4aW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiTmF0aXZlTWV0aG9kc01peGluIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJQbGF0Zm9ybSIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUmVhY3QiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJwcm9wLXR5cGVzIik7CgogIHZhciBSZWFjdE5hdGl2ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJSZWFjdE5hdGl2ZSIpOwoKICB2YXIgU3RhdHVzQmFyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgIlN0YXR1c0JhciIpOwoKICB2YXIgU3R5bGVTaGVldCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJTdHlsZVNoZWV0Iik7CgogIHZhciBVSU1hbmFnZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAiVUlNYW5hZ2VyIik7CgogIHZhciBWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs5XSwgIlZpZXciKTsKCiAgdmFyIFZpZXdQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEwXSwgIlZpZXdQcm9wVHlwZXMiKTsKCiAgdmFyIERyYXdlckNvbnN0cyA9IFVJTWFuYWdlci5BbmRyb2lkRHJhd2VyTGF5b3V0LkNvbnN0YW50czsKCiAgdmFyIGNyZWF0ZVJlYWN0Q2xhc3MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzExXSwgImNyZWF0ZS1yZWFjdC1jbGFzcyIpOwoKICB2YXIgZGlzbWlzc0tleWJvYXJkID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMl0sICJkaXNtaXNzS2V5Ym9hcmQiKTsKCiAgdmFyIHJlcXVpcmVOYXRpdmVDb21wb25lbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEzXSwgInJlcXVpcmVOYXRpdmVDb21wb25lbnQiKTsKCiAgdmFyIFJLX0RSQVdFUl9SRUYgPSAnZHJhd2VybGF5b3V0JzsKICB2YXIgSU5ORVJWSUVXX1JFRiA9ICdpbm5lclZpZXcnOwogIHZhciBEUkFXRVJfU1RBVEVTID0gWydJZGxlJywgJ0RyYWdnaW5nJywgJ1NldHRsaW5nJ107CiAgdmFyIERyYXdlckxheW91dEFuZHJvaWQgPSBjcmVhdGVSZWFjdENsYXNzKHsKICAgIGRpc3BsYXlOYW1lOiAnRHJhd2VyTGF5b3V0QW5kcm9pZCcsCiAgICBzdGF0aWNzOiB7CiAgICAgIHBvc2l0aW9uczogRHJhd2VyQ29uc3RzLkRyYXdlclBvc2l0aW9uCiAgICB9LAogICAgcHJvcFR5cGVzOiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgVmlld1Byb3BUeXBlcywgewogICAgICBrZXlib2FyZERpc21pc3NNb2RlOiBQcm9wVHlwZXMub25lT2YoWydub25lJywgJ29uLWRyYWcnXSksCiAgICAgIGRyYXdlckJhY2tncm91bmRDb2xvcjogQ29sb3JQcm9wVHlwZSwKICAgICAgZHJhd2VyUG9zaXRpb246IFByb3BUeXBlcy5vbmVPZihbRHJhd2VyQ29uc3RzLkRyYXdlclBvc2l0aW9uLkxlZnQsIERyYXdlckNvbnN0cy5EcmF3ZXJQb3NpdGlvbi5SaWdodF0pLAogICAgICBkcmF3ZXJXaWR0aDogUHJvcFR5cGVzLm51bWJlciwKICAgICAgZHJhd2VyTG9ja01vZGU6IFByb3BUeXBlcy5vbmVPZihbJ3VubG9ja2VkJywgJ2xvY2tlZC1jbG9zZWQnLCAnbG9ja2VkLW9wZW4nXSksCiAgICAgIG9uRHJhd2VyU2xpZGU6IFByb3BUeXBlcy5mdW5jLAogICAgICBvbkRyYXdlclN0YXRlQ2hhbmdlZDogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uRHJhd2VyT3BlbjogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uRHJhd2VyQ2xvc2U6IFByb3BUeXBlcy5mdW5jLAogICAgICByZW5kZXJOYXZpZ2F0aW9uVmlldzogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCwKICAgICAgc3RhdHVzQmFyQmFja2dyb3VuZENvbG9yOiBDb2xvclByb3BUeXBlCiAgICB9KSwKICAgIG1peGluczogW05hdGl2ZU1ldGhvZHNNaXhpbl0sCiAgICBnZXREZWZhdWx0UHJvcHM6IGZ1bmN0aW9uIGdldERlZmF1bHRQcm9wcygpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBkcmF3ZXJCYWNrZ3JvdW5kQ29sb3I6ICd3aGl0ZScKICAgICAgfTsKICAgIH0sCiAgICBnZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uIGdldEluaXRpYWxTdGF0ZSgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBzdGF0dXNCYXJCYWNrZ3JvdW5kQ29sb3I6IHVuZGVmaW5lZAogICAgICB9OwogICAgfSwKICAgIGdldElubmVyVmlld05vZGU6IGZ1bmN0aW9uIGdldElubmVyVmlld05vZGUoKSB7CiAgICAgIHJldHVybiB0aGlzLnJlZnNbSU5ORVJWSUVXX1JFRl0uZ2V0SW5uZXJWaWV3Tm9kZSgpOwogICAgfSwKICAgIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICB2YXIgZHJhd1N0YXR1c0JhciA9IFBsYXRmb3JtLlZlcnNpb24gPj0gMjEgJiYgdGhpcy5wcm9wcy5zdGF0dXNCYXJCYWNrZ3JvdW5kQ29sb3I7CiAgICAgIHZhciBkcmF3ZXJWaWV3V3JhcHBlciA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgVmlldywKICAgICAgICB7CiAgICAgICAgICBzdHlsZTogW3N0eWxlcy5kcmF3ZXJTdWJ2aWV3LCB7CiAgICAgICAgICAgIHdpZHRoOiB0aGlzLnByb3BzLmRyYXdlcldpZHRoLAogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IHRoaXMucHJvcHMuZHJhd2VyQmFja2dyb3VuZENvbG9yCiAgICAgICAgICB9XSwKICAgICAgICAgIGNvbGxhcHNhYmxlOiBmYWxzZSwKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDE3NgogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdGhpcy5wcm9wcy5yZW5kZXJOYXZpZ2F0aW9uVmlldygpLAogICAgICAgIGRyYXdTdGF0dXNCYXIgJiYgUmVhY3QuY3JlYXRlRWxlbWVudChWaWV3LCB7CiAgICAgICAgICBzdHlsZTogc3R5bGVzLmRyYXdlclN0YXR1c0JhciwKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDE4MwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICk7CiAgICAgIHZhciBjaGlsZHJlbldyYXBwZXIgPSBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgIFZpZXcsCiAgICAgICAgewogICAgICAgICAgcmVmOiBJTk5FUlZJRVdfUkVGLAogICAgICAgICAgc3R5bGU6IHN0eWxlcy5tYWluU3VidmlldywKICAgICAgICAgIGNvbGxhcHNhYmxlOiBmYWxzZSwKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDE4NgogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZHJhd1N0YXR1c0JhciAmJiBSZWFjdC5jcmVhdGVFbGVtZW50KFN0YXR1c0JhciwgewogICAgICAgICAgdHJhbnNsdWNlbnQ6IHRydWUsCiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IHRoaXMucHJvcHMuc3RhdHVzQmFyQmFja2dyb3VuZENvbG9yLAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogMTg4CiAgICAgICAgICB9CiAgICAgICAgfSksCiAgICAgICAgZHJhd1N0YXR1c0JhciAmJiBSZWFjdC5jcmVhdGVFbGVtZW50KFZpZXcsIHsKICAgICAgICAgIHN0eWxlOiBbc3R5bGVzLnN0YXR1c0JhciwgewogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IHRoaXMucHJvcHMuc3RhdHVzQmFyQmFja2dyb3VuZENvbG9yCiAgICAgICAgICB9XSwKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDE5MwogICAgICAgICAgfQogICAgICAgIH0pLAogICAgICAgIHRoaXMucHJvcHMuY2hpbGRyZW4KICAgICAgKTsKICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgQW5kcm9pZERyYXdlckxheW91dCwKICAgICAgICBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcywgewogICAgICAgICAgcmVmOiBSS19EUkFXRVJfUkVGLAogICAgICAgICAgZHJhd2VyV2lkdGg6IHRoaXMucHJvcHMuZHJhd2VyV2lkdGgsCiAgICAgICAgICBkcmF3ZXJQb3NpdGlvbjogdGhpcy5wcm9wcy5kcmF3ZXJQb3NpdGlvbiwKICAgICAgICAgIGRyYXdlckxvY2tNb2RlOiB0aGlzLnByb3BzLmRyYXdlckxvY2tNb2RlLAogICAgICAgICAgc3R5bGU6IFtzdHlsZXMuYmFzZSwgdGhpcy5wcm9wcy5zdHlsZV0sCiAgICAgICAgICBvbkRyYXdlclNsaWRlOiB0aGlzLl9vbkRyYXdlclNsaWRlLAogICAgICAgICAgb25EcmF3ZXJPcGVuOiB0aGlzLl9vbkRyYXdlck9wZW4sCiAgICAgICAgICBvbkRyYXdlckNsb3NlOiB0aGlzLl9vbkRyYXdlckNsb3NlLAogICAgICAgICAgb25EcmF3ZXJTdGF0ZUNoYW5nZWQ6IHRoaXMuX29uRHJhd2VyU3RhdGVDaGFuZ2VkLAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogMjAwCiAgICAgICAgICB9CiAgICAgICAgfSksCiAgICAgICAgY2hpbGRyZW5XcmFwcGVyLAogICAgICAgIGRyYXdlclZpZXdXcmFwcGVyCiAgICAgICk7CiAgICB9LAogICAgX29uRHJhd2VyU2xpZGU6IGZ1bmN0aW9uIF9vbkRyYXdlclNsaWRlKGV2ZW50KSB7CiAgICAgIGlmICh0aGlzLnByb3BzLm9uRHJhd2VyU2xpZGUpIHsKICAgICAgICB0aGlzLnByb3BzLm9uRHJhd2VyU2xpZGUoZXZlbnQpOwogICAgICB9CgogICAgICBpZiAodGhpcy5wcm9wcy5rZXlib2FyZERpc21pc3NNb2RlID09PSAnb24tZHJhZycpIHsKICAgICAgICBkaXNtaXNzS2V5Ym9hcmQoKTsKICAgICAgfQogICAgfSwKICAgIF9vbkRyYXdlck9wZW46IGZ1bmN0aW9uIF9vbkRyYXdlck9wZW4oKSB7CiAgICAgIGlmICh0aGlzLnByb3BzLm9uRHJhd2VyT3BlbikgewogICAgICAgIHRoaXMucHJvcHMub25EcmF3ZXJPcGVuKCk7CiAgICAgIH0KICAgIH0sCiAgICBfb25EcmF3ZXJDbG9zZTogZnVuY3Rpb24gX29uRHJhd2VyQ2xvc2UoKSB7CiAgICAgIGlmICh0aGlzLnByb3BzLm9uRHJhd2VyQ2xvc2UpIHsKICAgICAgICB0aGlzLnByb3BzLm9uRHJhd2VyQ2xvc2UoKTsKICAgICAgfQogICAgfSwKICAgIF9vbkRyYXdlclN0YXRlQ2hhbmdlZDogZnVuY3Rpb24gX29uRHJhd2VyU3RhdGVDaGFuZ2VkKGV2ZW50KSB7CiAgICAgIGlmICh0aGlzLnByb3BzLm9uRHJhd2VyU3RhdGVDaGFuZ2VkKSB7CiAgICAgICAgdGhpcy5wcm9wcy5vbkRyYXdlclN0YXRlQ2hhbmdlZChEUkFXRVJfU1RBVEVTW2V2ZW50Lm5hdGl2ZUV2ZW50LmRyYXdlclN0YXRlXSk7CiAgICAgIH0KICAgIH0sCiAgICBvcGVuRHJhd2VyOiBmdW5jdGlvbiBvcGVuRHJhd2VyKCkgewogICAgICBVSU1hbmFnZXIuZGlzcGF0Y2hWaWV3TWFuYWdlckNvbW1hbmQodGhpcy5fZ2V0RHJhd2VyTGF5b3V0SGFuZGxlKCksIFVJTWFuYWdlci5BbmRyb2lkRHJhd2VyTGF5b3V0LkNvbW1hbmRzLm9wZW5EcmF3ZXIsIG51bGwpOwogICAgfSwKICAgIGNsb3NlRHJhd2VyOiBmdW5jdGlvbiBjbG9zZURyYXdlcigpIHsKICAgICAgVUlNYW5hZ2VyLmRpc3BhdGNoVmlld01hbmFnZXJDb21tYW5kKHRoaXMuX2dldERyYXdlckxheW91dEhhbmRsZSgpLCBVSU1hbmFnZXIuQW5kcm9pZERyYXdlckxheW91dC5Db21tYW5kcy5jbG9zZURyYXdlciwgbnVsbCk7CiAgICB9LAogICAgX2dldERyYXdlckxheW91dEhhbmRsZTogZnVuY3Rpb24gX2dldERyYXdlckxheW91dEhhbmRsZSgpIHsKICAgICAgcmV0dXJuIFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKHRoaXMucmVmc1tSS19EUkFXRVJfUkVGXSk7CiAgICB9CiAgfSk7CiAgdmFyIHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHsKICAgIGJhc2U6IHsKICAgICAgZmxleDogMSwKICAgICAgZWxldmF0aW9uOiAxNgogICAgfSwKICAgIG1haW5TdWJ2aWV3OiB7CiAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICB0b3A6IDAsCiAgICAgIGxlZnQ6IDAsCiAgICAgIHJpZ2h0OiAwLAogICAgICBib3R0b206IDAKICAgIH0sCiAgICBkcmF3ZXJTdWJ2aWV3OiB7CiAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICB0b3A6IDAsCiAgICAgIGJvdHRvbTogMAogICAgfSwKICAgIHN0YXR1c0JhcjogewogICAgICBoZWlnaHQ6IFN0YXR1c0Jhci5jdXJyZW50SGVpZ2h0CiAgICB9LAogICAgZHJhd2VyU3RhdHVzQmFyOiB7CiAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICB0b3A6IDAsCiAgICAgIGxlZnQ6IDAsCiAgICAgIHJpZ2h0OiAwLAogICAgICBoZWlnaHQ6IFN0YXR1c0Jhci5jdXJyZW50SGVpZ2h0LAogICAgICBiYWNrZ3JvdW5kQ29sb3I6ICdyZ2JhKDAsIDAsIDAsIDAuMjUxKScKICAgIH0KICB9KTsKICB2YXIgQW5kcm9pZERyYXdlckxheW91dCA9IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoJ0FuZHJvaWREcmF3ZXJMYXlvdXQnLCBEcmF3ZXJMYXlvdXRBbmRyb2lkKTsKICBtb2R1bGUuZXhwb3J0cyA9IERyYXdlckxheW91dEFuZHJvaWQ7Cn0sMjM3LFsxMjMsMTI1LDUyLDEzMCwxMjcsMjEsMjM4LDE2OCwxMDcsMTcwLDEzMSwxNzIsMjI5LDE0NV0sIkRyYXdlckxheW91dEFuZHJvaWQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfY2xhc3MsIF90ZW1wMjsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0Iik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJQbGF0Zm9ybSIpOwoKICB2YXIgcHJvY2Vzc0NvbG9yID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgInByb2Nlc3NDb2xvciIpOwoKICB2YXIgU3RhdHVzQmFyTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJOYXRpdmVNb2R1bGVzIikuU3RhdHVzQmFyTWFuYWdlcjsKCiAgZnVuY3Rpb24gbWVyZ2VQcm9wc1N0YWNrKHByb3BzU3RhY2ssIGRlZmF1bHRWYWx1ZXMpIHsKICAgIHJldHVybiBwcm9wc1N0YWNrLnJlZHVjZShmdW5jdGlvbiAocHJldiwgY3VyKSB7CiAgICAgIGZvciAodmFyIHByb3AgaW4gY3VyKSB7CiAgICAgICAgaWYgKGN1cltwcm9wXSAhPSBudWxsKSB7CiAgICAgICAgICBwcmV2W3Byb3BdID0gY3VyW3Byb3BdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHByZXY7CiAgICB9LCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgZGVmYXVsdFZhbHVlcykpOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlU3RhY2tFbnRyeShwcm9wcykgewogICAgcmV0dXJuIHsKICAgICAgYmFja2dyb3VuZENvbG9yOiBwcm9wcy5iYWNrZ3JvdW5kQ29sb3IgIT0gbnVsbCA/IHsKICAgICAgICB2YWx1ZTogcHJvcHMuYmFja2dyb3VuZENvbG9yLAogICAgICAgIGFuaW1hdGVkOiBwcm9wcy5hbmltYXRlZAogICAgICB9IDogbnVsbCwKICAgICAgYmFyU3R5bGU6IHByb3BzLmJhclN0eWxlICE9IG51bGwgPyB7CiAgICAgICAgdmFsdWU6IHByb3BzLmJhclN0eWxlLAogICAgICAgIGFuaW1hdGVkOiBwcm9wcy5hbmltYXRlZAogICAgICB9IDogbnVsbCwKICAgICAgdHJhbnNsdWNlbnQ6IHByb3BzLnRyYW5zbHVjZW50LAogICAgICBoaWRkZW46IHByb3BzLmhpZGRlbiAhPSBudWxsID8gewogICAgICAgIHZhbHVlOiBwcm9wcy5oaWRkZW4sCiAgICAgICAgYW5pbWF0ZWQ6IHByb3BzLmFuaW1hdGVkLAogICAgICAgIHRyYW5zaXRpb246IHByb3BzLnNob3dIaWRlVHJhbnNpdGlvbgogICAgICB9IDogbnVsbCwKICAgICAgbmV0d29ya0FjdGl2aXR5SW5kaWNhdG9yVmlzaWJsZTogcHJvcHMubmV0d29ya0FjdGl2aXR5SW5kaWNhdG9yVmlzaWJsZQogICAgfTsKICB9CgogIHZhciBTdGF0dXNCYXIgPSAoX3RlbXAyID0gX2NsYXNzID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhTdGF0dXNCYXIsIF9SZWFjdCRDb21wb25lbnQpOwoKICAgIGZ1bmN0aW9uIFN0YXR1c0JhcigpIHsKICAgICAgdmFyIF9yZWY7CgogICAgICB2YXIgX3RlbXAsIF90aGlzLCBfcmV0OwoKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFN0YXR1c0Jhcik7CgogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiBfcmV0ID0gKF90ZW1wID0gKF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKF9yZWYgPSBTdGF0dXNCYXIuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihTdGF0dXNCYXIpKS5jYWxsLmFwcGx5KF9yZWYsIFt0aGlzXS5jb25jYXQoYXJncykpKSwgX3RoaXMpLCBfdGhpcy5fc3RhY2tFbnRyeSA9IG51bGwsIF90aGlzLl91cGRhdGVQcm9wc1N0YWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIGNsZWFySW1tZWRpYXRlKFN0YXR1c0Jhci5fdXBkYXRlSW1tZWRpYXRlKTsKICAgICAgICBTdGF0dXNCYXIuX3VwZGF0ZUltbWVkaWF0ZSA9IHNldEltbWVkaWF0ZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBTdGF0dXNCYXIuX2N1cnJlbnRWYWx1ZXM7CiAgICAgICAgICB2YXIgbWVyZ2VkUHJvcHMgPSBtZXJnZVByb3BzU3RhY2soU3RhdHVzQmFyLl9wcm9wc1N0YWNrLCBTdGF0dXNCYXIuX2RlZmF1bHRQcm9wcyk7CgogICAgICAgICAgaWYgKFBsYXRmb3JtLk9TID09PSAnaW9zJykgewogICAgICAgICAgICBpZiAoIW9sZFByb3BzIHx8IG9sZFByb3BzLmJhclN0eWxlLnZhbHVlICE9PSBtZXJnZWRQcm9wcy5iYXJTdHlsZS52YWx1ZSkgewogICAgICAgICAgICAgIFN0YXR1c0Jhck1hbmFnZXIuc2V0U3R5bGUobWVyZ2VkUHJvcHMuYmFyU3R5bGUudmFsdWUsIG1lcmdlZFByb3BzLmJhclN0eWxlLmFuaW1hdGVkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFvbGRQcm9wcyB8fCBvbGRQcm9wcy5oaWRkZW4udmFsdWUgIT09IG1lcmdlZFByb3BzLmhpZGRlbi52YWx1ZSkgewogICAgICAgICAgICAgIFN0YXR1c0Jhck1hbmFnZXIuc2V0SGlkZGVuKG1lcmdlZFByb3BzLmhpZGRlbi52YWx1ZSwgbWVyZ2VkUHJvcHMuaGlkZGVuLmFuaW1hdGVkID8gbWVyZ2VkUHJvcHMuaGlkZGVuLnRyYW5zaXRpb24gOiAnbm9uZScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIW9sZFByb3BzIHx8IG9sZFByb3BzLm5ldHdvcmtBY3Rpdml0eUluZGljYXRvclZpc2libGUgIT09IG1lcmdlZFByb3BzLm5ldHdvcmtBY3Rpdml0eUluZGljYXRvclZpc2libGUpIHsKICAgICAgICAgICAgICBTdGF0dXNCYXJNYW5hZ2VyLnNldE5ldHdvcmtBY3Rpdml0eUluZGljYXRvclZpc2libGUobWVyZ2VkUHJvcHMubmV0d29ya0FjdGl2aXR5SW5kaWNhdG9yVmlzaWJsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJykgewogICAgICAgICAgICBpZiAoIW9sZFByb3BzIHx8IG9sZFByb3BzLmJhclN0eWxlLnZhbHVlICE9PSBtZXJnZWRQcm9wcy5iYXJTdHlsZS52YWx1ZSkgewogICAgICAgICAgICAgIFN0YXR1c0Jhck1hbmFnZXIuc2V0U3R5bGUobWVyZ2VkUHJvcHMuYmFyU3R5bGUudmFsdWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIW9sZFByb3BzIHx8IG9sZFByb3BzLmJhY2tncm91bmRDb2xvci52YWx1ZSAhPT0gbWVyZ2VkUHJvcHMuYmFja2dyb3VuZENvbG9yLnZhbHVlKSB7CiAgICAgICAgICAgICAgU3RhdHVzQmFyTWFuYWdlci5zZXRDb2xvcihwcm9jZXNzQ29sb3IobWVyZ2VkUHJvcHMuYmFja2dyb3VuZENvbG9yLnZhbHVlKSwgbWVyZ2VkUHJvcHMuYmFja2dyb3VuZENvbG9yLmFuaW1hdGVkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFvbGRQcm9wcyB8fCBvbGRQcm9wcy5oaWRkZW4udmFsdWUgIT09IG1lcmdlZFByb3BzLmhpZGRlbi52YWx1ZSkgewogICAgICAgICAgICAgIFN0YXR1c0Jhck1hbmFnZXIuc2V0SGlkZGVuKG1lcmdlZFByb3BzLmhpZGRlbi52YWx1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghb2xkUHJvcHMgfHwgb2xkUHJvcHMudHJhbnNsdWNlbnQgIT09IG1lcmdlZFByb3BzLnRyYW5zbHVjZW50KSB7CiAgICAgICAgICAgICAgU3RhdHVzQmFyTWFuYWdlci5zZXRUcmFuc2x1Y2VudChtZXJnZWRQcm9wcy50cmFuc2x1Y2VudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBTdGF0dXNCYXIuX2N1cnJlbnRWYWx1ZXMgPSBtZXJnZWRQcm9wczsKICAgICAgICB9KTsKICAgICAgfSwgX3RlbXApLCBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybihfdGhpcywgX3JldCk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFN0YXR1c0JhciwgW3sKICAgICAga2V5OiAiY29tcG9uZW50RGlkTW91bnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgICAgdGhpcy5fc3RhY2tFbnRyeSA9IGNyZWF0ZVN0YWNrRW50cnkodGhpcy5wcm9wcyk7CgogICAgICAgIFN0YXR1c0Jhci5fcHJvcHNTdGFjay5wdXNoKHRoaXMuX3N0YWNrRW50cnkpOwoKICAgICAgICB0aGlzLl91cGRhdGVQcm9wc1N0YWNrKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY29tcG9uZW50V2lsbFVubW91bnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29tcG9uZW50V2lsbFVubW91bnQoKSB7CiAgICAgICAgdmFyIGluZGV4ID0gU3RhdHVzQmFyLl9wcm9wc1N0YWNrLmluZGV4T2YodGhpcy5fc3RhY2tFbnRyeSk7CgogICAgICAgIFN0YXR1c0Jhci5fcHJvcHNTdGFjay5zcGxpY2UoaW5kZXgsIDEpOwoKICAgICAgICB0aGlzLl91cGRhdGVQcm9wc1N0YWNrKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY29tcG9uZW50RGlkVXBkYXRlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudERpZFVwZGF0ZSgpIHsKICAgICAgICB2YXIgaW5kZXggPSBTdGF0dXNCYXIuX3Byb3BzU3RhY2suaW5kZXhPZih0aGlzLl9zdGFja0VudHJ5KTsKCiAgICAgICAgdGhpcy5fc3RhY2tFbnRyeSA9IGNyZWF0ZVN0YWNrRW50cnkodGhpcy5wcm9wcyk7CiAgICAgICAgU3RhdHVzQmFyLl9wcm9wc1N0YWNrW2luZGV4XSA9IHRoaXMuX3N0YWNrRW50cnk7CgogICAgICAgIHRoaXMuX3VwZGF0ZVByb3BzU3RhY2soKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9XSwgW3sKICAgICAga2V5OiAic2V0SGlkZGVuIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldEhpZGRlbihoaWRkZW4sIGFuaW1hdGlvbikgewogICAgICAgIGFuaW1hdGlvbiA9IGFuaW1hdGlvbiB8fCAnbm9uZSc7CiAgICAgICAgU3RhdHVzQmFyLl9kZWZhdWx0UHJvcHMuaGlkZGVuLnZhbHVlID0gaGlkZGVuOwoKICAgICAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICdpb3MnKSB7CiAgICAgICAgICBTdGF0dXNCYXJNYW5hZ2VyLnNldEhpZGRlbihoaWRkZW4sIGFuaW1hdGlvbik7CiAgICAgICAgfSBlbHNlIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICAgICAgICBTdGF0dXNCYXJNYW5hZ2VyLnNldEhpZGRlbihoaWRkZW4pOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzZXRCYXJTdHlsZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRCYXJTdHlsZShzdHlsZSwgYW5pbWF0ZWQpIHsKICAgICAgICBhbmltYXRlZCA9IGFuaW1hdGVkIHx8IGZhbHNlOwogICAgICAgIFN0YXR1c0Jhci5fZGVmYXVsdFByb3BzLmJhclN0eWxlLnZhbHVlID0gc3R5bGU7CgogICAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgICAgICAgIFN0YXR1c0Jhck1hbmFnZXIuc2V0U3R5bGUoc3R5bGUsIGFuaW1hdGVkKTsKICAgICAgICB9IGVsc2UgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHsKICAgICAgICAgIFN0YXR1c0Jhck1hbmFnZXIuc2V0U3R5bGUoc3R5bGUpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzZXROZXR3b3JrQWN0aXZpdHlJbmRpY2F0b3JWaXNpYmxlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldE5ldHdvcmtBY3Rpdml0eUluZGljYXRvclZpc2libGUodmlzaWJsZSkgewogICAgICAgIGlmIChQbGF0Zm9ybS5PUyAhPT0gJ2lvcycpIHsKICAgICAgICAgIGNvbnNvbGUud2FybignYHNldE5ldHdvcmtBY3Rpdml0eUluZGljYXRvclZpc2libGVgIGlzIG9ubHkgYXZhaWxhYmxlIG9uIGlPUycpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgU3RhdHVzQmFyLl9kZWZhdWx0UHJvcHMubmV0d29ya0FjdGl2aXR5SW5kaWNhdG9yVmlzaWJsZSA9IHZpc2libGU7CiAgICAgICAgU3RhdHVzQmFyTWFuYWdlci5zZXROZXR3b3JrQWN0aXZpdHlJbmRpY2F0b3JWaXNpYmxlKHZpc2libGUpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNldEJhY2tncm91bmRDb2xvciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRCYWNrZ3JvdW5kQ29sb3IoY29sb3IsIGFuaW1hdGVkKSB7CiAgICAgICAgaWYgKFBsYXRmb3JtLk9TICE9PSAnYW5kcm9pZCcpIHsKICAgICAgICAgIGNvbnNvbGUud2FybignYHNldEJhY2tncm91bmRDb2xvcmAgaXMgb25seSBhdmFpbGFibGUgb24gQW5kcm9pZCcpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgYW5pbWF0ZWQgPSBhbmltYXRlZCB8fCBmYWxzZTsKICAgICAgICBTdGF0dXNCYXIuX2RlZmF1bHRQcm9wcy5iYWNrZ3JvdW5kQ29sb3IudmFsdWUgPSBjb2xvcjsKICAgICAgICBTdGF0dXNCYXJNYW5hZ2VyLnNldENvbG9yKHByb2Nlc3NDb2xvcihjb2xvciksIGFuaW1hdGVkKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzZXRUcmFuc2x1Y2VudCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRUcmFuc2x1Y2VudCh0cmFuc2x1Y2VudCkgewogICAgICAgIGlmIChQbGF0Zm9ybS5PUyAhPT0gJ2FuZHJvaWQnKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oJ2BzZXRUcmFuc2x1Y2VudGAgaXMgb25seSBhdmFpbGFibGUgb24gQW5kcm9pZCcpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgU3RhdHVzQmFyLl9kZWZhdWx0UHJvcHMudHJhbnNsdWNlbnQgPSB0cmFuc2x1Y2VudDsKICAgICAgICBTdGF0dXNCYXJNYW5hZ2VyLnNldFRyYW5zbHVjZW50KHRyYW5zbHVjZW50KTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFN0YXR1c0JhcjsKICB9KFJlYWN0LkNvbXBvbmVudCksIF9jbGFzcy5fcHJvcHNTdGFjayA9IFtdLCBfY2xhc3MuX2RlZmF1bHRQcm9wcyA9IGNyZWF0ZVN0YWNrRW50cnkoewogICAgYW5pbWF0ZWQ6IGZhbHNlLAogICAgc2hvd0hpZGVUcmFuc2l0aW9uOiAnZmFkZScsCiAgICBiYWNrZ3JvdW5kQ29sb3I6ICdibGFjaycsCiAgICBiYXJTdHlsZTogJ2RlZmF1bHQnLAogICAgdHJhbnNsdWNlbnQ6IGZhbHNlLAogICAgaGlkZGVuOiBmYWxzZSwKICAgIG5ldHdvcmtBY3Rpdml0eUluZGljYXRvclZpc2libGU6IGZhbHNlCiAgfSksIF9jbGFzcy5fdXBkYXRlSW1tZWRpYXRlID0gbnVsbCwgX2NsYXNzLl9jdXJyZW50VmFsdWVzID0gbnVsbCwgX2NsYXNzLmN1cnJlbnRIZWlnaHQgPSBTdGF0dXNCYXJNYW5hZ2VyLkhFSUdIVCwgX2NsYXNzLnByb3BUeXBlcyA9IHsKICAgIGhpZGRlbjogUHJvcFR5cGVzLmJvb2wsCiAgICBhbmltYXRlZDogUHJvcFR5cGVzLmJvb2wsCiAgICBiYWNrZ3JvdW5kQ29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICB0cmFuc2x1Y2VudDogUHJvcFR5cGVzLmJvb2wsCiAgICBiYXJTdHlsZTogUHJvcFR5cGVzLm9uZU9mKFsnZGVmYXVsdCcsICdsaWdodC1jb250ZW50JywgJ2RhcmstY29udGVudCddKSwKICAgIG5ldHdvcmtBY3Rpdml0eUluZGljYXRvclZpc2libGU6IFByb3BUeXBlcy5ib29sLAogICAgc2hvd0hpZGVUcmFuc2l0aW9uOiBQcm9wVHlwZXMub25lT2YoWydmYWRlJywgJ3NsaWRlJ10pCiAgfSwgX2NsYXNzLmRlZmF1bHRQcm9wcyA9IHsKICAgIGFuaW1hdGVkOiBmYWxzZSwKICAgIHNob3dIaWRlVHJhbnNpdGlvbjogJ2ZhZGUnCiAgfSwgX3RlbXAyKTsKICBtb2R1bGUuZXhwb3J0cyA9IFN0YXR1c0JhcjsKfSwyMzgsWzEzMCwxMjcsMTIzLDUyLDE1MiwxNV0sIlN0YXR1c0JhciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9jbGFzcywKICAgICAgX3RlbXAsCiAgICAgIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0xpc3RzL0ZsYXRMaXN0LmpzIjsKCiAgdmFyIE1ldHJvTGlzdFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTWV0cm9MaXN0VmlldyIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUmVhY3QiKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiVmlldyIpOwoKICB2YXIgVmlydHVhbGl6ZWRMaXN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlZpcnR1YWxpemVkTGlzdCIpOwoKICB2YXIgTGlzdFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiTGlzdFZpZXciKTsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIGRlZmF1bHRQcm9wcyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBWaXJ0dWFsaXplZExpc3QuZGVmYXVsdFByb3BzLCB7CiAgICBudW1Db2x1bW5zOiAxCiAgfSk7CiAgdmFyIEZsYXRMaXN0ID0gKF90ZW1wID0gX2NsYXNzID0gZnVuY3Rpb24gKF9SZWFjdCRQdXJlQ29tcG9uZW50KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoRmxhdExpc3QsIF9SZWFjdCRQdXJlQ29tcG9uZW50KTsKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhGbGF0TGlzdCwgW3sKICAgICAga2V5OiAic2Nyb2xsVG9FbmQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2Nyb2xsVG9FbmQocGFyYW1zKSB7CiAgICAgICAgaWYgKHRoaXMuX2xpc3RSZWYpIHsKICAgICAgICAgIHRoaXMuX2xpc3RSZWYuc2Nyb2xsVG9FbmQocGFyYW1zKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2Nyb2xsVG9JbmRleCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzY3JvbGxUb0luZGV4KHBhcmFtcykgewogICAgICAgIGlmICh0aGlzLl9saXN0UmVmKSB7CiAgICAgICAgICB0aGlzLl9saXN0UmVmLnNjcm9sbFRvSW5kZXgocGFyYW1zKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2Nyb2xsVG9JdGVtIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNjcm9sbFRvSXRlbShwYXJhbXMpIHsKICAgICAgICBpZiAodGhpcy5fbGlzdFJlZikgewogICAgICAgICAgdGhpcy5fbGlzdFJlZi5zY3JvbGxUb0l0ZW0ocGFyYW1zKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2Nyb2xsVG9PZmZzZXQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2Nyb2xsVG9PZmZzZXQocGFyYW1zKSB7CiAgICAgICAgaWYgKHRoaXMuX2xpc3RSZWYpIHsKICAgICAgICAgIHRoaXMuX2xpc3RSZWYuc2Nyb2xsVG9PZmZzZXQocGFyYW1zKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVjb3JkSW50ZXJhY3Rpb24iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVjb3JkSW50ZXJhY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuX2xpc3RSZWYpIHsKICAgICAgICAgIHRoaXMuX2xpc3RSZWYucmVjb3JkSW50ZXJhY3Rpb24oKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZmxhc2hTY3JvbGxJbmRpY2F0b3JzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGZsYXNoU2Nyb2xsSW5kaWNhdG9ycygpIHsKICAgICAgICBpZiAodGhpcy5fbGlzdFJlZikgewogICAgICAgICAgdGhpcy5fbGlzdFJlZi5mbGFzaFNjcm9sbEluZGljYXRvcnMoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0U2Nyb2xsUmVzcG9uZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFNjcm9sbFJlc3BvbmRlcigpIHsKICAgICAgICBpZiAodGhpcy5fbGlzdFJlZikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX2xpc3RSZWYuZ2V0U2Nyb2xsUmVzcG9uZGVyKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFNjcm9sbGFibGVOb2RlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFNjcm9sbGFibGVOb2RlKCkgewogICAgICAgIGlmICh0aGlzLl9saXN0UmVmKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fbGlzdFJlZi5nZXRTY3JvbGxhYmxlTm9kZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzZXROYXRpdmVQcm9wcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXROYXRpdmVQcm9wcyhwcm9wcykgewogICAgICAgIGlmICh0aGlzLl9saXN0UmVmKSB7CiAgICAgICAgICB0aGlzLl9saXN0UmVmLnNldE5hdGl2ZVByb3BzKHByb3BzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY29tcG9uZW50V2lsbE1vdW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxNb3VudCgpIHsKICAgICAgICB0aGlzLl9jaGVja1Byb3BzKHRoaXMucHJvcHMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHMpIHsKICAgICAgICBpbnZhcmlhbnQobmV4dFByb3BzLm51bUNvbHVtbnMgPT09IHRoaXMucHJvcHMubnVtQ29sdW1ucywgJ0NoYW5naW5nIG51bUNvbHVtbnMgb24gdGhlIGZseSBpcyBub3Qgc3VwcG9ydGVkLiBDaGFuZ2UgdGhlIGtleSBwcm9wIG9uIEZsYXRMaXN0IHdoZW4gJyArICdjaGFuZ2luZyB0aGUgbnVtYmVyIG9mIGNvbHVtbnMgdG8gZm9yY2UgYSBmcmVzaCByZW5kZXIgb2YgdGhlIGNvbXBvbmVudC4nKTsKICAgICAgICBpbnZhcmlhbnQobmV4dFByb3BzLm9uVmlld2FibGVJdGVtc0NoYW5nZWQgPT09IHRoaXMucHJvcHMub25WaWV3YWJsZUl0ZW1zQ2hhbmdlZCwgJ0NoYW5naW5nIG9uVmlld2FibGVJdGVtc0NoYW5nZWQgb24gdGhlIGZseSBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgICAgICAgaW52YXJpYW50KG5leHRQcm9wcy52aWV3YWJpbGl0eUNvbmZpZyA9PT0gdGhpcy5wcm9wcy52aWV3YWJpbGl0eUNvbmZpZywgJ0NoYW5naW5nIHZpZXdhYmlsaXR5Q29uZmlnIG9uIHRoZSBmbHkgaXMgbm90IHN1cHBvcnRlZCcpOwogICAgICAgIGludmFyaWFudChuZXh0UHJvcHMudmlld2FiaWxpdHlDb25maWdDYWxsYmFja1BhaXJzID09PSB0aGlzLnByb3BzLnZpZXdhYmlsaXR5Q29uZmlnQ2FsbGJhY2tQYWlycywgJ0NoYW5naW5nIHZpZXdhYmlsaXR5Q29uZmlnQ2FsbGJhY2tQYWlycyBvbiB0aGUgZmx5IGlzIG5vdCBzdXBwb3J0ZWQnKTsKCiAgICAgICAgdGhpcy5fY2hlY2tQcm9wcyhuZXh0UHJvcHMpOwogICAgICB9CiAgICB9XSk7CgogICAgZnVuY3Rpb24gRmxhdExpc3QocHJvcHMpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEZsYXRMaXN0KTsKCiAgICAgIHZhciBfdGhpcyA9IGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChGbGF0TGlzdC5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEZsYXRMaXN0KSkuY2FsbCh0aGlzLCBwcm9wcykpOwoKICAgICAgX3RoaXMuX2hhc1dhcm5lZExlZ2FjeSA9IGZhbHNlOwogICAgICBfdGhpcy5fdmlydHVhbGl6ZWRMaXN0UGFpcnMgPSBbXTsKCiAgICAgIF90aGlzLl9jYXB0dXJlUmVmID0gZnVuY3Rpb24gKHJlZikgewogICAgICAgIF90aGlzLl9saXN0UmVmID0gcmVmOwogICAgICB9OwoKICAgICAgX3RoaXMuX2dldEl0ZW0gPSBmdW5jdGlvbiAoZGF0YSwgaW5kZXgpIHsKICAgICAgICB2YXIgbnVtQ29sdW1ucyA9IF90aGlzLnByb3BzLm51bUNvbHVtbnM7CgogICAgICAgIGlmIChudW1Db2x1bW5zID4gMSkgewogICAgICAgICAgdmFyIHJldCA9IFtdOwoKICAgICAgICAgIGZvciAodmFyIGtrID0gMDsga2sgPCBudW1Db2x1bW5zOyBraysrKSB7CiAgICAgICAgICAgIHZhciBfaXRlbSA9IGRhdGFbaW5kZXggKiBudW1Db2x1bW5zICsga2tdOwogICAgICAgICAgICBfaXRlbSAmJiByZXQucHVzaChfaXRlbSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGRhdGFbaW5kZXhdOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIF90aGlzLl9nZXRJdGVtQ291bnQgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHJldHVybiBkYXRhID8gTWF0aC5jZWlsKGRhdGEubGVuZ3RoIC8gX3RoaXMucHJvcHMubnVtQ29sdW1ucykgOiAwOwogICAgICB9OwoKICAgICAgX3RoaXMuX2tleUV4dHJhY3RvciA9IGZ1bmN0aW9uIChpdGVtcywgaW5kZXgpIHsKICAgICAgICB2YXIgX3RoaXMkcHJvcHMgPSBfdGhpcy5wcm9wcywKICAgICAgICAgICAga2V5RXh0cmFjdG9yID0gX3RoaXMkcHJvcHMua2V5RXh0cmFjdG9yLAogICAgICAgICAgICBudW1Db2x1bW5zID0gX3RoaXMkcHJvcHMubnVtQ29sdW1uczsKCiAgICAgICAgaWYgKG51bUNvbHVtbnMgPiAxKSB7CiAgICAgICAgICBpbnZhcmlhbnQoQXJyYXkuaXNBcnJheShpdGVtcyksICdGbGF0TGlzdDogRW5jb3VudGVyZWQgaW50ZXJuYWwgY29uc2lzdGVuY3kgZXJyb3IsIGV4cGVjdGVkIGVhY2ggaXRlbSB0byBjb25zaXN0IG9mIGFuICcgKyAnYXJyYXkgd2l0aCAxLSVzIGNvbHVtbnM7IGluc3RlYWQsIHJlY2VpdmVkIGEgc2luZ2xlIGl0ZW0uJywgbnVtQ29sdW1ucyk7CiAgICAgICAgICByZXR1cm4gaXRlbXMubWFwKGZ1bmN0aW9uIChpdCwga2spIHsKICAgICAgICAgICAgcmV0dXJuIGtleUV4dHJhY3RvcihpdCwgaW5kZXggKiBudW1Db2x1bW5zICsga2spOwogICAgICAgICAgfSkuam9pbignOicpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4ga2V5RXh0cmFjdG9yKGl0ZW1zLCBpbmRleCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgX3RoaXMuX3JlbmRlckl0ZW0gPSBmdW5jdGlvbiAoaW5mbykgewogICAgICAgIHZhciBfdGhpcyRwcm9wczIgPSBfdGhpcy5wcm9wcywKICAgICAgICAgICAgcmVuZGVySXRlbSA9IF90aGlzJHByb3BzMi5yZW5kZXJJdGVtLAogICAgICAgICAgICBudW1Db2x1bW5zID0gX3RoaXMkcHJvcHMyLm51bUNvbHVtbnMsCiAgICAgICAgICAgIGNvbHVtbldyYXBwZXJTdHlsZSA9IF90aGlzJHByb3BzMi5jb2x1bW5XcmFwcGVyU3R5bGU7CgogICAgICAgIGlmIChudW1Db2x1bW5zID4gMSkgewogICAgICAgICAgdmFyIF9pdGVtMiA9IGluZm8uaXRlbSwKICAgICAgICAgICAgICBfaW5kZXggPSBpbmZvLmluZGV4OwogICAgICAgICAgaW52YXJpYW50KEFycmF5LmlzQXJyYXkoX2l0ZW0yKSwgJ0V4cGVjdGVkIGFycmF5IG9mIGl0ZW1zIHdpdGggbnVtQ29sdW1ucyA+IDEnKTsKICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBWaWV3LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IFt7CiAgICAgICAgICAgICAgICBmbGV4RGlyZWN0aW9uOiAncm93JwogICAgICAgICAgICAgIH0sIGNvbHVtbldyYXBwZXJTdHlsZV0sCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA2MDcKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9pdGVtMi5tYXAoZnVuY3Rpb24gKGl0LCBraykgewogICAgICAgICAgICAgIHZhciBlbGVtZW50ID0gcmVuZGVySXRlbSh7CiAgICAgICAgICAgICAgICBpdGVtOiBpdCwKICAgICAgICAgICAgICAgIGluZGV4OiBfaW5kZXggKiBudW1Db2x1bW5zICsga2ssCiAgICAgICAgICAgICAgICBzZXBhcmF0b3JzOiBpbmZvLnNlcGFyYXRvcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudCAmJiBSZWFjdC5jbG9uZUVsZW1lbnQoZWxlbWVudCwgewogICAgICAgICAgICAgICAga2V5OiBrawogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHJlbmRlckl0ZW0oaW5mbyk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaWYgKF90aGlzLnByb3BzLnZpZXdhYmlsaXR5Q29uZmlnQ2FsbGJhY2tQYWlycykgewogICAgICAgIF90aGlzLl92aXJ0dWFsaXplZExpc3RQYWlycyA9IF90aGlzLnByb3BzLnZpZXdhYmlsaXR5Q29uZmlnQ2FsbGJhY2tQYWlycy5tYXAoZnVuY3Rpb24gKHBhaXIpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHZpZXdhYmlsaXR5Q29uZmlnOiBwYWlyLnZpZXdhYmlsaXR5Q29uZmlnLAogICAgICAgICAgICBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkOiBfdGhpcy5fY3JlYXRlT25WaWV3YWJsZUl0ZW1zQ2hhbmdlZChwYWlyLm9uVmlld2FibGVJdGVtc0NoYW5nZWQpCiAgICAgICAgICB9OwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKF90aGlzLnByb3BzLm9uVmlld2FibGVJdGVtc0NoYW5nZWQpIHsKICAgICAgICBfdGhpcy5fdmlydHVhbGl6ZWRMaXN0UGFpcnMucHVzaCh7CiAgICAgICAgICB2aWV3YWJpbGl0eUNvbmZpZzogX3RoaXMucHJvcHMudmlld2FiaWxpdHlDb25maWcsCiAgICAgICAgICBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkOiBfdGhpcy5fY3JlYXRlT25WaWV3YWJsZUl0ZW1zQ2hhbmdlZChfdGhpcy5wcm9wcy5vblZpZXdhYmxlSXRlbXNDaGFuZ2VkKQogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEZsYXRMaXN0LCBbewogICAgICBrZXk6ICJfY2hlY2tQcm9wcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfY2hlY2tQcm9wcyhwcm9wcykgewogICAgICAgIHZhciBnZXRJdGVtID0gcHJvcHMuZ2V0SXRlbSwKICAgICAgICAgICAgZ2V0SXRlbUNvdW50ID0gcHJvcHMuZ2V0SXRlbUNvdW50LAogICAgICAgICAgICBob3Jpem9udGFsID0gcHJvcHMuaG9yaXpvbnRhbCwKICAgICAgICAgICAgbGVnYWN5SW1wbGVtZW50YXRpb24gPSBwcm9wcy5sZWdhY3lJbXBsZW1lbnRhdGlvbiwKICAgICAgICAgICAgbnVtQ29sdW1ucyA9IHByb3BzLm51bUNvbHVtbnMsCiAgICAgICAgICAgIGNvbHVtbldyYXBwZXJTdHlsZSA9IHByb3BzLmNvbHVtbldyYXBwZXJTdHlsZSwKICAgICAgICAgICAgb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZCA9IHByb3BzLm9uVmlld2FibGVJdGVtc0NoYW5nZWQsCiAgICAgICAgICAgIHZpZXdhYmlsaXR5Q29uZmlnQ2FsbGJhY2tQYWlycyA9IHByb3BzLnZpZXdhYmlsaXR5Q29uZmlnQ2FsbGJhY2tQYWlyczsKICAgICAgICBpbnZhcmlhbnQoIWdldEl0ZW0gJiYgIWdldEl0ZW1Db3VudCwgJ0ZsYXRMaXN0IGRvZXMgbm90IHN1cHBvcnQgY3VzdG9tIGRhdGEgZm9ybWF0cy4nKTsKCiAgICAgICAgaWYgKG51bUNvbHVtbnMgPiAxKSB7CiAgICAgICAgICBpbnZhcmlhbnQoIWhvcml6b250YWwsICdudW1Db2x1bW5zIGRvZXMgbm90IHN1cHBvcnQgaG9yaXpvbnRhbC4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaW52YXJpYW50KCFjb2x1bW5XcmFwcGVyU3R5bGUsICdjb2x1bW5XcmFwcGVyU3R5bGUgbm90IHN1cHBvcnRlZCBmb3Igc2luZ2xlIGNvbHVtbiBsaXN0cycpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGxlZ2FjeUltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICBpbnZhcmlhbnQobnVtQ29sdW1ucyA9PT0gMSwgJ0xlZ2FjeSBsaXN0IGRvZXMgbm90IHN1cHBvcnQgbXVsdGlwbGUgY29sdW1ucy4nKTsKCiAgICAgICAgICBpZiAoIXRoaXMuX2hhc1dhcm5lZExlZ2FjeSkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ0ZsYXRMaXN0OiBVc2luZyBsZWdhY3lJbXBsZW1lbnRhdGlvbiAtIHNvbWUgZmVhdHVyZXMgbm90IHN1cHBvcnRlZCBhbmQgcGVyZm9ybWFuY2UgJyArICdtYXkgc3VmZmVyJyk7CiAgICAgICAgICAgIHRoaXMuX2hhc1dhcm5lZExlZ2FjeSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpbnZhcmlhbnQoIShvblZpZXdhYmxlSXRlbXNDaGFuZ2VkICYmIHZpZXdhYmlsaXR5Q29uZmlnQ2FsbGJhY2tQYWlycyksICdGbGF0TGlzdCBkb2VzIG5vdCBzdXBwb3J0IHNldHRpbmcgYm90aCBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkIGFuZCAnICsgJ3ZpZXdhYmlsaXR5Q29uZmlnQ2FsbGJhY2tQYWlycy4nKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfcHVzaE11bHRpQ29sdW1uVmlld2FibGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX3B1c2hNdWx0aUNvbHVtblZpZXdhYmxlKGFyciwgdikgewogICAgICAgIHZhciBfcHJvcHMgPSB0aGlzLnByb3BzLAogICAgICAgICAgICBudW1Db2x1bW5zID0gX3Byb3BzLm51bUNvbHVtbnMsCiAgICAgICAgICAgIGtleUV4dHJhY3RvciA9IF9wcm9wcy5rZXlFeHRyYWN0b3I7CiAgICAgICAgdi5pdGVtLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0sIGlpKSB7CiAgICAgICAgICBpbnZhcmlhbnQodi5pbmRleCAhPSBudWxsLCAnTWlzc2luZyBpbmRleCEnKTsKICAgICAgICAgIHZhciBpbmRleCA9IHYuaW5kZXggKiBudW1Db2x1bW5zICsgaWk7CiAgICAgICAgICBhcnIucHVzaChiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdiwgewogICAgICAgICAgICBpdGVtOiBpdGVtLAogICAgICAgICAgICBrZXk6IGtleUV4dHJhY3RvcihpdGVtLCBpbmRleCksCiAgICAgICAgICAgIGluZGV4OiBpbmRleAogICAgICAgICAgfSkpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9jcmVhdGVPblZpZXdhYmxlSXRlbXNDaGFuZ2VkIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9jcmVhdGVPblZpZXdhYmxlSXRlbXNDaGFuZ2VkKG9uVmlld2FibGVJdGVtc0NoYW5nZWQpIHsKICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChpbmZvKSB7CiAgICAgICAgICB2YXIgbnVtQ29sdW1ucyA9IF90aGlzMi5wcm9wcy5udW1Db2x1bW5zOwoKICAgICAgICAgIGlmIChvblZpZXdhYmxlSXRlbXNDaGFuZ2VkKSB7CiAgICAgICAgICAgIGlmIChudW1Db2x1bW5zID4gMSkgewogICAgICAgICAgICAgIHZhciBfY2hhbmdlZCA9IFtdOwogICAgICAgICAgICAgIHZhciBfdmlld2FibGVJdGVtcyA9IFtdOwogICAgICAgICAgICAgIGluZm8udmlld2FibGVJdGVtcy5mb3JFYWNoKGZ1bmN0aW9uICh2KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMyLl9wdXNoTXVsdGlDb2x1bW5WaWV3YWJsZShfdmlld2FibGVJdGVtcywgdik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaW5mby5jaGFuZ2VkLmZvckVhY2goZnVuY3Rpb24gKHYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczIuX3B1c2hNdWx0aUNvbHVtblZpZXdhYmxlKF9jaGFuZ2VkLCB2KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkKHsKICAgICAgICAgICAgICAgIHZpZXdhYmxlSXRlbXM6IF92aWV3YWJsZUl0ZW1zLAogICAgICAgICAgICAgICAgY2hhbmdlZDogX2NoYW5nZWQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkKGluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIGlmICh0aGlzLnByb3BzLmxlZ2FjeUltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChNZXRyb0xpc3RWaWV3LCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcywgewogICAgICAgICAgICBpdGVtczogdGhpcy5wcm9wcy5kYXRhLAogICAgICAgICAgICByZWY6IHRoaXMuX2NhcHR1cmVSZWYsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA2MjYKICAgICAgICAgICAgfQogICAgICAgICAgfSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChWaXJ0dWFsaXplZExpc3QsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCB0aGlzLnByb3BzLCB7CiAgICAgICAgICAgIHJlbmRlckl0ZW06IHRoaXMuX3JlbmRlckl0ZW0sCiAgICAgICAgICAgIGdldEl0ZW06IHRoaXMuX2dldEl0ZW0sCiAgICAgICAgICAgIGdldEl0ZW1Db3VudDogdGhpcy5fZ2V0SXRlbUNvdW50LAogICAgICAgICAgICBrZXlFeHRyYWN0b3I6IHRoaXMuX2tleUV4dHJhY3RvciwKICAgICAgICAgICAgcmVmOiB0aGlzLl9jYXB0dXJlUmVmLAogICAgICAgICAgICB2aWV3YWJpbGl0eUNvbmZpZ0NhbGxiYWNrUGFpcnM6IHRoaXMuX3ZpcnR1YWxpemVkTGlzdFBhaXJzLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNjM0CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pKTsKICAgICAgICB9CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBGbGF0TGlzdDsKICB9KFJlYWN0LlB1cmVDb21wb25lbnQpLCBfY2xhc3MuZGVmYXVsdFByb3BzID0gZGVmYXVsdFByb3BzLCBfdGVtcCk7CiAgbW9kdWxlLmV4cG9ydHMgPSBGbGF0TGlzdDsKfSwyMzksWzI0MCwxMzAsMTcwLDI0NywyNDEsMTNdLCJGbGF0TGlzdCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9jbGFzcywKICAgICAgX3RlbXAyLAogICAgICBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9MaXN0cy9NZXRyb0xpc3RWaWV3LmpzIjsKCiAgdmFyIExpc3RWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkxpc3RWaWV3Iik7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJSZWFjdCIpOwoKICB2YXIgUmVmcmVzaENvbnRyb2wgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUmVmcmVzaENvbnRyb2wiKTsKCiAgdmFyIFNjcm9sbFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiU2Nyb2xsVmlldyIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgTWV0cm9MaXN0VmlldyA9IChfdGVtcDIgPSBfY2xhc3MgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKE1ldHJvTGlzdFZpZXcsIF9SZWFjdCRDb21wb25lbnQpOwoKICAgIGZ1bmN0aW9uIE1ldHJvTGlzdFZpZXcoKSB7CiAgICAgIHZhciBfcmVmLAogICAgICAgICAgX3RoaXMyID0gdGhpczsKCiAgICAgIHZhciBfdGVtcCwgX3RoaXMsIF9yZXQ7CgogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgTWV0cm9MaXN0Vmlldyk7CgogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiBfcmV0ID0gKF90ZW1wID0gKF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKF9yZWYgPSBNZXRyb0xpc3RWaWV3Ll9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoTWV0cm9MaXN0VmlldykpLmNhbGwuYXBwbHkoX3JlZiwgW3RoaXNdLmNvbmNhdChhcmdzKSkpLCBfdGhpcyksIF90aGlzLnN0YXRlID0gX3RoaXMuX2NvbXB1dGVTdGF0ZShfdGhpcy5wcm9wcywgewogICAgICAgIGRzOiBuZXcgTGlzdFZpZXcuRGF0YVNvdXJjZSh7CiAgICAgICAgICByb3dIYXNDaGFuZ2VkOiBmdW5jdGlvbiByb3dIYXNDaGFuZ2VkKGl0ZW1BLCBpdGVtQikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBzZWN0aW9uSGVhZGVySGFzQ2hhbmdlZDogZnVuY3Rpb24gc2VjdGlvbkhlYWRlckhhc0NoYW5nZWQoKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSwKICAgICAgICAgIGdldFNlY3Rpb25IZWFkZXJEYXRhOiBmdW5jdGlvbiBnZXRTZWN0aW9uSGVhZGVyRGF0YShkYXRhQmxvYiwgc2VjdGlvbklEKSB7CiAgICAgICAgICAgIHJldHVybiBfdGhpcy5zdGF0ZS5zZWN0aW9uSGVhZGVyRGF0YVtzZWN0aW9uSURdOwogICAgICAgICAgfQogICAgICAgIH0pLAogICAgICAgIHNlY3Rpb25IZWFkZXJEYXRhOiB7fQogICAgICB9KSwgX3RoaXMuX2NhcHR1cmVSZWYgPSBmdW5jdGlvbiAocmVmKSB7CiAgICAgICAgX3RoaXMuX2xpc3RSZWYgPSByZWY7CiAgICAgIH0sIF90aGlzLl9yZW5kZXJGb290ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoX3RoaXMyLnByb3BzLkZvb3RlckNvbXBvbmVudCwgewogICAgICAgICAga2V5OiAiJGZvb3RlciIsCiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiAxODMKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwgX3RoaXMuX3JlbmRlclJvdyA9IGZ1bmN0aW9uIChpdGVtLCBzZWN0aW9uSUQsIHJvd0lELCBoaWdobGlnaHRSb3cpIHsKICAgICAgICByZXR1cm4gX3RoaXMucHJvcHMucmVuZGVySXRlbSh7CiAgICAgICAgICBpdGVtOiBpdGVtLAogICAgICAgICAgaW5kZXg6IHJvd0lECiAgICAgICAgfSk7CiAgICAgIH0sIF90aGlzLl9yZW5kZXJTZWN0aW9uSGVhZGVyID0gZnVuY3Rpb24gKHNlY3Rpb24sIHNlY3Rpb25JRCkgewogICAgICAgIHZhciByZW5kZXJTZWN0aW9uSGVhZGVyID0gX3RoaXMucHJvcHMucmVuZGVyU2VjdGlvbkhlYWRlcjsKICAgICAgICBpbnZhcmlhbnQocmVuZGVyU2VjdGlvbkhlYWRlciwgJ011c3QgcHJvdmlkZSByZW5kZXJTZWN0aW9uSGVhZGVyIHdpdGggc2VjdGlvbnMgcHJvcCcpOwogICAgICAgIHJldHVybiByZW5kZXJTZWN0aW9uSGVhZGVyKHsKICAgICAgICAgIHNlY3Rpb246IHNlY3Rpb24KICAgICAgICB9KTsKICAgICAgfSwgX3RoaXMuX3JlbmRlclNlcGFyYXRvciA9IGZ1bmN0aW9uIChzSUQsIHJJRCkgewogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KF90aGlzMi5wcm9wcy5TZXBhcmF0b3JDb21wb25lbnQsIHsKICAgICAgICAgIGtleTogc0lEICsgcklELAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogMTk5CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sIF90ZW1wKSwgYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4oX3RoaXMsIF9yZXQpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhNZXRyb0xpc3RWaWV3LCBbewogICAgICBrZXk6ICJzY3JvbGxUb0VuZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzY3JvbGxUb0VuZChwYXJhbXMpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Njcm9sbFRvRW5kIG5vdCBzdXBwb3J0ZWQgaW4gbGVnYWN5IExpc3RWaWV3LicpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNjcm9sbFRvSW5kZXgiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2Nyb2xsVG9JbmRleChwYXJhbXMpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Njcm9sbFRvSW5kZXggbm90IHN1cHBvcnRlZCBpbiBsZWdhY3kgTGlzdFZpZXcuJyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2Nyb2xsVG9JdGVtIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNjcm9sbFRvSXRlbShwYXJhbXMpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Njcm9sbFRvSXRlbSBub3Qgc3VwcG9ydGVkIGluIGxlZ2FjeSBMaXN0Vmlldy4nKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzY3JvbGxUb0xvY2F0aW9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNjcm9sbFRvTG9jYXRpb24ocGFyYW1zKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzY3JvbGxUb0xvY2F0aW9uIG5vdCBzdXBwb3J0ZWQgaW4gbGVnYWN5IExpc3RWaWV3LicpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNjcm9sbFRvT2Zmc2V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNjcm9sbFRvT2Zmc2V0KHBhcmFtcykgewogICAgICAgIHZhciBhbmltYXRlZCA9IHBhcmFtcy5hbmltYXRlZCwKICAgICAgICAgICAgb2Zmc2V0ID0gcGFyYW1zLm9mZnNldDsKCiAgICAgICAgdGhpcy5fbGlzdFJlZi5zY3JvbGxUbyh0aGlzLnByb3BzLmhvcml6b250YWwgPyB7CiAgICAgICAgICB4OiBvZmZzZXQsCiAgICAgICAgICBhbmltYXRlZDogYW5pbWF0ZWQKICAgICAgICB9IDogewogICAgICAgICAgeTogb2Zmc2V0LAogICAgICAgICAgYW5pbWF0ZWQ6IGFuaW1hdGVkCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0TGlzdFJlZiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRMaXN0UmVmKCkgewogICAgICAgIHJldHVybiB0aGlzLl9saXN0UmVmOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNldE5hdGl2ZVByb3BzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldE5hdGl2ZVByb3BzKHByb3BzKSB7CiAgICAgICAgaWYgKHRoaXMuX2xpc3RSZWYpIHsKICAgICAgICAgIHRoaXMuX2xpc3RSZWYuc2V0TmF0aXZlUHJvcHMocHJvcHMpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV3UHJvcHMpIHsKICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgdGhpcy5zZXRTdGF0ZShmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgICAgIHJldHVybiBfdGhpczMuX2NvbXB1dGVTdGF0ZShuZXdQcm9wcywgc3RhdGUpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoTGlzdFZpZXcsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCB0aGlzLnByb3BzLCB7CiAgICAgICAgICBkYXRhU291cmNlOiB0aGlzLnN0YXRlLmRzLAogICAgICAgICAgcmVmOiB0aGlzLl9jYXB0dXJlUmVmLAogICAgICAgICAgcmVuZGVyUm93OiB0aGlzLl9yZW5kZXJSb3csCiAgICAgICAgICByZW5kZXJGb290ZXI6IHRoaXMucHJvcHMuRm9vdGVyQ29tcG9uZW50ICYmIHRoaXMuX3JlbmRlckZvb3RlciwKICAgICAgICAgIHJlbmRlclNlY3Rpb25IZWFkZXI6IHRoaXMucHJvcHMuc2VjdGlvbnMgJiYgdGhpcy5fcmVuZGVyU2VjdGlvbkhlYWRlciwKICAgICAgICAgIHJlbmRlclNlcGFyYXRvcjogdGhpcy5wcm9wcy5TZXBhcmF0b3JDb21wb25lbnQgJiYgdGhpcy5fcmVuZGVyU2VwYXJhdG9yLAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogMTQzCiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9jb21wdXRlU3RhdGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2NvbXB1dGVTdGF0ZShwcm9wcywgc3RhdGUpIHsKICAgICAgICB2YXIgc2VjdGlvbkhlYWRlckRhdGEgPSB7fTsKCiAgICAgICAgaWYgKHByb3BzLnNlY3Rpb25zKSB7CiAgICAgICAgICBpbnZhcmlhbnQoIXByb3BzLml0ZW1zLCAnQ2Fubm90IGhhdmUgYm90aCBzZWN0aW9ucyBhbmQgaXRlbXMgcHJvcHMuJyk7CiAgICAgICAgICB2YXIgX3NlY3Rpb25zID0ge307CiAgICAgICAgICBwcm9wcy5zZWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChzZWN0aW9uSW4sIGlpKSB7CiAgICAgICAgICAgIHZhciBzZWN0aW9uSUQgPSAncycgKyBpaTsKICAgICAgICAgICAgX3NlY3Rpb25zW3NlY3Rpb25JRF0gPSBzZWN0aW9uSW4uZGF0YTsKICAgICAgICAgICAgc2VjdGlvbkhlYWRlckRhdGFbc2VjdGlvbklEXSA9IHNlY3Rpb25JbjsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZHM6IHN0YXRlLmRzLmNsb25lV2l0aFJvd3NBbmRTZWN0aW9ucyhfc2VjdGlvbnMpLAogICAgICAgICAgICBzZWN0aW9uSGVhZGVyRGF0YTogc2VjdGlvbkhlYWRlckRhdGEKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGludmFyaWFudCghcHJvcHMuc2VjdGlvbnMsICdDYW5ub3QgaGF2ZSBib3RoIHNlY3Rpb25zIGFuZCBpdGVtcyBwcm9wcy4nKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGRzOiBzdGF0ZS5kcy5jbG9uZVdpdGhSb3dzKHByb3BzLml0ZW1zKSwKICAgICAgICAgICAgc2VjdGlvbkhlYWRlckRhdGE6IHNlY3Rpb25IZWFkZXJEYXRhCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIE1ldHJvTGlzdFZpZXc7CiAgfShSZWFjdC5Db21wb25lbnQpLCBfY2xhc3MuZGVmYXVsdFByb3BzID0gewogICAga2V5RXh0cmFjdG9yOiBmdW5jdGlvbiBrZXlFeHRyYWN0b3IoaXRlbSwgaW5kZXgpIHsKICAgICAgcmV0dXJuIGl0ZW0ua2V5IHx8IFN0cmluZyhpbmRleCk7CiAgICB9LAogICAgcmVuZGVyU2Nyb2xsQ29tcG9uZW50OiBmdW5jdGlvbiByZW5kZXJTY3JvbGxDb21wb25lbnQocHJvcHMpIHsKICAgICAgaWYgKHByb3BzLm9uUmVmcmVzaCkgewogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFNjcm9sbFZpZXcsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBwcm9wcywgewogICAgICAgICAgcmVmcmVzaENvbnRyb2w6IFJlYWN0LmNyZWF0ZUVsZW1lbnQoUmVmcmVzaENvbnRyb2wsIHsKICAgICAgICAgICAgcmVmcmVzaGluZzogcHJvcHMucmVmcmVzaGluZywKICAgICAgICAgICAgb25SZWZyZXNoOiBwcm9wcy5vblJlZnJlc2gsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAxMTcKICAgICAgICAgICAgfQogICAgICAgICAgfSksCiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiAxMTAKICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoU2Nyb2xsVmlldywgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHByb3BzLCB7CiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiAxMjUKICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgIH0KICAgIH0KICB9LCBfdGVtcDIpOwogIG1vZHVsZS5leHBvcnRzID0gTWV0cm9MaXN0VmlldzsKfSwyNDAsWzI0MSwxMzAsMjQ2LDIyNCwxM10sIk1ldHJvTGlzdFZpZXciKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9MaXN0cy9MaXN0Vmlldy9MaXN0Vmlldy5qcyI7CgogIHZhciBMaXN0Vmlld0RhdGFTb3VyY2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTGlzdFZpZXdEYXRhU291cmNlIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJQbGF0Zm9ybSIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUmVhY3QiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJwcm9wLXR5cGVzIik7CgogIHZhciBSZWFjdE5hdGl2ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJSZWFjdE5hdGl2ZSIpOwoKICB2YXIgUkNUU2Nyb2xsVmlld01hbmFnZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiTmF0aXZlTW9kdWxlcyIpLlNjcm9sbFZpZXdNYW5hZ2VyOwoKICB2YXIgU2Nyb2xsVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJTY3JvbGxWaWV3Iik7CgogIHZhciBTY3JvbGxSZXNwb25kZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiU2Nyb2xsUmVzcG9uZGVyIik7CgogIHZhciBTdGF0aWNSZW5kZXJlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJTdGF0aWNSZW5kZXJlciIpOwoKICB2YXIgVGltZXJNaXhpbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOV0sICJyZWFjdC10aW1lci1taXhpbiIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTBdLCAiVmlldyIpOwoKICB2YXIgY2xvbmVSZWZlcmVuY2VkRWxlbWVudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTFdLCAicmVhY3QtY2xvbmUtcmVmZXJlbmNlZC1lbGVtZW50Iik7CgogIHZhciBjcmVhdGVSZWFjdENsYXNzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMl0sICJjcmVhdGUtcmVhY3QtY2xhc3MiKTsKCiAgdmFyIGlzRW1wdHkgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEzXSwgImlzRW1wdHkiKTsKCiAgdmFyIG1lcmdlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxNF0sICJtZXJnZSIpOwoKICB2YXIgREVGQVVMVF9QQUdFX1NJWkUgPSAxOwogIHZhciBERUZBVUxUX0lOSVRJQUxfUk9XUyA9IDEwOwogIHZhciBERUZBVUxUX1NDUk9MTF9SRU5ERVJfQUhFQUQgPSAxMDAwOwogIHZhciBERUZBVUxUX0VORF9SRUFDSEVEX1RIUkVTSE9MRCA9IDEwMDA7CiAgdmFyIERFRkFVTFRfU0NST0xMX0NBTExCQUNLX1RIUk9UVExFID0gNTA7CiAgdmFyIExpc3RWaWV3ID0gY3JlYXRlUmVhY3RDbGFzcyh7CiAgICBkaXNwbGF5TmFtZTogJ0xpc3RWaWV3JywKICAgIF9jaGlsZEZyYW1lczogW10sCiAgICBfc2VudEVuZEZvckNvbnRlbnRMZW5ndGg6IG51bGwsCiAgICBfc2Nyb2xsQ29tcG9uZW50OiBudWxsLAogICAgX3ByZXZSZW5kZXJlZFJvd3NDb3VudDogMCwKICAgIF92aXNpYmxlUm93czoge30sCiAgICBzY3JvbGxQcm9wZXJ0aWVzOiB7fSwKICAgIG1peGluczogW1Njcm9sbFJlc3BvbmRlci5NaXhpbiwgVGltZXJNaXhpbl0sCiAgICBzdGF0aWNzOiB7CiAgICAgIERhdGFTb3VyY2U6IExpc3RWaWV3RGF0YVNvdXJjZQogICAgfSwKICAgIHByb3BUeXBlczogYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIFNjcm9sbFZpZXcucHJvcFR5cGVzLCB7CiAgICAgIGRhdGFTb3VyY2U6IFByb3BUeXBlcy5pbnN0YW5jZU9mKExpc3RWaWV3RGF0YVNvdXJjZSkuaXNSZXF1aXJlZCwKICAgICAgcmVuZGVyU2VwYXJhdG9yOiBQcm9wVHlwZXMuZnVuYywKICAgICAgcmVuZGVyUm93OiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLAogICAgICBpbml0aWFsTGlzdFNpemU6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCwKICAgICAgb25FbmRSZWFjaGVkOiBQcm9wVHlwZXMuZnVuYywKICAgICAgb25FbmRSZWFjaGVkVGhyZXNob2xkOiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsCiAgICAgIHBhZ2VTaXplOiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsCiAgICAgIHJlbmRlckZvb3RlcjogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIHJlbmRlckhlYWRlcjogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIHJlbmRlclNlY3Rpb25IZWFkZXI6IFByb3BUeXBlcy5mdW5jLAogICAgICByZW5kZXJTY3JvbGxDb21wb25lbnQ6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsCiAgICAgIHNjcm9sbFJlbmRlckFoZWFkRGlzdGFuY2U6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCwKICAgICAgb25DaGFuZ2VWaXNpYmxlUm93czogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIHJlbW92ZUNsaXBwZWRTdWJ2aWV3czogUHJvcFR5cGVzLmJvb2wsCiAgICAgIHN0aWNreVNlY3Rpb25IZWFkZXJzRW5hYmxlZDogUHJvcFR5cGVzLmJvb2wsCiAgICAgIHN0aWNreUhlYWRlckluZGljZXM6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5udW1iZXIpLmlzUmVxdWlyZWQsCiAgICAgIGVuYWJsZUVtcHR5U2VjdGlvbnM6IFByb3BUeXBlcy5ib29sCiAgICB9KSwKICAgIGdldE1ldHJpY3M6IGZ1bmN0aW9uIGdldE1ldHJpY3MoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgY29udGVudExlbmd0aDogdGhpcy5zY3JvbGxQcm9wZXJ0aWVzLmNvbnRlbnRMZW5ndGgsCiAgICAgICAgdG90YWxSb3dzOiB0aGlzLnByb3BzLmVuYWJsZUVtcHR5U2VjdGlvbnMgPyB0aGlzLnByb3BzLmRhdGFTb3VyY2UuZ2V0Um93QW5kU2VjdGlvbkNvdW50KCkgOiB0aGlzLnByb3BzLmRhdGFTb3VyY2UuZ2V0Um93Q291bnQoKSwKICAgICAgICByZW5kZXJlZFJvd3M6IHRoaXMuc3RhdGUuY3VyUmVuZGVyZWRSb3dzQ291bnQsCiAgICAgICAgdmlzaWJsZVJvd3M6IE9iamVjdC5rZXlzKHRoaXMuX3Zpc2libGVSb3dzKS5sZW5ndGgKICAgICAgfTsKICAgIH0sCiAgICBnZXRTY3JvbGxSZXNwb25kZXI6IGZ1bmN0aW9uIGdldFNjcm9sbFJlc3BvbmRlcigpIHsKICAgICAgaWYgKHRoaXMuX3Njcm9sbENvbXBvbmVudCAmJiB0aGlzLl9zY3JvbGxDb21wb25lbnQuZ2V0U2Nyb2xsUmVzcG9uZGVyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3Njcm9sbENvbXBvbmVudC5nZXRTY3JvbGxSZXNwb25kZXIoKTsKICAgICAgfQogICAgfSwKICAgIGdldFNjcm9sbGFibGVOb2RlOiBmdW5jdGlvbiBnZXRTY3JvbGxhYmxlTm9kZSgpIHsKICAgICAgaWYgKHRoaXMuX3Njcm9sbENvbXBvbmVudCAmJiB0aGlzLl9zY3JvbGxDb21wb25lbnQuZ2V0U2Nyb2xsYWJsZU5vZGUpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc2Nyb2xsQ29tcG9uZW50LmdldFNjcm9sbGFibGVOb2RlKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKHRoaXMuX3Njcm9sbENvbXBvbmVudCk7CiAgICAgIH0KICAgIH0sCiAgICBzY3JvbGxUbzogZnVuY3Rpb24gc2Nyb2xsVG8oKSB7CiAgICAgIGlmICh0aGlzLl9zY3JvbGxDb21wb25lbnQgJiYgdGhpcy5fc2Nyb2xsQ29tcG9uZW50LnNjcm9sbFRvKSB7CiAgICAgICAgdmFyIF9zY3JvbGxDb21wb25lbnQ7CgogICAgICAgIChfc2Nyb2xsQ29tcG9uZW50ID0gdGhpcy5fc2Nyb2xsQ29tcG9uZW50KS5zY3JvbGxUby5hcHBseShfc2Nyb2xsQ29tcG9uZW50LCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9LAogICAgc2Nyb2xsVG9FbmQ6IGZ1bmN0aW9uIHNjcm9sbFRvRW5kKG9wdGlvbnMpIHsKICAgICAgaWYgKHRoaXMuX3Njcm9sbENvbXBvbmVudCkgewogICAgICAgIGlmICh0aGlzLl9zY3JvbGxDb21wb25lbnQuc2Nyb2xsVG9FbmQpIHsKICAgICAgICAgIHRoaXMuX3Njcm9sbENvbXBvbmVudC5zY3JvbGxUb0VuZChvcHRpb25zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS53YXJuKCdUaGUgc2Nyb2xsIGNvbXBvbmVudCB1c2VkIGJ5IHRoZSBMaXN0VmlldyBkb2VzIG5vdCBzdXBwb3J0ICcgKyAnc2Nyb2xsVG9FbmQuIENoZWNrIHRoZSByZW5kZXJTY3JvbGxDb21wb25lbnQgcHJvcCBvZiB5b3VyIExpc3RWaWV3LicpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGZsYXNoU2Nyb2xsSW5kaWNhdG9yczogZnVuY3Rpb24gZmxhc2hTY3JvbGxJbmRpY2F0b3JzKCkgewogICAgICBpZiAodGhpcy5fc2Nyb2xsQ29tcG9uZW50ICYmIHRoaXMuX3Njcm9sbENvbXBvbmVudC5mbGFzaFNjcm9sbEluZGljYXRvcnMpIHsKICAgICAgICB0aGlzLl9zY3JvbGxDb21wb25lbnQuZmxhc2hTY3JvbGxJbmRpY2F0b3JzKCk7CiAgICAgIH0KICAgIH0sCiAgICBzZXROYXRpdmVQcm9wczogZnVuY3Rpb24gc2V0TmF0aXZlUHJvcHMocHJvcHMpIHsKICAgICAgaWYgKHRoaXMuX3Njcm9sbENvbXBvbmVudCkgewogICAgICAgIHRoaXMuX3Njcm9sbENvbXBvbmVudC5zZXROYXRpdmVQcm9wcyhwcm9wcyk7CiAgICAgIH0KICAgIH0sCiAgICBnZXREZWZhdWx0UHJvcHM6IGZ1bmN0aW9uIGdldERlZmF1bHRQcm9wcygpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBpbml0aWFsTGlzdFNpemU6IERFRkFVTFRfSU5JVElBTF9ST1dTLAogICAgICAgIHBhZ2VTaXplOiBERUZBVUxUX1BBR0VfU0laRSwKICAgICAgICByZW5kZXJTY3JvbGxDb21wb25lbnQ6IGZ1bmN0aW9uIHJlbmRlclNjcm9sbENvbXBvbmVudChwcm9wcykgewogICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoU2Nyb2xsVmlldywgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHByb3BzLCB7CiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAzMzgKICAgICAgICAgICAgfQogICAgICAgICAgfSkpOwogICAgICAgIH0sCiAgICAgICAgc2Nyb2xsUmVuZGVyQWhlYWREaXN0YW5jZTogREVGQVVMVF9TQ1JPTExfUkVOREVSX0FIRUFELAogICAgICAgIG9uRW5kUmVhY2hlZFRocmVzaG9sZDogREVGQVVMVF9FTkRfUkVBQ0hFRF9USFJFU0hPTEQsCiAgICAgICAgc3RpY2t5U2VjdGlvbkhlYWRlcnNFbmFibGVkOiBQbGF0Zm9ybS5PUyA9PT0gJ2lvcycsCiAgICAgICAgc3RpY2t5SGVhZGVySW5kaWNlczogW10KICAgICAgfTsKICAgIH0sCiAgICBnZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uIGdldEluaXRpYWxTdGF0ZSgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBjdXJSZW5kZXJlZFJvd3NDb3VudDogdGhpcy5wcm9wcy5pbml0aWFsTGlzdFNpemUsCiAgICAgICAgaGlnaGxpZ2h0ZWRSb3c6IHt9CiAgICAgIH07CiAgICB9LAogICAgZ2V0SW5uZXJWaWV3Tm9kZTogZnVuY3Rpb24gZ2V0SW5uZXJWaWV3Tm9kZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3Njcm9sbENvbXBvbmVudC5nZXRJbm5lclZpZXdOb2RlKCk7CiAgICB9LAogICAgY29tcG9uZW50V2lsbE1vdW50OiBmdW5jdGlvbiBjb21wb25lbnRXaWxsTW91bnQoKSB7CiAgICAgIHRoaXMuc2Nyb2xsUHJvcGVydGllcyA9IHsKICAgICAgICB2aXNpYmxlTGVuZ3RoOiBudWxsLAogICAgICAgIGNvbnRlbnRMZW5ndGg6IG51bGwsCiAgICAgICAgb2Zmc2V0OiAwCiAgICAgIH07CiAgICAgIHRoaXMuX2NoaWxkRnJhbWVzID0gW107CiAgICAgIHRoaXMuX3Zpc2libGVSb3dzID0ge307CiAgICAgIHRoaXMuX3ByZXZSZW5kZXJlZFJvd3NDb3VudCA9IDA7CiAgICAgIHRoaXMuX3NlbnRFbmRGb3JDb250ZW50TGVuZ3RoID0gbnVsbDsKICAgIH0sCiAgICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24gY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB0aGlzLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMuX21lYXN1cmVBbmRVcGRhdGVTY3JvbGxQcm9wcygpOwogICAgICB9KTsKICAgIH0sCiAgICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzOiBmdW5jdGlvbiBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wcykgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIGlmICh0aGlzLnByb3BzLmRhdGFTb3VyY2UgIT09IG5leHRQcm9wcy5kYXRhU291cmNlIHx8IHRoaXMucHJvcHMuaW5pdGlhbExpc3RTaXplICE9PSBuZXh0UHJvcHMuaW5pdGlhbExpc3RTaXplKSB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZShmdW5jdGlvbiAoc3RhdGUsIHByb3BzKSB7CiAgICAgICAgICBfdGhpczIuX3ByZXZSZW5kZXJlZFJvd3NDb3VudCA9IDA7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBjdXJSZW5kZXJlZFJvd3NDb3VudDogTWF0aC5taW4oTWF0aC5tYXgoc3RhdGUuY3VyUmVuZGVyZWRSb3dzQ291bnQsIHByb3BzLmluaXRpYWxMaXN0U2l6ZSksIHByb3BzLmVuYWJsZUVtcHR5U2VjdGlvbnMgPyBwcm9wcy5kYXRhU291cmNlLmdldFJvd0FuZFNlY3Rpb25Db3VudCgpIDogcHJvcHMuZGF0YVNvdXJjZS5nZXRSb3dDb3VudCgpKQogICAgICAgICAgfTsKICAgICAgICB9LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gX3RoaXMyLl9yZW5kZXJNb3JlUm93c0lmTmVlZGVkKCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICBjb21wb25lbnREaWRVcGRhdGU6IGZ1bmN0aW9uIGNvbXBvbmVudERpZFVwZGF0ZSgpIHsKICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICB0aGlzLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMzLl9tZWFzdXJlQW5kVXBkYXRlU2Nyb2xsUHJvcHMoKTsKICAgICAgfSk7CiAgICB9LAogICAgX29uUm93SGlnaGxpZ2h0ZWQ6IGZ1bmN0aW9uIF9vblJvd0hpZ2hsaWdodGVkKHNlY3Rpb25JRCwgcm93SUQpIHsKICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgaGlnaGxpZ2h0ZWRSb3c6IHsKICAgICAgICAgIHNlY3Rpb25JRDogc2VjdGlvbklELAogICAgICAgICAgcm93SUQ6IHJvd0lECiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgdmFyIGJvZHlDb21wb25lbnRzID0gW107CiAgICAgIHZhciBkYXRhU291cmNlID0gdGhpcy5wcm9wcy5kYXRhU291cmNlOwogICAgICB2YXIgYWxsUm93SURzID0gZGF0YVNvdXJjZS5yb3dJZGVudGl0aWVzOwogICAgICB2YXIgcm93Q291bnQgPSAwOwogICAgICB2YXIgc3RpY2t5U2VjdGlvbkhlYWRlckluZGljZXMgPSBbXTsKICAgICAgdmFyIHJlbmRlclNlY3Rpb25IZWFkZXIgPSB0aGlzLnByb3BzLnJlbmRlclNlY3Rpb25IZWFkZXI7CiAgICAgIHZhciBoZWFkZXIgPSB0aGlzLnByb3BzLnJlbmRlckhlYWRlciAmJiB0aGlzLnByb3BzLnJlbmRlckhlYWRlcigpOwogICAgICB2YXIgZm9vdGVyID0gdGhpcy5wcm9wcy5yZW5kZXJGb290ZXIgJiYgdGhpcy5wcm9wcy5yZW5kZXJGb290ZXIoKTsKICAgICAgdmFyIHRvdGFsSW5kZXggPSBoZWFkZXIgPyAxIDogMDsKCiAgICAgIGZvciAodmFyIHNlY3Rpb25JZHggPSAwOyBzZWN0aW9uSWR4IDwgYWxsUm93SURzLmxlbmd0aDsgc2VjdGlvbklkeCsrKSB7CiAgICAgICAgdmFyIHNlY3Rpb25JRCA9IGRhdGFTb3VyY2Uuc2VjdGlvbklkZW50aXRpZXNbc2VjdGlvbklkeF07CiAgICAgICAgdmFyIHJvd0lEcyA9IGFsbFJvd0lEc1tzZWN0aW9uSWR4XTsKCiAgICAgICAgaWYgKHJvd0lEcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIGlmICh0aGlzLnByb3BzLmVuYWJsZUVtcHR5U2VjdGlvbnMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB2YXIgd2FybmluZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTVdLCAiZmJqcy9saWIvd2FybmluZyIpOwoKICAgICAgICAgICAgd2FybmluZyhmYWxzZSwgJ0luIG5leHQgcmVsZWFzZSBlbXB0eSBzZWN0aW9uIGhlYWRlcnMgd2lsbCBiZSByZW5kZXJlZC4nICsgIiBJbiB0aGlzIHJlbGVhc2UgeW91IGNhbiB1c2UgJ2VuYWJsZUVtcHR5U2VjdGlvbnMnIGZsYWcgdG8gcmVuZGVyIGVtcHR5IHNlY3Rpb24gaGVhZGVycy4iKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxNl0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgICAgICAgICAgIGludmFyaWFudCh0aGlzLnByb3BzLmVuYWJsZUVtcHR5U2VjdGlvbnMsICJJbiBuZXh0IHJlbGVhc2UgJ2VuYWJsZUVtcHR5U2VjdGlvbnMnIGZsYWcgd2lsbCBiZSBkZXByZWNhdGVkLCBlbXB0eSBzZWN0aW9uIGhlYWRlcnMgd2lsbCBhbHdheXMgYmUgcmVuZGVyZWQuIiArICcgSWYgZW1wdHkgc2VjdGlvbiBoZWFkZXJzIGFyZSBub3QgZGVzaXJhYmxlIHRoZWlyIGluZGljZXMgc2hvdWxkIGJlIGV4Y2x1ZGVkIGZyb20gc2VjdGlvbklEcyBvYmplY3QuJyArICIgSW4gdGhpcyByZWxlYXNlICdlbmFibGVFbXB0eVNlY3Rpb25zJyBtYXkgb25seSBoYXZlIHZhbHVlICd0cnVlJyB0byBhbGxvdyBlbXB0eSBzZWN0aW9uIGhlYWRlcnMgcmVuZGVyaW5nLiIpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHJlbmRlclNlY3Rpb25IZWFkZXIpIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gcmVuZGVyU2VjdGlvbkhlYWRlcihkYXRhU291cmNlLmdldFNlY3Rpb25IZWFkZXJEYXRhKHNlY3Rpb25JZHgpLCBzZWN0aW9uSUQpOwoKICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgIGJvZHlDb21wb25lbnRzLnB1c2goUmVhY3QuY2xvbmVFbGVtZW50KGVsZW1lbnQsIHsKICAgICAgICAgICAgICBrZXk6ICdzXycgKyBzZWN0aW9uSUQKICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgaWYgKHRoaXMucHJvcHMuc3RpY2t5U2VjdGlvbkhlYWRlcnNFbmFibGVkKSB7CiAgICAgICAgICAgICAgc3RpY2t5U2VjdGlvbkhlYWRlckluZGljZXMucHVzaCh0b3RhbEluZGV4KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdG90YWxJbmRleCsrOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgcm93SWR4ID0gMDsgcm93SWR4IDwgcm93SURzLmxlbmd0aDsgcm93SWR4KyspIHsKICAgICAgICAgIHZhciByb3dJRCA9IHJvd0lEc1tyb3dJZHhdOwogICAgICAgICAgdmFyIGNvbWJvSUQgPSBzZWN0aW9uSUQgKyAnXycgKyByb3dJRDsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGVSb3cgPSByb3dDb3VudCA+PSB0aGlzLl9wcmV2UmVuZGVyZWRSb3dzQ291bnQgJiYgZGF0YVNvdXJjZS5yb3dTaG91bGRVcGRhdGUoc2VjdGlvbklkeCwgcm93SWR4KTsKICAgICAgICAgIHZhciByb3cgPSBSZWFjdC5jcmVhdGVFbGVtZW50KFN0YXRpY1JlbmRlcmVyLCB7CiAgICAgICAgICAgIGtleTogJ3JfJyArIGNvbWJvSUQsCiAgICAgICAgICAgIHNob3VsZFVwZGF0ZTogISFzaG91bGRVcGRhdGVSb3csCiAgICAgICAgICAgIHJlbmRlcjogdGhpcy5wcm9wcy5yZW5kZXJSb3cuYmluZChudWxsLCBkYXRhU291cmNlLmdldFJvd0RhdGEoc2VjdGlvbklkeCwgcm93SWR4KSwgc2VjdGlvbklELCByb3dJRCwgdGhpcy5fb25Sb3dIaWdobGlnaHRlZCksCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA0NzMKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBib2R5Q29tcG9uZW50cy5wdXNoKHJvdyk7CiAgICAgICAgICB0b3RhbEluZGV4Kys7CgogICAgICAgICAgaWYgKHRoaXMucHJvcHMucmVuZGVyU2VwYXJhdG9yICYmIChyb3dJZHggIT09IHJvd0lEcy5sZW5ndGggLSAxIHx8IHNlY3Rpb25JZHggPT09IGFsbFJvd0lEcy5sZW5ndGggLSAxKSkgewogICAgICAgICAgICB2YXIgYWRqYWNlbnRSb3dIaWdobGlnaHRlZCA9IHRoaXMuc3RhdGUuaGlnaGxpZ2h0ZWRSb3cuc2VjdGlvbklEID09PSBzZWN0aW9uSUQgJiYgKHRoaXMuc3RhdGUuaGlnaGxpZ2h0ZWRSb3cucm93SUQgPT09IHJvd0lEIHx8IHRoaXMuc3RhdGUuaGlnaGxpZ2h0ZWRSb3cucm93SUQgPT09IHJvd0lEc1tyb3dJZHggKyAxXSk7CiAgICAgICAgICAgIHZhciBzZXBhcmF0b3IgPSB0aGlzLnByb3BzLnJlbmRlclNlcGFyYXRvcihzZWN0aW9uSUQsIHJvd0lELCBhZGphY2VudFJvd0hpZ2hsaWdodGVkKTsKCiAgICAgICAgICAgIGlmIChzZXBhcmF0b3IpIHsKICAgICAgICAgICAgICBib2R5Q29tcG9uZW50cy5wdXNoKFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgICBWaWV3LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBrZXk6ICdzXycgKyBjb21ib0lELAogICAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogNTAyCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXBhcmF0b3IKICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICB0b3RhbEluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoKytyb3dDb3VudCA9PT0gdGhpcy5zdGF0ZS5jdXJSZW5kZXJlZFJvd3NDb3VudCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChyb3dDb3VudCA+PSB0aGlzLnN0YXRlLmN1clJlbmRlcmVkUm93c0NvdW50KSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBfcHJvcHMgPSB0aGlzLnByb3BzLAogICAgICAgICAgcmVuZGVyU2Nyb2xsQ29tcG9uZW50ID0gX3Byb3BzLnJlbmRlclNjcm9sbENvbXBvbmVudCwKICAgICAgICAgIHByb3BzID0gYmFiZWxIZWxwZXJzLm9iamVjdFdpdGhvdXRQcm9wZXJ0aWVzKF9wcm9wcywgWyJyZW5kZXJTY3JvbGxDb21wb25lbnQiXSk7CgogICAgICBpZiAoIXByb3BzLnNjcm9sbEV2ZW50VGhyb3R0bGUpIHsKICAgICAgICBwcm9wcy5zY3JvbGxFdmVudFRocm90dGxlID0gREVGQVVMVF9TQ1JPTExfQ0FMTEJBQ0tfVEhST1RUTEU7CiAgICAgIH0KCiAgICAgIGlmIChwcm9wcy5yZW1vdmVDbGlwcGVkU3Vidmlld3MgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHByb3BzLnJlbW92ZUNsaXBwZWRTdWJ2aWV3cyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGJhYmVsSGVscGVycy5leHRlbmRzKHByb3BzLCB7CiAgICAgICAgb25TY3JvbGw6IHRoaXMuX29uU2Nyb2xsLAogICAgICAgIHN0aWNreUhlYWRlckluZGljZXM6IHRoaXMucHJvcHMuc3RpY2t5SGVhZGVySW5kaWNlcy5jb25jYXQoc3RpY2t5U2VjdGlvbkhlYWRlckluZGljZXMpLAogICAgICAgIG9uS2V5Ym9hcmRXaWxsU2hvdzogdW5kZWZpbmVkLAogICAgICAgIG9uS2V5Ym9hcmRXaWxsSGlkZTogdW5kZWZpbmVkLAogICAgICAgIG9uS2V5Ym9hcmREaWRTaG93OiB1bmRlZmluZWQsCiAgICAgICAgb25LZXlib2FyZERpZEhpZGU6IHVuZGVmaW5lZAogICAgICB9KTsKICAgICAgcmV0dXJuIGNsb25lUmVmZXJlbmNlZEVsZW1lbnQocmVuZGVyU2Nyb2xsQ29tcG9uZW50KHByb3BzKSwgewogICAgICAgIHJlZjogdGhpcy5fc2V0U2Nyb2xsQ29tcG9uZW50UmVmLAogICAgICAgIG9uQ29udGVudFNpemVDaGFuZ2U6IHRoaXMuX29uQ29udGVudFNpemVDaGFuZ2UsCiAgICAgICAgb25MYXlvdXQ6IHRoaXMuX29uTGF5b3V0LAogICAgICAgIERFUFJFQ0FURURfc2VuZFVwZGF0ZWRDaGlsZEZyYW1lczogdHlwZW9mIHByb3BzLm9uQ2hhbmdlVmlzaWJsZVJvd3MgIT09IHVuZGVmaW5lZAogICAgICB9LCBoZWFkZXIsIGJvZHlDb21wb25lbnRzLCBmb290ZXIpOwogICAgfSwKICAgIF9tZWFzdXJlQW5kVXBkYXRlU2Nyb2xsUHJvcHM6IGZ1bmN0aW9uIF9tZWFzdXJlQW5kVXBkYXRlU2Nyb2xsUHJvcHMoKSB7CiAgICAgIHZhciBzY3JvbGxDb21wb25lbnQgPSB0aGlzLmdldFNjcm9sbFJlc3BvbmRlcigpOwoKICAgICAgaWYgKCFzY3JvbGxDb21wb25lbnQgfHwgIXNjcm9sbENvbXBvbmVudC5nZXRJbm5lclZpZXdOb2RlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBSQ1RTY3JvbGxWaWV3TWFuYWdlciAmJiBSQ1RTY3JvbGxWaWV3TWFuYWdlci5jYWxjdWxhdGVDaGlsZEZyYW1lcyAmJiBSQ1RTY3JvbGxWaWV3TWFuYWdlci5jYWxjdWxhdGVDaGlsZEZyYW1lcyhSZWFjdE5hdGl2ZS5maW5kTm9kZUhhbmRsZShzY3JvbGxDb21wb25lbnQpLCB0aGlzLl91cGRhdGVWaXNpYmxlUm93cyk7CiAgICB9LAogICAgX3NldFNjcm9sbENvbXBvbmVudFJlZjogZnVuY3Rpb24gX3NldFNjcm9sbENvbXBvbmVudFJlZihzY3JvbGxDb21wb25lbnQpIHsKICAgICAgdGhpcy5fc2Nyb2xsQ29tcG9uZW50ID0gc2Nyb2xsQ29tcG9uZW50OwogICAgfSwKICAgIF9vbkNvbnRlbnRTaXplQ2hhbmdlOiBmdW5jdGlvbiBfb25Db250ZW50U2l6ZUNoYW5nZSh3aWR0aCwgaGVpZ2h0KSB7CiAgICAgIHZhciBjb250ZW50TGVuZ3RoID0gIXRoaXMucHJvcHMuaG9yaXpvbnRhbCA/IGhlaWdodCA6IHdpZHRoOwoKICAgICAgaWYgKGNvbnRlbnRMZW5ndGggIT09IHRoaXMuc2Nyb2xsUHJvcGVydGllcy5jb250ZW50TGVuZ3RoKSB7CiAgICAgICAgdGhpcy5zY3JvbGxQcm9wZXJ0aWVzLmNvbnRlbnRMZW5ndGggPSBjb250ZW50TGVuZ3RoOwoKICAgICAgICB0aGlzLl91cGRhdGVWaXNpYmxlUm93cygpOwoKICAgICAgICB0aGlzLl9yZW5kZXJNb3JlUm93c0lmTmVlZGVkKCk7CiAgICAgIH0KCiAgICAgIHRoaXMucHJvcHMub25Db250ZW50U2l6ZUNoYW5nZSAmJiB0aGlzLnByb3BzLm9uQ29udGVudFNpemVDaGFuZ2Uod2lkdGgsIGhlaWdodCk7CiAgICB9LAogICAgX29uTGF5b3V0OiBmdW5jdGlvbiBfb25MYXlvdXQoZXZlbnQpIHsKICAgICAgdmFyIF9ldmVudCRuYXRpdmVFdmVudCRsYSA9IGV2ZW50Lm5hdGl2ZUV2ZW50LmxheW91dCwKICAgICAgICAgIHdpZHRoID0gX2V2ZW50JG5hdGl2ZUV2ZW50JGxhLndpZHRoLAogICAgICAgICAgaGVpZ2h0ID0gX2V2ZW50JG5hdGl2ZUV2ZW50JGxhLmhlaWdodDsKICAgICAgdmFyIHZpc2libGVMZW5ndGggPSAhdGhpcy5wcm9wcy5ob3Jpem9udGFsID8gaGVpZ2h0IDogd2lkdGg7CgogICAgICBpZiAodmlzaWJsZUxlbmd0aCAhPT0gdGhpcy5zY3JvbGxQcm9wZXJ0aWVzLnZpc2libGVMZW5ndGgpIHsKICAgICAgICB0aGlzLnNjcm9sbFByb3BlcnRpZXMudmlzaWJsZUxlbmd0aCA9IHZpc2libGVMZW5ndGg7CgogICAgICAgIHRoaXMuX3VwZGF0ZVZpc2libGVSb3dzKCk7CgogICAgICAgIHRoaXMuX3JlbmRlck1vcmVSb3dzSWZOZWVkZWQoKTsKICAgICAgfQoKICAgICAgdGhpcy5wcm9wcy5vbkxheW91dCAmJiB0aGlzLnByb3BzLm9uTGF5b3V0KGV2ZW50KTsKICAgIH0sCiAgICBfbWF5YmVDYWxsT25FbmRSZWFjaGVkOiBmdW5jdGlvbiBfbWF5YmVDYWxsT25FbmRSZWFjaGVkKGV2ZW50KSB7CiAgICAgIGlmICh0aGlzLnByb3BzLm9uRW5kUmVhY2hlZCAmJiB0aGlzLnNjcm9sbFByb3BlcnRpZXMuY29udGVudExlbmd0aCAhPT0gdGhpcy5fc2VudEVuZEZvckNvbnRlbnRMZW5ndGggJiYgdGhpcy5fZ2V0RGlzdGFuY2VGcm9tRW5kKHRoaXMuc2Nyb2xsUHJvcGVydGllcykgPCB0aGlzLnByb3BzLm9uRW5kUmVhY2hlZFRocmVzaG9sZCAmJiB0aGlzLnN0YXRlLmN1clJlbmRlcmVkUm93c0NvdW50ID09PSAodGhpcy5wcm9wcy5lbmFibGVFbXB0eVNlY3Rpb25zID8gdGhpcy5wcm9wcy5kYXRhU291cmNlLmdldFJvd0FuZFNlY3Rpb25Db3VudCgpIDogdGhpcy5wcm9wcy5kYXRhU291cmNlLmdldFJvd0NvdW50KCkpKSB7CiAgICAgICAgdGhpcy5fc2VudEVuZEZvckNvbnRlbnRMZW5ndGggPSB0aGlzLnNjcm9sbFByb3BlcnRpZXMuY29udGVudExlbmd0aDsKICAgICAgICB0aGlzLnByb3BzLm9uRW5kUmVhY2hlZChldmVudCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICBfcmVuZGVyTW9yZVJvd3NJZk5lZWRlZDogZnVuY3Rpb24gX3JlbmRlck1vcmVSb3dzSWZOZWVkZWQoKSB7CiAgICAgIGlmICh0aGlzLnNjcm9sbFByb3BlcnRpZXMuY29udGVudExlbmd0aCA9PT0gbnVsbCB8fCB0aGlzLnNjcm9sbFByb3BlcnRpZXMudmlzaWJsZUxlbmd0aCA9PT0gbnVsbCB8fCB0aGlzLnN0YXRlLmN1clJlbmRlcmVkUm93c0NvdW50ID09PSAodGhpcy5wcm9wcy5lbmFibGVFbXB0eVNlY3Rpb25zID8gdGhpcy5wcm9wcy5kYXRhU291cmNlLmdldFJvd0FuZFNlY3Rpb25Db3VudCgpIDogdGhpcy5wcm9wcy5kYXRhU291cmNlLmdldFJvd0NvdW50KCkpKSB7CiAgICAgICAgdGhpcy5fbWF5YmVDYWxsT25FbmRSZWFjaGVkKCk7CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGRpc3RhbmNlRnJvbUVuZCA9IHRoaXMuX2dldERpc3RhbmNlRnJvbUVuZCh0aGlzLnNjcm9sbFByb3BlcnRpZXMpOwoKICAgICAgaWYgKGRpc3RhbmNlRnJvbUVuZCA8IHRoaXMucHJvcHMuc2Nyb2xsUmVuZGVyQWhlYWREaXN0YW5jZSkgewogICAgICAgIHRoaXMuX3BhZ2VJbk5ld1Jvd3MoKTsKICAgICAgfQogICAgfSwKICAgIF9wYWdlSW5OZXdSb3dzOiBmdW5jdGlvbiBfcGFnZUluTmV3Um93cygpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICB0aGlzLnNldFN0YXRlKGZ1bmN0aW9uIChzdGF0ZSwgcHJvcHMpIHsKICAgICAgICB2YXIgcm93c1RvUmVuZGVyID0gTWF0aC5taW4oc3RhdGUuY3VyUmVuZGVyZWRSb3dzQ291bnQgKyBwcm9wcy5wYWdlU2l6ZSwgcHJvcHMuZW5hYmxlRW1wdHlTZWN0aW9ucyA/IHByb3BzLmRhdGFTb3VyY2UuZ2V0Um93QW5kU2VjdGlvbkNvdW50KCkgOiBwcm9wcy5kYXRhU291cmNlLmdldFJvd0NvdW50KCkpOwogICAgICAgIF90aGlzNC5fcHJldlJlbmRlcmVkUm93c0NvdW50ID0gc3RhdGUuY3VyUmVuZGVyZWRSb3dzQ291bnQ7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGN1clJlbmRlcmVkUm93c0NvdW50OiByb3dzVG9SZW5kZXIKICAgICAgICB9OwogICAgICB9LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXM0Ll9tZWFzdXJlQW5kVXBkYXRlU2Nyb2xsUHJvcHMoKTsKCiAgICAgICAgX3RoaXM0Ll9wcmV2UmVuZGVyZWRSb3dzQ291bnQgPSBfdGhpczQuc3RhdGUuY3VyUmVuZGVyZWRSb3dzQ291bnQ7CiAgICAgIH0pOwogICAgfSwKICAgIF9nZXREaXN0YW5jZUZyb21FbmQ6IGZ1bmN0aW9uIF9nZXREaXN0YW5jZUZyb21FbmQoc2Nyb2xsUHJvcGVydGllcykgewogICAgICByZXR1cm4gc2Nyb2xsUHJvcGVydGllcy5jb250ZW50TGVuZ3RoIC0gc2Nyb2xsUHJvcGVydGllcy52aXNpYmxlTGVuZ3RoIC0gc2Nyb2xsUHJvcGVydGllcy5vZmZzZXQ7CiAgICB9LAogICAgX3VwZGF0ZVZpc2libGVSb3dzOiBmdW5jdGlvbiBfdXBkYXRlVmlzaWJsZVJvd3ModXBkYXRlZEZyYW1lcykgewogICAgICB2YXIgX3RoaXM1ID0gdGhpczsKCiAgICAgIGlmICghdGhpcy5wcm9wcy5vbkNoYW5nZVZpc2libGVSb3dzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodXBkYXRlZEZyYW1lcykgewogICAgICAgIHVwZGF0ZWRGcmFtZXMuZm9yRWFjaChmdW5jdGlvbiAobmV3RnJhbWUpIHsKICAgICAgICAgIF90aGlzNS5fY2hpbGRGcmFtZXNbbmV3RnJhbWUuaW5kZXhdID0gbWVyZ2UobmV3RnJhbWUpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICB2YXIgaXNWZXJ0aWNhbCA9ICF0aGlzLnByb3BzLmhvcml6b250YWw7CiAgICAgIHZhciBkYXRhU291cmNlID0gdGhpcy5wcm9wcy5kYXRhU291cmNlOwogICAgICB2YXIgdmlzaWJsZU1pbiA9IHRoaXMuc2Nyb2xsUHJvcGVydGllcy5vZmZzZXQ7CiAgICAgIHZhciB2aXNpYmxlTWF4ID0gdmlzaWJsZU1pbiArIHRoaXMuc2Nyb2xsUHJvcGVydGllcy52aXNpYmxlTGVuZ3RoOwogICAgICB2YXIgYWxsUm93SURzID0gZGF0YVNvdXJjZS5yb3dJZGVudGl0aWVzOwogICAgICB2YXIgaGVhZGVyID0gdGhpcy5wcm9wcy5yZW5kZXJIZWFkZXIgJiYgdGhpcy5wcm9wcy5yZW5kZXJIZWFkZXIoKTsKICAgICAgdmFyIHRvdGFsSW5kZXggPSBoZWFkZXIgPyAxIDogMDsKICAgICAgdmFyIHZpc2liaWxpdHlDaGFuZ2VkID0gZmFsc2U7CiAgICAgIHZhciBjaGFuZ2VkUm93cyA9IHt9OwoKICAgICAgZm9yICh2YXIgc2VjdGlvbklkeCA9IDA7IHNlY3Rpb25JZHggPCBhbGxSb3dJRHMubGVuZ3RoOyBzZWN0aW9uSWR4KyspIHsKICAgICAgICB2YXIgcm93SURzID0gYWxsUm93SURzW3NlY3Rpb25JZHhdOwoKICAgICAgICBpZiAocm93SURzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgc2VjdGlvbklEID0gZGF0YVNvdXJjZS5zZWN0aW9uSWRlbnRpdGllc1tzZWN0aW9uSWR4XTsKCiAgICAgICAgaWYgKHRoaXMucHJvcHMucmVuZGVyU2VjdGlvbkhlYWRlcikgewogICAgICAgICAgdG90YWxJbmRleCsrOwogICAgICAgIH0KCiAgICAgICAgdmFyIHZpc2libGVTZWN0aW9uID0gdGhpcy5fdmlzaWJsZVJvd3Nbc2VjdGlvbklEXTsKCiAgICAgICAgaWYgKCF2aXNpYmxlU2VjdGlvbikgewogICAgICAgICAgdmlzaWJsZVNlY3Rpb24gPSB7fTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIHJvd0lkeCA9IDA7IHJvd0lkeCA8IHJvd0lEcy5sZW5ndGg7IHJvd0lkeCsrKSB7CiAgICAgICAgICB2YXIgcm93SUQgPSByb3dJRHNbcm93SWR4XTsKICAgICAgICAgIHZhciBmcmFtZSA9IHRoaXMuX2NoaWxkRnJhbWVzW3RvdGFsSW5kZXhdOwogICAgICAgICAgdG90YWxJbmRleCsrOwoKICAgICAgICAgIGlmICh0aGlzLnByb3BzLnJlbmRlclNlcGFyYXRvciAmJiAocm93SWR4ICE9PSByb3dJRHMubGVuZ3RoIC0gMSB8fCBzZWN0aW9uSWR4ID09PSBhbGxSb3dJRHMubGVuZ3RoIC0gMSkpIHsKICAgICAgICAgICAgdG90YWxJbmRleCsrOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghZnJhbWUpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHJvd1Zpc2libGUgPSB2aXNpYmxlU2VjdGlvbltyb3dJRF07CiAgICAgICAgICB2YXIgbWluID0gaXNWZXJ0aWNhbCA/IGZyYW1lLnkgOiBmcmFtZS54OwogICAgICAgICAgdmFyIG1heCA9IG1pbiArIChpc1ZlcnRpY2FsID8gZnJhbWUuaGVpZ2h0IDogZnJhbWUud2lkdGgpOwoKICAgICAgICAgIGlmICghbWluICYmICFtYXggfHwgbWluID09PSBtYXgpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG1pbiA+IHZpc2libGVNYXggfHwgbWF4IDwgdmlzaWJsZU1pbikgewogICAgICAgICAgICBpZiAocm93VmlzaWJsZSkgewogICAgICAgICAgICAgIHZpc2liaWxpdHlDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICBkZWxldGUgdmlzaWJsZVNlY3Rpb25bcm93SURdOwoKICAgICAgICAgICAgICBpZiAoIWNoYW5nZWRSb3dzW3NlY3Rpb25JRF0pIHsKICAgICAgICAgICAgICAgIGNoYW5nZWRSb3dzW3NlY3Rpb25JRF0gPSB7fTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNoYW5nZWRSb3dzW3NlY3Rpb25JRF1bcm93SURdID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoIXJvd1Zpc2libGUpIHsKICAgICAgICAgICAgdmlzaWJpbGl0eUNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICB2aXNpYmxlU2VjdGlvbltyb3dJRF0gPSB0cnVlOwoKICAgICAgICAgICAgaWYgKCFjaGFuZ2VkUm93c1tzZWN0aW9uSURdKSB7CiAgICAgICAgICAgICAgY2hhbmdlZFJvd3Nbc2VjdGlvbklEXSA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBjaGFuZ2VkUm93c1tzZWN0aW9uSURdW3Jvd0lEXSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWlzRW1wdHkodmlzaWJsZVNlY3Rpb24pKSB7CiAgICAgICAgICB0aGlzLl92aXNpYmxlUm93c1tzZWN0aW9uSURdID0gdmlzaWJsZVNlY3Rpb247CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl92aXNpYmxlUm93c1tzZWN0aW9uSURdKSB7CiAgICAgICAgICBkZWxldGUgdGhpcy5fdmlzaWJsZVJvd3Nbc2VjdGlvbklEXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZpc2liaWxpdHlDaGFuZ2VkICYmIHRoaXMucHJvcHMub25DaGFuZ2VWaXNpYmxlUm93cyh0aGlzLl92aXNpYmxlUm93cywgY2hhbmdlZFJvd3MpOwogICAgfSwKICAgIF9vblNjcm9sbDogZnVuY3Rpb24gX29uU2Nyb2xsKGUpIHsKICAgICAgdmFyIGlzVmVydGljYWwgPSAhdGhpcy5wcm9wcy5ob3Jpem9udGFsOwogICAgICB0aGlzLnNjcm9sbFByb3BlcnRpZXMudmlzaWJsZUxlbmd0aCA9IGUubmF0aXZlRXZlbnQubGF5b3V0TWVhc3VyZW1lbnRbaXNWZXJ0aWNhbCA/ICdoZWlnaHQnIDogJ3dpZHRoJ107CiAgICAgIHRoaXMuc2Nyb2xsUHJvcGVydGllcy5jb250ZW50TGVuZ3RoID0gZS5uYXRpdmVFdmVudC5jb250ZW50U2l6ZVtpc1ZlcnRpY2FsID8gJ2hlaWdodCcgOiAnd2lkdGgnXTsKICAgICAgdGhpcy5zY3JvbGxQcm9wZXJ0aWVzLm9mZnNldCA9IGUubmF0aXZlRXZlbnQuY29udGVudE9mZnNldFtpc1ZlcnRpY2FsID8gJ3knIDogJ3gnXTsKCiAgICAgIHRoaXMuX3VwZGF0ZVZpc2libGVSb3dzKGUubmF0aXZlRXZlbnQudXBkYXRlZENoaWxkRnJhbWVzKTsKCiAgICAgIGlmICghdGhpcy5fbWF5YmVDYWxsT25FbmRSZWFjaGVkKGUpKSB7CiAgICAgICAgdGhpcy5fcmVuZGVyTW9yZVJvd3NJZk5lZWRlZCgpOwogICAgICB9CgogICAgICBpZiAodGhpcy5wcm9wcy5vbkVuZFJlYWNoZWQgJiYgdGhpcy5fZ2V0RGlzdGFuY2VGcm9tRW5kKHRoaXMuc2Nyb2xsUHJvcGVydGllcykgPiB0aGlzLnByb3BzLm9uRW5kUmVhY2hlZFRocmVzaG9sZCkgewogICAgICAgIHRoaXMuX3NlbnRFbmRGb3JDb250ZW50TGVuZ3RoID0gbnVsbDsKICAgICAgfQoKICAgICAgdGhpcy5wcm9wcy5vblNjcm9sbCAmJiB0aGlzLnByb3BzLm9uU2Nyb2xsKGUpOwogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gTGlzdFZpZXc7Cn0sMjQxLFsyNDIsNTIsMTMwLDEyNywyMSwxNSwyMjQsMjI2LDI0NCwxOTEsMTcwLDI0NSwxNzIsMjQzLDEzNCw1NiwxM10sIkxpc3RWaWV3Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgaXNFbXB0eSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJpc0VtcHR5Iik7CgogIHZhciB3YXJuaW5nID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgImZianMvbGliL3dhcm5pbmciKTsKCiAgZnVuY3Rpb24gZGVmYXVsdEdldFJvd0RhdGEoZGF0YUJsb2IsIHNlY3Rpb25JRCwgcm93SUQpIHsKICAgIHJldHVybiBkYXRhQmxvYltzZWN0aW9uSURdW3Jvd0lEXTsKICB9CgogIGZ1bmN0aW9uIGRlZmF1bHRHZXRTZWN0aW9uSGVhZGVyRGF0YShkYXRhQmxvYiwgc2VjdGlvbklEKSB7CiAgICByZXR1cm4gZGF0YUJsb2Jbc2VjdGlvbklEXTsKICB9CgogIHZhciBMaXN0Vmlld0RhdGFTb3VyY2UgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBMaXN0Vmlld0RhdGFTb3VyY2UocGFyYW1zKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBMaXN0Vmlld0RhdGFTb3VyY2UpOwogICAgICBpbnZhcmlhbnQocGFyYW1zICYmIHR5cGVvZiBwYXJhbXMucm93SGFzQ2hhbmdlZCA9PT0gJ2Z1bmN0aW9uJywgJ011c3QgcHJvdmlkZSBhIHJvd0hhc0NoYW5nZWQgZnVuY3Rpb24uJyk7CiAgICAgIHRoaXMuX3Jvd0hhc0NoYW5nZWQgPSBwYXJhbXMucm93SGFzQ2hhbmdlZDsKICAgICAgdGhpcy5fZ2V0Um93RGF0YSA9IHBhcmFtcy5nZXRSb3dEYXRhIHx8IGRlZmF1bHRHZXRSb3dEYXRhOwogICAgICB0aGlzLl9zZWN0aW9uSGVhZGVySGFzQ2hhbmdlZCA9IHBhcmFtcy5zZWN0aW9uSGVhZGVySGFzQ2hhbmdlZDsKICAgICAgdGhpcy5fZ2V0U2VjdGlvbkhlYWRlckRhdGEgPSBwYXJhbXMuZ2V0U2VjdGlvbkhlYWRlckRhdGEgfHwgZGVmYXVsdEdldFNlY3Rpb25IZWFkZXJEYXRhOwogICAgICB0aGlzLl9kYXRhQmxvYiA9IG51bGw7CiAgICAgIHRoaXMuX2RpcnR5Um93cyA9IFtdOwogICAgICB0aGlzLl9kaXJ0eVNlY3Rpb25zID0gW107CiAgICAgIHRoaXMuX2NhY2hlZFJvd0NvdW50ID0gMDsKICAgICAgdGhpcy5yb3dJZGVudGl0aWVzID0gW107CiAgICAgIHRoaXMuc2VjdGlvbklkZW50aXRpZXMgPSBbXTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoTGlzdFZpZXdEYXRhU291cmNlLCBbewogICAgICBrZXk6ICJjbG9uZVdpdGhSb3dzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNsb25lV2l0aFJvd3MoZGF0YUJsb2IsIHJvd0lkZW50aXRpZXMpIHsKICAgICAgICB2YXIgcm93SWRzID0gcm93SWRlbnRpdGllcyA/IFtbXS5jb25jYXQoYmFiZWxIZWxwZXJzLnRvQ29uc3VtYWJsZUFycmF5KHJvd0lkZW50aXRpZXMpKV0gOiBudWxsOwoKICAgICAgICBpZiAoIXRoaXMuX3NlY3Rpb25IZWFkZXJIYXNDaGFuZ2VkKSB7CiAgICAgICAgICB0aGlzLl9zZWN0aW9uSGVhZGVySGFzQ2hhbmdlZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmNsb25lV2l0aFJvd3NBbmRTZWN0aW9ucyh7CiAgICAgICAgICBzMTogZGF0YUJsb2IKICAgICAgICB9LCBbJ3MxJ10sIHJvd0lkcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY2xvbmVXaXRoUm93c0FuZFNlY3Rpb25zIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNsb25lV2l0aFJvd3NBbmRTZWN0aW9ucyhkYXRhQmxvYiwgc2VjdGlvbklkZW50aXRpZXMsIHJvd0lkZW50aXRpZXMpIHsKICAgICAgICBpbnZhcmlhbnQodHlwZW9mIHRoaXMuX3NlY3Rpb25IZWFkZXJIYXNDaGFuZ2VkID09PSAnZnVuY3Rpb24nLCAnTXVzdCBwcm92aWRlIGEgc2VjdGlvbkhlYWRlckhhc0NoYW5nZWQgZnVuY3Rpb24gd2l0aCBzZWN0aW9uIGRhdGEuJyk7CiAgICAgICAgaW52YXJpYW50KCFzZWN0aW9uSWRlbnRpdGllcyB8fCAhcm93SWRlbnRpdGllcyB8fCBzZWN0aW9uSWRlbnRpdGllcy5sZW5ndGggPT09IHJvd0lkZW50aXRpZXMubGVuZ3RoLCAncm93IGFuZCBzZWN0aW9uIGlkcyBsZW5ndGhzIG11c3QgYmUgdGhlIHNhbWUnKTsKICAgICAgICB2YXIgbmV3U291cmNlID0gbmV3IExpc3RWaWV3RGF0YVNvdXJjZSh7CiAgICAgICAgICBnZXRSb3dEYXRhOiB0aGlzLl9nZXRSb3dEYXRhLAogICAgICAgICAgZ2V0U2VjdGlvbkhlYWRlckRhdGE6IHRoaXMuX2dldFNlY3Rpb25IZWFkZXJEYXRhLAogICAgICAgICAgcm93SGFzQ2hhbmdlZDogdGhpcy5fcm93SGFzQ2hhbmdlZCwKICAgICAgICAgIHNlY3Rpb25IZWFkZXJIYXNDaGFuZ2VkOiB0aGlzLl9zZWN0aW9uSGVhZGVySGFzQ2hhbmdlZAogICAgICAgIH0pOwogICAgICAgIG5ld1NvdXJjZS5fZGF0YUJsb2IgPSBkYXRhQmxvYjsKCiAgICAgICAgaWYgKHNlY3Rpb25JZGVudGl0aWVzKSB7CiAgICAgICAgICBuZXdTb3VyY2Uuc2VjdGlvbklkZW50aXRpZXMgPSBzZWN0aW9uSWRlbnRpdGllczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbmV3U291cmNlLnNlY3Rpb25JZGVudGl0aWVzID0gT2JqZWN0LmtleXMoZGF0YUJsb2IpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJvd0lkZW50aXRpZXMpIHsKICAgICAgICAgIG5ld1NvdXJjZS5yb3dJZGVudGl0aWVzID0gcm93SWRlbnRpdGllczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbmV3U291cmNlLnJvd0lkZW50aXRpZXMgPSBbXTsKICAgICAgICAgIG5ld1NvdXJjZS5zZWN0aW9uSWRlbnRpdGllcy5mb3JFYWNoKGZ1bmN0aW9uIChzZWN0aW9uSUQpIHsKICAgICAgICAgICAgbmV3U291cmNlLnJvd0lkZW50aXRpZXMucHVzaChPYmplY3Qua2V5cyhkYXRhQmxvYltzZWN0aW9uSURdKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIG5ld1NvdXJjZS5fY2FjaGVkUm93Q291bnQgPSBjb3VudFJvd3MobmV3U291cmNlLnJvd0lkZW50aXRpZXMpOwoKICAgICAgICBuZXdTb3VyY2UuX2NhbGN1bGF0ZURpcnR5QXJyYXlzKHRoaXMuX2RhdGFCbG9iLCB0aGlzLnNlY3Rpb25JZGVudGl0aWVzLCB0aGlzLnJvd0lkZW50aXRpZXMpOwoKICAgICAgICByZXR1cm4gbmV3U291cmNlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFJvd0NvdW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFJvd0NvdW50KCkgewogICAgICAgIHJldHVybiB0aGlzLl9jYWNoZWRSb3dDb3VudDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRSb3dBbmRTZWN0aW9uQ291bnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0Um93QW5kU2VjdGlvbkNvdW50KCkgewogICAgICAgIHJldHVybiB0aGlzLl9jYWNoZWRSb3dDb3VudCArIHRoaXMuc2VjdGlvbklkZW50aXRpZXMubGVuZ3RoOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJvd1Nob3VsZFVwZGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByb3dTaG91bGRVcGRhdGUoc2VjdGlvbkluZGV4LCByb3dJbmRleCkgewogICAgICAgIHZhciBuZWVkc1VwZGF0ZSA9IHRoaXMuX2RpcnR5Um93c1tzZWN0aW9uSW5kZXhdW3Jvd0luZGV4XTsKICAgICAgICB3YXJuaW5nKG5lZWRzVXBkYXRlICE9PSB1bmRlZmluZWQsICdtaXNzaW5nIGRpcnR5Qml0IGZvciBzZWN0aW9uLCByb3c6ICcgKyBzZWN0aW9uSW5kZXggKyAnLCAnICsgcm93SW5kZXgpOwogICAgICAgIHJldHVybiBuZWVkc1VwZGF0ZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRSb3dEYXRhIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFJvd0RhdGEoc2VjdGlvbkluZGV4LCByb3dJbmRleCkgewogICAgICAgIHZhciBzZWN0aW9uSUQgPSB0aGlzLnNlY3Rpb25JZGVudGl0aWVzW3NlY3Rpb25JbmRleF07CiAgICAgICAgdmFyIHJvd0lEID0gdGhpcy5yb3dJZGVudGl0aWVzW3NlY3Rpb25JbmRleF1bcm93SW5kZXhdOwogICAgICAgIHdhcm5pbmcoc2VjdGlvbklEICE9PSB1bmRlZmluZWQgJiYgcm93SUQgIT09IHVuZGVmaW5lZCwgJ3JlbmRlcmluZyBpbnZhbGlkIHNlY3Rpb24sIHJvdzogJyArIHNlY3Rpb25JbmRleCArICcsICcgKyByb3dJbmRleCk7CiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFJvd0RhdGEodGhpcy5fZGF0YUJsb2IsIHNlY3Rpb25JRCwgcm93SUQpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFJvd0lERm9yRmxhdEluZGV4IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFJvd0lERm9yRmxhdEluZGV4KGluZGV4KSB7CiAgICAgICAgdmFyIGFjY2Vzc0luZGV4ID0gaW5kZXg7CgogICAgICAgIGZvciAodmFyIGlpID0gMDsgaWkgPCB0aGlzLnNlY3Rpb25JZGVudGl0aWVzLmxlbmd0aDsgaWkrKykgewogICAgICAgICAgaWYgKGFjY2Vzc0luZGV4ID49IHRoaXMucm93SWRlbnRpdGllc1tpaV0ubGVuZ3RoKSB7CiAgICAgICAgICAgIGFjY2Vzc0luZGV4IC09IHRoaXMucm93SWRlbnRpdGllc1tpaV0ubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucm93SWRlbnRpdGllc1tpaV1bYWNjZXNzSW5kZXhdOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0U2VjdGlvbklERm9yRmxhdEluZGV4IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFNlY3Rpb25JREZvckZsYXRJbmRleChpbmRleCkgewogICAgICAgIHZhciBhY2Nlc3NJbmRleCA9IGluZGV4OwoKICAgICAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgdGhpcy5zZWN0aW9uSWRlbnRpdGllcy5sZW5ndGg7IGlpKyspIHsKICAgICAgICAgIGlmIChhY2Nlc3NJbmRleCA+PSB0aGlzLnJvd0lkZW50aXRpZXNbaWldLmxlbmd0aCkgewogICAgICAgICAgICBhY2Nlc3NJbmRleCAtPSB0aGlzLnJvd0lkZW50aXRpZXNbaWldLmxlbmd0aDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNlY3Rpb25JZGVudGl0aWVzW2lpXTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFNlY3Rpb25MZW5ndGhzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFNlY3Rpb25MZW5ndGhzKCkgewogICAgICAgIHZhciByZXN1bHRzID0gW107CgogICAgICAgIGZvciAodmFyIGlpID0gMDsgaWkgPCB0aGlzLnNlY3Rpb25JZGVudGl0aWVzLmxlbmd0aDsgaWkrKykgewogICAgICAgICAgcmVzdWx0cy5wdXNoKHRoaXMucm93SWRlbnRpdGllc1tpaV0ubGVuZ3RoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNlY3Rpb25IZWFkZXJTaG91bGRVcGRhdGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2VjdGlvbkhlYWRlclNob3VsZFVwZGF0ZShzZWN0aW9uSW5kZXgpIHsKICAgICAgICB2YXIgbmVlZHNVcGRhdGUgPSB0aGlzLl9kaXJ0eVNlY3Rpb25zW3NlY3Rpb25JbmRleF07CiAgICAgICAgd2FybmluZyhuZWVkc1VwZGF0ZSAhPT0gdW5kZWZpbmVkLCAnbWlzc2luZyBkaXJ0eUJpdCBmb3Igc2VjdGlvbjogJyArIHNlY3Rpb25JbmRleCk7CiAgICAgICAgcmV0dXJuIG5lZWRzVXBkYXRlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFNlY3Rpb25IZWFkZXJEYXRhIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFNlY3Rpb25IZWFkZXJEYXRhKHNlY3Rpb25JbmRleCkgewogICAgICAgIGlmICghdGhpcy5fZ2V0U2VjdGlvbkhlYWRlckRhdGEpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNlY3Rpb25JRCA9IHRoaXMuc2VjdGlvbklkZW50aXRpZXNbc2VjdGlvbkluZGV4XTsKICAgICAgICB3YXJuaW5nKHNlY3Rpb25JRCAhPT0gdW5kZWZpbmVkLCAncmVuZGVyU2VjdGlvbiBjYWxsZWQgb24gaW52YWxpZCBzZWN0aW9uOiAnICsgc2VjdGlvbkluZGV4KTsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0U2VjdGlvbkhlYWRlckRhdGEodGhpcy5fZGF0YUJsb2IsIHNlY3Rpb25JRCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX2NhbGN1bGF0ZURpcnR5QXJyYXlzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9jYWxjdWxhdGVEaXJ0eUFycmF5cyhwcmV2RGF0YUJsb2IsIHByZXZTZWN0aW9uSURzLCBwcmV2Um93SURzKSB7CiAgICAgICAgdmFyIHByZXZTZWN0aW9uc0hhc2ggPSBrZXllZERpY3Rpb25hcnlGcm9tQXJyYXkocHJldlNlY3Rpb25JRHMpOwogICAgICAgIHZhciBwcmV2Um93c0hhc2ggPSB7fTsKCiAgICAgICAgZm9yICh2YXIgaWkgPSAwOyBpaSA8IHByZXZSb3dJRHMubGVuZ3RoOyBpaSsrKSB7CiAgICAgICAgICB2YXIgc2VjdGlvbklEID0gcHJldlNlY3Rpb25JRHNbaWldOwogICAgICAgICAgd2FybmluZyghcHJldlJvd3NIYXNoW3NlY3Rpb25JRF0sICdTZWN0aW9uSUQgYXBwZWFycyBtb3JlIHRoYW4gb25jZTogJyArIHNlY3Rpb25JRCk7CiAgICAgICAgICBwcmV2Um93c0hhc2hbc2VjdGlvbklEXSA9IGtleWVkRGljdGlvbmFyeUZyb21BcnJheShwcmV2Um93SURzW2lpXSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9kaXJ0eVNlY3Rpb25zID0gW107CiAgICAgICAgdGhpcy5fZGlydHlSb3dzID0gW107CiAgICAgICAgdmFyIGRpcnR5OwoKICAgICAgICBmb3IgKHZhciBzSW5kZXggPSAwOyBzSW5kZXggPCB0aGlzLnNlY3Rpb25JZGVudGl0aWVzLmxlbmd0aDsgc0luZGV4KyspIHsKICAgICAgICAgIHZhciBzZWN0aW9uSUQgPSB0aGlzLnNlY3Rpb25JZGVudGl0aWVzW3NJbmRleF07CiAgICAgICAgICBkaXJ0eSA9ICFwcmV2U2VjdGlvbnNIYXNoW3NlY3Rpb25JRF07CiAgICAgICAgICB2YXIgc2VjdGlvbkhlYWRlckhhc0NoYW5nZWQgPSB0aGlzLl9zZWN0aW9uSGVhZGVySGFzQ2hhbmdlZDsKCiAgICAgICAgICBpZiAoIWRpcnR5ICYmIHNlY3Rpb25IZWFkZXJIYXNDaGFuZ2VkKSB7CiAgICAgICAgICAgIGRpcnR5ID0gc2VjdGlvbkhlYWRlckhhc0NoYW5nZWQodGhpcy5fZ2V0U2VjdGlvbkhlYWRlckRhdGEocHJldkRhdGFCbG9iLCBzZWN0aW9uSUQpLCB0aGlzLl9nZXRTZWN0aW9uSGVhZGVyRGF0YSh0aGlzLl9kYXRhQmxvYiwgc2VjdGlvbklEKSk7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5fZGlydHlTZWN0aW9ucy5wdXNoKCEhZGlydHkpOwoKICAgICAgICAgIHRoaXMuX2RpcnR5Um93c1tzSW5kZXhdID0gW107CgogICAgICAgICAgZm9yICh2YXIgckluZGV4ID0gMDsgckluZGV4IDwgdGhpcy5yb3dJZGVudGl0aWVzW3NJbmRleF0ubGVuZ3RoOyBySW5kZXgrKykgewogICAgICAgICAgICB2YXIgcm93SUQgPSB0aGlzLnJvd0lkZW50aXRpZXNbc0luZGV4XVtySW5kZXhdOwogICAgICAgICAgICBkaXJ0eSA9ICFwcmV2U2VjdGlvbnNIYXNoW3NlY3Rpb25JRF0gfHwgIXByZXZSb3dzSGFzaFtzZWN0aW9uSURdW3Jvd0lEXSB8fCB0aGlzLl9yb3dIYXNDaGFuZ2VkKHRoaXMuX2dldFJvd0RhdGEocHJldkRhdGFCbG9iLCBzZWN0aW9uSUQsIHJvd0lEKSwgdGhpcy5fZ2V0Um93RGF0YSh0aGlzLl9kYXRhQmxvYiwgc2VjdGlvbklELCByb3dJRCkpOwoKICAgICAgICAgICAgdGhpcy5fZGlydHlSb3dzW3NJbmRleF0ucHVzaCghIWRpcnR5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBMaXN0Vmlld0RhdGFTb3VyY2U7CiAgfSgpOwoKICBmdW5jdGlvbiBjb3VudFJvd3MoYWxsUm93SURzKSB7CiAgICB2YXIgdG90YWxSb3dzID0gMDsKCiAgICBmb3IgKHZhciBzZWN0aW9uSWR4ID0gMDsgc2VjdGlvbklkeCA8IGFsbFJvd0lEcy5sZW5ndGg7IHNlY3Rpb25JZHgrKykgewogICAgICB2YXIgcm93SURzID0gYWxsUm93SURzW3NlY3Rpb25JZHhdOwogICAgICB0b3RhbFJvd3MgKz0gcm93SURzLmxlbmd0aDsKICAgIH0KCiAgICByZXR1cm4gdG90YWxSb3dzOwogIH0KCiAgZnVuY3Rpb24ga2V5ZWREaWN0aW9uYXJ5RnJvbUFycmF5KGFycikgewogICAgaWYgKGlzRW1wdHkoYXJyKSkgewogICAgICByZXR1cm4ge307CiAgICB9CgogICAgdmFyIHJlc3VsdCA9IHt9OwoKICAgIGZvciAodmFyIGlpID0gMDsgaWkgPCBhcnIubGVuZ3RoOyBpaSsrKSB7CiAgICAgIHZhciBrZXkgPSBhcnJbaWldOwogICAgICB3YXJuaW5nKCFyZXN1bHRba2V5XSwgJ1ZhbHVlIGFwcGVhcnMgbW9yZSB0aGFuIG9uY2UgaW4gYXJyYXk6ICcgKyBrZXkpOwogICAgICByZXN1bHRba2V5XSA9IHRydWU7CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gTGlzdFZpZXdEYXRhU291cmNlOwp9LDI0MixbMTMsMjQzLDU2XSwiTGlzdFZpZXdEYXRhU291cmNlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBpc0VtcHR5KG9iaikgewogICAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewogICAgICByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpIHsKICAgICAgZm9yICh2YXIgaSBpbiBvYmopIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICFvYmo7CiAgICB9CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGlzRW1wdHk7Cn0sMjQzLFtdLCJpc0VtcHR5Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2NsYXNzLCBfdGVtcDsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0Iik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgU3RhdGljUmVuZGVyZXIgPSAoX3RlbXAgPSBfY2xhc3MgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKFN0YXRpY1JlbmRlcmVyLCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBTdGF0aWNSZW5kZXJlcigpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFN0YXRpY1JlbmRlcmVyKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChTdGF0aWNSZW5kZXJlci5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKFN0YXRpY1JlbmRlcmVyKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFN0YXRpY1JlbmRlcmVyLCBbewogICAgICBrZXk6ICJzaG91bGRDb21wb25lbnRVcGRhdGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5leHRQcm9wcykgewogICAgICAgIHJldHVybiBuZXh0UHJvcHMuc2hvdWxkVXBkYXRlOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMucmVuZGVyKCk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBTdGF0aWNSZW5kZXJlcjsKICB9KFJlYWN0LkNvbXBvbmVudCksIF9jbGFzcy5wcm9wVHlwZXMgPSB7CiAgICBzaG91bGRVcGRhdGU6IFByb3BUeXBlcy5ib29sLmlzUmVxdWlyZWQsCiAgICByZW5kZXI6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQKICB9LCBfdGVtcCk7CiAgbW9kdWxlLmV4cG9ydHMgPSBTdGF0aWNSZW5kZXJlcjsKfSwyNDQsWzEzMCwxMjddLCJTdGF0aWNSZW5kZXJlciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgInJlYWN0Iik7CgogIGZ1bmN0aW9uIGNsb25lUmVmZXJlbmNlZEVsZW1lbnQoZWxlbWVudCwgY29uZmlnKSB7CiAgICB2YXIgY2xvbmVSZWYgPSBjb25maWcucmVmOwogICAgdmFyIG9yaWdpbmFsUmVmID0gZWxlbWVudC5yZWY7CgogICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGNoaWxkcmVuID0gQXJyYXkoX2xlbiA+IDIgPyBfbGVuIC0gMiA6IDApLCBfa2V5ID0gMjsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICBjaGlsZHJlbltfa2V5IC0gMl0gPSBhcmd1bWVudHNbX2tleV07CiAgICB9CgogICAgaWYgKG9yaWdpbmFsUmVmID09IG51bGwgfHwgY2xvbmVSZWYgPT0gbnVsbCkgewogICAgICByZXR1cm4gUmVhY3QuY2xvbmVFbGVtZW50LmFwcGx5KFJlYWN0LCBbZWxlbWVudCwgY29uZmlnXS5jb25jYXQoY2hpbGRyZW4pKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIG9yaWdpbmFsUmVmICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdDbG9uaW5nIGFuIGVsZW1lbnQgd2l0aCBhIHJlZiB0aGF0IHdpbGwgYmUgb3ZlcndyaXR0ZW4gYmVjYXVzZSBpdCAnICsgJ2lzIG5vdCBhIGZ1bmN0aW9uLiBVc2UgYSBjb21wb3NhYmxlIGNhbGxiYWNrLXN0eWxlIHJlZiBpbnN0ZWFkLiAnICsgJ0lnbm9yaW5nIHJlZjogJyArIG9yaWdpbmFsUmVmKTsKICAgICAgfQoKICAgICAgcmV0dXJuIFJlYWN0LmNsb25lRWxlbWVudC5hcHBseShSZWFjdCwgW2VsZW1lbnQsIGNvbmZpZ10uY29uY2F0KGNoaWxkcmVuKSk7CiAgICB9CgogICAgcmV0dXJuIFJlYWN0LmNsb25lRWxlbWVudC5hcHBseShSZWFjdCwgW2VsZW1lbnQsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBjb25maWcsIHsKICAgICAgcmVmOiBmdW5jdGlvbiByZWYoY29tcG9uZW50KSB7CiAgICAgICAgY2xvbmVSZWYoY29tcG9uZW50KTsKICAgICAgICBvcmlnaW5hbFJlZihjb21wb25lbnQpOwogICAgICB9CiAgICB9KV0uY29uY2F0KGNoaWxkcmVuKSk7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGNsb25lUmVmZXJlbmNlZEVsZW1lbnQ7Cn0sMjQ1LFsxMDhdLCJyZWFjdC1jbG9uZS1yZWZlcmVuY2VkLWVsZW1lbnQvY2xvbmVSZWZlcmVuY2VkRWxlbWVudC5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvbXBvbmVudHMvUmVmcmVzaENvbnRyb2wvUmVmcmVzaENvbnRyb2wuanMiOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBOYXRpdmVNZXRob2RzTWl4aW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiTmF0aXZlTWV0aG9kc01peGluIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJQbGF0Zm9ybSIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUmVhY3QiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJwcm9wLXR5cGVzIik7CgogIHZhciBWaWV3UHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgIlZpZXdQcm9wVHlwZXMiKTsKCiAgdmFyIGNyZWF0ZVJlYWN0Q2xhc3MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAiY3JlYXRlLXJlYWN0LWNsYXNzIik7CgogIHZhciByZXF1aXJlTmF0aXZlQ29tcG9uZW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgInJlcXVpcmVOYXRpdmVDb21wb25lbnQiKTsKCiAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHsKICAgIHZhciBSZWZyZXNoTGF5b3V0Q29uc3RzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4XSwgIlVJTWFuYWdlciIpLkFuZHJvaWRTd2lwZVJlZnJlc2hMYXlvdXQuQ29uc3RhbnRzOwogIH0gZWxzZSB7CiAgICB2YXIgUmVmcmVzaExheW91dENvbnN0cyA9IHsKICAgICAgU0laRToge30KICAgIH07CiAgfQoKICB2YXIgUmVmcmVzaENvbnRyb2wgPSBjcmVhdGVSZWFjdENsYXNzKHsKICAgIGRpc3BsYXlOYW1lOiAnUmVmcmVzaENvbnRyb2wnLAogICAgc3RhdGljczogewogICAgICBTSVpFOiBSZWZyZXNoTGF5b3V0Q29uc3RzLlNJWkUKICAgIH0sCiAgICBtaXhpbnM6IFtOYXRpdmVNZXRob2RzTWl4aW5dLAogICAgcHJvcFR5cGVzOiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgVmlld1Byb3BUeXBlcywgewogICAgICBvblJlZnJlc2g6IFByb3BUeXBlcy5mdW5jLAogICAgICByZWZyZXNoaW5nOiBQcm9wVHlwZXMuYm9vbC5pc1JlcXVpcmVkLAogICAgICB0aW50Q29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICAgIHRpdGxlQ29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICAgIHRpdGxlOiBQcm9wVHlwZXMuc3RyaW5nLAogICAgICBlbmFibGVkOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgY29sb3JzOiBQcm9wVHlwZXMuYXJyYXlPZihDb2xvclByb3BUeXBlKSwKICAgICAgcHJvZ3Jlc3NCYWNrZ3JvdW5kQ29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICAgIHNpemU6IFByb3BUeXBlcy5vbmVPZihbUmVmcmVzaExheW91dENvbnN0cy5TSVpFLkRFRkFVTFQsIFJlZnJlc2hMYXlvdXRDb25zdHMuU0laRS5MQVJHRV0pLAogICAgICBwcm9ncmVzc1ZpZXdPZmZzZXQ6IFByb3BUeXBlcy5udW1iZXIKICAgIH0pLAogICAgX25hdGl2ZVJlZjogbnVsbCwKICAgIF9sYXN0TmF0aXZlUmVmcmVzaGluZzogZmFsc2UsCiAgICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24gY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgIHRoaXMuX2xhc3ROYXRpdmVSZWZyZXNoaW5nID0gdGhpcy5wcm9wcy5yZWZyZXNoaW5nOwogICAgfSwKICAgIGNvbXBvbmVudERpZFVwZGF0ZTogZnVuY3Rpb24gY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcykgewogICAgICBpZiAodGhpcy5wcm9wcy5yZWZyZXNoaW5nICE9PSBwcmV2UHJvcHMucmVmcmVzaGluZykgewogICAgICAgIHRoaXMuX2xhc3ROYXRpdmVSZWZyZXNoaW5nID0gdGhpcy5wcm9wcy5yZWZyZXNoaW5nOwogICAgICB9IGVsc2UgaWYgKHRoaXMucHJvcHMucmVmcmVzaGluZyAhPT0gdGhpcy5fbGFzdE5hdGl2ZVJlZnJlc2hpbmcpIHsKICAgICAgICB0aGlzLl9uYXRpdmVSZWYuc2V0TmF0aXZlUHJvcHMoewogICAgICAgICAgcmVmcmVzaGluZzogdGhpcy5wcm9wcy5yZWZyZXNoaW5nCiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuX2xhc3ROYXRpdmVSZWZyZXNoaW5nID0gdGhpcy5wcm9wcy5yZWZyZXNoaW5nOwogICAgICB9CiAgICB9LAogICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChOYXRpdmVSZWZyZXNoQ29udHJvbCwgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHRoaXMucHJvcHMsIHsKICAgICAgICByZWY6IGZ1bmN0aW9uIHJlZihfcmVmKSB7CiAgICAgICAgICBfdGhpcy5fbmF0aXZlUmVmID0gX3JlZjsKICAgICAgICB9LAogICAgICAgIG9uUmVmcmVzaDogdGhpcy5fb25SZWZyZXNoLAogICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgbGluZU51bWJlcjogMTU2CiAgICAgICAgfQogICAgICB9KSk7CiAgICB9LAogICAgX29uUmVmcmVzaDogZnVuY3Rpb24gX29uUmVmcmVzaCgpIHsKICAgICAgdGhpcy5fbGFzdE5hdGl2ZVJlZnJlc2hpbmcgPSB0cnVlOwogICAgICB0aGlzLnByb3BzLm9uUmVmcmVzaCAmJiB0aGlzLnByb3BzLm9uUmVmcmVzaCgpOwogICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7CiAgICB9CiAgfSk7CgogIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgIHZhciBOYXRpdmVSZWZyZXNoQ29udHJvbCA9IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoJ1JDVFJlZnJlc2hDb250cm9sJywgUmVmcmVzaENvbnRyb2wpOwogIH0gZWxzZSBpZiAoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJykgewogICAgdmFyIE5hdGl2ZVJlZnJlc2hDb250cm9sID0gcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCgnQW5kcm9pZFN3aXBlUmVmcmVzaExheW91dCcsIFJlZnJlc2hDb250cm9sKTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gUmVmcmVzaENvbnRyb2w7Cn0sMjQ2LFsxMjMsMTI1LDUyLDEzMCwxMjcsMTMxLDE3MiwxNDUsMTA3XSwiUmVmcmVzaENvbnRyb2wiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfY2xhc3MsCiAgICAgIF90ZW1wLAogICAgICBfaW5pdGlhbGlzZVByb3BzLAogICAgICBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9MaXN0cy9WaXJ0dWFsaXplZExpc3QuanMiOwoKICB2YXIgQmF0Y2hpbmF0b3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQmF0Y2hpbmF0b3IiKTsKCiAgdmFyIEZpbGxSYXRlSGVscGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkZpbGxSYXRlSGVscGVyIik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUmVhY3QiKTsKCiAgdmFyIFJlYWN0TmF0aXZlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlJlYWN0TmF0aXZlIik7CgogIHZhciBSZWZyZXNoQ29udHJvbCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJSZWZyZXNoQ29udHJvbCIpOwoKICB2YXIgU2Nyb2xsVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJTY3JvbGxWaWV3Iik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAiVmlldyIpOwoKICB2YXIgVmlld2FiaWxpdHlIZWxwZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAiVmlld2FiaWxpdHlIZWxwZXIiKTsKCiAgdmFyIGZsYXR0ZW5TdHlsZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTBdLCAiZmxhdHRlblN0eWxlIik7CgogIHZhciBpbmZvTG9nID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMV0sICJpbmZvTG9nIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEyXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgd2FybmluZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTNdLCAiZmJqcy9saWIvd2FybmluZyIpOwoKICB2YXIgX3JlcXVpcmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE0XSwgIlZpcnR1YWxpemVVdGlscyIpLAogICAgICBjb21wdXRlV2luZG93ZWRSZW5kZXJMaW1pdHMgPSBfcmVxdWlyZS5jb21wdXRlV2luZG93ZWRSZW5kZXJMaW1pdHM7CgogIHZhciBfdXNlZEluZGV4Rm9yS2V5ID0gZmFsc2U7CiAgdmFyIFZpcnR1YWxpemVkTGlzdCA9IChfdGVtcCA9IF9jbGFzcyA9IGZ1bmN0aW9uIChfUmVhY3QkUHVyZUNvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKFZpcnR1YWxpemVkTGlzdCwgX1JlYWN0JFB1cmVDb21wb25lbnQpOwogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFZpcnR1YWxpemVkTGlzdCwgW3sKICAgICAga2V5OiAic2Nyb2xsVG9FbmQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2Nyb2xsVG9FbmQocGFyYW1zKSB7CiAgICAgICAgdmFyIGFuaW1hdGVkID0gcGFyYW1zID8gcGFyYW1zLmFuaW1hdGVkIDogdHJ1ZTsKICAgICAgICB2YXIgdmVyeUxhc3QgPSB0aGlzLnByb3BzLmdldEl0ZW1Db3VudCh0aGlzLnByb3BzLmRhdGEpIC0gMTsKCiAgICAgICAgdmFyIGZyYW1lID0gdGhpcy5fZ2V0RnJhbWVNZXRyaWNzQXBwcm94KHZlcnlMYXN0KTsKCiAgICAgICAgdmFyIG9mZnNldCA9IE1hdGgubWF4KDAsIGZyYW1lLm9mZnNldCArIGZyYW1lLmxlbmd0aCArIHRoaXMuX2Zvb3Rlckxlbmd0aCAtIHRoaXMuX3Njcm9sbE1ldHJpY3MudmlzaWJsZUxlbmd0aCk7CgogICAgICAgIHRoaXMuX3Njcm9sbFJlZi5zY3JvbGxUbyh0aGlzLnByb3BzLmhvcml6b250YWwgPyB7CiAgICAgICAgICB4OiBvZmZzZXQsCiAgICAgICAgICBhbmltYXRlZDogYW5pbWF0ZWQKICAgICAgICB9IDogewogICAgICAgICAgeTogb2Zmc2V0LAogICAgICAgICAgYW5pbWF0ZWQ6IGFuaW1hdGVkCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2Nyb2xsVG9JbmRleCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzY3JvbGxUb0luZGV4KHBhcmFtcykgewogICAgICAgIHZhciBfcHJvcHMgPSB0aGlzLnByb3BzLAogICAgICAgICAgICBkYXRhID0gX3Byb3BzLmRhdGEsCiAgICAgICAgICAgIGhvcml6b250YWwgPSBfcHJvcHMuaG9yaXpvbnRhbCwKICAgICAgICAgICAgZ2V0SXRlbUNvdW50ID0gX3Byb3BzLmdldEl0ZW1Db3VudCwKICAgICAgICAgICAgZ2V0SXRlbUxheW91dCA9IF9wcm9wcy5nZXRJdGVtTGF5b3V0LAogICAgICAgICAgICBvblNjcm9sbFRvSW5kZXhGYWlsZWQgPSBfcHJvcHMub25TY3JvbGxUb0luZGV4RmFpbGVkOwogICAgICAgIHZhciBhbmltYXRlZCA9IHBhcmFtcy5hbmltYXRlZCwKICAgICAgICAgICAgaW5kZXggPSBwYXJhbXMuaW5kZXgsCiAgICAgICAgICAgIHZpZXdPZmZzZXQgPSBwYXJhbXMudmlld09mZnNldCwKICAgICAgICAgICAgdmlld1Bvc2l0aW9uID0gcGFyYW1zLnZpZXdQb3NpdGlvbjsKICAgICAgICBpbnZhcmlhbnQoaW5kZXggPj0gMCAmJiBpbmRleCA8IGdldEl0ZW1Db3VudChkYXRhKSwgInNjcm9sbFRvSW5kZXggb3V0IG9mIHJhbmdlOiAiICsgaW5kZXggKyAiIHZzICIgKyAoZ2V0SXRlbUNvdW50KGRhdGEpIC0gMSkpOwoKICAgICAgICBpZiAoIWdldEl0ZW1MYXlvdXQgJiYgaW5kZXggPiB0aGlzLl9oaWdoZXN0TWVhc3VyZWRGcmFtZUluZGV4KSB7CiAgICAgICAgICBpbnZhcmlhbnQoISFvblNjcm9sbFRvSW5kZXhGYWlsZWQsICdzY3JvbGxUb0luZGV4IHNob3VsZCBiZSB1c2VkIGluIGNvbmp1bmN0aW9uIHdpdGggZ2V0SXRlbUxheW91dCBvciBvblNjcm9sbFRvSW5kZXhGYWlsZWQsICcgKyAnb3RoZXJ3aXNlIHRoZXJlIGlzIG5vIHdheSB0byBrbm93IHRoZSBsb2NhdGlvbiBvZiBvZmZzY3JlZW4gaW5kaWNlcyBvciBoYW5kbGUgZmFpbHVyZXMuJyk7CiAgICAgICAgICBvblNjcm9sbFRvSW5kZXhGYWlsZWQoewogICAgICAgICAgICBhdmVyYWdlSXRlbUxlbmd0aDogdGhpcy5fYXZlcmFnZUNlbGxMZW5ndGgsCiAgICAgICAgICAgIGhpZ2hlc3RNZWFzdXJlZEZyYW1lSW5kZXg6IHRoaXMuX2hpZ2hlc3RNZWFzdXJlZEZyYW1lSW5kZXgsCiAgICAgICAgICAgIGluZGV4OiBpbmRleAogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgZnJhbWUgPSB0aGlzLl9nZXRGcmFtZU1ldHJpY3NBcHByb3goaW5kZXgpOwoKICAgICAgICB2YXIgb2Zmc2V0ID0gTWF0aC5tYXgoMCwgZnJhbWUub2Zmc2V0IC0gKHZpZXdQb3NpdGlvbiB8fCAwKSAqICh0aGlzLl9zY3JvbGxNZXRyaWNzLnZpc2libGVMZW5ndGggLSBmcmFtZS5sZW5ndGgpKSAtICh2aWV3T2Zmc2V0IHx8IDApOwoKICAgICAgICB0aGlzLl9zY3JvbGxSZWYuc2Nyb2xsVG8oaG9yaXpvbnRhbCA/IHsKICAgICAgICAgIHg6IG9mZnNldCwKICAgICAgICAgIGFuaW1hdGVkOiBhbmltYXRlZAogICAgICAgIH0gOiB7CiAgICAgICAgICB5OiBvZmZzZXQsCiAgICAgICAgICBhbmltYXRlZDogYW5pbWF0ZWQKICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzY3JvbGxUb0l0ZW0iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2Nyb2xsVG9JdGVtKHBhcmFtcykgewogICAgICAgIHZhciBpdGVtID0gcGFyYW1zLml0ZW07CiAgICAgICAgdmFyIF9wcm9wczIgPSB0aGlzLnByb3BzLAogICAgICAgICAgICBkYXRhID0gX3Byb3BzMi5kYXRhLAogICAgICAgICAgICBnZXRJdGVtID0gX3Byb3BzMi5nZXRJdGVtLAogICAgICAgICAgICBnZXRJdGVtQ291bnQgPSBfcHJvcHMyLmdldEl0ZW1Db3VudDsKICAgICAgICB2YXIgaXRlbUNvdW50ID0gZ2V0SXRlbUNvdW50KGRhdGEpOwoKICAgICAgICBmb3IgKHZhciBfaW5kZXggPSAwOyBfaW5kZXggPCBpdGVtQ291bnQ7IF9pbmRleCsrKSB7CiAgICAgICAgICBpZiAoZ2V0SXRlbShkYXRhLCBfaW5kZXgpID09PSBpdGVtKSB7CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9JbmRleChiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgcGFyYW1zLCB7CiAgICAgICAgICAgICAgaW5kZXg6IF9pbmRleAogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzY3JvbGxUb09mZnNldCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzY3JvbGxUb09mZnNldChwYXJhbXMpIHsKICAgICAgICB2YXIgYW5pbWF0ZWQgPSBwYXJhbXMuYW5pbWF0ZWQsCiAgICAgICAgICAgIG9mZnNldCA9IHBhcmFtcy5vZmZzZXQ7CgogICAgICAgIHRoaXMuX3Njcm9sbFJlZi5zY3JvbGxUbyh0aGlzLnByb3BzLmhvcml6b250YWwgPyB7CiAgICAgICAgICB4OiBvZmZzZXQsCiAgICAgICAgICBhbmltYXRlZDogYW5pbWF0ZWQKICAgICAgICB9IDogewogICAgICAgICAgeTogb2Zmc2V0LAogICAgICAgICAgYW5pbWF0ZWQ6IGFuaW1hdGVkCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVjb3JkSW50ZXJhY3Rpb24iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVjb3JkSW50ZXJhY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fdmlld2FiaWxpdHlUdXBsZXMuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICAgICAgdC52aWV3YWJpbGl0eUhlbHBlci5yZWNvcmRJbnRlcmFjdGlvbigpOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLl91cGRhdGVWaWV3YWJsZUl0ZW1zKHRoaXMucHJvcHMuZGF0YSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZmxhc2hTY3JvbGxJbmRpY2F0b3JzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGZsYXNoU2Nyb2xsSW5kaWNhdG9ycygpIHsKICAgICAgICB0aGlzLl9zY3JvbGxSZWYuZmxhc2hTY3JvbGxJbmRpY2F0b3JzKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0U2Nyb2xsUmVzcG9uZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFNjcm9sbFJlc3BvbmRlcigpIHsKICAgICAgICBpZiAodGhpcy5fc2Nyb2xsUmVmICYmIHRoaXMuX3Njcm9sbFJlZi5nZXRTY3JvbGxSZXNwb25kZXIpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9zY3JvbGxSZWYuZ2V0U2Nyb2xsUmVzcG9uZGVyKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFNjcm9sbGFibGVOb2RlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFNjcm9sbGFibGVOb2RlKCkgewogICAgICAgIGlmICh0aGlzLl9zY3JvbGxSZWYgJiYgdGhpcy5fc2Nyb2xsUmVmLmdldFNjcm9sbGFibGVOb2RlKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fc2Nyb2xsUmVmLmdldFNjcm9sbGFibGVOb2RlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBSZWFjdE5hdGl2ZS5maW5kTm9kZUhhbmRsZSh0aGlzLl9zY3JvbGxSZWYpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzZXROYXRpdmVQcm9wcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXROYXRpdmVQcm9wcyhwcm9wcykgewogICAgICAgIGlmICh0aGlzLl9zY3JvbGxSZWYpIHsKICAgICAgICAgIHRoaXMuX3Njcm9sbFJlZi5zZXROYXRpdmVQcm9wcyhwcm9wcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldENoaWxkQ29udGV4dCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRDaGlsZENvbnRleHQoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHZpcnR1YWxpemVkTGlzdDogewogICAgICAgICAgICBob3Jpem9udGFsOiB0aGlzLnByb3BzLmhvcml6b250YWwKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICB9XSk7CgogICAgZnVuY3Rpb24gVmlydHVhbGl6ZWRMaXN0KHByb3BzLCBjb250ZXh0KSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBWaXJ0dWFsaXplZExpc3QpOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKFZpcnR1YWxpemVkTGlzdC5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKFZpcnR1YWxpemVkTGlzdCkpLmNhbGwodGhpcywgcHJvcHMsIGNvbnRleHQpKTsKCiAgICAgIF9pbml0aWFsaXNlUHJvcHMuY2FsbChfdGhpcyk7CgogICAgICBpbnZhcmlhbnQoIXByb3BzLm9uU2Nyb2xsIHx8ICFwcm9wcy5vblNjcm9sbC5fX2lzTmF0aXZlLCAnQ29tcG9uZW50cyBiYXNlZCBvbiBWaXJ0dWFsaXplZExpc3QgbXVzdCBiZSB3cmFwcGVkIHdpdGggQW5pbWF0ZWQuY3JlYXRlQW5pbWF0ZWRDb21wb25lbnQgJyArICd0byBzdXBwb3J0IG5hdGl2ZSBvblNjcm9sbCBldmVudHMgd2l0aCB1c2VOYXRpdmVEcml2ZXInKTsKICAgICAgaW52YXJpYW50KCEoX3RoaXMuX2lzTmVzdGVkV2l0aFNhbWVPcmllbnRhdGlvbigpICYmIHByb3BzLm9uVmlld2FibGVJdGVtc0NoYW5nZWQpLCAnTmVzdGluZyBsaXN0cyB0aGF0IHNjcm9sbCBpbiB0aGUgc2FtZSBkaXJlY3Rpb24gZG9lcyBub3Qgc3VwcG9ydCBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkJyArICdvbiB0aGUgaW5uZXIgbGlzdC4nKTsKICAgICAgX3RoaXMuX2ZpbGxSYXRlSGVscGVyID0gbmV3IEZpbGxSYXRlSGVscGVyKF90aGlzLl9nZXRGcmFtZU1ldHJpY3MpOwogICAgICBfdGhpcy5fdXBkYXRlQ2VsbHNUb1JlbmRlckJhdGNoZXIgPSBuZXcgQmF0Y2hpbmF0b3IoX3RoaXMuX3VwZGF0ZUNlbGxzVG9SZW5kZXIsIF90aGlzLnByb3BzLnVwZGF0ZUNlbGxzQmF0Y2hpbmdQZXJpb2QpOwoKICAgICAgaWYgKF90aGlzLnByb3BzLnZpZXdhYmlsaXR5Q29uZmlnQ2FsbGJhY2tQYWlycykgewogICAgICAgIF90aGlzLl92aWV3YWJpbGl0eVR1cGxlcyA9IF90aGlzLnByb3BzLnZpZXdhYmlsaXR5Q29uZmlnQ2FsbGJhY2tQYWlycy5tYXAoZnVuY3Rpb24gKHBhaXIpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHZpZXdhYmlsaXR5SGVscGVyOiBuZXcgVmlld2FiaWxpdHlIZWxwZXIocGFpci52aWV3YWJpbGl0eUNvbmZpZyksCiAgICAgICAgICAgIG9uVmlld2FibGVJdGVtc0NoYW5nZWQ6IHBhaXIub25WaWV3YWJsZUl0ZW1zQ2hhbmdlZAogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChfdGhpcy5wcm9wcy5vblZpZXdhYmxlSXRlbXNDaGFuZ2VkKSB7CiAgICAgICAgX3RoaXMuX3ZpZXdhYmlsaXR5VHVwbGVzLnB1c2goewogICAgICAgICAgdmlld2FiaWxpdHlIZWxwZXI6IG5ldyBWaWV3YWJpbGl0eUhlbHBlcihfdGhpcy5wcm9wcy52aWV3YWJpbGl0eUNvbmZpZyksCiAgICAgICAgICBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkOiBfdGhpcy5wcm9wcy5vblZpZXdhYmxlSXRlbXNDaGFuZ2VkCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIF90aGlzLnN0YXRlID0gewogICAgICAgIGZpcnN0OiBfdGhpcy5wcm9wcy5pbml0aWFsU2Nyb2xsSW5kZXggfHwgMCwKICAgICAgICBsYXN0OiBNYXRoLm1pbihfdGhpcy5wcm9wcy5nZXRJdGVtQ291bnQoX3RoaXMucHJvcHMuZGF0YSksIChfdGhpcy5wcm9wcy5pbml0aWFsU2Nyb2xsSW5kZXggfHwgMCkgKyBfdGhpcy5wcm9wcy5pbml0aWFsTnVtVG9SZW5kZXIpIC0gMQogICAgICB9OwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFZpcnR1YWxpemVkTGlzdCwgW3sKICAgICAga2V5OiAiY29tcG9uZW50RGlkTW91bnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICAgIGlmICh0aGlzLnByb3BzLmluaXRpYWxTY3JvbGxJbmRleCkgewogICAgICAgICAgdGhpcy5faW5pdGlhbFNjcm9sbEluZGV4VGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMyLnNjcm9sbFRvSW5kZXgoewogICAgICAgICAgICAgIGFuaW1hdGVkOiBmYWxzZSwKICAgICAgICAgICAgICBpbmRleDogX3RoaXMyLnByb3BzLmluaXRpYWxTY3JvbGxJbmRleAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIDApOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjb21wb25lbnRXaWxsVW5tb3VudCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnRXaWxsVW5tb3VudCgpIHsKICAgICAgICB0aGlzLl91cGRhdGVWaWV3YWJsZUl0ZW1zKG51bGwpOwoKICAgICAgICB0aGlzLl91cGRhdGVDZWxsc1RvUmVuZGVyQmF0Y2hlci5kaXNwb3NlKCk7CgogICAgICAgIHRoaXMuX3ZpZXdhYmlsaXR5VHVwbGVzLmZvckVhY2goZnVuY3Rpb24gKHR1cGxlKSB7CiAgICAgICAgICB0dXBsZS52aWV3YWJpbGl0eUhlbHBlci5kaXNwb3NlKCk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuX2ZpbGxSYXRlSGVscGVyLmRlYWN0aXZhdGVBbmRGbHVzaCgpOwoKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5faW5pdGlhbFNjcm9sbEluZGV4VGltZW91dCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzKSB7CiAgICAgICAgdmFyIGRhdGEgPSBuZXdQcm9wcy5kYXRhLAogICAgICAgICAgICBleHRyYURhdGEgPSBuZXdQcm9wcy5leHRyYURhdGEsCiAgICAgICAgICAgIGdldEl0ZW1Db3VudCA9IG5ld1Byb3BzLmdldEl0ZW1Db3VudCwKICAgICAgICAgICAgbWF4VG9SZW5kZXJQZXJCYXRjaCA9IG5ld1Byb3BzLm1heFRvUmVuZGVyUGVyQmF0Y2g7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICBmaXJzdDogTWF0aC5tYXgoMCwgTWF0aC5taW4odGhpcy5zdGF0ZS5maXJzdCwgZ2V0SXRlbUNvdW50KGRhdGEpIC0gMSAtIG1heFRvUmVuZGVyUGVyQmF0Y2gpKSwKICAgICAgICAgIGxhc3Q6IE1hdGgubWF4KDAsIE1hdGgubWluKHRoaXMuc3RhdGUubGFzdCwgZ2V0SXRlbUNvdW50KGRhdGEpIC0gMSkpCiAgICAgICAgfSk7CgogICAgICAgIGlmIChkYXRhICE9PSB0aGlzLnByb3BzLmRhdGEgfHwgZXh0cmFEYXRhICE9PSB0aGlzLnByb3BzLmV4dHJhRGF0YSkgewogICAgICAgICAgdGhpcy5faGFzRGF0YUNoYW5nZWRTaW5jZUVuZFJlYWNoZWQgPSB0cnVlOwoKICAgICAgICAgIHRoaXMuX3ZpZXdhYmlsaXR5VHVwbGVzLmZvckVhY2goZnVuY3Rpb24gKHR1cGxlKSB7CiAgICAgICAgICAgIHR1cGxlLnZpZXdhYmlsaXR5SGVscGVyLnJlc2V0Vmlld2FibGVJbmRpY2VzKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX3B1c2hDZWxscyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfcHVzaENlbGxzKGNlbGxzLCBzdGlja3lIZWFkZXJJbmRpY2VzLCBzdGlja3lJbmRpY2VzRnJvbVByb3BzLCBmaXJzdCwgbGFzdCwgaW52ZXJzaW9uU3R5bGUpIHsKICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgdmFyIF9wcm9wczMgPSB0aGlzLnByb3BzLAogICAgICAgICAgICBDZWxsUmVuZGVyZXJDb21wb25lbnQgPSBfcHJvcHMzLkNlbGxSZW5kZXJlckNvbXBvbmVudCwKICAgICAgICAgICAgSXRlbVNlcGFyYXRvckNvbXBvbmVudCA9IF9wcm9wczMuSXRlbVNlcGFyYXRvckNvbXBvbmVudCwKICAgICAgICAgICAgZGF0YSA9IF9wcm9wczMuZGF0YSwKICAgICAgICAgICAgZ2V0SXRlbSA9IF9wcm9wczMuZ2V0SXRlbSwKICAgICAgICAgICAgZ2V0SXRlbUNvdW50ID0gX3Byb3BzMy5nZXRJdGVtQ291bnQsCiAgICAgICAgICAgIGhvcml6b250YWwgPSBfcHJvcHMzLmhvcml6b250YWwsCiAgICAgICAgICAgIGtleUV4dHJhY3RvciA9IF9wcm9wczMua2V5RXh0cmFjdG9yOwogICAgICAgIHZhciBzdGlja3lPZmZzZXQgPSB0aGlzLnByb3BzLkxpc3RIZWFkZXJDb21wb25lbnQgPyAxIDogMDsKICAgICAgICB2YXIgZW5kID0gZ2V0SXRlbUNvdW50KGRhdGEpIC0gMTsKICAgICAgICB2YXIgcHJldkNlbGxLZXkgPSB2b2lkIDA7CiAgICAgICAgbGFzdCA9IE1hdGgubWluKGVuZCwgbGFzdCk7CgogICAgICAgIHZhciBfbG9vcCA9IGZ1bmN0aW9uIF9sb29wKGlpKSB7CiAgICAgICAgICB2YXIgaXRlbSA9IGdldEl0ZW0oZGF0YSwgaWkpOwogICAgICAgICAgdmFyIGtleSA9IGtleUV4dHJhY3RvcihpdGVtLCBpaSk7CgogICAgICAgICAgaWYgKHN0aWNreUluZGljZXNGcm9tUHJvcHMuaGFzKGlpICsgc3RpY2t5T2Zmc2V0KSkgewogICAgICAgICAgICBzdGlja3lIZWFkZXJJbmRpY2VzLnB1c2goY2VsbHMubGVuZ3RoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBjZWxscy5wdXNoKFJlYWN0LmNyZWF0ZUVsZW1lbnQoQ2VsbFJlbmRlcmVyLCB7CiAgICAgICAgICAgIENlbGxSZW5kZXJlckNvbXBvbmVudDogQ2VsbFJlbmRlcmVyQ29tcG9uZW50LAogICAgICAgICAgICBJdGVtU2VwYXJhdG9yQ29tcG9uZW50OiBpaSA8IGVuZCA/IEl0ZW1TZXBhcmF0b3JDb21wb25lbnQgOiB1bmRlZmluZWQsCiAgICAgICAgICAgIGNlbGxLZXk6IGtleSwKICAgICAgICAgICAgZmlsbFJhdGVIZWxwZXI6IF90aGlzMy5fZmlsbFJhdGVIZWxwZXIsCiAgICAgICAgICAgIGhvcml6b250YWw6IGhvcml6b250YWwsCiAgICAgICAgICAgIGluZGV4OiBpaSwKICAgICAgICAgICAgaW52ZXJzaW9uU3R5bGU6IGludmVyc2lvblN0eWxlLAogICAgICAgICAgICBpdGVtOiBpdGVtLAogICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgcHJldkNlbGxLZXk6IHByZXZDZWxsS2V5LAogICAgICAgICAgICBvblVwZGF0ZVNlcGFyYXRvcnM6IF90aGlzMy5fb25VcGRhdGVTZXBhcmF0b3JzLAogICAgICAgICAgICBvbkxheW91dDogZnVuY3Rpb24gb25MYXlvdXQoZSkgewogICAgICAgICAgICAgIHJldHVybiBfdGhpczMuX29uQ2VsbExheW91dChlLCBrZXksIGlpKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25Vbm1vdW50OiBfdGhpczMuX29uQ2VsbFVubW91bnQsCiAgICAgICAgICAgIHBhcmVudFByb3BzOiBfdGhpczMucHJvcHMsCiAgICAgICAgICAgIHJlZjogZnVuY3Rpb24gcmVmKF9yZWYpIHsKICAgICAgICAgICAgICBfdGhpczMuX2NlbGxSZWZzW2tleV0gPSBfcmVmOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNTU2CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pKTsKICAgICAgICAgIHByZXZDZWxsS2V5ID0ga2V5OwogICAgICAgIH07CgogICAgICAgIGZvciAodmFyIGlpID0gZmlyc3Q7IGlpIDw9IGxhc3Q7IGlpKyspIHsKICAgICAgICAgIF9sb29wKGlpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX2lzVmlydHVhbGl6YXRpb25EaXNhYmxlZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfaXNWaXJ0dWFsaXphdGlvbkRpc2FibGVkKCkgewogICAgICAgIHJldHVybiB0aGlzLnByb3BzLmRpc2FibGVWaXJ0dWFsaXphdGlvbiB8fCB0aGlzLl9pc05lc3RlZFdpdGhTYW1lT3JpZW50YXRpb24oKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfaXNOZXN0ZWRXaXRoU2FtZU9yaWVudGF0aW9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9pc05lc3RlZFdpdGhTYW1lT3JpZW50YXRpb24oKSB7CiAgICAgICAgdmFyIG5lc3RlZENvbnRleHQgPSB0aGlzLmNvbnRleHQudmlydHVhbGl6ZWRMaXN0OwogICAgICAgIHJldHVybiAhIShuZXN0ZWRDb250ZXh0ICYmICEhbmVzdGVkQ29udGV4dC5ob3Jpem9udGFsID09PSAhIXRoaXMucHJvcHMuaG9yaXpvbnRhbCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgdmFyIGZsYXRTdHlsZXMgPSBmbGF0dGVuU3R5bGUodGhpcy5wcm9wcy5jb250ZW50Q29udGFpbmVyU3R5bGUpOwogICAgICAgICAgd2FybmluZyhmbGF0U3R5bGVzID09IG51bGwgfHwgZmxhdFN0eWxlcy5mbGV4V3JhcCAhPT0gJ3dyYXAnLCAnYGZsZXhXcmFwOiBgd3JhcGBgIGlzIG5vdCBzdXBwb3J0ZWQgd2l0aCB0aGUgYFZpcnR1YWxpemVkTGlzdGAgY29tcG9uZW50cy4nICsgJ0NvbnNpZGVyIHVzaW5nIGBudW1Db2x1bW5zYCB3aXRoIGBGbGF0TGlzdGAgaW5zdGVhZC4nKTsKICAgICAgICB9CgogICAgICAgIHZhciBfcHJvcHM0ID0gdGhpcy5wcm9wcywKICAgICAgICAgICAgTGlzdEVtcHR5Q29tcG9uZW50ID0gX3Byb3BzNC5MaXN0RW1wdHlDb21wb25lbnQsCiAgICAgICAgICAgIExpc3RGb290ZXJDb21wb25lbnQgPSBfcHJvcHM0Lkxpc3RGb290ZXJDb21wb25lbnQsCiAgICAgICAgICAgIExpc3RIZWFkZXJDb21wb25lbnQgPSBfcHJvcHM0Lkxpc3RIZWFkZXJDb21wb25lbnQ7CiAgICAgICAgdmFyIF9wcm9wczUgPSB0aGlzLnByb3BzLAogICAgICAgICAgICBkYXRhID0gX3Byb3BzNS5kYXRhLAogICAgICAgICAgICBob3Jpem9udGFsID0gX3Byb3BzNS5ob3Jpem9udGFsOwoKICAgICAgICB2YXIgaXNWaXJ0dWFsaXphdGlvbkRpc2FibGVkID0gdGhpcy5faXNWaXJ0dWFsaXphdGlvbkRpc2FibGVkKCk7CgogICAgICAgIHZhciBpbnZlcnNpb25TdHlsZSA9IHRoaXMucHJvcHMuaW52ZXJ0ZWQgPyB0aGlzLnByb3BzLmhvcml6b250YWwgPyBzdHlsZXMuaG9yaXpvbnRhbGx5SW52ZXJ0ZWQgOiBzdHlsZXMudmVydGljYWxseUludmVydGVkIDogbnVsbDsKICAgICAgICB2YXIgY2VsbHMgPSBbXTsKICAgICAgICB2YXIgc3RpY2t5SW5kaWNlc0Zyb21Qcm9wcyA9IG5ldyBTZXQodGhpcy5wcm9wcy5zdGlja3lIZWFkZXJJbmRpY2VzKTsKICAgICAgICB2YXIgc3RpY2t5SGVhZGVySW5kaWNlcyA9IFtdOwoKICAgICAgICBpZiAoTGlzdEhlYWRlckNvbXBvbmVudCkgewogICAgICAgICAgaWYgKHN0aWNreUluZGljZXNGcm9tUHJvcHMuaGFzKDApKSB7CiAgICAgICAgICAgIHN0aWNreUhlYWRlckluZGljZXMucHVzaCgwKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZWxlbWVudCA9IFJlYWN0LmlzVmFsaWRFbGVtZW50KExpc3RIZWFkZXJDb21wb25lbnQpID8gTGlzdEhlYWRlckNvbXBvbmVudCA6IFJlYWN0LmNyZWF0ZUVsZW1lbnQoTGlzdEhlYWRlckNvbXBvbmVudCwgewogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNjMzCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgY2VsbHMucHVzaChSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBWaWV3LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAga2V5OiAiJGhlYWRlciIsCiAgICAgICAgICAgICAgb25MYXlvdXQ6IHRoaXMuX29uTGF5b3V0SGVhZGVyLAogICAgICAgICAgICAgIHN0eWxlOiBpbnZlcnNpb25TdHlsZSwKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDYzNgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZWxlbWVudAogICAgICAgICAgKSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgaXRlbUNvdW50ID0gdGhpcy5wcm9wcy5nZXRJdGVtQ291bnQoZGF0YSk7CgogICAgICAgIGlmIChpdGVtQ291bnQgPiAwKSB7CiAgICAgICAgICBfdXNlZEluZGV4Rm9yS2V5ID0gZmFsc2U7CiAgICAgICAgICB2YXIgc3BhY2VyS2V5ID0gIWhvcml6b250YWwgPyAnaGVpZ2h0JyA6ICd3aWR0aCc7CiAgICAgICAgICB2YXIgbGFzdEluaXRpYWxJbmRleCA9IHRoaXMucHJvcHMuaW5pdGlhbFNjcm9sbEluZGV4ID8gLTEgOiB0aGlzLnByb3BzLmluaXRpYWxOdW1Ub1JlbmRlciAtIDE7CiAgICAgICAgICB2YXIgX3N0YXRlID0gdGhpcy5zdGF0ZSwKICAgICAgICAgICAgICBfZmlyc3QgPSBfc3RhdGUuZmlyc3QsCiAgICAgICAgICAgICAgX2xhc3QgPSBfc3RhdGUubGFzdDsKCiAgICAgICAgICB0aGlzLl9wdXNoQ2VsbHMoY2VsbHMsIHN0aWNreUhlYWRlckluZGljZXMsIHN0aWNreUluZGljZXNGcm9tUHJvcHMsIDAsIGxhc3RJbml0aWFsSW5kZXgsIGludmVyc2lvblN0eWxlKTsKCiAgICAgICAgICB2YXIgZmlyc3RBZnRlckluaXRpYWwgPSBNYXRoLm1heChsYXN0SW5pdGlhbEluZGV4ICsgMSwgX2ZpcnN0KTsKCiAgICAgICAgICBpZiAoIWlzVmlydHVhbGl6YXRpb25EaXNhYmxlZCAmJiBfZmlyc3QgPiBsYXN0SW5pdGlhbEluZGV4ICsgMSkgewogICAgICAgICAgICB2YXIgaW5zZXJ0ZWRTdGlja3lTcGFjZXIgPSBmYWxzZTsKCiAgICAgICAgICAgIGlmIChzdGlja3lJbmRpY2VzRnJvbVByb3BzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIHN0aWNreU9mZnNldCA9IExpc3RIZWFkZXJDb21wb25lbnQgPyAxIDogMDsKCiAgICAgICAgICAgICAgZm9yICh2YXIgaWkgPSBmaXJzdEFmdGVySW5pdGlhbCAtIDE7IGlpID4gbGFzdEluaXRpYWxJbmRleDsgaWktLSkgewogICAgICAgICAgICAgICAgaWYgKHN0aWNreUluZGljZXNGcm9tUHJvcHMuaGFzKGlpICsgc3RpY2t5T2Zmc2V0KSkgewogICAgICAgICAgICAgICAgICB2YXIgaW5pdEJsb2NrID0gdGhpcy5fZ2V0RnJhbWVNZXRyaWNzQXBwcm94KGxhc3RJbml0aWFsSW5kZXgpOwoKICAgICAgICAgICAgICAgICAgdmFyIHN0aWNreUJsb2NrID0gdGhpcy5fZ2V0RnJhbWVNZXRyaWNzQXBwcm94KGlpKTsKCiAgICAgICAgICAgICAgICAgIHZhciBsZWFkU3BhY2UgPSBzdGlja3lCbG9jay5vZmZzZXQgLSAoaW5pdEJsb2NrLm9mZnNldCArIGluaXRCbG9jay5sZW5ndGgpOwogICAgICAgICAgICAgICAgICBjZWxscy5wdXNoKFJlYWN0LmNyZWF0ZUVsZW1lbnQoVmlldywgewogICAgICAgICAgICAgICAgICAgIGtleTogIiRzdGlja3lfbGVhZCIsCiAgICAgICAgICAgICAgICAgICAgc3R5bGU6IGJhYmVsSGVscGVycy5kZWZpbmVQcm9wZXJ0eSh7fSwgc3BhY2VyS2V5LCBsZWFkU3BhY2UpLAogICAgICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogNjczCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgICB0aGlzLl9wdXNoQ2VsbHMoY2VsbHMsIHN0aWNreUhlYWRlckluZGljZXMsIHN0aWNreUluZGljZXNGcm9tUHJvcHMsIGlpLCBpaSwgaW52ZXJzaW9uU3R5bGUpOwoKICAgICAgICAgICAgICAgICAgdmFyIHRyYWlsU3BhY2UgPSB0aGlzLl9nZXRGcmFtZU1ldHJpY3NBcHByb3goX2ZpcnN0KS5vZmZzZXQgLSAoc3RpY2t5QmxvY2sub2Zmc2V0ICsgc3RpY2t5QmxvY2subGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgY2VsbHMucHVzaChSZWFjdC5jcmVhdGVFbGVtZW50KFZpZXcsIHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICIkc3RpY2t5X3RyYWlsIiwKICAgICAgICAgICAgICAgICAgICBzdHlsZTogYmFiZWxIZWxwZXJzLmRlZmluZVByb3BlcnR5KHt9LCBzcGFjZXJLZXksIHRyYWlsU3BhY2UpLAogICAgICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogNjg3CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgIGluc2VydGVkU3RpY2t5U3BhY2VyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWluc2VydGVkU3RpY2t5U3BhY2VyKSB7CiAgICAgICAgICAgICAgdmFyIF9pbml0QmxvY2sgPSB0aGlzLl9nZXRGcmFtZU1ldHJpY3NBcHByb3gobGFzdEluaXRpYWxJbmRleCk7CgogICAgICAgICAgICAgIHZhciBmaXJzdFNwYWNlID0gdGhpcy5fZ2V0RnJhbWVNZXRyaWNzQXBwcm94KF9maXJzdCkub2Zmc2V0IC0gKF9pbml0QmxvY2sub2Zmc2V0ICsgX2luaXRCbG9jay5sZW5ndGgpOwoKICAgICAgICAgICAgICBjZWxscy5wdXNoKFJlYWN0LmNyZWF0ZUVsZW1lbnQoVmlldywgewogICAgICAgICAgICAgICAga2V5OiAiJGxlYWRfc3BhY2VyIiwKICAgICAgICAgICAgICAgIHN0eWxlOiBiYWJlbEhlbHBlcnMuZGVmaW5lUHJvcGVydHkoe30sIHNwYWNlcktleSwgZmlyc3RTcGFjZSksCiAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA3MDAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLl9wdXNoQ2VsbHMoY2VsbHMsIHN0aWNreUhlYWRlckluZGljZXMsIHN0aWNreUluZGljZXNGcm9tUHJvcHMsIGZpcnN0QWZ0ZXJJbml0aWFsLCBfbGFzdCwgaW52ZXJzaW9uU3R5bGUpOwoKICAgICAgICAgIGlmICghdGhpcy5faGFzV2FybmVkLmtleXMgJiYgX3VzZWRJbmRleEZvcktleSkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1ZpcnR1YWxpemVkTGlzdDogbWlzc2luZyBrZXlzIGZvciBpdGVtcywgbWFrZSBzdXJlIHRvIHNwZWNpZnkgYSBrZXkgcHJvcGVydHkgb24gZWFjaCAnICsgJ2l0ZW0gb3IgcHJvdmlkZSBhIGN1c3RvbSBrZXlFeHRyYWN0b3IuJyk7CiAgICAgICAgICAgIHRoaXMuX2hhc1dhcm5lZC5rZXlzID0gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWlzVmlydHVhbGl6YXRpb25EaXNhYmxlZCAmJiBfbGFzdCA8IGl0ZW1Db3VudCAtIDEpIHsKICAgICAgICAgICAgdmFyIGxhc3RGcmFtZSA9IHRoaXMuX2dldEZyYW1lTWV0cmljc0FwcHJveChfbGFzdCk7CgogICAgICAgICAgICB2YXIgZW5kID0gdGhpcy5wcm9wcy5nZXRJdGVtTGF5b3V0ID8gaXRlbUNvdW50IC0gMSA6IE1hdGgubWluKGl0ZW1Db3VudCAtIDEsIHRoaXMuX2hpZ2hlc3RNZWFzdXJlZEZyYW1lSW5kZXgpOwoKICAgICAgICAgICAgdmFyIGVuZEZyYW1lID0gdGhpcy5fZ2V0RnJhbWVNZXRyaWNzQXBwcm94KGVuZCk7CgogICAgICAgICAgICB2YXIgdGFpbFNwYWNlckxlbmd0aCA9IGVuZEZyYW1lLm9mZnNldCArIGVuZEZyYW1lLmxlbmd0aCAtIChsYXN0RnJhbWUub2Zmc2V0ICsgbGFzdEZyYW1lLmxlbmd0aCk7CiAgICAgICAgICAgIGNlbGxzLnB1c2goUmVhY3QuY3JlYXRlRWxlbWVudChWaWV3LCB7CiAgICAgICAgICAgICAga2V5OiAiJHRhaWxfc3BhY2VyIiwKICAgICAgICAgICAgICBzdHlsZTogYmFiZWxIZWxwZXJzLmRlZmluZVByb3BlcnR5KHt9LCBzcGFjZXJLZXksIHRhaWxTcGFjZXJMZW5ndGgpLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogNzMzCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChMaXN0RW1wdHlDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBfZWxlbWVudCA9IFJlYWN0LmlzVmFsaWRFbGVtZW50KExpc3RFbXB0eUNvbXBvbmVudCkgPyBMaXN0RW1wdHlDb21wb25lbnQgOiBSZWFjdC5jcmVhdGVFbGVtZW50KExpc3RFbXB0eUNvbXBvbmVudCwgewogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNzQxCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIGNlbGxzLnB1c2goUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgewogICAgICAgICAgICAgIGtleTogIiRlbXB0eSIsCiAgICAgICAgICAgICAgb25MYXlvdXQ6IHRoaXMuX29uTGF5b3V0RW1wdHksCiAgICAgICAgICAgICAgc3R5bGU6IGludmVyc2lvblN0eWxlLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogNzQ0CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfZWxlbWVudAogICAgICAgICAgKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoTGlzdEZvb3RlckNvbXBvbmVudCkgewogICAgICAgICAgdmFyIF9lbGVtZW50MiA9IFJlYWN0LmlzVmFsaWRFbGVtZW50KExpc3RGb290ZXJDb21wb25lbnQpID8gTGlzdEZvb3RlckNvbXBvbmVudCA6IFJlYWN0LmNyZWF0ZUVsZW1lbnQoTGlzdEZvb3RlckNvbXBvbmVudCwgewogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNzU3CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIGNlbGxzLnB1c2goUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgewogICAgICAgICAgICAgIGtleTogIiRmb290ZXIiLAogICAgICAgICAgICAgIG9uTGF5b3V0OiB0aGlzLl9vbkxheW91dEZvb3RlciwKICAgICAgICAgICAgICBzdHlsZTogaW52ZXJzaW9uU3R5bGUsCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA3NjAKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9lbGVtZW50MgogICAgICAgICAgKSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgc2Nyb2xsUHJvcHMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcywgewogICAgICAgICAgb25Db250ZW50U2l6ZUNoYW5nZTogdGhpcy5fb25Db250ZW50U2l6ZUNoYW5nZSwKICAgICAgICAgIG9uTGF5b3V0OiB0aGlzLl9vbkxheW91dCwKICAgICAgICAgIG9uU2Nyb2xsOiB0aGlzLl9vblNjcm9sbCwKICAgICAgICAgIG9uU2Nyb2xsQmVnaW5EcmFnOiB0aGlzLl9vblNjcm9sbEJlZ2luRHJhZywKICAgICAgICAgIG9uU2Nyb2xsRW5kRHJhZzogdGhpcy5fb25TY3JvbGxFbmREcmFnLAogICAgICAgICAgb25Nb21lbnR1bVNjcm9sbEVuZDogdGhpcy5fb25Nb21lbnR1bVNjcm9sbEVuZCwKICAgICAgICAgIHNjcm9sbEV2ZW50VGhyb3R0bGU6IHRoaXMucHJvcHMuc2Nyb2xsRXZlbnRUaHJvdHRsZSwKICAgICAgICAgIHN0aWNreUhlYWRlckluZGljZXM6IHN0aWNreUhlYWRlckluZGljZXMKICAgICAgICB9KTsKCiAgICAgICAgaWYgKGludmVyc2lvblN0eWxlKSB7CiAgICAgICAgICBzY3JvbGxQcm9wcy5zdHlsZSA9IFtpbnZlcnNpb25TdHlsZSwgdGhpcy5wcm9wcy5zdHlsZV07CiAgICAgICAgfQoKICAgICAgICB2YXIgcmV0ID0gUmVhY3QuY2xvbmVFbGVtZW50KCh0aGlzLnByb3BzLnJlbmRlclNjcm9sbENvbXBvbmVudCB8fCB0aGlzLl9kZWZhdWx0UmVuZGVyU2Nyb2xsQ29tcG9uZW50KShzY3JvbGxQcm9wcyksIHsKICAgICAgICAgIHJlZjogdGhpcy5fY2FwdHVyZVNjcm9sbFJlZgogICAgICAgIH0sIGNlbGxzKTsKCiAgICAgICAgaWYgKHRoaXMucHJvcHMuZGVidWcpIHsKICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBWaWV3LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgIGZsZXg6IDEKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogNzkzCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICByZXQsCiAgICAgICAgICAgIHRoaXMuX3JlbmRlckRlYnVnT3ZlcmxheSgpCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjb21wb25lbnREaWRVcGRhdGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29tcG9uZW50RGlkVXBkYXRlKCkgewogICAgICAgIHRoaXMuX3NjaGVkdWxlQ2VsbHNUb1JlbmRlclVwZGF0ZSgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9jb21wdXRlQmxhbmtuZXNzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9jb21wdXRlQmxhbmtuZXNzKCkgewogICAgICAgIHRoaXMuX2ZpbGxSYXRlSGVscGVyLmNvbXB1dGVCbGFua25lc3ModGhpcy5wcm9wcywgdGhpcy5zdGF0ZSwgdGhpcy5fc2Nyb2xsTWV0cmljcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX29uQ2VsbExheW91dCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfb25DZWxsTGF5b3V0KGUsIGNlbGxLZXksIGluZGV4KSB7CiAgICAgICAgdmFyIGxheW91dCA9IGUubmF0aXZlRXZlbnQubGF5b3V0OwogICAgICAgIHZhciBuZXh0ID0gewogICAgICAgICAgb2Zmc2V0OiB0aGlzLl9zZWxlY3RPZmZzZXQobGF5b3V0KSwKICAgICAgICAgIGxlbmd0aDogdGhpcy5fc2VsZWN0TGVuZ3RoKGxheW91dCksCiAgICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgICBpbkxheW91dDogdHJ1ZQogICAgICAgIH07CiAgICAgICAgdmFyIGN1cnIgPSB0aGlzLl9mcmFtZXNbY2VsbEtleV07CgogICAgICAgIGlmICghY3VyciB8fCBuZXh0Lm9mZnNldCAhPT0gY3Vyci5vZmZzZXQgfHwgbmV4dC5sZW5ndGggIT09IGN1cnIubGVuZ3RoIHx8IGluZGV4ICE9PSBjdXJyLmluZGV4KSB7CiAgICAgICAgICB0aGlzLl90b3RhbENlbGxMZW5ndGggKz0gbmV4dC5sZW5ndGggLSAoY3VyciA/IGN1cnIubGVuZ3RoIDogMCk7CiAgICAgICAgICB0aGlzLl90b3RhbENlbGxzTWVhc3VyZWQgKz0gY3VyciA/IDAgOiAxOwogICAgICAgICAgdGhpcy5fYXZlcmFnZUNlbGxMZW5ndGggPSB0aGlzLl90b3RhbENlbGxMZW5ndGggLyB0aGlzLl90b3RhbENlbGxzTWVhc3VyZWQ7CiAgICAgICAgICB0aGlzLl9mcmFtZXNbY2VsbEtleV0gPSBuZXh0OwogICAgICAgICAgdGhpcy5faGlnaGVzdE1lYXN1cmVkRnJhbWVJbmRleCA9IE1hdGgubWF4KHRoaXMuX2hpZ2hlc3RNZWFzdXJlZEZyYW1lSW5kZXgsIGluZGV4KTsKCiAgICAgICAgICB0aGlzLl9zY2hlZHVsZUNlbGxzVG9SZW5kZXJVcGRhdGUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fZnJhbWVzW2NlbGxLZXldLmluTGF5b3V0ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2NvbXB1dGVCbGFua25lc3MoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfcmVuZGVyRGVidWdPdmVybGF5IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9yZW5kZXJEZWJ1Z092ZXJsYXkoKSB7CiAgICAgICAgdmFyIG5vcm1hbGl6ZSA9IHRoaXMuX3Njcm9sbE1ldHJpY3MudmlzaWJsZUxlbmd0aCAvIHRoaXMuX3Njcm9sbE1ldHJpY3MuY29udGVudExlbmd0aDsKICAgICAgICB2YXIgZnJhbWVzSW5MYXlvdXQgPSBbXTsKICAgICAgICB2YXIgaXRlbUNvdW50ID0gdGhpcy5wcm9wcy5nZXRJdGVtQ291bnQodGhpcy5wcm9wcy5kYXRhKTsKCiAgICAgICAgZm9yICh2YXIgaWkgPSAwOyBpaSA8IGl0ZW1Db3VudDsgaWkrKykgewogICAgICAgICAgdmFyIGZyYW1lID0gdGhpcy5fZ2V0RnJhbWVNZXRyaWNzQXBwcm94KGlpKTsKCiAgICAgICAgICBpZiAoZnJhbWUuaW5MYXlvdXQpIHsKICAgICAgICAgICAgZnJhbWVzSW5MYXlvdXQucHVzaChmcmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgd2luZG93VG9wID0gdGhpcy5fZ2V0RnJhbWVNZXRyaWNzQXBwcm94KHRoaXMuc3RhdGUuZmlyc3QpLm9mZnNldDsKCiAgICAgICAgdmFyIGZyYW1lTGFzdCA9IHRoaXMuX2dldEZyYW1lTWV0cmljc0FwcHJveCh0aGlzLnN0YXRlLmxhc3QpOwoKICAgICAgICB2YXIgd2luZG93TGVuID0gZnJhbWVMYXN0Lm9mZnNldCArIGZyYW1lTGFzdC5sZW5ndGggLSB3aW5kb3dUb3A7CiAgICAgICAgdmFyIHZpc1RvcCA9IHRoaXMuX3Njcm9sbE1ldHJpY3Mub2Zmc2V0OwogICAgICAgIHZhciB2aXNMZW4gPSB0aGlzLl9zY3JvbGxNZXRyaWNzLnZpc2libGVMZW5ndGg7CiAgICAgICAgdmFyIGJhc2VTdHlsZSA9IHsKICAgICAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgcmlnaHQ6IDAKICAgICAgICB9OwogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBiYXNlU3R5bGUsIHsKICAgICAgICAgICAgICBib3R0b206IDAsCiAgICAgICAgICAgICAgd2lkdGg6IDIwLAogICAgICAgICAgICAgIGJvcmRlckNvbG9yOiAnYmx1ZScsCiAgICAgICAgICAgICAgYm9yZGVyV2lkdGg6IDEKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA5NTIKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGZyYW1lc0luTGF5b3V0Lm1hcChmdW5jdGlvbiAoZiwgaWkpIHsKICAgICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoVmlldywgewogICAgICAgICAgICAgIGtleTogJ2YnICsgaWksCiAgICAgICAgICAgICAgc3R5bGU6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBiYXNlU3R5bGUsIHsKICAgICAgICAgICAgICAgIGxlZnQ6IDAsCiAgICAgICAgICAgICAgICB0b3A6IGYub2Zmc2V0ICogbm9ybWFsaXplLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBmLmxlbmd0aCAqIG5vcm1hbGl6ZSwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJ29yYW5nZScKICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDk2MQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KSwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoVmlldywgewogICAgICAgICAgICBzdHlsZTogYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIGJhc2VTdHlsZSwgewogICAgICAgICAgICAgIGxlZnQ6IDAsCiAgICAgICAgICAgICAgdG9wOiB3aW5kb3dUb3AgKiBub3JtYWxpemUsCiAgICAgICAgICAgICAgaGVpZ2h0OiB3aW5kb3dMZW4gKiBub3JtYWxpemUsCiAgICAgICAgICAgICAgYm9yZGVyQ29sb3I6ICdncmVlbicsCiAgICAgICAgICAgICAgYm9yZGVyV2lkdGg6IDIKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA5NzIKICAgICAgICAgICAgfQogICAgICAgICAgfSksCiAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KFZpZXcsIHsKICAgICAgICAgICAgc3R5bGU6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBiYXNlU3R5bGUsIHsKICAgICAgICAgICAgICBsZWZ0OiAwLAogICAgICAgICAgICAgIHRvcDogdmlzVG9wICogbm9ybWFsaXplLAogICAgICAgICAgICAgIGhlaWdodDogdmlzTGVuICogbm9ybWFsaXplLAogICAgICAgICAgICAgIGJvcmRlckNvbG9yOiAncmVkJywKICAgICAgICAgICAgICBib3JkZXJXaWR0aDogMgogICAgICAgICAgICB9KSwKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDk4MgogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgICk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX3NlbGVjdExlbmd0aCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfc2VsZWN0TGVuZ3RoKG1ldHJpY3MpIHsKICAgICAgICByZXR1cm4gIXRoaXMucHJvcHMuaG9yaXpvbnRhbCA/IG1ldHJpY3MuaGVpZ2h0IDogbWV0cmljcy53aWR0aDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfc2VsZWN0T2Zmc2V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9zZWxlY3RPZmZzZXQobWV0cmljcykgewogICAgICAgIHJldHVybiAhdGhpcy5wcm9wcy5ob3Jpem9udGFsID8gbWV0cmljcy55IDogbWV0cmljcy54OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9tYXliZUNhbGxPbkVuZFJlYWNoZWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX21heWJlQ2FsbE9uRW5kUmVhY2hlZCgpIHsKICAgICAgICB2YXIgX3Byb3BzNiA9IHRoaXMucHJvcHMsCiAgICAgICAgICAgIGRhdGEgPSBfcHJvcHM2LmRhdGEsCiAgICAgICAgICAgIGdldEl0ZW1Db3VudCA9IF9wcm9wczYuZ2V0SXRlbUNvdW50LAogICAgICAgICAgICBvbkVuZFJlYWNoZWQgPSBfcHJvcHM2Lm9uRW5kUmVhY2hlZCwKICAgICAgICAgICAgb25FbmRSZWFjaGVkVGhyZXNob2xkID0gX3Byb3BzNi5vbkVuZFJlYWNoZWRUaHJlc2hvbGQ7CiAgICAgICAgdmFyIF9zY3JvbGxNZXRyaWNzID0gdGhpcy5fc2Nyb2xsTWV0cmljcywKICAgICAgICAgICAgY29udGVudExlbmd0aCA9IF9zY3JvbGxNZXRyaWNzLmNvbnRlbnRMZW5ndGgsCiAgICAgICAgICAgIHZpc2libGVMZW5ndGggPSBfc2Nyb2xsTWV0cmljcy52aXNpYmxlTGVuZ3RoLAogICAgICAgICAgICBvZmZzZXQgPSBfc2Nyb2xsTWV0cmljcy5vZmZzZXQ7CiAgICAgICAgdmFyIGRpc3RhbmNlRnJvbUVuZCA9IGNvbnRlbnRMZW5ndGggLSB2aXNpYmxlTGVuZ3RoIC0gb2Zmc2V0OwoKICAgICAgICBpZiAob25FbmRSZWFjaGVkICYmIHRoaXMuc3RhdGUubGFzdCA9PT0gZ2V0SXRlbUNvdW50KGRhdGEpIC0gMSAmJiBkaXN0YW5jZUZyb21FbmQgPCBvbkVuZFJlYWNoZWRUaHJlc2hvbGQgKiB2aXNpYmxlTGVuZ3RoICYmICh0aGlzLl9oYXNEYXRhQ2hhbmdlZFNpbmNlRW5kUmVhY2hlZCB8fCB0aGlzLl9zY3JvbGxNZXRyaWNzLmNvbnRlbnRMZW5ndGggIT09IHRoaXMuX3NlbnRFbmRGb3JDb250ZW50TGVuZ3RoKSkgewogICAgICAgICAgdGhpcy5faGFzRGF0YUNoYW5nZWRTaW5jZUVuZFJlYWNoZWQgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuX3NlbnRFbmRGb3JDb250ZW50TGVuZ3RoID0gdGhpcy5fc2Nyb2xsTWV0cmljcy5jb250ZW50TGVuZ3RoOwogICAgICAgICAgb25FbmRSZWFjaGVkKHsKICAgICAgICAgICAgZGlzdGFuY2VGcm9tRW5kOiBkaXN0YW5jZUZyb21FbmQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfc2NoZWR1bGVDZWxsc1RvUmVuZGVyVXBkYXRlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9zY2hlZHVsZUNlbGxzVG9SZW5kZXJVcGRhdGUoKSB7CiAgICAgICAgdmFyIF9zdGF0ZTIgPSB0aGlzLnN0YXRlLAogICAgICAgICAgICBmaXJzdCA9IF9zdGF0ZTIuZmlyc3QsCiAgICAgICAgICAgIGxhc3QgPSBfc3RhdGUyLmxhc3Q7CiAgICAgICAgdmFyIF9zY3JvbGxNZXRyaWNzMiA9IHRoaXMuX3Njcm9sbE1ldHJpY3MsCiAgICAgICAgICAgIG9mZnNldCA9IF9zY3JvbGxNZXRyaWNzMi5vZmZzZXQsCiAgICAgICAgICAgIHZpc2libGVMZW5ndGggPSBfc2Nyb2xsTWV0cmljczIudmlzaWJsZUxlbmd0aCwKICAgICAgICAgICAgdmVsb2NpdHkgPSBfc2Nyb2xsTWV0cmljczIudmVsb2NpdHk7CiAgICAgICAgdmFyIGl0ZW1Db3VudCA9IHRoaXMucHJvcHMuZ2V0SXRlbUNvdW50KHRoaXMucHJvcHMuZGF0YSk7CiAgICAgICAgdmFyIGhpUHJpID0gZmFsc2U7CgogICAgICAgIGlmIChmaXJzdCA+IDAgfHwgbGFzdCA8IGl0ZW1Db3VudCAtIDEpIHsKICAgICAgICAgIHZhciBkaXN0VG9wID0gb2Zmc2V0IC0gdGhpcy5fZ2V0RnJhbWVNZXRyaWNzQXBwcm94KGZpcnN0KS5vZmZzZXQ7CgogICAgICAgICAgdmFyIGRpc3RCb3R0b20gPSB0aGlzLl9nZXRGcmFtZU1ldHJpY3NBcHByb3gobGFzdCkub2Zmc2V0IC0gKG9mZnNldCArIHZpc2libGVMZW5ndGgpOwogICAgICAgICAgdmFyIHNjcm9sbGluZ1RocmVzaG9sZCA9IHRoaXMucHJvcHMub25FbmRSZWFjaGVkVGhyZXNob2xkICogdmlzaWJsZUxlbmd0aCAvIDI7CiAgICAgICAgICBoaVByaSA9IE1hdGgubWluKGRpc3RUb3AsIGRpc3RCb3R0b20pIDwgMCB8fCB2ZWxvY2l0eSA8IC0yICYmIGRpc3RUb3AgPCBzY3JvbGxpbmdUaHJlc2hvbGQgfHwgdmVsb2NpdHkgPiAyICYmIGRpc3RCb3R0b20gPCBzY3JvbGxpbmdUaHJlc2hvbGQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoaGlQcmkgJiYgdGhpcy5fYXZlcmFnZUNlbGxMZW5ndGgpIHsKICAgICAgICAgIHRoaXMuX3VwZGF0ZUNlbGxzVG9SZW5kZXJCYXRjaGVyLmRpc3Bvc2UoewogICAgICAgICAgICBhYm9ydDogdHJ1ZQogICAgICAgICAgfSk7CgogICAgICAgICAgdGhpcy5fdXBkYXRlQ2VsbHNUb1JlbmRlcigpOwoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fdXBkYXRlQ2VsbHNUb1JlbmRlckJhdGNoZXIuc2NoZWR1bGUoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX3VwZGF0ZVZpZXdhYmxlSXRlbXMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX3VwZGF0ZVZpZXdhYmxlSXRlbXMoZGF0YSkgewogICAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgICB2YXIgZ2V0SXRlbUNvdW50ID0gdGhpcy5wcm9wcy5nZXRJdGVtQ291bnQ7CgogICAgICAgIHRoaXMuX3ZpZXdhYmlsaXR5VHVwbGVzLmZvckVhY2goZnVuY3Rpb24gKHR1cGxlKSB7CiAgICAgICAgICB0dXBsZS52aWV3YWJpbGl0eUhlbHBlci5vblVwZGF0ZShnZXRJdGVtQ291bnQoZGF0YSksIF90aGlzNC5fc2Nyb2xsTWV0cmljcy5vZmZzZXQsIF90aGlzNC5fc2Nyb2xsTWV0cmljcy52aXNpYmxlTGVuZ3RoLCBfdGhpczQuX2dldEZyYW1lTWV0cmljcywgX3RoaXM0Ll9jcmVhdGVWaWV3VG9rZW4sIHR1cGxlLm9uVmlld2FibGVJdGVtc0NoYW5nZWQsIF90aGlzNC5zdGF0ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBWaXJ0dWFsaXplZExpc3Q7CiAgfShSZWFjdC5QdXJlQ29tcG9uZW50KSwgX2NsYXNzLmRlZmF1bHRQcm9wcyA9IHsKICAgIGRpc2FibGVWaXJ0dWFsaXphdGlvbjogZmFsc2UsCiAgICBob3Jpem9udGFsOiBmYWxzZSwKICAgIGluaXRpYWxOdW1Ub1JlbmRlcjogMTAsCiAgICBrZXlFeHRyYWN0b3I6IGZ1bmN0aW9uIGtleUV4dHJhY3RvcihpdGVtLCBpbmRleCkgewogICAgICBpZiAoaXRlbS5rZXkgIT0gbnVsbCkgewogICAgICAgIHJldHVybiBpdGVtLmtleTsKICAgICAgfQoKICAgICAgX3VzZWRJbmRleEZvcktleSA9IHRydWU7CiAgICAgIHJldHVybiBTdHJpbmcoaW5kZXgpOwogICAgfSwKICAgIG1heFRvUmVuZGVyUGVyQmF0Y2g6IDEwLAogICAgb25FbmRSZWFjaGVkVGhyZXNob2xkOiAyLAogICAgc2Nyb2xsRXZlbnRUaHJvdHRsZTogNTAsCiAgICB1cGRhdGVDZWxsc0JhdGNoaW5nUGVyaW9kOiA1MCwKICAgIHdpbmRvd1NpemU6IDIxCiAgfSwgX2NsYXNzLmNvbnRleHRUeXBlcyA9IHsKICAgIHZpcnR1YWxpemVkTGlzdDogUHJvcFR5cGVzLnNoYXBlKHsKICAgICAgaG9yaXpvbnRhbDogUHJvcFR5cGVzLmJvb2wKICAgIH0pCiAgfSwgX2NsYXNzLmNoaWxkQ29udGV4dFR5cGVzID0gewogICAgdmlydHVhbGl6ZWRMaXN0OiBQcm9wVHlwZXMuc2hhcGUoewogICAgICBob3Jpem9udGFsOiBQcm9wVHlwZXMuYm9vbAogICAgfSkKICB9LCBfaW5pdGlhbGlzZVByb3BzID0gZnVuY3Rpb24gX2luaXRpYWxpc2VQcm9wcygpIHsKICAgIHZhciBfdGhpczUgPSB0aGlzOwoKICAgIHRoaXMuX29uVXBkYXRlU2VwYXJhdG9ycyA9IGZ1bmN0aW9uIChrZXlzLCBuZXdQcm9wcykgewogICAgICBrZXlzLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIHZhciByZWYgPSBrZXkgIT0gbnVsbCAmJiBfdGhpczUuX2NlbGxSZWZzW2tleV07CiAgICAgICAgcmVmICYmIHJlZi51cGRhdGVTZXBhcmF0b3JQcm9wcyhuZXdQcm9wcyk7CiAgICAgIH0pOwogICAgfTsKCiAgICB0aGlzLl9hdmVyYWdlQ2VsbExlbmd0aCA9IDA7CiAgICB0aGlzLl9jZWxsUmVmcyA9IHt9OwogICAgdGhpcy5faGFzRGF0YUNoYW5nZWRTaW5jZUVuZFJlYWNoZWQgPSB0cnVlOwogICAgdGhpcy5faGFzV2FybmVkID0ge307CiAgICB0aGlzLl9oaWdoZXN0TWVhc3VyZWRGcmFtZUluZGV4ID0gMDsKICAgIHRoaXMuX2hlYWRlckxlbmd0aCA9IDA7CiAgICB0aGlzLl9pbml0aWFsU2Nyb2xsSW5kZXhUaW1lb3V0ID0gMDsKICAgIHRoaXMuX2ZyYW1lcyA9IHt9OwogICAgdGhpcy5fZm9vdGVyTGVuZ3RoID0gMDsKICAgIHRoaXMuX3Njcm9sbE1ldHJpY3MgPSB7CiAgICAgIGNvbnRlbnRMZW5ndGg6IDAsCiAgICAgIGRPZmZzZXQ6IDAsCiAgICAgIGR0OiAxMCwKICAgICAgb2Zmc2V0OiAwLAogICAgICB0aW1lc3RhbXA6IDAsCiAgICAgIHZlbG9jaXR5OiAwLAogICAgICB2aXNpYmxlTGVuZ3RoOiAwCiAgICB9OwogICAgdGhpcy5fc2Nyb2xsUmVmID0gbnVsbDsKICAgIHRoaXMuX3NlbnRFbmRGb3JDb250ZW50TGVuZ3RoID0gMDsKICAgIHRoaXMuX3RvdGFsQ2VsbExlbmd0aCA9IDA7CiAgICB0aGlzLl90b3RhbENlbGxzTWVhc3VyZWQgPSAwOwogICAgdGhpcy5fdmlld2FiaWxpdHlUdXBsZXMgPSBbXTsKCiAgICB0aGlzLl9jYXB0dXJlU2Nyb2xsUmVmID0gZnVuY3Rpb24gKHJlZikgewogICAgICBfdGhpczUuX3Njcm9sbFJlZiA9IHJlZjsKICAgIH07CgogICAgdGhpcy5fZGVmYXVsdFJlbmRlclNjcm9sbENvbXBvbmVudCA9IGZ1bmN0aW9uIChwcm9wcykgewogICAgICBpZiAoX3RoaXM1Ll9pc05lc3RlZFdpdGhTYW1lT3JpZW50YXRpb24oKSkgewogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFZpZXcsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBwcm9wcywgewogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogODQ3CiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9IGVsc2UgaWYgKHByb3BzLm9uUmVmcmVzaCkgewogICAgICAgIGludmFyaWFudCh0eXBlb2YgcHJvcHMucmVmcmVzaGluZyA9PT0gJ2Jvb2xlYW4nLCAnYHJlZnJlc2hpbmdgIHByb3AgbXVzdCBiZSBzZXQgYXMgYSBib29sZWFuIGluIG9yZGVyIHRvIHVzZSBgb25SZWZyZXNoYCwgYnV0IGdvdCBgJyArIEpTT04uc3RyaW5naWZ5KHByb3BzLnJlZnJlc2hpbmcpICsgJ2AnKTsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChTY3JvbGxWaWV3LCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgcHJvcHMsIHsKICAgICAgICAgIHJlZnJlc2hDb250cm9sOiBSZWFjdC5jcmVhdGVFbGVtZW50KFJlZnJlc2hDb250cm9sLCB7CiAgICAgICAgICAgIHJlZnJlc2hpbmc6IHByb3BzLnJlZnJlc2hpbmcsCiAgICAgICAgICAgIG9uUmVmcmVzaDogcHJvcHMub25SZWZyZXNoLAogICAgICAgICAgICBwcm9ncmVzc1ZpZXdPZmZzZXQ6IHByb3BzLnByb2dyZXNzVmlld09mZnNldCwKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDg2MgogICAgICAgICAgICB9CiAgICAgICAgICB9KSwKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDg1NgogICAgICAgICAgfQogICAgICAgIH0pKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChTY3JvbGxWaWV3LCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgcHJvcHMsIHsKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDg3MQogICAgICAgICAgfQogICAgICAgIH0pKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLl9vbkNlbGxVbm1vdW50ID0gZnVuY3Rpb24gKGNlbGxLZXkpIHsKICAgICAgdmFyIGN1cnIgPSBfdGhpczUuX2ZyYW1lc1tjZWxsS2V5XTsKCiAgICAgIGlmIChjdXJyKSB7CiAgICAgICAgX3RoaXM1Ll9mcmFtZXNbY2VsbEtleV0gPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgY3VyciwgewogICAgICAgICAgaW5MYXlvdXQ6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgdGhpcy5fb25MYXlvdXQgPSBmdW5jdGlvbiAoZSkgewogICAgICBfdGhpczUuX3Njcm9sbE1ldHJpY3MudmlzaWJsZUxlbmd0aCA9IF90aGlzNS5fc2VsZWN0TGVuZ3RoKGUubmF0aXZlRXZlbnQubGF5b3V0KTsKICAgICAgX3RoaXM1LnByb3BzLm9uTGF5b3V0ICYmIF90aGlzNS5wcm9wcy5vbkxheW91dChlKTsKCiAgICAgIF90aGlzNS5fc2NoZWR1bGVDZWxsc1RvUmVuZGVyVXBkYXRlKCk7CgogICAgICBfdGhpczUuX21heWJlQ2FsbE9uRW5kUmVhY2hlZCgpOwogICAgfTsKCiAgICB0aGlzLl9vbkxheW91dEVtcHR5ID0gZnVuY3Rpb24gKGUpIHsKICAgICAgX3RoaXM1LnByb3BzLm9uTGF5b3V0ICYmIF90aGlzNS5wcm9wcy5vbkxheW91dChlKTsKICAgIH07CgogICAgdGhpcy5fb25MYXlvdXRGb290ZXIgPSBmdW5jdGlvbiAoZSkgewogICAgICBfdGhpczUuX2Zvb3Rlckxlbmd0aCA9IF90aGlzNS5fc2VsZWN0TGVuZ3RoKGUubmF0aXZlRXZlbnQubGF5b3V0KTsKICAgIH07CgogICAgdGhpcy5fb25MYXlvdXRIZWFkZXIgPSBmdW5jdGlvbiAoZSkgewogICAgICBfdGhpczUuX2hlYWRlckxlbmd0aCA9IF90aGlzNS5fc2VsZWN0TGVuZ3RoKGUubmF0aXZlRXZlbnQubGF5b3V0KTsKICAgIH07CgogICAgdGhpcy5fb25Db250ZW50U2l6ZUNoYW5nZSA9IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0KSB7CiAgICAgIGlmIChfdGhpczUucHJvcHMub25Db250ZW50U2l6ZUNoYW5nZSkgewogICAgICAgIF90aGlzNS5wcm9wcy5vbkNvbnRlbnRTaXplQ2hhbmdlKHdpZHRoLCBoZWlnaHQpOwogICAgICB9CgogICAgICBfdGhpczUuX3Njcm9sbE1ldHJpY3MuY29udGVudExlbmd0aCA9IF90aGlzNS5fc2VsZWN0TGVuZ3RoKHsKICAgICAgICBoZWlnaHQ6IGhlaWdodCwKICAgICAgICB3aWR0aDogd2lkdGgKICAgICAgfSk7CgogICAgICBfdGhpczUuX3NjaGVkdWxlQ2VsbHNUb1JlbmRlclVwZGF0ZSgpOwoKICAgICAgX3RoaXM1Ll9tYXliZUNhbGxPbkVuZFJlYWNoZWQoKTsKICAgIH07CgogICAgdGhpcy5fb25TY3JvbGwgPSBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoX3RoaXM1LnByb3BzLm9uU2Nyb2xsKSB7CiAgICAgICAgX3RoaXM1LnByb3BzLm9uU2Nyb2xsKGUpOwogICAgICB9CgogICAgICB2YXIgdGltZXN0YW1wID0gZS50aW1lU3RhbXA7CgogICAgICB2YXIgdmlzaWJsZUxlbmd0aCA9IF90aGlzNS5fc2VsZWN0TGVuZ3RoKGUubmF0aXZlRXZlbnQubGF5b3V0TWVhc3VyZW1lbnQpOwoKICAgICAgdmFyIGNvbnRlbnRMZW5ndGggPSBfdGhpczUuX3NlbGVjdExlbmd0aChlLm5hdGl2ZUV2ZW50LmNvbnRlbnRTaXplKTsKCiAgICAgIHZhciBvZmZzZXQgPSBfdGhpczUuX3NlbGVjdE9mZnNldChlLm5hdGl2ZUV2ZW50LmNvbnRlbnRPZmZzZXQpOwoKICAgICAgdmFyIGR0ID0gX3RoaXM1Ll9zY3JvbGxNZXRyaWNzLnRpbWVzdGFtcCA/IE1hdGgubWF4KDEsIHRpbWVzdGFtcCAtIF90aGlzNS5fc2Nyb2xsTWV0cmljcy50aW1lc3RhbXApIDogMTsKCiAgICAgIGlmIChkdCA+IDUwMCAmJiBfdGhpczUuX3Njcm9sbE1ldHJpY3MuZHQgPiA1MDAgJiYgY29udGVudExlbmd0aCA+IDUgKiB2aXNpYmxlTGVuZ3RoICYmICFfdGhpczUuX2hhc1dhcm5lZC5wZXJmKSB7CiAgICAgICAgaW5mb0xvZygnVmlydHVhbGl6ZWRMaXN0OiBZb3UgaGF2ZSBhIGxhcmdlIGxpc3QgdGhhdCBpcyBzbG93IHRvIHVwZGF0ZSAtIG1ha2Ugc3VyZSB5b3VyICcgKyAncmVuZGVySXRlbSBmdW5jdGlvbiByZW5kZXJzIGNvbXBvbmVudHMgdGhhdCBmb2xsb3cgUmVhY3QgcGVyZm9ybWFuY2UgYmVzdCBwcmFjdGljZXMgJyArICdsaWtlIFB1cmVDb21wb25lbnQsIHNob3VsZENvbXBvbmVudFVwZGF0ZSwgZXRjLicsIHsKICAgICAgICAgIGR0OiBkdCwKICAgICAgICAgIHByZXZEdDogX3RoaXM1Ll9zY3JvbGxNZXRyaWNzLmR0LAogICAgICAgICAgY29udGVudExlbmd0aDogY29udGVudExlbmd0aAogICAgICAgIH0pOwogICAgICAgIF90aGlzNS5faGFzV2FybmVkLnBlcmYgPSB0cnVlOwogICAgICB9CgogICAgICB2YXIgZE9mZnNldCA9IG9mZnNldCAtIF90aGlzNS5fc2Nyb2xsTWV0cmljcy5vZmZzZXQ7CiAgICAgIHZhciB2ZWxvY2l0eSA9IGRPZmZzZXQgLyBkdDsKICAgICAgX3RoaXM1Ll9zY3JvbGxNZXRyaWNzID0gewogICAgICAgIGNvbnRlbnRMZW5ndGg6IGNvbnRlbnRMZW5ndGgsCiAgICAgICAgZHQ6IGR0LAogICAgICAgIGRPZmZzZXQ6IGRPZmZzZXQsCiAgICAgICAgb2Zmc2V0OiBvZmZzZXQsCiAgICAgICAgdGltZXN0YW1wOiB0aW1lc3RhbXAsCiAgICAgICAgdmVsb2NpdHk6IHZlbG9jaXR5LAogICAgICAgIHZpc2libGVMZW5ndGg6IHZpc2libGVMZW5ndGgKICAgICAgfTsKCiAgICAgIF90aGlzNS5fdXBkYXRlVmlld2FibGVJdGVtcyhfdGhpczUucHJvcHMuZGF0YSk7CgogICAgICBpZiAoIV90aGlzNS5wcm9wcykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgX3RoaXM1Ll9tYXliZUNhbGxPbkVuZFJlYWNoZWQoKTsKCiAgICAgIGlmICh2ZWxvY2l0eSAhPT0gMCkgewogICAgICAgIF90aGlzNS5fZmlsbFJhdGVIZWxwZXIuYWN0aXZhdGUoKTsKICAgICAgfQoKICAgICAgX3RoaXM1Ll9jb21wdXRlQmxhbmtuZXNzKCk7CgogICAgICBfdGhpczUuX3NjaGVkdWxlQ2VsbHNUb1JlbmRlclVwZGF0ZSgpOwogICAgfTsKCiAgICB0aGlzLl9vblNjcm9sbEJlZ2luRHJhZyA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIF90aGlzNS5fdmlld2FiaWxpdHlUdXBsZXMuZm9yRWFjaChmdW5jdGlvbiAodHVwbGUpIHsKICAgICAgICB0dXBsZS52aWV3YWJpbGl0eUhlbHBlci5yZWNvcmRJbnRlcmFjdGlvbigpOwogICAgICB9KTsKCiAgICAgIF90aGlzNS5wcm9wcy5vblNjcm9sbEJlZ2luRHJhZyAmJiBfdGhpczUucHJvcHMub25TY3JvbGxCZWdpbkRyYWcoZSk7CiAgICB9OwoKICAgIHRoaXMuX29uU2Nyb2xsRW5kRHJhZyA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciB2ZWxvY2l0eSA9IGUubmF0aXZlRXZlbnQudmVsb2NpdHk7CgogICAgICBpZiAodmVsb2NpdHkpIHsKICAgICAgICBfdGhpczUuX3Njcm9sbE1ldHJpY3MudmVsb2NpdHkgPSBfdGhpczUuX3NlbGVjdE9mZnNldCh2ZWxvY2l0eSk7CiAgICAgIH0KCiAgICAgIF90aGlzNS5fY29tcHV0ZUJsYW5rbmVzcygpOwoKICAgICAgX3RoaXM1LnByb3BzLm9uU2Nyb2xsRW5kRHJhZyAmJiBfdGhpczUucHJvcHMub25TY3JvbGxFbmREcmFnKGUpOwogICAgfTsKCiAgICB0aGlzLl9vbk1vbWVudHVtU2Nyb2xsRW5kID0gZnVuY3Rpb24gKGUpIHsKICAgICAgX3RoaXM1Ll9zY3JvbGxNZXRyaWNzLnZlbG9jaXR5ID0gMDsKCiAgICAgIF90aGlzNS5fY29tcHV0ZUJsYW5rbmVzcygpOwoKICAgICAgX3RoaXM1LnByb3BzLm9uTW9tZW50dW1TY3JvbGxFbmQgJiYgX3RoaXM1LnByb3BzLm9uTW9tZW50dW1TY3JvbGxFbmQoZSk7CiAgICB9OwoKICAgIHRoaXMuX3VwZGF0ZUNlbGxzVG9SZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfcHJvcHM3ID0gX3RoaXM1LnByb3BzLAogICAgICAgICAgZGF0YSA9IF9wcm9wczcuZGF0YSwKICAgICAgICAgIGdldEl0ZW1Db3VudCA9IF9wcm9wczcuZ2V0SXRlbUNvdW50LAogICAgICAgICAgb25FbmRSZWFjaGVkVGhyZXNob2xkID0gX3Byb3BzNy5vbkVuZFJlYWNoZWRUaHJlc2hvbGQ7CgogICAgICB2YXIgaXNWaXJ0dWFsaXphdGlvbkRpc2FibGVkID0gX3RoaXM1Ll9pc1ZpcnR1YWxpemF0aW9uRGlzYWJsZWQoKTsKCiAgICAgIF90aGlzNS5fdXBkYXRlVmlld2FibGVJdGVtcyhkYXRhKTsKCiAgICAgIGlmICghZGF0YSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgX3RoaXM1LnNldFN0YXRlKGZ1bmN0aW9uIChzdGF0ZSkgewogICAgICAgIHZhciBuZXdTdGF0ZSA9IHZvaWQgMDsKCiAgICAgICAgaWYgKCFpc1ZpcnR1YWxpemF0aW9uRGlzYWJsZWQpIHsKICAgICAgICAgIGlmIChfdGhpczUuX3Njcm9sbE1ldHJpY3MudmlzaWJsZUxlbmd0aCkgewogICAgICAgICAgICBpZiAoIV90aGlzNS5wcm9wcy5pbml0aWFsU2Nyb2xsSW5kZXggfHwgX3RoaXM1Ll9zY3JvbGxNZXRyaWNzLm9mZnNldCkgewogICAgICAgICAgICAgIG5ld1N0YXRlID0gY29tcHV0ZVdpbmRvd2VkUmVuZGVyTGltaXRzKF90aGlzNS5wcm9wcywgc3RhdGUsIF90aGlzNS5fZ2V0RnJhbWVNZXRyaWNzQXBwcm94LCBfdGhpczUuX3Njcm9sbE1ldHJpY3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBfc2Nyb2xsTWV0cmljczMgPSBfdGhpczUuX3Njcm9sbE1ldHJpY3MsCiAgICAgICAgICAgICAgY29udGVudExlbmd0aCA9IF9zY3JvbGxNZXRyaWNzMy5jb250ZW50TGVuZ3RoLAogICAgICAgICAgICAgIF9vZmZzZXQgPSBfc2Nyb2xsTWV0cmljczMub2Zmc2V0LAogICAgICAgICAgICAgIHZpc2libGVMZW5ndGggPSBfc2Nyb2xsTWV0cmljczMudmlzaWJsZUxlbmd0aDsKCiAgICAgICAgICB2YXIgX2Rpc3RhbmNlRnJvbUVuZCA9IGNvbnRlbnRMZW5ndGggLSB2aXNpYmxlTGVuZ3RoIC0gX29mZnNldDsKCiAgICAgICAgICB2YXIgcmVuZGVyQWhlYWQgPSBfZGlzdGFuY2VGcm9tRW5kIDwgb25FbmRSZWFjaGVkVGhyZXNob2xkICogdmlzaWJsZUxlbmd0aCA/IF90aGlzNS5wcm9wcy5tYXhUb1JlbmRlclBlckJhdGNoIDogMDsKICAgICAgICAgIG5ld1N0YXRlID0gewogICAgICAgICAgICBmaXJzdDogMCwKICAgICAgICAgICAgbGFzdDogTWF0aC5taW4oc3RhdGUubGFzdCArIHJlbmRlckFoZWFkLCBnZXRJdGVtQ291bnQoZGF0YSkgLSAxKQogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBuZXdTdGF0ZTsKICAgICAgfSk7CiAgICB9OwoKICAgIHRoaXMuX2NyZWF0ZVZpZXdUb2tlbiA9IGZ1bmN0aW9uIChpbmRleCwgaXNWaWV3YWJsZSkgewogICAgICB2YXIgX3Byb3BzOCA9IF90aGlzNS5wcm9wcywKICAgICAgICAgIGRhdGEgPSBfcHJvcHM4LmRhdGEsCiAgICAgICAgICBnZXRJdGVtID0gX3Byb3BzOC5nZXRJdGVtLAogICAgICAgICAga2V5RXh0cmFjdG9yID0gX3Byb3BzOC5rZXlFeHRyYWN0b3I7CiAgICAgIHZhciBpdGVtID0gZ2V0SXRlbShkYXRhLCBpbmRleCk7CiAgICAgIHJldHVybiB7CiAgICAgICAgaW5kZXg6IGluZGV4LAogICAgICAgIGl0ZW06IGl0ZW0sCiAgICAgICAga2V5OiBrZXlFeHRyYWN0b3IoaXRlbSwgaW5kZXgpLAogICAgICAgIGlzVmlld2FibGU6IGlzVmlld2FibGUKICAgICAgfTsKICAgIH07CgogICAgdGhpcy5fZ2V0RnJhbWVNZXRyaWNzQXBwcm94ID0gZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgIHZhciBmcmFtZSA9IF90aGlzNS5fZ2V0RnJhbWVNZXRyaWNzKGluZGV4KTsKCiAgICAgIGlmIChmcmFtZSAmJiBmcmFtZS5pbmRleCA9PT0gaW5kZXgpIHsKICAgICAgICByZXR1cm4gZnJhbWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIF9nZXRJdGVtTGF5b3V0ID0gX3RoaXM1LnByb3BzLmdldEl0ZW1MYXlvdXQ7CiAgICAgICAgaW52YXJpYW50KCFfZ2V0SXRlbUxheW91dCwgJ1Nob3VsZCBub3QgaGF2ZSB0byBlc3RpbWF0ZSBmcmFtZXMgd2hlbiBhIG1lYXN1cmVtZW50IG1ldHJpY3MgZnVuY3Rpb24gaXMgcHJvdmlkZWQnKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbGVuZ3RoOiBfdGhpczUuX2F2ZXJhZ2VDZWxsTGVuZ3RoLAogICAgICAgICAgb2Zmc2V0OiBfdGhpczUuX2F2ZXJhZ2VDZWxsTGVuZ3RoICogaW5kZXgKICAgICAgICB9OwogICAgICB9CiAgICB9OwoKICAgIHRoaXMuX2dldEZyYW1lTWV0cmljcyA9IGZ1bmN0aW9uIChpbmRleCkgewogICAgICB2YXIgX3Byb3BzOSA9IF90aGlzNS5wcm9wcywKICAgICAgICAgIGRhdGEgPSBfcHJvcHM5LmRhdGEsCiAgICAgICAgICBnZXRJdGVtID0gX3Byb3BzOS5nZXRJdGVtLAogICAgICAgICAgZ2V0SXRlbUNvdW50ID0gX3Byb3BzOS5nZXRJdGVtQ291bnQsCiAgICAgICAgICBnZXRJdGVtTGF5b3V0ID0gX3Byb3BzOS5nZXRJdGVtTGF5b3V0LAogICAgICAgICAga2V5RXh0cmFjdG9yID0gX3Byb3BzOS5rZXlFeHRyYWN0b3I7CiAgICAgIGludmFyaWFudChnZXRJdGVtQ291bnQoZGF0YSkgPiBpbmRleCwgJ1RyaWVkIHRvIGdldCBmcmFtZSBmb3Igb3V0IG9mIHJhbmdlIGluZGV4ICcgKyBpbmRleCk7CiAgICAgIHZhciBpdGVtID0gZ2V0SXRlbShkYXRhLCBpbmRleCk7CgogICAgICB2YXIgZnJhbWUgPSBpdGVtICYmIF90aGlzNS5fZnJhbWVzW2tleUV4dHJhY3RvcihpdGVtLCBpbmRleCldOwoKICAgICAgaWYgKCFmcmFtZSB8fCBmcmFtZS5pbmRleCAhPT0gaW5kZXgpIHsKICAgICAgICBpZiAoZ2V0SXRlbUxheW91dCkgewogICAgICAgICAgZnJhbWUgPSBnZXRJdGVtTGF5b3V0KGRhdGEsIGluZGV4KTsKCiAgICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgICB2YXIgZnJhbWVUeXBlID0gUHJvcFR5cGVzLnNoYXBlKHsKICAgICAgICAgICAgICBsZW5ndGg6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCwKICAgICAgICAgICAgICBvZmZzZXQ6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCwKICAgICAgICAgICAgICBpbmRleDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkCiAgICAgICAgICAgIH0pLmlzUmVxdWlyZWQ7CiAgICAgICAgICAgIFByb3BUeXBlcy5jaGVja1Byb3BUeXBlcyh7CiAgICAgICAgICAgICAgZnJhbWU6IGZyYW1lVHlwZQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgZnJhbWU6IGZyYW1lCiAgICAgICAgICAgIH0sICdmcmFtZScsICdWaXJ0dWFsaXplZExpc3QuZ2V0SXRlbUxheW91dCcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGZyYW1lOwogICAgfTsKICB9LCBfdGVtcCk7CgogIHZhciBDZWxsUmVuZGVyZXIgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKENlbGxSZW5kZXJlciwgX1JlYWN0JENvbXBvbmVudCk7CgogICAgZnVuY3Rpb24gQ2VsbFJlbmRlcmVyKCkgewogICAgICB2YXIgX3JlZjY7CgogICAgICB2YXIgX3RlbXAyLCBfdGhpczYsIF9yZXQyOwoKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIENlbGxSZW5kZXJlcik7CgogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiBfcmV0MiA9IChfdGVtcDIgPSAoX3RoaXM2ID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKF9yZWY2ID0gQ2VsbFJlbmRlcmVyLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQ2VsbFJlbmRlcmVyKSkuY2FsbC5hcHBseShfcmVmNiwgW3RoaXNdLmNvbmNhdChhcmdzKSkpLCBfdGhpczYpLCBfdGhpczYuc3RhdGUgPSB7CiAgICAgICAgc2VwYXJhdG9yUHJvcHM6IHsKICAgICAgICAgIGhpZ2hsaWdodGVkOiBmYWxzZSwKICAgICAgICAgIGxlYWRpbmdJdGVtOiBfdGhpczYucHJvcHMuaXRlbQogICAgICAgIH0KICAgICAgfSwgX3RoaXM2Ll9zZXBhcmF0b3JzID0gewogICAgICAgIGhpZ2hsaWdodDogZnVuY3Rpb24gaGlnaGxpZ2h0KCkgewogICAgICAgICAgdmFyIF90aGlzNiRwcm9wcyA9IF90aGlzNi5wcm9wcywKICAgICAgICAgICAgICBjZWxsS2V5ID0gX3RoaXM2JHByb3BzLmNlbGxLZXksCiAgICAgICAgICAgICAgcHJldkNlbGxLZXkgPSBfdGhpczYkcHJvcHMucHJldkNlbGxLZXk7CgogICAgICAgICAgX3RoaXM2LnByb3BzLm9uVXBkYXRlU2VwYXJhdG9ycyhbY2VsbEtleSwgcHJldkNlbGxLZXldLCB7CiAgICAgICAgICAgIGhpZ2hsaWdodGVkOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHVuaGlnaGxpZ2h0OiBmdW5jdGlvbiB1bmhpZ2hsaWdodCgpIHsKICAgICAgICAgIHZhciBfdGhpczYkcHJvcHMyID0gX3RoaXM2LnByb3BzLAogICAgICAgICAgICAgIGNlbGxLZXkgPSBfdGhpczYkcHJvcHMyLmNlbGxLZXksCiAgICAgICAgICAgICAgcHJldkNlbGxLZXkgPSBfdGhpczYkcHJvcHMyLnByZXZDZWxsS2V5OwoKICAgICAgICAgIF90aGlzNi5wcm9wcy5vblVwZGF0ZVNlcGFyYXRvcnMoW2NlbGxLZXksIHByZXZDZWxsS2V5XSwgewogICAgICAgICAgICBoaWdobGlnaHRlZDogZmFsc2UKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgdXBkYXRlUHJvcHM6IGZ1bmN0aW9uIHVwZGF0ZVByb3BzKHNlbGVjdCwgbmV3UHJvcHMpIHsKICAgICAgICAgIHZhciBfdGhpczYkcHJvcHMzID0gX3RoaXM2LnByb3BzLAogICAgICAgICAgICAgIGNlbGxLZXkgPSBfdGhpczYkcHJvcHMzLmNlbGxLZXksCiAgICAgICAgICAgICAgcHJldkNlbGxLZXkgPSBfdGhpczYkcHJvcHMzLnByZXZDZWxsS2V5OwoKICAgICAgICAgIF90aGlzNi5wcm9wcy5vblVwZGF0ZVNlcGFyYXRvcnMoW3NlbGVjdCA9PT0gJ2xlYWRpbmcnID8gcHJldkNlbGxLZXkgOiBjZWxsS2V5XSwgbmV3UHJvcHMpOwogICAgICAgIH0KICAgICAgfSwgX3RlbXAyKSwgYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4oX3RoaXM2LCBfcmV0Mik7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKENlbGxSZW5kZXJlciwgW3sKICAgICAga2V5OiAidXBkYXRlU2VwYXJhdG9yUHJvcHMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gdXBkYXRlU2VwYXJhdG9yUHJvcHMobmV3UHJvcHMpIHsKICAgICAgICB0aGlzLnNldFN0YXRlKGZ1bmN0aW9uIChzdGF0ZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgc2VwYXJhdG9yUHJvcHM6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBzdGF0ZS5zZXBhcmF0b3JQcm9wcywgbmV3UHJvcHMpCiAgICAgICAgICB9OwogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNvbXBvbmVudFdpbGxVbm1vdW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICAgIHRoaXMucHJvcHMub25Vbm1vdW50KHRoaXMucHJvcHMuY2VsbEtleSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICB2YXIgX3Byb3BzMTAgPSB0aGlzLnByb3BzLAogICAgICAgICAgICBDZWxsUmVuZGVyZXJDb21wb25lbnQgPSBfcHJvcHMxMC5DZWxsUmVuZGVyZXJDb21wb25lbnQsCiAgICAgICAgICAgIEl0ZW1TZXBhcmF0b3JDb21wb25lbnQgPSBfcHJvcHMxMC5JdGVtU2VwYXJhdG9yQ29tcG9uZW50LAogICAgICAgICAgICBmaWxsUmF0ZUhlbHBlciA9IF9wcm9wczEwLmZpbGxSYXRlSGVscGVyLAogICAgICAgICAgICBob3Jpem9udGFsID0gX3Byb3BzMTAuaG9yaXpvbnRhbCwKICAgICAgICAgICAgaXRlbSA9IF9wcm9wczEwLml0ZW0sCiAgICAgICAgICAgIGluZGV4ID0gX3Byb3BzMTAuaW5kZXgsCiAgICAgICAgICAgIGludmVyc2lvblN0eWxlID0gX3Byb3BzMTAuaW52ZXJzaW9uU3R5bGUsCiAgICAgICAgICAgIHBhcmVudFByb3BzID0gX3Byb3BzMTAucGFyZW50UHJvcHM7CiAgICAgICAgdmFyIHJlbmRlckl0ZW0gPSBwYXJlbnRQcm9wcy5yZW5kZXJJdGVtLAogICAgICAgICAgICBnZXRJdGVtTGF5b3V0ID0gcGFyZW50UHJvcHMuZ2V0SXRlbUxheW91dDsKICAgICAgICBpbnZhcmlhbnQocmVuZGVySXRlbSwgJ25vIHJlbmRlckl0ZW0hJyk7CiAgICAgICAgdmFyIGVsZW1lbnQgPSByZW5kZXJJdGVtKHsKICAgICAgICAgIGl0ZW06IGl0ZW0sCiAgICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgICBzZXBhcmF0b3JzOiB0aGlzLl9zZXBhcmF0b3JzCiAgICAgICAgfSk7CiAgICAgICAgdmFyIG9uTGF5b3V0ID0gZ2V0SXRlbUxheW91dCAmJiAhcGFyZW50UHJvcHMuZGVidWcgJiYgIWZpbGxSYXRlSGVscGVyLmVuYWJsZWQoKSA/IHVuZGVmaW5lZCA6IHRoaXMucHJvcHMub25MYXlvdXQ7CiAgICAgICAgdmFyIGl0ZW1TZXBhcmF0b3IgPSBJdGVtU2VwYXJhdG9yQ29tcG9uZW50ICYmIFJlYWN0LmNyZWF0ZUVsZW1lbnQoSXRlbVNlcGFyYXRvckNvbXBvbmVudCwgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHRoaXMuc3RhdGUuc2VwYXJhdG9yUHJvcHMsIHsKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDEzNTQKICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgICAgdmFyIGNlbGxTdHlsZSA9IGludmVyc2lvblN0eWxlID8gaG9yaXpvbnRhbCA/IFt7CiAgICAgICAgICBmbGV4RGlyZWN0aW9uOiAncm93LXJldmVyc2UnCiAgICAgICAgfSwgaW52ZXJzaW9uU3R5bGVdIDogW3sKICAgICAgICAgIGZsZXhEaXJlY3Rpb246ICdjb2x1bW4tcmV2ZXJzZScKICAgICAgICB9LCBpbnZlcnNpb25TdHlsZV0gOiBob3Jpem9udGFsID8gW3sKICAgICAgICAgIGZsZXhEaXJlY3Rpb246ICdyb3cnCiAgICAgICAgfSwgaW52ZXJzaW9uU3R5bGVdIDogaW52ZXJzaW9uU3R5bGU7CgogICAgICAgIGlmICghQ2VsbFJlbmRlcmVyQ29tcG9uZW50KSB7CiAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0eWxlOiBjZWxsU3R5bGUsCiAgICAgICAgICAgICAgb25MYXlvdXQ6IG9uTGF5b3V0LAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMTM2MwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZWxlbWVudCwKICAgICAgICAgICAgaXRlbVNlcGFyYXRvcgogICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgQ2VsbFJlbmRlcmVyQ29tcG9uZW50LAogICAgICAgICAgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHRoaXMucHJvcHMsIHsKICAgICAgICAgICAgc3R5bGU6IGNlbGxTdHlsZSwKICAgICAgICAgICAgb25MYXlvdXQ6IG9uTGF5b3V0LAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMTM3MAogICAgICAgICAgICB9CiAgICAgICAgICB9KSwKICAgICAgICAgIGVsZW1lbnQsCiAgICAgICAgICBpdGVtU2VwYXJhdG9yCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIENlbGxSZW5kZXJlcjsKICB9KFJlYWN0LkNvbXBvbmVudCk7CgogIHZhciBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7CiAgICB2ZXJ0aWNhbGx5SW52ZXJ0ZWQ6IHsKICAgICAgdHJhbnNmb3JtOiBbewogICAgICAgIHNjYWxlWTogLTEKICAgICAgfV0KICAgIH0sCiAgICBob3Jpem9udGFsbHlJbnZlcnRlZDogewogICAgICB0cmFuc2Zvcm06IFt7CiAgICAgICAgc2NhbGVYOiAtMQogICAgICB9XQogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gVmlydHVhbGl6ZWRMaXN0Owp9LDI0NyxbMjQ4LDI0OSwxMjcsMTMwLDIxLDI0NiwyMjQsMTY4LDE3MCwyNTAsMTAxLDk0LDEzLDU2LDI1MV0sIlZpcnR1YWxpemVkTGlzdCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEludGVyYWN0aW9uTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJJbnRlcmFjdGlvbk1hbmFnZXIiKTsKCiAgdmFyIEJhdGNoaW5hdG9yID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQmF0Y2hpbmF0b3IoY2FsbGJhY2ssIGRlbGF5TVMpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEJhdGNoaW5hdG9yKTsKICAgICAgdGhpcy5fZGVsYXkgPSBkZWxheU1TOwogICAgICB0aGlzLl9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhCYXRjaGluYXRvciwgW3sKICAgICAga2V5OiAiZGlzcG9zZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBkaXNwb3NlKCkgewogICAgICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB7CiAgICAgICAgICBhYm9ydDogZmFsc2UKICAgICAgICB9OwoKICAgICAgICBpZiAodGhpcy5fdGFza0hhbmRsZSkgewogICAgICAgICAgdGhpcy5fdGFza0hhbmRsZS5jYW5jZWwoKTsKCiAgICAgICAgICBpZiAoIW9wdGlvbnMuYWJvcnQpIHsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2soKTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLl90YXNrSGFuZGxlID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2NoZWR1bGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2NoZWR1bGUoKSB7CiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgaWYgKHRoaXMuX3Rhc2tIYW5kbGUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciB0aW1lb3V0SGFuZGxlID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpcy5fdGFza0hhbmRsZSA9IEludGVyYWN0aW9uTWFuYWdlci5ydW5BZnRlckludGVyYWN0aW9ucyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIF90aGlzLl90YXNrSGFuZGxlID0gbnVsbDsKCiAgICAgICAgICAgIF90aGlzLl9jYWxsYmFjaygpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwgdGhpcy5fZGVsYXkpOwogICAgICAgIHRoaXMuX3Rhc2tIYW5kbGUgPSB7CiAgICAgICAgICBjYW5jZWw6IGZ1bmN0aW9uIGNhbmNlbCgpIHsKICAgICAgICAgICAgcmV0dXJuIGNsZWFyVGltZW91dCh0aW1lb3V0SGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQmF0Y2hpbmF0b3I7CiAgfSgpOwoKICBtb2R1bGUuZXhwb3J0cyA9IEJhdGNoaW5hdG9yOwp9LDI0OCxbMjAyXSwiQmF0Y2hpbmF0b3IiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBwZXJmb3JtYW5jZU5vdyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJmYmpzL2xpYi9wZXJmb3JtYW5jZU5vdyIpOwoKICB2YXIgd2FybmluZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJmYmpzL2xpYi93YXJuaW5nIik7CgogIHZhciBJbmZvID0gZnVuY3Rpb24gSW5mbygpIHsKICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBJbmZvKTsKICAgIHRoaXMuYW55X2JsYW5rX2NvdW50ID0gMDsKICAgIHRoaXMuYW55X2JsYW5rX21zID0gMDsKICAgIHRoaXMuYW55X2JsYW5rX3NwZWVkX3N1bSA9IDA7CiAgICB0aGlzLm1vc3RseV9ibGFua19jb3VudCA9IDA7CiAgICB0aGlzLm1vc3RseV9ibGFua19tcyA9IDA7CiAgICB0aGlzLnBpeGVsc19ibGFuayA9IDA7CiAgICB0aGlzLnBpeGVsc19zYW1wbGVkID0gMDsKICAgIHRoaXMucGl4ZWxzX3Njcm9sbGVkID0gMDsKICAgIHRoaXMudG90YWxfdGltZV9zcGVudCA9IDA7CiAgICB0aGlzLnNhbXBsZV9jb3VudCA9IDA7CiAgfTsKCiAgdmFyIERFQlVHID0gZmFsc2U7CiAgdmFyIF9saXN0ZW5lcnMgPSBbXTsKICB2YXIgX21pblNhbXBsZUNvdW50ID0gMTA7CgogIHZhciBfc2FtcGxlUmF0ZSA9IERFQlVHID8gMSA6IG51bGw7CgogIHZhciBGaWxsUmF0ZUhlbHBlciA9IGZ1bmN0aW9uICgpIHsKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhGaWxsUmF0ZUhlbHBlciwgbnVsbCwgW3sKICAgICAga2V5OiAiYWRkTGlzdGVuZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gYWRkTGlzdGVuZXIoY2FsbGJhY2spIHsKICAgICAgICB3YXJuaW5nKF9zYW1wbGVSYXRlICE9PSBudWxsLCAnQ2FsbCBgRmlsbFJhdGVIZWxwZXIuc2V0U2FtcGxlUmF0ZWAgYmVmb3JlIGBhZGRMaXN0ZW5lcmAuJyk7CgogICAgICAgIF9saXN0ZW5lcnMucHVzaChjYWxsYmFjayk7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uIHJlbW92ZSgpIHsKICAgICAgICAgICAgX2xpc3RlbmVycyA9IF9saXN0ZW5lcnMuZmlsdGVyKGZ1bmN0aW9uIChsaXN0ZW5lcikgewogICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayAhPT0gbGlzdGVuZXI7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2V0U2FtcGxlUmF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRTYW1wbGVSYXRlKHNhbXBsZVJhdGUpIHsKICAgICAgICBfc2FtcGxlUmF0ZSA9IHNhbXBsZVJhdGU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2V0TWluU2FtcGxlQ291bnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0TWluU2FtcGxlQ291bnQobWluU2FtcGxlQ291bnQpIHsKICAgICAgICBfbWluU2FtcGxlQ291bnQgPSBtaW5TYW1wbGVDb3VudDsKICAgICAgfQogICAgfV0pOwoKICAgIGZ1bmN0aW9uIEZpbGxSYXRlSGVscGVyKGdldEZyYW1lTWV0cmljcykgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgRmlsbFJhdGVIZWxwZXIpOwogICAgICB0aGlzLl9hbnlCbGFua1N0YXJ0VGltZSA9IG51bGw7CiAgICAgIHRoaXMuX2VuYWJsZWQgPSBmYWxzZTsKICAgICAgdGhpcy5faW5mbyA9IG5ldyBJbmZvKCk7CiAgICAgIHRoaXMuX21vc3RseUJsYW5rU3RhcnRUaW1lID0gbnVsbDsKICAgICAgdGhpcy5fc2FtcGxlc1N0YXJ0VGltZSA9IG51bGw7CiAgICAgIHRoaXMuX2dldEZyYW1lTWV0cmljcyA9IGdldEZyYW1lTWV0cmljczsKICAgICAgdGhpcy5fZW5hYmxlZCA9IChfc2FtcGxlUmF0ZSB8fCAwKSA+IE1hdGgucmFuZG9tKCk7CgogICAgICB0aGlzLl9yZXNldERhdGEoKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoRmlsbFJhdGVIZWxwZXIsIFt7CiAgICAgIGtleTogImFjdGl2YXRlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGFjdGl2YXRlKCkgewogICAgICAgIGlmICh0aGlzLl9lbmFibGVkICYmIHRoaXMuX3NhbXBsZXNTdGFydFRpbWUgPT0gbnVsbCkgewogICAgICAgICAgREVCVUcgJiYgY29uc29sZS5kZWJ1ZygnRmlsbFJhdGVIZWxwZXI6IGFjdGl2YXRlJyk7CiAgICAgICAgICB0aGlzLl9zYW1wbGVzU3RhcnRUaW1lID0gcGVyZm9ybWFuY2VOb3coKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZGVhY3RpdmF0ZUFuZEZsdXNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGRlYWN0aXZhdGVBbmRGbHVzaCgpIHsKICAgICAgICBpZiAoIXRoaXMuX2VuYWJsZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBzdGFydCA9IHRoaXMuX3NhbXBsZXNTdGFydFRpbWU7CgogICAgICAgIGlmIChzdGFydCA9PSBudWxsKSB7CiAgICAgICAgICBERUJVRyAmJiBjb25zb2xlLmRlYnVnKCdGaWxsUmF0ZUhlbHBlcjogYmFpbCBvbiBkZWFjdGl2YXRlIHdpdGggbm8gc3RhcnQgdGltZScpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2luZm8uc2FtcGxlX2NvdW50IDwgX21pblNhbXBsZUNvdW50KSB7CiAgICAgICAgICB0aGlzLl9yZXNldERhdGEoKTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgdG90YWxfdGltZV9zcGVudCA9IHBlcmZvcm1hbmNlTm93KCkgLSBzdGFydDsKICAgICAgICB2YXIgaW5mbyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCB0aGlzLl9pbmZvLCB7CiAgICAgICAgICB0b3RhbF90aW1lX3NwZW50OiB0b3RhbF90aW1lX3NwZW50CiAgICAgICAgfSk7CgogICAgICAgIGlmIChERUJVRykgewogICAgICAgICAgdmFyIGRlcml2ZWQgPSB7CiAgICAgICAgICAgIGF2Z19ibGFua25lc3M6IHRoaXMuX2luZm8ucGl4ZWxzX2JsYW5rIC8gdGhpcy5faW5mby5waXhlbHNfc2FtcGxlZCwKICAgICAgICAgICAgYXZnX3NwZWVkOiB0aGlzLl9pbmZvLnBpeGVsc19zY3JvbGxlZCAvICh0b3RhbF90aW1lX3NwZW50IC8gMTAwMCksCiAgICAgICAgICAgIGF2Z19zcGVlZF93aGVuX2FueV9ibGFuazogdGhpcy5faW5mby5hbnlfYmxhbmtfc3BlZWRfc3VtIC8gdGhpcy5faW5mby5hbnlfYmxhbmtfY291bnQsCiAgICAgICAgICAgIGFueV9ibGFua19wZXJfbWluOiB0aGlzLl9pbmZvLmFueV9ibGFua19jb3VudCAvICh0b3RhbF90aW1lX3NwZW50IC8gMTAwMCAvIDYwKSwKICAgICAgICAgICAgYW55X2JsYW5rX3RpbWVfZnJhYzogdGhpcy5faW5mby5hbnlfYmxhbmtfbXMgLyB0b3RhbF90aW1lX3NwZW50LAogICAgICAgICAgICBtb3N0bHlfYmxhbmtfcGVyX21pbjogdGhpcy5faW5mby5tb3N0bHlfYmxhbmtfY291bnQgLyAodG90YWxfdGltZV9zcGVudCAvIDEwMDAgLyA2MCksCiAgICAgICAgICAgIG1vc3RseV9ibGFua190aW1lX2ZyYWM6IHRoaXMuX2luZm8ubW9zdGx5X2JsYW5rX21zIC8gdG90YWxfdGltZV9zcGVudAogICAgICAgICAgfTsKCiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGVyaXZlZCkgewogICAgICAgICAgICBkZXJpdmVkW2tleV0gPSBNYXRoLnJvdW5kKDEwMDAgKiBkZXJpdmVkW2tleV0pIC8gMTAwMDsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zb2xlLmRlYnVnKCdGaWxsUmF0ZUhlbHBlciBkZWFjdGl2YXRlQW5kRmx1c2g6ICcsIHsKICAgICAgICAgICAgZGVyaXZlZDogZGVyaXZlZCwKICAgICAgICAgICAgaW5mbzogaW5mbwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfbGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24gKGxpc3RlbmVyKSB7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIoaW5mbyk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuX3Jlc2V0RGF0YSgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNvbXB1dGVCbGFua25lc3MiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29tcHV0ZUJsYW5rbmVzcyhwcm9wcywgc3RhdGUsIHNjcm9sbE1ldHJpY3MpIHsKICAgICAgICBpZiAoIXRoaXMuX2VuYWJsZWQgfHwgcHJvcHMuZ2V0SXRlbUNvdW50KHByb3BzLmRhdGEpID09PSAwIHx8IHRoaXMuX3NhbXBsZXNTdGFydFRpbWUgPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICB2YXIgZE9mZnNldCA9IHNjcm9sbE1ldHJpY3MuZE9mZnNldCwKICAgICAgICAgICAgb2Zmc2V0ID0gc2Nyb2xsTWV0cmljcy5vZmZzZXQsCiAgICAgICAgICAgIHZlbG9jaXR5ID0gc2Nyb2xsTWV0cmljcy52ZWxvY2l0eSwKICAgICAgICAgICAgdmlzaWJsZUxlbmd0aCA9IHNjcm9sbE1ldHJpY3MudmlzaWJsZUxlbmd0aDsKICAgICAgICB0aGlzLl9pbmZvLnNhbXBsZV9jb3VudCsrOwogICAgICAgIHRoaXMuX2luZm8ucGl4ZWxzX3NhbXBsZWQgKz0gTWF0aC5yb3VuZCh2aXNpYmxlTGVuZ3RoKTsKICAgICAgICB0aGlzLl9pbmZvLnBpeGVsc19zY3JvbGxlZCArPSBNYXRoLnJvdW5kKE1hdGguYWJzKGRPZmZzZXQpKTsKICAgICAgICB2YXIgc2Nyb2xsU3BlZWQgPSBNYXRoLnJvdW5kKE1hdGguYWJzKHZlbG9jaXR5KSAqIDEwMDApOwogICAgICAgIHZhciBub3cgPSBwZXJmb3JtYW5jZU5vdygpOwoKICAgICAgICBpZiAodGhpcy5fYW55QmxhbmtTdGFydFRpbWUgIT0gbnVsbCkgewogICAgICAgICAgdGhpcy5faW5mby5hbnlfYmxhbmtfbXMgKz0gbm93IC0gdGhpcy5fYW55QmxhbmtTdGFydFRpbWU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9hbnlCbGFua1N0YXJ0VGltZSA9IG51bGw7CgogICAgICAgIGlmICh0aGlzLl9tb3N0bHlCbGFua1N0YXJ0VGltZSAhPSBudWxsKSB7CiAgICAgICAgICB0aGlzLl9pbmZvLm1vc3RseV9ibGFua19tcyArPSBub3cgLSB0aGlzLl9tb3N0bHlCbGFua1N0YXJ0VGltZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX21vc3RseUJsYW5rU3RhcnRUaW1lID0gbnVsbDsKICAgICAgICB2YXIgYmxhbmtUb3AgPSAwOwogICAgICAgIHZhciBmaXJzdCA9IHN0YXRlLmZpcnN0OwoKICAgICAgICB2YXIgZmlyc3RGcmFtZSA9IHRoaXMuX2dldEZyYW1lTWV0cmljcyhmaXJzdCk7CgogICAgICAgIHdoaWxlIChmaXJzdCA8PSBzdGF0ZS5sYXN0ICYmICghZmlyc3RGcmFtZSB8fCAhZmlyc3RGcmFtZS5pbkxheW91dCkpIHsKICAgICAgICAgIGZpcnN0RnJhbWUgPSB0aGlzLl9nZXRGcmFtZU1ldHJpY3MoZmlyc3QpOwogICAgICAgICAgZmlyc3QrKzsKICAgICAgICB9CgogICAgICAgIGlmIChmaXJzdEZyYW1lICYmIGZpcnN0ID4gMCkgewogICAgICAgICAgYmxhbmtUb3AgPSBNYXRoLm1pbih2aXNpYmxlTGVuZ3RoLCBNYXRoLm1heCgwLCBmaXJzdEZyYW1lLm9mZnNldCAtIG9mZnNldCkpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGJsYW5rQm90dG9tID0gMDsKICAgICAgICB2YXIgbGFzdCA9IHN0YXRlLmxhc3Q7CgogICAgICAgIHZhciBsYXN0RnJhbWUgPSB0aGlzLl9nZXRGcmFtZU1ldHJpY3MobGFzdCk7CgogICAgICAgIHdoaWxlIChsYXN0ID49IHN0YXRlLmZpcnN0ICYmICghbGFzdEZyYW1lIHx8ICFsYXN0RnJhbWUuaW5MYXlvdXQpKSB7CiAgICAgICAgICBsYXN0RnJhbWUgPSB0aGlzLl9nZXRGcmFtZU1ldHJpY3MobGFzdCk7CiAgICAgICAgICBsYXN0LS07CiAgICAgICAgfQoKICAgICAgICBpZiAobGFzdEZyYW1lICYmIGxhc3QgPCBwcm9wcy5nZXRJdGVtQ291bnQocHJvcHMuZGF0YSkgLSAxKSB7CiAgICAgICAgICB2YXIgYm90dG9tRWRnZSA9IGxhc3RGcmFtZS5vZmZzZXQgKyBsYXN0RnJhbWUubGVuZ3RoOwogICAgICAgICAgYmxhbmtCb3R0b20gPSBNYXRoLm1pbih2aXNpYmxlTGVuZ3RoLCBNYXRoLm1heCgwLCBvZmZzZXQgKyB2aXNpYmxlTGVuZ3RoIC0gYm90dG9tRWRnZSkpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHBpeGVsc19ibGFuayA9IE1hdGgucm91bmQoYmxhbmtUb3AgKyBibGFua0JvdHRvbSk7CiAgICAgICAgdmFyIGJsYW5rbmVzcyA9IHBpeGVsc19ibGFuayAvIHZpc2libGVMZW5ndGg7CgogICAgICAgIGlmIChibGFua25lc3MgPiAwKSB7CiAgICAgICAgICB0aGlzLl9hbnlCbGFua1N0YXJ0VGltZSA9IG5vdzsKICAgICAgICAgIHRoaXMuX2luZm8uYW55X2JsYW5rX3NwZWVkX3N1bSArPSBzY3JvbGxTcGVlZDsKICAgICAgICAgIHRoaXMuX2luZm8uYW55X2JsYW5rX2NvdW50Kys7CiAgICAgICAgICB0aGlzLl9pbmZvLnBpeGVsc19ibGFuayArPSBwaXhlbHNfYmxhbms7CgogICAgICAgICAgaWYgKGJsYW5rbmVzcyA+IDAuNSkgewogICAgICAgICAgICB0aGlzLl9tb3N0bHlCbGFua1N0YXJ0VGltZSA9IG5vdzsKICAgICAgICAgICAgdGhpcy5faW5mby5tb3N0bHlfYmxhbmtfY291bnQrKzsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHNjcm9sbFNwZWVkIDwgMC4wMSB8fCBNYXRoLmFicyhkT2Zmc2V0KSA8IDEpIHsKICAgICAgICAgIHRoaXMuZGVhY3RpdmF0ZUFuZEZsdXNoKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYmxhbmtuZXNzOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImVuYWJsZWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZW5hYmxlZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZW5hYmxlZDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfcmVzZXREYXRhIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9yZXNldERhdGEoKSB7CiAgICAgICAgdGhpcy5fYW55QmxhbmtTdGFydFRpbWUgPSBudWxsOwogICAgICAgIHRoaXMuX2luZm8gPSBuZXcgSW5mbygpOwogICAgICAgIHRoaXMuX21vc3RseUJsYW5rU3RhcnRUaW1lID0gbnVsbDsKICAgICAgICB0aGlzLl9zYW1wbGVzU3RhcnRUaW1lID0gbnVsbDsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEZpbGxSYXRlSGVscGVyOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBGaWxsUmF0ZUhlbHBlcjsKfSwyNDksWzUzLDU2XSwiRmlsbFJhdGVIZWxwZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBWaWV3YWJpbGl0eUhlbHBlciA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFZpZXdhYmlsaXR5SGVscGVyKCkgewogICAgICB2YXIgY29uZmlnID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB7CiAgICAgICAgdmlld0FyZWFDb3ZlcmFnZVBlcmNlbnRUaHJlc2hvbGQ6IDAKICAgICAgfTsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFZpZXdhYmlsaXR5SGVscGVyKTsKICAgICAgdGhpcy5faGFzSW50ZXJhY3RlZCA9IGZhbHNlOwogICAgICB0aGlzLl90aW1lcnMgPSBuZXcgU2V0KCk7CiAgICAgIHRoaXMuX3ZpZXdhYmxlSW5kaWNlcyA9IFtdOwogICAgICB0aGlzLl92aWV3YWJsZUl0ZW1zID0gbmV3IE1hcCgpOwogICAgICB0aGlzLl9jb25maWcgPSBjb25maWc7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFZpZXdhYmlsaXR5SGVscGVyLCBbewogICAgICBrZXk6ICJkaXNwb3NlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGRpc3Bvc2UoKSB7CiAgICAgICAgdGhpcy5fdGltZXJzLmZvckVhY2goY2xlYXJUaW1lb3V0KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjb21wdXRlVmlld2FibGVJdGVtcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wdXRlVmlld2FibGVJdGVtcyhpdGVtQ291bnQsIHNjcm9sbE9mZnNldCwgdmlld3BvcnRIZWlnaHQsIGdldEZyYW1lTWV0cmljcywgcmVuZGVyUmFuZ2UpIHsKICAgICAgICB2YXIgX2NvbmZpZyA9IHRoaXMuX2NvbmZpZywKICAgICAgICAgICAgaXRlbVZpc2libGVQZXJjZW50VGhyZXNob2xkID0gX2NvbmZpZy5pdGVtVmlzaWJsZVBlcmNlbnRUaHJlc2hvbGQsCiAgICAgICAgICAgIHZpZXdBcmVhQ292ZXJhZ2VQZXJjZW50VGhyZXNob2xkID0gX2NvbmZpZy52aWV3QXJlYUNvdmVyYWdlUGVyY2VudFRocmVzaG9sZDsKICAgICAgICB2YXIgdmlld0FyZWFNb2RlID0gdmlld0FyZWFDb3ZlcmFnZVBlcmNlbnRUaHJlc2hvbGQgIT0gbnVsbDsKICAgICAgICB2YXIgdmlld2FibGVQZXJjZW50VGhyZXNob2xkID0gdmlld0FyZWFNb2RlID8gdmlld0FyZWFDb3ZlcmFnZVBlcmNlbnRUaHJlc2hvbGQgOiBpdGVtVmlzaWJsZVBlcmNlbnRUaHJlc2hvbGQ7CiAgICAgICAgaW52YXJpYW50KHZpZXdhYmxlUGVyY2VudFRocmVzaG9sZCAhPSBudWxsICYmIGl0ZW1WaXNpYmxlUGVyY2VudFRocmVzaG9sZCAhPSBudWxsICE9PSAodmlld0FyZWFDb3ZlcmFnZVBlcmNlbnRUaHJlc2hvbGQgIT0gbnVsbCksICdNdXN0IHNldCBleGFjdGx5IG9uZSBvZiBpdGVtVmlzaWJsZVBlcmNlbnRUaHJlc2hvbGQgb3Igdmlld0FyZWFDb3ZlcmFnZVBlcmNlbnRUaHJlc2hvbGQnKTsKICAgICAgICB2YXIgdmlld2FibGVJbmRpY2VzID0gW107CgogICAgICAgIGlmIChpdGVtQ291bnQgPT09IDApIHsKICAgICAgICAgIHJldHVybiB2aWV3YWJsZUluZGljZXM7CiAgICAgICAgfQoKICAgICAgICB2YXIgZmlyc3RWaXNpYmxlID0gLTE7CgogICAgICAgIHZhciBfcmVmID0gcmVuZGVyUmFuZ2UgfHwgewogICAgICAgICAgZmlyc3Q6IDAsCiAgICAgICAgICBsYXN0OiBpdGVtQ291bnQgLSAxCiAgICAgICAgfSwKICAgICAgICAgICAgZmlyc3QgPSBfcmVmLmZpcnN0LAogICAgICAgICAgICBsYXN0ID0gX3JlZi5sYXN0OwoKICAgICAgICBpbnZhcmlhbnQobGFzdCA8IGl0ZW1Db3VudCwgJ0ludmFsaWQgcmVuZGVyIHJhbmdlICcgKyBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICByZW5kZXJSYW5nZTogcmVuZGVyUmFuZ2UsCiAgICAgICAgICBpdGVtQ291bnQ6IGl0ZW1Db3VudAogICAgICAgIH0pKTsKCiAgICAgICAgZm9yICh2YXIgaWR4ID0gZmlyc3Q7IGlkeCA8PSBsYXN0OyBpZHgrKykgewogICAgICAgICAgdmFyIG1ldHJpY3MgPSBnZXRGcmFtZU1ldHJpY3MoaWR4KTsKCiAgICAgICAgICBpZiAoIW1ldHJpY3MpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHRvcCA9IG1ldHJpY3Mub2Zmc2V0IC0gc2Nyb2xsT2Zmc2V0OwogICAgICAgICAgdmFyIGJvdHRvbSA9IHRvcCArIG1ldHJpY3MubGVuZ3RoOwoKICAgICAgICAgIGlmICh0b3AgPCB2aWV3cG9ydEhlaWdodCAmJiBib3R0b20gPiAwKSB7CiAgICAgICAgICAgIGZpcnN0VmlzaWJsZSA9IGlkeDsKCiAgICAgICAgICAgIGlmIChfaXNWaWV3YWJsZSh2aWV3QXJlYU1vZGUsIHZpZXdhYmxlUGVyY2VudFRocmVzaG9sZCwgdG9wLCBib3R0b20sIHZpZXdwb3J0SGVpZ2h0LCBtZXRyaWNzLmxlbmd0aCkpIHsKICAgICAgICAgICAgICB2aWV3YWJsZUluZGljZXMucHVzaChpZHgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGZpcnN0VmlzaWJsZSA+PSAwKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZpZXdhYmxlSW5kaWNlczsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJvblVwZGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBvblVwZGF0ZShpdGVtQ291bnQsIHNjcm9sbE9mZnNldCwgdmlld3BvcnRIZWlnaHQsIGdldEZyYW1lTWV0cmljcywgY3JlYXRlVmlld1Rva2VuLCBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkLCByZW5kZXJSYW5nZSkgewogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIGlmICh0aGlzLl9jb25maWcud2FpdEZvckludGVyYWN0aW9uICYmICF0aGlzLl9oYXNJbnRlcmFjdGVkIHx8IGl0ZW1Db3VudCA9PT0gMCB8fCAhZ2V0RnJhbWVNZXRyaWNzKDApKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgdmlld2FibGVJbmRpY2VzID0gW107CgogICAgICAgIGlmIChpdGVtQ291bnQpIHsKICAgICAgICAgIHZpZXdhYmxlSW5kaWNlcyA9IHRoaXMuY29tcHV0ZVZpZXdhYmxlSXRlbXMoaXRlbUNvdW50LCBzY3JvbGxPZmZzZXQsIHZpZXdwb3J0SGVpZ2h0LCBnZXRGcmFtZU1ldHJpY3MsIHJlbmRlclJhbmdlKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl92aWV3YWJsZUluZGljZXMubGVuZ3RoID09PSB2aWV3YWJsZUluZGljZXMubGVuZ3RoICYmIHRoaXMuX3ZpZXdhYmxlSW5kaWNlcy5ldmVyeShmdW5jdGlvbiAodiwgaWkpIHsKICAgICAgICAgIHJldHVybiB2ID09PSB2aWV3YWJsZUluZGljZXNbaWldOwogICAgICAgIH0pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLl92aWV3YWJsZUluZGljZXMgPSB2aWV3YWJsZUluZGljZXM7CgogICAgICAgIGlmICh0aGlzLl9jb25maWcubWluaW11bVZpZXdUaW1lKSB7CiAgICAgICAgICB2YXIgaGFuZGxlID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIF90aGlzLl90aW1lcnMuZGVsZXRlKGhhbmRsZSk7CgogICAgICAgICAgICBfdGhpcy5fb25VcGRhdGVTeW5jKHZpZXdhYmxlSW5kaWNlcywgb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZCwgY3JlYXRlVmlld1Rva2VuKTsKICAgICAgICAgIH0sIHRoaXMuX2NvbmZpZy5taW5pbXVtVmlld1RpbWUpOwoKICAgICAgICAgIHRoaXMuX3RpbWVycy5hZGQoaGFuZGxlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fb25VcGRhdGVTeW5jKHZpZXdhYmxlSW5kaWNlcywgb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZCwgY3JlYXRlVmlld1Rva2VuKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVzZXRWaWV3YWJsZUluZGljZXMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVzZXRWaWV3YWJsZUluZGljZXMoKSB7CiAgICAgICAgdGhpcy5fdmlld2FibGVJbmRpY2VzID0gW107CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVjb3JkSW50ZXJhY3Rpb24iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVjb3JkSW50ZXJhY3Rpb24oKSB7CiAgICAgICAgdGhpcy5faGFzSW50ZXJhY3RlZCA9IHRydWU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX29uVXBkYXRlU3luYyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfb25VcGRhdGVTeW5jKHZpZXdhYmxlSW5kaWNlc1RvQ2hlY2ssIG9uVmlld2FibGVJdGVtc0NoYW5nZWQsIGNyZWF0ZVZpZXdUb2tlbikgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICB2aWV3YWJsZUluZGljZXNUb0NoZWNrID0gdmlld2FibGVJbmRpY2VzVG9DaGVjay5maWx0ZXIoZnVuY3Rpb24gKGlpKSB7CiAgICAgICAgICByZXR1cm4gX3RoaXMyLl92aWV3YWJsZUluZGljZXMuaW5jbHVkZXMoaWkpOwogICAgICAgIH0pOwogICAgICAgIHZhciBwcmV2SXRlbXMgPSB0aGlzLl92aWV3YWJsZUl0ZW1zOwogICAgICAgIHZhciBuZXh0SXRlbXMgPSBuZXcgTWFwKHZpZXdhYmxlSW5kaWNlc1RvQ2hlY2subWFwKGZ1bmN0aW9uIChpaSkgewogICAgICAgICAgdmFyIHZpZXdhYmxlID0gY3JlYXRlVmlld1Rva2VuKGlpLCB0cnVlKTsKICAgICAgICAgIHJldHVybiBbdmlld2FibGUua2V5LCB2aWV3YWJsZV07CiAgICAgICAgfSkpOwogICAgICAgIHZhciBjaGFuZ2VkID0gW107CgogICAgICAgIGZvciAodmFyIF9pdGVyYXRvciA9IG5leHRJdGVtcywgX2lzQXJyYXkgPSBBcnJheS5pc0FycmF5KF9pdGVyYXRvciksIF9pID0gMCwgX2l0ZXJhdG9yID0gX2lzQXJyYXkgPyBfaXRlcmF0b3IgOiBfaXRlcmF0b3JbdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiA/IFN5bWJvbC5pdGVyYXRvciA6ICJAQGl0ZXJhdG9yIl0oKTs7KSB7CiAgICAgICAgICB2YXIgX3JlZjQ7CgogICAgICAgICAgaWYgKF9pc0FycmF5KSB7CiAgICAgICAgICAgIGlmIChfaSA+PSBfaXRlcmF0b3IubGVuZ3RoKSBicmVhazsKICAgICAgICAgICAgX3JlZjQgPSBfaXRlcmF0b3JbX2krK107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfaSA9IF9pdGVyYXRvci5uZXh0KCk7CiAgICAgICAgICAgIGlmIChfaS5kb25lKSBicmVhazsKICAgICAgICAgICAgX3JlZjQgPSBfaS52YWx1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgX3JlZjIgPSBfcmVmNDsKCiAgICAgICAgICB2YXIgX3JlZjMgPSBiYWJlbEhlbHBlcnMuc2xpY2VkVG9BcnJheShfcmVmMiwgMik7CgogICAgICAgICAgdmFyIF9rZXkgPSBfcmVmM1swXTsKICAgICAgICAgIHZhciB2aWV3YWJsZSA9IF9yZWYzWzFdOwoKICAgICAgICAgIGlmICghcHJldkl0ZW1zLmhhcyhfa2V5KSkgewogICAgICAgICAgICBjaGFuZ2VkLnB1c2godmlld2FibGUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgX2l0ZXJhdG9yMiA9IHByZXZJdGVtcywgX2lzQXJyYXkyID0gQXJyYXkuaXNBcnJheShfaXRlcmF0b3IyKSwgX2kyID0gMCwgX2l0ZXJhdG9yMiA9IF9pc0FycmF5MiA/IF9pdGVyYXRvcjIgOiBfaXRlcmF0b3IyW3R5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciJdKCk7OykgewogICAgICAgICAgdmFyIF9yZWY3OwoKICAgICAgICAgIGlmIChfaXNBcnJheTIpIHsKICAgICAgICAgICAgaWYgKF9pMiA+PSBfaXRlcmF0b3IyLmxlbmd0aCkgYnJlYWs7CiAgICAgICAgICAgIF9yZWY3ID0gX2l0ZXJhdG9yMltfaTIrK107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfaTIgPSBfaXRlcmF0b3IyLm5leHQoKTsKICAgICAgICAgICAgaWYgKF9pMi5kb25lKSBicmVhazsKICAgICAgICAgICAgX3JlZjcgPSBfaTIudmFsdWU7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIF9yZWY1ID0gX3JlZjc7CgogICAgICAgICAgdmFyIF9yZWY2ID0gYmFiZWxIZWxwZXJzLnNsaWNlZFRvQXJyYXkoX3JlZjUsIDIpOwoKICAgICAgICAgIHZhciBfa2V5MiA9IF9yZWY2WzBdOwogICAgICAgICAgdmFyIF92aWV3YWJsZSA9IF9yZWY2WzFdOwoKICAgICAgICAgIGlmICghbmV4dEl0ZW1zLmhhcyhfa2V5MikpIHsKICAgICAgICAgICAgY2hhbmdlZC5wdXNoKGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBfdmlld2FibGUsIHsKICAgICAgICAgICAgICBpc1ZpZXdhYmxlOiBmYWxzZQogICAgICAgICAgICB9KSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoY2hhbmdlZC5sZW5ndGggPiAwKSB7CiAgICAgICAgICB0aGlzLl92aWV3YWJsZUl0ZW1zID0gbmV4dEl0ZW1zOwogICAgICAgICAgb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgIHZpZXdhYmxlSXRlbXM6IEFycmF5LmZyb20obmV4dEl0ZW1zLnZhbHVlcygpKSwKICAgICAgICAgICAgY2hhbmdlZDogY2hhbmdlZCwKICAgICAgICAgICAgdmlld2FiaWxpdHlDb25maWc6IHRoaXMuX2NvbmZpZwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gVmlld2FiaWxpdHlIZWxwZXI7CiAgfSgpOwoKICBmdW5jdGlvbiBfaXNWaWV3YWJsZSh2aWV3QXJlYU1vZGUsIHZpZXdhYmxlUGVyY2VudFRocmVzaG9sZCwgdG9wLCBib3R0b20sIHZpZXdwb3J0SGVpZ2h0LCBpdGVtTGVuZ3RoKSB7CiAgICBpZiAoX2lzRW50aXJlbHlWaXNpYmxlKHRvcCwgYm90dG9tLCB2aWV3cG9ydEhlaWdodCkpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICB2YXIgcGl4ZWxzID0gX2dldFBpeGVsc1Zpc2libGUodG9wLCBib3R0b20sIHZpZXdwb3J0SGVpZ2h0KTsKCiAgICAgIHZhciBwZXJjZW50ID0gMTAwICogKHZpZXdBcmVhTW9kZSA/IHBpeGVscyAvIHZpZXdwb3J0SGVpZ2h0IDogcGl4ZWxzIC8gaXRlbUxlbmd0aCk7CiAgICAgIHJldHVybiBwZXJjZW50ID49IHZpZXdhYmxlUGVyY2VudFRocmVzaG9sZDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIF9nZXRQaXhlbHNWaXNpYmxlKHRvcCwgYm90dG9tLCB2aWV3cG9ydEhlaWdodCkgewogICAgdmFyIHZpc2libGVIZWlnaHQgPSBNYXRoLm1pbihib3R0b20sIHZpZXdwb3J0SGVpZ2h0KSAtIE1hdGgubWF4KHRvcCwgMCk7CiAgICByZXR1cm4gTWF0aC5tYXgoMCwgdmlzaWJsZUhlaWdodCk7CiAgfQoKICBmdW5jdGlvbiBfaXNFbnRpcmVseVZpc2libGUodG9wLCBib3R0b20sIHZpZXdwb3J0SGVpZ2h0KSB7CiAgICByZXR1cm4gdG9wID49IDAgJiYgYm90dG9tIDw9IHZpZXdwb3J0SGVpZ2h0ICYmIGJvdHRvbSA+IHRvcDsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gVmlld2FiaWxpdHlIZWxwZXI7Cn0sMjUwLFsxM10sIlZpZXdhYmlsaXR5SGVscGVyIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICBmdW5jdGlvbiBlbGVtZW50c1RoYXRPdmVybGFwT2Zmc2V0cyhvZmZzZXRzLCBpdGVtQ291bnQsIGdldEZyYW1lTWV0cmljcykgewogICAgdmFyIG91dCA9IFtdOwoKICAgIGZvciAodmFyIGlpID0gMDsgaWkgPCBpdGVtQ291bnQ7IGlpKyspIHsKICAgICAgdmFyIGZyYW1lID0gZ2V0RnJhbWVNZXRyaWNzKGlpKTsKICAgICAgdmFyIHRyYWlsaW5nT2Zmc2V0ID0gZnJhbWUub2Zmc2V0ICsgZnJhbWUubGVuZ3RoOwoKICAgICAgZm9yICh2YXIga2sgPSAwOyBrayA8IG9mZnNldHMubGVuZ3RoOyBraysrKSB7CiAgICAgICAgaWYgKG91dFtra10gPT0gbnVsbCAmJiB0cmFpbGluZ09mZnNldCA+PSBvZmZzZXRzW2trXSkgewogICAgICAgICAgb3V0W2trXSA9IGlpOwoKICAgICAgICAgIGlmIChrayA9PT0gb2Zmc2V0cy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgIGludmFyaWFudChvdXQubGVuZ3RoID09PSBvZmZzZXRzLmxlbmd0aCwgJ2JhZCBvZmZzZXRzIGlucHV0LCBzaG91bGQgYmUgaW4gaW5jcmVhc2luZyBvcmRlciAnICsgSlNPTi5zdHJpbmdpZnkob2Zmc2V0cykpOwogICAgICAgICAgICByZXR1cm4gb3V0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBvdXQ7CiAgfQoKICBmdW5jdGlvbiBuZXdSYW5nZUNvdW50KHByZXYsIG5leHQpIHsKICAgIHJldHVybiBuZXh0Lmxhc3QgLSBuZXh0LmZpcnN0ICsgMSAtIE1hdGgubWF4KDAsIDEgKyBNYXRoLm1pbihuZXh0Lmxhc3QsIHByZXYubGFzdCkgLSBNYXRoLm1heChuZXh0LmZpcnN0LCBwcmV2LmZpcnN0KSk7CiAgfQoKICBmdW5jdGlvbiBjb21wdXRlV2luZG93ZWRSZW5kZXJMaW1pdHMocHJvcHMsIHByZXYsIGdldEZyYW1lTWV0cmljc0FwcHJveCwgc2Nyb2xsTWV0cmljcykgewogICAgdmFyIGRhdGEgPSBwcm9wcy5kYXRhLAogICAgICAgIGdldEl0ZW1Db3VudCA9IHByb3BzLmdldEl0ZW1Db3VudCwKICAgICAgICBtYXhUb1JlbmRlclBlckJhdGNoID0gcHJvcHMubWF4VG9SZW5kZXJQZXJCYXRjaCwKICAgICAgICB3aW5kb3dTaXplID0gcHJvcHMud2luZG93U2l6ZTsKICAgIHZhciBpdGVtQ291bnQgPSBnZXRJdGVtQ291bnQoZGF0YSk7CgogICAgaWYgKGl0ZW1Db3VudCA9PT0gMCkgewogICAgICByZXR1cm4gcHJldjsKICAgIH0KCiAgICB2YXIgb2Zmc2V0ID0gc2Nyb2xsTWV0cmljcy5vZmZzZXQsCiAgICAgICAgdmVsb2NpdHkgPSBzY3JvbGxNZXRyaWNzLnZlbG9jaXR5LAogICAgICAgIHZpc2libGVMZW5ndGggPSBzY3JvbGxNZXRyaWNzLnZpc2libGVMZW5ndGg7CiAgICB2YXIgdmlzaWJsZUJlZ2luID0gTWF0aC5tYXgoMCwgb2Zmc2V0KTsKICAgIHZhciB2aXNpYmxlRW5kID0gdmlzaWJsZUJlZ2luICsgdmlzaWJsZUxlbmd0aDsKICAgIHZhciBvdmVyc2Nhbkxlbmd0aCA9ICh3aW5kb3dTaXplIC0gMSkgKiB2aXNpYmxlTGVuZ3RoOwogICAgdmFyIGxlYWRGYWN0b3IgPSAwLjU7CiAgICB2YXIgZmlsbFByZWZlcmVuY2UgPSB2ZWxvY2l0eSA+IDEgPyAnYWZ0ZXInIDogdmVsb2NpdHkgPCAtMSA/ICdiZWZvcmUnIDogJ25vbmUnOwogICAgdmFyIG92ZXJzY2FuQmVnaW4gPSBNYXRoLm1heCgwLCB2aXNpYmxlQmVnaW4gLSAoMSAtIGxlYWRGYWN0b3IpICogb3ZlcnNjYW5MZW5ndGgpOwogICAgdmFyIG92ZXJzY2FuRW5kID0gTWF0aC5tYXgoMCwgdmlzaWJsZUVuZCArIGxlYWRGYWN0b3IgKiBvdmVyc2Nhbkxlbmd0aCk7CgogICAgdmFyIF9lbGVtZW50c1RoYXRPdmVybGFwTyA9IGVsZW1lbnRzVGhhdE92ZXJsYXBPZmZzZXRzKFtvdmVyc2NhbkJlZ2luLCB2aXNpYmxlQmVnaW4sIHZpc2libGVFbmQsIG92ZXJzY2FuRW5kXSwgcHJvcHMuZ2V0SXRlbUNvdW50KHByb3BzLmRhdGEpLCBnZXRGcmFtZU1ldHJpY3NBcHByb3gpLAogICAgICAgIF9lbGVtZW50c1RoYXRPdmVybGFwTzIgPSBiYWJlbEhlbHBlcnMuc2xpY2VkVG9BcnJheShfZWxlbWVudHNUaGF0T3ZlcmxhcE8sIDQpLAogICAgICAgIG92ZXJzY2FuRmlyc3QgPSBfZWxlbWVudHNUaGF0T3ZlcmxhcE8yWzBdLAogICAgICAgIGZpcnN0ID0gX2VsZW1lbnRzVGhhdE92ZXJsYXBPMlsxXSwKICAgICAgICBsYXN0ID0gX2VsZW1lbnRzVGhhdE92ZXJsYXBPMlsyXSwKICAgICAgICBvdmVyc2Nhbkxhc3QgPSBfZWxlbWVudHNUaGF0T3ZlcmxhcE8yWzNdOwoKICAgIG92ZXJzY2FuRmlyc3QgPSBvdmVyc2NhbkZpcnN0ID09IG51bGwgPyAwIDogb3ZlcnNjYW5GaXJzdDsKICAgIGZpcnN0ID0gZmlyc3QgPT0gbnVsbCA/IE1hdGgubWF4KDAsIG92ZXJzY2FuRmlyc3QpIDogZmlyc3Q7CiAgICBvdmVyc2Nhbkxhc3QgPSBvdmVyc2Nhbkxhc3QgPT0gbnVsbCA/IGl0ZW1Db3VudCAtIDEgOiBvdmVyc2Nhbkxhc3Q7CiAgICBsYXN0ID0gbGFzdCA9PSBudWxsID8gTWF0aC5taW4ob3ZlcnNjYW5MYXN0LCBmaXJzdCArIG1heFRvUmVuZGVyUGVyQmF0Y2ggLSAxKSA6IGxhc3Q7CiAgICB2YXIgdmlzaWJsZSA9IHsKICAgICAgZmlyc3Q6IGZpcnN0LAogICAgICBsYXN0OiBsYXN0CiAgICB9OwogICAgdmFyIG5ld0NlbGxDb3VudCA9IG5ld1JhbmdlQ291bnQocHJldiwgdmlzaWJsZSk7CgogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKGZpcnN0IDw9IG92ZXJzY2FuRmlyc3QgJiYgbGFzdCA+PSBvdmVyc2Nhbkxhc3QpIHsKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgdmFyIG1heE5ld0NlbGxzID0gbmV3Q2VsbENvdW50ID49IG1heFRvUmVuZGVyUGVyQmF0Y2g7CiAgICAgIHZhciBmaXJzdFdpbGxBZGRNb3JlID0gZmlyc3QgPD0gcHJldi5maXJzdCB8fCBmaXJzdCA+IHByZXYubGFzdDsKICAgICAgdmFyIGZpcnN0U2hvdWxkSW5jcmVtZW50ID0gZmlyc3QgPiBvdmVyc2NhbkZpcnN0ICYmICghbWF4TmV3Q2VsbHMgfHwgIWZpcnN0V2lsbEFkZE1vcmUpOwogICAgICB2YXIgbGFzdFdpbGxBZGRNb3JlID0gbGFzdCA+PSBwcmV2Lmxhc3QgfHwgbGFzdCA8IHByZXYuZmlyc3Q7CiAgICAgIHZhciBsYXN0U2hvdWxkSW5jcmVtZW50ID0gbGFzdCA8IG92ZXJzY2FuTGFzdCAmJiAoIW1heE5ld0NlbGxzIHx8ICFsYXN0V2lsbEFkZE1vcmUpOwoKICAgICAgaWYgKG1heE5ld0NlbGxzICYmICFmaXJzdFNob3VsZEluY3JlbWVudCAmJiAhbGFzdFNob3VsZEluY3JlbWVudCkgewogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBpZiAoZmlyc3RTaG91bGRJbmNyZW1lbnQgJiYgIShmaWxsUHJlZmVyZW5jZSA9PT0gJ2FmdGVyJyAmJiBsYXN0U2hvdWxkSW5jcmVtZW50ICYmIGxhc3RXaWxsQWRkTW9yZSkpIHsKICAgICAgICBpZiAoZmlyc3RXaWxsQWRkTW9yZSkgewogICAgICAgICAgbmV3Q2VsbENvdW50Kys7CiAgICAgICAgfQoKICAgICAgICBmaXJzdC0tOwogICAgICB9CgogICAgICBpZiAobGFzdFNob3VsZEluY3JlbWVudCAmJiAhKGZpbGxQcmVmZXJlbmNlID09PSAnYmVmb3JlJyAmJiBmaXJzdFNob3VsZEluY3JlbWVudCAmJiBmaXJzdFdpbGxBZGRNb3JlKSkgewogICAgICAgIGlmIChsYXN0V2lsbEFkZE1vcmUpIHsKICAgICAgICAgIG5ld0NlbGxDb3VudCsrOwogICAgICAgIH0KCiAgICAgICAgbGFzdCsrOwogICAgICB9CiAgICB9CgogICAgaWYgKCEobGFzdCA+PSBmaXJzdCAmJiBmaXJzdCA+PSAwICYmIGxhc3QgPCBpdGVtQ291bnQgJiYgZmlyc3QgPj0gb3ZlcnNjYW5GaXJzdCAmJiBsYXN0IDw9IG92ZXJzY2FuTGFzdCAmJiBmaXJzdCA8PSB2aXNpYmxlLmZpcnN0ICYmIGxhc3QgPj0gdmlzaWJsZS5sYXN0KSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhZCB3aW5kb3cgY2FsY3VsYXRpb24gJyArIEpTT04uc3RyaW5naWZ5KHsKICAgICAgICBmaXJzdDogZmlyc3QsCiAgICAgICAgbGFzdDogbGFzdCwKICAgICAgICBpdGVtQ291bnQ6IGl0ZW1Db3VudCwKICAgICAgICBvdmVyc2NhbkZpcnN0OiBvdmVyc2NhbkZpcnN0LAogICAgICAgIG92ZXJzY2FuTGFzdDogb3ZlcnNjYW5MYXN0LAogICAgICAgIHZpc2libGU6IHZpc2libGUKICAgICAgfSkpOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGZpcnN0OiBmaXJzdCwKICAgICAgbGFzdDogbGFzdAogICAgfTsKICB9CgogIHZhciBWaXJ0dWFsaXplVXRpbHMgPSB7CiAgICBjb21wdXRlV2luZG93ZWRSZW5kZXJMaW1pdHM6IGNvbXB1dGVXaW5kb3dlZFJlbmRlckxpbWl0cywKICAgIGVsZW1lbnRzVGhhdE92ZXJsYXBPZmZzZXRzOiBlbGVtZW50c1RoYXRPdmVybGFwT2Zmc2V0cywKICAgIG5ld1JhbmdlQ291bnQ6IG5ld1JhbmdlQ291bnQKICB9OwogIG1vZHVsZS5leHBvcnRzID0gVmlydHVhbGl6ZVV0aWxzOwp9LDI1MSxbMTNdLCJWaXJ0dWFsaXplVXRpbHMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9JbWFnZS9JbWFnZUJhY2tncm91bmQuanMiOwoKICB2YXIgSW1hZ2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiSW1hZ2UiKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlJlYWN0Iik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiVmlldyIpOwoKICB2YXIgZW5zdXJlQ29tcG9uZW50SXNOYXRpdmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiZW5zdXJlQ29tcG9uZW50SXNOYXRpdmUiKTsKCiAgdmFyIEltYWdlQmFja2dyb3VuZCA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoSW1hZ2VCYWNrZ3JvdW5kLCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBJbWFnZUJhY2tncm91bmQoKSB7CiAgICAgIHZhciBfcmVmOwoKICAgICAgdmFyIF90ZW1wLCBfdGhpcywgX3JldDsKCiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBJbWFnZUJhY2tncm91bmQpOwoKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICByZXR1cm4gX3JldCA9IChfdGVtcCA9IChfdGhpcyA9IGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChfcmVmID0gSW1hZ2VCYWNrZ3JvdW5kLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoSW1hZ2VCYWNrZ3JvdW5kKSkuY2FsbC5hcHBseShfcmVmLCBbdGhpc10uY29uY2F0KGFyZ3MpKSksIF90aGlzKSwgX3RoaXMuX3ZpZXdSZWYgPSBudWxsLCBfdGhpcy5fY2FwdHVyZVJlZiA9IGZ1bmN0aW9uIChyZWYpIHsKICAgICAgICBfdGhpcy5fdmlld1JlZiA9IHJlZjsKICAgICAgfSwgX3RlbXApLCBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybihfdGhpcywgX3JldCk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEltYWdlQmFja2dyb3VuZCwgW3sKICAgICAga2V5OiAic2V0TmF0aXZlUHJvcHMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0TmF0aXZlUHJvcHMocHJvcHMpIHsKICAgICAgICB2YXIgdmlld1JlZiA9IHRoaXMuX3ZpZXdSZWY7CgogICAgICAgIGlmICh2aWV3UmVmKSB7CiAgICAgICAgICBlbnN1cmVDb21wb25lbnRJc05hdGl2ZSh2aWV3UmVmKTsKICAgICAgICAgIHZpZXdSZWYuc2V0TmF0aXZlUHJvcHMocHJvcHMpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBfcHJvcHMgPSB0aGlzLnByb3BzLAogICAgICAgICAgICBjaGlsZHJlbiA9IF9wcm9wcy5jaGlsZHJlbiwKICAgICAgICAgICAgc3R5bGUgPSBfcHJvcHMuc3R5bGUsCiAgICAgICAgICAgIGltYWdlU3R5bGUgPSBfcHJvcHMuaW1hZ2VTdHlsZSwKICAgICAgICAgICAgaW1hZ2VSZWYgPSBfcHJvcHMuaW1hZ2VSZWYsCiAgICAgICAgICAgIHByb3BzID0gYmFiZWxIZWxwZXJzLm9iamVjdFdpdGhvdXRQcm9wZXJ0aWVzKF9wcm9wcywgWyJjaGlsZHJlbiIsICJzdHlsZSIsICJpbWFnZVN0eWxlIiwgImltYWdlUmVmIl0pOwogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHN0eWxlLAogICAgICAgICAgICByZWY6IHRoaXMuX2NhcHR1cmVSZWYsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA2OAogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChJbWFnZSwgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHByb3BzLCB7CiAgICAgICAgICAgIHN0eWxlOiBbU3R5bGVTaGVldC5hYnNvbHV0ZUZpbGwsIHsKICAgICAgICAgICAgICB3aWR0aDogc3R5bGUud2lkdGgsCiAgICAgICAgICAgICAgaGVpZ2h0OiBzdHlsZS5oZWlnaHQKICAgICAgICAgICAgfSwgaW1hZ2VTdHlsZV0sCiAgICAgICAgICAgIHJlZjogaW1hZ2VSZWYsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA2OQogICAgICAgICAgICB9CiAgICAgICAgICB9KSksCiAgICAgICAgICBjaGlsZHJlbgogICAgICAgICk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBJbWFnZUJhY2tncm91bmQ7CiAgfShSZWFjdC5Db21wb25lbnQpOwoKICBtb2R1bGUuZXhwb3J0cyA9IEltYWdlQmFja2dyb3VuZDsKfSwyNTIsWzIyMiwxMzAsMTY4LDE3MCwyNTNdLCJJbWFnZUJhY2tncm91bmQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciBlbnN1cmVDb21wb25lbnRJc05hdGl2ZSA9IGZ1bmN0aW9uIGVuc3VyZUNvbXBvbmVudElzTmF0aXZlKGNvbXBvbmVudCkgewogICAgaW52YXJpYW50KGNvbXBvbmVudCAmJiB0eXBlb2YgY29tcG9uZW50LnNldE5hdGl2ZVByb3BzID09PSAnZnVuY3Rpb24nLCAnVG91Y2hhYmxlIGNoaWxkIG11c3QgZWl0aGVyIGJlIG5hdGl2ZSBvciBmb3J3YXJkIHNldE5hdGl2ZVByb3BzIHRvIGEgJyArICduYXRpdmUgY29tcG9uZW50Jyk7CiAgfTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBlbnN1cmVDb21wb25lbnRJc05hdGl2ZTsKfSwyNTMsWzEzXSwiZW5zdXJlQ29tcG9uZW50SXNOYXRpdmUiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBSQ1RJbWFnZUVkaXRpbmdNYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIk5hdGl2ZU1vZHVsZXMiKS5JbWFnZUVkaXRpbmdNYW5hZ2VyOwoKICB2YXIgSW1hZ2VFZGl0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBJbWFnZUVkaXRvcigpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEltYWdlRWRpdG9yKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoSW1hZ2VFZGl0b3IsIG51bGwsIFt7CiAgICAgIGtleTogImNyb3BJbWFnZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjcm9wSW1hZ2UodXJpLCBjcm9wRGF0YSwgc3VjY2VzcywgZmFpbHVyZSkgewogICAgICAgIFJDVEltYWdlRWRpdGluZ01hbmFnZXIuY3JvcEltYWdlKHVyaSwgY3JvcERhdGEsIHN1Y2Nlc3MsIGZhaWx1cmUpOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gSW1hZ2VFZGl0b3I7CiAgfSgpOwoKICBtb2R1bGUuZXhwb3J0cyA9IEltYWdlRWRpdG9yOwp9LDI1NCxbMTVdLCJJbWFnZUVkaXRvciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFJDVEltYWdlU3RvcmVNYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIk5hdGl2ZU1vZHVsZXMiKS5JbWFnZVN0b3JlTWFuYWdlcjsKCiAgdmFyIEltYWdlU3RvcmUgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBJbWFnZVN0b3JlKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgSW1hZ2VTdG9yZSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEltYWdlU3RvcmUsIG51bGwsIFt7CiAgICAgIGtleTogImhhc0ltYWdlRm9yVGFnIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGhhc0ltYWdlRm9yVGFnKHVyaSwgY2FsbGJhY2spIHsKICAgICAgICBpZiAoUkNUSW1hZ2VTdG9yZU1hbmFnZXIuaGFzSW1hZ2VGb3JUYWcpIHsKICAgICAgICAgIFJDVEltYWdlU3RvcmVNYW5hZ2VyLmhhc0ltYWdlRm9yVGFnKHVyaSwgY2FsbGJhY2spOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oJ2hhc0ltYWdlRm9yVGFnKCkgbm90IGltcGxlbWVudGVkJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZUltYWdlRm9yVGFnIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUltYWdlRm9yVGFnKHVyaSkgewogICAgICAgIGlmIChSQ1RJbWFnZVN0b3JlTWFuYWdlci5yZW1vdmVJbWFnZUZvclRhZykgewogICAgICAgICAgUkNUSW1hZ2VTdG9yZU1hbmFnZXIucmVtb3ZlSW1hZ2VGb3JUYWcodXJpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS53YXJuKCdyZW1vdmVJbWFnZUZvclRhZygpIG5vdCBpbXBsZW1lbnRlZCcpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJhZGRJbWFnZUZyb21CYXNlNjQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gYWRkSW1hZ2VGcm9tQmFzZTY0KGJhc2U2NEltYWdlRGF0YSwgc3VjY2VzcywgZmFpbHVyZSkgewogICAgICAgIFJDVEltYWdlU3RvcmVNYW5hZ2VyLmFkZEltYWdlRnJvbUJhc2U2NChiYXNlNjRJbWFnZURhdGEsIHN1Y2Nlc3MsIGZhaWx1cmUpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldEJhc2U2NEZvclRhZyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRCYXNlNjRGb3JUYWcodXJpLCBzdWNjZXNzLCBmYWlsdXJlKSB7CiAgICAgICAgUkNUSW1hZ2VTdG9yZU1hbmFnZXIuZ2V0QmFzZTY0Rm9yVGFnKHVyaSwgc3VjY2VzcywgZmFpbHVyZSk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBJbWFnZVN0b3JlOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBJbWFnZVN0b3JlOwp9LDI1NSxbMTVdLCJJbWFnZVN0b3JlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29tcG9uZW50cy9LZXlib2FyZC9LZXlib2FyZEF2b2lkaW5nVmlldy5qcyI7CgogIHZhciBjcmVhdGVSZWFjdENsYXNzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgImNyZWF0ZS1yZWFjdC1jbGFzcyIpOwoKICB2YXIgS2V5Ym9hcmQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiS2V5Ym9hcmQiKTsKCiAgdmFyIExheW91dEFuaW1hdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJMYXlvdXRBbmltYXRpb24iKTsKCiAgdmFyIFBsYXRmb3JtID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlBsYXRmb3JtIik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiUmVhY3QiKTsKCiAgdmFyIFRpbWVyTWl4aW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAicmVhY3QtdGltZXItbWl4aW4iKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiVmlldyIpOwoKICB2YXIgVmlld1Byb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJWaWV3UHJvcFR5cGVzIik7CgogIHZhciB2aWV3UmVmID0gJ1ZJRVcnOwogIHZhciBLZXlib2FyZEF2b2lkaW5nVmlldyA9IGNyZWF0ZVJlYWN0Q2xhc3MoewogICAgZGlzcGxheU5hbWU6ICdLZXlib2FyZEF2b2lkaW5nVmlldycsCiAgICBtaXhpbnM6IFtUaW1lck1peGluXSwKICAgIHByb3BUeXBlczogYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIFZpZXdQcm9wVHlwZXMsIHsKICAgICAgYmVoYXZpb3I6IFByb3BUeXBlcy5vbmVPZihbJ2hlaWdodCcsICdwb3NpdGlvbicsICdwYWRkaW5nJ10pLAogICAgICBjb250ZW50Q29udGFpbmVyU3R5bGU6IFZpZXdQcm9wVHlwZXMuc3R5bGUsCiAgICAgIGtleWJvYXJkVmVydGljYWxPZmZzZXQ6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZAogICAgfSksCiAgICBnZXREZWZhdWx0UHJvcHM6IGZ1bmN0aW9uIGdldERlZmF1bHRQcm9wcygpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBrZXlib2FyZFZlcnRpY2FsT2Zmc2V0OiAwCiAgICAgIH07CiAgICB9LAogICAgZ2V0SW5pdGlhbFN0YXRlOiBmdW5jdGlvbiBnZXRJbml0aWFsU3RhdGUoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgYm90dG9tOiAwCiAgICAgIH07CiAgICB9LAogICAgc3Vic2NyaXB0aW9uczogW10sCiAgICBmcmFtZTogbnVsbCwKICAgIF9yZWxhdGl2ZUtleWJvYXJkSGVpZ2h0OiBmdW5jdGlvbiBfcmVsYXRpdmVLZXlib2FyZEhlaWdodChrZXlib2FyZEZyYW1lKSB7CiAgICAgIHZhciBmcmFtZSA9IHRoaXMuZnJhbWU7CgogICAgICBpZiAoIWZyYW1lIHx8ICFrZXlib2FyZEZyYW1lKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KCiAgICAgIHZhciBrZXlib2FyZFkgPSBrZXlib2FyZEZyYW1lLnNjcmVlblkgLSB0aGlzLnByb3BzLmtleWJvYXJkVmVydGljYWxPZmZzZXQ7CiAgICAgIHJldHVybiBNYXRoLm1heChmcmFtZS55ICsgZnJhbWUuaGVpZ2h0IC0ga2V5Ym9hcmRZLCAwKTsKICAgIH0sCiAgICBfb25LZXlib2FyZENoYW5nZTogZnVuY3Rpb24gX29uS2V5Ym9hcmRDaGFuZ2UoZXZlbnQpIHsKICAgICAgaWYgKCFldmVudCkgewogICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgYm90dG9tOiAwCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgZHVyYXRpb24gPSBldmVudC5kdXJhdGlvbiwKICAgICAgICAgIGVhc2luZyA9IGV2ZW50LmVhc2luZywKICAgICAgICAgIGVuZENvb3JkaW5hdGVzID0gZXZlbnQuZW5kQ29vcmRpbmF0ZXM7CgogICAgICB2YXIgaGVpZ2h0ID0gdGhpcy5fcmVsYXRpdmVLZXlib2FyZEhlaWdodChlbmRDb29yZGluYXRlcyk7CgogICAgICBpZiAodGhpcy5zdGF0ZS5ib3R0b20gPT09IGhlaWdodCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGR1cmF0aW9uICYmIGVhc2luZykgewogICAgICAgIExheW91dEFuaW1hdGlvbi5jb25maWd1cmVOZXh0KHsKICAgICAgICAgIGR1cmF0aW9uOiBkdXJhdGlvbiwKICAgICAgICAgIHVwZGF0ZTogewogICAgICAgICAgICBkdXJhdGlvbjogZHVyYXRpb24sCiAgICAgICAgICAgIHR5cGU6IExheW91dEFuaW1hdGlvbi5UeXBlc1tlYXNpbmddIHx8ICdrZXlib2FyZCcKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgYm90dG9tOiBoZWlnaHQKICAgICAgfSk7CiAgICB9LAogICAgX29uTGF5b3V0OiBmdW5jdGlvbiBfb25MYXlvdXQoZXZlbnQpIHsKICAgICAgdGhpcy5mcmFtZSA9IGV2ZW50Lm5hdGl2ZUV2ZW50LmxheW91dDsKICAgIH0sCiAgICBjb21wb25lbnRXaWxsVXBkYXRlOiBmdW5jdGlvbiBjb21wb25lbnRXaWxsVXBkYXRlKG5leHRQcm9wcywgbmV4dFN0YXRlLCBuZXh0Q29udGV4dCkgewogICAgICBpZiAobmV4dFN0YXRlLmJvdHRvbSA9PT0gdGhpcy5zdGF0ZS5ib3R0b20gJiYgdGhpcy5wcm9wcy5iZWhhdmlvciA9PT0gJ2hlaWdodCcgJiYgbmV4dFByb3BzLmJlaGF2aW9yID09PSAnaGVpZ2h0JykgewogICAgICAgIG5leHRTdGF0ZS5ib3R0b20gPSAwOwogICAgICB9CiAgICB9LAogICAgY29tcG9uZW50V2lsbE1vdW50OiBmdW5jdGlvbiBjb21wb25lbnRXaWxsTW91bnQoKSB7CiAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMgPSBbS2V5Ym9hcmQuYWRkTGlzdGVuZXIoJ2tleWJvYXJkV2lsbENoYW5nZUZyYW1lJywgdGhpcy5fb25LZXlib2FyZENoYW5nZSldOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IFtLZXlib2FyZC5hZGRMaXN0ZW5lcigna2V5Ym9hcmREaWRIaWRlJywgdGhpcy5fb25LZXlib2FyZENoYW5nZSksIEtleWJvYXJkLmFkZExpc3RlbmVyKCdrZXlib2FyZERpZFNob3cnLCB0aGlzLl9vbktleWJvYXJkQ2hhbmdlKV07CiAgICAgIH0KICAgIH0sCiAgICBjb21wb25lbnRXaWxsVW5tb3VudDogZnVuY3Rpb24gY29tcG9uZW50V2lsbFVubW91bnQoKSB7CiAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChzdWIpIHsKICAgICAgICByZXR1cm4gc3ViLnJlbW92ZSgpOwogICAgICB9KTsKICAgIH0sCiAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgdmFyIF9wcm9wcyA9IHRoaXMucHJvcHMsCiAgICAgICAgICBiZWhhdmlvciA9IF9wcm9wcy5iZWhhdmlvciwKICAgICAgICAgIGNoaWxkcmVuID0gX3Byb3BzLmNoaWxkcmVuLAogICAgICAgICAgc3R5bGUgPSBfcHJvcHMuc3R5bGUsCiAgICAgICAgICBwcm9wcyA9IGJhYmVsSGVscGVycy5vYmplY3RXaXRob3V0UHJvcGVydGllcyhfcHJvcHMsIFsiYmVoYXZpb3IiLCAiY2hpbGRyZW4iLCAic3R5bGUiXSk7CgogICAgICBzd2l0Y2ggKGJlaGF2aW9yKSB7CiAgICAgICAgY2FzZSAnaGVpZ2h0JzoKICAgICAgICAgIHZhciBoZWlnaHRTdHlsZSA9IHZvaWQgMDsKCiAgICAgICAgICBpZiAodGhpcy5mcmFtZSkgewogICAgICAgICAgICBoZWlnaHRTdHlsZSA9IHsKICAgICAgICAgICAgICBoZWlnaHQ6IHRoaXMuZnJhbWUuaGVpZ2h0IC0gdGhpcy5zdGF0ZS5ib3R0b20sCiAgICAgICAgICAgICAgZmxleDogMAogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBWaWV3LAogICAgICAgICAgICBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7CiAgICAgICAgICAgICAgcmVmOiB2aWV3UmVmLAogICAgICAgICAgICAgIHN0eWxlOiBbc3R5bGUsIGhlaWdodFN0eWxlXSwKICAgICAgICAgICAgICBvbkxheW91dDogdGhpcy5fb25MYXlvdXQKICAgICAgICAgICAgfSwgcHJvcHMsIHsKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDE3MgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSksCiAgICAgICAgICAgIGNoaWxkcmVuCiAgICAgICAgICApOwoKICAgICAgICBjYXNlICdwb3NpdGlvbic6CiAgICAgICAgICB2YXIgcG9zaXRpb25TdHlsZSA9IHsKICAgICAgICAgICAgYm90dG9tOiB0aGlzLnN0YXRlLmJvdHRvbQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb250ZW50Q29udGFpbmVyU3R5bGUgPSB0aGlzLnByb3BzLmNvbnRlbnRDb250YWluZXJTdHlsZTsKICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBWaWV3LAogICAgICAgICAgICBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7CiAgICAgICAgICAgICAgcmVmOiB2aWV3UmVmLAogICAgICAgICAgICAgIHN0eWxlOiBzdHlsZSwKICAgICAgICAgICAgICBvbkxheW91dDogdGhpcy5fb25MYXlvdXQKICAgICAgICAgICAgfSwgcHJvcHMsIHsKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDE4MgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSksCiAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdHlsZTogW2NvbnRlbnRDb250YWluZXJTdHlsZSwgcG9zaXRpb25TdHlsZV0sCiAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAxODMKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNoaWxkcmVuCiAgICAgICAgICAgICkKICAgICAgICAgICk7CgogICAgICAgIGNhc2UgJ3BhZGRpbmcnOgogICAgICAgICAgdmFyIHBhZGRpbmdTdHlsZSA9IHsKICAgICAgICAgICAgcGFkZGluZ0JvdHRvbTogdGhpcy5zdGF0ZS5ib3R0b20KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgYmFiZWxIZWxwZXJzLmV4dGVuZHMoewogICAgICAgICAgICAgIHJlZjogdmlld1JlZiwKICAgICAgICAgICAgICBzdHlsZTogW3N0eWxlLCBwYWRkaW5nU3R5bGVdLAogICAgICAgICAgICAgIG9uTGF5b3V0OiB0aGlzLl9vbkxheW91dAogICAgICAgICAgICB9LCBwcm9wcywgewogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMTkyCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgY2hpbGRyZW4KICAgICAgICAgICk7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgYmFiZWxIZWxwZXJzLmV4dGVuZHMoewogICAgICAgICAgICAgIHJlZjogdmlld1JlZiwKICAgICAgICAgICAgICBvbkxheW91dDogdGhpcy5fb25MYXlvdXQsCiAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlCiAgICAgICAgICAgIH0sIHByb3BzLCB7CiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAxOTkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBjaGlsZHJlbgogICAgICAgICAgKTsKICAgICAgfQogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gS2V5Ym9hcmRBdm9pZGluZ1ZpZXc7Cn0sMjU2LFsxNzIsMjI4LDI1Nyw1MiwxMjcsMTMwLDE5MSwxNzAsMTMxXSwiS2V5Ym9hcmRBdm9pZGluZ1ZpZXciKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgVUlNYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlVJTWFuYWdlciIpOwoKICB2YXIga2V5TWlycm9yID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgImZianMvbGliL2tleU1pcnJvciIpOwoKICB2YXIgY2hlY2tQcm9wVHlwZXMgPSBQcm9wVHlwZXMuY2hlY2tQcm9wVHlwZXM7CiAgdmFyIFR5cGVzRW51bSA9IHsKICAgIHNwcmluZzogdHJ1ZSwKICAgIGxpbmVhcjogdHJ1ZSwKICAgIGVhc2VJbkVhc2VPdXQ6IHRydWUsCiAgICBlYXNlSW46IHRydWUsCiAgICBlYXNlT3V0OiB0cnVlLAogICAga2V5Ym9hcmQ6IHRydWUKICB9OwogIHZhciBUeXBlcyA9IGtleU1pcnJvcihUeXBlc0VudW0pOwogIHZhciBQcm9wZXJ0aWVzRW51bSA9IHsKICAgIG9wYWNpdHk6IHRydWUsCiAgICBzY2FsZVhZOiB0cnVlCiAgfTsKICB2YXIgUHJvcGVydGllcyA9IGtleU1pcnJvcihQcm9wZXJ0aWVzRW51bSk7CiAgdmFyIGFuaW1UeXBlID0gUHJvcFR5cGVzLnNoYXBlKHsKICAgIGR1cmF0aW9uOiBQcm9wVHlwZXMubnVtYmVyLAogICAgZGVsYXk6IFByb3BUeXBlcy5udW1iZXIsCiAgICBzcHJpbmdEYW1waW5nOiBQcm9wVHlwZXMubnVtYmVyLAogICAgaW5pdGlhbFZlbG9jaXR5OiBQcm9wVHlwZXMubnVtYmVyLAogICAgdHlwZTogUHJvcFR5cGVzLm9uZU9mKE9iamVjdC5rZXlzKFR5cGVzKSkuaXNSZXF1aXJlZCwKICAgIHByb3BlcnR5OiBQcm9wVHlwZXMub25lT2YoT2JqZWN0LmtleXMoUHJvcGVydGllcykpCiAgfSk7CiAgdmFyIGNvbmZpZ1R5cGUgPSBQcm9wVHlwZXMuc2hhcGUoewogICAgZHVyYXRpb246IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCwKICAgIGNyZWF0ZTogYW5pbVR5cGUsCiAgICB1cGRhdGU6IGFuaW1UeXBlLAogICAgZGVsZXRlOiBhbmltVHlwZQogIH0pOwoKICBmdW5jdGlvbiBjaGVja0NvbmZpZyhjb25maWcsIGxvY2F0aW9uLCBuYW1lKSB7CiAgICBjaGVja1Byb3BUeXBlcyh7CiAgICAgIGNvbmZpZzogY29uZmlnVHlwZQogICAgfSwgewogICAgICBjb25maWc6IGNvbmZpZwogICAgfSwgbG9jYXRpb24sIG5hbWUpOwogIH0KCiAgZnVuY3Rpb24gY29uZmlndXJlTmV4dChjb25maWcsIG9uQW5pbWF0aW9uRGlkRW5kKSB7CiAgICBpZiAoX19ERVZfXykgewogICAgICBjaGVja0NvbmZpZyhjb25maWcsICdjb25maWcnLCAnTGF5b3V0QW5pbWF0aW9uLmNvbmZpZ3VyZU5leHQnKTsKICAgIH0KCiAgICBVSU1hbmFnZXIuY29uZmlndXJlTmV4dExheW91dEFuaW1hdGlvbihjb25maWcsIG9uQW5pbWF0aW9uRGlkRW5kIHx8IGZ1bmN0aW9uICgpIHt9LCBmdW5jdGlvbiAoKSB7fSk7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGUoZHVyYXRpb24sIHR5cGUsIGNyZWF0aW9uUHJvcCkgewogICAgcmV0dXJuIHsKICAgICAgZHVyYXRpb246IGR1cmF0aW9uLAogICAgICBjcmVhdGU6IHsKICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgIHByb3BlcnR5OiBjcmVhdGlvblByb3AKICAgICAgfSwKICAgICAgdXBkYXRlOiB7CiAgICAgICAgdHlwZTogdHlwZQogICAgICB9LAogICAgICBkZWxldGU6IHsKICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgIHByb3BlcnR5OiBjcmVhdGlvblByb3AKICAgICAgfQogICAgfTsKICB9CgogIHZhciBQcmVzZXRzID0gewogICAgZWFzZUluRWFzZU91dDogY3JlYXRlKDMwMCwgVHlwZXMuZWFzZUluRWFzZU91dCwgUHJvcGVydGllcy5vcGFjaXR5KSwKICAgIGxpbmVhcjogY3JlYXRlKDUwMCwgVHlwZXMubGluZWFyLCBQcm9wZXJ0aWVzLm9wYWNpdHkpLAogICAgc3ByaW5nOiB7CiAgICAgIGR1cmF0aW9uOiA3MDAsCiAgICAgIGNyZWF0ZTogewogICAgICAgIHR5cGU6IFR5cGVzLmxpbmVhciwKICAgICAgICBwcm9wZXJ0eTogUHJvcGVydGllcy5vcGFjaXR5CiAgICAgIH0sCiAgICAgIHVwZGF0ZTogewogICAgICAgIHR5cGU6IFR5cGVzLnNwcmluZywKICAgICAgICBzcHJpbmdEYW1waW5nOiAwLjQKICAgICAgfSwKICAgICAgZGVsZXRlOiB7CiAgICAgICAgdHlwZTogVHlwZXMubGluZWFyLAogICAgICAgIHByb3BlcnR5OiBQcm9wZXJ0aWVzLm9wYWNpdHkKICAgICAgfQogICAgfQogIH07CiAgdmFyIExheW91dEFuaW1hdGlvbiA9IHsKICAgIGNvbmZpZ3VyZU5leHQ6IGNvbmZpZ3VyZU5leHQsCiAgICBjcmVhdGU6IGNyZWF0ZSwKICAgIFR5cGVzOiBUeXBlcywKICAgIFByb3BlcnRpZXM6IFByb3BlcnRpZXMsCiAgICBjaGVja0NvbmZpZzogY2hlY2tDb25maWcsCiAgICBQcmVzZXRzOiBQcmVzZXRzLAogICAgZWFzZUluRWFzZU91dDogY29uZmlndXJlTmV4dC5iaW5kKG51bGwsIFByZXNldHMuZWFzZUluRWFzZU91dCksCiAgICBsaW5lYXI6IGNvbmZpZ3VyZU5leHQuYmluZChudWxsLCBQcmVzZXRzLmxpbmVhciksCiAgICBzcHJpbmc6IGNvbmZpZ3VyZU5leHQuYmluZChudWxsLCBQcmVzZXRzLnNwcmluZykKICB9OwogIG1vZHVsZS5leHBvcnRzID0gTGF5b3V0QW5pbWF0aW9uOwp9LDI1NyxbMTI3LDEwNywxNTBdLCJMYXlvdXRBbmltYXRpb24iKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlVuaW1wbGVtZW50ZWRWaWV3Iik7Cn0sMjU4LFsyNTldLCJNYXNrZWRWaWV3SU9TIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29tcG9uZW50cy9VbmltcGxlbWVudGVkVmlld3MvVW5pbXBsZW1lbnRlZFZpZXcuanMiOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiUmVhY3QiKTsKCiAgdmFyIFN0eWxlU2hlZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiU3R5bGVTaGVldCIpOwoKICB2YXIgVW5pbXBsZW1lbnRlZFZpZXcgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKFVuaW1wbGVtZW50ZWRWaWV3LCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBVbmltcGxlbWVudGVkVmlldygpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFVuaW1wbGVtZW50ZWRWaWV3KTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChVbmltcGxlbWVudGVkVmlldy5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKFVuaW1wbGVtZW50ZWRWaWV3KSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFVuaW1wbGVtZW50ZWRWaWV3LCBbewogICAgICBrZXk6ICJzZXROYXRpdmVQcm9wcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXROYXRpdmVQcm9wcygpIHt9CiAgICB9LCB7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiVmlldyIpOwoKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgIFZpZXcsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiBbc3R5bGVzLnVuaW1wbGVtZW50ZWRWaWV3LCB0aGlzLnByb3BzLnN0eWxlXSwKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDMzCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICB0aGlzLnByb3BzLmNoaWxkcmVuCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFVuaW1wbGVtZW50ZWRWaWV3OwogIH0oUmVhY3QuQ29tcG9uZW50KTsKCiAgdmFyIHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHsKICAgIHVuaW1wbGVtZW50ZWRWaWV3OiBfX0RFVl9fID8gewogICAgICBhbGlnblNlbGY6ICdmbGV4LXN0YXJ0JywKICAgICAgYm9yZGVyQ29sb3I6ICdyZWQnLAogICAgICBib3JkZXJXaWR0aDogMQogICAgfSA6IHt9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBVbmltcGxlbWVudGVkVmlldzsKfSwyNTksWzEzMCwxNjgsMTcwXSwiVW5pbXBsZW1lbnRlZFZpZXciKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfY2xhc3MsCiAgICAgIF90ZW1wLAogICAgICBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9Nb2RhbC9Nb2RhbC5qcyIsCiAgICAgIF9jb250YWluZXI7CgogIHZhciBBcHBDb250YWluZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQXBwQ29udGFpbmVyIik7CgogIHZhciBJMThuTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJJMThuTWFuYWdlciIpOwoKICB2YXIgTmF0aXZlRXZlbnRFbWl0dGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIk5hdGl2ZUV2ZW50RW1pdHRlciIpOwoKICB2YXIgTmF0aXZlTW9kdWxlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJOYXRpdmVNb2R1bGVzIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJQbGF0Zm9ybSIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiUmVhY3QiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJwcm9wLXR5cGVzIik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAiVmlldyIpOwoKICB2YXIgZGVwcmVjYXRlZFByb3BUeXBlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs5XSwgImRlcHJlY2F0ZWRQcm9wVHlwZSIpOwoKICB2YXIgcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTBdLCAicmVxdWlyZU5hdGl2ZUNvbXBvbmVudCIpOwoKICB2YXIgUkNUTW9kYWxIb3N0VmlldyA9IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoJ1JDVE1vZGFsSG9zdFZpZXcnLCBudWxsKTsKICB2YXIgTW9kYWxFdmVudEVtaXR0ZXIgPSBQbGF0Zm9ybS5PUyA9PT0gJ2lvcycgJiYgTmF0aXZlTW9kdWxlcy5Nb2RhbE1hbmFnZXIgPyBuZXcgTmF0aXZlRXZlbnRFbWl0dGVyKE5hdGl2ZU1vZHVsZXMuTW9kYWxNYW5hZ2VyKSA6IG51bGw7CiAgdmFyIHVuaXF1ZU1vZGFsSWRlbnRpZmllciA9IDA7CiAgdmFyIE1vZGFsID0gKF90ZW1wID0gX2NsYXNzID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhNb2RhbCwgX1JlYWN0JENvbXBvbmVudCk7CgogICAgZnVuY3Rpb24gTW9kYWwocHJvcHMpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIE1vZGFsKTsKCiAgICAgIHZhciBfdGhpcyA9IGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChNb2RhbC5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKE1vZGFsKSkuY2FsbCh0aGlzLCBwcm9wcykpOwoKICAgICAgTW9kYWwuX2NvbmZpcm1Qcm9wcyhwcm9wcyk7CgogICAgICBfdGhpcy5faWRlbnRpZmllciA9IHVuaXF1ZU1vZGFsSWRlbnRpZmllcisrOwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKE1vZGFsLCBbewogICAgICBrZXk6ICJjb21wb25lbnREaWRNb3VudCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnREaWRNb3VudCgpIHsKICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgICAgaWYgKE1vZGFsRXZlbnRFbWl0dGVyKSB7CiAgICAgICAgICB0aGlzLl9ldmVudFN1YnNjcmlwdGlvbiA9IE1vZGFsRXZlbnRFbWl0dGVyLmFkZExpc3RlbmVyKCdtb2RhbERpc21pc3NlZCcsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQubW9kYWxJRCA9PT0gX3RoaXMyLl9pZGVudGlmaWVyICYmIF90aGlzMi5wcm9wcy5vbkRpc21pc3MpIHsKICAgICAgICAgICAgICBfdGhpczIucHJvcHMub25EaXNtaXNzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjb21wb25lbnRXaWxsVW5tb3VudCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnRXaWxsVW5tb3VudCgpIHsKICAgICAgICBpZiAodGhpcy5fZXZlbnRTdWJzY3JpcHRpb24pIHsKICAgICAgICAgIHRoaXMuX2V2ZW50U3Vic2NyaXB0aW9uLnJlbW92ZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzKSB7CiAgICAgICAgTW9kYWwuX2NvbmZpcm1Qcm9wcyhuZXh0UHJvcHMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgaWYgKHRoaXMucHJvcHMudmlzaWJsZSA9PT0gZmFsc2UpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNvbnRhaW5lclN0eWxlcyA9IHsKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogdGhpcy5wcm9wcy50cmFuc3BhcmVudCA/ICd0cmFuc3BhcmVudCcgOiAnd2hpdGUnCiAgICAgICAgfTsKICAgICAgICB2YXIgYW5pbWF0aW9uVHlwZSA9IHRoaXMucHJvcHMuYW5pbWF0aW9uVHlwZTsKCiAgICAgICAgaWYgKCFhbmltYXRpb25UeXBlKSB7CiAgICAgICAgICBhbmltYXRpb25UeXBlID0gJ25vbmUnOwoKICAgICAgICAgIGlmICh0aGlzLnByb3BzLmFuaW1hdGVkKSB7CiAgICAgICAgICAgIGFuaW1hdGlvblR5cGUgPSAnc2xpZGUnOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIHByZXNlbnRhdGlvblN0eWxlID0gdGhpcy5wcm9wcy5wcmVzZW50YXRpb25TdHlsZTsKCiAgICAgICAgaWYgKCFwcmVzZW50YXRpb25TdHlsZSkgewogICAgICAgICAgcHJlc2VudGF0aW9uU3R5bGUgPSAnZnVsbFNjcmVlbic7CgogICAgICAgICAgaWYgKHRoaXMucHJvcHMudHJhbnNwYXJlbnQpIHsKICAgICAgICAgICAgcHJlc2VudGF0aW9uU3R5bGUgPSAnb3ZlckZ1bGxTY3JlZW4nOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGlubmVyQ2hpbGRyZW4gPSBfX0RFVl9fID8gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgIEFwcENvbnRhaW5lciwKICAgICAgICAgIHsKICAgICAgICAgICAgcm9vdFRhZzogdGhpcy5jb250ZXh0LnJvb3RUYWcsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAyMzgKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHRoaXMucHJvcHMuY2hpbGRyZW4KICAgICAgICApIDogdGhpcy5wcm9wcy5jaGlsZHJlbjsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgIFJDVE1vZGFsSG9zdFZpZXcsCiAgICAgICAgICB7CiAgICAgICAgICAgIGFuaW1hdGlvblR5cGU6IGFuaW1hdGlvblR5cGUsCiAgICAgICAgICAgIHByZXNlbnRhdGlvblN0eWxlOiBwcmVzZW50YXRpb25TdHlsZSwKICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IHRoaXMucHJvcHMudHJhbnNwYXJlbnQsCiAgICAgICAgICAgIGhhcmR3YXJlQWNjZWxlcmF0ZWQ6IHRoaXMucHJvcHMuaGFyZHdhcmVBY2NlbGVyYXRlZCwKICAgICAgICAgICAgb25SZXF1ZXN0Q2xvc2U6IHRoaXMucHJvcHMub25SZXF1ZXN0Q2xvc2UsCiAgICAgICAgICAgIG9uU2hvdzogdGhpcy5wcm9wcy5vblNob3csCiAgICAgICAgICAgIGlkZW50aWZpZXI6IHRoaXMuX2lkZW50aWZpZXIsCiAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMubW9kYWwsCiAgICAgICAgICAgIG9uU3RhcnRTaG91bGRTZXRSZXNwb25kZXI6IHRoaXMuX3Nob3VsZFNldFJlc3BvbmRlciwKICAgICAgICAgICAgc3VwcG9ydGVkT3JpZW50YXRpb25zOiB0aGlzLnByb3BzLnN1cHBvcnRlZE9yaWVudGF0aW9ucywKICAgICAgICAgICAgb25PcmllbnRhdGlvbkNoYW5nZTogdGhpcy5wcm9wcy5vbk9yaWVudGF0aW9uQ2hhbmdlLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMjQ0CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBWaWV3LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IFtzdHlsZXMuY29udGFpbmVyLCBjb250YWluZXJTdHlsZXNdLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjU3CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBpbm5lckNoaWxkcmVuCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfc2hvdWxkU2V0UmVzcG9uZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9zaG91bGRTZXRSZXNwb25kZXIoKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH1dLCBbewogICAgICBrZXk6ICJfY29uZmlybVByb3BzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9jb25maXJtUHJvcHMocHJvcHMpIHsKICAgICAgICBpZiAocHJvcHMucHJlc2VudGF0aW9uU3R5bGUgJiYgcHJvcHMucHJlc2VudGF0aW9uU3R5bGUgIT09ICdvdmVyRnVsbFNjcmVlbicgJiYgcHJvcHMudHJhbnNwYXJlbnQpIHsKICAgICAgICAgIGNvbnNvbGUud2FybigiTW9kYWwgd2l0aCAnIiArIHByb3BzLnByZXNlbnRhdGlvblN0eWxlICsgIicgcHJlc2VudGF0aW9uIHN0eWxlIGFuZCAndHJhbnNwYXJlbnQnIHZhbHVlIGlzIG5vdCBzdXBwb3J0ZWQuIik7CiAgICAgICAgfQogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gTW9kYWw7CiAgfShSZWFjdC5Db21wb25lbnQpLCBfY2xhc3MucHJvcFR5cGVzID0gewogICAgYW5pbWF0aW9uVHlwZTogUHJvcFR5cGVzLm9uZU9mKFsnbm9uZScsICdzbGlkZScsICdmYWRlJ10pLAogICAgcHJlc2VudGF0aW9uU3R5bGU6IFByb3BUeXBlcy5vbmVPZihbJ2Z1bGxTY3JlZW4nLCAncGFnZVNoZWV0JywgJ2Zvcm1TaGVldCcsICdvdmVyRnVsbFNjcmVlbiddKSwKICAgIHRyYW5zcGFyZW50OiBQcm9wVHlwZXMuYm9vbCwKICAgIGhhcmR3YXJlQWNjZWxlcmF0ZWQ6IFByb3BUeXBlcy5ib29sLAogICAgdmlzaWJsZTogUHJvcFR5cGVzLmJvb2wsCiAgICBvblJlcXVlc3RDbG9zZTogUGxhdGZvcm0uaXNUVk9TIHx8IFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcgPyBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkIDogUHJvcFR5cGVzLmZ1bmMsCiAgICBvblNob3c6IFByb3BUeXBlcy5mdW5jLAogICAgb25EaXNtaXNzOiBQcm9wVHlwZXMuZnVuYywKICAgIGFuaW1hdGVkOiBkZXByZWNhdGVkUHJvcFR5cGUoUHJvcFR5cGVzLmJvb2wsICdVc2UgdGhlIGBhbmltYXRpb25UeXBlYCBwcm9wIGluc3RlYWQuJyksCiAgICBzdXBwb3J0ZWRPcmllbnRhdGlvbnM6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5vbmVPZihbJ3BvcnRyYWl0JywgJ3BvcnRyYWl0LXVwc2lkZS1kb3duJywgJ2xhbmRzY2FwZScsICdsYW5kc2NhcGUtbGVmdCcsICdsYW5kc2NhcGUtcmlnaHQnXSkpLAogICAgb25PcmllbnRhdGlvbkNoYW5nZTogUHJvcFR5cGVzLmZ1bmMKICB9LCBfY2xhc3MuZGVmYXVsdFByb3BzID0gewogICAgdmlzaWJsZTogdHJ1ZSwKICAgIGhhcmR3YXJlQWNjZWxlcmF0ZWQ6IGZhbHNlCiAgfSwgX2NsYXNzLmNvbnRleHRUeXBlcyA9IHsKICAgIHJvb3RUYWc6IFByb3BUeXBlcy5udW1iZXIKICB9LCBfdGVtcCk7CiAgdmFyIHNpZGUgPSBJMThuTWFuYWdlci5pc1JUTCA/ICdyaWdodCcgOiAnbGVmdCc7CiAgdmFyIHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHsKICAgIG1vZGFsOiB7CiAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnCiAgICB9LAogICAgY29udGFpbmVyOiAoX2NvbnRhaW5lciA9IHsKICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScKICAgIH0sIGJhYmVsSGVscGVycy5kZWZpbmVQcm9wZXJ0eShfY29udGFpbmVyLCBzaWRlLCAwKSwgYmFiZWxIZWxwZXJzLmRlZmluZVByb3BlcnR5KF9jb250YWluZXIsICJ0b3AiLCAwKSwgX2NvbnRhaW5lcikKICB9KTsKICBtb2R1bGUuZXhwb3J0cyA9IE1vZGFsOwp9LDI2MCxbMjYxLDI4MCw2OSwxNSw1MiwxMzAsMTI3LDE2OCwxNzAsMTQzLDE0NV0sIk1vZGFsIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2NsYXNzLAogICAgICBfdGVtcDIsCiAgICAgIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL1JlYWN0TmF0aXZlL0FwcENvbnRhaW5lci5qcyI7CgogIHZhciBFbWl0dGVyU3Vic2NyaXB0aW9uID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkVtaXR0ZXJTdWJzY3JpcHRpb24iKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJwcm9wLXR5cGVzIik7CgogIHZhciBSQ1REZXZpY2VFdmVudEVtaXR0ZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUkNURGV2aWNlRXZlbnRFbWl0dGVyIik7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJSZWFjdCIpOwoKICB2YXIgUmVhY3ROYXRpdmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiUmVhY3ROYXRpdmUiKTsKCiAgdmFyIFN0eWxlU2hlZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiU3R5bGVTaGVldCIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJWaWV3Iik7CgogIHZhciBBcHBDb250YWluZXIgPSAoX3RlbXAyID0gX2NsYXNzID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhBcHBDb250YWluZXIsIF9SZWFjdCRDb21wb25lbnQpOwoKICAgIGZ1bmN0aW9uIEFwcENvbnRhaW5lcigpIHsKICAgICAgdmFyIF9yZWY7CgogICAgICB2YXIgX3RlbXAsIF90aGlzLCBfcmV0OwoKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEFwcENvbnRhaW5lcik7CgogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiBfcmV0ID0gKF90ZW1wID0gKF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKF9yZWYgPSBBcHBDb250YWluZXIuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihBcHBDb250YWluZXIpKS5jYWxsLmFwcGx5KF9yZWYsIFt0aGlzXS5jb25jYXQoYXJncykpKSwgX3RoaXMpLCBfdGhpcy5zdGF0ZSA9IHsKICAgICAgICBpbnNwZWN0b3I6IG51bGwsCiAgICAgICAgbWFpbktleTogMQogICAgICB9LCBfdGhpcy5fc3Vic2NyaXB0aW9uID0gbnVsbCwgX3RlbXApLCBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybihfdGhpcywgX3JldCk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEFwcENvbnRhaW5lciwgW3sKICAgICAga2V5OiAiZ2V0Q2hpbGRDb250ZXh0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldENoaWxkQ29udGV4dCgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcm9vdFRhZzogdGhpcy5wcm9wcy5yb290VGFnCiAgICAgICAgfTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjb21wb25lbnREaWRNb3VudCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnREaWRNb3VudCgpIHsKICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICAgIGlmICghZ2xvYmFsLl9fUkNUUHJvZmlsZUlzUHJvZmlsaW5nKSB7CiAgICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbiA9IFJDVERldmljZUV2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcigndG9nZ2xlRWxlbWVudEluc3BlY3RvcicsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB2YXIgSW5zcGVjdG9yID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgIkluc3BlY3RvciIpOwoKICAgICAgICAgICAgICB2YXIgaW5zcGVjdG9yID0gX3RoaXMyLnN0YXRlLmluc3BlY3RvciA/IG51bGwgOiBSZWFjdC5jcmVhdGVFbGVtZW50KEluc3BlY3RvciwgewogICAgICAgICAgICAgICAgaW5zcGVjdGVkVmlld1RhZzogUmVhY3ROYXRpdmUuZmluZE5vZGVIYW5kbGUoX3RoaXMyLl9tYWluUmVmKSwKICAgICAgICAgICAgICAgIG9uUmVxdWVzdFJlcmVuZGVyQXBwOiBmdW5jdGlvbiBvblJlcXVlc3RSZXJlbmRlckFwcCh1cGRhdGVJbnNwZWN0ZWRWaWV3VGFnKSB7CiAgICAgICAgICAgICAgICAgIF90aGlzMi5zZXRTdGF0ZShmdW5jdGlvbiAocykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICBtYWluS2V5OiBzLm1haW5LZXkgKyAxCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbnNwZWN0ZWRWaWV3VGFnKFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKF90aGlzMi5fbWFpblJlZikpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA2NgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBfdGhpczIuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgaW5zcGVjdG9yOiBpbnNwZWN0b3IKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNvbXBvbmVudFdpbGxVbm1vdW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICAgIGlmICh0aGlzLl9zdWJzY3JpcHRpb24pIHsKICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbi5yZW1vdmUoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgdmFyIHllbGxvd0JveCA9IG51bGw7CgogICAgICAgIGlmIChfX0RFVl9fKSB7CiAgICAgICAgICBpZiAoIWdsb2JhbC5fX1JDVFByb2ZpbGVJc1Byb2ZpbGluZykgewogICAgICAgICAgICB2YXIgWWVsbG93Qm94ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4XSwgIlllbGxvd0JveCIpOwoKICAgICAgICAgICAgeWVsbG93Qm94ID0gUmVhY3QuY3JlYXRlRWxlbWVudChZZWxsb3dCb3gsIHsKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDk3CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBpbm5lclZpZXcgPSBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgY29sbGFwc2FibGU6ICF0aGlzLnN0YXRlLmluc3BlY3RvciwKICAgICAgICAgICAga2V5OiB0aGlzLnN0YXRlLm1haW5LZXksCiAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6ICJib3gtbm9uZSIsCiAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuYXBwQ29udGFpbmVyLAogICAgICAgICAgICByZWY6IGZ1bmN0aW9uIHJlZihfcmVmMikgewogICAgICAgICAgICAgIF90aGlzMy5fbWFpblJlZiA9IF9yZWYyOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMTAyCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICB0aGlzLnByb3BzLmNoaWxkcmVuCiAgICAgICAgKTsKICAgICAgICB2YXIgV3JhcHBlciA9IHRoaXMucHJvcHMuV3JhcHBlckNvbXBvbmVudDsKCiAgICAgICAgaWYgKFdyYXBwZXIpIHsKICAgICAgICAgIGlubmVyVmlldyA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFdyYXBwZXIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDExOQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW5uZXJWaWV3CiAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBWaWV3LAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogc3R5bGVzLmFwcENvbnRhaW5lciwKICAgICAgICAgICAgcG9pbnRlckV2ZW50czogImJveC1ub25lIiwKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDEyMgogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgaW5uZXJWaWV3LAogICAgICAgICAgeWVsbG93Qm94LAogICAgICAgICAgdGhpcy5zdGF0ZS5pbnNwZWN0b3IKICAgICAgICApOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQXBwQ29udGFpbmVyOwogIH0oUmVhY3QuQ29tcG9uZW50KSwgX2NsYXNzLmNoaWxkQ29udGV4dFR5cGVzID0gewogICAgcm9vdFRhZzogUHJvcFR5cGVzLm51bWJlcgogIH0sIF90ZW1wMik7CiAgdmFyIHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHsKICAgIGFwcENvbnRhaW5lcjogewogICAgICBmbGV4OiAxCiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBBcHBDb250YWluZXI7Cn0sMjYxLFs2NSwxMjcsNzAsMTMwLDIxLDE2OCwxNzAsMjYyLDI3OF0sIkFwcENvbnRhaW5lciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9jbGFzcywKICAgICAgX3RlbXAsCiAgICAgIF9pbml0aWFsaXNlUHJvcHMsCiAgICAgIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0luc3BlY3Rvci9JbnNwZWN0b3IuanMiOwoKICB2YXIgRGltZW5zaW9ucyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJEaW1lbnNpb25zIik7CgogIHZhciBJbnNwZWN0b3JPdmVybGF5ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkluc3BlY3Rvck92ZXJsYXkiKTsKCiAgdmFyIEluc3BlY3RvclBhbmVsID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIkluc3BlY3RvclBhbmVsIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJQbGF0Zm9ybSIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiUmVhY3QiKTsKCiAgdmFyIFJlYWN0TmF0aXZlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgIlJlYWN0TmF0aXZlIik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFRvdWNoYWJsZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJUb3VjaGFibGUiKTsKCiAgdmFyIFVJTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJVSU1hbmFnZXIiKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAiVmlldyIpOwoKICB2YXIgZW1wdHlPYmplY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEwXSwgImZianMvbGliL2VtcHR5T2JqZWN0Iik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzExXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgaG9vayA9IHdpbmRvdy5fX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX187CiAgdmFyIHJlbmRlcmVyID0gZmluZFJlbmRlcmVyKCk7CiAgaG9vay5yZXNvbHZlUk5TdHlsZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTJdLCAiZmxhdHRlblN0eWxlIik7CgogIGZ1bmN0aW9uIGZpbmRSZW5kZXJlcigpIHsKICAgIHZhciByZW5kZXJlcnMgPSBob29rLl9yZW5kZXJlcnM7CiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHJlbmRlcmVycyk7CiAgICBpbnZhcmlhbnQoa2V5cy5sZW5ndGggPT09IDEsICdFeHBlY3RlZCB0byBmaW5kIGV4YWN0bHkgb25lIFJlYWN0IE5hdGl2ZSByZW5kZXJlciBvbiBEZXZUb29scyBob29rLicpOwogICAgcmV0dXJuIHJlbmRlcmVyc1trZXlzWzBdXTsKICB9CgogIHZhciBJbnNwZWN0b3IgPSAoX3RlbXAgPSBfY2xhc3MgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKEluc3BlY3RvciwgX1JlYWN0JENvbXBvbmVudCk7CgogICAgZnVuY3Rpb24gSW5zcGVjdG9yKHByb3BzKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBJbnNwZWN0b3IpOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKEluc3BlY3Rvci5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEluc3BlY3RvcikpLmNhbGwodGhpcywgcHJvcHMpKTsKCiAgICAgIF9pbml0aWFsaXNlUHJvcHMuY2FsbChfdGhpcyk7CgogICAgICBfdGhpcy5zdGF0ZSA9IHsKICAgICAgICBkZXZ0b29sc0FnZW50OiBudWxsLAogICAgICAgIGhpZXJhcmNoeTogbnVsbCwKICAgICAgICBwYW5lbFBvczogJ2JvdHRvbScsCiAgICAgICAgaW5zcGVjdGluZzogdHJ1ZSwKICAgICAgICBwZXJmaW5nOiBmYWxzZSwKICAgICAgICBpbnNwZWN0ZWQ6IG51bGwsCiAgICAgICAgc2VsZWN0aW9uOiBudWxsLAogICAgICAgIGluc3BlY3RlZFZpZXdUYWc6IF90aGlzLnByb3BzLmluc3BlY3RlZFZpZXdUYWcsCiAgICAgICAgbmV0d29ya2luZzogZmFsc2UKICAgICAgfTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhJbnNwZWN0b3IsIFt7CiAgICAgIGtleTogImNvbXBvbmVudERpZE1vdW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudERpZE1vdW50KCkgewogICAgICAgIGhvb2sub24oJ3JlYWN0LWRldnRvb2xzJywgdGhpcy5hdHRhY2hUb0RldnRvb2xzKTsKCiAgICAgICAgaWYgKGhvb2sucmVhY3REZXZ0b29sc0FnZW50KSB7CiAgICAgICAgICB0aGlzLmF0dGFjaFRvRGV2dG9vbHMoaG9vay5yZWFjdERldnRvb2xzQWdlbnQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjb21wb25lbnRXaWxsVW5tb3VudCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnRXaWxsVW5tb3VudCgpIHsKICAgICAgICBpZiAodGhpcy5fc3VicykgewogICAgICAgICAgdGhpcy5fc3Vicy5tYXAoZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBob29rLm9mZigncmVhY3QtZGV2dG9vbHMnLCB0aGlzLmF0dGFjaFRvRGV2dG9vbHMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXdQcm9wcykgewogICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgaW5zcGVjdGVkVmlld1RhZzogbmV3UHJvcHMuaW5zcGVjdGVkVmlld1RhZwogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNldFNlbGVjdGlvbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRTZWxlY3Rpb24oaSkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICB2YXIgaGllcmFyY2h5SXRlbSA9IHRoaXMuc3RhdGUuaGllcmFyY2h5W2ldOwoKICAgICAgICB2YXIgX2hpZXJhcmNoeUl0ZW0kZ2V0SW5zID0gaGllcmFyY2h5SXRlbS5nZXRJbnNwZWN0b3JEYXRhKFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKSwKICAgICAgICAgICAgbWVhc3VyZSA9IF9oaWVyYXJjaHlJdGVtJGdldElucy5tZWFzdXJlLAogICAgICAgICAgICBwcm9wcyA9IF9oaWVyYXJjaHlJdGVtJGdldElucy5wcm9wcywKICAgICAgICAgICAgc291cmNlID0gX2hpZXJhcmNoeUl0ZW0kZ2V0SW5zLnNvdXJjZTsKCiAgICAgICAgbWVhc3VyZShmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCwgbGVmdCwgdG9wKSB7CiAgICAgICAgICBfdGhpczIuc2V0U3RhdGUoewogICAgICAgICAgICBpbnNwZWN0ZWQ6IHsKICAgICAgICAgICAgICBmcmFtZTogewogICAgICAgICAgICAgICAgbGVmdDogbGVmdCwKICAgICAgICAgICAgICAgIHRvcDogdG9wLAogICAgICAgICAgICAgICAgd2lkdGg6IHdpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHN0eWxlOiBwcm9wcy5zdHlsZSwKICAgICAgICAgICAgICBzb3VyY2U6IHNvdXJjZQogICAgICAgICAgICB9LAogICAgICAgICAgICBzZWxlY3Rpb246IGkKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIm9uVG91Y2hWaWV3VGFnIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIG9uVG91Y2hWaWV3VGFnKHRvdWNoZWRWaWV3VGFnLCBmcmFtZSwgcG9pbnRlclkpIHsKICAgICAgICB2YXIgX3JlbmRlcmVyJGdldEluc3BlY3RvID0gcmVuZGVyZXIuZ2V0SW5zcGVjdG9yRGF0YUZvclZpZXdUYWcodG91Y2hlZFZpZXdUYWcpLAogICAgICAgICAgICBoaWVyYXJjaHkgPSBfcmVuZGVyZXIkZ2V0SW5zcGVjdG8uaGllcmFyY2h5LAogICAgICAgICAgICBwcm9wcyA9IF9yZW5kZXJlciRnZXRJbnNwZWN0by5wcm9wcywKICAgICAgICAgICAgc2VsZWN0aW9uID0gX3JlbmRlcmVyJGdldEluc3BlY3RvLnNlbGVjdGlvbiwKICAgICAgICAgICAgc291cmNlID0gX3JlbmRlcmVyJGdldEluc3BlY3RvLnNvdXJjZTsKCiAgICAgICAgaWYgKHRoaXMuc3RhdGUuZGV2dG9vbHNBZ2VudCkgewogICAgICAgICAgdmFyIG9mZnNldEZyb21MZWFmID0gaGllcmFyY2h5Lmxlbmd0aCAtIDEgLSBzZWxlY3Rpb247CiAgICAgICAgICB0aGlzLnN0YXRlLmRldnRvb2xzQWdlbnQuc2VsZWN0RnJvbURPTU5vZGUodG91Y2hlZFZpZXdUYWcsIHRydWUsIG9mZnNldEZyb21MZWFmKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgcGFuZWxQb3M6IHBvaW50ZXJZID4gRGltZW5zaW9ucy5nZXQoJ3dpbmRvdycpLmhlaWdodCAvIDIgPyAndG9wJyA6ICdib3R0b20nLAogICAgICAgICAgc2VsZWN0aW9uOiBzZWxlY3Rpb24sCiAgICAgICAgICBoaWVyYXJjaHk6IGhpZXJhcmNoeSwKICAgICAgICAgIGluc3BlY3RlZDogewogICAgICAgICAgICBzdHlsZTogcHJvcHMuc3R5bGUsCiAgICAgICAgICAgIGZyYW1lOiBmcmFtZSwKICAgICAgICAgICAgc291cmNlOiBzb3VyY2UKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzZXRQZXJmaW5nIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldFBlcmZpbmcodmFsKSB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICBwZXJmaW5nOiB2YWwsCiAgICAgICAgICBpbnNwZWN0aW5nOiBmYWxzZSwKICAgICAgICAgIGluc3BlY3RlZDogbnVsbCwKICAgICAgICAgIG5ldHdvcmtpbmc6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2V0SW5zcGVjdGluZyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRJbnNwZWN0aW5nKHZhbCkgewogICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgaW5zcGVjdGluZzogdmFsLAogICAgICAgICAgaW5zcGVjdGVkOiBudWxsCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2V0VG91Y2hUYXJnZXR0aW5nIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldFRvdWNoVGFyZ2V0dGluZyh2YWwpIHsKICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgVG91Y2hhYmxlLlRPVUNIX1RBUkdFVF9ERUJVRyA9IHZhbDsKICAgICAgICB0aGlzLnByb3BzLm9uUmVxdWVzdFJlcmVuZGVyQXBwKGZ1bmN0aW9uIChpbnNwZWN0ZWRWaWV3VGFnKSB7CiAgICAgICAgICBfdGhpczMuc2V0U3RhdGUoewogICAgICAgICAgICBpbnNwZWN0ZWRWaWV3VGFnOiBpbnNwZWN0ZWRWaWV3VGFnCiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzZXROZXR3b3JraW5nIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldE5ldHdvcmtpbmcodmFsKSB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICBuZXR3b3JraW5nOiB2YWwsCiAgICAgICAgICBwZXJmaW5nOiBmYWxzZSwKICAgICAgICAgIGluc3BlY3Rpbmc6IGZhbHNlLAogICAgICAgICAgaW5zcGVjdGVkOiBudWxsCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICB2YXIgcGFuZWxDb250YWluZXJTdHlsZSA9IHRoaXMuc3RhdGUucGFuZWxQb3MgPT09ICdib3R0b20nID8gewogICAgICAgICAgYm90dG9tOiAwCiAgICAgICAgfSA6IHsKICAgICAgICAgIHRvcDogUGxhdGZvcm0uT1MgPT09ICdpb3MnID8gMjAgOiAwCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgIFZpZXcsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuY29udGFpbmVyLAogICAgICAgICAgICBwb2ludGVyRXZlbnRzOiAiYm94LW5vbmUiLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMjMxCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICB0aGlzLnN0YXRlLmluc3BlY3RpbmcgJiYgUmVhY3QuY3JlYXRlRWxlbWVudChJbnNwZWN0b3JPdmVybGF5LCB7CiAgICAgICAgICAgIGluc3BlY3RlZDogdGhpcy5zdGF0ZS5pbnNwZWN0ZWQsCiAgICAgICAgICAgIGluc3BlY3RlZFZpZXdUYWc6IHRoaXMuc3RhdGUuaW5zcGVjdGVkVmlld1RhZywKICAgICAgICAgICAgb25Ub3VjaFZpZXdUYWc6IHRoaXMub25Ub3VjaFZpZXdUYWcuYmluZCh0aGlzKSwKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDIzMwogICAgICAgICAgICB9CiAgICAgICAgICB9KSwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFZpZXcsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogW3N0eWxlcy5wYW5lbENvbnRhaW5lciwgcGFuZWxDb250YWluZXJTdHlsZV0sCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAyMzgKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoSW5zcGVjdG9yUGFuZWwsIHsKICAgICAgICAgICAgICBkZXZ0b29sc0lzT3BlbjogISF0aGlzLnN0YXRlLmRldnRvb2xzQWdlbnQsCiAgICAgICAgICAgICAgaW5zcGVjdGluZzogdGhpcy5zdGF0ZS5pbnNwZWN0aW5nLAogICAgICAgICAgICAgIHBlcmZpbmc6IHRoaXMuc3RhdGUucGVyZmluZywKICAgICAgICAgICAgICBzZXRQZXJmaW5nOiB0aGlzLnNldFBlcmZpbmcuYmluZCh0aGlzKSwKICAgICAgICAgICAgICBzZXRJbnNwZWN0aW5nOiB0aGlzLnNldEluc3BlY3RpbmcuYmluZCh0aGlzKSwKICAgICAgICAgICAgICBpbnNwZWN0ZWQ6IHRoaXMuc3RhdGUuaW5zcGVjdGVkLAogICAgICAgICAgICAgIGhpZXJhcmNoeTogdGhpcy5zdGF0ZS5oaWVyYXJjaHksCiAgICAgICAgICAgICAgc2VsZWN0aW9uOiB0aGlzLnN0YXRlLnNlbGVjdGlvbiwKICAgICAgICAgICAgICBzZXRTZWxlY3Rpb246IHRoaXMuc2V0U2VsZWN0aW9uLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgdG91Y2hUYXJnZXR0aW5nOiBUb3VjaGFibGUuVE9VQ0hfVEFSR0VUX0RFQlVHLAogICAgICAgICAgICAgIHNldFRvdWNoVGFyZ2V0dGluZzogdGhpcy5zZXRUb3VjaFRhcmdldHRpbmcuYmluZCh0aGlzKSwKICAgICAgICAgICAgICBuZXR3b3JraW5nOiB0aGlzLnN0YXRlLm5ldHdvcmtpbmcsCiAgICAgICAgICAgICAgc2V0TmV0d29ya2luZzogdGhpcy5zZXROZXR3b3JraW5nLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAyMzkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEluc3BlY3RvcjsKICB9KFJlYWN0LkNvbXBvbmVudCksIF9pbml0aWFsaXNlUHJvcHMgPSBmdW5jdGlvbiBfaW5pdGlhbGlzZVByb3BzKCkgewogICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgdGhpcy5hdHRhY2hUb0RldnRvb2xzID0gZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgIHZhciBfaGlkZVdhaXQgPSBudWxsOwogICAgICB2YXIgaGxTdWIgPSBhZ2VudC5zdWIoJ2hpZ2hsaWdodCcsIGZ1bmN0aW9uIChfcmVmKSB7CiAgICAgICAgdmFyIG5vZGUgPSBfcmVmLm5vZGUsCiAgICAgICAgICAgIG5hbWUgPSBfcmVmLm5hbWUsCiAgICAgICAgICAgIHByb3BzID0gX3JlZi5wcm9wczsKICAgICAgICBjbGVhclRpbWVvdXQoX2hpZGVXYWl0KTsKCiAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAnbnVtYmVyJykgewogICAgICAgICAgbm9kZSA9IFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKG5vZGUpOwogICAgICAgIH0KCiAgICAgICAgVUlNYW5hZ2VyLm1lYXN1cmUobm9kZSwgZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIGxlZnQsIHRvcCkgewogICAgICAgICAgX3RoaXM0LnNldFN0YXRlKHsKICAgICAgICAgICAgaGllcmFyY2h5OiBbXSwKICAgICAgICAgICAgaW5zcGVjdGVkOiB7CiAgICAgICAgICAgICAgZnJhbWU6IHsKICAgICAgICAgICAgICAgIGxlZnQ6IGxlZnQsCiAgICAgICAgICAgICAgICB0b3A6IHRvcCwKICAgICAgICAgICAgICAgIHdpZHRoOiB3aWR0aCwKICAgICAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzdHlsZTogcHJvcHMgPyBwcm9wcy5zdHlsZSA6IGVtcHR5T2JqZWN0CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgdmFyIGhpZGVTdWIgPSBhZ2VudC5zdWIoJ2hpZGVIaWdobGlnaHQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKF90aGlzNC5zdGF0ZS5pbnNwZWN0ZWQgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIF9oaWRlV2FpdCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgX3RoaXM0LnNldFN0YXRlKHsKICAgICAgICAgICAgaW5zcGVjdGVkOiBudWxsCiAgICAgICAgICB9KTsKICAgICAgICB9LCAxMDApOwogICAgICB9KTsKICAgICAgX3RoaXM0Ll9zdWJzID0gW2hsU3ViLCBoaWRlU3ViXTsKICAgICAgYWdlbnQub24oJ3NodXRkb3duJywgZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzNC5zZXRTdGF0ZSh7CiAgICAgICAgICBkZXZ0b29sc0FnZW50OiBudWxsCiAgICAgICAgfSk7CgogICAgICAgIF90aGlzNC5fc3VicyA9IG51bGw7CiAgICAgIH0pOwoKICAgICAgX3RoaXM0LnNldFN0YXRlKHsKICAgICAgICBkZXZ0b29sc0FnZW50OiBhZ2VudAogICAgICB9KTsKICAgIH07CiAgfSwgX3RlbXApOwogIHZhciBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7CiAgICBjb250YWluZXI6IHsKICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAgICAgIGJhY2tncm91bmRDb2xvcjogJ3RyYW5zcGFyZW50JywKICAgICAgdG9wOiAwLAogICAgICBsZWZ0OiAwLAogICAgICByaWdodDogMCwKICAgICAgYm90dG9tOiAwCiAgICB9LAogICAgcGFuZWxDb250YWluZXI6IHsKICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAgICAgIGxlZnQ6IDAsCiAgICAgIHJpZ2h0OiAwCiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBJbnNwZWN0b3I7Cn0sMjYyLFsxNjQsMjYzLDI2Nyw1MiwxMzAsMjEsMTY4LDE4MiwxMDcsMTcwLDExMSwxMywxMDFdLCJJbnNwZWN0b3IiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfY2xhc3MsCiAgICAgIF90ZW1wMiwKICAgICAgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvSW5zcGVjdG9yL0luc3BlY3Rvck92ZXJsYXkuanMiOwoKICB2YXIgRGltZW5zaW9ucyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJEaW1lbnNpb25zIik7CgogIHZhciBFbGVtZW50Qm94ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkVsZW1lbnRCb3giKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJwcm9wLXR5cGVzIik7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJSZWFjdCIpOwoKICB2YXIgU3R5bGVTaGVldCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJTdHlsZVNoZWV0Iik7CgogIHZhciBVSU1hbmFnZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiVUlNYW5hZ2VyIik7CgogIHZhciBWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgIlZpZXciKTsKCiAgdmFyIEluc3BlY3Rvck92ZXJsYXkgPSAoX3RlbXAyID0gX2NsYXNzID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhJbnNwZWN0b3JPdmVybGF5LCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBJbnNwZWN0b3JPdmVybGF5KCkgewogICAgICB2YXIgX3JlZjsKCiAgICAgIHZhciBfdGVtcCwgX3RoaXMsIF9yZXQ7CgogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgSW5zcGVjdG9yT3ZlcmxheSk7CgogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiBfcmV0ID0gKF90ZW1wID0gKF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKF9yZWYgPSBJbnNwZWN0b3JPdmVybGF5Ll9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoSW5zcGVjdG9yT3ZlcmxheSkpLmNhbGwuYXBwbHkoX3JlZiwgW3RoaXNdLmNvbmNhdChhcmdzKSkpLCBfdGhpcyksIF90aGlzLmZpbmRWaWV3Rm9yVG91Y2hFdmVudCA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIF9lJG5hdGl2ZUV2ZW50JHRvdWNoZSA9IGUubmF0aXZlRXZlbnQudG91Y2hlc1swXSwKICAgICAgICAgICAgbG9jYXRpb25YID0gX2UkbmF0aXZlRXZlbnQkdG91Y2hlLmxvY2F0aW9uWCwKICAgICAgICAgICAgbG9jYXRpb25ZID0gX2UkbmF0aXZlRXZlbnQkdG91Y2hlLmxvY2F0aW9uWTsKICAgICAgICBVSU1hbmFnZXIuZmluZFN1YnZpZXdJbihfdGhpcy5wcm9wcy5pbnNwZWN0ZWRWaWV3VGFnLCBbbG9jYXRpb25YLCBsb2NhdGlvblldLCBmdW5jdGlvbiAobmF0aXZlVmlld1RhZywgbGVmdCwgdG9wLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICBfdGhpcy5wcm9wcy5vblRvdWNoVmlld1RhZyhuYXRpdmVWaWV3VGFnLCB7CiAgICAgICAgICAgIGxlZnQ6IGxlZnQsCiAgICAgICAgICAgIHRvcDogdG9wLAogICAgICAgICAgICB3aWR0aDogd2lkdGgsCiAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0CiAgICAgICAgICB9LCBsb2NhdGlvblkpOwogICAgICAgIH0pOwogICAgICB9LCBfdGhpcy5zaG91bGRTZXRSZXNwb25zZXIgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIF90aGlzLmZpbmRWaWV3Rm9yVG91Y2hFdmVudChlKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0sIF90ZW1wKSwgYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4oX3RoaXMsIF9yZXQpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhJbnNwZWN0b3JPdmVybGF5LCBbewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBjb250ZW50ID0gbnVsbDsKCiAgICAgICAgaWYgKHRoaXMucHJvcHMuaW5zcGVjdGVkKSB7CiAgICAgICAgICBjb250ZW50ID0gUmVhY3QuY3JlYXRlRWxlbWVudChFbGVtZW50Qm94LCB7CiAgICAgICAgICAgIGZyYW1lOiB0aGlzLnByb3BzLmluc3BlY3RlZC5mcmFtZSwKICAgICAgICAgICAgc3R5bGU6IHRoaXMucHJvcHMuaW5zcGVjdGVkLnN0eWxlLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNjIKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgIFZpZXcsCiAgICAgICAgICB7CiAgICAgICAgICAgIG9uU3RhcnRTaG91bGRTZXRSZXNwb25kZXI6IHRoaXMuc2hvdWxkU2V0UmVzcG9uc2VyLAogICAgICAgICAgICBvblJlc3BvbmRlck1vdmU6IHRoaXMuZmluZFZpZXdGb3JUb3VjaEV2ZW50LAogICAgICAgICAgICBzdHlsZTogW3N0eWxlcy5pbnNwZWN0b3IsIHsKICAgICAgICAgICAgICBoZWlnaHQ6IERpbWVuc2lvbnMuZ2V0KCd3aW5kb3cnKS5oZWlnaHQKICAgICAgICAgICAgfV0sCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA2NgogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgY29udGVudAogICAgICAgICk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBJbnNwZWN0b3JPdmVybGF5OwogIH0oUmVhY3QuQ29tcG9uZW50KSwgX2NsYXNzLnByb3BUeXBlcyA9IHsKICAgIGluc3BlY3RlZDogUHJvcFR5cGVzLnNoYXBlKHsKICAgICAgZnJhbWU6IFByb3BUeXBlcy5vYmplY3QsCiAgICAgIHN0eWxlOiBQcm9wVHlwZXMuYW55CiAgICB9KSwKICAgIGluc3BlY3RlZFZpZXdUYWc6IFByb3BUeXBlcy5udW1iZXIsCiAgICBvblRvdWNoVmlld1RhZzogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZAogIH0sIF90ZW1wMik7CiAgdmFyIHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHsKICAgIGluc3BlY3RvcjogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6ICd0cmFuc3BhcmVudCcsCiAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICBsZWZ0OiAwLAogICAgICB0b3A6IDAsCiAgICAgIHJpZ2h0OiAwCiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBJbnNwZWN0b3JPdmVybGF5Owp9LDI2MyxbMTY0LDI2NCwxMjcsMTMwLDE2OCwxMDcsMTcwXSwiSW5zcGVjdG9yT3ZlcmxheSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0luc3BlY3Rvci9FbGVtZW50Qm94LmpzIjsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0Iik7CgogIHZhciBWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlZpZXciKTsKCiAgdmFyIFN0eWxlU2hlZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiU3R5bGVTaGVldCIpOwoKICB2YXIgQm9yZGVyQm94ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIkJvcmRlckJveCIpOwoKICB2YXIgcmVzb2x2ZUJveFN0eWxlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgInJlc29sdmVCb3hTdHlsZSIpOwoKICB2YXIgZmxhdHRlblN0eWxlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgImZsYXR0ZW5TdHlsZSIpOwoKICB2YXIgRWxlbWVudEJveCA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoRWxlbWVudEJveCwgX1JlYWN0JENvbXBvbmVudCk7CgogICAgZnVuY3Rpb24gRWxlbWVudEJveCgpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEVsZW1lbnRCb3gpOwogICAgICByZXR1cm4gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKEVsZW1lbnRCb3guX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihFbGVtZW50Qm94KSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEVsZW1lbnRCb3gsIFt7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgdmFyIHN0eWxlID0gZmxhdHRlblN0eWxlKHRoaXMucHJvcHMuc3R5bGUpIHx8IHt9OwogICAgICAgIHZhciBtYXJnaW4gPSByZXNvbHZlQm94U3R5bGUoJ21hcmdpbicsIHN0eWxlKTsKICAgICAgICB2YXIgcGFkZGluZyA9IHJlc29sdmVCb3hTdHlsZSgncGFkZGluZycsIHN0eWxlKTsKICAgICAgICB2YXIgZnJhbWVTdHlsZSA9IHRoaXMucHJvcHMuZnJhbWU7CgogICAgICAgIGlmIChtYXJnaW4pIHsKICAgICAgICAgIGZyYW1lU3R5bGUgPSB7CiAgICAgICAgICAgIHRvcDogZnJhbWVTdHlsZS50b3AgLSBtYXJnaW4udG9wLAogICAgICAgICAgICBsZWZ0OiBmcmFtZVN0eWxlLmxlZnQgLSBtYXJnaW4ubGVmdCwKICAgICAgICAgICAgaGVpZ2h0OiBmcmFtZVN0eWxlLmhlaWdodCArIG1hcmdpbi50b3AgKyBtYXJnaW4uYm90dG9tLAogICAgICAgICAgICB3aWR0aDogZnJhbWVTdHlsZS53aWR0aCArIG1hcmdpbi5sZWZ0ICsgbWFyZ2luLnJpZ2h0CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgdmFyIGNvbnRlbnRTdHlsZSA9IHsKICAgICAgICAgIHdpZHRoOiB0aGlzLnByb3BzLmZyYW1lLndpZHRoLAogICAgICAgICAgaGVpZ2h0OiB0aGlzLnByb3BzLmZyYW1lLmhlaWdodAogICAgICAgIH07CgogICAgICAgIGlmIChwYWRkaW5nKSB7CiAgICAgICAgICBjb250ZW50U3R5bGUgPSB7CiAgICAgICAgICAgIHdpZHRoOiBjb250ZW50U3R5bGUud2lkdGggLSBwYWRkaW5nLmxlZnQgLSBwYWRkaW5nLnJpZ2h0LAogICAgICAgICAgICBoZWlnaHQ6IGNvbnRlbnRTdHlsZS5oZWlnaHQgLSBwYWRkaW5nLnRvcCAtIHBhZGRpbmcuYm90dG9tCiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBWaWV3LAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogW3N0eWxlcy5mcmFtZSwgZnJhbWVTdHlsZV0sCiAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6ICJub25lIiwKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQ3CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBCb3JkZXJCb3gsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBib3g6IG1hcmdpbiwKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLm1hcmdpbiwKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQ4CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgIEJvcmRlckJveCwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib3g6IHBhZGRpbmcsCiAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLnBhZGRpbmcsCiAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA0OQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChWaWV3LCB7CiAgICAgICAgICAgICAgICBzdHlsZTogW3N0eWxlcy5jb250ZW50LCBjb250ZW50U3R5bGVdLAogICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogNTAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KQogICAgICAgICAgICApCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEVsZW1lbnRCb3g7CiAgfShSZWFjdC5Db21wb25lbnQpOwoKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgZnJhbWU6IHsKICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScKICAgIH0sCiAgICBjb250ZW50OiB7CiAgICAgIGJhY2tncm91bmRDb2xvcjogJ3JnYmEoMjAwLCAyMzAsIDI1NSwgMC44KScKICAgIH0sCiAgICBwYWRkaW5nOiB7CiAgICAgIGJvcmRlckNvbG9yOiAncmdiYSg3NywgMjU1LCAwLCAwLjMpJwogICAgfSwKICAgIG1hcmdpbjogewogICAgICBib3JkZXJDb2xvcjogJ3JnYmEoMjU1LCAxMzIsIDAsIDAuMyknCiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBFbGVtZW50Qm94Owp9LDI2NCxbMTMwLDE3MCwxNjgsMjY1LDI2NiwxMDFdLCJFbGVtZW50Qm94Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvSW5zcGVjdG9yL0JvcmRlckJveC5qcyI7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJSZWFjdCIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJWaWV3Iik7CgogIHZhciBCb3JkZXJCb3ggPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKEJvcmRlckJveCwgX1JlYWN0JENvbXBvbmVudCk7CgogICAgZnVuY3Rpb24gQm9yZGVyQm94KCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQm9yZGVyQm94KTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChCb3JkZXJCb3guX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihCb3JkZXJCb3gpKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQm9yZGVyQm94LCBbewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBib3ggPSB0aGlzLnByb3BzLmJveDsKCiAgICAgICAgaWYgKCFib3gpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLmNoaWxkcmVuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHN0eWxlID0gewogICAgICAgICAgYm9yZGVyVG9wV2lkdGg6IGJveC50b3AsCiAgICAgICAgICBib3JkZXJCb3R0b21XaWR0aDogYm94LmJvdHRvbSwKICAgICAgICAgIGJvcmRlckxlZnRXaWR0aDogYm94LmxlZnQsCiAgICAgICAgICBib3JkZXJSaWdodFdpZHRoOiBib3gucmlnaHQKICAgICAgICB9OwogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IFtzdHlsZSwgdGhpcy5wcm9wcy5zdHlsZV0sCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAzMAogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgdGhpcy5wcm9wcy5jaGlsZHJlbgogICAgICAgICk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBCb3JkZXJCb3g7CiAgfShSZWFjdC5Db21wb25lbnQpOwoKICBtb2R1bGUuZXhwb3J0cyA9IEJvcmRlckJveDsKfSwyNjUsWzEzMCwxNzBdLCJCb3JkZXJCb3giKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIGZ1bmN0aW9uIHJlc29sdmVCb3hTdHlsZShwcmVmaXgsIHN0eWxlKSB7CiAgICB2YXIgcmVzID0ge307CiAgICB2YXIgc3VicyA9IFsndG9wJywgJ2xlZnQnLCAnYm90dG9tJywgJ3JpZ2h0J107CiAgICB2YXIgc2V0ID0gZmFsc2U7CiAgICBzdWJzLmZvckVhY2goZnVuY3Rpb24gKHN1YikgewogICAgICByZXNbc3ViXSA9IHN0eWxlW3ByZWZpeF0gfHwgMDsKICAgIH0pOwoKICAgIGlmIChzdHlsZVtwcmVmaXhdKSB7CiAgICAgIHNldCA9IHRydWU7CiAgICB9CgogICAgaWYgKHN0eWxlW3ByZWZpeCArICdWZXJ0aWNhbCddKSB7CiAgICAgIHJlcy50b3AgPSByZXMuYm90dG9tID0gc3R5bGVbcHJlZml4ICsgJ1ZlcnRpY2FsJ107CiAgICAgIHNldCA9IHRydWU7CiAgICB9CgogICAgaWYgKHN0eWxlW3ByZWZpeCArICdIb3Jpem9udGFsJ10pIHsKICAgICAgcmVzLmxlZnQgPSByZXMucmlnaHQgPSBzdHlsZVtwcmVmaXggKyAnSG9yaXpvbnRhbCddOwogICAgICBzZXQgPSB0cnVlOwogICAgfQoKICAgIHN1YnMuZm9yRWFjaChmdW5jdGlvbiAoc3ViKSB7CiAgICAgIHZhciB2YWwgPSBzdHlsZVtwcmVmaXggKyBjYXBGaXJzdChzdWIpXTsKCiAgICAgIGlmICh2YWwpIHsKICAgICAgICByZXNbc3ViXSA9IHZhbDsKICAgICAgICBzZXQgPSB0cnVlOwogICAgICB9CiAgICB9KTsKCiAgICBpZiAoIXNldCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgcmV0dXJuIHJlczsKICB9CgogIGZ1bmN0aW9uIGNhcEZpcnN0KHRleHQpIHsKICAgIHJldHVybiB0ZXh0WzBdLnRvVXBwZXJDYXNlKCkgKyB0ZXh0LnNsaWNlKDEpOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSByZXNvbHZlQm94U3R5bGU7Cn0sMjY2LFtdLCJyZXNvbHZlQm94U3R5bGUiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9JbnNwZWN0b3IvSW5zcGVjdG9yUGFuZWwuanMiOwoKICB2YXIgRWxlbWVudFByb3BlcnRpZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiRWxlbWVudFByb3BlcnRpZXMiKTsKCiAgdmFyIE5ldHdvcmtPdmVybGF5ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIk5ldHdvcmtPdmVybGF5Iik7CgogIHZhciBQZXJmb3JtYW5jZU92ZXJsYXkgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUGVyZm9ybWFuY2VPdmVybGF5Iik7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJSZWFjdCIpOwoKICB2YXIgUHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgInByb3AtdHlwZXMiKTsKCiAgdmFyIFNjcm9sbFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiU2Nyb2xsVmlldyIpOwoKICB2YXIgU3R5bGVTaGVldCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJTdHlsZVNoZWV0Iik7CgogIHZhciBUZXh0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgIlRleHQiKTsKCiAgdmFyIFRvdWNoYWJsZUhpZ2hsaWdodCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJUb3VjaGFibGVIaWdobGlnaHQiKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAiVmlldyIpOwoKICB2YXIgSW5zcGVjdG9yUGFuZWwgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKEluc3BlY3RvclBhbmVsLCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBJbnNwZWN0b3JQYW5lbCgpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEluc3BlY3RvclBhbmVsKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChJbnNwZWN0b3JQYW5lbC5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEluc3BlY3RvclBhbmVsKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEluc3BlY3RvclBhbmVsLCBbewogICAgICBrZXk6ICJyZW5kZXJXYWl0aW5nIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcldhaXRpbmcoKSB7CiAgICAgICAgaWYgKHRoaXMucHJvcHMuaW5zcGVjdGluZykgewogICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLndhaXRpbmdUZXh0LAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJUYXAgc29tZXRoaW5nIHRvIGluc3BlY3QgaXQiCiAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBUZXh0LAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogc3R5bGVzLndhaXRpbmdUZXh0LAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMzQKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgICJOb3RoaW5nIGlzIGluc3BlY3RlZCIKICAgICAgICApOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgdmFyIGNvbnRlbnRzID0gdm9pZCAwOwoKICAgICAgICBpZiAodGhpcy5wcm9wcy5pbnNwZWN0ZWQpIHsKICAgICAgICAgIGNvbnRlbnRzID0gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgU2Nyb2xsVmlldywKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMucHJvcGVydGllcywKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQxCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KEVsZW1lbnRQcm9wZXJ0aWVzLCB7CiAgICAgICAgICAgICAgc3R5bGU6IHRoaXMucHJvcHMuaW5zcGVjdGVkLnN0eWxlLAogICAgICAgICAgICAgIGZyYW1lOiB0aGlzLnByb3BzLmluc3BlY3RlZC5mcmFtZSwKICAgICAgICAgICAgICBzb3VyY2U6IHRoaXMucHJvcHMuaW5zcGVjdGVkLnNvdXJjZSwKICAgICAgICAgICAgICBoaWVyYXJjaHk6IHRoaXMucHJvcHMuaGllcmFyY2h5LAogICAgICAgICAgICAgIHNlbGVjdGlvbjogdGhpcy5wcm9wcy5zZWxlY3Rpb24sCiAgICAgICAgICAgICAgc2V0U2VsZWN0aW9uOiB0aGlzLnByb3BzLnNldFNlbGVjdGlvbiwKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQyCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KQogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMucHJvcHMucGVyZmluZykgewogICAgICAgICAgY29udGVudHMgPSBSZWFjdC5jcmVhdGVFbGVtZW50KFBlcmZvcm1hbmNlT3ZlcmxheSwgewogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNTQKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnByb3BzLm5ldHdvcmtpbmcpIHsKICAgICAgICAgIGNvbnRlbnRzID0gUmVhY3QuY3JlYXRlRWxlbWVudChOZXR3b3JrT3ZlcmxheSwgewogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNTgKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnRlbnRzID0gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMud2FpdGluZywKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDYyCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB0aGlzLnJlbmRlcldhaXRpbmcoKQogICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5jb250YWluZXIsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA2OAogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgIXRoaXMucHJvcHMuZGV2dG9vbHNJc09wZW4gJiYgY29udGVudHMsCiAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBWaWV3LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5idXR0b25Sb3csCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA3MAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChCdXR0b24sIHsKICAgICAgICAgICAgICB0aXRsZTogJ0luc3BlY3QnLAogICAgICAgICAgICAgIHByZXNzZWQ6IHRoaXMucHJvcHMuaW5zcGVjdGluZywKICAgICAgICAgICAgICBvbkNsaWNrOiB0aGlzLnByb3BzLnNldEluc3BlY3RpbmcsCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA3MQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSksCiAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoQnV0dG9uLCB7CiAgICAgICAgICAgICAgdGl0bGU6ICdQZXJmJywKICAgICAgICAgICAgICBwcmVzc2VkOiB0aGlzLnByb3BzLnBlcmZpbmcsCiAgICAgICAgICAgICAgb25DbGljazogdGhpcy5wcm9wcy5zZXRQZXJmaW5nLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogNzYKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KEJ1dHRvbiwgewogICAgICAgICAgICAgIHRpdGxlOiAnTmV0d29yaycsCiAgICAgICAgICAgICAgcHJlc3NlZDogdGhpcy5wcm9wcy5uZXR3b3JraW5nLAogICAgICAgICAgICAgIG9uQ2xpY2s6IHRoaXMucHJvcHMuc2V0TmV0d29ya2luZywKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDgwCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChCdXR0b24sIHsKICAgICAgICAgICAgICB0aXRsZTogJ1RvdWNoYWJsZXMnLAogICAgICAgICAgICAgIHByZXNzZWQ6IHRoaXMucHJvcHMudG91Y2hUYXJnZXR0aW5nLAogICAgICAgICAgICAgIG9uQ2xpY2s6IHRoaXMucHJvcHMuc2V0VG91Y2hUYXJnZXR0aW5nLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogODQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEluc3BlY3RvclBhbmVsOwogIH0oUmVhY3QuQ29tcG9uZW50KTsKCiAgSW5zcGVjdG9yUGFuZWwucHJvcFR5cGVzID0gewogICAgZGV2dG9vbHNJc09wZW46IFByb3BUeXBlcy5ib29sLAogICAgaW5zcGVjdGluZzogUHJvcFR5cGVzLmJvb2wsCiAgICBzZXRJbnNwZWN0aW5nOiBQcm9wVHlwZXMuZnVuYywKICAgIGluc3BlY3RlZDogUHJvcFR5cGVzLm9iamVjdCwKICAgIHBlcmZpbmc6IFByb3BUeXBlcy5ib29sLAogICAgc2V0UGVyZmluZzogUHJvcFR5cGVzLmZ1bmMsCiAgICB0b3VjaFRhcmdldHRpbmc6IFByb3BUeXBlcy5ib29sLAogICAgc2V0VG91Y2hUYXJnZXR0aW5nOiBQcm9wVHlwZXMuZnVuYywKICAgIG5ldHdvcmtpbmc6IFByb3BUeXBlcy5ib29sLAogICAgc2V0TmV0d29ya2luZzogUHJvcFR5cGVzLmZ1bmMKICB9OwoKICB2YXIgQnV0dG9uID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQyKSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoQnV0dG9uLCBfUmVhY3QkQ29tcG9uZW50Mik7CgogICAgZnVuY3Rpb24gQnV0dG9uKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQnV0dG9uKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChCdXR0b24uX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihCdXR0b24pKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQnV0dG9uLCBbewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgIFRvdWNoYWJsZUhpZ2hsaWdodCwKICAgICAgICAgIHsKICAgICAgICAgICAgb25QcmVzczogZnVuY3Rpb24gb25QcmVzcygpIHsKICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLnByb3BzLm9uQ2xpY2soIV90aGlzMy5wcm9wcy5wcmVzc2VkKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3R5bGU6IFtzdHlsZXMuYnV0dG9uLCB0aGlzLnByb3BzLnByZXNzZWQgJiYgc3R5bGVzLmJ1dHRvblByZXNzZWRdLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMTEwCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBUZXh0LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5idXR0b25UZXh0LAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMTE0CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB0aGlzLnByb3BzLnRpdGxlCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEJ1dHRvbjsKICB9KFJlYWN0LkNvbXBvbmVudCk7CgogIHZhciBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7CiAgICBidXR0b25Sb3c6IHsKICAgICAgZmxleERpcmVjdGlvbjogJ3JvdycKICAgIH0sCiAgICBidXR0b246IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiAncmdiYSgwLCAwLCAwLCAwLjMpJywKICAgICAgbWFyZ2luOiAyLAogICAgICBoZWlnaHQ6IDMwLAogICAgICBqdXN0aWZ5Q29udGVudDogJ2NlbnRlcicsCiAgICAgIGFsaWduSXRlbXM6ICdjZW50ZXInCiAgICB9LAogICAgYnV0dG9uUHJlc3NlZDogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6ICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMyknCiAgICB9LAogICAgYnV0dG9uVGV4dDogewogICAgICB0ZXh0QWxpZ246ICdjZW50ZXInLAogICAgICBjb2xvcjogJ3doaXRlJywKICAgICAgbWFyZ2luOiA1CiAgICB9LAogICAgY29udGFpbmVyOiB7CiAgICAgIGJhY2tncm91bmRDb2xvcjogJ3JnYmEoMCwgMCwgMCwgMC43KScKICAgIH0sCiAgICBwcm9wZXJ0aWVzOiB7CiAgICAgIGhlaWdodDogMjAwCiAgICB9LAogICAgd2FpdGluZzogewogICAgICBoZWlnaHQ6IDEwMAogICAgfSwKICAgIHdhaXRpbmdUZXh0OiB7CiAgICAgIGZvbnRTaXplOiAyMCwKICAgICAgdGV4dEFsaWduOiAnY2VudGVyJywKICAgICAgbWFyZ2luVmVydGljYWw6IDIwLAogICAgICBjb2xvcjogJ3doaXRlJwogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gSW5zcGVjdG9yUGFuZWw7Cn0sMjY3LFsyNjgsMjc0LDI3NywxMzAsMTI3LDIyNCwxNjgsMTgxLDI3MSwxNzBdLCJJbnNwZWN0b3JQYW5lbCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9jbGFzcywKICAgICAgX3RlbXAsCiAgICAgIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0luc3BlY3Rvci9FbGVtZW50UHJvcGVydGllcy5qcyI7CgogIHZhciBCb3hJbnNwZWN0b3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQm94SW5zcGVjdG9yIik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUmVhY3QiKTsKCiAgdmFyIFN0eWxlSW5zcGVjdG9yID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlN0eWxlSW5zcGVjdG9yIik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFRleHQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiVGV4dCIpOwoKICB2YXIgVG91Y2hhYmxlSGlnaGxpZ2h0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgIlRvdWNoYWJsZUhpZ2hsaWdodCIpOwoKICB2YXIgVG91Y2hhYmxlV2l0aG91dEZlZWRiYWNrID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgIlRvdWNoYWJsZVdpdGhvdXRGZWVkYmFjayIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJWaWV3Iik7CgogIHZhciBmbGF0dGVuU3R5bGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAiZmxhdHRlblN0eWxlIik7CgogIHZhciBtYXBXaXRoU2VwYXJhdG9yID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMF0sICJtYXBXaXRoU2VwYXJhdG9yIik7CgogIHZhciBvcGVuRmlsZUluRWRpdG9yID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMV0sICJvcGVuRmlsZUluRWRpdG9yIik7CgogIHZhciBFbGVtZW50UHJvcGVydGllcyA9IChfdGVtcCA9IF9jbGFzcyA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoRWxlbWVudFByb3BlcnRpZXMsIF9SZWFjdCRDb21wb25lbnQpOwoKICAgIGZ1bmN0aW9uIEVsZW1lbnRQcm9wZXJ0aWVzKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgRWxlbWVudFByb3BlcnRpZXMpOwogICAgICByZXR1cm4gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKEVsZW1lbnRQcm9wZXJ0aWVzLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoRWxlbWVudFByb3BlcnRpZXMpKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoRWxlbWVudFByb3BlcnRpZXMsIFt7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICAgIHZhciBzdHlsZSA9IGZsYXR0ZW5TdHlsZSh0aGlzLnByb3BzLnN0eWxlKTsKICAgICAgICB2YXIgc2VsZWN0aW9uID0gdGhpcy5wcm9wcy5zZWxlY3Rpb247CiAgICAgICAgdmFyIG9wZW5GaWxlQnV0dG9uID0gdm9pZCAwOwogICAgICAgIHZhciBzb3VyY2UgPSB0aGlzLnByb3BzLnNvdXJjZTsKCiAgICAgICAgdmFyIF9yZWYgPSBzb3VyY2UgfHwge30sCiAgICAgICAgICAgIGZpbGVOYW1lID0gX3JlZi5maWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlciA9IF9yZWYubGluZU51bWJlcjsKCiAgICAgICAgaWYgKGZpbGVOYW1lICYmIGxpbmVOdW1iZXIpIHsKICAgICAgICAgIHZhciBwYXJ0cyA9IGZpbGVOYW1lLnNwbGl0KCcvJyk7CiAgICAgICAgICB2YXIgZmlsZU5hbWVTaG9ydCA9IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdOwogICAgICAgICAgb3BlbkZpbGVCdXR0b24gPSBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBUb3VjaGFibGVIaWdobGlnaHQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLm9wZW5CdXR0b24sCiAgICAgICAgICAgICAgb25QcmVzczogb3BlbkZpbGVJbkVkaXRvci5iaW5kKG51bGwsIGZpbGVOYW1lLCBsaW5lTnVtYmVyKSwKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDYyCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5vcGVuQnV0dG9uVGl0bGUsCiAgICAgICAgICAgICAgICBudW1iZXJPZkxpbmVzOiAxLAogICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogNjUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZpbGVOYW1lU2hvcnQsCiAgICAgICAgICAgICAgIjoiLAogICAgICAgICAgICAgIGxpbmVOdW1iZXIKICAgICAgICAgICAgKQogICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVG91Y2hhYmxlV2l0aG91dEZlZWRiYWNrLAogICAgICAgICAgewogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNzQKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFZpZXcsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmluZm8sCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA3NQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICBWaWV3LAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuYnJlYWRjcnVtYiwKICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDc2CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBtYXBXaXRoU2VwYXJhdG9yKHRoaXMucHJvcHMuaGllcmFyY2h5LCBmdW5jdGlvbiAoaGllcmFyY2h5SXRlbSwgaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgICAgIFRvdWNoYWJsZUhpZ2hsaWdodCwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGtleTogJ2l0ZW0tJyArIGksCiAgICAgICAgICAgICAgICAgICAgc3R5bGU6IFtzdHlsZXMuYnJlYWRJdGVtLCBpID09PSBzZWxlY3Rpb24gJiYgc3R5bGVzLnNlbGVjdGVkXSwKICAgICAgICAgICAgICAgICAgICBvblByZXNzOiBmdW5jdGlvbiBvblByZXNzKCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMi5wcm9wcy5zZXRTZWxlY3Rpb24oaSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDgwCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5icmVhZEl0ZW1UZXh0LAogICAgICAgICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogODUKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGhpZXJhcmNoeUl0ZW0ubmFtZQogICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICAgICAgVGV4dCwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGtleTogJ3NlcC0nICsgaSwKICAgICAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmJyZWFkU2VwLAogICAgICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogOTEKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICJcdTI1QjgiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICksCiAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLnJvdywKICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDk3CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5jb2wsCiAgICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA5OAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChTdHlsZUluc3BlY3RvciwgewogICAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGUsCiAgICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA5OQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIG9wZW5GaWxlQnV0dG9uCiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KEJveEluc3BlY3RvciwgewogICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlLAogICAgICAgICAgICAgICAgZnJhbWU6IHRoaXMucHJvcHMuZnJhbWUsCiAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAxMDQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KQogICAgICAgICAgICApCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEVsZW1lbnRQcm9wZXJ0aWVzOwogIH0oUmVhY3QuQ29tcG9uZW50KSwgX2NsYXNzLnByb3BUeXBlcyA9IHsKICAgIGhpZXJhcmNoeTogUHJvcFR5cGVzLmFycmF5LmlzUmVxdWlyZWQsCiAgICBzdHlsZTogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLm9iamVjdCwgUHJvcFR5cGVzLmFycmF5LCBQcm9wVHlwZXMubnVtYmVyXSksCiAgICBzb3VyY2U6IFByb3BUeXBlcy5zaGFwZSh7CiAgICAgIGZpbGVOYW1lOiBQcm9wVHlwZXMuc3RyaW5nLAogICAgICBsaW5lTnVtYmVyOiBQcm9wVHlwZXMubnVtYmVyCiAgICB9KQogIH0sIF90ZW1wKTsKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgYnJlYWRTZXA6IHsKICAgICAgZm9udFNpemU6IDgsCiAgICAgIGNvbG9yOiAnd2hpdGUnCiAgICB9LAogICAgYnJlYWRjcnVtYjogewogICAgICBmbGV4RGlyZWN0aW9uOiAncm93JywKICAgICAgZmxleFdyYXA6ICd3cmFwJywKICAgICAgYWxpZ25JdGVtczogJ2ZsZXgtc3RhcnQnLAogICAgICBtYXJnaW5Cb3R0b206IDUKICAgIH0sCiAgICBzZWxlY3RlZDogewogICAgICBib3JkZXJDb2xvcjogJ3doaXRlJywKICAgICAgYm9yZGVyUmFkaXVzOiA1CiAgICB9LAogICAgYnJlYWRJdGVtOiB7CiAgICAgIGJvcmRlcldpZHRoOiAxLAogICAgICBib3JkZXJDb2xvcjogJ3RyYW5zcGFyZW50JywKICAgICAgbWFyZ2luSG9yaXpvbnRhbDogMgogICAgfSwKICAgIGJyZWFkSXRlbVRleHQ6IHsKICAgICAgZm9udFNpemU6IDEwLAogICAgICBjb2xvcjogJ3doaXRlJywKICAgICAgbWFyZ2luSG9yaXpvbnRhbDogNQogICAgfSwKICAgIHJvdzogewogICAgICBmbGV4RGlyZWN0aW9uOiAncm93JywKICAgICAgYWxpZ25JdGVtczogJ2NlbnRlcicsCiAgICAgIGp1c3RpZnlDb250ZW50OiAnc3BhY2UtYmV0d2VlbicKICAgIH0sCiAgICBjb2w6IHsKICAgICAgZmxleDogMQogICAgfSwKICAgIGluZm86IHsKICAgICAgcGFkZGluZzogMTAKICAgIH0sCiAgICBvcGVuQnV0dG9uOiB7CiAgICAgIHBhZGRpbmc6IDEwLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6ICcjMDAwJywKICAgICAgbWFyZ2luVmVydGljYWw6IDUsCiAgICAgIG1hcmdpblJpZ2h0OiA1LAogICAgICBib3JkZXJSYWRpdXM6IDIKICAgIH0sCiAgICBvcGVuQnV0dG9uVGl0bGU6IHsKICAgICAgY29sb3I6ICd3aGl0ZScsCiAgICAgIGZvbnRTaXplOiA4CiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBFbGVtZW50UHJvcGVydGllczsKfSwyNjgsWzI2OSwxMjcsMTMwLDI3MCwxNjgsMTgxLDI3MSwxOTAsMTcwLDEwMSwyNzIsMjczXSwiRWxlbWVudFByb3BlcnRpZXMiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9JbnNwZWN0b3IvQm94SW5zcGVjdG9yLmpzIjsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0Iik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFRleHQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiVGV4dCIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJWaWV3Iik7CgogIHZhciByZXNvbHZlQm94U3R5bGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAicmVzb2x2ZUJveFN0eWxlIik7CgogIHZhciBibGFuayA9IHsKICAgIHRvcDogMCwKICAgIGxlZnQ6IDAsCiAgICByaWdodDogMCwKICAgIGJvdHRvbTogMAogIH07CgogIHZhciBCb3hJbnNwZWN0b3IgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKEJveEluc3BlY3RvciwgX1JlYWN0JENvbXBvbmVudCk7CgogICAgZnVuY3Rpb24gQm94SW5zcGVjdG9yKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQm94SW5zcGVjdG9yKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChCb3hJbnNwZWN0b3IuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihCb3hJbnNwZWN0b3IpKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQm94SW5zcGVjdG9yLCBbewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBmcmFtZSA9IHRoaXMucHJvcHMuZnJhbWU7CiAgICAgICAgdmFyIHN0eWxlID0gdGhpcy5wcm9wcy5zdHlsZTsKICAgICAgICB2YXIgbWFyZ2luID0gc3R5bGUgJiYgcmVzb2x2ZUJveFN0eWxlKCdtYXJnaW4nLCBzdHlsZSkgfHwgYmxhbms7CiAgICAgICAgdmFyIHBhZGRpbmcgPSBzdHlsZSAmJiByZXNvbHZlQm94U3R5bGUoJ3BhZGRpbmcnLCBzdHlsZSkgfHwgYmxhbms7CiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBCb3hDb250YWluZXIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHRpdGxlOiAibWFyZ2luIiwKICAgICAgICAgICAgdGl0bGVTdHlsZTogc3R5bGVzLm1hcmdpbkxhYmVsLAogICAgICAgICAgICBib3g6IG1hcmdpbiwKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDM0CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBCb3hDb250YWluZXIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB0aXRsZTogInBhZGRpbmciLAogICAgICAgICAgICAgIGJveDogcGFkZGluZywKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDM1CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgIFZpZXcsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogMzYKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgICBUZXh0LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmlubmVyVGV4dCwKICAgICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDM3CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiKCIsCiAgICAgICAgICAgICAgICAoZnJhbWUubGVmdCB8fCAwKS50b0ZpeGVkKDEpLAogICAgICAgICAgICAgICAgIiwgIiwKICAgICAgICAgICAgICAgIChmcmFtZS50b3AgfHwgMCkudG9GaXhlZCgxKSwKICAgICAgICAgICAgICAgICIpIgogICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuaW5uZXJUZXh0LAogICAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogNDAKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIChmcmFtZS53aWR0aCB8fCAwKS50b0ZpeGVkKDEpLAogICAgICAgICAgICAgICAgIiBceEQ3ICIsCiAgICAgICAgICAgICAgICAoZnJhbWUuaGVpZ2h0IHx8IDApLnRvRml4ZWQoMSkKICAgICAgICAgICAgICApCiAgICAgICAgICAgICkKICAgICAgICAgICkKICAgICAgICApOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQm94SW5zcGVjdG9yOwogIH0oUmVhY3QuQ29tcG9uZW50KTsKCiAgdmFyIEJveENvbnRhaW5lciA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50MikgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKEJveENvbnRhaW5lciwgX1JlYWN0JENvbXBvbmVudDIpOwoKICAgIGZ1bmN0aW9uIEJveENvbnRhaW5lcigpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEJveENvbnRhaW5lcik7CiAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoQm94Q29udGFpbmVyLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQm94Q29udGFpbmVyKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEJveENvbnRhaW5lciwgW3sKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICB2YXIgYm94ID0gdGhpcy5wcm9wcy5ib3g7CiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBWaWV3LAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogc3R5bGVzLmJveCwKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDU0CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBWaWV3LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5yb3csCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA1NQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICBUZXh0LAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHN0eWxlOiBbdGhpcy5wcm9wcy50aXRsZVN0eWxlLCBzdHlsZXMubGFiZWxdLAogICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogNTgKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHRoaXMucHJvcHMudGl0bGUKICAgICAgICAgICAgKSwKICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICBUZXh0LAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuYm94VGV4dCwKICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDU5CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBib3gudG9wCiAgICAgICAgICAgICkKICAgICAgICAgICksCiAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBWaWV3LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5yb3csCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA2MQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICBUZXh0LAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuYm94VGV4dCwKICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDYyCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBib3gubGVmdAogICAgICAgICAgICApLAogICAgICAgICAgICB0aGlzLnByb3BzLmNoaWxkcmVuLAogICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5ib3hUZXh0LAogICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogNjQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGJveC5yaWdodAogICAgICAgICAgICApCiAgICAgICAgICApLAogICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVGV4dCwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuYm94VGV4dCwKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDY2CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBib3guYm90dG9tCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEJveENvbnRhaW5lcjsKICB9KFJlYWN0LkNvbXBvbmVudCk7CgogIHZhciBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7CiAgICByb3c6IHsKICAgICAgZmxleERpcmVjdGlvbjogJ3JvdycsCiAgICAgIGFsaWduSXRlbXM6ICdjZW50ZXInLAogICAgICBqdXN0aWZ5Q29udGVudDogJ3NwYWNlLWFyb3VuZCcKICAgIH0sCiAgICBtYXJnaW5MYWJlbDogewogICAgICB3aWR0aDogNjAKICAgIH0sCiAgICBsYWJlbDogewogICAgICBmb250U2l6ZTogMTAsCiAgICAgIGNvbG9yOiAncmdiKDI1NSwxMDAsMCknLAogICAgICBtYXJnaW5MZWZ0OiA1LAogICAgICBmbGV4OiAxLAogICAgICB0ZXh0QWxpZ246ICdsZWZ0JywKICAgICAgdG9wOiAtMwogICAgfSwKICAgIGJ1ZmZlcjogewogICAgICBmb250U2l6ZTogMTAsCiAgICAgIGNvbG9yOiAneWVsbG93JywKICAgICAgZmxleDogMSwKICAgICAgdGV4dEFsaWduOiAnY2VudGVyJwogICAgfSwKICAgIGlubmVyVGV4dDogewogICAgICBjb2xvcjogJ3llbGxvdycsCiAgICAgIGZvbnRTaXplOiAxMiwKICAgICAgdGV4dEFsaWduOiAnY2VudGVyJywKICAgICAgd2lkdGg6IDcwCiAgICB9LAogICAgYm94OiB7CiAgICAgIGJvcmRlcldpZHRoOiAxLAogICAgICBib3JkZXJDb2xvcjogJ2dyZXknCiAgICB9LAogICAgYm94VGV4dDogewogICAgICBjb2xvcjogJ3doaXRlJywKICAgICAgZm9udFNpemU6IDEyLAogICAgICBtYXJnaW5Ib3Jpem9udGFsOiAzLAogICAgICBtYXJnaW5WZXJ0aWNhbDogMiwKICAgICAgdGV4dEFsaWduOiAnY2VudGVyJwogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gQm94SW5zcGVjdG9yOwp9LDI2OSxbMTMwLDE2OCwxODEsMTcwLDI2Nl0sIkJveEluc3BlY3RvciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0luc3BlY3Rvci9TdHlsZUluc3BlY3Rvci5qcyI7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJSZWFjdCIpOwoKICB2YXIgU3R5bGVTaGVldCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJTdHlsZVNoZWV0Iik7CgogIHZhciBUZXh0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlRleHQiKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiVmlldyIpOwoKICB2YXIgU3R5bGVJbnNwZWN0b3IgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKFN0eWxlSW5zcGVjdG9yLCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBTdHlsZUluc3BlY3RvcigpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFN0eWxlSW5zcGVjdG9yKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChTdHlsZUluc3BlY3Rvci5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKFN0eWxlSW5zcGVjdG9yKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFN0eWxlSW5zcGVjdG9yLCBbewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICBpZiAoIXRoaXMucHJvcHMuc3R5bGUpIHsKICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBUZXh0LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5ub1N0eWxlLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJObyBzdHlsZSIKICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICB2YXIgbmFtZXMgPSBPYmplY3Qua2V5cyh0aGlzLnByb3BzLnN0eWxlKTsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgIFZpZXcsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuY29udGFpbmVyLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMjYKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFZpZXcsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDI3CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBuYW1lcy5tYXAoZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGtleTogbmFtZSwKICAgICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5hdHRyLAogICAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjgKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAiOiIKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9KQogICAgICAgICAgKSwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFZpZXcsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDMxCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBuYW1lcy5tYXAoZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICB2YXIgdmFsdWUgPSB0eXBlb2YgX3RoaXMyLnByb3BzLnN0eWxlW25hbWVdID09PSAnb2JqZWN0JyA/IEpTT04uc3RyaW5naWZ5KF90aGlzMi5wcm9wcy5zdHlsZVtuYW1lXSkgOiBfdGhpczIucHJvcHMuc3R5bGVbbmFtZV07CiAgICAgICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgICBUZXh0LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBrZXk6IG5hbWUsCiAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMudmFsdWUsCiAgICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAzNAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmFsdWUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9KQogICAgICAgICAgKQogICAgICAgICk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBTdHlsZUluc3BlY3RvcjsKICB9KFJlYWN0LkNvbXBvbmVudCk7CgogIHZhciBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7CiAgICBjb250YWluZXI6IHsKICAgICAgZmxleERpcmVjdGlvbjogJ3JvdycKICAgIH0sCiAgICByb3c6IHsKICAgICAgZmxleERpcmVjdGlvbjogJ3JvdycsCiAgICAgIGFsaWduSXRlbXM6ICdjZW50ZXInLAogICAgICBqdXN0aWZ5Q29udGVudDogJ3NwYWNlLWFyb3VuZCcKICAgIH0sCiAgICBhdHRyOiB7CiAgICAgIGZvbnRTaXplOiAxMCwKICAgICAgY29sb3I6ICcjY2NjJwogICAgfSwKICAgIHZhbHVlOiB7CiAgICAgIGZvbnRTaXplOiAxMCwKICAgICAgY29sb3I6ICd3aGl0ZScsCiAgICAgIG1hcmdpbkxlZnQ6IDEwCiAgICB9LAogICAgbm9TdHlsZTogewogICAgICBjb2xvcjogJ3doaXRlJywKICAgICAgZm9udFNpemU6IDEwCiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBTdHlsZUluc3BlY3RvcjsKfSwyNzAsWzEzMCwxNjgsMTgxLDE3MF0sIlN0eWxlSW5zcGVjdG9yIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29tcG9uZW50cy9Ub3VjaGFibGUvVG91Y2hhYmxlSGlnaGxpZ2h0LmpzIjsKCiAgdmFyIENvbG9yUHJvcFR5cGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQ29sb3JQcm9wVHlwZSIpOwoKICB2YXIgTmF0aXZlTWV0aG9kc01peGluID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIk5hdGl2ZU1ldGhvZHNNaXhpbiIpOwoKICB2YXIgUHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgInByb3AtdHlwZXMiKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlJlYWN0Iik7CgogIHZhciBSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlJlYWN0TmF0aXZlVmlld0F0dHJpYnV0ZXMiKTsKCiAgdmFyIFN0eWxlU2hlZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiU3R5bGVTaGVldCIpOwoKICB2YXIgVG91Y2hhYmxlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgIlRvdWNoYWJsZSIpOwoKICB2YXIgVG91Y2hhYmxlV2l0aG91dEZlZWRiYWNrID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgIlRvdWNoYWJsZVdpdGhvdXRGZWVkYmFjayIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJWaWV3Iik7CgogIHZhciBWaWV3UHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs5XSwgIlZpZXdQcm9wVHlwZXMiKTsKCiAgdmFyIGNyZWF0ZVJlYWN0Q2xhc3MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEwXSwgImNyZWF0ZS1yZWFjdC1jbGFzcyIpOwoKICB2YXIgZW5zdXJlUG9zaXRpdmVEZWxheVByb3BzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMV0sICJlbnN1cmVQb3NpdGl2ZURlbGF5UHJvcHMiKTsKCiAgdmFyIERFRkFVTFRfUFJPUFMgPSB7CiAgICBhY3RpdmVPcGFjaXR5OiAwLjg1LAogICAgZGVsYXlQcmVzc091dDogMTAwLAogICAgdW5kZXJsYXlDb2xvcjogJ2JsYWNrJwogIH07CiAgdmFyIFBSRVNTX1JFVEVOVElPTl9PRkZTRVQgPSB7CiAgICB0b3A6IDIwLAogICAgbGVmdDogMjAsCiAgICByaWdodDogMjAsCiAgICBib3R0b206IDMwCiAgfTsKICB2YXIgVG91Y2hhYmxlSGlnaGxpZ2h0ID0gY3JlYXRlUmVhY3RDbGFzcyh7CiAgICBkaXNwbGF5TmFtZTogJ1RvdWNoYWJsZUhpZ2hsaWdodCcsCiAgICBwcm9wVHlwZXM6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBUb3VjaGFibGVXaXRob3V0RmVlZGJhY2sucHJvcFR5cGVzLCB7CiAgICAgIGFjdGl2ZU9wYWNpdHk6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgIHVuZGVybGF5Q29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICAgIHN0eWxlOiBWaWV3UHJvcFR5cGVzLnN0eWxlLAogICAgICBvblNob3dVbmRlcmxheTogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uSGlkZVVuZGVybGF5OiBQcm9wVHlwZXMuZnVuYywKICAgICAgaGFzVFZQcmVmZXJyZWRGb2N1czogUHJvcFR5cGVzLmJvb2wsCiAgICAgIHR2UGFyYWxsYXhQcm9wZXJ0aWVzOiBQcm9wVHlwZXMub2JqZWN0CiAgICB9KSwKICAgIG1peGluczogW05hdGl2ZU1ldGhvZHNNaXhpbiwgVG91Y2hhYmxlLk1peGluXSwKICAgIGdldERlZmF1bHRQcm9wczogZnVuY3Rpb24gZ2V0RGVmYXVsdFByb3BzKCkgewogICAgICByZXR1cm4gREVGQVVMVF9QUk9QUzsKICAgIH0sCiAgICBnZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uIGdldEluaXRpYWxTdGF0ZSgpIHsKICAgICAgdGhpcy5faXNNb3VudGVkID0gZmFsc2U7CiAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy50b3VjaGFibGVHZXRJbml0aWFsU3RhdGUoKSwgewogICAgICAgIGV4dHJhQ2hpbGRTdHlsZTogbnVsbCwKICAgICAgICBleHRyYVVuZGVybGF5U3R5bGU6IG51bGwKICAgICAgfSk7CiAgICB9LAogICAgY29tcG9uZW50RGlkTW91bnQ6IGZ1bmN0aW9uIGNvbXBvbmVudERpZE1vdW50KCkgewogICAgICB0aGlzLl9pc01vdW50ZWQgPSB0cnVlOwogICAgICBlbnN1cmVQb3NpdGl2ZURlbGF5UHJvcHModGhpcy5wcm9wcyk7CiAgICB9LAogICAgY29tcG9uZW50V2lsbFVubW91bnQ6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICB0aGlzLl9pc01vdW50ZWQgPSBmYWxzZTsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2hpZGVUaW1lb3V0KTsKICAgIH0sCiAgICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzOiBmdW5jdGlvbiBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wcykgewogICAgICBlbnN1cmVQb3NpdGl2ZURlbGF5UHJvcHMobmV4dFByb3BzKTsKICAgIH0sCiAgICB2aWV3Q29uZmlnOiB7CiAgICAgIHVpVmlld0NsYXNzTmFtZTogJ1JDVFZpZXcnLAogICAgICB2YWxpZEF0dHJpYnV0ZXM6IFJlYWN0TmF0aXZlVmlld0F0dHJpYnV0ZXMuUkNUVmlldwogICAgfSwKICAgIHRvdWNoYWJsZUhhbmRsZUFjdGl2ZVByZXNzSW46IGZ1bmN0aW9uIHRvdWNoYWJsZUhhbmRsZUFjdGl2ZVByZXNzSW4oZSkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy5faGlkZVRpbWVvdXQpOwogICAgICB0aGlzLl9oaWRlVGltZW91dCA9IG51bGw7CgogICAgICB0aGlzLl9zaG93VW5kZXJsYXkoKTsKCiAgICAgIHRoaXMucHJvcHMub25QcmVzc0luICYmIHRoaXMucHJvcHMub25QcmVzc0luKGUpOwogICAgfSwKICAgIHRvdWNoYWJsZUhhbmRsZUFjdGl2ZVByZXNzT3V0OiBmdW5jdGlvbiB0b3VjaGFibGVIYW5kbGVBY3RpdmVQcmVzc091dChlKSB7CiAgICAgIGlmICghdGhpcy5faGlkZVRpbWVvdXQpIHsKICAgICAgICB0aGlzLl9oaWRlVW5kZXJsYXkoKTsKICAgICAgfQoKICAgICAgdGhpcy5wcm9wcy5vblByZXNzT3V0ICYmIHRoaXMucHJvcHMub25QcmVzc091dChlKTsKICAgIH0sCiAgICB0b3VjaGFibGVIYW5kbGVQcmVzczogZnVuY3Rpb24gdG91Y2hhYmxlSGFuZGxlUHJlc3MoZSkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy5faGlkZVRpbWVvdXQpOwoKICAgICAgdGhpcy5fc2hvd1VuZGVybGF5KCk7CgogICAgICB0aGlzLl9oaWRlVGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5faGlkZVVuZGVybGF5LCB0aGlzLnByb3BzLmRlbGF5UHJlc3NPdXQpOwogICAgICB0aGlzLnByb3BzLm9uUHJlc3MgJiYgdGhpcy5wcm9wcy5vblByZXNzKGUpOwogICAgfSwKICAgIHRvdWNoYWJsZUhhbmRsZUxvbmdQcmVzczogZnVuY3Rpb24gdG91Y2hhYmxlSGFuZGxlTG9uZ1ByZXNzKGUpIHsKICAgICAgdGhpcy5wcm9wcy5vbkxvbmdQcmVzcyAmJiB0aGlzLnByb3BzLm9uTG9uZ1ByZXNzKGUpOwogICAgfSwKICAgIHRvdWNoYWJsZUdldFByZXNzUmVjdE9mZnNldDogZnVuY3Rpb24gdG91Y2hhYmxlR2V0UHJlc3NSZWN0T2Zmc2V0KCkgewogICAgICByZXR1cm4gdGhpcy5wcm9wcy5wcmVzc1JldGVudGlvbk9mZnNldCB8fCBQUkVTU19SRVRFTlRJT05fT0ZGU0VUOwogICAgfSwKICAgIHRvdWNoYWJsZUdldEhpdFNsb3A6IGZ1bmN0aW9uIHRvdWNoYWJsZUdldEhpdFNsb3AoKSB7CiAgICAgIHJldHVybiB0aGlzLnByb3BzLmhpdFNsb3A7CiAgICB9LAogICAgdG91Y2hhYmxlR2V0SGlnaGxpZ2h0RGVsYXlNUzogZnVuY3Rpb24gdG91Y2hhYmxlR2V0SGlnaGxpZ2h0RGVsYXlNUygpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvcHMuZGVsYXlQcmVzc0luOwogICAgfSwKICAgIHRvdWNoYWJsZUdldExvbmdQcmVzc0RlbGF5TVM6IGZ1bmN0aW9uIHRvdWNoYWJsZUdldExvbmdQcmVzc0RlbGF5TVMoKSB7CiAgICAgIHJldHVybiB0aGlzLnByb3BzLmRlbGF5TG9uZ1ByZXNzOwogICAgfSwKICAgIHRvdWNoYWJsZUdldFByZXNzT3V0RGVsYXlNUzogZnVuY3Rpb24gdG91Y2hhYmxlR2V0UHJlc3NPdXREZWxheU1TKCkgewogICAgICByZXR1cm4gdGhpcy5wcm9wcy5kZWxheVByZXNzT3V0OwogICAgfSwKICAgIF9zaG93VW5kZXJsYXk6IGZ1bmN0aW9uIF9zaG93VW5kZXJsYXkoKSB7CiAgICAgIGlmICghdGhpcy5faXNNb3VudGVkIHx8ICF0aGlzLl9oYXNQcmVzc0hhbmRsZXIoKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgZXh0cmFDaGlsZFN0eWxlOiB7CiAgICAgICAgICBvcGFjaXR5OiB0aGlzLnByb3BzLmFjdGl2ZU9wYWNpdHkKICAgICAgICB9LAogICAgICAgIGV4dHJhVW5kZXJsYXlTdHlsZTogewogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiB0aGlzLnByb3BzLnVuZGVybGF5Q29sb3IKICAgICAgICB9CiAgICAgIH0pOwogICAgICB0aGlzLnByb3BzLm9uU2hvd1VuZGVybGF5ICYmIHRoaXMucHJvcHMub25TaG93VW5kZXJsYXkoKTsKICAgIH0sCiAgICBfaGlkZVVuZGVybGF5OiBmdW5jdGlvbiBfaGlkZVVuZGVybGF5KCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy5faGlkZVRpbWVvdXQpOwogICAgICB0aGlzLl9oaWRlVGltZW91dCA9IG51bGw7CgogICAgICBpZiAodGhpcy5faGFzUHJlc3NIYW5kbGVyKCkpIHsKICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgIGV4dHJhQ2hpbGRTdHlsZTogbnVsbCwKICAgICAgICAgIGV4dHJhVW5kZXJsYXlTdHlsZTogbnVsbAogICAgICAgIH0pOwogICAgICAgIHRoaXMucHJvcHMub25IaWRlVW5kZXJsYXkgJiYgdGhpcy5wcm9wcy5vbkhpZGVVbmRlcmxheSgpOwogICAgICB9CiAgICB9LAogICAgX2hhc1ByZXNzSGFuZGxlcjogZnVuY3Rpb24gX2hhc1ByZXNzSGFuZGxlcigpIHsKICAgICAgcmV0dXJuICEhKHRoaXMucHJvcHMub25QcmVzcyB8fCB0aGlzLnByb3BzLm9uUHJlc3NJbiB8fCB0aGlzLnByb3BzLm9uUHJlc3NPdXQgfHwgdGhpcy5wcm9wcy5vbkxvbmdQcmVzcyk7CiAgICB9LAogICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgIHZhciBjaGlsZCA9IFJlYWN0LkNoaWxkcmVuLm9ubHkodGhpcy5wcm9wcy5jaGlsZHJlbik7CiAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgIFZpZXcsCiAgICAgICAgewogICAgICAgICAgYWNjZXNzaWJsZTogdGhpcy5wcm9wcy5hY2Nlc3NpYmxlICE9PSBmYWxzZSwKICAgICAgICAgIGFjY2Vzc2liaWxpdHlMYWJlbDogdGhpcy5wcm9wcy5hY2Nlc3NpYmlsaXR5TGFiZWwsCiAgICAgICAgICBhY2Nlc3NpYmlsaXR5Q29tcG9uZW50VHlwZTogdGhpcy5wcm9wcy5hY2Nlc3NpYmlsaXR5Q29tcG9uZW50VHlwZSwKICAgICAgICAgIGFjY2Vzc2liaWxpdHlUcmFpdHM6IHRoaXMucHJvcHMuYWNjZXNzaWJpbGl0eVRyYWl0cywKICAgICAgICAgIHN0eWxlOiBTdHlsZVNoZWV0LmNvbXBvc2UodGhpcy5wcm9wcy5zdHlsZSwgdGhpcy5zdGF0ZS5leHRyYVVuZGVybGF5U3R5bGUpLAogICAgICAgICAgb25MYXlvdXQ6IHRoaXMucHJvcHMub25MYXlvdXQsCiAgICAgICAgICBoaXRTbG9wOiB0aGlzLnByb3BzLmhpdFNsb3AsCiAgICAgICAgICBpc1RWU2VsZWN0YWJsZTogdHJ1ZSwKICAgICAgICAgIHR2UGFyYWxsYXhQcm9wZXJ0aWVzOiB0aGlzLnByb3BzLnR2UGFyYWxsYXhQcm9wZXJ0aWVzLAogICAgICAgICAgaGFzVFZQcmVmZXJyZWRGb2N1czogdGhpcy5wcm9wcy5oYXNUVlByZWZlcnJlZEZvY3VzLAogICAgICAgICAgb25TdGFydFNob3VsZFNldFJlc3BvbmRlcjogdGhpcy50b3VjaGFibGVIYW5kbGVTdGFydFNob3VsZFNldFJlc3BvbmRlciwKICAgICAgICAgIG9uUmVzcG9uZGVyVGVybWluYXRpb25SZXF1ZXN0OiB0aGlzLnRvdWNoYWJsZUhhbmRsZVJlc3BvbmRlclRlcm1pbmF0aW9uUmVxdWVzdCwKICAgICAgICAgIG9uUmVzcG9uZGVyR3JhbnQ6IHRoaXMudG91Y2hhYmxlSGFuZGxlUmVzcG9uZGVyR3JhbnQsCiAgICAgICAgICBvblJlc3BvbmRlck1vdmU6IHRoaXMudG91Y2hhYmxlSGFuZGxlUmVzcG9uZGVyTW92ZSwKICAgICAgICAgIG9uUmVzcG9uZGVyUmVsZWFzZTogdGhpcy50b3VjaGFibGVIYW5kbGVSZXNwb25kZXJSZWxlYXNlLAogICAgICAgICAgb25SZXNwb25kZXJUZXJtaW5hdGU6IHRoaXMudG91Y2hhYmxlSGFuZGxlUmVzcG9uZGVyVGVybWluYXRlLAogICAgICAgICAgbmF0aXZlSUQ6IHRoaXMucHJvcHMubmF0aXZlSUQsCiAgICAgICAgICB0ZXN0SUQ6IHRoaXMucHJvcHMudGVzdElELAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogMzA2CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBSZWFjdC5jbG9uZUVsZW1lbnQoY2hpbGQsIHsKICAgICAgICAgIHN0eWxlOiBTdHlsZVNoZWV0LmNvbXBvc2UoY2hpbGQucHJvcHMuc3R5bGUsIHRoaXMuc3RhdGUuZXh0cmFDaGlsZFN0eWxlKQogICAgICAgIH0pLAogICAgICAgIFRvdWNoYWJsZS5yZW5kZXJEZWJ1Z1ZpZXcoewogICAgICAgICAgY29sb3I6ICdncmVlbicsCiAgICAgICAgICBoaXRTbG9wOiB0aGlzLnByb3BzLmhpdFNsb3AKICAgICAgICB9KQogICAgICApOwogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gVG91Y2hhYmxlSGlnaGxpZ2h0Owp9LDI3MSxbMTIzLDEyNSwxMjcsMTMwLDE3MSwxNjgsMTgyLDE5MCwxNzAsMTMxLDE3MiwxOTJdLCJUb3VjaGFibGVIaWdobGlnaHQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIGZ1bmN0aW9uIG1hcFdpdGhTZXBhcmF0b3IoaXRlbXMsIGl0ZW1SZW5kZXJlciwgc3BhY2VyUmVuZGVyZXIpIHsKICAgIHZhciBtYXBwZWQgPSBbXTsKCiAgICBpZiAoaXRlbXMubGVuZ3RoID4gMCkgewogICAgICBtYXBwZWQucHVzaChpdGVtUmVuZGVyZXIoaXRlbXNbMF0sIDAsIGl0ZW1zKSk7CgogICAgICBmb3IgKHZhciBpaSA9IDE7IGlpIDwgaXRlbXMubGVuZ3RoOyBpaSsrKSB7CiAgICAgICAgbWFwcGVkLnB1c2goc3BhY2VyUmVuZGVyZXIoaWkgLSAxKSwgaXRlbVJlbmRlcmVyKGl0ZW1zW2lpXSwgaWksIGl0ZW1zKSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbWFwcGVkOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBtYXBXaXRoU2VwYXJhdG9yOwp9LDI3MixbXSwibWFwV2l0aFNlcGFyYXRvciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGdldERldlNlcnZlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJnZXREZXZTZXJ2ZXIiKTsKCiAgZnVuY3Rpb24gb3BlbkZpbGVJbkVkaXRvcihmaWxlLCBsaW5lTnVtYmVyKSB7CiAgICBmZXRjaChnZXREZXZTZXJ2ZXIoKS51cmwgKyAnb3Blbi1zdGFjay1mcmFtZScsIHsKICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICBmaWxlOiBmaWxlLAogICAgICAgIGxpbmVOdW1iZXI6IGxpbmVOdW1iZXIKICAgICAgfSkKICAgIH0pOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBvcGVuRmlsZUluRWRpdG9yOwp9LDI3MyxbMzZdLCJvcGVuRmlsZUluRWRpdG9yIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvSW5zcGVjdG9yL05ldHdvcmtPdmVybGF5LmpzIjsKCiAgdmFyIExpc3RWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkxpc3RWaWV3Iik7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJSZWFjdCIpOwoKICB2YXIgU2Nyb2xsVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJTY3JvbGxWaWV3Iik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFRleHQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiVGV4dCIpOwoKICB2YXIgVG91Y2hhYmxlSGlnaGxpZ2h0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgIlRvdWNoYWJsZUhpZ2hsaWdodCIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJWaWV3Iik7CgogIHZhciBXZWJTb2NrZXRJbnRlcmNlcHRvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJXZWJTb2NrZXRJbnRlcmNlcHRvciIpOwoKICB2YXIgWEhSSW50ZXJjZXB0b3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAiWEhSSW50ZXJjZXB0b3IiKTsKCiAgdmFyIExJU1RWSUVXX0NFTExfSEVJR0hUID0gMTU7CiAgdmFyIFNFUEFSQVRPUl9USElDS05FU1MgPSAyOwogIHZhciBuZXh0WEhSSWQgPSAwOwoKICB2YXIgTmV0d29ya092ZXJsYXkgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKE5ldHdvcmtPdmVybGF5LCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBOZXR3b3JrT3ZlcmxheShwcm9wcykgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgTmV0d29ya092ZXJsYXkpOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKE5ldHdvcmtPdmVybGF5Ll9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoTmV0d29ya092ZXJsYXkpKS5jYWxsKHRoaXMsIHByb3BzKSk7CgogICAgICBfdGhpcy5fcmVxdWVzdHMgPSBbXTsKICAgICAgX3RoaXMuX2RldGFpbFZpZXdJdGVtcyA9IFtdOwogICAgICBfdGhpcy5fbGlzdFZpZXdEYXRhU291cmNlID0gbmV3IExpc3RWaWV3LkRhdGFTb3VyY2UoewogICAgICAgIHJvd0hhc0NoYW5nZWQ6IGZ1bmN0aW9uIHJvd0hhc0NoYW5nZWQocjEsIHIyKSB7CiAgICAgICAgICByZXR1cm4gcjEgIT09IHIyOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIF90aGlzLnN0YXRlID0gewogICAgICAgIGRhdGFTb3VyY2U6IF90aGlzLl9saXN0Vmlld0RhdGFTb3VyY2UuY2xvbmVXaXRoUm93cyhbXSksCiAgICAgICAgbmV3RGV0YWlsSW5mbzogZmFsc2UsCiAgICAgICAgZGV0YWlsUm93SUQ6IG51bGwKICAgICAgfTsKICAgICAgX3RoaXMuX2xpc3RWaWV3SGlnaGxpZ2h0ZWQgPSBmYWxzZTsKICAgICAgX3RoaXMuX2xpc3RWaWV3SGVpZ2h0ID0gMDsKICAgICAgX3RoaXMuX2NhcHR1cmVSZXF1ZXN0TGlzdFZpZXcgPSBfdGhpcy5fY2FwdHVyZVJlcXVlc3RMaXN0Vmlldy5iaW5kKF90aGlzKTsKICAgICAgX3RoaXMuX2NhcHR1cmVEZXRhaWxTY3JvbGxWaWV3ID0gX3RoaXMuX2NhcHR1cmVEZXRhaWxTY3JvbGxWaWV3LmJpbmQoX3RoaXMpOwogICAgICBfdGhpcy5fbGlzdFZpZXdPbkxheW91dCA9IF90aGlzLl9saXN0Vmlld09uTGF5b3V0LmJpbmQoX3RoaXMpOwogICAgICBfdGhpcy5fcmVuZGVyUm93ID0gX3RoaXMuX3JlbmRlclJvdy5iaW5kKF90aGlzKTsKICAgICAgX3RoaXMuX2Nsb3NlQnV0dG9uQ2xpY2tlZCA9IF90aGlzLl9jbG9zZUJ1dHRvbkNsaWNrZWQuYmluZChfdGhpcyk7CiAgICAgIF90aGlzLl9zb2NrZXRJZE1hcCA9IHt9OwogICAgICBfdGhpcy5feGhySWRNYXAgPSB7fTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhOZXR3b3JrT3ZlcmxheSwgW3sKICAgICAga2V5OiAiX2VuYWJsZVhIUkludGVyY2VwdGlvbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfZW5hYmxlWEhSSW50ZXJjZXB0aW9uKCkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICBpZiAoWEhSSW50ZXJjZXB0b3IuaXNJbnRlcmNlcHRvckVuYWJsZWQoKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgWEhSSW50ZXJjZXB0b3Iuc2V0T3BlbkNhbGxiYWNrKGZ1bmN0aW9uIChtZXRob2QsIHVybCwgeGhyKSB7CiAgICAgICAgICB4aHIuX2luZGV4ID0gbmV4dFhIUklkKys7CiAgICAgICAgICB2YXIgeGhySW5kZXggPSBfdGhpczIuX3JlcXVlc3RzLmxlbmd0aDsKICAgICAgICAgIF90aGlzMi5feGhySWRNYXBbeGhyLl9pbmRleF0gPSB4aHJJbmRleDsKICAgICAgICAgIHZhciBfeGhyID0gewogICAgICAgICAgICAndHlwZSc6ICdYTUxIdHRwUmVxdWVzdCcsCiAgICAgICAgICAgICdtZXRob2QnOiBtZXRob2QsCiAgICAgICAgICAgICd1cmwnOiB1cmwKICAgICAgICAgIH07CgogICAgICAgICAgX3RoaXMyLl9yZXF1ZXN0cy5wdXNoKF94aHIpOwoKICAgICAgICAgIF90aGlzMi5fZGV0YWlsVmlld0l0ZW1zLnB1c2goW10pOwoKICAgICAgICAgIF90aGlzMi5fZ2VuRGV0YWlsVmlld0l0ZW0oeGhySW5kZXgpOwoKICAgICAgICAgIF90aGlzMi5zZXRTdGF0ZSh7CiAgICAgICAgICAgIGRhdGFTb3VyY2U6IF90aGlzMi5fbGlzdFZpZXdEYXRhU291cmNlLmNsb25lV2l0aFJvd3MoX3RoaXMyLl9yZXF1ZXN0cykKICAgICAgICAgIH0sIF90aGlzMi5fc2Nyb2xsVG9Cb3R0b20oKSk7CiAgICAgICAgfSk7CiAgICAgICAgWEhSSW50ZXJjZXB0b3Iuc2V0UmVxdWVzdEhlYWRlckNhbGxiYWNrKGZ1bmN0aW9uIChoZWFkZXIsIHZhbHVlLCB4aHIpIHsKICAgICAgICAgIHZhciB4aHJJbmRleCA9IF90aGlzMi5fZ2V0UmVxdWVzdEluZGV4QnlYSFJJRCh4aHIuX2luZGV4KTsKCiAgICAgICAgICBpZiAoeGhySW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgbmV0d29ya0luZm8gPSBfdGhpczIuX3JlcXVlc3RzW3hockluZGV4XTsKCiAgICAgICAgICBpZiAoIW5ldHdvcmtJbmZvLnJlcXVlc3RIZWFkZXJzKSB7CiAgICAgICAgICAgIG5ldHdvcmtJbmZvLnJlcXVlc3RIZWFkZXJzID0ge307CiAgICAgICAgICB9CgogICAgICAgICAgbmV0d29ya0luZm8ucmVxdWVzdEhlYWRlcnNbaGVhZGVyXSA9IHZhbHVlOwoKICAgICAgICAgIF90aGlzMi5fZ2VuRGV0YWlsVmlld0l0ZW0oeGhySW5kZXgpOwogICAgICAgIH0pOwogICAgICAgIFhIUkludGVyY2VwdG9yLnNldFNlbmRDYWxsYmFjayhmdW5jdGlvbiAoZGF0YSwgeGhyKSB7CiAgICAgICAgICB2YXIgeGhySW5kZXggPSBfdGhpczIuX2dldFJlcXVlc3RJbmRleEJ5WEhSSUQoeGhyLl9pbmRleCk7CgogICAgICAgICAgaWYgKHhockluZGV4ID09PSAtMSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgX3RoaXMyLl9yZXF1ZXN0c1t4aHJJbmRleF0uZGF0YVNlbnQgPSBkYXRhOwoKICAgICAgICAgIF90aGlzMi5fZ2VuRGV0YWlsVmlld0l0ZW0oeGhySW5kZXgpOwogICAgICAgIH0pOwogICAgICAgIFhIUkludGVyY2VwdG9yLnNldEhlYWRlclJlY2VpdmVkQ2FsbGJhY2soZnVuY3Rpb24gKHR5cGUsIHNpemUsIHJlc3BvbnNlSGVhZGVycywgeGhyKSB7CiAgICAgICAgICB2YXIgeGhySW5kZXggPSBfdGhpczIuX2dldFJlcXVlc3RJbmRleEJ5WEhSSUQoeGhyLl9pbmRleCk7CgogICAgICAgICAgaWYgKHhockluZGV4ID09PSAtMSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG5ldHdvcmtJbmZvID0gX3RoaXMyLl9yZXF1ZXN0c1t4aHJJbmRleF07CiAgICAgICAgICBuZXR3b3JrSW5mby5yZXNwb25zZUNvbnRlbnRUeXBlID0gdHlwZTsKICAgICAgICAgIG5ldHdvcmtJbmZvLnJlc3BvbnNlU2l6ZSA9IHNpemU7CiAgICAgICAgICBuZXR3b3JrSW5mby5yZXNwb25zZUhlYWRlcnMgPSByZXNwb25zZUhlYWRlcnM7CgogICAgICAgICAgX3RoaXMyLl9nZW5EZXRhaWxWaWV3SXRlbSh4aHJJbmRleCk7CiAgICAgICAgfSk7CiAgICAgICAgWEhSSW50ZXJjZXB0b3Iuc2V0UmVzcG9uc2VDYWxsYmFjayhmdW5jdGlvbiAoc3RhdHVzLCB0aW1lb3V0LCByZXNwb25zZSwgcmVzcG9uc2VVUkwsIHJlc3BvbnNlVHlwZSwgeGhyKSB7CiAgICAgICAgICB2YXIgeGhySW5kZXggPSBfdGhpczIuX2dldFJlcXVlc3RJbmRleEJ5WEhSSUQoeGhyLl9pbmRleCk7CgogICAgICAgICAgaWYgKHhockluZGV4ID09PSAtMSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG5ldHdvcmtJbmZvID0gX3RoaXMyLl9yZXF1ZXN0c1t4aHJJbmRleF07CiAgICAgICAgICBuZXR3b3JrSW5mby5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICBuZXR3b3JrSW5mby50aW1lb3V0ID0gdGltZW91dDsKICAgICAgICAgIG5ldHdvcmtJbmZvLnJlc3BvbnNlID0gcmVzcG9uc2U7CiAgICAgICAgICBuZXR3b3JrSW5mby5yZXNwb25zZVVSTCA9IHJlc3BvbnNlVVJMOwogICAgICAgICAgbmV0d29ya0luZm8ucmVzcG9uc2VUeXBlID0gcmVzcG9uc2VUeXBlOwoKICAgICAgICAgIF90aGlzMi5fZ2VuRGV0YWlsVmlld0l0ZW0oeGhySW5kZXgpOwogICAgICAgIH0pOwogICAgICAgIFhIUkludGVyY2VwdG9yLmVuYWJsZUludGVyY2VwdGlvbigpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9lbmFibGVXZWJTb2NrZXRJbnRlcmNlcHRpb24iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2VuYWJsZVdlYlNvY2tldEludGVyY2VwdGlvbigpIHsKICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgaWYgKFdlYlNvY2tldEludGVyY2VwdG9yLmlzSW50ZXJjZXB0b3JFbmFibGVkKCkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIFdlYlNvY2tldEludGVyY2VwdG9yLnNldENvbm5lY3RDYWxsYmFjayhmdW5jdGlvbiAodXJsLCBwcm90b2NvbHMsIG9wdGlvbnMsIHNvY2tldElkKSB7CiAgICAgICAgICB2YXIgc29ja2V0SW5kZXggPSBfdGhpczMuX3JlcXVlc3RzLmxlbmd0aDsKICAgICAgICAgIF90aGlzMy5fc29ja2V0SWRNYXBbc29ja2V0SWRdID0gc29ja2V0SW5kZXg7CiAgICAgICAgICB2YXIgX3dlYlNvY2tldCA9IHsKICAgICAgICAgICAgJ3R5cGUnOiAnV2ViU29ja2V0JywKICAgICAgICAgICAgJ3VybCc6IHVybCwKICAgICAgICAgICAgJ3Byb3RvY29scyc6IHByb3RvY29scwogICAgICAgICAgfTsKCiAgICAgICAgICBfdGhpczMuX3JlcXVlc3RzLnB1c2goX3dlYlNvY2tldCk7CgogICAgICAgICAgX3RoaXMzLl9kZXRhaWxWaWV3SXRlbXMucHVzaChbXSk7CgogICAgICAgICAgX3RoaXMzLl9nZW5EZXRhaWxWaWV3SXRlbShzb2NrZXRJbmRleCk7CgogICAgICAgICAgX3RoaXMzLnNldFN0YXRlKHsKICAgICAgICAgICAgZGF0YVNvdXJjZTogX3RoaXMzLl9saXN0Vmlld0RhdGFTb3VyY2UuY2xvbmVXaXRoUm93cyhfdGhpczMuX3JlcXVlc3RzKQogICAgICAgICAgfSwgX3RoaXMzLl9zY3JvbGxUb0JvdHRvbSgpKTsKICAgICAgICB9KTsKICAgICAgICBXZWJTb2NrZXRJbnRlcmNlcHRvci5zZXRDbG9zZUNhbGxiYWNrKGZ1bmN0aW9uIChzdGF0dXNDb2RlLCBjbG9zZVJlYXNvbiwgc29ja2V0SWQpIHsKICAgICAgICAgIHZhciBzb2NrZXRJbmRleCA9IF90aGlzMy5fc29ja2V0SWRNYXBbc29ja2V0SWRdOwoKICAgICAgICAgIGlmIChzb2NrZXRJbmRleCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc3RhdHVzQ29kZSAhPT0gbnVsbCAmJiBjbG9zZVJlYXNvbiAhPT0gbnVsbCkgewogICAgICAgICAgICBfdGhpczMuX3JlcXVlc3RzW3NvY2tldEluZGV4XS5zdGF0dXMgPSBzdGF0dXNDb2RlOwogICAgICAgICAgICBfdGhpczMuX3JlcXVlc3RzW3NvY2tldEluZGV4XS5jbG9zZVJlYXNvbiA9IGNsb3NlUmVhc29uOwogICAgICAgICAgfQoKICAgICAgICAgIF90aGlzMy5fZ2VuRGV0YWlsVmlld0l0ZW0oc29ja2V0SW5kZXgpOwogICAgICAgIH0pOwogICAgICAgIFdlYlNvY2tldEludGVyY2VwdG9yLnNldFNlbmRDYWxsYmFjayhmdW5jdGlvbiAoZGF0YSwgc29ja2V0SWQpIHsKICAgICAgICAgIHZhciBzb2NrZXRJbmRleCA9IF90aGlzMy5fc29ja2V0SWRNYXBbc29ja2V0SWRdOwoKICAgICAgICAgIGlmIChzb2NrZXRJbmRleCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIV90aGlzMy5fcmVxdWVzdHNbc29ja2V0SW5kZXhdLm1lc3NhZ2VzKSB7CiAgICAgICAgICAgIF90aGlzMy5fcmVxdWVzdHNbc29ja2V0SW5kZXhdLm1lc3NhZ2VzID0gJyc7CiAgICAgICAgICB9CgogICAgICAgICAgX3RoaXMzLl9yZXF1ZXN0c1tzb2NrZXRJbmRleF0ubWVzc2FnZXMgKz0gJ1NlbnQ6ICcgKyBKU09OLnN0cmluZ2lmeShkYXRhKSArICdcbic7CgogICAgICAgICAgX3RoaXMzLl9nZW5EZXRhaWxWaWV3SXRlbShzb2NrZXRJbmRleCk7CiAgICAgICAgfSk7CiAgICAgICAgV2ViU29ja2V0SW50ZXJjZXB0b3Iuc2V0T25NZXNzYWdlQ2FsbGJhY2soZnVuY3Rpb24gKHNvY2tldElkLCBtZXNzYWdlKSB7CiAgICAgICAgICB2YXIgc29ja2V0SW5kZXggPSBfdGhpczMuX3NvY2tldElkTWFwW3NvY2tldElkXTsKCiAgICAgICAgICBpZiAoc29ja2V0SW5kZXggPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFfdGhpczMuX3JlcXVlc3RzW3NvY2tldEluZGV4XS5tZXNzYWdlcykgewogICAgICAgICAgICBfdGhpczMuX3JlcXVlc3RzW3NvY2tldEluZGV4XS5tZXNzYWdlcyA9ICcnOwogICAgICAgICAgfQoKICAgICAgICAgIF90aGlzMy5fcmVxdWVzdHNbc29ja2V0SW5kZXhdLm1lc3NhZ2VzICs9ICdSZWNlaXZlZDogJyArIEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpICsgJ1xuJzsKCiAgICAgICAgICBfdGhpczMuX2dlbkRldGFpbFZpZXdJdGVtKHNvY2tldEluZGV4KTsKICAgICAgICB9KTsKICAgICAgICBXZWJTb2NrZXRJbnRlcmNlcHRvci5zZXRPbkNsb3NlQ2FsbGJhY2soZnVuY3Rpb24gKHNvY2tldElkLCBtZXNzYWdlKSB7CiAgICAgICAgICB2YXIgc29ja2V0SW5kZXggPSBfdGhpczMuX3NvY2tldElkTWFwW3NvY2tldElkXTsKCiAgICAgICAgICBpZiAoc29ja2V0SW5kZXggPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgX3RoaXMzLl9yZXF1ZXN0c1tzb2NrZXRJbmRleF0uc2VydmVyQ2xvc2UgPSBtZXNzYWdlOwoKICAgICAgICAgIF90aGlzMy5fZ2VuRGV0YWlsVmlld0l0ZW0oc29ja2V0SW5kZXgpOwogICAgICAgIH0pOwogICAgICAgIFdlYlNvY2tldEludGVyY2VwdG9yLnNldE9uRXJyb3JDYWxsYmFjayhmdW5jdGlvbiAoc29ja2V0SWQsIG1lc3NhZ2UpIHsKICAgICAgICAgIHZhciBzb2NrZXRJbmRleCA9IF90aGlzMy5fc29ja2V0SWRNYXBbc29ja2V0SWRdOwoKICAgICAgICAgIGlmIChzb2NrZXRJbmRleCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBfdGhpczMuX3JlcXVlc3RzW3NvY2tldEluZGV4XS5zZXJ2ZXJFcnJvciA9IG1lc3NhZ2U7CgogICAgICAgICAgX3RoaXMzLl9nZW5EZXRhaWxWaWV3SXRlbShzb2NrZXRJbmRleCk7CiAgICAgICAgfSk7CiAgICAgICAgV2ViU29ja2V0SW50ZXJjZXB0b3IuZW5hYmxlSW50ZXJjZXB0aW9uKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY29tcG9uZW50RGlkTW91bnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgICAgdGhpcy5fZW5hYmxlWEhSSW50ZXJjZXB0aW9uKCk7CgogICAgICAgIHRoaXMuX2VuYWJsZVdlYlNvY2tldEludGVyY2VwdGlvbigpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNvbXBvbmVudFdpbGxVbm1vdW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICAgIFhIUkludGVyY2VwdG9yLmRpc2FibGVJbnRlcmNlcHRpb24oKTsKICAgICAgICBXZWJTb2NrZXRJbnRlcmNlcHRvci5kaXNhYmxlSW50ZXJjZXB0aW9uKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX3JlbmRlclJvdyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfcmVuZGVyUm93KHJvd0RhdGEsIHNlY3Rpb25JRCwgcm93SUQsIGhpZ2hsaWdodFJvdykgewogICAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgICB2YXIgdXJsQ2VsbFZpZXdTdHlsZSA9IHN0eWxlcy51cmxFdmVuQ2VsbFZpZXc7CiAgICAgICAgdmFyIG1ldGhvZENlbGxWaWV3U3R5bGUgPSBzdHlsZXMubWV0aG9kRXZlbkNlbGxWaWV3OwoKICAgICAgICBpZiAocm93SUQgJSAyID09PSAxKSB7CiAgICAgICAgICB1cmxDZWxsVmlld1N0eWxlID0gc3R5bGVzLnVybE9kZENlbGxWaWV3OwogICAgICAgICAgbWV0aG9kQ2VsbFZpZXdTdHlsZSA9IHN0eWxlcy5tZXRob2RPZGRDZWxsVmlldzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVG91Y2hhYmxlSGlnaGxpZ2h0LAogICAgICAgICAgewogICAgICAgICAgICBvblByZXNzOiBmdW5jdGlvbiBvblByZXNzKCkgewogICAgICAgICAgICAgIF90aGlzNC5fcHJlc3NSb3cocm93SUQpOwoKICAgICAgICAgICAgICBoaWdobGlnaHRSb3coc2VjdGlvbklELCByb3dJRCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAzMDAKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFZpZXcsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDMwNAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICBWaWV3LAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMudGFibGVSb3csCiAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAzMDUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgICBWaWV3LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBzdHlsZTogdXJsQ2VsbFZpZXdTdHlsZSwKICAgICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDMwNgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICAgICAgVGV4dCwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuY2VsbFRleHQsCiAgICAgICAgICAgICAgICAgICAgbnVtYmVyT2ZMaW5lczogMSwKICAgICAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDMwNwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgcm93RGF0YS51cmwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICApLAogICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgICBWaWV3LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBzdHlsZTogbWV0aG9kQ2VsbFZpZXdTdHlsZSwKICAgICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDMxMQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICAgICAgVGV4dCwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuY2VsbFRleHQsCiAgICAgICAgICAgICAgICAgICAgbnVtYmVyT2ZMaW5lczogMSwKICAgICAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDMxMgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgdGhpcy5fZ2V0VHlwZVNob3J0TmFtZShyb3dEYXRhLnR5cGUpCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgKQogICAgICAgICAgICApCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfcmVuZGVyU2VwZXJhdG9yIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9yZW5kZXJTZXBlcmF0b3Ioc2VjdGlvbklELCByb3dJRCwgYWRqYWNlbnRSb3dIaWdobGlnaHRlZCkgewogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFZpZXcsIHsKICAgICAgICAgIGtleTogc2VjdGlvbklEICsgIi0iICsgcm93SUQsCiAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICBoZWlnaHQ6IGFkamFjZW50Um93SGlnaGxpZ2h0ZWQgPyBTRVBBUkFUT1JfVEhJQ0tORVNTIDogMCwKICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBhZGphY2VudFJvd0hpZ2hsaWdodGVkID8gJyMzQjU5OTgnIDogJyNDQ0NDQ0MnCiAgICAgICAgICB9LAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogMzI3CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX3Njcm9sbFRvQm90dG9tIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9zY3JvbGxUb0JvdHRvbSgpIHsKICAgICAgICBpZiAodGhpcy5fbGlzdFZpZXcpIHsKICAgICAgICAgIHZhciBzY3JvbGxSZXNwb25kZXIgPSB0aGlzLl9saXN0Vmlldy5nZXRTY3JvbGxSZXNwb25kZXIoKTsKCiAgICAgICAgICBpZiAoc2Nyb2xsUmVzcG9uZGVyKSB7CiAgICAgICAgICAgIHZhciBzY3JvbGxZID0gTWF0aC5tYXgodGhpcy5fcmVxdWVzdHMubGVuZ3RoICogTElTVFZJRVdfQ0VMTF9IRUlHSFQgKyAodGhpcy5fbGlzdFZpZXdIaWdobGlnaHRlZCA/IDIgKiBTRVBBUkFUT1JfVEhJQ0tORVNTIDogMCkgLSB0aGlzLl9saXN0Vmlld0hlaWdodCwgMCk7CiAgICAgICAgICAgIHNjcm9sbFJlc3BvbmRlci5zY3JvbGxSZXNwb25kZXJTY3JvbGxUbyh7CiAgICAgICAgICAgICAgeDogMCwKICAgICAgICAgICAgICB5OiBzY3JvbGxZLAogICAgICAgICAgICAgIGFuaW1hdGVkOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfY2FwdHVyZVJlcXVlc3RMaXN0VmlldyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfY2FwdHVyZVJlcXVlc3RMaXN0VmlldyhsaXN0UmVmKSB7CiAgICAgICAgdGhpcy5fbGlzdFZpZXcgPSBsaXN0UmVmOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9saXN0Vmlld09uTGF5b3V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9saXN0Vmlld09uTGF5b3V0KGV2ZW50KSB7CiAgICAgICAgdmFyIGhlaWdodCA9IGV2ZW50Lm5hdGl2ZUV2ZW50LmxheW91dC5oZWlnaHQ7CiAgICAgICAgdGhpcy5fbGlzdFZpZXdIZWlnaHQgPSBoZWlnaHQ7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX3ByZXNzUm93IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9wcmVzc1Jvdyhyb3dJRCkgewogICAgICAgIHRoaXMuX2xpc3RWaWV3SGlnaGxpZ2h0ZWQgPSB0cnVlOwogICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgZGV0YWlsUm93SUQ6IHJvd0lECiAgICAgICAgfSwgdGhpcy5fc2Nyb2xsVG9Ub3AoKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX3Njcm9sbFRvVG9wIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9zY3JvbGxUb1RvcCgpIHsKICAgICAgICBpZiAodGhpcy5fc2Nyb2xsVmlldykgewogICAgICAgICAgdGhpcy5fc2Nyb2xsVmlldy5zY3JvbGxUbyh7CiAgICAgICAgICAgIHk6IDAsCiAgICAgICAgICAgIGFuaW1hdGVkOiBmYWxzZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9jYXB0dXJlRGV0YWlsU2Nyb2xsVmlldyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfY2FwdHVyZURldGFpbFNjcm9sbFZpZXcoc2Nyb2xsUmVmKSB7CiAgICAgICAgdGhpcy5fc2Nyb2xsVmlldyA9IHNjcm9sbFJlZjsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfY2xvc2VCdXR0b25DbGlja2VkIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9jbG9zZUJ1dHRvbkNsaWNrZWQoKSB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICBkZXRhaWxSb3dJRDogbnVsbAogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9nZXRTdHJpbmdCeVZhbHVlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRTdHJpbmdCeVZhbHVlKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiAndW5kZWZpbmVkJzsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgJiYgdmFsdWUubGVuZ3RoID4gNTAwKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS5zdWJzdHIoMCwgNTAwKS5jb25jYXQoJ1xuKioqVFJVTkNBVEVEIFRPIDUwMCBDSEFSQUNURVJTKioqJyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX2dldFJlcXVlc3RJbmRleEJ5WEhSSUQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2dldFJlcXVlc3RJbmRleEJ5WEhSSUQoaW5kZXgpIHsKICAgICAgICBpZiAoaW5kZXggPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KCiAgICAgICAgdmFyIHhockluZGV4ID0gdGhpcy5feGhySWRNYXBbaW5kZXhdOwoKICAgICAgICBpZiAoeGhySW5kZXggPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4geGhySW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9nZXRUeXBlU2hvcnROYW1lIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRUeXBlU2hvcnROYW1lKHR5cGUpIHsKICAgICAgICBpZiAodHlwZSA9PT0gJ1hNTEh0dHBSZXF1ZXN0JykgewogICAgICAgICAgcmV0dXJuICdYSFInOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ1dlYlNvY2tldCcpIHsKICAgICAgICAgIHJldHVybiAnV1MnOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9nZW5EZXRhaWxWaWV3SXRlbSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2VuRGV0YWlsVmlld0l0ZW0oaW5kZXgpIHsKICAgICAgICB0aGlzLl9kZXRhaWxWaWV3SXRlbXNbaW5kZXhdID0gW107CiAgICAgICAgdmFyIGRldGFpbFZpZXdJdGVtID0gdGhpcy5fZGV0YWlsVmlld0l0ZW1zW2luZGV4XTsKICAgICAgICB2YXIgcmVxdWVzdEl0ZW0gPSB0aGlzLl9yZXF1ZXN0c1tpbmRleF07CgogICAgICAgIGZvciAodmFyIF9rZXkgaW4gcmVxdWVzdEl0ZW0pIHsKICAgICAgICAgIGRldGFpbFZpZXdJdGVtLnB1c2goUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuZGV0YWlsVmlld1JvdywKICAgICAgICAgICAgICBrZXk6IF9rZXksCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA0NDIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgVGV4dCwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdHlsZTogW3N0eWxlcy5kZXRhaWxWaWV3VGV4dCwgc3R5bGVzLmRldGFpbEtleUNlbGxWaWV3XSwKICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQ0MwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2tleQogICAgICAgICAgICApLAogICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3R5bGU6IFtzdHlsZXMuZGV0YWlsVmlld1RleHQsIHN0eWxlcy5kZXRhaWxWYWx1ZUNlbGxWaWV3XSwKICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQ0NgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdGhpcy5fZ2V0U3RyaW5nQnlWYWx1ZShyZXF1ZXN0SXRlbVtfa2V5XSkKICAgICAgICAgICAgKQogICAgICAgICAgKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5zdGF0ZS5kZXRhaWxSb3dJRCAhPSBudWxsICYmIE51bWJlcih0aGlzLnN0YXRlLmRldGFpbFJvd0lEKSA9PT0gaW5kZXgpIHsKICAgICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgICBuZXdEZXRhaWxJbmZvOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgIFZpZXcsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuY29udGFpbmVyLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNDYxCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICB0aGlzLnN0YXRlLmRldGFpbFJvd0lEICE9IG51bGwgJiYgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVG91Y2hhYmxlSGlnaGxpZ2h0LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5jbG9zZUJ1dHRvbiwKICAgICAgICAgICAgICBvblByZXNzOiB0aGlzLl9jbG9zZUJ1dHRvbkNsaWNrZWQsCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA0NjMKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA0NjYKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgICBUZXh0LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmNsb3N0QnV0dG9uVGV4dCwKICAgICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQ2NwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInYiCiAgICAgICAgICAgICAgKQogICAgICAgICAgICApCiAgICAgICAgICApLAogICAgICAgICAgdGhpcy5zdGF0ZS5kZXRhaWxSb3dJRCAhPSBudWxsICYmIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFNjcm9sbFZpZXcsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmRldGFpbFNjcm9sbFZpZXcsCiAgICAgICAgICAgICAgcmVmOiB0aGlzLl9jYXB0dXJlRGV0YWlsU2Nyb2xsVmlldywKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQ3MQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdGhpcy5fZGV0YWlsVmlld0l0ZW1zW3RoaXMuc3RhdGUuZGV0YWlsUm93SURdCiAgICAgICAgICApLAogICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMubGlzdFZpZXdUaXRsZSwKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQ3NgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID4gMCAmJiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgIFZpZXcsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy50YWJsZVJvdywKICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQ3OAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICAgIFZpZXcsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMudXJsVGl0bGVDZWxsVmlldywKICAgICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQ3OQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICAgICAgVGV4dCwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuY2VsbFRleHQsCiAgICAgICAgICAgICAgICAgICAgbnVtYmVyT2ZMaW5lczogMSwKICAgICAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQ4MAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgIlVSTCIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICApLAogICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgICBWaWV3LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLm1ldGhvZFRpdGxlQ2VsbFZpZXcsCiAgICAgICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA0ODIKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmNlbGxUZXh0LAogICAgICAgICAgICAgICAgICAgIG51bWJlck9mTGluZXM6IDEsCiAgICAgICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA0ODMKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICJUeXBlIgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICkKICAgICAgICAgICAgKQogICAgICAgICAgKSwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoTGlzdFZpZXcsIHsKICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5saXN0VmlldywKICAgICAgICAgICAgcmVmOiB0aGlzLl9jYXB0dXJlUmVxdWVzdExpc3RWaWV3LAogICAgICAgICAgICBkYXRhU291cmNlOiB0aGlzLnN0YXRlLmRhdGFTb3VyY2UsCiAgICAgICAgICAgIHJlbmRlclJvdzogdGhpcy5fcmVuZGVyUm93LAogICAgICAgICAgICBlbmFibGVFbXB0eVNlY3Rpb25zOiB0cnVlLAogICAgICAgICAgICByZW5kZXJTZXBhcmF0b3I6IHRoaXMuX3JlbmRlclNlcGVyYXRvciwKICAgICAgICAgICAgb25MYXlvdXQ6IHRoaXMuX2xpc3RWaWV3T25MYXlvdXQsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA0ODcKICAgICAgICAgICAgfQogICAgICAgICAgfSkKICAgICAgICApOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gTmV0d29ya092ZXJsYXk7CiAgfShSZWFjdC5Db21wb25lbnQpOwoKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgY29udGFpbmVyOiB7CiAgICAgIHBhZGRpbmdUb3A6IDEwLAogICAgICBwYWRkaW5nQm90dG9tOiAxMCwKICAgICAgcGFkZGluZ0xlZnQ6IDUsCiAgICAgIHBhZGRpbmdSaWdodDogNQogICAgfSwKICAgIGxpc3RWaWV3VGl0bGU6IHsKICAgICAgaGVpZ2h0OiAyMAogICAgfSwKICAgIGxpc3RWaWV3OiB7CiAgICAgIGZsZXg6IDEsCiAgICAgIGhlaWdodDogNjAKICAgIH0sCiAgICB0YWJsZVJvdzogewogICAgICBmbGV4RGlyZWN0aW9uOiAncm93JywKICAgICAgZmxleDogMQogICAgfSwKICAgIGNlbGxUZXh0OiB7CiAgICAgIGNvbG9yOiAnd2hpdGUnLAogICAgICBmb250U2l6ZTogMTIKICAgIH0sCiAgICBtZXRob2RUaXRsZUNlbGxWaWV3OiB7CiAgICAgIGhlaWdodDogMTgsCiAgICAgIGJvcmRlckNvbG9yOiAnI0RDRDdDRCcsCiAgICAgIGJvcmRlclRvcFdpZHRoOiAxLAogICAgICBib3JkZXJCb3R0b21XaWR0aDogMSwKICAgICAgYm9yZGVyUmlnaHRXaWR0aDogMSwKICAgICAgYWxpZ25JdGVtczogJ2NlbnRlcicsCiAgICAgIGp1c3RpZnlDb250ZW50OiAnY2VudGVyJywKICAgICAgYmFja2dyb3VuZENvbG9yOiAnIzQ0NCcsCiAgICAgIGZsZXg6IDEKICAgIH0sCiAgICB1cmxUaXRsZUNlbGxWaWV3OiB7CiAgICAgIGhlaWdodDogMTgsCiAgICAgIGJvcmRlckNvbG9yOiAnI0RDRDdDRCcsCiAgICAgIGJvcmRlclRvcFdpZHRoOiAxLAogICAgICBib3JkZXJCb3R0b21XaWR0aDogMSwKICAgICAgYm9yZGVyTGVmdFdpZHRoOiAxLAogICAgICBib3JkZXJSaWdodFdpZHRoOiAxLAogICAgICBqdXN0aWZ5Q29udGVudDogJ2NlbnRlcicsCiAgICAgIGJhY2tncm91bmRDb2xvcjogJyM0NDQnLAogICAgICBmbGV4OiA1LAogICAgICBwYWRkaW5nTGVmdDogMwogICAgfSwKICAgIG1ldGhvZE9kZENlbGxWaWV3OiB7CiAgICAgIGhlaWdodDogMTUsCiAgICAgIGJvcmRlckNvbG9yOiAnI0RDRDdDRCcsCiAgICAgIGJvcmRlclJpZ2h0V2lkdGg6IDEsCiAgICAgIGFsaWduSXRlbXM6ICdjZW50ZXInLAogICAgICBqdXN0aWZ5Q29udGVudDogJ2NlbnRlcicsCiAgICAgIGJhY2tncm91bmRDb2xvcjogJyMwMDAnLAogICAgICBmbGV4OiAxCiAgICB9LAogICAgdXJsT2RkQ2VsbFZpZXc6IHsKICAgICAgaGVpZ2h0OiAxNSwKICAgICAgYm9yZGVyQ29sb3I6ICcjRENEN0NEJywKICAgICAgYm9yZGVyTGVmdFdpZHRoOiAxLAogICAgICBib3JkZXJSaWdodFdpZHRoOiAxLAogICAgICBqdXN0aWZ5Q29udGVudDogJ2NlbnRlcicsCiAgICAgIGJhY2tncm91bmRDb2xvcjogJyMwMDAnLAogICAgICBmbGV4OiA1LAogICAgICBwYWRkaW5nTGVmdDogMwogICAgfSwKICAgIG1ldGhvZEV2ZW5DZWxsVmlldzogewogICAgICBoZWlnaHQ6IDE1LAogICAgICBib3JkZXJDb2xvcjogJyNEQ0Q3Q0QnLAogICAgICBib3JkZXJSaWdodFdpZHRoOiAxLAogICAgICBhbGlnbkl0ZW1zOiAnY2VudGVyJywKICAgICAganVzdGlmeUNvbnRlbnQ6ICdjZW50ZXInLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6ICcjODg4JywKICAgICAgZmxleDogMQogICAgfSwKICAgIHVybEV2ZW5DZWxsVmlldzogewogICAgICBoZWlnaHQ6IDE1LAogICAgICBib3JkZXJDb2xvcjogJyNEQ0Q3Q0QnLAogICAgICBib3JkZXJMZWZ0V2lkdGg6IDEsCiAgICAgIGJvcmRlclJpZ2h0V2lkdGg6IDEsCiAgICAgIGp1c3RpZnlDb250ZW50OiAnY2VudGVyJywKICAgICAgYmFja2dyb3VuZENvbG9yOiAnIzg4OCcsCiAgICAgIGZsZXg6IDUsCiAgICAgIHBhZGRpbmdMZWZ0OiAzCiAgICB9LAogICAgZGV0YWlsU2Nyb2xsVmlldzogewogICAgICBmbGV4OiAxLAogICAgICBoZWlnaHQ6IDE4MCwKICAgICAgbWFyZ2luVG9wOiA1LAogICAgICBtYXJnaW5Cb3R0b206IDUKICAgIH0sCiAgICBkZXRhaWxLZXlDZWxsVmlldzogewogICAgICBmbGV4OiAxLjMKICAgIH0sCiAgICBkZXRhaWxWYWx1ZUNlbGxWaWV3OiB7CiAgICAgIGZsZXg6IDIKICAgIH0sCiAgICBkZXRhaWxWaWV3Um93OiB7CiAgICAgIGZsZXhEaXJlY3Rpb246ICdyb3cnLAogICAgICBwYWRkaW5nSG9yaXpvbnRhbDogMwogICAgfSwKICAgIGRldGFpbFZpZXdUZXh0OiB7CiAgICAgIGNvbG9yOiAnd2hpdGUnLAogICAgICBmb250U2l6ZTogMTEKICAgIH0sCiAgICBjbG9zdEJ1dHRvblRleHQ6IHsKICAgICAgY29sb3I6ICd3aGl0ZScsCiAgICAgIGZvbnRTaXplOiAxMAogICAgfSwKICAgIGNsb3NlQnV0dG9uOiB7CiAgICAgIG1hcmdpblRvcDogNSwKICAgICAgYmFja2dyb3VuZENvbG9yOiAnIzg4OCcsCiAgICAgIGp1c3RpZnlDb250ZW50OiAnY2VudGVyJywKICAgICAgYWxpZ25JdGVtczogJ2NlbnRlcicKICAgIH0KICB9KTsKICBtb2R1bGUuZXhwb3J0cyA9IE5ldHdvcmtPdmVybGF5Owp9LDI3NCxbMjQxLDEzMCwyMjQsMTY4LDE4MSwyNzEsMTcwLDI3NSwyNzZdLCJOZXR3b3JrT3ZlcmxheSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFJDVFdlYlNvY2tldE1vZHVsZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIikuV2ViU29ja2V0TW9kdWxlOwoKICB2YXIgTmF0aXZlRXZlbnRFbWl0dGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIk5hdGl2ZUV2ZW50RW1pdHRlciIpOwoKICB2YXIgYmFzZTY0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgImJhc2U2NC1qcyIpOwoKICB2YXIgb3JpZ2luYWxSQ1RXZWJTb2NrZXRDb25uZWN0ID0gUkNUV2ViU29ja2V0TW9kdWxlLmNvbm5lY3Q7CiAgdmFyIG9yaWdpbmFsUkNUV2ViU29ja2V0U2VuZCA9IFJDVFdlYlNvY2tldE1vZHVsZS5zZW5kOwogIHZhciBvcmlnaW5hbFJDVFdlYlNvY2tldFNlbmRCaW5hcnkgPSBSQ1RXZWJTb2NrZXRNb2R1bGUuc2VuZEJpbmFyeTsKICB2YXIgb3JpZ2luYWxSQ1RXZWJTb2NrZXRDbG9zZSA9IFJDVFdlYlNvY2tldE1vZHVsZS5jbG9zZTsKICB2YXIgZXZlbnRFbWl0dGVyID0gdm9pZCAwOwogIHZhciBzdWJzY3JpcHRpb25zID0gdm9pZCAwOwogIHZhciBjbG9zZUNhbGxiYWNrID0gdm9pZCAwOwogIHZhciBzZW5kQ2FsbGJhY2sgPSB2b2lkIDA7CiAgdmFyIGNvbm5lY3RDYWxsYmFjayA9IHZvaWQgMDsKICB2YXIgb25PcGVuQ2FsbGJhY2sgPSB2b2lkIDA7CiAgdmFyIG9uTWVzc2FnZUNhbGxiYWNrID0gdm9pZCAwOwogIHZhciBvbkVycm9yQ2FsbGJhY2sgPSB2b2lkIDA7CiAgdmFyIG9uQ2xvc2VDYWxsYmFjayA9IHZvaWQgMDsKICB2YXIgX2lzSW50ZXJjZXB0b3JFbmFibGVkID0gZmFsc2U7CiAgdmFyIFdlYlNvY2tldEludGVyY2VwdG9yID0gewogICAgc2V0Q2xvc2VDYWxsYmFjazogZnVuY3Rpb24gc2V0Q2xvc2VDYWxsYmFjayhjYWxsYmFjaykgewogICAgICBjbG9zZUNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgc2V0U2VuZENhbGxiYWNrOiBmdW5jdGlvbiBzZXRTZW5kQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgc2VuZENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgc2V0Q29ubmVjdENhbGxiYWNrOiBmdW5jdGlvbiBzZXRDb25uZWN0Q2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgY29ubmVjdENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgc2V0T25PcGVuQ2FsbGJhY2s6IGZ1bmN0aW9uIHNldE9uT3BlbkNhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgIG9uT3BlbkNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgc2V0T25NZXNzYWdlQ2FsbGJhY2s6IGZ1bmN0aW9uIHNldE9uTWVzc2FnZUNhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgIG9uTWVzc2FnZUNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgc2V0T25FcnJvckNhbGxiYWNrOiBmdW5jdGlvbiBzZXRPbkVycm9yQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgb25FcnJvckNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgc2V0T25DbG9zZUNhbGxiYWNrOiBmdW5jdGlvbiBzZXRPbkNsb3NlQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgb25DbG9zZUNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgaXNJbnRlcmNlcHRvckVuYWJsZWQ6IGZ1bmN0aW9uIGlzSW50ZXJjZXB0b3JFbmFibGVkKCkgewogICAgICByZXR1cm4gX2lzSW50ZXJjZXB0b3JFbmFibGVkOwogICAgfSwKICAgIF91bnJlZ2lzdGVyRXZlbnRzOiBmdW5jdGlvbiBfdW5yZWdpc3RlckV2ZW50cygpIHsKICAgICAgc3Vic2NyaXB0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcmV0dXJuIGUucmVtb3ZlKCk7CiAgICAgIH0pOwogICAgICBzdWJzY3JpcHRpb25zID0gW107CiAgICB9LAogICAgX3JlZ2lzdGVyRXZlbnRzOiBmdW5jdGlvbiBfcmVnaXN0ZXJFdmVudHMoKSB7CiAgICAgIHN1YnNjcmlwdGlvbnMgPSBbZXZlbnRFbWl0dGVyLmFkZExpc3RlbmVyKCd3ZWJzb2NrZXRNZXNzYWdlJywgZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgaWYgKG9uTWVzc2FnZUNhbGxiYWNrKSB7CiAgICAgICAgICBvbk1lc3NhZ2VDYWxsYmFjayhldi5pZCwgZXYudHlwZSA9PT0gJ2JpbmFyeScgPyBXZWJTb2NrZXRJbnRlcmNlcHRvci5fYXJyYXlCdWZmZXJUb1N0cmluZyhldi5kYXRhKSA6IGV2LmRhdGEpOwogICAgICAgIH0KICAgICAgfSksIGV2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcignd2Vic29ja2V0T3BlbicsIGZ1bmN0aW9uIChldikgewogICAgICAgIGlmIChvbk9wZW5DYWxsYmFjaykgewogICAgICAgICAgb25PcGVuQ2FsbGJhY2soZXYuaWQpOwogICAgICAgIH0KICAgICAgfSksIGV2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcignd2Vic29ja2V0Q2xvc2VkJywgZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgaWYgKG9uQ2xvc2VDYWxsYmFjaykgewogICAgICAgICAgb25DbG9zZUNhbGxiYWNrKGV2LmlkLCB7CiAgICAgICAgICAgIGNvZGU6IGV2LmNvZGUsCiAgICAgICAgICAgIHJlYXNvbjogZXYucmVhc29uCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pLCBldmVudEVtaXR0ZXIuYWRkTGlzdGVuZXIoJ3dlYnNvY2tldEZhaWxlZCcsIGZ1bmN0aW9uIChldikgewogICAgICAgIGlmIChvbkVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgIG9uRXJyb3JDYWxsYmFjayhldi5pZCwgewogICAgICAgICAgICBtZXNzYWdlOiBldi5tZXNzYWdlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pXTsKICAgIH0sCiAgICBlbmFibGVJbnRlcmNlcHRpb246IGZ1bmN0aW9uIGVuYWJsZUludGVyY2VwdGlvbigpIHsKICAgICAgaWYgKF9pc0ludGVyY2VwdG9yRW5hYmxlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgZXZlbnRFbWl0dGVyID0gbmV3IE5hdGl2ZUV2ZW50RW1pdHRlcihSQ1RXZWJTb2NrZXRNb2R1bGUpOwoKICAgICAgV2ViU29ja2V0SW50ZXJjZXB0b3IuX3JlZ2lzdGVyRXZlbnRzKCk7CgogICAgICBSQ1RXZWJTb2NrZXRNb2R1bGUuY29ubmVjdCA9IGZ1bmN0aW9uICh1cmwsIHByb3RvY29scywgb3B0aW9ucywgc29ja2V0SWQpIHsKICAgICAgICBpZiAoY29ubmVjdENhbGxiYWNrKSB7CiAgICAgICAgICBjb25uZWN0Q2FsbGJhY2sodXJsLCBwcm90b2NvbHMsIG9wdGlvbnMsIHNvY2tldElkKTsKICAgICAgICB9CgogICAgICAgIG9yaWdpbmFsUkNUV2ViU29ja2V0Q29ubmVjdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwoKICAgICAgUkNUV2ViU29ja2V0TW9kdWxlLnNlbmQgPSBmdW5jdGlvbiAoZGF0YSwgc29ja2V0SWQpIHsKICAgICAgICBpZiAoc2VuZENhbGxiYWNrKSB7CiAgICAgICAgICBzZW5kQ2FsbGJhY2soZGF0YSwgc29ja2V0SWQpOwogICAgICAgIH0KCiAgICAgICAgb3JpZ2luYWxSQ1RXZWJTb2NrZXRTZW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CgogICAgICBSQ1RXZWJTb2NrZXRNb2R1bGUuc2VuZEJpbmFyeSA9IGZ1bmN0aW9uIChkYXRhLCBzb2NrZXRJZCkgewogICAgICAgIGlmIChzZW5kQ2FsbGJhY2spIHsKICAgICAgICAgIHNlbmRDYWxsYmFjayhXZWJTb2NrZXRJbnRlcmNlcHRvci5fYXJyYXlCdWZmZXJUb1N0cmluZyhkYXRhKSwgc29ja2V0SWQpOwogICAgICAgIH0KCiAgICAgICAgb3JpZ2luYWxSQ1RXZWJTb2NrZXRTZW5kQmluYXJ5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CgogICAgICBSQ1RXZWJTb2NrZXRNb2R1bGUuY2xvc2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGNsb3NlQ2FsbGJhY2spIHsKICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAzKSB7CiAgICAgICAgICAgIGNsb3NlQ2FsbGJhY2soYXJndW1lbnRzWzBdLCBhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjbG9zZUNhbGxiYWNrKG51bGwsIG51bGwsIGFyZ3VtZW50c1swXSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBvcmlnaW5hbFJDVFdlYlNvY2tldENsb3NlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CgogICAgICBfaXNJbnRlcmNlcHRvckVuYWJsZWQgPSB0cnVlOwogICAgfSwKICAgIF9hcnJheUJ1ZmZlclRvU3RyaW5nOiBmdW5jdGlvbiBfYXJyYXlCdWZmZXJUb1N0cmluZyhkYXRhKSB7CiAgICAgIHZhciB2YWx1ZSA9IGJhc2U2NC50b0J5dGVBcnJheShkYXRhKS5idWZmZXI7CgogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiAnKG5vIHZhbHVlKSc7CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBVaW50OEFycmF5ICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICAgICAgcmV0dXJuICJBcnJheUJ1ZmZlciB7IiArIFN0cmluZyhBcnJheS5mcm9tKG5ldyBVaW50OEFycmF5KHZhbHVlKSkpICsgIn0iOwogICAgICB9CgogICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAogICAgZGlzYWJsZUludGVyY2VwdGlvbjogZnVuY3Rpb24gZGlzYWJsZUludGVyY2VwdGlvbigpIHsKICAgICAgaWYgKCFfaXNJbnRlcmNlcHRvckVuYWJsZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIF9pc0ludGVyY2VwdG9yRW5hYmxlZCA9IGZhbHNlOwogICAgICBSQ1RXZWJTb2NrZXRNb2R1bGUuc2VuZCA9IG9yaWdpbmFsUkNUV2ViU29ja2V0U2VuZDsKICAgICAgUkNUV2ViU29ja2V0TW9kdWxlLnNlbmRCaW5hcnkgPSBvcmlnaW5hbFJDVFdlYlNvY2tldFNlbmRCaW5hcnk7CiAgICAgIFJDVFdlYlNvY2tldE1vZHVsZS5jbG9zZSA9IG9yaWdpbmFsUkNUV2ViU29ja2V0Q2xvc2U7CiAgICAgIFJDVFdlYlNvY2tldE1vZHVsZS5jb25uZWN0ID0gb3JpZ2luYWxSQ1RXZWJTb2NrZXRDb25uZWN0OwogICAgICBjb25uZWN0Q2FsbGJhY2sgPSBudWxsOwogICAgICBjbG9zZUNhbGxiYWNrID0gbnVsbDsKICAgICAgc2VuZENhbGxiYWNrID0gbnVsbDsKICAgICAgb25PcGVuQ2FsbGJhY2sgPSBudWxsOwogICAgICBvbk1lc3NhZ2VDYWxsYmFjayA9IG51bGw7CiAgICAgIG9uQ2xvc2VDYWxsYmFjayA9IG51bGw7CiAgICAgIG9uRXJyb3JDYWxsYmFjayA9IG51bGw7CgogICAgICBXZWJTb2NrZXRJbnRlcmNlcHRvci5fdW5yZWdpc3RlckV2ZW50cygpOwogICAgfQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBXZWJTb2NrZXRJbnRlcmNlcHRvcjsKfSwyNzUsWzE1LDY5LDczXSwiV2ViU29ja2V0SW50ZXJjZXB0b3IiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBYTUxIdHRwUmVxdWVzdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJYTUxIdHRwUmVxdWVzdCIpOwoKICB2YXIgb3JpZ2luYWxYSFJPcGVuID0gWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlLm9wZW47CiAgdmFyIG9yaWdpbmFsWEhSU2VuZCA9IFhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5zZW5kOwogIHZhciBvcmlnaW5hbFhIUlNldFJlcXVlc3RIZWFkZXIgPSBYTUxIdHRwUmVxdWVzdC5wcm90b3R5cGUuc2V0UmVxdWVzdEhlYWRlcjsKICB2YXIgb3BlbkNhbGxiYWNrOwogIHZhciBzZW5kQ2FsbGJhY2s7CiAgdmFyIHJlcXVlc3RIZWFkZXJDYWxsYmFjazsKICB2YXIgaGVhZGVyUmVjZWl2ZWRDYWxsYmFjazsKICB2YXIgcmVzcG9uc2VDYWxsYmFjazsKICB2YXIgX2lzSW50ZXJjZXB0b3JFbmFibGVkID0gZmFsc2U7CiAgdmFyIFhIUkludGVyY2VwdG9yID0gewogICAgc2V0T3BlbkNhbGxiYWNrOiBmdW5jdGlvbiBzZXRPcGVuQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgb3BlbkNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgc2V0U2VuZENhbGxiYWNrOiBmdW5jdGlvbiBzZXRTZW5kQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgc2VuZENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgc2V0SGVhZGVyUmVjZWl2ZWRDYWxsYmFjazogZnVuY3Rpb24gc2V0SGVhZGVyUmVjZWl2ZWRDYWxsYmFjayhjYWxsYmFjaykgewogICAgICBoZWFkZXJSZWNlaXZlZENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgc2V0UmVzcG9uc2VDYWxsYmFjazogZnVuY3Rpb24gc2V0UmVzcG9uc2VDYWxsYmFjayhjYWxsYmFjaykgewogICAgICByZXNwb25zZUNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgc2V0UmVxdWVzdEhlYWRlckNhbGxiYWNrOiBmdW5jdGlvbiBzZXRSZXF1ZXN0SGVhZGVyQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgcmVxdWVzdEhlYWRlckNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB9LAogICAgaXNJbnRlcmNlcHRvckVuYWJsZWQ6IGZ1bmN0aW9uIGlzSW50ZXJjZXB0b3JFbmFibGVkKCkgewogICAgICByZXR1cm4gX2lzSW50ZXJjZXB0b3JFbmFibGVkOwogICAgfSwKICAgIGVuYWJsZUludGVyY2VwdGlvbjogZnVuY3Rpb24gZW5hYmxlSW50ZXJjZXB0aW9uKCkgewogICAgICBpZiAoX2lzSW50ZXJjZXB0b3JFbmFibGVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBYTUxIdHRwUmVxdWVzdC5wcm90b3R5cGUub3BlbiA9IGZ1bmN0aW9uIChtZXRob2QsIHVybCkgewogICAgICAgIGlmIChvcGVuQ2FsbGJhY2spIHsKICAgICAgICAgIG9wZW5DYWxsYmFjayhtZXRob2QsIHVybCwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICBvcmlnaW5hbFhIUk9wZW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKCiAgICAgIFhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5zZXRSZXF1ZXN0SGVhZGVyID0gZnVuY3Rpb24gKGhlYWRlciwgdmFsdWUpIHsKICAgICAgICBpZiAocmVxdWVzdEhlYWRlckNhbGxiYWNrKSB7CiAgICAgICAgICByZXF1ZXN0SGVhZGVyQ2FsbGJhY2soaGVhZGVyLCB2YWx1ZSwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICBvcmlnaW5hbFhIUlNldFJlcXVlc3RIZWFkZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKCiAgICAgIFhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICBpZiAoc2VuZENhbGxiYWNrKSB7CiAgICAgICAgICBzZW5kQ2FsbGJhY2soZGF0YSwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghX2lzSW50ZXJjZXB0b3JFbmFibGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX3RoaXMucmVhZHlTdGF0ZSA9PT0gX3RoaXMuSEVBREVSU19SRUNFSVZFRCkgewogICAgICAgICAgICAgIHZhciBjb250ZW50VHlwZVN0cmluZyA9IF90aGlzLmdldFJlc3BvbnNlSGVhZGVyKCdDb250ZW50LVR5cGUnKTsKCiAgICAgICAgICAgICAgdmFyIGNvbnRlbnRMZW5ndGhTdHJpbmcgPSBfdGhpcy5nZXRSZXNwb25zZUhlYWRlcignQ29udGVudC1MZW5ndGgnKTsKCiAgICAgICAgICAgICAgdmFyIHJlc3BvbnNlQ29udGVudFR5cGUgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlU2l6ZSA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgaWYgKGNvbnRlbnRUeXBlU3RyaW5nKSB7CiAgICAgICAgICAgICAgICByZXNwb25zZUNvbnRlbnRUeXBlID0gY29udGVudFR5cGVTdHJpbmcuc3BsaXQoJzsnKVswXTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChjb250ZW50TGVuZ3RoU3RyaW5nKSB7CiAgICAgICAgICAgICAgICByZXNwb25zZVNpemUgPSBwYXJzZUludChjb250ZW50TGVuZ3RoU3RyaW5nLCAxMCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoaGVhZGVyUmVjZWl2ZWRDYWxsYmFjaykgewogICAgICAgICAgICAgICAgaGVhZGVyUmVjZWl2ZWRDYWxsYmFjayhyZXNwb25zZUNvbnRlbnRUeXBlLCByZXNwb25zZVNpemUsIF90aGlzLmdldEFsbFJlc3BvbnNlSGVhZGVycygpLCBfdGhpcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoX3RoaXMucmVhZHlTdGF0ZSA9PT0gX3RoaXMuRE9ORSkgewogICAgICAgICAgICAgIGlmIChyZXNwb25zZUNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICByZXNwb25zZUNhbGxiYWNrKF90aGlzLnN0YXR1cywgX3RoaXMudGltZW91dCwgX3RoaXMucmVzcG9uc2UsIF90aGlzLnJlc3BvbnNlVVJMLCBfdGhpcy5yZXNwb25zZVR5cGUsIF90aGlzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIG9yaWdpbmFsWEhSU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwoKICAgICAgX2lzSW50ZXJjZXB0b3JFbmFibGVkID0gdHJ1ZTsKICAgIH0sCiAgICBkaXNhYmxlSW50ZXJjZXB0aW9uOiBmdW5jdGlvbiBkaXNhYmxlSW50ZXJjZXB0aW9uKCkgewogICAgICBpZiAoIV9pc0ludGVyY2VwdG9yRW5hYmxlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgX2lzSW50ZXJjZXB0b3JFbmFibGVkID0gZmFsc2U7CiAgICAgIFhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5zZW5kID0gb3JpZ2luYWxYSFJTZW5kOwogICAgICBYTUxIdHRwUmVxdWVzdC5wcm90b3R5cGUub3BlbiA9IG9yaWdpbmFsWEhST3BlbjsKICAgICAgWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlLnNldFJlcXVlc3RIZWFkZXIgPSBvcmlnaW5hbFhIUlNldFJlcXVlc3RIZWFkZXI7CiAgICAgIHJlc3BvbnNlQ2FsbGJhY2sgPSBudWxsOwogICAgICBvcGVuQ2FsbGJhY2sgPSBudWxsOwogICAgICBzZW5kQ2FsbGJhY2sgPSBudWxsOwogICAgICBoZWFkZXJSZWNlaXZlZENhbGxiYWNrID0gbnVsbDsKICAgICAgcmVxdWVzdEhlYWRlckNhbGxiYWNrID0gbnVsbDsKICAgIH0KICB9OwogIG1vZHVsZS5leHBvcnRzID0gWEhSSW50ZXJjZXB0b3I7Cn0sMjc2LFs1OF0sIlhIUkludGVyY2VwdG9yIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvSW5zcGVjdG9yL1BlcmZvcm1hbmNlT3ZlcmxheS5qcyI7CgogIHZhciBQZXJmb3JtYW5jZUxvZ2dlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJQZXJmb3JtYW5jZUxvZ2dlciIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUmVhY3QiKTsKCiAgdmFyIFN0eWxlU2hlZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiU3R5bGVTaGVldCIpOwoKICB2YXIgVGV4dCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJUZXh0Iik7CgogIHZhciBWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlZpZXciKTsKCiAgdmFyIFBlcmZvcm1hbmNlT3ZlcmxheSA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoUGVyZm9ybWFuY2VPdmVybGF5LCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBQZXJmb3JtYW5jZU92ZXJsYXkoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBQZXJmb3JtYW5jZU92ZXJsYXkpOwogICAgICByZXR1cm4gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKFBlcmZvcm1hbmNlT3ZlcmxheS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKFBlcmZvcm1hbmNlT3ZlcmxheSkpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhQZXJmb3JtYW5jZU92ZXJsYXksIFt7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgdmFyIHBlcmZMb2dzID0gUGVyZm9ybWFuY2VMb2dnZXIuZ2V0VGltZXNwYW5zKCk7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CgogICAgICAgIGZvciAodmFyIGtleSBpbiBwZXJmTG9ncykgewogICAgICAgICAgaWYgKHBlcmZMb2dzW2tleV0udG90YWxUaW1lKSB7CiAgICAgICAgICAgIHZhciB1bml0ID0ga2V5ID09PSAnQnVuZGxlU2l6ZScgPyAnYicgOiAnbXMnOwogICAgICAgICAgICBpdGVtcy5wdXNoKFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgVmlldywKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLnJvdywKICAgICAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgICBUZXh0LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBzdHlsZTogW3N0eWxlcy50ZXh0LCBzdHlsZXMubGFiZWxdLAogICAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogMzAKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGtleQogICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHN0eWxlOiBbc3R5bGVzLnRleHQsIHN0eWxlcy50b3RhbFRpbWVdLAogICAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogMzEKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHBlcmZMb2dzW2tleV0udG90YWxUaW1lICsgdW5pdAogICAgICAgICAgICAgICkKICAgICAgICAgICAgKSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgIFZpZXcsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuY29udGFpbmVyLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNDAKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGl0ZW1zCiAgICAgICAgKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFBlcmZvcm1hbmNlT3ZlcmxheTsKICB9KFJlYWN0LkNvbXBvbmVudCk7CgogIHZhciBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7CiAgICBjb250YWluZXI6IHsKICAgICAgaGVpZ2h0OiAxMDAsCiAgICAgIHBhZGRpbmdUb3A6IDEwCiAgICB9LAogICAgbGFiZWw6IHsKICAgICAgZmxleDogMQogICAgfSwKICAgIHJvdzogewogICAgICBmbGV4RGlyZWN0aW9uOiAncm93JywKICAgICAgcGFkZGluZ0hvcml6b250YWw6IDEwCiAgICB9LAogICAgdGV4dDogewogICAgICBjb2xvcjogJ3doaXRlJywKICAgICAgZm9udFNpemU6IDEyCiAgICB9LAogICAgdG90YWxUaW1lOiB7CiAgICAgIHBhZGRpbmdSaWdodDogMTAwCiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBQZXJmb3JtYW5jZU92ZXJsYXk7Cn0sMjc3LFs5MywxMzAsMTY4LDE4MSwxNzBdLCJQZXJmb3JtYW5jZU92ZXJsYXkiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9SZWFjdE5hdGl2ZS9ZZWxsb3dCb3guanMiOwoKICB2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkV2ZW50RW1pdHRlciIpOwoKICB2YXIgUGxhdGZvcm0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUGxhdGZvcm0iKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlJlYWN0Iik7CgogIHZhciBTYWZlQXJlYVZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiU2FmZUFyZWFWaWV3Iik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFJDVExvZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJSQ1RMb2ciKTsKCiAgdmFyIGluZm9Mb2cgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAiaW5mb0xvZyIpOwoKICB2YXIgb3BlbkZpbGVJbkVkaXRvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJvcGVuRmlsZUluRWRpdG9yIik7CgogIHZhciBwYXJzZUVycm9yU3RhY2sgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAicGFyc2VFcnJvclN0YWNrIik7CgogIHZhciBzdHJpbmdpZnlTYWZlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs5XSwgInN0cmluZ2lmeVNhZmUiKTsKCiAgdmFyIHN5bWJvbGljYXRlU3RhY2tUcmFjZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTBdLCAic3ltYm9saWNhdGVTdGFja1RyYWNlIik7CgogIHZhciBfd2FybmluZ0VtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7CgogIHZhciBfd2FybmluZ01hcCA9IG5ldyBNYXAoKTsKCiAgdmFyIElHTk9SRURfV0FSTklOR1MgPSBbXTsKCiAgaWYgKF9fREVWX18pIHsKICAgIHZhciBfY29uc29sZSA9IGNvbnNvbGUsCiAgICAgICAgZXJyb3IgPSBfY29uc29sZS5lcnJvciwKICAgICAgICB3YXJuID0gX2NvbnNvbGUud2FybjsKCiAgICBjb25zb2xlLmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgICBlcnJvci5hcHBseShjb25zb2xlLCBhcmd1bWVudHMpOwoKICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICdzdHJpbmcnICYmIGFyZ3VtZW50c1swXS5zdGFydHNXaXRoKCdXYXJuaW5nOiAnKSkgewogICAgICAgIHVwZGF0ZVdhcm5pbmdNYXAuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKCiAgICBjb25zb2xlLndhcm4gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHdhcm4uYXBwbHkoY29uc29sZSwgYXJndW1lbnRzKTsKICAgICAgdXBkYXRlV2FybmluZ01hcC5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgfTsKCiAgICBpZiAoUGxhdGZvcm0uaXNUZXN0aW5nKSB7CiAgICAgIGNvbnNvbGUuZGlzYWJsZVllbGxvd0JveCA9IHRydWU7CiAgICB9CgogICAgUkNUTG9nLnNldFdhcm5pbmdIYW5kbGVyKGZ1bmN0aW9uICgpIHsKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICB1cGRhdGVXYXJuaW5nTWFwLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBzcHJpbnRmKGZvcm1hdCkgewogICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbjIgPiAxID8gX2xlbjIgLSAxIDogMCksIF9rZXkyID0gMTsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgfQoKICAgIHZhciBpbmRleCA9IDA7CiAgICByZXR1cm4gZm9ybWF0LnJlcGxhY2UoLyVzL2csIGZ1bmN0aW9uIChtYXRjaCkgewogICAgICByZXR1cm4gYXJnc1tpbmRleCsrXTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlV2FybmluZ01hcCgpIHsKICAgIGlmIChjb25zb2xlLmRpc2FibGVZZWxsb3dCb3gpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciB3YXJuaW5nID0gdm9pZCAwOwoKICAgIGZvciAodmFyIF9sZW4zID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4zKSwgX2tleTMgPSAwOyBfa2V5MyA8IF9sZW4zOyBfa2V5MysrKSB7CiAgICAgIGFyZ3NbX2tleTNdID0gYXJndW1lbnRzW19rZXkzXTsKICAgIH0KCiAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnKSB7CiAgICAgIHZhciBmb3JtYXQgPSBhcmdzWzBdLAogICAgICAgICAgZm9ybWF0QXJncyA9IGFyZ3Muc2xpY2UoMSk7CiAgICAgIHZhciBhcmdDb3VudCA9IChmb3JtYXQubWF0Y2goLyVzL2cpIHx8IFtdKS5sZW5ndGg7CiAgICAgIHdhcm5pbmcgPSBbc3ByaW50Zi5hcHBseSh1bmRlZmluZWQsIFtmb3JtYXRdLmNvbmNhdChiYWJlbEhlbHBlcnMudG9Db25zdW1hYmxlQXJyYXkoZm9ybWF0QXJncy5zbGljZSgwLCBhcmdDb3VudCkubWFwKHN0cmluZ2lmeVNhZmUpKSkpXS5jb25jYXQoYmFiZWxIZWxwZXJzLnRvQ29uc3VtYWJsZUFycmF5KGZvcm1hdEFyZ3Muc2xpY2UoYXJnQ291bnQpLm1hcChzdHJpbmdpZnlTYWZlKSkpLmpvaW4oJyAnKTsKICAgIH0gZWxzZSB7CiAgICAgIHdhcm5pbmcgPSBhcmdzLm1hcChzdHJpbmdpZnlTYWZlKS5qb2luKCcgJyk7CiAgICB9CgogICAgaWYgKHdhcm5pbmcuc3RhcnRzV2l0aCgnKEFEVklDRSknKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHdhcm5pbmdJbmZvID0gX3dhcm5pbmdNYXAuZ2V0KHdhcm5pbmcpOwoKICAgIGlmICh3YXJuaW5nSW5mbykgewogICAgICB3YXJuaW5nSW5mby5jb3VudCArPSAxOwogICAgfSBlbHNlIHsKICAgICAgdmFyIF9lcnJvciA9IG5ldyBFcnJvcigpOwoKICAgICAgX2Vycm9yLmZyYW1lc1RvUG9wID0gMjsKCiAgICAgIF93YXJuaW5nTWFwLnNldCh3YXJuaW5nLCB7CiAgICAgICAgY291bnQ6IDEsCiAgICAgICAgc3RhY2t0cmFjZTogcGFyc2VFcnJvclN0YWNrKF9lcnJvciksCiAgICAgICAgc3ltYm9saWNhdGVkOiBmYWxzZQogICAgICB9KTsKICAgIH0KCiAgICBfd2FybmluZ0VtaXR0ZXIuZW1pdCgnd2FybmluZycsIF93YXJuaW5nTWFwKTsKICB9CgogIGZ1bmN0aW9uIGVuc3VyZVN5bWJvbGljYXRlZFdhcm5pbmcod2FybmluZykgewogICAgdmFyIHByZXZXYXJuaW5nSW5mbyA9IF93YXJuaW5nTWFwLmdldCh3YXJuaW5nKTsKCiAgICBpZiAoIXByZXZXYXJuaW5nSW5mbyB8fCBwcmV2V2FybmluZ0luZm8uc3ltYm9saWNhdGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBwcmV2V2FybmluZ0luZm8uc3ltYm9saWNhdGVkID0gdHJ1ZTsKICAgIHN5bWJvbGljYXRlU3RhY2tUcmFjZShwcmV2V2FybmluZ0luZm8uc3RhY2t0cmFjZSkudGhlbihmdW5jdGlvbiAoc3RhY2spIHsKICAgICAgdmFyIG5leHRXYXJuaW5nSW5mbyA9IF93YXJuaW5nTWFwLmdldCh3YXJuaW5nKTsKCiAgICAgIGlmIChuZXh0V2FybmluZ0luZm8pIHsKICAgICAgICBuZXh0V2FybmluZ0luZm8uc3RhY2t0cmFjZSA9IHN0YWNrOwoKICAgICAgICBfd2FybmluZ0VtaXR0ZXIuZW1pdCgnd2FybmluZycsIF93YXJuaW5nTWFwKTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIHZhciBuZXh0V2FybmluZ0luZm8gPSBfd2FybmluZ01hcC5nZXQod2FybmluZyk7CgogICAgICBpZiAobmV4dFdhcm5pbmdJbmZvKSB7CiAgICAgICAgaW5mb0xvZygnRmFpbGVkIHRvIHN5bWJvbGljYXRlIHdhcm5pbmcsICIlcyI6Jywgd2FybmluZywgZXJyb3IpOwoKICAgICAgICBfd2FybmluZ0VtaXR0ZXIuZW1pdCgnd2FybmluZycsIF93YXJuaW5nTWFwKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBpc1dhcm5pbmdJZ25vcmVkKHdhcm5pbmcpIHsKICAgIHZhciBpc0lnbm9yZWQgPSBJR05PUkVEX1dBUk5JTkdTLnNvbWUoZnVuY3Rpb24gKGlnbm9yZWRXYXJuaW5nKSB7CiAgICAgIHJldHVybiB3YXJuaW5nLnN0YXJ0c1dpdGgoaWdub3JlZFdhcm5pbmcpOwogICAgfSk7CgogICAgaWYgKGlzSWdub3JlZCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICByZXR1cm4gQXJyYXkuaXNBcnJheShjb25zb2xlLmlnbm9yZWRZZWxsb3dCb3gpICYmIGNvbnNvbGUuaWdub3JlZFllbGxvd0JveC5zb21lKGZ1bmN0aW9uIChpZ25vcmVQcmVmaXgpIHsKICAgICAgcmV0dXJuIHdhcm5pbmcuc3RhcnRzV2l0aChTdHJpbmcoaWdub3JlUHJlZml4KSk7CiAgICB9KTsKICB9CgogIHZhciBXYXJuaW5nUm93ID0gZnVuY3Rpb24gV2FybmluZ1JvdyhfcmVmKSB7CiAgICB2YXIgY291bnQgPSBfcmVmLmNvdW50LAogICAgICAgIHdhcm5pbmcgPSBfcmVmLndhcm5pbmcsCiAgICAgICAgb25QcmVzcyA9IF9yZWYub25QcmVzczsKCiAgICB2YXIgVGV4dCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTFdLCAiVGV4dCIpOwoKICAgIHZhciBUb3VjaGFibGVIaWdobGlnaHQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEyXSwgIlRvdWNoYWJsZUhpZ2hsaWdodCIpOwoKICAgIHZhciBWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxM10sICJWaWV3Iik7CgogICAgdmFyIGNvdW50VGV4dCA9IGNvdW50ID4gMSA/IFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgIFRleHQsCiAgICAgIHsKICAgICAgICBzdHlsZTogc3R5bGVzLmxpc3RSb3dDb3VudCwKICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgIGxpbmVOdW1iZXI6IDE5NwogICAgICAgIH0KICAgICAgfSwKICAgICAgJygnICsgY291bnQgKyAnKSAnCiAgICApIDogbnVsbDsKICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICBWaWV3LAogICAgICB7CiAgICAgICAgc3R5bGU6IHN0eWxlcy5saXN0Um93LAogICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgbGluZU51bWJlcjogMjAxCiAgICAgICAgfQogICAgICB9LAogICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgIFRvdWNoYWJsZUhpZ2hsaWdodCwKICAgICAgICB7CiAgICAgICAgICBhY3RpdmVPcGFjaXR5OiAwLjUsCiAgICAgICAgICBvblByZXNzOiBvblByZXNzLAogICAgICAgICAgc3R5bGU6IHN0eWxlcy5saXN0Um93Q29udGVudCwKICAgICAgICAgIHVuZGVybGF5Q29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiAyMDIKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBUZXh0LAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogc3R5bGVzLmxpc3RSb3dUZXh0LAogICAgICAgICAgICBudW1iZXJPZkxpbmVzOiAyLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMjA3CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBjb3VudFRleHQsCiAgICAgICAgICB3YXJuaW5nCiAgICAgICAgKQogICAgICApCiAgICApOwogIH07CgogIHZhciBTdGFja1JvdyA9IGZ1bmN0aW9uIFN0YWNrUm93KF9yZWYyKSB7CiAgICB2YXIgZnJhbWUgPSBfcmVmMi5mcmFtZTsKCiAgICB2YXIgVGV4dCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTFdLCAiVGV4dCIpOwoKICAgIHZhciBUb3VjaGFibGVIaWdobGlnaHQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEyXSwgIlRvdWNoYWJsZUhpZ2hsaWdodCIpOwoKICAgIHZhciBmaWxlID0gZnJhbWUuZmlsZSwKICAgICAgICBsaW5lTnVtYmVyID0gZnJhbWUubGluZU51bWJlcjsKICAgIHZhciBmaWxlTmFtZSA9IHZvaWQgMDsKCiAgICBpZiAoZmlsZSkgewogICAgICB2YXIgZmlsZVBhcnRzID0gZmlsZS5zcGxpdCgnLycpOwogICAgICBmaWxlTmFtZSA9IGZpbGVQYXJ0c1tmaWxlUGFydHMubGVuZ3RoIC0gMV07CiAgICB9IGVsc2UgewogICAgICBmaWxlTmFtZSA9ICc8dW5rbm93biBmaWxlPic7CiAgICB9CgogICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgIFRvdWNoYWJsZUhpZ2hsaWdodCwKICAgICAgewogICAgICAgIGFjdGl2ZU9wYWNpdHk6IDAuNSwKICAgICAgICBzdHlsZTogc3R5bGVzLm9wZW5JbkVkaXRvckJ1dHRvbiwKICAgICAgICB1bmRlcmxheUNvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgIG9uUHJlc3M6IG9wZW5GaWxlSW5FZGl0b3IuYmluZChudWxsLCBmaWxlLCBsaW5lTnVtYmVyKSwKICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgIGxpbmVOdW1iZXI6IDIzMAogICAgICAgIH0KICAgICAgfSwKICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICBUZXh0LAogICAgICAgIHsKICAgICAgICAgIHN0eWxlOiBzdHlsZXMuaW5zcGVjdG9yQ291bnRUZXh0LAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogMjM1CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmaWxlTmFtZSwKICAgICAgICAiOiIsCiAgICAgICAgbGluZU51bWJlcgogICAgICApCiAgICApOwogIH07CgogIHZhciBXYXJuaW5nSW5zcGVjdG9yID0gZnVuY3Rpb24gV2FybmluZ0luc3BlY3RvcihfcmVmMykgewogICAgdmFyIHdhcm5pbmdJbmZvID0gX3JlZjMud2FybmluZ0luZm8sCiAgICAgICAgd2FybmluZyA9IF9yZWYzLndhcm5pbmcsCiAgICAgICAgc3RhY2t0cmFjZVZpc2libGUgPSBfcmVmMy5zdGFja3RyYWNlVmlzaWJsZSwKICAgICAgICBvbkRpc21pc3MgPSBfcmVmMy5vbkRpc21pc3MsCiAgICAgICAgb25EaXNtaXNzQWxsID0gX3JlZjMub25EaXNtaXNzQWxsLAogICAgICAgIG9uTWluaW1pemUgPSBfcmVmMy5vbk1pbmltaXplLAogICAgICAgIHRvZ2dsZVN0YWNrdHJhY2UgPSBfcmVmMy50b2dnbGVTdGFja3RyYWNlOwoKICAgIHZhciBTY3JvbGxWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxNF0sICJTY3JvbGxWaWV3Iik7CgogICAgdmFyIFRleHQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzExXSwgIlRleHQiKTsKCiAgICB2YXIgVG91Y2hhYmxlSGlnaGxpZ2h0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMl0sICJUb3VjaGFibGVIaWdobGlnaHQiKTsKCiAgICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTNdLCAiVmlldyIpOwoKICAgIHZhciBfcmVmNCA9IHdhcm5pbmdJbmZvIHx8IHt9LAogICAgICAgIGNvdW50ID0gX3JlZjQuY291bnQsCiAgICAgICAgc3RhY2t0cmFjZSA9IF9yZWY0LnN0YWNrdHJhY2U7CgogICAgdmFyIGNvdW50U2VudGVuY2UgPSAnV2FybmluZyBlbmNvdW50ZXJlZCAnICsgY291bnQgKyAnIHRpbWUnICsgKGNvdW50IC0gMSA/ICdzJyA6ICcnKSArICcuJzsKICAgIHZhciBzdGFja3RyYWNlTGlzdCA9IHZvaWQgMDsKCiAgICBpZiAoc3RhY2t0cmFjZVZpc2libGUgJiYgc3RhY2t0cmFjZSkgewogICAgICBzdGFja3RyYWNlTGlzdCA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgVmlldywKICAgICAgICB7CiAgICAgICAgICBzdHlsZTogc3R5bGVzLnN0YWNrdHJhY2VMaXN0LAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogMjYzCiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdGFja3RyYWNlLm1hcChmdW5jdGlvbiAoZnJhbWUsIGlpKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChTdGFja1JvdywgewogICAgICAgICAgICBmcmFtZTogZnJhbWUsCiAgICAgICAgICAgIGtleTogaWksCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAyNjQKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSkKICAgICAgKTsKICAgIH0KCiAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgVmlldywKICAgICAgewogICAgICAgIHN0eWxlOiBzdHlsZXMuaW5zcGVjdG9yLAogICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgbGluZU51bWJlcjogMjcwCiAgICAgICAgfQogICAgICB9LAogICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgIFNhZmVBcmVhVmlldywKICAgICAgICB7CiAgICAgICAgICBzdHlsZTogc3R5bGVzLnNhZmVBcmVhLAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogMjcxCiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5pbnNwZWN0b3JDb3VudCwKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDI3MgogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVGV4dCwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuaW5zcGVjdG9yQ291bnRUZXh0LAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjczCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBjb3VudFNlbnRlbmNlCiAgICAgICAgICApLAogICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVG91Y2hhYmxlSGlnaGxpZ2h0LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgb25QcmVzczogdG9nZ2xlU3RhY2t0cmFjZSwKICAgICAgICAgICAgICB1bmRlcmxheUNvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjc0CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5pbnNwZWN0b3JCdXR0b25UZXh0LAogICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjc3CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzdGFja3RyYWNlVmlzaWJsZSA/ICJcdTI1QkMiIDogIlx1MjVCNiIsCiAgICAgICAgICAgICAgIiBTdGFja3RyYWNlIgogICAgICAgICAgICApCiAgICAgICAgICApCiAgICAgICAgKSwKICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgU2Nyb2xsVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5pbnNwZWN0b3JXYXJuaW5nLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMjgyCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBzdGFja3RyYWNlTGlzdCwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmluc3BlY3Rvcldhcm5pbmdUZXh0LAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjg0CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB3YXJuaW5nCiAgICAgICAgICApCiAgICAgICAgKSwKICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5pbnNwZWN0b3JCdXR0b25zLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMjg2CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBUb3VjaGFibGVIaWdobGlnaHQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBhY3RpdmVPcGFjaXR5OiAwLjUsCiAgICAgICAgICAgICAgb25QcmVzczogb25NaW5pbWl6ZSwKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmluc3BlY3RvckJ1dHRvbiwKICAgICAgICAgICAgICB1bmRlcmxheUNvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjg3CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5pbnNwZWN0b3JCdXR0b25UZXh0LAogICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogMjkyCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiTWluaW1pemUiCiAgICAgICAgICAgICkKICAgICAgICAgICksCiAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBUb3VjaGFibGVIaWdobGlnaHQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBhY3RpdmVPcGFjaXR5OiAwLjUsCiAgICAgICAgICAgICAgb25QcmVzczogb25EaXNtaXNzLAogICAgICAgICAgICAgIHN0eWxlOiBzdHlsZXMuaW5zcGVjdG9yQnV0dG9uLAogICAgICAgICAgICAgIHVuZGVybGF5Q29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAyOTQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgICAgVGV4dCwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmluc3BlY3RvckJ1dHRvblRleHQsCiAgICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAyOTkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJEaXNtaXNzIgogICAgICAgICAgICApCiAgICAgICAgICApLAogICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgVG91Y2hhYmxlSGlnaGxpZ2h0LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgYWN0aXZlT3BhY2l0eTogMC41LAogICAgICAgICAgICAgIG9uUHJlc3M6IG9uRGlzbWlzc0FsbCwKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLmluc3BlY3RvckJ1dHRvbiwKICAgICAgICAgICAgICB1bmRlcmxheUNvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMzAxCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5pbnNwZWN0b3JCdXR0b25UZXh0LAogICAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgICAgbGluZU51bWJlcjogMzA2CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiRGlzbWlzcyBBbGwiCiAgICAgICAgICAgICkKICAgICAgICAgICkKICAgICAgICApCiAgICAgICkKICAgICk7CiAgfTsKCiAgdmFyIFllbGxvd0JveCA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoWWVsbG93Qm94LCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBZZWxsb3dCb3gocHJvcHMsIGNvbnRleHQpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFllbGxvd0JveCk7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoWWVsbG93Qm94Ll9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoWWVsbG93Qm94KSkuY2FsbCh0aGlzLCBwcm9wcywgY29udGV4dCkpOwoKICAgICAgX3RoaXMuc3RhdGUgPSB7CiAgICAgICAgaW5zcGVjdGluZzogbnVsbCwKICAgICAgICBzdGFja3RyYWNlVmlzaWJsZTogZmFsc2UsCiAgICAgICAgd2FybmluZ01hcDogX3dhcm5pbmdNYXAKICAgICAgfTsKCiAgICAgIF90aGlzLmRpc21pc3NXYXJuaW5nID0gZnVuY3Rpb24gKHdhcm5pbmcpIHsKICAgICAgICB2YXIgX3RoaXMkc3RhdGUgPSBfdGhpcy5zdGF0ZSwKICAgICAgICAgICAgaW5zcGVjdGluZyA9IF90aGlzJHN0YXRlLmluc3BlY3RpbmcsCiAgICAgICAgICAgIHdhcm5pbmdNYXAgPSBfdGhpcyRzdGF0ZS53YXJuaW5nTWFwOwoKICAgICAgICBpZiAod2FybmluZykgewogICAgICAgICAgd2FybmluZ01hcC5kZWxldGUod2FybmluZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdhcm5pbmdNYXAuY2xlYXIoKTsKICAgICAgICB9CgogICAgICAgIF90aGlzLnNldFN0YXRlKHsKICAgICAgICAgIGluc3BlY3Rpbmc6IHdhcm5pbmcgJiYgaW5zcGVjdGluZyAhPT0gd2FybmluZyA/IGluc3BlY3RpbmcgOiBudWxsLAogICAgICAgICAgd2FybmluZ01hcDogd2FybmluZ01hcAogICAgICAgIH0pOwogICAgICB9OwoKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhZZWxsb3dCb3gsIFt7CiAgICAgIGtleTogImNvbXBvbmVudERpZE1vdW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudERpZE1vdW50KCkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICB2YXIgc2NoZWR1bGVkID0gbnVsbDsKICAgICAgICB0aGlzLl9saXN0ZW5lciA9IF93YXJuaW5nRW1pdHRlci5hZGRMaXN0ZW5lcignd2FybmluZycsIGZ1bmN0aW9uICh3YXJuaW5nTWFwKSB7CiAgICAgICAgICBzY2hlZHVsZWQgPSBzY2hlZHVsZWQgfHwgc2V0SW1tZWRpYXRlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2NoZWR1bGVkID0gbnVsbDsKCiAgICAgICAgICAgIF90aGlzMi5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgd2FybmluZ01hcDogd2FybmluZ01hcAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNvbXBvbmVudERpZFVwZGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnREaWRVcGRhdGUoKSB7CiAgICAgICAgdmFyIGluc3BlY3RpbmcgPSB0aGlzLnN0YXRlLmluc3BlY3Rpbmc7CgogICAgICAgIGlmIChpbnNwZWN0aW5nICE9IG51bGwpIHsKICAgICAgICAgIGVuc3VyZVN5bWJvbGljYXRlZFdhcm5pbmcoaW5zcGVjdGluZyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNvbXBvbmVudFdpbGxVbm1vdW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICAgIGlmICh0aGlzLl9saXN0ZW5lcikgewogICAgICAgICAgdGhpcy5fbGlzdGVuZXIucmVtb3ZlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICAgIGlmIChjb25zb2xlLmRpc2FibGVZZWxsb3dCb3ggfHwgdGhpcy5zdGF0ZS53YXJuaW5nTWFwLnNpemUgPT09IDApIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgdmFyIFNjcm9sbFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE0XSwgIlNjcm9sbFZpZXciKTsKCiAgICAgICAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEzXSwgIlZpZXciKTsKCiAgICAgICAgdmFyIF9zdGF0ZSA9IHRoaXMuc3RhdGUsCiAgICAgICAgICAgIGluc3BlY3RpbmcgPSBfc3RhdGUuaW5zcGVjdGluZywKICAgICAgICAgICAgc3RhY2t0cmFjZVZpc2libGUgPSBfc3RhdGUuc3RhY2t0cmFjZVZpc2libGU7CiAgICAgICAgdmFyIGluc3BlY3RvciA9IGluc3BlY3RpbmcgIT09IG51bGwgPyBSZWFjdC5jcmVhdGVFbGVtZW50KFdhcm5pbmdJbnNwZWN0b3IsIHsKICAgICAgICAgIHdhcm5pbmdJbmZvOiB0aGlzLnN0YXRlLndhcm5pbmdNYXAuZ2V0KGluc3BlY3RpbmcpLAogICAgICAgICAgd2FybmluZzogaW5zcGVjdGluZywKICAgICAgICAgIHN0YWNrdHJhY2VWaXNpYmxlOiBzdGFja3RyYWNlVmlzaWJsZSwKICAgICAgICAgIG9uRGlzbWlzczogZnVuY3Rpb24gb25EaXNtaXNzKCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMzLmRpc21pc3NXYXJuaW5nKGluc3BlY3RpbmcpOwogICAgICAgICAgfSwKICAgICAgICAgIG9uRGlzbWlzc0FsbDogZnVuY3Rpb24gb25EaXNtaXNzQWxsKCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMzLmRpc21pc3NXYXJuaW5nKG51bGwpOwogICAgICAgICAgfSwKICAgICAgICAgIG9uTWluaW1pemU6IGZ1bmN0aW9uIG9uTWluaW1pemUoKSB7CiAgICAgICAgICAgIHJldHVybiBfdGhpczMuc2V0U3RhdGUoewogICAgICAgICAgICAgIGluc3BlY3Rpbmc6IG51bGwKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgdG9nZ2xlU3RhY2t0cmFjZTogZnVuY3Rpb24gdG9nZ2xlU3RhY2t0cmFjZSgpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgc3RhY2t0cmFjZVZpc2libGU6ICFzdGFja3RyYWNlVmlzaWJsZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiAzOTMKICAgICAgICAgIH0KICAgICAgICB9KSA6IG51bGw7CiAgICAgICAgdmFyIHJvd3MgPSBbXTsKICAgICAgICB0aGlzLnN0YXRlLndhcm5pbmdNYXAuZm9yRWFjaChmdW5jdGlvbiAod2FybmluZ0luZm8sIHdhcm5pbmcpIHsKICAgICAgICAgIGlmICghaXNXYXJuaW5nSWdub3JlZCh3YXJuaW5nKSkgewogICAgICAgICAgICByb3dzLnB1c2goUmVhY3QuY3JlYXRlRWxlbWVudChXYXJuaW5nUm93LCB7CiAgICAgICAgICAgICAga2V5OiB3YXJuaW5nLAogICAgICAgICAgICAgIGNvdW50OiB3YXJuaW5nSW5mby5jb3VudCwKICAgICAgICAgICAgICB3YXJuaW5nOiB3YXJuaW5nLAogICAgICAgICAgICAgIG9uUHJlc3M6IGZ1bmN0aW9uIG9uUHJlc3MoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgaW5zcGVjdGluZzogd2FybmluZwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBvbkRpc21pc3M6IGZ1bmN0aW9uIG9uRGlzbWlzcygpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczMuZGlzbWlzc1dhcm5pbmcod2FybmluZyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQwOQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBsaXN0U3R5bGUgPSBbc3R5bGVzLmxpc3QsIHsKICAgICAgICAgIGhlaWdodDogTWF0aC5taW4ocm93cy5sZW5ndGgsIDQuNCkgKiAocm93R3V0dGVyICsgcm93SGVpZ2h0KQogICAgICAgIH1dOwogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IGluc3BlY3RvciA/IHN0eWxlcy5mdWxsU2NyZWVuIDogbGlzdFN0eWxlLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNDI2CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBTY3JvbGxWaWV3LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3R5bGU6IGxpc3RTdHlsZSwKICAgICAgICAgICAgICBzY3JvbGxzVG9Ub3A6IGZhbHNlLAogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogNDI3CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICByb3dzCiAgICAgICAgICApLAogICAgICAgICAgaW5zcGVjdG9yCiAgICAgICAgKTsKICAgICAgfQogICAgfV0sIFt7CiAgICAgIGtleTogImlnbm9yZVdhcm5pbmdzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGlnbm9yZVdhcm5pbmdzKHdhcm5pbmdzKSB7CiAgICAgICAgd2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbiAod2FybmluZykgewogICAgICAgICAgaWYgKElHTk9SRURfV0FSTklOR1MuaW5kZXhPZih3YXJuaW5nKSA9PT0gLTEpIHsKICAgICAgICAgICAgSUdOT1JFRF9XQVJOSU5HUy5wdXNoKHdhcm5pbmcpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gWWVsbG93Qm94OwogIH0oUmVhY3QuQ29tcG9uZW50KTsKCiAgdmFyIGJhY2tncm91bmRDb2xvciA9IGZ1bmN0aW9uIGJhY2tncm91bmRDb2xvcihvcGFjaXR5KSB7CiAgICByZXR1cm4gJ3JnYmEoMjUwLCAxODYsIDQ4LCAnICsgb3BhY2l0eSArICcpJzsKICB9OwoKICB2YXIgdGV4dENvbG9yID0gJ3doaXRlJzsKICB2YXIgcm93R3V0dGVyID0gMTsKICB2YXIgcm93SGVpZ2h0ID0gNDY7CiAgdmFyIGVsZXZhdGlvbiA9IFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcgPyBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUiA6IHVuZGVmaW5lZDsKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgZnVsbFNjcmVlbjogewogICAgICBoZWlnaHQ6ICcxMDAlJywKICAgICAgd2lkdGg6ICcxMDAlJywKICAgICAgZWxldmF0aW9uOiBlbGV2YXRpb24sCiAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnCiAgICB9LAogICAgaW5zcGVjdG9yOiB7CiAgICAgIGJhY2tncm91bmRDb2xvcjogYmFja2dyb3VuZENvbG9yKDAuOTUpLAogICAgICBoZWlnaHQ6ICcxMDAlJywKICAgICAgcGFkZGluZ1RvcDogNSwKICAgICAgZWxldmF0aW9uOiBlbGV2YXRpb24KICAgIH0sCiAgICBpbnNwZWN0b3JCdXR0b25zOiB7CiAgICAgIGZsZXhEaXJlY3Rpb246ICdyb3cnCiAgICB9LAogICAgaW5zcGVjdG9yQnV0dG9uOiB7CiAgICAgIGZsZXg6IDEsCiAgICAgIHBhZGRpbmdWZXJ0aWNhbDogMjIsCiAgICAgIGJhY2tncm91bmRDb2xvcjogYmFja2dyb3VuZENvbG9yKDEpCiAgICB9LAogICAgc2FmZUFyZWE6IHsKICAgICAgZmxleDogMQogICAgfSwKICAgIHN0YWNrdHJhY2VMaXN0OiB7CiAgICAgIHBhZGRpbmdCb3R0b206IDUKICAgIH0sCiAgICBpbnNwZWN0b3JCdXR0b25UZXh0OiB7CiAgICAgIGNvbG9yOiB0ZXh0Q29sb3IsCiAgICAgIGZvbnRTaXplOiAxNCwKICAgICAgb3BhY2l0eTogMC44LAogICAgICB0ZXh0QWxpZ246ICdjZW50ZXInCiAgICB9LAogICAgb3BlbkluRWRpdG9yQnV0dG9uOiB7CiAgICAgIHBhZGRpbmdUb3A6IDUsCiAgICAgIHBhZGRpbmdCb3R0b206IDUKICAgIH0sCiAgICBpbnNwZWN0b3JDb3VudDogewogICAgICBwYWRkaW5nOiAxNSwKICAgICAgcGFkZGluZ0JvdHRvbTogMCwKICAgICAgZmxleERpcmVjdGlvbjogJ3JvdycsCiAgICAgIGp1c3RpZnlDb250ZW50OiAnc3BhY2UtYmV0d2VlbicKICAgIH0sCiAgICBpbnNwZWN0b3JDb3VudFRleHQ6IHsKICAgICAgY29sb3I6IHRleHRDb2xvciwKICAgICAgZm9udFNpemU6IDE0CiAgICB9LAogICAgaW5zcGVjdG9yV2FybmluZzogewogICAgICBmbGV4OiAxLAogICAgICBwYWRkaW5nSG9yaXpvbnRhbDogMTUKICAgIH0sCiAgICBpbnNwZWN0b3JXYXJuaW5nVGV4dDogewogICAgICBjb2xvcjogdGV4dENvbG9yLAogICAgICBmb250U2l6ZTogMTYsCiAgICAgIGZvbnRXZWlnaHQ6ICc2MDAnCiAgICB9LAogICAgbGlzdDogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6ICd0cmFuc3BhcmVudCcsCiAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICBsZWZ0OiAwLAogICAgICByaWdodDogMCwKICAgICAgYm90dG9tOiAwLAogICAgICBlbGV2YXRpb246IGVsZXZhdGlvbgogICAgfSwKICAgIGxpc3RSb3c6IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiBiYWNrZ3JvdW5kQ29sb3IoMC45NSksCiAgICAgIGhlaWdodDogcm93SGVpZ2h0LAogICAgICBtYXJnaW5Ub3A6IHJvd0d1dHRlcgogICAgfSwKICAgIGxpc3RSb3dDb250ZW50OiB7CiAgICAgIGZsZXg6IDEKICAgIH0sCiAgICBsaXN0Um93Q291bnQ6IHsKICAgICAgY29sb3I6ICdyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuNSknCiAgICB9LAogICAgbGlzdFJvd1RleHQ6IHsKICAgICAgY29sb3I6IHRleHRDb2xvciwKICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAgICAgIGxlZnQ6IDAsCiAgICAgIHRvcDogUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJyA/IDUgOiA3LAogICAgICBtYXJnaW5MZWZ0OiAxNSwKICAgICAgbWFyZ2luUmlnaHQ6IDE1CiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBZZWxsb3dCb3g7Cn0sMjc4LFs2Nyw1MiwxMzAsMjc5LDE2OCw5MSw5NCwyNzMsMzIsMzksMzUsMTgxLDI3MSwxNzAsMjI0XSwiWWVsbG93Qm94Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJWaWV3Iik7Cn0sMjc5LFsxNzBdLCJTYWZlQXJlYVZpZXciKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBJMThuTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIikuSTE4bk1hbmFnZXIgfHwgewogICAgaXNSVEw6IGZhbHNlLAogICAgZG9MZWZ0QW5kUmlnaHRTd2FwSW5SVEw6IHRydWUsCiAgICBhbGxvd1JUTDogZnVuY3Rpb24gYWxsb3dSVEwoKSB7fSwKICAgIGZvcmNlUlRMOiBmdW5jdGlvbiBmb3JjZVJUTCgpIHt9LAogICAgc3dhcExlZnRBbmRSaWdodEluUlRMOiBmdW5jdGlvbiBzd2FwTGVmdEFuZFJpZ2h0SW5SVEwoKSB7fQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBJMThuTWFuYWdlcjsKfSwyODAsWzE1XSwiSTE4bk1hbmFnZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlVuaW1wbGVtZW50ZWRWaWV3Iik7Cn0sMjgxLFsyNTldLCJOYXZpZ2F0b3JJT1MiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfY2xhc3MsCiAgICAgIF90ZW1wLAogICAgICBfY2xhc3MyLAogICAgICBfdGVtcDIsCiAgICAgIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvbXBvbmVudHMvUGlja2VyL1BpY2tlci5qcyI7CgogIHZhciBDb2xvclByb3BUeXBlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkNvbG9yUHJvcFR5cGUiKTsKCiAgdmFyIFBpY2tlcklPUyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJQaWNrZXJJT1MiKTsKCiAgdmFyIFBpY2tlckFuZHJvaWQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUGlja2VyQW5kcm9pZCIpOwoKICB2YXIgUGxhdGZvcm0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUGxhdGZvcm0iKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlJlYWN0Iik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgU3R5bGVTaGVldFByb3BUeXBlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgIlN0eWxlU2hlZXRQcm9wVHlwZSIpOwoKICB2YXIgVGV4dFN0eWxlUHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs3XSwgIlRleHRTdHlsZVByb3BUeXBlcyIpOwoKICB2YXIgVW5pbXBsZW1lbnRlZFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAiVW5pbXBsZW1lbnRlZFZpZXciKTsKCiAgdmFyIFZpZXdQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAiVmlld1Byb3BUeXBlcyIpOwoKICB2YXIgVmlld1N0eWxlUHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMF0sICJWaWV3U3R5bGVQcm9wVHlwZXMiKTsKCiAgdmFyIGl0ZW1TdHlsZVByb3BUeXBlID0gU3R5bGVTaGVldFByb3BUeXBlKFRleHRTdHlsZVByb3BUeXBlcyk7CiAgdmFyIHBpY2tlclN0eWxlVHlwZSA9IFN0eWxlU2hlZXRQcm9wVHlwZShiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgVmlld1N0eWxlUHJvcFR5cGVzLCB7CiAgICBjb2xvcjogQ29sb3JQcm9wVHlwZQogIH0pKTsKICB2YXIgTU9ERV9ESUFMT0cgPSAnZGlhbG9nJzsKICB2YXIgTU9ERV9EUk9QRE9XTiA9ICdkcm9wZG93bic7CiAgdmFyIFBpY2tlckl0ZW0gPSAoX3RlbXAgPSBfY2xhc3MgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKFBpY2tlckl0ZW0sIF9SZWFjdCRDb21wb25lbnQpOwoKICAgIGZ1bmN0aW9uIFBpY2tlckl0ZW0oKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBQaWNrZXJJdGVtKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChQaWNrZXJJdGVtLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoUGlja2VySXRlbSkpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhQaWNrZXJJdGVtLCBbewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHRocm93IG51bGw7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBQaWNrZXJJdGVtOwogIH0oUmVhY3QuQ29tcG9uZW50KSwgX2NsYXNzLnByb3BUeXBlcyA9IHsKICAgIGxhYmVsOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsCiAgICB2YWx1ZTogUHJvcFR5cGVzLmFueSwKICAgIGNvbG9yOiBDb2xvclByb3BUeXBlLAogICAgdGVzdElEOiBQcm9wVHlwZXMuc3RyaW5nCiAgfSwgX3RlbXApOwogIHZhciBQaWNrZXIgPSAoX3RlbXAyID0gX2NsYXNzMiA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50MikgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKFBpY2tlciwgX1JlYWN0JENvbXBvbmVudDIpOwoKICAgIGZ1bmN0aW9uIFBpY2tlcigpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFBpY2tlcik7CiAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoUGlja2VyLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoUGlja2VyKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFBpY2tlciwgW3sKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICdpb3MnKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgUGlja2VySU9TLAogICAgICAgICAgICBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcywgewogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMTU3CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgdGhpcy5wcm9wcy5jaGlsZHJlbgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHsKICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgICBQaWNrZXJBbmRyb2lkLAogICAgICAgICAgICBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcywgewogICAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgICAgbGluZU51bWJlcjogMTYwCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgdGhpcy5wcm9wcy5jaGlsZHJlbgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoVW5pbXBsZW1lbnRlZFZpZXcsIHsKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDE2MgogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBQaWNrZXI7CiAgfShSZWFjdC5Db21wb25lbnQpLCBfY2xhc3MyLk1PREVfRElBTE9HID0gTU9ERV9ESUFMT0csIF9jbGFzczIuTU9ERV9EUk9QRE9XTiA9IE1PREVfRFJPUERPV04sIF9jbGFzczIuSXRlbSA9IFBpY2tlckl0ZW0sIF9jbGFzczIuZGVmYXVsdFByb3BzID0gewogICAgbW9kZTogTU9ERV9ESUFMT0cKICB9LCBfY2xhc3MyLnByb3BUeXBlcyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBWaWV3UHJvcFR5cGVzLCB7CiAgICBzdHlsZTogcGlja2VyU3R5bGVUeXBlLAogICAgc2VsZWN0ZWRWYWx1ZTogUHJvcFR5cGVzLmFueSwKICAgIG9uVmFsdWVDaGFuZ2U6IFByb3BUeXBlcy5mdW5jLAogICAgZW5hYmxlZDogUHJvcFR5cGVzLmJvb2wsCiAgICBtb2RlOiBQcm9wVHlwZXMub25lT2YoWydkaWFsb2cnLCAnZHJvcGRvd24nXSksCiAgICBpdGVtU3R5bGU6IGl0ZW1TdHlsZVByb3BUeXBlLAogICAgcHJvbXB0OiBQcm9wVHlwZXMuc3RyaW5nLAogICAgdGVzdElEOiBQcm9wVHlwZXMuc3RyaW5nCiAgfSksIF90ZW1wMik7CiAgbW9kdWxlLmV4cG9ydHMgPSBQaWNrZXI7Cn0sMjgyLFsxMjMsMjgzLDI4NCw1MiwxMzAsMTI3LDEzOCwxNTEsMjU5LDEzMSwxMzldLCJQaWNrZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlVuaW1wbGVtZW50ZWRWaWV3Iik7Cn0sMjgzLFsyNTldLCJQaWNrZXJJT1MiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfY2xhc3MsCiAgICAgIF90ZW1wLAogICAgICBfaW5pdGlhbGlzZVByb3BzLAogICAgICBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9Db21wb25lbnRzL1BpY2tlci9QaWNrZXJBbmRyb2lkLmFuZHJvaWQuanMiOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJSZWFjdCIpOwoKICB2YXIgUmVhY3RQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgU3R5bGVTaGVldCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJTdHlsZVNoZWV0Iik7CgogIHZhciBTdHlsZVNoZWV0UHJvcFR5cGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiU3R5bGVTaGVldFByb3BUeXBlIik7CgogIHZhciBWaWV3UHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgIlZpZXdQcm9wVHlwZXMiKTsKCiAgdmFyIFZpZXdTdHlsZVByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJWaWV3U3R5bGVQcm9wVHlwZXMiKTsKCiAgdmFyIHByb2Nlc3NDb2xvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJwcm9jZXNzQ29sb3IiKTsKCiAgdmFyIHJlcXVpcmVOYXRpdmVDb21wb25lbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAicmVxdWlyZU5hdGl2ZUNvbXBvbmVudCIpOwoKICB2YXIgUkVGX1BJQ0tFUiA9ICdwaWNrZXInOwogIHZhciBNT0RFX0RST1BET1dOID0gJ2Ryb3Bkb3duJzsKICB2YXIgcGlja2VyU3R5bGVUeXBlID0gU3R5bGVTaGVldFByb3BUeXBlKGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBWaWV3U3R5bGVQcm9wVHlwZXMsIHsKICAgIGNvbG9yOiBDb2xvclByb3BUeXBlCiAgfSkpOwogIHZhciBQaWNrZXJBbmRyb2lkID0gKF90ZW1wID0gX2NsYXNzID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhQaWNrZXJBbmRyb2lkLCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBQaWNrZXJBbmRyb2lkKHByb3BzLCBjb250ZXh0KSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBQaWNrZXJBbmRyb2lkKTsKCiAgICAgIHZhciBfdGhpcyA9IGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChQaWNrZXJBbmRyb2lkLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoUGlja2VyQW5kcm9pZCkpLmNhbGwodGhpcywgcHJvcHMsIGNvbnRleHQpKTsKCiAgICAgIF9pbml0aWFsaXNlUHJvcHMuY2FsbChfdGhpcyk7CgogICAgICB2YXIgc3RhdGUgPSBfdGhpcy5fc3RhdGVGcm9tUHJvcHMocHJvcHMpOwoKICAgICAgX3RoaXMuc3RhdGUgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgc3RhdGUsIHsKICAgICAgICBpbml0aWFsU2VsZWN0ZWRJbmRleDogc3RhdGUuc2VsZWN0ZWRJbmRleAogICAgICB9KTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhQaWNrZXJBbmRyb2lkLCBbewogICAgICBrZXk6ICJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzKSB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSh0aGlzLl9zdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHMpKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBQaWNrZXIgPSB0aGlzLnByb3BzLm1vZGUgPT09IE1PREVfRFJPUERPV04gPyBEcm9wZG93blBpY2tlciA6IERpYWxvZ1BpY2tlcjsKICAgICAgICB2YXIgbmF0aXZlUHJvcHMgPSB7CiAgICAgICAgICBlbmFibGVkOiB0aGlzLnByb3BzLmVuYWJsZWQsCiAgICAgICAgICBpdGVtczogdGhpcy5zdGF0ZS5pdGVtcywKICAgICAgICAgIG1vZGU6IHRoaXMucHJvcHMubW9kZSwKICAgICAgICAgIG9uU2VsZWN0OiB0aGlzLl9vbkNoYW5nZSwKICAgICAgICAgIHByb21wdDogdGhpcy5wcm9wcy5wcm9tcHQsCiAgICAgICAgICBzZWxlY3RlZDogdGhpcy5zdGF0ZS5pbml0aWFsU2VsZWN0ZWRJbmRleCwKICAgICAgICAgIHRlc3RJRDogdGhpcy5wcm9wcy50ZXN0SUQsCiAgICAgICAgICBzdHlsZTogW3N0eWxlcy5waWNrZXJBbmRyb2lkLCB0aGlzLnByb3BzLnN0eWxlXSwKICAgICAgICAgIGFjY2Vzc2liaWxpdHlMYWJlbDogdGhpcy5wcm9wcy5hY2Nlc3NpYmlsaXR5TGFiZWwKICAgICAgICB9OwogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFBpY2tlciwgYmFiZWxIZWxwZXJzLmV4dGVuZHMoewogICAgICAgICAgcmVmOiBSRUZfUElDS0VSCiAgICAgICAgfSwgbmF0aXZlUHJvcHMsIHsKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDEwNwogICAgICAgICAgfQogICAgICAgIH0pKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjb21wb25lbnREaWRNb3VudCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnREaWRNb3VudCgpIHsKICAgICAgICB0aGlzLl9sYXN0TmF0aXZlUG9zaXRpb24gPSB0aGlzLnN0YXRlLmluaXRpYWxTZWxlY3RlZEluZGV4OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNvbXBvbmVudERpZFVwZGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnREaWRVcGRhdGUoKSB7CiAgICAgICAgaWYgKHRoaXMucmVmc1tSRUZfUElDS0VSXSAmJiB0aGlzLnN0YXRlLnNlbGVjdGVkSW5kZXggIT09IHRoaXMuX2xhc3ROYXRpdmVQb3NpdGlvbikgewogICAgICAgICAgdGhpcy5yZWZzW1JFRl9QSUNLRVJdLnNldE5hdGl2ZVByb3BzKHsKICAgICAgICAgICAgc2VsZWN0ZWQ6IHRoaXMuc3RhdGUuc2VsZWN0ZWRJbmRleAogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLl9sYXN0TmF0aXZlUG9zaXRpb24gPSB0aGlzLnN0YXRlLnNlbGVjdGVkSW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gUGlja2VyQW5kcm9pZDsKICB9KFJlYWN0LkNvbXBvbmVudCksIF9jbGFzcy5wcm9wVHlwZXMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgVmlld1Byb3BUeXBlcywgewogICAgc3R5bGU6IHBpY2tlclN0eWxlVHlwZSwKICAgIHNlbGVjdGVkVmFsdWU6IFJlYWN0UHJvcFR5cGVzLmFueSwKICAgIGVuYWJsZWQ6IFJlYWN0UHJvcFR5cGVzLmJvb2wsCiAgICBtb2RlOiBSZWFjdFByb3BUeXBlcy5vbmVPZihbJ2RpYWxvZycsICdkcm9wZG93biddKSwKICAgIG9uVmFsdWVDaGFuZ2U6IFJlYWN0UHJvcFR5cGVzLmZ1bmMsCiAgICBwcm9tcHQ6IFJlYWN0UHJvcFR5cGVzLnN0cmluZywKICAgIHRlc3RJRDogUmVhY3RQcm9wVHlwZXMuc3RyaW5nCiAgfSksIF9pbml0aWFsaXNlUHJvcHMgPSBmdW5jdGlvbiBfaW5pdGlhbGlzZVByb3BzKCkgewogICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgdGhpcy5fc3RhdGVGcm9tUHJvcHMgPSBmdW5jdGlvbiAocHJvcHMpIHsKICAgICAgdmFyIHNlbGVjdGVkSW5kZXggPSAwOwogICAgICB2YXIgaXRlbXMgPSBSZWFjdC5DaGlsZHJlbi5tYXAocHJvcHMuY2hpbGRyZW4sIGZ1bmN0aW9uIChjaGlsZCwgaW5kZXgpIHsKICAgICAgICBpZiAoY2hpbGQucHJvcHMudmFsdWUgPT09IHByb3BzLnNlbGVjdGVkVmFsdWUpIHsKICAgICAgICAgIHNlbGVjdGVkSW5kZXggPSBpbmRleDsKICAgICAgICB9CgogICAgICAgIHZhciBjaGlsZFByb3BzID0gewogICAgICAgICAgdmFsdWU6IGNoaWxkLnByb3BzLnZhbHVlLAogICAgICAgICAgbGFiZWw6IGNoaWxkLnByb3BzLmxhYmVsCiAgICAgICAgfTsKCiAgICAgICAgaWYgKGNoaWxkLnByb3BzLmNvbG9yKSB7CiAgICAgICAgICBjaGlsZFByb3BzLmNvbG9yID0gcHJvY2Vzc0NvbG9yKGNoaWxkLnByb3BzLmNvbG9yKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBjaGlsZFByb3BzOwogICAgICB9KTsKICAgICAgcmV0dXJuIHsKICAgICAgICBzZWxlY3RlZEluZGV4OiBzZWxlY3RlZEluZGV4LAogICAgICAgIGl0ZW1zOiBpdGVtcwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLl9vbkNoYW5nZSA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICBpZiAoX3RoaXMyLnByb3BzLm9uVmFsdWVDaGFuZ2UpIHsKICAgICAgICB2YXIgcG9zaXRpb24gPSBldmVudC5uYXRpdmVFdmVudC5wb3NpdGlvbjsKCiAgICAgICAgaWYgKHBvc2l0aW9uID49IDApIHsKICAgICAgICAgIHZhciBjaGlsZHJlbiA9IFJlYWN0LkNoaWxkcmVuLnRvQXJyYXkoX3RoaXMyLnByb3BzLmNoaWxkcmVuKTsKICAgICAgICAgIHZhciB2YWx1ZSA9IGNoaWxkcmVuW3Bvc2l0aW9uXS5wcm9wcy52YWx1ZTsKCiAgICAgICAgICBfdGhpczIucHJvcHMub25WYWx1ZUNoYW5nZSh2YWx1ZSwgcG9zaXRpb24pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfdGhpczIucHJvcHMub25WYWx1ZUNoYW5nZShudWxsLCBwb3NpdGlvbik7CiAgICAgICAgfQogICAgICB9CgogICAgICBfdGhpczIuX2xhc3ROYXRpdmVQb3NpdGlvbiA9IGV2ZW50Lm5hdGl2ZUV2ZW50LnBvc2l0aW9uOwoKICAgICAgX3RoaXMyLmZvcmNlVXBkYXRlKCk7CiAgICB9OwogIH0sIF90ZW1wKTsKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgcGlja2VyQW5kcm9pZDogewogICAgICBoZWlnaHQ6IDUwCiAgICB9CiAgfSk7CiAgdmFyIGNmZyA9IHsKICAgIG5hdGl2ZU9ubHk6IHsKICAgICAgaXRlbXM6IHRydWUsCiAgICAgIHNlbGVjdGVkOiB0cnVlCiAgICB9CiAgfTsKICB2YXIgRHJvcGRvd25QaWNrZXIgPSByZXF1aXJlTmF0aXZlQ29tcG9uZW50KCdBbmRyb2lkRHJvcGRvd25QaWNrZXInLCBQaWNrZXJBbmRyb2lkLCBjZmcpOwogIHZhciBEaWFsb2dQaWNrZXIgPSByZXF1aXJlTmF0aXZlQ29tcG9uZW50KCdBbmRyb2lkRGlhbG9nUGlja2VyJywgUGlja2VyQW5kcm9pZCwgY2ZnKTsKICBtb2R1bGUuZXhwb3J0cyA9IFBpY2tlckFuZHJvaWQ7Cn0sMjg0LFsxMjMsMTMwLDEyNywxNjgsMTM4LDEzMSwxMzksMTUyLDE0NV0sIlBpY2tlckFuZHJvaWQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9Db21wb25lbnRzL1Byb2dyZXNzVmlld0lPUy9Qcm9ncmVzc1ZpZXdJT1MuYW5kcm9pZC5qcyI7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJSZWFjdCIpOwoKICB2YXIgU3R5bGVTaGVldCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJTdHlsZVNoZWV0Iik7CgogIHZhciBUZXh0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlRleHQiKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiVmlldyIpOwoKICB2YXIgRHVtbXlQcm9ncmVzc1ZpZXdJT1MgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKER1bW15UHJvZ3Jlc3NWaWV3SU9TLCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBEdW1teVByb2dyZXNzVmlld0lPUygpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIER1bW15UHJvZ3Jlc3NWaWV3SU9TKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChEdW1teVByb2dyZXNzVmlld0lPUy5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKER1bW15UHJvZ3Jlc3NWaWV3SU9TKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKER1bW15UHJvZ3Jlc3NWaWV3SU9TLCBbewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IFtzdHlsZXMuZHVtbXksIHRoaXMucHJvcHMuc3R5bGVdLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMjMKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLnRleHQsCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAyNAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlByb2dyZXNzVmlld0lPUyBpcyBub3Qgc3VwcG9ydGVkIG9uIHRoaXMgcGxhdGZvcm0hIgogICAgICAgICAgKQogICAgICAgICk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBEdW1teVByb2dyZXNzVmlld0lPUzsKICB9KFJlYWN0LkNvbXBvbmVudCk7CgogIHZhciBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7CiAgICBkdW1teTogewogICAgICB3aWR0aDogMTIwLAogICAgICBoZWlnaHQ6IDIwLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6ICcjZmZiY2JjJywKICAgICAgYm9yZGVyV2lkdGg6IDEsCiAgICAgIGJvcmRlckNvbG9yOiAncmVkJywKICAgICAgYWxpZ25JdGVtczogJ2NlbnRlcicsCiAgICAgIGp1c3RpZnlDb250ZW50OiAnY2VudGVyJwogICAgfSwKICAgIHRleHQ6IHsKICAgICAgY29sb3I6ICcjMzMzMzMzJywKICAgICAgbWFyZ2luOiA1LAogICAgICBmb250U2l6ZTogMTAKICAgIH0KICB9KTsKICBtb2R1bGUuZXhwb3J0cyA9IER1bW15UHJvZ3Jlc3NWaWV3SU9TOwp9LDI4NSxbMTMwLDE2OCwxODEsMTcwXSwiUHJvZ3Jlc3NWaWV3SU9TIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2NsYXNzLAogICAgICBfdGVtcDIsCiAgICAgIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0xpc3RzL1NlY3Rpb25MaXN0LmpzIjsKCiAgdmFyIE1ldHJvTGlzdFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTWV0cm9MaXN0VmlldyIpOwoKICB2YXIgUGxhdGZvcm0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUGxhdGZvcm0iKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlJlYWN0Iik7CgogIHZhciBTY3JvbGxWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlNjcm9sbFZpZXciKTsKCiAgdmFyIFZpcnR1YWxpemVkU2VjdGlvbkxpc3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiVmlydHVhbGl6ZWRTZWN0aW9uTGlzdCIpOwoKICB2YXIgZGVmYXVsdFByb3BzID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIFZpcnR1YWxpemVkU2VjdGlvbkxpc3QuZGVmYXVsdFByb3BzLCB7CiAgICBzdGlja3lTZWN0aW9uSGVhZGVyc0VuYWJsZWQ6IFBsYXRmb3JtLk9TID09PSAnaW9zJwogIH0pOwogIHZhciBTZWN0aW9uTGlzdCA9IChfdGVtcDIgPSBfY2xhc3MgPSBmdW5jdGlvbiAoX1JlYWN0JFB1cmVDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhTZWN0aW9uTGlzdCwgX1JlYWN0JFB1cmVDb21wb25lbnQpOwoKICAgIGZ1bmN0aW9uIFNlY3Rpb25MaXN0KCkgewogICAgICB2YXIgX3JlZjsKCiAgICAgIHZhciBfdGVtcCwgX3RoaXMsIF9yZXQ7CgogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgU2VjdGlvbkxpc3QpOwoKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICByZXR1cm4gX3JldCA9IChfdGVtcCA9IChfdGhpcyA9IGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChfcmVmID0gU2VjdGlvbkxpc3QuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihTZWN0aW9uTGlzdCkpLmNhbGwuYXBwbHkoX3JlZiwgW3RoaXNdLmNvbmNhdChhcmdzKSkpLCBfdGhpcyksIF90aGlzLl9jYXB0dXJlUmVmID0gZnVuY3Rpb24gKHJlZikgewogICAgICAgIF90aGlzLl93cmFwcGVyTGlzdFJlZiA9IHJlZjsKICAgICAgfSwgX3RlbXApLCBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybihfdGhpcywgX3JldCk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFNlY3Rpb25MaXN0LCBbewogICAgICBrZXk6ICJzY3JvbGxUb0xvY2F0aW9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNjcm9sbFRvTG9jYXRpb24ocGFyYW1zKSB7CiAgICAgICAgdGhpcy5fd3JhcHBlckxpc3RSZWYuc2Nyb2xsVG9Mb2NhdGlvbihwYXJhbXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlY29yZEludGVyYWN0aW9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlY29yZEludGVyYWN0aW9uKCkgewogICAgICAgIHZhciBsaXN0UmVmID0gdGhpcy5fd3JhcHBlckxpc3RSZWYgJiYgdGhpcy5fd3JhcHBlckxpc3RSZWYuZ2V0TGlzdFJlZigpOwoKICAgICAgICBsaXN0UmVmICYmIGxpc3RSZWYucmVjb3JkSW50ZXJhY3Rpb24oKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJmbGFzaFNjcm9sbEluZGljYXRvcnMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZmxhc2hTY3JvbGxJbmRpY2F0b3JzKCkgewogICAgICAgIHZhciBsaXN0UmVmID0gdGhpcy5fd3JhcHBlckxpc3RSZWYgJiYgdGhpcy5fd3JhcHBlckxpc3RSZWYuZ2V0TGlzdFJlZigpOwoKICAgICAgICBsaXN0UmVmICYmIGxpc3RSZWYuZmxhc2hTY3JvbGxJbmRpY2F0b3JzKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0U2Nyb2xsUmVzcG9uZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFNjcm9sbFJlc3BvbmRlcigpIHsKICAgICAgICB2YXIgbGlzdFJlZiA9IHRoaXMuX3dyYXBwZXJMaXN0UmVmICYmIHRoaXMuX3dyYXBwZXJMaXN0UmVmLmdldExpc3RSZWYoKTsKCiAgICAgICAgaWYgKGxpc3RSZWYpIHsKICAgICAgICAgIHJldHVybiBsaXN0UmVmLmdldFNjcm9sbFJlc3BvbmRlcigpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRTY3JvbGxhYmxlTm9kZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRTY3JvbGxhYmxlTm9kZSgpIHsKICAgICAgICB2YXIgbGlzdFJlZiA9IHRoaXMuX3dyYXBwZXJMaXN0UmVmICYmIHRoaXMuX3dyYXBwZXJMaXN0UmVmLmdldExpc3RSZWYoKTsKCiAgICAgICAgaWYgKGxpc3RSZWYpIHsKICAgICAgICAgIHJldHVybiBsaXN0UmVmLmdldFNjcm9sbGFibGVOb2RlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNldE5hdGl2ZVByb3BzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldE5hdGl2ZVByb3BzKHByb3BzKSB7CiAgICAgICAgdmFyIGxpc3RSZWYgPSB0aGlzLl93cmFwcGVyTGlzdFJlZiAmJiB0aGlzLl93cmFwcGVyTGlzdFJlZi5nZXRMaXN0UmVmKCk7CgogICAgICAgIGlmIChsaXN0UmVmKSB7CiAgICAgICAgICBsaXN0UmVmLnNldE5hdGl2ZVByb3BzKHByb3BzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICB2YXIgTGlzdCA9IHRoaXMucHJvcHMubGVnYWN5SW1wbGVtZW50YXRpb24gPyBNZXRyb0xpc3RWaWV3IDogVmlydHVhbGl6ZWRTZWN0aW9uTGlzdDsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChMaXN0LCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcywgewogICAgICAgICAgcmVmOiB0aGlzLl9jYXB0dXJlUmVmLAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogMzMxCiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gU2VjdGlvbkxpc3Q7CiAgfShSZWFjdC5QdXJlQ29tcG9uZW50KSwgX2NsYXNzLmRlZmF1bHRQcm9wcyA9IGRlZmF1bHRQcm9wcywgX3RlbXAyKTsKICBtb2R1bGUuZXhwb3J0cyA9IFNlY3Rpb25MaXN0Owp9LDI4NixbMjQwLDUyLDEzMCwyMjQsMjg3XSwiU2VjdGlvbkxpc3QiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfY2xhc3MsCiAgICAgIF90ZW1wLAogICAgICBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9MaXN0cy9WaXJ0dWFsaXplZFNlY3Rpb25MaXN0LmpzIjsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0Iik7CgogIHZhciBWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlZpZXciKTsKCiAgdmFyIFZpcnR1YWxpemVkTGlzdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJWaXJ0dWFsaXplZExpc3QiKTsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIFZpcnR1YWxpemVkU2VjdGlvbkxpc3QgPSAoX3RlbXAgPSBfY2xhc3MgPSBmdW5jdGlvbiAoX1JlYWN0JFB1cmVDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhWaXJ0dWFsaXplZFNlY3Rpb25MaXN0LCBfUmVhY3QkUHVyZUNvbXBvbmVudCk7CiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoVmlydHVhbGl6ZWRTZWN0aW9uTGlzdCwgW3sKICAgICAga2V5OiAic2Nyb2xsVG9Mb2NhdGlvbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzY3JvbGxUb0xvY2F0aW9uKHBhcmFtcykgewogICAgICAgIHZhciBpbmRleCA9IHBhcmFtcy5pdGVtSW5kZXggKyAxOwoKICAgICAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgcGFyYW1zLnNlY3Rpb25JbmRleDsgaWkrKykgewogICAgICAgICAgaW5kZXggKz0gdGhpcy5wcm9wcy5zZWN0aW9uc1tpaV0uZGF0YS5sZW5ndGggKyAyOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRvSW5kZXhQYXJhbXMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgcGFyYW1zLCB7CiAgICAgICAgICBpbmRleDogaW5kZXgKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5fbGlzdFJlZi5zY3JvbGxUb0luZGV4KHRvSW5kZXhQYXJhbXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldExpc3RSZWYiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0TGlzdFJlZigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbGlzdFJlZjsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfc3ViRXh0cmFjdG9yIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9zdWJFeHRyYWN0b3IoaW5kZXgpIHsKICAgICAgICB2YXIgaXRlbUluZGV4ID0gaW5kZXg7CiAgICAgICAgdmFyIGRlZmF1bHRLZXlFeHRyYWN0b3IgPSB0aGlzLnByb3BzLmtleUV4dHJhY3RvcjsKCiAgICAgICAgZm9yICh2YXIgaWkgPSAwOyBpaSA8IHRoaXMucHJvcHMuc2VjdGlvbnMubGVuZ3RoOyBpaSsrKSB7CiAgICAgICAgICB2YXIgX3NlY3Rpb24gPSB0aGlzLnByb3BzLnNlY3Rpb25zW2lpXTsKCiAgICAgICAgICB2YXIgX2tleSA9IF9zZWN0aW9uLmtleSB8fCBTdHJpbmcoaWkpOwoKICAgICAgICAgIGl0ZW1JbmRleCAtPSAxOwoKICAgICAgICAgIGlmIChpdGVtSW5kZXggPj0gX3NlY3Rpb24uZGF0YS5sZW5ndGggKyAxKSB7CiAgICAgICAgICAgIGl0ZW1JbmRleCAtPSBfc2VjdGlvbi5kYXRhLmxlbmd0aCArIDE7CiAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW1JbmRleCA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBzZWN0aW9uOiBfc2VjdGlvbiwKICAgICAgICAgICAgICBrZXk6IF9rZXkgKyAnOmhlYWRlcicsCiAgICAgICAgICAgICAgaW5kZXg6IG51bGwsCiAgICAgICAgICAgICAgaGVhZGVyOiB0cnVlLAogICAgICAgICAgICAgIHRyYWlsaW5nU2VjdGlvbjogdGhpcy5wcm9wcy5zZWN0aW9uc1tpaSArIDFdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW1JbmRleCA9PT0gX3NlY3Rpb24uZGF0YS5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBzZWN0aW9uOiBfc2VjdGlvbiwKICAgICAgICAgICAgICBrZXk6IF9rZXkgKyAnOmZvb3RlcicsCiAgICAgICAgICAgICAgaW5kZXg6IG51bGwsCiAgICAgICAgICAgICAgaGVhZGVyOiBmYWxzZSwKICAgICAgICAgICAgICB0cmFpbGluZ1NlY3Rpb246IHRoaXMucHJvcHMuc2VjdGlvbnNbaWkgKyAxXQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF9rZXlFeHRyYWN0b3IgPSBfc2VjdGlvbi5rZXlFeHRyYWN0b3IgfHwgZGVmYXVsdEtleUV4dHJhY3RvcjsKCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgc2VjdGlvbjogX3NlY3Rpb24sCiAgICAgICAgICAgICAga2V5OiBfa2V5ICsgJzonICsgX2tleUV4dHJhY3Rvcihfc2VjdGlvbi5kYXRhW2l0ZW1JbmRleF0sIGl0ZW1JbmRleCksCiAgICAgICAgICAgICAgaW5kZXg6IGl0ZW1JbmRleCwKICAgICAgICAgICAgICBsZWFkaW5nSXRlbTogX3NlY3Rpb24uZGF0YVtpdGVtSW5kZXggLSAxXSwKICAgICAgICAgICAgICBsZWFkaW5nU2VjdGlvbjogdGhpcy5wcm9wcy5zZWN0aW9uc1tpaSAtIDFdLAogICAgICAgICAgICAgIHRyYWlsaW5nSXRlbTogX3NlY3Rpb24uZGF0YVtpdGVtSW5kZXggKyAxXSwKICAgICAgICAgICAgICB0cmFpbGluZ1NlY3Rpb246IHRoaXMucHJvcHMuc2VjdGlvbnNbaWkgKyAxXQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfZ2V0U2VwYXJhdG9yQ29tcG9uZW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRTZXBhcmF0b3JDb21wb25lbnQoaW5kZXgsIGluZm8pIHsKICAgICAgICBpbmZvID0gaW5mbyB8fCB0aGlzLl9zdWJFeHRyYWN0b3IoaW5kZXgpOwoKICAgICAgICBpZiAoIWluZm8pIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgdmFyIEl0ZW1TZXBhcmF0b3JDb21wb25lbnQgPSBpbmZvLnNlY3Rpb24uSXRlbVNlcGFyYXRvckNvbXBvbmVudCB8fCB0aGlzLnByb3BzLkl0ZW1TZXBhcmF0b3JDb21wb25lbnQ7CiAgICAgICAgdmFyIFNlY3Rpb25TZXBhcmF0b3JDb21wb25lbnQgPSB0aGlzLnByb3BzLlNlY3Rpb25TZXBhcmF0b3JDb21wb25lbnQ7CiAgICAgICAgdmFyIGlzTGFzdEl0ZW1Jbkxpc3QgPSBpbmRleCA9PT0gdGhpcy5zdGF0ZS5jaGlsZFByb3BzLmdldEl0ZW1Db3VudCgpIC0gMTsKICAgICAgICB2YXIgaXNMYXN0SXRlbUluU2VjdGlvbiA9IGluZm8uaW5kZXggPT09IGluZm8uc2VjdGlvbi5kYXRhLmxlbmd0aCAtIDE7CgogICAgICAgIGlmIChTZWN0aW9uU2VwYXJhdG9yQ29tcG9uZW50ICYmIGlzTGFzdEl0ZW1JblNlY3Rpb24pIHsKICAgICAgICAgIHJldHVybiBTZWN0aW9uU2VwYXJhdG9yQ29tcG9uZW50OwogICAgICAgIH0KCiAgICAgICAgaWYgKEl0ZW1TZXBhcmF0b3JDb21wb25lbnQgJiYgIWlzTGFzdEl0ZW1JblNlY3Rpb24gJiYgIWlzTGFzdEl0ZW1Jbkxpc3QpIHsKICAgICAgICAgIHJldHVybiBJdGVtU2VwYXJhdG9yQ29tcG9uZW50OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX2NvbXB1dGVTdGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfY29tcHV0ZVN0YXRlKHByb3BzKSB7CiAgICAgICAgdmFyIG9mZnNldCA9IHByb3BzLkxpc3RIZWFkZXJDb21wb25lbnQgPyAxIDogMDsKICAgICAgICB2YXIgc3RpY2t5SGVhZGVySW5kaWNlcyA9IFtdOwogICAgICAgIHZhciBpdGVtQ291bnQgPSBwcm9wcy5zZWN0aW9ucy5yZWR1Y2UoZnVuY3Rpb24gKHYsIHNlY3Rpb24pIHsKICAgICAgICAgIHN0aWNreUhlYWRlckluZGljZXMucHVzaCh2ICsgb2Zmc2V0KTsKICAgICAgICAgIHJldHVybiB2ICsgc2VjdGlvbi5kYXRhLmxlbmd0aCArIDI7CiAgICAgICAgfSwgMCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNoaWxkUHJvcHM6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBwcm9wcywgewogICAgICAgICAgICByZW5kZXJJdGVtOiB0aGlzLl9yZW5kZXJJdGVtLAogICAgICAgICAgICBJdGVtU2VwYXJhdG9yQ29tcG9uZW50OiB1bmRlZmluZWQsCiAgICAgICAgICAgIGRhdGE6IHByb3BzLnNlY3Rpb25zLAogICAgICAgICAgICBnZXRJdGVtQ291bnQ6IGZ1bmN0aW9uIGdldEl0ZW1Db3VudCgpIHsKICAgICAgICAgICAgICByZXR1cm4gaXRlbUNvdW50OwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRJdGVtOiBnZXRJdGVtLAogICAgICAgICAgICBrZXlFeHRyYWN0b3I6IHRoaXMuX2tleUV4dHJhY3RvciwKICAgICAgICAgICAgb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZDogcHJvcHMub25WaWV3YWJsZUl0ZW1zQ2hhbmdlZCA/IHRoaXMuX29uVmlld2FibGVJdGVtc0NoYW5nZWQgOiB1bmRlZmluZWQsCiAgICAgICAgICAgIHN0aWNreUhlYWRlckluZGljZXM6IHByb3BzLnN0aWNreVNlY3Rpb25IZWFkZXJzRW5hYmxlZCA/IHN0aWNreUhlYWRlckluZGljZXMgOiB1bmRlZmluZWQKICAgICAgICAgIH0pCiAgICAgICAgfTsKICAgICAgfQogICAgfV0pOwoKICAgIGZ1bmN0aW9uIFZpcnR1YWxpemVkU2VjdGlvbkxpc3QocHJvcHMsIGNvbnRleHQpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIFZpcnR1YWxpemVkU2VjdGlvbkxpc3QpOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKFZpcnR1YWxpemVkU2VjdGlvbkxpc3QuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihWaXJ0dWFsaXplZFNlY3Rpb25MaXN0KSkuY2FsbCh0aGlzLCBwcm9wcywgY29udGV4dCkpOwoKICAgICAgX3RoaXMuX2tleUV4dHJhY3RvciA9IGZ1bmN0aW9uIChpdGVtLCBpbmRleCkgewogICAgICAgIHZhciBpbmZvID0gX3RoaXMuX3N1YkV4dHJhY3RvcihpbmRleCk7CgogICAgICAgIHJldHVybiBpbmZvICYmIGluZm8ua2V5IHx8IFN0cmluZyhpbmRleCk7CiAgICAgIH07CgogICAgICBfdGhpcy5fY29udmVydFZpZXdhYmxlID0gZnVuY3Rpb24gKHZpZXdhYmxlKSB7CiAgICAgICAgaW52YXJpYW50KHZpZXdhYmxlLmluZGV4ICE9IG51bGwsICdSZWNlaXZlZCBhIGJyb2tlbiBWaWV3VG9rZW4nKTsKCiAgICAgICAgdmFyIGluZm8gPSBfdGhpcy5fc3ViRXh0cmFjdG9yKHZpZXdhYmxlLmluZGV4KTsKCiAgICAgICAgaWYgKCFpbmZvKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHZhciBrZXlFeHRyYWN0b3IgPSBpbmZvLnNlY3Rpb24ua2V5RXh0cmFjdG9yIHx8IF90aGlzLnByb3BzLmtleUV4dHJhY3RvcjsKICAgICAgICByZXR1cm4gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHZpZXdhYmxlLCB7CiAgICAgICAgICBpbmRleDogaW5mby5pbmRleCwKICAgICAgICAgIGtleToga2V5RXh0cmFjdG9yKHZpZXdhYmxlLml0ZW0sIGluZm8uaW5kZXgpLAogICAgICAgICAgc2VjdGlvbjogaW5mby5zZWN0aW9uCiAgICAgICAgfSk7CiAgICAgIH07CgogICAgICBfdGhpcy5fb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZCA9IGZ1bmN0aW9uIChfcmVmKSB7CiAgICAgICAgdmFyIHZpZXdhYmxlSXRlbXMgPSBfcmVmLnZpZXdhYmxlSXRlbXMsCiAgICAgICAgICAgIGNoYW5nZWQgPSBfcmVmLmNoYW5nZWQ7CgogICAgICAgIGlmIChfdGhpcy5wcm9wcy5vblZpZXdhYmxlSXRlbXNDaGFuZ2VkKSB7CiAgICAgICAgICBfdGhpcy5wcm9wcy5vblZpZXdhYmxlSXRlbXNDaGFuZ2VkKHsKICAgICAgICAgICAgdmlld2FibGVJdGVtczogdmlld2FibGVJdGVtcy5tYXAoX3RoaXMuX2NvbnZlcnRWaWV3YWJsZSwgX3RoaXMpLmZpbHRlcihCb29sZWFuKSwKICAgICAgICAgICAgY2hhbmdlZDogY2hhbmdlZC5tYXAoX3RoaXMuX2NvbnZlcnRWaWV3YWJsZSwgX3RoaXMpLmZpbHRlcihCb29sZWFuKQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgX3RoaXMuX3JlbmRlckl0ZW0gPSBmdW5jdGlvbiAoX3JlZjIpIHsKICAgICAgICB2YXIgaXRlbSA9IF9yZWYyLml0ZW0sCiAgICAgICAgICAgIGluZGV4ID0gX3JlZjIuaW5kZXg7CgogICAgICAgIHZhciBpbmZvID0gX3RoaXMuX3N1YkV4dHJhY3RvcihpbmRleCk7CgogICAgICAgIGlmICghaW5mbykgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICB2YXIgaW5mb0luZGV4ID0gaW5mby5pbmRleDsKCiAgICAgICAgaWYgKGluZm9JbmRleCA9PSBudWxsKSB7CiAgICAgICAgICB2YXIgX3NlY3Rpb24yID0gaW5mby5zZWN0aW9uOwoKICAgICAgICAgIGlmIChpbmZvLmhlYWRlciA9PT0gdHJ1ZSkgewogICAgICAgICAgICB2YXIgX3JlbmRlclNlY3Rpb25IZWFkZXIgPSBfdGhpcy5wcm9wcy5yZW5kZXJTZWN0aW9uSGVhZGVyOwogICAgICAgICAgICByZXR1cm4gX3JlbmRlclNlY3Rpb25IZWFkZXIgPyBfcmVuZGVyU2VjdGlvbkhlYWRlcih7CiAgICAgICAgICAgICAgc2VjdGlvbjogX3NlY3Rpb24yCiAgICAgICAgICAgIH0pIDogbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBfcmVuZGVyU2VjdGlvbkZvb3RlciA9IF90aGlzLnByb3BzLnJlbmRlclNlY3Rpb25Gb290ZXI7CiAgICAgICAgICAgIHJldHVybiBfcmVuZGVyU2VjdGlvbkZvb3RlciA/IF9yZW5kZXJTZWN0aW9uRm9vdGVyKHsKICAgICAgICAgICAgICBzZWN0aW9uOiBfc2VjdGlvbjIKICAgICAgICAgICAgfSkgOiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgX3JlbmRlckl0ZW0gPSBpbmZvLnNlY3Rpb24ucmVuZGVySXRlbSB8fCBfdGhpcy5wcm9wcy5yZW5kZXJJdGVtOwoKICAgICAgICAgIHZhciBfU2VwYXJhdG9yQ29tcG9uZW50ID0gX3RoaXMuX2dldFNlcGFyYXRvckNvbXBvbmVudChpbmRleCwgaW5mbyk7CgogICAgICAgICAgaW52YXJpYW50KF9yZW5kZXJJdGVtLCAnbm8gcmVuZGVySXRlbSEnKTsKICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KEl0ZW1XaXRoU2VwYXJhdG9yLCB7CiAgICAgICAgICAgIFNlcGFyYXRvckNvbXBvbmVudDogX1NlcGFyYXRvckNvbXBvbmVudCwKICAgICAgICAgICAgTGVhZGluZ1NlcGFyYXRvckNvbXBvbmVudDogaW5mb0luZGV4ID09PSAwID8gX3RoaXMucHJvcHMuU2VjdGlvblNlcGFyYXRvckNvbXBvbmVudCA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgY2VsbEtleTogaW5mby5rZXksCiAgICAgICAgICAgIGluZGV4OiBpbmZvSW5kZXgsCiAgICAgICAgICAgIGl0ZW06IGl0ZW0sCiAgICAgICAgICAgIGxlYWRpbmdJdGVtOiBpbmZvLmxlYWRpbmdJdGVtLAogICAgICAgICAgICBsZWFkaW5nU2VjdGlvbjogaW5mby5sZWFkaW5nU2VjdGlvbiwKICAgICAgICAgICAgb25VcGRhdGVTZXBhcmF0b3I6IF90aGlzLl9vblVwZGF0ZVNlcGFyYXRvciwKICAgICAgICAgICAgcHJldkNlbGxLZXk6IChfdGhpcy5fc3ViRXh0cmFjdG9yKGluZGV4IC0gMSkgfHwge30pLmtleSwKICAgICAgICAgICAgcmVmOiBmdW5jdGlvbiByZWYoX3JlZjMpIHsKICAgICAgICAgICAgICBfdGhpcy5fY2VsbFJlZnNbaW5mby5rZXldID0gX3JlZjM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlbmRlckl0ZW06IF9yZW5kZXJJdGVtLAogICAgICAgICAgICBzZWN0aW9uOiBpbmZvLnNlY3Rpb24sCiAgICAgICAgICAgIHRyYWlsaW5nSXRlbTogaW5mby50cmFpbGluZ0l0ZW0sCiAgICAgICAgICAgIHRyYWlsaW5nU2VjdGlvbjogaW5mby50cmFpbGluZ1NlY3Rpb24sCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAyNzgKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgX3RoaXMuX29uVXBkYXRlU2VwYXJhdG9yID0gZnVuY3Rpb24gKGtleSwgbmV3UHJvcHMpIHsKICAgICAgICB2YXIgcmVmID0gX3RoaXMuX2NlbGxSZWZzW2tleV07CiAgICAgICAgcmVmICYmIHJlZi51cGRhdGVTZXBhcmF0b3JQcm9wcyhuZXdQcm9wcyk7CiAgICAgIH07CgogICAgICBfdGhpcy5fY2VsbFJlZnMgPSB7fTsKCiAgICAgIF90aGlzLl9jYXB0dXJlUmVmID0gZnVuY3Rpb24gKHJlZikgewogICAgICAgIF90aGlzLl9saXN0UmVmID0gcmVmOwogICAgICB9OwoKICAgICAgX3RoaXMuc3RhdGUgPSBfdGhpcy5fY29tcHV0ZVN0YXRlKHByb3BzKTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhWaXJ0dWFsaXplZFNlY3Rpb25MaXN0LCBbewogICAgICBrZXk6ICJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzKSB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSh0aGlzLl9jb21wdXRlU3RhdGUobmV4dFByb3BzKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChWaXJ0dWFsaXplZExpc3QsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCB0aGlzLnN0YXRlLmNoaWxkUHJvcHMsIHsKICAgICAgICAgIHJlZjogdGhpcy5fY2FwdHVyZVJlZiwKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDM2NwogICAgICAgICAgfQogICAgICAgIH0pKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFZpcnR1YWxpemVkU2VjdGlvbkxpc3Q7CiAgfShSZWFjdC5QdXJlQ29tcG9uZW50KSwgX2NsYXNzLmRlZmF1bHRQcm9wcyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBWaXJ0dWFsaXplZExpc3QuZGVmYXVsdFByb3BzLCB7CiAgICBkYXRhOiBbXQogIH0pLCBfdGVtcCk7CgogIHZhciBJdGVtV2l0aFNlcGFyYXRvciA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoSXRlbVdpdGhTZXBhcmF0b3IsIF9SZWFjdCRDb21wb25lbnQpOwoKICAgIGZ1bmN0aW9uIEl0ZW1XaXRoU2VwYXJhdG9yKCkgewogICAgICB2YXIgX3JlZjQ7CgogICAgICB2YXIgX3RlbXAyLCBfdGhpczIsIF9yZXQ7CgogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgSXRlbVdpdGhTZXBhcmF0b3IpOwoKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleTIgPSAwOyBfa2V5MiA8IF9sZW47IF9rZXkyKyspIHsKICAgICAgICBhcmdzW19rZXkyXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgIH0KCiAgICAgIHJldHVybiBfcmV0ID0gKF90ZW1wMiA9IChfdGhpczIgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoX3JlZjQgPSBJdGVtV2l0aFNlcGFyYXRvci5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKEl0ZW1XaXRoU2VwYXJhdG9yKSkuY2FsbC5hcHBseShfcmVmNCwgW3RoaXNdLmNvbmNhdChhcmdzKSkpLCBfdGhpczIpLCBfdGhpczIuc3RhdGUgPSB7CiAgICAgICAgc2VwYXJhdG9yUHJvcHM6IHsKICAgICAgICAgIGhpZ2hsaWdodGVkOiBmYWxzZSwKICAgICAgICAgIGxlYWRpbmdJdGVtOiBfdGhpczIucHJvcHMuaXRlbSwKICAgICAgICAgIGxlYWRpbmdTZWN0aW9uOiBfdGhpczIucHJvcHMubGVhZGluZ1NlY3Rpb24sCiAgICAgICAgICBzZWN0aW9uOiBfdGhpczIucHJvcHMuc2VjdGlvbiwKICAgICAgICAgIHRyYWlsaW5nSXRlbTogX3RoaXMyLnByb3BzLnRyYWlsaW5nSXRlbSwKICAgICAgICAgIHRyYWlsaW5nU2VjdGlvbjogX3RoaXMyLnByb3BzLnRyYWlsaW5nU2VjdGlvbgogICAgICAgIH0sCiAgICAgICAgbGVhZGluZ1NlcGFyYXRvclByb3BzOiB7CiAgICAgICAgICBoaWdobGlnaHRlZDogZmFsc2UsCiAgICAgICAgICBsZWFkaW5nSXRlbTogX3RoaXMyLnByb3BzLmxlYWRpbmdJdGVtLAogICAgICAgICAgbGVhZGluZ1NlY3Rpb246IF90aGlzMi5wcm9wcy5sZWFkaW5nU2VjdGlvbiwKICAgICAgICAgIHNlY3Rpb246IF90aGlzMi5wcm9wcy5zZWN0aW9uLAogICAgICAgICAgdHJhaWxpbmdJdGVtOiBfdGhpczIucHJvcHMuaXRlbSwKICAgICAgICAgIHRyYWlsaW5nU2VjdGlvbjogX3RoaXMyLnByb3BzLnRyYWlsaW5nU2VjdGlvbgogICAgICAgIH0KICAgICAgfSwgX3RoaXMyLl9zZXBhcmF0b3JzID0gewogICAgICAgIGhpZ2hsaWdodDogZnVuY3Rpb24gaGlnaGxpZ2h0KCkgewogICAgICAgICAgWydsZWFkaW5nJywgJ3RyYWlsaW5nJ10uZm9yRWFjaChmdW5jdGlvbiAocykgewogICAgICAgICAgICByZXR1cm4gX3RoaXMyLl9zZXBhcmF0b3JzLnVwZGF0ZVByb3BzKHMsIHsKICAgICAgICAgICAgICBoaWdobGlnaHRlZDogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgdW5oaWdobGlnaHQ6IGZ1bmN0aW9uIHVuaGlnaGxpZ2h0KCkgewogICAgICAgICAgWydsZWFkaW5nJywgJ3RyYWlsaW5nJ10uZm9yRWFjaChmdW5jdGlvbiAocykgewogICAgICAgICAgICByZXR1cm4gX3RoaXMyLl9zZXBhcmF0b3JzLnVwZGF0ZVByb3BzKHMsIHsKICAgICAgICAgICAgICBoaWdobGlnaHRlZDogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHVwZGF0ZVByb3BzOiBmdW5jdGlvbiB1cGRhdGVQcm9wcyhzZWxlY3QsIG5ld1Byb3BzKSB7CiAgICAgICAgICB2YXIgX3RoaXMyJHByb3BzID0gX3RoaXMyLnByb3BzLAogICAgICAgICAgICAgIExlYWRpbmdTZXBhcmF0b3JDb21wb25lbnQgPSBfdGhpczIkcHJvcHMuTGVhZGluZ1NlcGFyYXRvckNvbXBvbmVudCwKICAgICAgICAgICAgICBjZWxsS2V5ID0gX3RoaXMyJHByb3BzLmNlbGxLZXksCiAgICAgICAgICAgICAgcHJldkNlbGxLZXkgPSBfdGhpczIkcHJvcHMucHJldkNlbGxLZXk7CgogICAgICAgICAgaWYgKHNlbGVjdCA9PT0gJ2xlYWRpbmcnICYmIExlYWRpbmdTZXBhcmF0b3JDb21wb25lbnQpIHsKICAgICAgICAgICAgX3RoaXMyLnNldFN0YXRlKGZ1bmN0aW9uIChzdGF0ZSkgewogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBsZWFkaW5nU2VwYXJhdG9yUHJvcHM6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBzdGF0ZS5sZWFkaW5nU2VwYXJhdG9yUHJvcHMsIG5ld1Byb3BzKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX3RoaXMyLnByb3BzLm9uVXBkYXRlU2VwYXJhdG9yKHNlbGVjdCA9PT0gJ2xlYWRpbmcnICYmIHByZXZDZWxsS2V5IHx8IGNlbGxLZXksIG5ld1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIF90ZW1wMiksIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKF90aGlzMiwgX3JldCk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEl0ZW1XaXRoU2VwYXJhdG9yLCBbewogICAgICBrZXk6ICJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMocHJvcHMpIHsKICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgdGhpcy5zZXRTdGF0ZShmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHNlcGFyYXRvclByb3BzOiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgX3RoaXMzLnN0YXRlLnNlcGFyYXRvclByb3BzLCB7CiAgICAgICAgICAgICAgbGVhZGluZ0l0ZW06IHByb3BzLml0ZW0sCiAgICAgICAgICAgICAgbGVhZGluZ1NlY3Rpb246IHByb3BzLmxlYWRpbmdTZWN0aW9uLAogICAgICAgICAgICAgIHNlY3Rpb246IHByb3BzLnNlY3Rpb24sCiAgICAgICAgICAgICAgdHJhaWxpbmdJdGVtOiBwcm9wcy50cmFpbGluZ0l0ZW0sCiAgICAgICAgICAgICAgdHJhaWxpbmdTZWN0aW9uOiBwcm9wcy50cmFpbGluZ1NlY3Rpb24KICAgICAgICAgICAgfSksCiAgICAgICAgICAgIGxlYWRpbmdTZXBhcmF0b3JQcm9wczogYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIF90aGlzMy5zdGF0ZS5sZWFkaW5nU2VwYXJhdG9yUHJvcHMsIHsKICAgICAgICAgICAgICBsZWFkaW5nSXRlbTogcHJvcHMubGVhZGluZ0l0ZW0sCiAgICAgICAgICAgICAgbGVhZGluZ1NlY3Rpb246IHByb3BzLmxlYWRpbmdTZWN0aW9uLAogICAgICAgICAgICAgIHNlY3Rpb246IHByb3BzLnNlY3Rpb24sCiAgICAgICAgICAgICAgdHJhaWxpbmdJdGVtOiBwcm9wcy5pdGVtLAogICAgICAgICAgICAgIHRyYWlsaW5nU2VjdGlvbjogcHJvcHMudHJhaWxpbmdTZWN0aW9uCiAgICAgICAgICAgIH0pCiAgICAgICAgICB9OwogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInVwZGF0ZVNlcGFyYXRvclByb3BzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHVwZGF0ZVNlcGFyYXRvclByb3BzKG5ld1Byb3BzKSB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZShmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHNlcGFyYXRvclByb3BzOiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgc3RhdGUuc2VwYXJhdG9yUHJvcHMsIG5ld1Byb3BzKQogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBfcHJvcHMgPSB0aGlzLnByb3BzLAogICAgICAgICAgICBMZWFkaW5nU2VwYXJhdG9yQ29tcG9uZW50ID0gX3Byb3BzLkxlYWRpbmdTZXBhcmF0b3JDb21wb25lbnQsCiAgICAgICAgICAgIFNlcGFyYXRvckNvbXBvbmVudCA9IF9wcm9wcy5TZXBhcmF0b3JDb21wb25lbnQsCiAgICAgICAgICAgIGl0ZW0gPSBfcHJvcHMuaXRlbSwKICAgICAgICAgICAgaW5kZXggPSBfcHJvcHMuaW5kZXgsCiAgICAgICAgICAgIHNlY3Rpb24gPSBfcHJvcHMuc2VjdGlvbjsKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMucHJvcHMucmVuZGVySXRlbSh7CiAgICAgICAgICBpdGVtOiBpdGVtLAogICAgICAgICAgaW5kZXg6IGluZGV4LAogICAgICAgICAgc2VjdGlvbjogc2VjdGlvbiwKICAgICAgICAgIHNlcGFyYXRvcnM6IHRoaXMuX3NlcGFyYXRvcnMKICAgICAgICB9KTsKICAgICAgICB2YXIgbGVhZGluZ1NlcGFyYXRvciA9IExlYWRpbmdTZXBhcmF0b3JDb21wb25lbnQgJiYgUmVhY3QuY3JlYXRlRWxlbWVudChMZWFkaW5nU2VwYXJhdG9yQ29tcG9uZW50LCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5zdGF0ZS5sZWFkaW5nU2VwYXJhdG9yUHJvcHMsIHsKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDQ4OAogICAgICAgICAgfQogICAgICAgIH0pKTsKICAgICAgICB2YXIgc2VwYXJhdG9yID0gU2VwYXJhdG9yQ29tcG9uZW50ICYmIFJlYWN0LmNyZWF0ZUVsZW1lbnQoU2VwYXJhdG9yQ29tcG9uZW50LCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5zdGF0ZS5zZXBhcmF0b3JQcm9wcywgewogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogNDkxCiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICAgIHJldHVybiBsZWFkaW5nU2VwYXJhdG9yIHx8IHNlcGFyYXRvciA/IFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBWaWV3LAogICAgICAgICAgewogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogNDk0CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBsZWFkaW5nU2VwYXJhdG9yLAogICAgICAgICAgZWxlbWVudCwKICAgICAgICAgIHNlcGFyYXRvcgogICAgICAgICkgOiBlbGVtZW50OwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gSXRlbVdpdGhTZXBhcmF0b3I7CiAgfShSZWFjdC5Db21wb25lbnQpOwoKICBmdW5jdGlvbiBnZXRJdGVtKHNlY3Rpb25zLCBpbmRleCkgewogICAgaWYgKCFzZWN0aW9ucykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICB2YXIgaXRlbUlkeCA9IGluZGV4IC0gMTsKCiAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgc2VjdGlvbnMubGVuZ3RoOyBpaSsrKSB7CiAgICAgIGlmIChpdGVtSWR4ID09PSAtMSB8fCBpdGVtSWR4ID09PSBzZWN0aW9uc1tpaV0uZGF0YS5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gc2VjdGlvbnNbaWldOwogICAgICB9IGVsc2UgaWYgKGl0ZW1JZHggPCBzZWN0aW9uc1tpaV0uZGF0YS5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gc2VjdGlvbnNbaWldLmRhdGFbaXRlbUlkeF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaXRlbUlkeCAtPSBzZWN0aW9uc1tpaV0uZGF0YS5sZW5ndGggKyAyOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IFZpcnR1YWxpemVkU2VjdGlvbkxpc3Q7Cn0sMjg3LFsxMzAsMTcwLDI0NywxM10sIlZpcnR1YWxpemVkU2VjdGlvbkxpc3QiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9Db21wb25lbnRzL1NlZ21lbnRlZENvbnRyb2xJT1MvU2VnbWVudGVkQ29udHJvbElPUy5hbmRyb2lkLmpzIjsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0Iik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFRleHQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiVGV4dCIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJWaWV3Iik7CgogIHZhciBEdW1teVNlZ21lbnRlZENvbnRyb2xJT1MgPSBmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKER1bW15U2VnbWVudGVkQ29udHJvbElPUywgX1JlYWN0JENvbXBvbmVudCk7CgogICAgZnVuY3Rpb24gRHVtbXlTZWdtZW50ZWRDb250cm9sSU9TKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgRHVtbXlTZWdtZW50ZWRDb250cm9sSU9TKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChEdW1teVNlZ21lbnRlZENvbnRyb2xJT1MuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihEdW1teVNlZ21lbnRlZENvbnRyb2xJT1MpKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoRHVtbXlTZWdtZW50ZWRDb250cm9sSU9TLCBbewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IFtzdHlsZXMuZHVtbXksIHRoaXMucHJvcHMuc3R5bGVdLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMjMKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogc3R5bGVzLnRleHQsCiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAyNAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlNlZ21lbnRlZENvbnRyb2xJT1MgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGlzIHBsYXRmb3JtISIKICAgICAgICAgICkKICAgICAgICApOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gRHVtbXlTZWdtZW50ZWRDb250cm9sSU9TOwogIH0oUmVhY3QuQ29tcG9uZW50KTsKCiAgdmFyIHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHsKICAgIGR1bW15OiB7CiAgICAgIHdpZHRoOiAxMjAsCiAgICAgIGhlaWdodDogNTAsCiAgICAgIGJhY2tncm91bmRDb2xvcjogJyNmZmJjYmMnLAogICAgICBib3JkZXJXaWR0aDogMSwKICAgICAgYm9yZGVyQ29sb3I6ICdyZWQnLAogICAgICBhbGlnbkl0ZW1zOiAnY2VudGVyJywKICAgICAganVzdGlmeUNvbnRlbnQ6ICdjZW50ZXInCiAgICB9LAogICAgdGV4dDogewogICAgICBjb2xvcjogJyMzMzMzMzMnLAogICAgICBtYXJnaW46IDUsCiAgICAgIGZvbnRTaXplOiAxMAogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gRHVtbXlTZWdtZW50ZWRDb250cm9sSU9TOwp9LDI4OCxbMTMwLDE2OCwxODEsMTcwXSwiU2VnbWVudGVkQ29udHJvbElPUyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvbXBvbmVudHMvU2xpZGVyL1NsaWRlci5qcyI7CgogIHZhciBJbWFnZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJJbWFnZSIpOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBOYXRpdmVNZXRob2RzTWl4aW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiTmF0aXZlTWV0aG9kc01peGluIik7CgogIHZhciBSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlJlYWN0TmF0aXZlVmlld0F0dHJpYnV0ZXMiKTsKCiAgdmFyIFBsYXRmb3JtID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlBsYXRmb3JtIik7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJSZWFjdCIpOwoKICB2YXIgUHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgInByb3AtdHlwZXMiKTsKCiAgdmFyIFN0eWxlU2hlZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiU3R5bGVTaGVldCIpOwoKICB2YXIgVmlld1Byb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJWaWV3UHJvcFR5cGVzIik7CgogIHZhciBjcmVhdGVSZWFjdENsYXNzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs5XSwgImNyZWF0ZS1yZWFjdC1jbGFzcyIpOwoKICB2YXIgcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTBdLCAicmVxdWlyZU5hdGl2ZUNvbXBvbmVudCIpOwoKICB2YXIgU2xpZGVyID0gY3JlYXRlUmVhY3RDbGFzcyh7CiAgICBkaXNwbGF5TmFtZTogJ1NsaWRlcicsCiAgICBtaXhpbnM6IFtOYXRpdmVNZXRob2RzTWl4aW5dLAogICAgcHJvcFR5cGVzOiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgVmlld1Byb3BUeXBlcywgewogICAgICBzdHlsZTogVmlld1Byb3BUeXBlcy5zdHlsZSwKICAgICAgdmFsdWU6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgIHN0ZXA6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgIG1pbmltdW1WYWx1ZTogUHJvcFR5cGVzLm51bWJlciwKICAgICAgbWF4aW11bVZhbHVlOiBQcm9wVHlwZXMubnVtYmVyLAogICAgICBtaW5pbXVtVHJhY2tUaW50Q29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICAgIG1heGltdW1UcmFja1RpbnRDb2xvcjogQ29sb3JQcm9wVHlwZSwKICAgICAgZGlzYWJsZWQ6IFByb3BUeXBlcy5ib29sLAogICAgICB0cmFja0ltYWdlOiBJbWFnZS5wcm9wVHlwZXMuc291cmNlLAogICAgICBtaW5pbXVtVHJhY2tJbWFnZTogSW1hZ2UucHJvcFR5cGVzLnNvdXJjZSwKICAgICAgbWF4aW11bVRyYWNrSW1hZ2U6IEltYWdlLnByb3BUeXBlcy5zb3VyY2UsCiAgICAgIHRodW1iSW1hZ2U6IEltYWdlLnByb3BUeXBlcy5zb3VyY2UsCiAgICAgIHRodW1iVGludENvbG9yOiBDb2xvclByb3BUeXBlLAogICAgICBvblZhbHVlQ2hhbmdlOiBQcm9wVHlwZXMuZnVuYywKICAgICAgb25TbGlkaW5nQ29tcGxldGU6IFByb3BUeXBlcy5mdW5jLAogICAgICB0ZXN0SUQ6IFByb3BUeXBlcy5zdHJpbmcKICAgIH0pLAogICAgZ2V0RGVmYXVsdFByb3BzOiBmdW5jdGlvbiBnZXREZWZhdWx0UHJvcHMoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZGlzYWJsZWQ6IGZhbHNlLAogICAgICAgIHZhbHVlOiAwLAogICAgICAgIG1pbmltdW1WYWx1ZTogMCwKICAgICAgICBtYXhpbXVtVmFsdWU6IDEsCiAgICAgICAgc3RlcDogMAogICAgICB9OwogICAgfSwKICAgIHZpZXdDb25maWc6IHsKICAgICAgdWlWaWV3Q2xhc3NOYW1lOiAnUkNUU2xpZGVyJywKICAgICAgdmFsaWRBdHRyaWJ1dGVzOiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgUmVhY3ROYXRpdmVWaWV3QXR0cmlidXRlcy5SQ1RWaWV3LCB7CiAgICAgICAgdmFsdWU6IHRydWUKICAgICAgfSkKICAgIH0sCiAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgdmFyIF9wcm9wcyA9IHRoaXMucHJvcHMsCiAgICAgICAgICBzdHlsZSA9IF9wcm9wcy5zdHlsZSwKICAgICAgICAgIG9uVmFsdWVDaGFuZ2UgPSBfcHJvcHMub25WYWx1ZUNoYW5nZSwKICAgICAgICAgIG9uU2xpZGluZ0NvbXBsZXRlID0gX3Byb3BzLm9uU2xpZGluZ0NvbXBsZXRlLAogICAgICAgICAgcHJvcHMgPSBiYWJlbEhlbHBlcnMub2JqZWN0V2l0aG91dFByb3BlcnRpZXMoX3Byb3BzLCBbInN0eWxlIiwgIm9uVmFsdWVDaGFuZ2UiLCAib25TbGlkaW5nQ29tcGxldGUiXSk7CiAgICAgIHByb3BzLnN0eWxlID0gW3N0eWxlcy5zbGlkZXIsIHN0eWxlXTsKCiAgICAgIHByb3BzLm9uVmFsdWVDaGFuZ2UgPSBvblZhbHVlQ2hhbmdlICYmIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHZhciB1c2VyRXZlbnQgPSB0cnVlOwoKICAgICAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJykgewogICAgICAgICAgdXNlckV2ZW50ID0gZXZlbnQubmF0aXZlRXZlbnQuZnJvbVVzZXI7CiAgICAgICAgfQoKICAgICAgICBvblZhbHVlQ2hhbmdlICYmIHVzZXJFdmVudCAmJiBvblZhbHVlQ2hhbmdlKGV2ZW50Lm5hdGl2ZUV2ZW50LnZhbHVlKTsKICAgICAgfTsKCiAgICAgIHByb3BzLm9uQ2hhbmdlID0gcHJvcHMub25WYWx1ZUNoYW5nZTsKCiAgICAgIHByb3BzLm9uU2xpZGluZ0NvbXBsZXRlID0gb25TbGlkaW5nQ29tcGxldGUgJiYgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgb25TbGlkaW5nQ29tcGxldGUgJiYgb25TbGlkaW5nQ29tcGxldGUoZXZlbnQubmF0aXZlRXZlbnQudmFsdWUpOwogICAgICB9OwoKICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoUkNUU2xpZGVyLCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgcHJvcHMsIHsKICAgICAgICBlbmFibGVkOiAhdGhpcy5wcm9wcy5kaXNhYmxlZCwKICAgICAgICBvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyOiBmdW5jdGlvbiBvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyKCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKICAgICAgICBvblJlc3BvbmRlclRlcm1pbmF0aW9uUmVxdWVzdDogZnVuY3Rpb24gb25SZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3QoKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgIGxpbmVOdW1iZXI6IDI0OAogICAgICAgIH0KICAgICAgfSkpOwogICAgfQogIH0pOwogIHZhciBzdHlsZXMgPSB2b2lkIDA7CgogIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgIHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHsKICAgICAgc2xpZGVyOiB7CiAgICAgICAgaGVpZ2h0OiA0MAogICAgICB9CiAgICB9KTsKICB9IGVsc2UgewogICAgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgICBzbGlkZXI6IHt9CiAgICB9KTsKICB9CgogIHZhciBvcHRpb25zID0ge307CgogIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICBvcHRpb25zID0gewogICAgICBuYXRpdmVPbmx5OiB7CiAgICAgICAgZW5hYmxlZDogdHJ1ZQogICAgICB9CiAgICB9OwogIH0KCiAgdmFyIFJDVFNsaWRlciA9IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoJ1JDVFNsaWRlcicsIFNsaWRlciwgb3B0aW9ucyk7CiAgbW9kdWxlLmV4cG9ydHMgPSBTbGlkZXI7Cn0sMjg5LFsyMjIsMTIzLDEyNSwxNzEsNTIsMTMwLDEyNywxNjgsMTMxLDE3MiwxNDVdLCJTbGlkZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlVuaW1wbGVtZW50ZWRWaWV3Iik7Cn0sMjkwLFsyNTldLCJTbmFwc2hvdFZpZXdJT1MiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9Db21wb25lbnRzL1N3aXRjaC9Td2l0Y2guanMiOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBOYXRpdmVNZXRob2RzTWl4aW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiTmF0aXZlTWV0aG9kc01peGluIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJQbGF0Zm9ybSIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUmVhY3QiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJwcm9wLXR5cGVzIik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFZpZXdQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAiVmlld1Byb3BUeXBlcyIpOwoKICB2YXIgY3JlYXRlUmVhY3RDbGFzcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJjcmVhdGUtcmVhY3QtY2xhc3MiKTsKCiAgdmFyIHJlcXVpcmVOYXRpdmVDb21wb25lbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzhdLCAicmVxdWlyZU5hdGl2ZUNvbXBvbmVudCIpOwoKICB2YXIgU3dpdGNoID0gY3JlYXRlUmVhY3RDbGFzcyh7CiAgICBkaXNwbGF5TmFtZTogJ1N3aXRjaCcsCiAgICBwcm9wVHlwZXM6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBWaWV3UHJvcFR5cGVzLCB7CiAgICAgIHZhbHVlOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgZGlzYWJsZWQ6IFByb3BUeXBlcy5ib29sLAogICAgICBvblZhbHVlQ2hhbmdlOiBQcm9wVHlwZXMuZnVuYywKICAgICAgdGVzdElEOiBQcm9wVHlwZXMuc3RyaW5nLAogICAgICB0aW50Q29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICAgIG9uVGludENvbG9yOiBDb2xvclByb3BUeXBlLAogICAgICB0aHVtYlRpbnRDb2xvcjogQ29sb3JQcm9wVHlwZQogICAgfSksCiAgICBnZXREZWZhdWx0UHJvcHM6IGZ1bmN0aW9uIGdldERlZmF1bHRQcm9wcygpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogZmFsc2UsCiAgICAgICAgZGlzYWJsZWQ6IGZhbHNlCiAgICAgIH07CiAgICB9LAogICAgbWl4aW5zOiBbTmF0aXZlTWV0aG9kc01peGluXSwKICAgIF9yY3RTd2l0Y2g6IHt9LAogICAgX29uQ2hhbmdlOiBmdW5jdGlvbiBfb25DaGFuZ2UoZXZlbnQpIHsKICAgICAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHsKICAgICAgICB0aGlzLl9yY3RTd2l0Y2guc2V0TmF0aXZlUHJvcHMoewogICAgICAgICAgb246IHRoaXMucHJvcHMudmFsdWUKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9yY3RTd2l0Y2guc2V0TmF0aXZlUHJvcHMoewogICAgICAgICAgdmFsdWU6IHRoaXMucHJvcHMudmFsdWUKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGhpcy5wcm9wcy5vbkNoYW5nZSAmJiB0aGlzLnByb3BzLm9uQ2hhbmdlKGV2ZW50KTsKICAgICAgdGhpcy5wcm9wcy5vblZhbHVlQ2hhbmdlICYmIHRoaXMucHJvcHMub25WYWx1ZUNoYW5nZShldmVudC5uYXRpdmVFdmVudC52YWx1ZSk7CiAgICB9LAogICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgcHJvcHMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcyk7CgogICAgICBwcm9wcy5vblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9OwoKICAgICAgcHJvcHMub25SZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9OwoKICAgICAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHsKICAgICAgICBwcm9wcy5lbmFibGVkID0gIXRoaXMucHJvcHMuZGlzYWJsZWQ7CiAgICAgICAgcHJvcHMub24gPSB0aGlzLnByb3BzLnZhbHVlOwogICAgICAgIHByb3BzLnN0eWxlID0gdGhpcy5wcm9wcy5zdHlsZTsKICAgICAgICBwcm9wcy50cmFja1RpbnRDb2xvciA9IHRoaXMucHJvcHMudmFsdWUgPyB0aGlzLnByb3BzLm9uVGludENvbG9yIDogdGhpcy5wcm9wcy50aW50Q29sb3I7CiAgICAgIH0gZWxzZSBpZiAoUGxhdGZvcm0uT1MgPT09ICdpb3MnKSB7CiAgICAgICAgcHJvcHMuc3R5bGUgPSBbc3R5bGVzLnJjdFN3aXRjaElPUywgdGhpcy5wcm9wcy5zdHlsZV07CiAgICAgIH0KCiAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFJDVFN3aXRjaCwgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHByb3BzLCB7CiAgICAgICAgcmVmOiBmdW5jdGlvbiByZWYoX3JlZikgewogICAgICAgICAgX3RoaXMuX3JjdFN3aXRjaCA9IF9yZWY7CiAgICAgICAgfSwKICAgICAgICBvbkNoYW5nZTogdGhpcy5fb25DaGFuZ2UsCiAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICBsaW5lTnVtYmVyOiAxMTUKICAgICAgICB9CiAgICAgIH0pKTsKICAgIH0KICB9KTsKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgcmN0U3dpdGNoSU9TOiB7CiAgICAgIGhlaWdodDogMzEsCiAgICAgIHdpZHRoOiA1MQogICAgfQogIH0pOwoKICBpZiAoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJykgewogICAgdmFyIFJDVFN3aXRjaCA9IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoJ0FuZHJvaWRTd2l0Y2gnLCBTd2l0Y2gsIHsKICAgICAgbmF0aXZlT25seTogewogICAgICAgIG9uQ2hhbmdlOiB0cnVlLAogICAgICAgIG9uOiB0cnVlLAogICAgICAgIGVuYWJsZWQ6IHRydWUsCiAgICAgICAgdHJhY2tUaW50Q29sb3I6IHRydWUKICAgICAgfQogICAgfSk7CiAgfSBlbHNlIHsKICAgIHZhciBSQ1RTd2l0Y2ggPSByZXF1aXJlTmF0aXZlQ29tcG9uZW50KCdSQ1RTd2l0Y2gnLCBTd2l0Y2gsIHsKICAgICAgbmF0aXZlT25seTogewogICAgICAgIG9uQ2hhbmdlOiB0cnVlCiAgICAgIH0KICAgIH0pOwogIH0KCiAgbW9kdWxlLmV4cG9ydHMgPSBTd2l0Y2g7Cn0sMjkxLFsxMjMsMTI1LDUyLDEzMCwxMjcsMTY4LDEzMSwxNzIsMTQ1XSwiU3dpdGNoIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2NsYXNzLAogICAgICBfdGVtcCwKICAgICAgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvRXhwZXJpbWVudGFsL1N3aXBlYWJsZVJvdy9Td2lwZWFibGVGbGF0TGlzdC5qcyI7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUmVhY3QiKTsKCiAgdmFyIFN3aXBlYWJsZVJvdyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJTd2lwZWFibGVSb3ciKTsKCiAgdmFyIEZsYXRMaXN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIkZsYXRMaXN0Iik7CgogIHZhciBTd2lwZWFibGVGbGF0TGlzdCA9IChfdGVtcCA9IF9jbGFzcyA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoU3dpcGVhYmxlRmxhdExpc3QsIF9SZWFjdCRDb21wb25lbnQpOwoKICAgIGZ1bmN0aW9uIFN3aXBlYWJsZUZsYXRMaXN0KHByb3BzLCBjb250ZXh0KSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBTd2lwZWFibGVGbGF0TGlzdCk7CgogICAgICB2YXIgX3RoaXMgPSBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoU3dpcGVhYmxlRmxhdExpc3QuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihTd2lwZWFibGVGbGF0TGlzdCkpLmNhbGwodGhpcywgcHJvcHMsIGNvbnRleHQpKTsKCiAgICAgIF90aGlzLl9mbGF0TGlzdFJlZiA9IG51bGw7CiAgICAgIF90aGlzLl9zaG91bGRCb3VuY2VGaXJzdFJvd09uTW91bnQgPSBmYWxzZTsKCiAgICAgIF90aGlzLl9vblNjcm9sbCA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgaWYgKF90aGlzLnN0YXRlLm9wZW5Sb3dLZXkpIHsKICAgICAgICAgIF90aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgb3BlblJvd0tleTogbnVsbAogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBfdGhpcy5wcm9wcy5vblNjcm9sbCAmJiBfdGhpcy5wcm9wcy5vblNjcm9sbChlKTsKICAgICAgfTsKCiAgICAgIF90aGlzLl9yZW5kZXJJdGVtID0gZnVuY3Rpb24gKGluZm8pIHsKICAgICAgICB2YXIgc2xpZGVvdXRWaWV3ID0gX3RoaXMucHJvcHMucmVuZGVyUXVpY2tBY3Rpb25zKGluZm8pOwoKICAgICAgICB2YXIga2V5ID0gX3RoaXMucHJvcHMua2V5RXh0cmFjdG9yKGluZm8uaXRlbSwgaW5mby5pbmRleCk7CgogICAgICAgIGlmICghc2xpZGVvdXRWaWV3KSB7CiAgICAgICAgICByZXR1cm4gX3RoaXMucHJvcHMucmVuZGVySXRlbShpbmZvKTsKICAgICAgICB9CgogICAgICAgIHZhciBzaG91bGRCb3VuY2VPbk1vdW50ID0gZmFsc2U7CgogICAgICAgIGlmIChfdGhpcy5fc2hvdWxkQm91bmNlRmlyc3RSb3dPbk1vdW50KSB7CiAgICAgICAgICBfdGhpcy5fc2hvdWxkQm91bmNlRmlyc3RSb3dPbk1vdW50ID0gZmFsc2U7CiAgICAgICAgICBzaG91bGRCb3VuY2VPbk1vdW50ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgU3dpcGVhYmxlUm93LAogICAgICAgICAgewogICAgICAgICAgICBzbGlkZW91dFZpZXc6IHNsaWRlb3V0VmlldywKICAgICAgICAgICAgaXNPcGVuOiBrZXkgPT09IF90aGlzLnN0YXRlLm9wZW5Sb3dLZXksCiAgICAgICAgICAgIG1heFN3aXBlRGlzdGFuY2U6IF90aGlzLl9nZXRNYXhTd2lwZURpc3RhbmNlKGluZm8pLAogICAgICAgICAgICBvbk9wZW46IGZ1bmN0aW9uIG9uT3BlbigpIHsKICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX29uT3BlbihrZXkpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvbkNsb3NlOiBmdW5jdGlvbiBvbkNsb3NlKCkgewogICAgICAgICAgICAgIHJldHVybiBfdGhpcy5fb25DbG9zZShrZXkpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzaG91bGRCb3VuY2VPbk1vdW50OiBzaG91bGRCb3VuY2VPbk1vdW50LAogICAgICAgICAgICBvblN3aXBlRW5kOiBfdGhpcy5fc2V0TGlzdFZpZXdTY3JvbGxhYmxlLAogICAgICAgICAgICBvblN3aXBlU3RhcnQ6IF90aGlzLl9zZXRMaXN0Vmlld05vdFNjcm9sbGFibGUsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAxMzcKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIF90aGlzLnByb3BzLnJlbmRlckl0ZW0oaW5mbykKICAgICAgICApOwogICAgICB9OwoKICAgICAgX3RoaXMuX3NldExpc3RWaWV3U2Nyb2xsYWJsZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpcy5fc2V0TGlzdFZpZXdTY3JvbGxhYmxlVG8odHJ1ZSk7CiAgICAgIH07CgogICAgICBfdGhpcy5fc2V0TGlzdFZpZXdOb3RTY3JvbGxhYmxlID0gZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzLl9zZXRMaXN0Vmlld1Njcm9sbGFibGVUbyhmYWxzZSk7CiAgICAgIH07CgogICAgICBfdGhpcy5zdGF0ZSA9IHsKICAgICAgICBvcGVuUm93S2V5OiBudWxsCiAgICAgIH07CiAgICAgIF90aGlzLl9zaG91bGRCb3VuY2VGaXJzdFJvd09uTW91bnQgPSBfdGhpcy5wcm9wcy5ib3VuY2VGaXJzdFJvd09uTW91bnQ7CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoU3dpcGVhYmxlRmxhdExpc3QsIFt7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KEZsYXRMaXN0LCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcywgewogICAgICAgICAgcmVmOiBmdW5jdGlvbiByZWYoX3JlZikgewogICAgICAgICAgICBfdGhpczIuX2ZsYXRMaXN0UmVmID0gX3JlZjsKICAgICAgICAgIH0sCiAgICAgICAgICBvblNjcm9sbDogdGhpcy5fb25TY3JvbGwsCiAgICAgICAgICByZW5kZXJJdGVtOiB0aGlzLl9yZW5kZXJJdGVtLAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogOTkKICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX2dldE1heFN3aXBlRGlzdGFuY2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2dldE1heFN3aXBlRGlzdGFuY2UoaW5mbykgewogICAgICAgIGlmICh0eXBlb2YgdGhpcy5wcm9wcy5tYXhTd2lwZURpc3RhbmNlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5tYXhTd2lwZURpc3RhbmNlKGluZm8pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMubWF4U3dpcGVEaXN0YW5jZTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfc2V0TGlzdFZpZXdTY3JvbGxhYmxlVG8iLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX3NldExpc3RWaWV3U2Nyb2xsYWJsZVRvKHZhbHVlKSB7CiAgICAgICAgaWYgKHRoaXMuX2ZsYXRMaXN0UmVmKSB7CiAgICAgICAgICB0aGlzLl9mbGF0TGlzdFJlZi5zZXROYXRpdmVQcm9wcyh7CiAgICAgICAgICAgIHNjcm9sbEVuYWJsZWQ6IHZhbHVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX29uT3BlbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfb25PcGVuKGtleSkgewogICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgb3BlblJvd0tleToga2V5CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX29uQ2xvc2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX29uQ2xvc2Uoa2V5KSB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICBvcGVuUm93S2V5OiBudWxsCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBTd2lwZWFibGVGbGF0TGlzdDsKICB9KFJlYWN0LkNvbXBvbmVudCksIF9jbGFzcy5wcm9wVHlwZXMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgRmxhdExpc3QucHJvcFR5cGVzLCB7CiAgICBib3VuY2VGaXJzdFJvd09uTW91bnQ6IFByb3BUeXBlcy5ib29sLmlzUmVxdWlyZWQsCiAgICBtYXhTd2lwZURpc3RhbmNlOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMubnVtYmVyLCBQcm9wVHlwZXMuZnVuY10pLmlzUmVxdWlyZWQsCiAgICByZW5kZXJRdWlja0FjdGlvbnM6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQKICB9KSwgX2NsYXNzLmRlZmF1bHRQcm9wcyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBGbGF0TGlzdC5kZWZhdWx0UHJvcHMsIHsKICAgIGJvdW5jZUZpcnN0Um93T25Nb3VudDogdHJ1ZSwKICAgIHJlbmRlclF1aWNrQWN0aW9uczogZnVuY3Rpb24gcmVuZGVyUXVpY2tBY3Rpb25zKCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9KSwgX3RlbXApOwogIG1vZHVsZS5leHBvcnRzID0gU3dpcGVhYmxlRmxhdExpc3Q7Cn0sMjkyLFsxMjcsMTMwLDI5MywyMzldLCJTd2lwZWFibGVGbGF0TGlzdCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0V4cGVyaW1lbnRhbC9Td2lwZWFibGVSb3cvU3dpcGVhYmxlUm93LmpzIjsKCiAgdmFyIEFuaW1hdGVkID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkFuaW1hdGVkIik7CgogIHZhciBJMThuTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJJMThuTWFuYWdlciIpOwoKICB2YXIgUGFuUmVzcG9uZGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlBhblJlc3BvbmRlciIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiUmVhY3QiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJwcm9wLXR5cGVzIik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFRpbWVyTWl4aW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAicmVhY3QtdGltZXItbWl4aW4iKTsKCiAgdmFyIFZpZXcgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzddLCAiVmlldyIpOwoKICB2YXIgY3JlYXRlUmVhY3RDbGFzcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJjcmVhdGUtcmVhY3QtY2xhc3MiKTsKCiAgdmFyIGVtcHR5RnVuY3Rpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzldLCAiZmJqcy9saWIvZW1wdHlGdW5jdGlvbiIpOwoKICB2YXIgSVNfUlRMID0gSTE4bk1hbmFnZXIuaXNSVEw7CiAgdmFyIENMT1NFRF9MRUZUX1BPU0lUSU9OID0gMDsKICB2YXIgSE9SSVpPTlRBTF9TV0lQRV9ESVNUQU5DRV9USFJFU0hPTEQgPSAxMDsKICB2YXIgSE9SSVpPTlRBTF9GVUxMX1NXSVBFX1NQRUVEX1RIUkVTSE9MRCA9IDAuMzsKICB2YXIgU0xPV19TUEVFRF9TV0lQRV9GQUNUT1IgPSA0OwogIHZhciBTV0lQRV9EVVJBVElPTiA9IDMwMDsKICB2YXIgT05fTU9VTlRfQk9VTkNFX0RFTEFZID0gNzAwOwogIHZhciBPTl9NT1VOVF9CT1VOQ0VfRFVSQVRJT04gPSA0MDA7CiAgdmFyIFJJR0hUX1NXSVBFX0JPVU5DRV9CQUNLX0RJU1RBTkNFID0gMzA7CiAgdmFyIFJJR0hUX1NXSVBFX0JPVU5DRV9CQUNLX0RVUkFUSU9OID0gMzAwOwogIHZhciBSSUdIVF9TV0lQRV9USFJFU0hPTEQgPSAzMCAqIFNMT1dfU1BFRURfU1dJUEVfRkFDVE9SOwogIHZhciBTd2lwZWFibGVSb3cgPSBjcmVhdGVSZWFjdENsYXNzKHsKICAgIGRpc3BsYXlOYW1lOiAnU3dpcGVhYmxlUm93JywKICAgIF9wYW5SZXNwb25kZXI6IHt9LAogICAgX3ByZXZpb3VzTGVmdDogQ0xPU0VEX0xFRlRfUE9TSVRJT04sCiAgICBtaXhpbnM6IFtUaW1lck1peGluXSwKICAgIHByb3BUeXBlczogewogICAgICBjaGlsZHJlbjogUHJvcFR5cGVzLmFueSwKICAgICAgaXNPcGVuOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgcHJldmVudFN3aXBlUmlnaHQ6IFByb3BUeXBlcy5ib29sLAogICAgICBtYXhTd2lwZURpc3RhbmNlOiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsCiAgICAgIG9uT3BlbjogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCwKICAgICAgb25DbG9zZTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCwKICAgICAgb25Td2lwZUVuZDogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCwKICAgICAgb25Td2lwZVN0YXJ0OiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLAogICAgICBzaG91bGRCb3VuY2VPbk1vdW50OiBQcm9wVHlwZXMuYm9vbCwKICAgICAgc2xpZGVvdXRWaWV3OiBQcm9wVHlwZXMubm9kZS5pc1JlcXVpcmVkLAogICAgICBzd2lwZVRocmVzaG9sZDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkCiAgICB9LAogICAgZ2V0SW5pdGlhbFN0YXRlOiBmdW5jdGlvbiBnZXRJbml0aWFsU3RhdGUoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgY3VycmVudExlZnQ6IG5ldyBBbmltYXRlZC5WYWx1ZSh0aGlzLl9wcmV2aW91c0xlZnQpLAogICAgICAgIGlzU3dpcGVhYmxlVmlld1JlbmRlcmVkOiBmYWxzZSwKICAgICAgICByb3dIZWlnaHQ6IG51bGwKICAgICAgfTsKICAgIH0sCiAgICBnZXREZWZhdWx0UHJvcHM6IGZ1bmN0aW9uIGdldERlZmF1bHRQcm9wcygpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBpc09wZW46IGZhbHNlLAogICAgICAgIHByZXZlbnRTd2lwZVJpZ2h0OiBmYWxzZSwKICAgICAgICBtYXhTd2lwZURpc3RhbmNlOiAwLAogICAgICAgIG9uT3BlbjogZW1wdHlGdW5jdGlvbiwKICAgICAgICBvbkNsb3NlOiBlbXB0eUZ1bmN0aW9uLAogICAgICAgIG9uU3dpcGVFbmQ6IGVtcHR5RnVuY3Rpb24sCiAgICAgICAgb25Td2lwZVN0YXJ0OiBlbXB0eUZ1bmN0aW9uLAogICAgICAgIHN3aXBlVGhyZXNob2xkOiAzMAogICAgICB9OwogICAgfSwKICAgIGNvbXBvbmVudFdpbGxNb3VudDogZnVuY3Rpb24gY29tcG9uZW50V2lsbE1vdW50KCkgewogICAgICB0aGlzLl9wYW5SZXNwb25kZXIgPSBQYW5SZXNwb25kZXIuY3JlYXRlKHsKICAgICAgICBvbk1vdmVTaG91bGRTZXRQYW5SZXNwb25kZXJDYXB0dXJlOiB0aGlzLl9oYW5kbGVNb3ZlU2hvdWxkU2V0UGFuUmVzcG9uZGVyQ2FwdHVyZSwKICAgICAgICBvblBhblJlc3BvbmRlckdyYW50OiB0aGlzLl9oYW5kbGVQYW5SZXNwb25kZXJHcmFudCwKICAgICAgICBvblBhblJlc3BvbmRlck1vdmU6IHRoaXMuX2hhbmRsZVBhblJlc3BvbmRlck1vdmUsCiAgICAgICAgb25QYW5SZXNwb25kZXJSZWxlYXNlOiB0aGlzLl9oYW5kbGVQYW5SZXNwb25kZXJFbmQsCiAgICAgICAgb25QYW5SZXNwb25kZXJUZXJtaW5hdGlvblJlcXVlc3Q6IHRoaXMuX29uUGFuUmVzcG9uZGVyVGVybWluYXRpb25SZXF1ZXN0LAogICAgICAgIG9uUGFuUmVzcG9uZGVyVGVybWluYXRlOiB0aGlzLl9oYW5kbGVQYW5SZXNwb25kZXJFbmQsCiAgICAgICAgb25TaG91bGRCbG9ja05hdGl2ZVJlc3BvbmRlcjogZnVuY3Rpb24gb25TaG91bGRCbG9ja05hdGl2ZVJlc3BvbmRlcihldmVudCwgZ2VzdHVyZVN0YXRlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24gY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBpZiAodGhpcy5wcm9wcy5zaG91bGRCb3VuY2VPbk1vdW50KSB7CiAgICAgICAgdGhpcy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgIF90aGlzLl9hbmltYXRlQm91bmNlQmFjayhPTl9NT1VOVF9CT1VOQ0VfRFVSQVRJT04pOwogICAgICAgIH0sIE9OX01PVU5UX0JPVU5DRV9ERUxBWSk7CiAgICAgIH0KICAgIH0sCiAgICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzOiBmdW5jdGlvbiBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wcykgewogICAgICBpZiAodGhpcy5wcm9wcy5pc09wZW4gJiYgIW5leHRQcm9wcy5pc09wZW4pIHsKICAgICAgICB0aGlzLl9hbmltYXRlVG9DbG9zZWRQb3NpdGlvbigpOwogICAgICB9CiAgICB9LAogICAgc2hvdWxkQ29tcG9uZW50VXBkYXRlOiBmdW5jdGlvbiBzaG91bGRDb21wb25lbnRVcGRhdGUobmV4dFByb3BzLCBuZXh0U3RhdGUpIHsKICAgICAgaWYgKHRoaXMucHJvcHMuc2hvdWxkQm91bmNlT25Nb3VudCAmJiAhbmV4dFByb3BzLnNob3VsZEJvdW5jZU9uTW91bnQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICB2YXIgc2xpZGVPdXRWaWV3ID0gdm9pZCAwOwoKICAgICAgaWYgKHRoaXMuc3RhdGUuaXNTd2lwZWFibGVWaWV3UmVuZGVyZWQgJiYgdGhpcy5zdGF0ZS5yb3dIZWlnaHQpIHsKICAgICAgICBzbGlkZU91dFZpZXcgPSBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IFtzdHlsZXMuc2xpZGVPdXRDb250YWluZXIsIHsKICAgICAgICAgICAgICBoZWlnaHQ6IHRoaXMuc3RhdGUucm93SGVpZ2h0CiAgICAgICAgICAgIH1dLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMTc2CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICB0aGlzLnByb3BzLnNsaWRlb3V0VmlldwogICAgICAgICk7CiAgICAgIH0KCiAgICAgIHZhciBzd2lwZWFibGVWaWV3ID0gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICBBbmltYXRlZC5WaWV3LAogICAgICAgIHsKICAgICAgICAgIG9uTGF5b3V0OiB0aGlzLl9vblN3aXBlYWJsZVZpZXdMYXlvdXQsCiAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICB0cmFuc2Zvcm06IFt7CiAgICAgICAgICAgICAgdHJhbnNsYXRlWDogdGhpcy5zdGF0ZS5jdXJyZW50TGVmdAogICAgICAgICAgICB9XQogICAgICAgICAgfSwKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDE4NwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdGhpcy5wcm9wcy5jaGlsZHJlbgogICAgICApOwogICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgKICAgICAgICBWaWV3LAogICAgICAgIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCB0aGlzLl9wYW5SZXNwb25kZXIucGFuSGFuZGxlcnMsIHsKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDE5NQogICAgICAgICAgfQogICAgICAgIH0pLAogICAgICAgIHNsaWRlT3V0VmlldywKICAgICAgICBzd2lwZWFibGVWaWV3CiAgICAgICk7CiAgICB9LAogICAgY2xvc2U6IGZ1bmN0aW9uIGNsb3NlKCkgewogICAgICB0aGlzLnByb3BzLm9uQ2xvc2UoKTsKCiAgICAgIHRoaXMuX2FuaW1hdGVUb0Nsb3NlZFBvc2l0aW9uKCk7CiAgICB9LAogICAgX29uU3dpcGVhYmxlVmlld0xheW91dDogZnVuY3Rpb24gX29uU3dpcGVhYmxlVmlld0xheW91dChldmVudCkgewogICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICBpc1N3aXBlYWJsZVZpZXdSZW5kZXJlZDogdHJ1ZSwKICAgICAgICByb3dIZWlnaHQ6IGV2ZW50Lm5hdGl2ZUV2ZW50LmxheW91dC5oZWlnaHQKICAgICAgfSk7CiAgICB9LAogICAgX2hhbmRsZU1vdmVTaG91bGRTZXRQYW5SZXNwb25kZXJDYXB0dXJlOiBmdW5jdGlvbiBfaGFuZGxlTW92ZVNob3VsZFNldFBhblJlc3BvbmRlckNhcHR1cmUoZXZlbnQsIGdlc3R1cmVTdGF0ZSkgewogICAgICByZXR1cm4gZ2VzdHVyZVN0YXRlLmR5IDwgMTAgJiYgdGhpcy5faXNWYWxpZFN3aXBlKGdlc3R1cmVTdGF0ZSk7CiAgICB9LAogICAgX2hhbmRsZVBhblJlc3BvbmRlckdyYW50OiBmdW5jdGlvbiBfaGFuZGxlUGFuUmVzcG9uZGVyR3JhbnQoZXZlbnQsIGdlc3R1cmVTdGF0ZSkge30sCiAgICBfaGFuZGxlUGFuUmVzcG9uZGVyTW92ZTogZnVuY3Rpb24gX2hhbmRsZVBhblJlc3BvbmRlck1vdmUoZXZlbnQsIGdlc3R1cmVTdGF0ZSkgewogICAgICBpZiAodGhpcy5faXNTd2lwaW5nRXhjZXNzaXZlbHlSaWdodEZyb21DbG9zZWRQb3NpdGlvbihnZXN0dXJlU3RhdGUpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLnByb3BzLm9uU3dpcGVTdGFydCgpOwoKICAgICAgaWYgKHRoaXMuX2lzU3dpcGluZ1JpZ2h0RnJvbUNsb3NlZChnZXN0dXJlU3RhdGUpKSB7CiAgICAgICAgdGhpcy5fc3dpcGVTbG93U3BlZWQoZ2VzdHVyZVN0YXRlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9zd2lwZUZ1bGxTcGVlZChnZXN0dXJlU3RhdGUpOwogICAgICB9CiAgICB9LAogICAgX2lzU3dpcGluZ1JpZ2h0RnJvbUNsb3NlZDogZnVuY3Rpb24gX2lzU3dpcGluZ1JpZ2h0RnJvbUNsb3NlZChnZXN0dXJlU3RhdGUpIHsKICAgICAgdmFyIGdlc3R1cmVTdGF0ZUR4ID0gSVNfUlRMID8gLWdlc3R1cmVTdGF0ZS5keCA6IGdlc3R1cmVTdGF0ZS5keDsKICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzTGVmdCA9PT0gQ0xPU0VEX0xFRlRfUE9TSVRJT04gJiYgZ2VzdHVyZVN0YXRlRHggPiAwOwogICAgfSwKICAgIF9zd2lwZUZ1bGxTcGVlZDogZnVuY3Rpb24gX3N3aXBlRnVsbFNwZWVkKGdlc3R1cmVTdGF0ZSkgewogICAgICB0aGlzLnN0YXRlLmN1cnJlbnRMZWZ0LnNldFZhbHVlKHRoaXMuX3ByZXZpb3VzTGVmdCArIGdlc3R1cmVTdGF0ZS5keCk7CiAgICB9LAogICAgX3N3aXBlU2xvd1NwZWVkOiBmdW5jdGlvbiBfc3dpcGVTbG93U3BlZWQoZ2VzdHVyZVN0YXRlKSB7CiAgICAgIHRoaXMuc3RhdGUuY3VycmVudExlZnQuc2V0VmFsdWUodGhpcy5fcHJldmlvdXNMZWZ0ICsgZ2VzdHVyZVN0YXRlLmR4IC8gU0xPV19TUEVFRF9TV0lQRV9GQUNUT1IpOwogICAgfSwKICAgIF9pc1N3aXBpbmdFeGNlc3NpdmVseVJpZ2h0RnJvbUNsb3NlZFBvc2l0aW9uOiBmdW5jdGlvbiBfaXNTd2lwaW5nRXhjZXNzaXZlbHlSaWdodEZyb21DbG9zZWRQb3NpdGlvbihnZXN0dXJlU3RhdGUpIHsKICAgICAgdmFyIGdlc3R1cmVTdGF0ZUR4ID0gSVNfUlRMID8gLWdlc3R1cmVTdGF0ZS5keCA6IGdlc3R1cmVTdGF0ZS5keDsKICAgICAgcmV0dXJuIHRoaXMuX2lzU3dpcGluZ1JpZ2h0RnJvbUNsb3NlZChnZXN0dXJlU3RhdGUpICYmIGdlc3R1cmVTdGF0ZUR4ID4gUklHSFRfU1dJUEVfVEhSRVNIT0xEOwogICAgfSwKICAgIF9vblBhblJlc3BvbmRlclRlcm1pbmF0aW9uUmVxdWVzdDogZnVuY3Rpb24gX29uUGFuUmVzcG9uZGVyVGVybWluYXRpb25SZXF1ZXN0KGV2ZW50LCBnZXN0dXJlU3RhdGUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIF9hbmltYXRlVG86IGZ1bmN0aW9uIF9hbmltYXRlVG8odG9WYWx1ZSkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHZhciBkdXJhdGlvbiA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogU1dJUEVfRFVSQVRJT047CiAgICAgIHZhciBjYWxsYmFjayA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogZW1wdHlGdW5jdGlvbjsKICAgICAgQW5pbWF0ZWQudGltaW5nKHRoaXMuc3RhdGUuY3VycmVudExlZnQsIHsKICAgICAgICBkdXJhdGlvbjogZHVyYXRpb24sCiAgICAgICAgdG9WYWx1ZTogdG9WYWx1ZSwKICAgICAgICB1c2VOYXRpdmVEcml2ZXI6IHRydWUKICAgICAgfSkuc3RhcnQoZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMi5fcHJldmlvdXNMZWZ0ID0gdG9WYWx1ZTsKICAgICAgICBjYWxsYmFjaygpOwogICAgICB9KTsKICAgIH0sCiAgICBfYW5pbWF0ZVRvT3BlblBvc2l0aW9uOiBmdW5jdGlvbiBfYW5pbWF0ZVRvT3BlblBvc2l0aW9uKCkgewogICAgICB2YXIgbWF4U3dpcGVEaXN0YW5jZSA9IElTX1JUTCA/IC10aGlzLnByb3BzLm1heFN3aXBlRGlzdGFuY2UgOiB0aGlzLnByb3BzLm1heFN3aXBlRGlzdGFuY2U7CgogICAgICB0aGlzLl9hbmltYXRlVG8oLW1heFN3aXBlRGlzdGFuY2UpOwogICAgfSwKICAgIF9hbmltYXRlVG9PcGVuUG9zaXRpb25XaXRoOiBmdW5jdGlvbiBfYW5pbWF0ZVRvT3BlblBvc2l0aW9uV2l0aChzcGVlZCwgZGlzdE1vdmVkKSB7CiAgICAgIHNwZWVkID0gc3BlZWQgPiBIT1JJWk9OVEFMX0ZVTExfU1dJUEVfU1BFRURfVEhSRVNIT0xEID8gc3BlZWQgOiBIT1JJWk9OVEFMX0ZVTExfU1dJUEVfU1BFRURfVEhSRVNIT0xEOwogICAgICB2YXIgZHVyYXRpb24gPSBNYXRoLmFicygodGhpcy5wcm9wcy5tYXhTd2lwZURpc3RhbmNlIC0gTWF0aC5hYnMoZGlzdE1vdmVkKSkgLyBzcGVlZCk7CiAgICAgIHZhciBtYXhTd2lwZURpc3RhbmNlID0gSVNfUlRMID8gLXRoaXMucHJvcHMubWF4U3dpcGVEaXN0YW5jZSA6IHRoaXMucHJvcHMubWF4U3dpcGVEaXN0YW5jZTsKCiAgICAgIHRoaXMuX2FuaW1hdGVUbygtbWF4U3dpcGVEaXN0YW5jZSwgZHVyYXRpb24pOwogICAgfSwKICAgIF9hbmltYXRlVG9DbG9zZWRQb3NpdGlvbjogZnVuY3Rpb24gX2FuaW1hdGVUb0Nsb3NlZFBvc2l0aW9uKCkgewogICAgICB2YXIgZHVyYXRpb24gPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IFNXSVBFX0RVUkFUSU9OOwoKICAgICAgdGhpcy5fYW5pbWF0ZVRvKENMT1NFRF9MRUZUX1BPU0lUSU9OLCBkdXJhdGlvbik7CiAgICB9LAogICAgX2FuaW1hdGVUb0Nsb3NlZFBvc2l0aW9uRHVyaW5nQm91bmNlOiBmdW5jdGlvbiBfYW5pbWF0ZVRvQ2xvc2VkUG9zaXRpb25EdXJpbmdCb3VuY2UoKSB7CiAgICAgIHRoaXMuX2FuaW1hdGVUb0Nsb3NlZFBvc2l0aW9uKFJJR0hUX1NXSVBFX0JPVU5DRV9CQUNLX0RVUkFUSU9OKTsKICAgIH0sCiAgICBfYW5pbWF0ZUJvdW5jZUJhY2s6IGZ1bmN0aW9uIF9hbmltYXRlQm91bmNlQmFjayhkdXJhdGlvbikgewogICAgICB2YXIgc3dpcGVCb3VuY2VCYWNrRGlzdGFuY2UgPSBJU19SVEwgPyAtUklHSFRfU1dJUEVfQk9VTkNFX0JBQ0tfRElTVEFOQ0UgOiBSSUdIVF9TV0lQRV9CT1VOQ0VfQkFDS19ESVNUQU5DRTsKCiAgICAgIHRoaXMuX2FuaW1hdGVUbygtc3dpcGVCb3VuY2VCYWNrRGlzdGFuY2UsIGR1cmF0aW9uLCB0aGlzLl9hbmltYXRlVG9DbG9zZWRQb3NpdGlvbkR1cmluZ0JvdW5jZSk7CiAgICB9LAogICAgX2lzVmFsaWRTd2lwZTogZnVuY3Rpb24gX2lzVmFsaWRTd2lwZShnZXN0dXJlU3RhdGUpIHsKICAgICAgaWYgKHRoaXMucHJvcHMucHJldmVudFN3aXBlUmlnaHQgJiYgdGhpcy5fcHJldmlvdXNMZWZ0ID09PSBDTE9TRURfTEVGVF9QT1NJVElPTiAmJiBnZXN0dXJlU3RhdGUuZHggPiAwKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gTWF0aC5hYnMoZ2VzdHVyZVN0YXRlLmR4KSA+IEhPUklaT05UQUxfU1dJUEVfRElTVEFOQ0VfVEhSRVNIT0xEOwogICAgfSwKICAgIF9zaG91bGRBbmltYXRlUmVtYWluZGVyOiBmdW5jdGlvbiBfc2hvdWxkQW5pbWF0ZVJlbWFpbmRlcihnZXN0dXJlU3RhdGUpIHsKICAgICAgcmV0dXJuIE1hdGguYWJzKGdlc3R1cmVTdGF0ZS5keCkgPiB0aGlzLnByb3BzLnN3aXBlVGhyZXNob2xkIHx8IGdlc3R1cmVTdGF0ZS52eCA+IEhPUklaT05UQUxfRlVMTF9TV0lQRV9TUEVFRF9USFJFU0hPTEQ7CiAgICB9LAogICAgX2hhbmRsZVBhblJlc3BvbmRlckVuZDogZnVuY3Rpb24gX2hhbmRsZVBhblJlc3BvbmRlckVuZChldmVudCwgZ2VzdHVyZVN0YXRlKSB7CiAgICAgIHZhciBob3Jpem9udGFsRGlzdGFuY2UgPSBJU19SVEwgPyAtZ2VzdHVyZVN0YXRlLmR4IDogZ2VzdHVyZVN0YXRlLmR4OwoKICAgICAgaWYgKHRoaXMuX2lzU3dpcGluZ1JpZ2h0RnJvbUNsb3NlZChnZXN0dXJlU3RhdGUpKSB7CiAgICAgICAgdGhpcy5wcm9wcy5vbk9wZW4oKTsKCiAgICAgICAgdGhpcy5fYW5pbWF0ZUJvdW5jZUJhY2soUklHSFRfU1dJUEVfQk9VTkNFX0JBQ0tfRFVSQVRJT04pOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3Nob3VsZEFuaW1hdGVSZW1haW5kZXIoZ2VzdHVyZVN0YXRlKSkgewogICAgICAgIGlmIChob3Jpem9udGFsRGlzdGFuY2UgPCAwKSB7CiAgICAgICAgICB0aGlzLnByb3BzLm9uT3BlbigpOwoKICAgICAgICAgIHRoaXMuX2FuaW1hdGVUb09wZW5Qb3NpdGlvbldpdGgoZ2VzdHVyZVN0YXRlLnZ4LCBob3Jpem9udGFsRGlzdGFuY2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnByb3BzLm9uQ2xvc2UoKTsKCiAgICAgICAgICB0aGlzLl9hbmltYXRlVG9DbG9zZWRQb3NpdGlvbigpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5fcHJldmlvdXNMZWZ0ID09PSBDTE9TRURfTEVGVF9QT1NJVElPTikgewogICAgICAgICAgdGhpcy5fYW5pbWF0ZVRvQ2xvc2VkUG9zaXRpb24oKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fYW5pbWF0ZVRvT3BlblBvc2l0aW9uKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnByb3BzLm9uU3dpcGVFbmQoKTsKICAgIH0KICB9KTsKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgc2xpZGVPdXRDb250YWluZXI6IHsKICAgICAgYm90dG9tOiAwLAogICAgICBsZWZ0OiAwLAogICAgICBwb3NpdGlvbjogJ2Fic29sdXRlJywKICAgICAgcmlnaHQ6IDAsCiAgICAgIHRvcDogMAogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gU3dpcGVhYmxlUm93Owp9LDI5MyxbMTk0LDI4MCwyOTQsMTMwLDEyNywxNjgsMTkxLDE3MCwxNzIsNTddLCJTd2lwZWFibGVSb3ciKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBJbnRlcmFjdGlvbk1hbmFnZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAnLi9JbnRlcmFjdGlvbk1hbmFnZXInKTsKCiAgdmFyIFRvdWNoSGlzdG9yeU1hdGggPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiVG91Y2hIaXN0b3J5TWF0aCIpOwoKICB2YXIgY3VycmVudENlbnRyb2lkWE9mVG91Y2hlc0NoYW5nZWRBZnRlciA9IFRvdWNoSGlzdG9yeU1hdGguY3VycmVudENlbnRyb2lkWE9mVG91Y2hlc0NoYW5nZWRBZnRlcjsKICB2YXIgY3VycmVudENlbnRyb2lkWU9mVG91Y2hlc0NoYW5nZWRBZnRlciA9IFRvdWNoSGlzdG9yeU1hdGguY3VycmVudENlbnRyb2lkWU9mVG91Y2hlc0NoYW5nZWRBZnRlcjsKICB2YXIgcHJldmlvdXNDZW50cm9pZFhPZlRvdWNoZXNDaGFuZ2VkQWZ0ZXIgPSBUb3VjaEhpc3RvcnlNYXRoLnByZXZpb3VzQ2VudHJvaWRYT2ZUb3VjaGVzQ2hhbmdlZEFmdGVyOwogIHZhciBwcmV2aW91c0NlbnRyb2lkWU9mVG91Y2hlc0NoYW5nZWRBZnRlciA9IFRvdWNoSGlzdG9yeU1hdGgucHJldmlvdXNDZW50cm9pZFlPZlRvdWNoZXNDaGFuZ2VkQWZ0ZXI7CiAgdmFyIGN1cnJlbnRDZW50cm9pZFggPSBUb3VjaEhpc3RvcnlNYXRoLmN1cnJlbnRDZW50cm9pZFg7CiAgdmFyIGN1cnJlbnRDZW50cm9pZFkgPSBUb3VjaEhpc3RvcnlNYXRoLmN1cnJlbnRDZW50cm9pZFk7CiAgdmFyIFBhblJlc3BvbmRlciA9IHsKICAgIF9pbml0aWFsaXplR2VzdHVyZVN0YXRlOiBmdW5jdGlvbiBfaW5pdGlhbGl6ZUdlc3R1cmVTdGF0ZShnZXN0dXJlU3RhdGUpIHsKICAgICAgZ2VzdHVyZVN0YXRlLm1vdmVYID0gMDsKICAgICAgZ2VzdHVyZVN0YXRlLm1vdmVZID0gMDsKICAgICAgZ2VzdHVyZVN0YXRlLngwID0gMDsKICAgICAgZ2VzdHVyZVN0YXRlLnkwID0gMDsKICAgICAgZ2VzdHVyZVN0YXRlLmR4ID0gMDsKICAgICAgZ2VzdHVyZVN0YXRlLmR5ID0gMDsKICAgICAgZ2VzdHVyZVN0YXRlLnZ4ID0gMDsKICAgICAgZ2VzdHVyZVN0YXRlLnZ5ID0gMDsKICAgICAgZ2VzdHVyZVN0YXRlLm51bWJlckFjdGl2ZVRvdWNoZXMgPSAwOwogICAgICBnZXN0dXJlU3RhdGUuX2FjY291bnRzRm9yTW92ZXNVcFRvID0gMDsKICAgIH0sCiAgICBfdXBkYXRlR2VzdHVyZVN0YXRlT25Nb3ZlOiBmdW5jdGlvbiBfdXBkYXRlR2VzdHVyZVN0YXRlT25Nb3ZlKGdlc3R1cmVTdGF0ZSwgdG91Y2hIaXN0b3J5KSB7CiAgICAgIGdlc3R1cmVTdGF0ZS5udW1iZXJBY3RpdmVUb3VjaGVzID0gdG91Y2hIaXN0b3J5Lm51bWJlckFjdGl2ZVRvdWNoZXM7CiAgICAgIGdlc3R1cmVTdGF0ZS5tb3ZlWCA9IGN1cnJlbnRDZW50cm9pZFhPZlRvdWNoZXNDaGFuZ2VkQWZ0ZXIodG91Y2hIaXN0b3J5LCBnZXN0dXJlU3RhdGUuX2FjY291bnRzRm9yTW92ZXNVcFRvKTsKICAgICAgZ2VzdHVyZVN0YXRlLm1vdmVZID0gY3VycmVudENlbnRyb2lkWU9mVG91Y2hlc0NoYW5nZWRBZnRlcih0b3VjaEhpc3RvcnksIGdlc3R1cmVTdGF0ZS5fYWNjb3VudHNGb3JNb3Zlc1VwVG8pOwogICAgICB2YXIgbW92ZWRBZnRlciA9IGdlc3R1cmVTdGF0ZS5fYWNjb3VudHNGb3JNb3Zlc1VwVG87CiAgICAgIHZhciBwcmV2WCA9IHByZXZpb3VzQ2VudHJvaWRYT2ZUb3VjaGVzQ2hhbmdlZEFmdGVyKHRvdWNoSGlzdG9yeSwgbW92ZWRBZnRlcik7CiAgICAgIHZhciB4ID0gY3VycmVudENlbnRyb2lkWE9mVG91Y2hlc0NoYW5nZWRBZnRlcih0b3VjaEhpc3RvcnksIG1vdmVkQWZ0ZXIpOwogICAgICB2YXIgcHJldlkgPSBwcmV2aW91c0NlbnRyb2lkWU9mVG91Y2hlc0NoYW5nZWRBZnRlcih0b3VjaEhpc3RvcnksIG1vdmVkQWZ0ZXIpOwogICAgICB2YXIgeSA9IGN1cnJlbnRDZW50cm9pZFlPZlRvdWNoZXNDaGFuZ2VkQWZ0ZXIodG91Y2hIaXN0b3J5LCBtb3ZlZEFmdGVyKTsKICAgICAgdmFyIG5leHREWCA9IGdlc3R1cmVTdGF0ZS5keCArICh4IC0gcHJldlgpOwogICAgICB2YXIgbmV4dERZID0gZ2VzdHVyZVN0YXRlLmR5ICsgKHkgLSBwcmV2WSk7CiAgICAgIHZhciBkdCA9IHRvdWNoSGlzdG9yeS5tb3N0UmVjZW50VGltZVN0YW1wIC0gZ2VzdHVyZVN0YXRlLl9hY2NvdW50c0Zvck1vdmVzVXBUbzsKICAgICAgZ2VzdHVyZVN0YXRlLnZ4ID0gKG5leHREWCAtIGdlc3R1cmVTdGF0ZS5keCkgLyBkdDsKICAgICAgZ2VzdHVyZVN0YXRlLnZ5ID0gKG5leHREWSAtIGdlc3R1cmVTdGF0ZS5keSkgLyBkdDsKICAgICAgZ2VzdHVyZVN0YXRlLmR4ID0gbmV4dERYOwogICAgICBnZXN0dXJlU3RhdGUuZHkgPSBuZXh0RFk7CiAgICAgIGdlc3R1cmVTdGF0ZS5fYWNjb3VudHNGb3JNb3Zlc1VwVG8gPSB0b3VjaEhpc3RvcnkubW9zdFJlY2VudFRpbWVTdGFtcDsKICAgIH0sCiAgICBjcmVhdGU6IGZ1bmN0aW9uIGNyZWF0ZShjb25maWcpIHsKICAgICAgdmFyIGludGVyYWN0aW9uU3RhdGUgPSB7CiAgICAgICAgaGFuZGxlOiBudWxsCiAgICAgIH07CiAgICAgIHZhciBnZXN0dXJlU3RhdGUgPSB7CiAgICAgICAgc3RhdGVJRDogTWF0aC5yYW5kb20oKQogICAgICB9OwoKICAgICAgUGFuUmVzcG9uZGVyLl9pbml0aWFsaXplR2VzdHVyZVN0YXRlKGdlc3R1cmVTdGF0ZSk7CgogICAgICB2YXIgcGFuSGFuZGxlcnMgPSB7CiAgICAgICAgb25TdGFydFNob3VsZFNldFJlc3BvbmRlcjogZnVuY3Rpb24gb25TdGFydFNob3VsZFNldFJlc3BvbmRlcihlKSB7CiAgICAgICAgICByZXR1cm4gY29uZmlnLm9uU3RhcnRTaG91bGRTZXRQYW5SZXNwb25kZXIgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogY29uZmlnLm9uU3RhcnRTaG91bGRTZXRQYW5SZXNwb25kZXIoZSwgZ2VzdHVyZVN0YXRlKTsKICAgICAgICB9LAogICAgICAgIG9uTW92ZVNob3VsZFNldFJlc3BvbmRlcjogZnVuY3Rpb24gb25Nb3ZlU2hvdWxkU2V0UmVzcG9uZGVyKGUpIHsKICAgICAgICAgIHJldHVybiBjb25maWcub25Nb3ZlU2hvdWxkU2V0UGFuUmVzcG9uZGVyID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IGNvbmZpZy5vbk1vdmVTaG91bGRTZXRQYW5SZXNwb25kZXIoZSwgZ2VzdHVyZVN0YXRlKTsKICAgICAgICB9LAogICAgICAgIG9uU3RhcnRTaG91bGRTZXRSZXNwb25kZXJDYXB0dXJlOiBmdW5jdGlvbiBvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyQ2FwdHVyZShlKSB7CiAgICAgICAgICBpZiAoZS5uYXRpdmVFdmVudC50b3VjaGVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICBQYW5SZXNwb25kZXIuX2luaXRpYWxpemVHZXN0dXJlU3RhdGUoZ2VzdHVyZVN0YXRlKTsKICAgICAgICAgIH0KCiAgICAgICAgICBnZXN0dXJlU3RhdGUubnVtYmVyQWN0aXZlVG91Y2hlcyA9IGUudG91Y2hIaXN0b3J5Lm51bWJlckFjdGl2ZVRvdWNoZXM7CiAgICAgICAgICByZXR1cm4gY29uZmlnLm9uU3RhcnRTaG91bGRTZXRQYW5SZXNwb25kZXJDYXB0dXJlICE9PSB1bmRlZmluZWQgPyBjb25maWcub25TdGFydFNob3VsZFNldFBhblJlc3BvbmRlckNhcHR1cmUoZSwgZ2VzdHVyZVN0YXRlKSA6IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgb25Nb3ZlU2hvdWxkU2V0UmVzcG9uZGVyQ2FwdHVyZTogZnVuY3Rpb24gb25Nb3ZlU2hvdWxkU2V0UmVzcG9uZGVyQ2FwdHVyZShlKSB7CiAgICAgICAgICB2YXIgdG91Y2hIaXN0b3J5ID0gZS50b3VjaEhpc3Rvcnk7CgogICAgICAgICAgaWYgKGdlc3R1cmVTdGF0ZS5fYWNjb3VudHNGb3JNb3Zlc1VwVG8gPT09IHRvdWNoSGlzdG9yeS5tb3N0UmVjZW50VGltZVN0YW1wKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBQYW5SZXNwb25kZXIuX3VwZGF0ZUdlc3R1cmVTdGF0ZU9uTW92ZShnZXN0dXJlU3RhdGUsIHRvdWNoSGlzdG9yeSk7CgogICAgICAgICAgcmV0dXJuIGNvbmZpZy5vbk1vdmVTaG91bGRTZXRQYW5SZXNwb25kZXJDYXB0dXJlID8gY29uZmlnLm9uTW92ZVNob3VsZFNldFBhblJlc3BvbmRlckNhcHR1cmUoZSwgZ2VzdHVyZVN0YXRlKSA6IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgb25SZXNwb25kZXJHcmFudDogZnVuY3Rpb24gb25SZXNwb25kZXJHcmFudChlKSB7CiAgICAgICAgICBpZiAoIWludGVyYWN0aW9uU3RhdGUuaGFuZGxlKSB7CiAgICAgICAgICAgIGludGVyYWN0aW9uU3RhdGUuaGFuZGxlID0gSW50ZXJhY3Rpb25NYW5hZ2VyLmNyZWF0ZUludGVyYWN0aW9uSGFuZGxlKCk7CiAgICAgICAgICB9CgogICAgICAgICAgZ2VzdHVyZVN0YXRlLngwID0gY3VycmVudENlbnRyb2lkWChlLnRvdWNoSGlzdG9yeSk7CiAgICAgICAgICBnZXN0dXJlU3RhdGUueTAgPSBjdXJyZW50Q2VudHJvaWRZKGUudG91Y2hIaXN0b3J5KTsKICAgICAgICAgIGdlc3R1cmVTdGF0ZS5keCA9IDA7CiAgICAgICAgICBnZXN0dXJlU3RhdGUuZHkgPSAwOwoKICAgICAgICAgIGlmIChjb25maWcub25QYW5SZXNwb25kZXJHcmFudCkgewogICAgICAgICAgICBjb25maWcub25QYW5SZXNwb25kZXJHcmFudChlLCBnZXN0dXJlU3RhdGUpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBjb25maWcub25TaG91bGRCbG9ja05hdGl2ZVJlc3BvbmRlciA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6IGNvbmZpZy5vblNob3VsZEJsb2NrTmF0aXZlUmVzcG9uZGVyKCk7CiAgICAgICAgfSwKICAgICAgICBvblJlc3BvbmRlclJlamVjdDogZnVuY3Rpb24gb25SZXNwb25kZXJSZWplY3QoZSkgewogICAgICAgICAgY2xlYXJJbnRlcmFjdGlvbkhhbmRsZShpbnRlcmFjdGlvblN0YXRlLCBjb25maWcub25QYW5SZXNwb25kZXJSZWplY3QsIGUsIGdlc3R1cmVTdGF0ZSk7CiAgICAgICAgfSwKICAgICAgICBvblJlc3BvbmRlclJlbGVhc2U6IGZ1bmN0aW9uIG9uUmVzcG9uZGVyUmVsZWFzZShlKSB7CiAgICAgICAgICBjbGVhckludGVyYWN0aW9uSGFuZGxlKGludGVyYWN0aW9uU3RhdGUsIGNvbmZpZy5vblBhblJlc3BvbmRlclJlbGVhc2UsIGUsIGdlc3R1cmVTdGF0ZSk7CgogICAgICAgICAgUGFuUmVzcG9uZGVyLl9pbml0aWFsaXplR2VzdHVyZVN0YXRlKGdlc3R1cmVTdGF0ZSk7CiAgICAgICAgfSwKICAgICAgICBvblJlc3BvbmRlclN0YXJ0OiBmdW5jdGlvbiBvblJlc3BvbmRlclN0YXJ0KGUpIHsKICAgICAgICAgIHZhciB0b3VjaEhpc3RvcnkgPSBlLnRvdWNoSGlzdG9yeTsKICAgICAgICAgIGdlc3R1cmVTdGF0ZS5udW1iZXJBY3RpdmVUb3VjaGVzID0gdG91Y2hIaXN0b3J5Lm51bWJlckFjdGl2ZVRvdWNoZXM7CgogICAgICAgICAgaWYgKGNvbmZpZy5vblBhblJlc3BvbmRlclN0YXJ0KSB7CiAgICAgICAgICAgIGNvbmZpZy5vblBhblJlc3BvbmRlclN0YXJ0KGUsIGdlc3R1cmVTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBvblJlc3BvbmRlck1vdmU6IGZ1bmN0aW9uIG9uUmVzcG9uZGVyTW92ZShlKSB7CiAgICAgICAgICB2YXIgdG91Y2hIaXN0b3J5ID0gZS50b3VjaEhpc3Rvcnk7CgogICAgICAgICAgaWYgKGdlc3R1cmVTdGF0ZS5fYWNjb3VudHNGb3JNb3Zlc1VwVG8gPT09IHRvdWNoSGlzdG9yeS5tb3N0UmVjZW50VGltZVN0YW1wKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBQYW5SZXNwb25kZXIuX3VwZGF0ZUdlc3R1cmVTdGF0ZU9uTW92ZShnZXN0dXJlU3RhdGUsIHRvdWNoSGlzdG9yeSk7CgogICAgICAgICAgaWYgKGNvbmZpZy5vblBhblJlc3BvbmRlck1vdmUpIHsKICAgICAgICAgICAgY29uZmlnLm9uUGFuUmVzcG9uZGVyTW92ZShlLCBnZXN0dXJlU3RhdGUpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgb25SZXNwb25kZXJFbmQ6IGZ1bmN0aW9uIG9uUmVzcG9uZGVyRW5kKGUpIHsKICAgICAgICAgIHZhciB0b3VjaEhpc3RvcnkgPSBlLnRvdWNoSGlzdG9yeTsKICAgICAgICAgIGdlc3R1cmVTdGF0ZS5udW1iZXJBY3RpdmVUb3VjaGVzID0gdG91Y2hIaXN0b3J5Lm51bWJlckFjdGl2ZVRvdWNoZXM7CiAgICAgICAgICBjbGVhckludGVyYWN0aW9uSGFuZGxlKGludGVyYWN0aW9uU3RhdGUsIGNvbmZpZy5vblBhblJlc3BvbmRlckVuZCwgZSwgZ2VzdHVyZVN0YXRlKTsKICAgICAgICB9LAogICAgICAgIG9uUmVzcG9uZGVyVGVybWluYXRlOiBmdW5jdGlvbiBvblJlc3BvbmRlclRlcm1pbmF0ZShlKSB7CiAgICAgICAgICBjbGVhckludGVyYWN0aW9uSGFuZGxlKGludGVyYWN0aW9uU3RhdGUsIGNvbmZpZy5vblBhblJlc3BvbmRlclRlcm1pbmF0ZSwgZSwgZ2VzdHVyZVN0YXRlKTsKCiAgICAgICAgICBQYW5SZXNwb25kZXIuX2luaXRpYWxpemVHZXN0dXJlU3RhdGUoZ2VzdHVyZVN0YXRlKTsKICAgICAgICB9LAogICAgICAgIG9uUmVzcG9uZGVyVGVybWluYXRpb25SZXF1ZXN0OiBmdW5jdGlvbiBvblJlc3BvbmRlclRlcm1pbmF0aW9uUmVxdWVzdChlKSB7CiAgICAgICAgICByZXR1cm4gY29uZmlnLm9uUGFuUmVzcG9uZGVyVGVybWluYXRpb25SZXF1ZXN0ID09PSB1bmRlZmluZWQgPyB0cnVlIDogY29uZmlnLm9uUGFuUmVzcG9uZGVyVGVybWluYXRpb25SZXF1ZXN0KGUsIGdlc3R1cmVTdGF0ZSk7CiAgICAgICAgfQogICAgICB9OwogICAgICByZXR1cm4gewogICAgICAgIHBhbkhhbmRsZXJzOiBwYW5IYW5kbGVycywKICAgICAgICBnZXRJbnRlcmFjdGlvbkhhbmRsZTogZnVuY3Rpb24gZ2V0SW50ZXJhY3Rpb25IYW5kbGUoKSB7CiAgICAgICAgICByZXR1cm4gaW50ZXJhY3Rpb25TdGF0ZS5oYW5kbGU7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH07CgogIGZ1bmN0aW9uIGNsZWFySW50ZXJhY3Rpb25IYW5kbGUoaW50ZXJhY3Rpb25TdGF0ZSwgY2FsbGJhY2ssIGV2ZW50LCBnZXN0dXJlU3RhdGUpIHsKICAgIGlmIChpbnRlcmFjdGlvblN0YXRlLmhhbmRsZSkgewogICAgICBJbnRlcmFjdGlvbk1hbmFnZXIuY2xlYXJJbnRlcmFjdGlvbkhhbmRsZShpbnRlcmFjdGlvblN0YXRlLmhhbmRsZSk7CiAgICAgIGludGVyYWN0aW9uU3RhdGUuaGFuZGxlID0gbnVsbDsKICAgIH0KCiAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2soZXZlbnQsIGdlc3R1cmVTdGF0ZSk7CiAgICB9CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IFBhblJlc3BvbmRlcjsKfSwyOTQsWzIwMiwyOTVdLCJQYW5SZXNwb25kZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfcmVxdWlyZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJSZWFjdE5hdGl2ZSIpLAogICAgICBfX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IF9yZXF1aXJlLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwoKICBtb2R1bGUuZXhwb3J0cyA9IF9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVELlRvdWNoSGlzdG9yeU1hdGg7Cn0sMjk1LFsyMV0sIlRvdWNoSGlzdG9yeU1hdGgiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfY2xhc3MsCiAgICAgIF90ZW1wLAogICAgICBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9FeHBlcmltZW50YWwvU3dpcGVhYmxlUm93L1N3aXBlYWJsZUxpc3RWaWV3LmpzIjsKCiAgdmFyIExpc3RWaWV3ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkxpc3RWaWV3Iik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUmVhY3QiKTsKCiAgdmFyIFN3aXBlYWJsZUxpc3RWaWV3RGF0YVNvdXJjZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJTd2lwZWFibGVMaXN0Vmlld0RhdGFTb3VyY2UiKTsKCiAgdmFyIFN3aXBlYWJsZVJvdyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNF0sICJTd2lwZWFibGVSb3ciKTsKCiAgdmFyIFN3aXBlYWJsZUxpc3RWaWV3ID0gKF90ZW1wID0gX2NsYXNzID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhTd2lwZWFibGVMaXN0VmlldywgX1JlYWN0JENvbXBvbmVudCk7CiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoU3dpcGVhYmxlTGlzdFZpZXcsIG51bGwsIFt7CiAgICAgIGtleTogImdldE5ld0RhdGFTb3VyY2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0TmV3RGF0YVNvdXJjZSgpIHsKICAgICAgICByZXR1cm4gbmV3IFN3aXBlYWJsZUxpc3RWaWV3RGF0YVNvdXJjZSh7CiAgICAgICAgICBnZXRSb3dEYXRhOiBmdW5jdGlvbiBnZXRSb3dEYXRhKGRhdGEsIHNlY3Rpb25JRCwgcm93SUQpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGFbc2VjdGlvbklEXVtyb3dJRF07CiAgICAgICAgICB9LAogICAgICAgICAgZ2V0U2VjdGlvbkhlYWRlckRhdGE6IGZ1bmN0aW9uIGdldFNlY3Rpb25IZWFkZXJEYXRhKGRhdGEsIHNlY3Rpb25JRCkgewogICAgICAgICAgICByZXR1cm4gZGF0YVtzZWN0aW9uSURdOwogICAgICAgICAgfSwKICAgICAgICAgIHJvd0hhc0NoYW5nZWQ6IGZ1bmN0aW9uIHJvd0hhc0NoYW5nZWQocm93MSwgcm93MikgewogICAgICAgICAgICByZXR1cm4gcm93MSAhPT0gcm93MjsKICAgICAgICAgIH0sCiAgICAgICAgICBzZWN0aW9uSGVhZGVySGFzQ2hhbmdlZDogZnVuY3Rpb24gc2VjdGlvbkhlYWRlckhhc0NoYW5nZWQoczEsIHMyKSB7CiAgICAgICAgICAgIHJldHVybiBzMSAhPT0gczI7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH1dKTsKCiAgICBmdW5jdGlvbiBTd2lwZWFibGVMaXN0Vmlldyhwcm9wcywgY29udGV4dCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgU3dpcGVhYmxlTGlzdFZpZXcpOwoKICAgICAgdmFyIF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKFN3aXBlYWJsZUxpc3RWaWV3Ll9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoU3dpcGVhYmxlTGlzdFZpZXcpKS5jYWxsKHRoaXMsIHByb3BzLCBjb250ZXh0KSk7CgogICAgICBfdGhpcy5fbGlzdFZpZXdSZWYgPSBudWxsOwogICAgICBfdGhpcy5fc2hvdWxkQm91bmNlRmlyc3RSb3dPbk1vdW50ID0gZmFsc2U7CgogICAgICBfdGhpcy5fb25TY3JvbGwgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIGlmIChfdGhpcy5wcm9wcy5kYXRhU291cmNlLmdldE9wZW5Sb3dJRCgpKSB7CiAgICAgICAgICBfdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICAgIGRhdGFTb3VyY2U6IF90aGlzLnN0YXRlLmRhdGFTb3VyY2Uuc2V0T3BlblJvd0lEKG51bGwpCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF90aGlzLnByb3BzLm9uU2Nyb2xsICYmIF90aGlzLnByb3BzLm9uU2Nyb2xsKGUpOwogICAgICB9OwoKICAgICAgX3RoaXMuX3JlbmRlclJvdyA9IGZ1bmN0aW9uIChyb3dEYXRhLCBzZWN0aW9uSUQsIHJvd0lEKSB7CiAgICAgICAgdmFyIHNsaWRlb3V0VmlldyA9IF90aGlzLnByb3BzLnJlbmRlclF1aWNrQWN0aW9ucyhyb3dEYXRhLCBzZWN0aW9uSUQsIHJvd0lEKTsKCiAgICAgICAgaWYgKCFzbGlkZW91dFZpZXcpIHsKICAgICAgICAgIHJldHVybiBfdGhpcy5wcm9wcy5yZW5kZXJSb3cocm93RGF0YSwgc2VjdGlvbklELCByb3dJRCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgc2hvdWxkQm91bmNlT25Nb3VudCA9IGZhbHNlOwoKICAgICAgICBpZiAoX3RoaXMuX3Nob3VsZEJvdW5jZUZpcnN0Um93T25Nb3VudCkgewogICAgICAgICAgX3RoaXMuX3Nob3VsZEJvdW5jZUZpcnN0Um93T25Nb3VudCA9IGZhbHNlOwogICAgICAgICAgc2hvdWxkQm91bmNlT25Nb3VudCA9IHJvd0lEID09PSBfdGhpcy5wcm9wcy5kYXRhU291cmNlLmdldEZpcnN0Um93SUQoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgU3dpcGVhYmxlUm93LAogICAgICAgICAgewogICAgICAgICAgICBzbGlkZW91dFZpZXc6IHNsaWRlb3V0VmlldywKICAgICAgICAgICAgaXNPcGVuOiByb3dEYXRhLmlkID09PSBfdGhpcy5wcm9wcy5kYXRhU291cmNlLmdldE9wZW5Sb3dJRCgpLAogICAgICAgICAgICBtYXhTd2lwZURpc3RhbmNlOiBfdGhpcy5fZ2V0TWF4U3dpcGVEaXN0YW5jZShyb3dEYXRhLCBzZWN0aW9uSUQsIHJvd0lEKSwKICAgICAgICAgICAga2V5OiByb3dJRCwKICAgICAgICAgICAgb25PcGVuOiBmdW5jdGlvbiBvbk9wZW4oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9vbk9wZW4ocm93RGF0YS5pZCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uQ2xvc2U6IGZ1bmN0aW9uIG9uQ2xvc2UoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9vbkNsb3NlKHJvd0RhdGEuaWQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblN3aXBlRW5kOiBmdW5jdGlvbiBvblN3aXBlRW5kKCkgewogICAgICAgICAgICAgIHJldHVybiBfdGhpcy5fc2V0TGlzdFZpZXdTY3JvbGxhYmxlKHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvblN3aXBlU3RhcnQ6IGZ1bmN0aW9uIG9uU3dpcGVTdGFydCgpIHsKICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX3NldExpc3RWaWV3U2Nyb2xsYWJsZShmYWxzZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNob3VsZEJvdW5jZU9uTW91bnQ6IHNob3VsZEJvdW5jZU9uTW91bnQsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAxODUKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIF90aGlzLnByb3BzLnJlbmRlclJvdyhyb3dEYXRhLCBzZWN0aW9uSUQsIHJvd0lEKQogICAgICAgICk7CiAgICAgIH07CgogICAgICBfdGhpcy5fc2hvdWxkQm91bmNlRmlyc3RSb3dPbk1vdW50ID0gX3RoaXMucHJvcHMuYm91bmNlRmlyc3RSb3dPbk1vdW50OwogICAgICBfdGhpcy5zdGF0ZSA9IHsKICAgICAgICBkYXRhU291cmNlOiBfdGhpcy5wcm9wcy5kYXRhU291cmNlCiAgICAgIH07CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoU3dpcGVhYmxlTGlzdFZpZXcsIFt7CiAgICAgIGtleTogImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHMpIHsKICAgICAgICBpZiAodGhpcy5zdGF0ZS5kYXRhU291cmNlLmdldERhdGFTb3VyY2UoKSAhPT0gbmV4dFByb3BzLmRhdGFTb3VyY2UuZ2V0RGF0YVNvdXJjZSgpKSB7CiAgICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgZGF0YVNvdXJjZTogbmV4dFByb3BzLmRhdGFTb3VyY2UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW5kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChMaXN0VmlldywgYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHRoaXMucHJvcHMsIHsKICAgICAgICAgIHJlZjogZnVuY3Rpb24gcmVmKF9yZWYpIHsKICAgICAgICAgICAgX3RoaXMyLl9saXN0Vmlld1JlZiA9IF9yZWY7CiAgICAgICAgICB9LAogICAgICAgICAgZGF0YVNvdXJjZTogdGhpcy5zdGF0ZS5kYXRhU291cmNlLmdldERhdGFTb3VyY2UoKSwKICAgICAgICAgIG9uU2Nyb2xsOiB0aGlzLl9vblNjcm9sbCwKICAgICAgICAgIHJlbmRlclJvdzogdGhpcy5fcmVuZGVyUm93LAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogMTE4CiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9zZXRMaXN0Vmlld1Njcm9sbGFibGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX3NldExpc3RWaWV3U2Nyb2xsYWJsZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLl9saXN0Vmlld1JlZiAmJiB0eXBlb2YgdGhpcy5fbGlzdFZpZXdSZWYuc2V0TmF0aXZlUHJvcHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHRoaXMuX2xpc3RWaWV3UmVmLnNldE5hdGl2ZVByb3BzKHsKICAgICAgICAgICAgc2Nyb2xsRW5hYmxlZDogdmFsdWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRTY3JvbGxSZXNwb25kZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0U2Nyb2xsUmVzcG9uZGVyKCkgewogICAgICAgIGlmICh0aGlzLl9saXN0Vmlld1JlZiAmJiB0eXBlb2YgdGhpcy5fbGlzdFZpZXdSZWYuZ2V0U2Nyb2xsUmVzcG9uZGVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fbGlzdFZpZXdSZWYuZ2V0U2Nyb2xsUmVzcG9uZGVyKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9nZXRNYXhTd2lwZURpc3RhbmNlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRNYXhTd2lwZURpc3RhbmNlKHJvd0RhdGEsIHNlY3Rpb25JRCwgcm93SUQpIHsKICAgICAgICBpZiAodHlwZW9mIHRoaXMucHJvcHMubWF4U3dpcGVEaXN0YW5jZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMubWF4U3dpcGVEaXN0YW5jZShyb3dEYXRhLCBzZWN0aW9uSUQsIHJvd0lEKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLnByb3BzLm1heFN3aXBlRGlzdGFuY2U7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX29uT3BlbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfb25PcGVuKHJvd0lEKSB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICBkYXRhU291cmNlOiB0aGlzLnN0YXRlLmRhdGFTb3VyY2Uuc2V0T3BlblJvd0lEKHJvd0lEKQogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9vbkNsb3NlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9vbkNsb3NlKHJvd0lEKSB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICBkYXRhU291cmNlOiB0aGlzLnN0YXRlLmRhdGFTb3VyY2Uuc2V0T3BlblJvd0lEKG51bGwpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBTd2lwZWFibGVMaXN0VmlldzsKICB9KFJlYWN0LkNvbXBvbmVudCksIF9jbGFzcy5wcm9wVHlwZXMgPSB7CiAgICBib3VuY2VGaXJzdFJvd09uTW91bnQ6IFByb3BUeXBlcy5ib29sLmlzUmVxdWlyZWQsCiAgICBkYXRhU291cmNlOiBQcm9wVHlwZXMuaW5zdGFuY2VPZihTd2lwZWFibGVMaXN0Vmlld0RhdGFTb3VyY2UpLmlzUmVxdWlyZWQsCiAgICBtYXhTd2lwZURpc3RhbmNlOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMubnVtYmVyLCBQcm9wVHlwZXMuZnVuY10pLmlzUmVxdWlyZWQsCiAgICByZW5kZXJSb3c6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsCiAgICByZW5kZXJRdWlja0FjdGlvbnM6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQKICB9LCBfY2xhc3MuZGVmYXVsdFByb3BzID0gewogICAgYm91bmNlRmlyc3RSb3dPbk1vdW50OiBmYWxzZSwKICAgIHJlbmRlclF1aWNrQWN0aW9uczogZnVuY3Rpb24gcmVuZGVyUXVpY2tBY3Rpb25zKCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9LCBfdGVtcCk7CiAgbW9kdWxlLmV4cG9ydHMgPSBTd2lwZWFibGVMaXN0VmlldzsKfSwyOTYsWzI0MSwxMjcsMTMwLDI5NywyOTNdLCJTd2lwZWFibGVMaXN0VmlldyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIExpc3RWaWV3RGF0YVNvdXJjZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJMaXN0Vmlld0RhdGFTb3VyY2UiKTsKCiAgdmFyIFN3aXBlYWJsZUxpc3RWaWV3RGF0YVNvdXJjZSA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFN3aXBlYWJsZUxpc3RWaWV3RGF0YVNvdXJjZShwYXJhbXMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBTd2lwZWFibGVMaXN0Vmlld0RhdGFTb3VyY2UpOwogICAgICB0aGlzLl9kYXRhU291cmNlID0gbmV3IExpc3RWaWV3RGF0YVNvdXJjZSh7CiAgICAgICAgZ2V0Um93RGF0YTogcGFyYW1zLmdldFJvd0RhdGEsCiAgICAgICAgZ2V0U2VjdGlvbkhlYWRlckRhdGE6IHBhcmFtcy5nZXRTZWN0aW9uSGVhZGVyRGF0YSwKICAgICAgICByb3dIYXNDaGFuZ2VkOiBmdW5jdGlvbiByb3dIYXNDaGFuZ2VkKHJvdzEsIHJvdzIpIHsKICAgICAgICAgIHJldHVybiByb3cxLmlkICE9PSBfdGhpcy5fcHJldmlvdXNPcGVuUm93SUQgJiYgcm93Mi5pZCA9PT0gX3RoaXMuX29wZW5Sb3dJRCB8fCByb3cxLmlkID09PSBfdGhpcy5fcHJldmlvdXNPcGVuUm93SUQgJiYgcm93Mi5pZCAhPT0gX3RoaXMuX29wZW5Sb3dJRCB8fCBwYXJhbXMucm93SGFzQ2hhbmdlZChyb3cxLCByb3cyKTsKICAgICAgICB9LAogICAgICAgIHNlY3Rpb25IZWFkZXJIYXNDaGFuZ2VkOiBwYXJhbXMuc2VjdGlvbkhlYWRlckhhc0NoYW5nZWQKICAgICAgfSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFN3aXBlYWJsZUxpc3RWaWV3RGF0YVNvdXJjZSwgW3sKICAgICAga2V5OiAiY2xvbmVXaXRoUm93c0FuZFNlY3Rpb25zIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNsb25lV2l0aFJvd3NBbmRTZWN0aW9ucyhkYXRhQmxvYiwgc2VjdGlvbklkZW50aXRpZXMsIHJvd0lkZW50aXRpZXMpIHsKICAgICAgICB0aGlzLl9kYXRhU291cmNlID0gdGhpcy5fZGF0YVNvdXJjZS5jbG9uZVdpdGhSb3dzQW5kU2VjdGlvbnMoZGF0YUJsb2IsIHNlY3Rpb25JZGVudGl0aWVzLCByb3dJZGVudGl0aWVzKTsKICAgICAgICB0aGlzLl9kYXRhQmxvYiA9IGRhdGFCbG9iOwogICAgICAgIHRoaXMucm93SWRlbnRpdGllcyA9IHRoaXMuX2RhdGFTb3VyY2Uucm93SWRlbnRpdGllczsKICAgICAgICB0aGlzLnNlY3Rpb25JZGVudGl0aWVzID0gdGhpcy5fZGF0YVNvdXJjZS5zZWN0aW9uSWRlbnRpdGllczsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXREYXRhU291cmNlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldERhdGFTb3VyY2UoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2RhdGFTb3VyY2U7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0T3BlblJvd0lEIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldE9wZW5Sb3dJRCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fb3BlblJvd0lEOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldEZpcnN0Um93SUQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0Rmlyc3RSb3dJRCgpIHsKICAgICAgICBpZiAodGhpcy5yb3dJZGVudGl0aWVzKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5yb3dJZGVudGl0aWVzWzBdICYmIHRoaXMucm93SWRlbnRpdGllc1swXVswXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLl9kYXRhQmxvYilbMF07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0TGFzdFJvd0lEIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldExhc3RSb3dJRCgpIHsKICAgICAgICBpZiAodGhpcy5yb3dJZGVudGl0aWVzICYmIHRoaXMucm93SWRlbnRpdGllcy5sZW5ndGgpIHsKICAgICAgICAgIHZhciBsYXN0U2VjdGlvbiA9IHRoaXMucm93SWRlbnRpdGllc1t0aGlzLnJvd0lkZW50aXRpZXMubGVuZ3RoIC0gMV07CgogICAgICAgICAgaWYgKGxhc3RTZWN0aW9uICYmIGxhc3RTZWN0aW9uLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gbGFzdFNlY3Rpb25bbGFzdFNlY3Rpb24ubGVuZ3RoIC0gMV07CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5fZGF0YUJsb2IpW3RoaXMuX2RhdGFCbG9iLmxlbmd0aCAtIDFdOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNldE9wZW5Sb3dJRCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRPcGVuUm93SUQocm93SUQpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c09wZW5Sb3dJRCA9IHRoaXMuX29wZW5Sb3dJRDsKICAgICAgICB0aGlzLl9vcGVuUm93SUQgPSByb3dJRDsKICAgICAgICB0aGlzLl9kYXRhU291cmNlID0gdGhpcy5fZGF0YVNvdXJjZS5jbG9uZVdpdGhSb3dzQW5kU2VjdGlvbnModGhpcy5fZGF0YUJsb2IsIHRoaXMuc2VjdGlvbklkZW50aXRpZXMsIHRoaXMucm93SWRlbnRpdGllcyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBTd2lwZWFibGVMaXN0Vmlld0RhdGFTb3VyY2U7CiAgfSgpOwoKICBtb2R1bGUuZXhwb3J0cyA9IFN3aXBlYWJsZUxpc3RWaWV3RGF0YVNvdXJjZTsKfSwyOTcsWzI0Ml0sIlN3aXBlYWJsZUxpc3RWaWV3RGF0YVNvdXJjZSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9jbGFzcywKICAgICAgX3RlbXAsCiAgICAgIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvbXBvbmVudHMvVGFiQmFySU9TL1RhYkJhcklPUy5hbmRyb2lkLmpzIjsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0Iik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIFRhYkJhckl0ZW1JT1MgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiVGFiQmFySXRlbUlPUyIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJWaWV3Iik7CgogIHZhciBEdW1teVRhYkJhcklPUyA9IChfdGVtcCA9IF9jbGFzcyA9IGZ1bmN0aW9uIChfUmVhY3QkQ29tcG9uZW50KSB7CiAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoRHVtbXlUYWJCYXJJT1MsIF9SZWFjdCRDb21wb25lbnQpOwoKICAgIGZ1bmN0aW9uIER1bW15VGFiQmFySU9TKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgRHVtbXlUYWJCYXJJT1MpOwogICAgICByZXR1cm4gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKER1bW15VGFiQmFySU9TLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoRHVtbXlUYWJCYXJJT1MpKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoRHVtbXlUYWJCYXJJT1MsIFt7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBWaWV3LAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogW3RoaXMucHJvcHMuc3R5bGUsIHN0eWxlcy50YWJHcm91cF0sCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAyNQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgdGhpcy5wcm9wcy5jaGlsZHJlbgogICAgICAgICk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBEdW1teVRhYkJhcklPUzsKICB9KFJlYWN0LkNvbXBvbmVudCksIF9jbGFzcy5JdGVtID0gVGFiQmFySXRlbUlPUywgX3RlbXApOwogIHZhciBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7CiAgICB0YWJHcm91cDogewogICAgICBmbGV4OiAxCiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBEdW1teVRhYkJhcklPUzsKfSwyOTgsWzEzMCwxNjgsMjk5LDE3MF0sIlRhYkJhcklPUyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvbXBvbmVudHMvVGFiQmFySU9TL1RhYkJhckl0ZW1JT1MuYW5kcm9pZC5qcyI7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJSZWFjdCIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJWaWV3Iik7CgogIHZhciBTdHlsZVNoZWV0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlN0eWxlU2hlZXQiKTsKCiAgdmFyIER1bW15VGFiID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhEdW1teVRhYiwgX1JlYWN0JENvbXBvbmVudCk7CgogICAgZnVuY3Rpb24gRHVtbXlUYWIoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBEdW1teVRhYik7CiAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoRHVtbXlUYWIuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihEdW1teVRhYikpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhEdW1teVRhYiwgW3sKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICBpZiAoIXRoaXMucHJvcHMuc2VsZWN0ZWQpIHsKICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFZpZXcsIHsKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDIxCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBWaWV3LAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogW3RoaXMucHJvcHMuc3R5bGUsIHN0eWxlcy50YWJdLAogICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgbGluZU51bWJlcjogMjQKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHRoaXMucHJvcHMuY2hpbGRyZW4KICAgICAgICApOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gRHVtbXlUYWI7CiAgfShSZWFjdC5Db21wb25lbnQpOwoKICB2YXIgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoewogICAgdGFiOiB7CiAgICAgIHRvcDogMCwKICAgICAgcmlnaHQ6IDAsCiAgICAgIGJvdHRvbTogMCwKICAgICAgbGVmdDogMCwKICAgICAgYm9yZGVyQ29sb3I6ICdyZWQnLAogICAgICBib3JkZXJXaWR0aDogMQogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gRHVtbXlUYWI7Cn0sMjk5LFsxMzAsMTcwLDE2OF0sIlRhYkJhckl0ZW1JT1MiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfanN4RmlsZU5hbWUgPSAiL2hvbWUvaG9qaW4vZGV2L2lnbml0ZS9UZXh0VGVzdC9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9Db21wb25lbnRzL1RleHRJbnB1dC9UZXh0SW5wdXQuanMiOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBEb2N1bWVudFNlbGVjdGlvblN0YXRlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkRvY3VtZW50U2VsZWN0aW9uU3RhdGUiKTsKCiAgdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJFdmVudEVtaXR0ZXIiKTsKCiAgdmFyIE5hdGl2ZU1ldGhvZHNNaXhpbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJOYXRpdmVNZXRob2RzTWl4aW4iKTsKCiAgdmFyIFBsYXRmb3JtID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlBsYXRmb3JtIik7CgogIHZhciBSZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJSZWFjdCIpOwoKICB2YXIgY3JlYXRlUmVhY3RDbGFzcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJjcmVhdGUtcmVhY3QtY2xhc3MiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJwcm9wLXR5cGVzIik7CgogIHZhciBSZWFjdE5hdGl2ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOF0sICJSZWFjdE5hdGl2ZSIpOwoKICB2YXIgU3R5bGVTaGVldCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOV0sICJTdHlsZVNoZWV0Iik7CgogIHZhciBUZXh0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMF0sICJUZXh0Iik7CgogIHZhciBUZXh0SW5wdXRTdGF0ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTFdLCAiVGV4dElucHV0U3RhdGUiKTsKCiAgdmFyIFRpbWVyTWl4aW4gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEyXSwgInJlYWN0LXRpbWVyLW1peGluIik7CgogIHZhciBUb3VjaGFibGVXaXRob3V0RmVlZGJhY2sgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEzXSwgIlRvdWNoYWJsZVdpdGhvdXRGZWVkYmFjayIpOwoKICB2YXIgVUlNYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxNF0sICJVSU1hbmFnZXIiKTsKCiAgdmFyIFZpZXdQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE1XSwgIlZpZXdQcm9wVHlwZXMiKTsKCiAgdmFyIGVtcHR5RnVuY3Rpb24gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzE2XSwgImZianMvbGliL2VtcHR5RnVuY3Rpb24iKTsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTddLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciByZXF1aXJlTmF0aXZlQ29tcG9uZW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxOF0sICJyZXF1aXJlTmF0aXZlQ29tcG9uZW50Iik7CgogIHZhciB3YXJuaW5nID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxOV0sICJmYmpzL2xpYi93YXJuaW5nIik7CgogIHZhciBvbmx5TXVsdGlsaW5lID0gewogICAgb25UZXh0SW5wdXQ6IHRydWUsCiAgICBjaGlsZHJlbjogdHJ1ZQogIH07CgogIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICB2YXIgQW5kcm9pZFRleHRJbnB1dCA9IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoJ0FuZHJvaWRUZXh0SW5wdXQnLCBudWxsKTsKICB9IGVsc2UgaWYgKFBsYXRmb3JtLk9TID09PSAnaW9zJykgewogICAgdmFyIFJDVFRleHRWaWV3ID0gcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCgnUkNUVGV4dFZpZXcnLCBudWxsKTsKICAgIHZhciBSQ1RUZXh0RmllbGQgPSByZXF1aXJlTmF0aXZlQ29tcG9uZW50KCdSQ1RUZXh0RmllbGQnLCBudWxsKTsKICB9CgogIHZhciBEYXRhRGV0ZWN0b3JUeXBlcyA9IFsncGhvbmVOdW1iZXInLCAnbGluaycsICdhZGRyZXNzJywgJ2NhbGVuZGFyRXZlbnQnLCAnbm9uZScsICdhbGwnXTsKICB2YXIgVGV4dElucHV0ID0gY3JlYXRlUmVhY3RDbGFzcyh7CiAgICBkaXNwbGF5TmFtZTogJ1RleHRJbnB1dCcsCiAgICBzdGF0aWNzOiB7CiAgICAgIFN0YXRlOiBUZXh0SW5wdXRTdGF0ZQogICAgfSwKICAgIHByb3BUeXBlczogYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIFZpZXdQcm9wVHlwZXMsIHsKICAgICAgYXV0b0NhcGl0YWxpemU6IFByb3BUeXBlcy5vbmVPZihbJ25vbmUnLCAnc2VudGVuY2VzJywgJ3dvcmRzJywgJ2NoYXJhY3RlcnMnXSksCiAgICAgIGF1dG9Db3JyZWN0OiBQcm9wVHlwZXMuYm9vbCwKICAgICAgc3BlbGxDaGVjazogUHJvcFR5cGVzLmJvb2wsCiAgICAgIGF1dG9Gb2N1czogUHJvcFR5cGVzLmJvb2wsCiAgICAgIGF1dG9Hcm93OiBQcm9wVHlwZXMuYm9vbCwKICAgICAgYWxsb3dGb250U2NhbGluZzogUHJvcFR5cGVzLmJvb2wsCiAgICAgIGVkaXRhYmxlOiBQcm9wVHlwZXMuYm9vbCwKICAgICAga2V5Ym9hcmRUeXBlOiBQcm9wVHlwZXMub25lT2YoWydkZWZhdWx0JywgJ2VtYWlsLWFkZHJlc3MnLCAnbnVtZXJpYycsICdwaG9uZS1wYWQnLCAnYXNjaWktY2FwYWJsZScsICdudW1iZXJzLWFuZC1wdW5jdHVhdGlvbicsICd1cmwnLCAnbnVtYmVyLXBhZCcsICduYW1lLXBob25lLXBhZCcsICdkZWNpbWFsLXBhZCcsICd0d2l0dGVyJywgJ3dlYi1zZWFyY2gnLCAndmlzaWJsZS1wYXNzd29yZCddKSwKICAgICAga2V5Ym9hcmRBcHBlYXJhbmNlOiBQcm9wVHlwZXMub25lT2YoWydkZWZhdWx0JywgJ2xpZ2h0JywgJ2RhcmsnXSksCiAgICAgIHJldHVybktleVR5cGU6IFByb3BUeXBlcy5vbmVPZihbJ2RvbmUnLCAnZ28nLCAnbmV4dCcsICdzZWFyY2gnLCAnc2VuZCcsICdub25lJywgJ3ByZXZpb3VzJywgJ2RlZmF1bHQnLCAnZW1lcmdlbmN5LWNhbGwnLCAnZ29vZ2xlJywgJ2pvaW4nLCAncm91dGUnLCAneWFob28nXSksCiAgICAgIHJldHVybktleUxhYmVsOiBQcm9wVHlwZXMuc3RyaW5nLAogICAgICBtYXhMZW5ndGg6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgIG1heEhlaWdodDogUHJvcFR5cGVzLm51bWJlciwKICAgICAgbnVtYmVyT2ZMaW5lczogUHJvcFR5cGVzLm51bWJlciwKICAgICAgZGlzYWJsZUZ1bGxzY3JlZW5VSTogUHJvcFR5cGVzLmJvb2wsCiAgICAgIGVuYWJsZXNSZXR1cm5LZXlBdXRvbWF0aWNhbGx5OiBQcm9wVHlwZXMuYm9vbCwKICAgICAgbXVsdGlsaW5lOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgdGV4dEJyZWFrU3RyYXRlZ3k6IFByb3BUeXBlcy5vbmVPZihbJ3NpbXBsZScsICdoaWdoUXVhbGl0eScsICdiYWxhbmNlZCddKSwKICAgICAgb25CbHVyOiBQcm9wVHlwZXMuZnVuYywKICAgICAgb25Gb2N1czogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uQ2hhbmdlOiBQcm9wVHlwZXMuZnVuYywKICAgICAgb25DaGFuZ2VUZXh0OiBQcm9wVHlwZXMuZnVuYywKICAgICAgb25Db250ZW50U2l6ZUNoYW5nZTogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uRW5kRWRpdGluZzogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uU2VsZWN0aW9uQ2hhbmdlOiBQcm9wVHlwZXMuZnVuYywKICAgICAgb25TdWJtaXRFZGl0aW5nOiBQcm9wVHlwZXMuZnVuYywKICAgICAgb25LZXlQcmVzczogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uTGF5b3V0OiBQcm9wVHlwZXMuZnVuYywKICAgICAgb25TY3JvbGw6IFByb3BUeXBlcy5mdW5jLAogICAgICBwbGFjZWhvbGRlcjogUHJvcFR5cGVzLnN0cmluZywKICAgICAgcGxhY2Vob2xkZXJUZXh0Q29sb3I6IENvbG9yUHJvcFR5cGUsCiAgICAgIHNlY3VyZVRleHRFbnRyeTogUHJvcFR5cGVzLmJvb2wsCiAgICAgIHNlbGVjdGlvbkNvbG9yOiBDb2xvclByb3BUeXBlLAogICAgICBzZWxlY3Rpb25TdGF0ZTogUHJvcFR5cGVzLmluc3RhbmNlT2YoRG9jdW1lbnRTZWxlY3Rpb25TdGF0ZSksCiAgICAgIHNlbGVjdGlvbjogUHJvcFR5cGVzLnNoYXBlKHsKICAgICAgICBzdGFydDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLAogICAgICAgIGVuZDogUHJvcFR5cGVzLm51bWJlcgogICAgICB9KSwKICAgICAgdmFsdWU6IFByb3BUeXBlcy5zdHJpbmcsCiAgICAgIGRlZmF1bHRWYWx1ZTogUHJvcFR5cGVzLnN0cmluZywKICAgICAgY2xlYXJCdXR0b25Nb2RlOiBQcm9wVHlwZXMub25lT2YoWyduZXZlcicsICd3aGlsZS1lZGl0aW5nJywgJ3VubGVzcy1lZGl0aW5nJywgJ2Fsd2F5cyddKSwKICAgICAgY2xlYXJUZXh0T25Gb2N1czogUHJvcFR5cGVzLmJvb2wsCiAgICAgIHNlbGVjdFRleHRPbkZvY3VzOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgYmx1ck9uU3VibWl0OiBQcm9wVHlwZXMuYm9vbCwKICAgICAgc3R5bGU6IFRleHQucHJvcFR5cGVzLnN0eWxlLAogICAgICB1bmRlcmxpbmVDb2xvckFuZHJvaWQ6IENvbG9yUHJvcFR5cGUsCiAgICAgIGlubGluZUltYWdlTGVmdDogUHJvcFR5cGVzLnN0cmluZywKICAgICAgaW5saW5lSW1hZ2VQYWRkaW5nOiBQcm9wVHlwZXMubnVtYmVyLAogICAgICBkYXRhRGV0ZWN0b3JUeXBlczogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLm9uZU9mKERhdGFEZXRlY3RvclR5cGVzKSwgUHJvcFR5cGVzLmFycmF5T2YoUHJvcFR5cGVzLm9uZU9mKERhdGFEZXRlY3RvclR5cGVzKSldKSwKICAgICAgY2FyZXRIaWRkZW46IFByb3BUeXBlcy5ib29sCiAgICB9KSwKICAgIGdldERlZmF1bHRQcm9wczogZnVuY3Rpb24gZ2V0RGVmYXVsdFByb3BzKCkgewogICAgICByZXR1cm4gewogICAgICAgIGFsbG93Rm9udFNjYWxpbmc6IHRydWUKICAgICAgfTsKICAgIH0sCiAgICBtaXhpbnM6IFtOYXRpdmVNZXRob2RzTWl4aW4sIFRpbWVyTWl4aW5dLAogICAgZ2V0SW5pdGlhbFN0YXRlOiBmdW5jdGlvbiBnZXRJbml0aWFsU3RhdGUoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgbGF5b3V0SGVpZ2h0OiB0aGlzLl9sYXlvdXRIZWlnaHQKICAgICAgfTsKICAgIH0sCiAgICBpc0ZvY3VzZWQ6IGZ1bmN0aW9uIGlzRm9jdXNlZCgpIHsKICAgICAgcmV0dXJuIFRleHRJbnB1dFN0YXRlLmN1cnJlbnRseUZvY3VzZWRGaWVsZCgpID09PSBSZWFjdE5hdGl2ZS5maW5kTm9kZUhhbmRsZSh0aGlzLl9pbnB1dFJlZik7CiAgICB9LAogICAgY29udGV4dFR5cGVzOiB7CiAgICAgIG9uRm9jdXNSZXF1ZXN0ZWQ6IFByb3BUeXBlcy5mdW5jLAogICAgICBmb2N1c0VtaXR0ZXI6IFByb3BUeXBlcy5pbnN0YW5jZU9mKEV2ZW50RW1pdHRlcikKICAgIH0sCiAgICBfaW5wdXRSZWY6IHVuZGVmaW5lZCwKICAgIF9mb2N1c1N1YnNjcmlwdGlvbjogdW5kZWZpbmVkLAogICAgX2xhc3ROYXRpdmVUZXh0OiB1bmRlZmluZWQsCiAgICBfbGFzdE5hdGl2ZVNlbGVjdGlvbjogdW5kZWZpbmVkLAogICAgX2xheW91dEhlaWdodDogLTEsCiAgICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24gY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB0aGlzLl9sYXN0TmF0aXZlVGV4dCA9IHRoaXMucHJvcHMudmFsdWU7CgogICAgICBpZiAoIXRoaXMuY29udGV4dC5mb2N1c0VtaXR0ZXIpIHsKICAgICAgICBpZiAodGhpcy5wcm9wcy5hdXRvRm9jdXMpIHsKICAgICAgICAgIHRoaXMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuZm9jdXMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9mb2N1c1N1YnNjcmlwdGlvbiA9IHRoaXMuY29udGV4dC5mb2N1c0VtaXR0ZXIuYWRkTGlzdGVuZXIoJ2ZvY3VzJywgZnVuY3Rpb24gKGVsKSB7CiAgICAgICAgaWYgKF90aGlzID09PSBlbCkgewogICAgICAgICAgX3RoaXMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKF90aGlzLmZvY3VzKTsKICAgICAgICB9IGVsc2UgaWYgKF90aGlzLmlzRm9jdXNlZCgpKSB7CiAgICAgICAgICBfdGhpcy5ibHVyKCk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGlmICh0aGlzLnByb3BzLmF1dG9Gb2N1cykgewogICAgICAgIHRoaXMuY29udGV4dC5vbkZvY3VzUmVxdWVzdGVkKHRoaXMpOwogICAgICB9CiAgICB9LAogICAgY29tcG9uZW50V2lsbFVubW91bnQ6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICB0aGlzLl9mb2N1c1N1YnNjcmlwdGlvbiAmJiB0aGlzLl9mb2N1c1N1YnNjcmlwdGlvbi5yZW1vdmUoKTsKCiAgICAgIGlmICh0aGlzLmlzRm9jdXNlZCgpKSB7CiAgICAgICAgdGhpcy5ibHVyKCk7CiAgICAgIH0KICAgIH0sCiAgICBnZXRDaGlsZENvbnRleHQ6IGZ1bmN0aW9uIGdldENoaWxkQ29udGV4dCgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBpc0luQVBhcmVudFRleHQ6IHRydWUKICAgICAgfTsKICAgIH0sCiAgICBjaGlsZENvbnRleHRUeXBlczogewogICAgICBpc0luQVBhcmVudFRleHQ6IFByb3BUeXBlcy5ib29sCiAgICB9LAogICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICB0aGlzLnNldE5hdGl2ZVByb3BzKHsKICAgICAgICB0ZXh0OiAnJwogICAgICB9KTsKICAgIH0sCiAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgaWYgKFBsYXRmb3JtLk9TID09PSAnaW9zJykgewogICAgICAgIHJldHVybiB0aGlzLl9yZW5kZXJJT1MoKTsKICAgICAgfSBlbHNlIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JlbmRlckFuZHJvaWQoKTsKICAgICAgfQogICAgfSwKICAgIF9nZXRUZXh0OiBmdW5jdGlvbiBfZ2V0VGV4dCgpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB0aGlzLnByb3BzLnZhbHVlID09PSAnc3RyaW5nJyA/IHRoaXMucHJvcHMudmFsdWUgOiB0eXBlb2YgdGhpcy5wcm9wcy5kZWZhdWx0VmFsdWUgPT09ICdzdHJpbmcnID8gdGhpcy5wcm9wcy5kZWZhdWx0VmFsdWUgOiAnJzsKICAgIH0sCiAgICBfc2V0TmF0aXZlUmVmOiBmdW5jdGlvbiBfc2V0TmF0aXZlUmVmKHJlZikgewogICAgICB0aGlzLl9pbnB1dFJlZiA9IHJlZjsKICAgIH0sCiAgICBfcmVuZGVySU9TOiBmdW5jdGlvbiBfcmVuZGVySU9TKCkgewogICAgICB2YXIgdGV4dENvbnRhaW5lcjsKICAgICAgdmFyIHByb3BzID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHRoaXMucHJvcHMpOwogICAgICBwcm9wcy5zdHlsZSA9IFt0aGlzLnByb3BzLnN0eWxlXTsKCiAgICAgIGlmIChwcm9wcy5zZWxlY3Rpb24gJiYgcHJvcHMuc2VsZWN0aW9uLmVuZCA9PSBudWxsKSB7CiAgICAgICAgcHJvcHMuc2VsZWN0aW9uID0gewogICAgICAgICAgc3RhcnQ6IHByb3BzLnNlbGVjdGlvbi5zdGFydCwKICAgICAgICAgIGVuZDogcHJvcHMuc2VsZWN0aW9uLnN0YXJ0CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgaWYgKCFwcm9wcy5tdWx0aWxpbmUpIHsKICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiBvbmx5TXVsdGlsaW5lKSB7CiAgICAgICAgICAgIGlmIChwcm9wc1twcm9wS2V5XSkgewogICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcignVGV4dElucHV0IHByb3AgYCcgKyBwcm9wS2V5ICsgJ2AgaXMgb25seSBzdXBwb3J0ZWQgd2l0aCBtdWx0aWxpbmUuJyk7CiAgICAgICAgICAgICAgd2FybmluZyhmYWxzZSwgJyVzJywgZXJyb3Iuc3RhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0ZXh0Q29udGFpbmVyID0gUmVhY3QuY3JlYXRlRWxlbWVudChSQ1RUZXh0RmllbGQsIGJhYmVsSGVscGVycy5leHRlbmRzKHsKICAgICAgICAgIHJlZjogdGhpcy5fc2V0TmF0aXZlUmVmCiAgICAgICAgfSwgcHJvcHMsIHsKICAgICAgICAgIG9uRm9jdXM6IHRoaXMuX29uRm9jdXMsCiAgICAgICAgICBvbkJsdXI6IHRoaXMuX29uQmx1ciwKICAgICAgICAgIG9uQ2hhbmdlOiB0aGlzLl9vbkNoYW5nZSwKICAgICAgICAgIG9uU2VsZWN0aW9uQ2hhbmdlOiB0aGlzLl9vblNlbGVjdGlvbkNoYW5nZSwKICAgICAgICAgIG9uU2VsZWN0aW9uQ2hhbmdlU2hvdWxkU2V0UmVzcG9uZGVyOiBlbXB0eUZ1bmN0aW9uLnRoYXRSZXR1cm5zVHJ1ZSwKICAgICAgICAgIHRleHQ6IHRoaXMuX2dldFRleHQoKSwKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDcyNwogICAgICAgICAgfQogICAgICAgIH0pKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgY2hpbGRyZW4gPSBwcm9wcy5jaGlsZHJlbjsKICAgICAgICB2YXIgY2hpbGRDb3VudCA9IDA7CiAgICAgICAgUmVhY3QuQ2hpbGRyZW4uZm9yRWFjaChjaGlsZHJlbiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuICsrY2hpbGRDb3VudDsKICAgICAgICB9KTsKICAgICAgICBpbnZhcmlhbnQoIShwcm9wcy52YWx1ZSAmJiBjaGlsZENvdW50KSwgJ0Nhbm5vdCBzcGVjaWZ5IGJvdGggdmFsdWUgYW5kIGNoaWxkcmVuLicpOwoKICAgICAgICBpZiAoY2hpbGRDb3VudCA+PSAxKSB7CiAgICAgICAgICBjaGlsZHJlbiA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIFRleHQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdHlsZTogcHJvcHMuc3R5bGUsCiAgICAgICAgICAgICAgYWxsb3dGb250U2NhbGluZzogcHJvcHMuYWxsb3dGb250U2NhbGluZywKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDc0NgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW4KICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICBpZiAocHJvcHMuaW5wdXRWaWV3KSB7CiAgICAgICAgICBjaGlsZHJlbiA9IFtjaGlsZHJlbiwgcHJvcHMuaW5wdXRWaWV3XTsKICAgICAgICB9CgogICAgICAgIHByb3BzLnN0eWxlLnVuc2hpZnQoc3R5bGVzLm11bHRpbGluZUlucHV0KTsKICAgICAgICB0ZXh0Q29udGFpbmVyID0gUmVhY3QuY3JlYXRlRWxlbWVudChSQ1RUZXh0VmlldywgYmFiZWxIZWxwZXJzLmV4dGVuZHMoewogICAgICAgICAgcmVmOiB0aGlzLl9zZXROYXRpdmVSZWYKICAgICAgICB9LCBwcm9wcywgewogICAgICAgICAgY2hpbGRyZW46IGNoaWxkcmVuLAogICAgICAgICAgb25Gb2N1czogdGhpcy5fb25Gb2N1cywKICAgICAgICAgIG9uQmx1cjogdGhpcy5fb25CbHVyLAogICAgICAgICAgb25DaGFuZ2U6IHRoaXMuX29uQ2hhbmdlLAogICAgICAgICAgb25Db250ZW50U2l6ZUNoYW5nZTogdGhpcy5wcm9wcy5vbkNvbnRlbnRTaXplQ2hhbmdlLAogICAgICAgICAgb25TZWxlY3Rpb25DaGFuZ2U6IHRoaXMuX29uU2VsZWN0aW9uQ2hhbmdlLAogICAgICAgICAgb25UZXh0SW5wdXQ6IHRoaXMuX29uVGV4dElucHV0LAogICAgICAgICAgb25TZWxlY3Rpb25DaGFuZ2VTaG91bGRTZXRSZXNwb25kZXI6IGVtcHR5RnVuY3Rpb24udGhhdFJldHVybnNUcnVlLAogICAgICAgICAgdGV4dDogdGhpcy5fZ2V0VGV4dCgpLAogICAgICAgICAgZGF0YURldGVjdG9yVHlwZXM6IHRoaXMucHJvcHMuZGF0YURldGVjdG9yVHlwZXMsCiAgICAgICAgICBvblNjcm9sbDogdGhpcy5fb25TY3JvbGwsCiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiA3NTMKICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgIFRvdWNoYWJsZVdpdGhvdXRGZWVkYmFjaywKICAgICAgICB7CiAgICAgICAgICBvbkxheW91dDogcHJvcHMub25MYXlvdXQsCiAgICAgICAgICBvblByZXNzOiB0aGlzLl9vblByZXNzLAogICAgICAgICAgcmVqZWN0UmVzcG9uZGVyVGVybWluYXRpb246IHRydWUsCiAgICAgICAgICBhY2Nlc3NpYmxlOiBwcm9wcy5hY2Nlc3NpYmxlLAogICAgICAgICAgYWNjZXNzaWJpbGl0eUxhYmVsOiBwcm9wcy5hY2Nlc3NpYmlsaXR5TGFiZWwsCiAgICAgICAgICBhY2Nlc3NpYmlsaXR5VHJhaXRzOiBwcm9wcy5hY2Nlc3NpYmlsaXR5VHJhaXRzLAogICAgICAgICAgbmF0aXZlSUQ6IHRoaXMucHJvcHMubmF0aXZlSUQsCiAgICAgICAgICB0ZXN0SUQ6IHByb3BzLnRlc3RJRCwKICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgIGxpbmVOdW1iZXI6IDc3MAogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdGV4dENvbnRhaW5lcgogICAgICApOwogICAgfSwKICAgIF9yZW5kZXJBbmRyb2lkOiBmdW5jdGlvbiBfcmVuZGVyQW5kcm9pZCgpIHsKICAgICAgdmFyIHByb3BzID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHRoaXMucHJvcHMpOwogICAgICBwcm9wcy5zdHlsZSA9IHRoaXMucHJvcHMuc3R5bGU7CgogICAgICBpZiAodGhpcy5zdGF0ZS5sYXlvdXRIZWlnaHQgPj0gMCkgewogICAgICAgIHByb3BzLnN0eWxlID0gW3Byb3BzLnN0eWxlLCB7CiAgICAgICAgICBoZWlnaHQ6IHRoaXMuc3RhdGUubGF5b3V0SGVpZ2h0CiAgICAgICAgfV07CiAgICAgIH0KCiAgICAgIHByb3BzLmF1dG9DYXBpdGFsaXplID0gVUlNYW5hZ2VyLkFuZHJvaWRUZXh0SW5wdXQuQ29uc3RhbnRzLkF1dG9DYXBpdGFsaXphdGlvblR5cGVbcHJvcHMuYXV0b0NhcGl0YWxpemUgfHwgJ3NlbnRlbmNlcyddOwogICAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLnByb3BzLmNoaWxkcmVuOwogICAgICB2YXIgY2hpbGRDb3VudCA9IDA7CiAgICAgIFJlYWN0LkNoaWxkcmVuLmZvckVhY2goY2hpbGRyZW4sIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKytjaGlsZENvdW50OwogICAgICB9KTsKICAgICAgaW52YXJpYW50KCEodGhpcy5wcm9wcy52YWx1ZSAmJiBjaGlsZENvdW50KSwgJ0Nhbm5vdCBzcGVjaWZ5IGJvdGggdmFsdWUgYW5kIGNoaWxkcmVuLicpOwoKICAgICAgaWYgKGNoaWxkQ291bnQgPiAxKSB7CiAgICAgICAgY2hpbGRyZW4gPSBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgICAgVGV4dCwKICAgICAgICAgIHsKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDgwNQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgY2hpbGRyZW4KICAgICAgICApOwogICAgICB9CgogICAgICBpZiAocHJvcHMuc2VsZWN0aW9uICYmIHByb3BzLnNlbGVjdGlvbi5lbmQgPT0gbnVsbCkgewogICAgICAgIHByb3BzLnNlbGVjdGlvbiA9IHsKICAgICAgICAgIHN0YXJ0OiBwcm9wcy5zZWxlY3Rpb24uc3RhcnQsCiAgICAgICAgICBlbmQ6IHByb3BzLnNlbGVjdGlvbi5zdGFydAogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHZhciB0ZXh0Q29udGFpbmVyID0gUmVhY3QuY3JlYXRlRWxlbWVudChBbmRyb2lkVGV4dElucHV0LCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7CiAgICAgICAgcmVmOiB0aGlzLl9zZXROYXRpdmVSZWYKICAgICAgfSwgcHJvcHMsIHsKICAgICAgICBtb3N0UmVjZW50RXZlbnRDb3VudDogMCwKICAgICAgICBvbkZvY3VzOiB0aGlzLl9vbkZvY3VzLAogICAgICAgIG9uQmx1cjogdGhpcy5fb25CbHVyLAogICAgICAgIG9uQ2hhbmdlOiB0aGlzLl9vbkNoYW5nZSwKICAgICAgICBvbkNvbnRlbnRTaXplQ2hhbmdlOiB0aGlzLl9vbkNvbnRlbnRTaXplQ2hhbmdlLAogICAgICAgIG9uU2VsZWN0aW9uQ2hhbmdlOiB0aGlzLl9vblNlbGVjdGlvbkNoYW5nZSwKICAgICAgICBvblRleHRJbnB1dDogdGhpcy5fb25UZXh0SW5wdXQsCiAgICAgICAgdGV4dDogdGhpcy5fZ2V0VGV4dCgpLAogICAgICAgIGNoaWxkcmVuOiBjaGlsZHJlbiwKICAgICAgICBkaXNhYmxlRnVsbHNjcmVlblVJOiB0aGlzLnByb3BzLmRpc2FibGVGdWxsc2NyZWVuVUksCiAgICAgICAgdGV4dEJyZWFrU3RyYXRlZ3k6IHRoaXMucHJvcHMudGV4dEJyZWFrU3RyYXRlZ3ksCiAgICAgICAgb25TY3JvbGw6IHRoaXMuX29uU2Nyb2xsLAogICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgbGluZU51bWJlcjogODExCiAgICAgICAgfQogICAgICB9KSk7CiAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgIFRvdWNoYWJsZVdpdGhvdXRGZWVkYmFjaywKICAgICAgICB7CiAgICAgICAgICBvbkxheW91dDogdGhpcy5fb25MYXlvdXQsCiAgICAgICAgICBvblByZXNzOiB0aGlzLl9vblByZXNzLAogICAgICAgICAgYWNjZXNzaWJsZTogdGhpcy5wcm9wcy5hY2Nlc3NpYmxlLAogICAgICAgICAgYWNjZXNzaWJpbGl0eUxhYmVsOiB0aGlzLnByb3BzLmFjY2Vzc2liaWxpdHlMYWJlbCwKICAgICAgICAgIGFjY2Vzc2liaWxpdHlDb21wb25lbnRUeXBlOiB0aGlzLnByb3BzLmFjY2Vzc2liaWxpdHlDb21wb25lbnRUeXBlLAogICAgICAgICAgbmF0aXZlSUQ6IHRoaXMucHJvcHMubmF0aXZlSUQsCiAgICAgICAgICB0ZXN0SUQ6IHRoaXMucHJvcHMudGVzdElELAogICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgbGluZU51bWJlcjogODI5CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICB0ZXh0Q29udGFpbmVyCiAgICAgICk7CiAgICB9LAogICAgX29uRm9jdXM6IGZ1bmN0aW9uIF9vbkZvY3VzKGV2ZW50KSB7CiAgICAgIGlmICh0aGlzLnByb3BzLm9uRm9jdXMpIHsKICAgICAgICB0aGlzLnByb3BzLm9uRm9jdXMoZXZlbnQpOwogICAgICB9CgogICAgICBpZiAodGhpcy5wcm9wcy5zZWxlY3Rpb25TdGF0ZSkgewogICAgICAgIHRoaXMucHJvcHMuc2VsZWN0aW9uU3RhdGUuZm9jdXMoKTsKICAgICAgfQogICAgfSwKICAgIF9vblByZXNzOiBmdW5jdGlvbiBfb25QcmVzcyhldmVudCkgewogICAgICBpZiAodGhpcy5wcm9wcy5lZGl0YWJsZSB8fCB0aGlzLnByb3BzLmVkaXRhYmxlID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLmZvY3VzKCk7CiAgICAgIH0KICAgIH0sCiAgICBfb25DaGFuZ2U6IGZ1bmN0aW9uIF9vbkNoYW5nZShldmVudCkgewogICAgICBpZiAodGhpcy5faW5wdXRSZWYpIHsKICAgICAgICB0aGlzLl9pbnB1dFJlZi5zZXROYXRpdmVQcm9wcyh7CiAgICAgICAgICBtb3N0UmVjZW50RXZlbnRDb3VudDogZXZlbnQubmF0aXZlRXZlbnQuZXZlbnRDb3VudAogICAgICAgIH0pOwogICAgICB9CgogICAgICB2YXIgdGV4dCA9IGV2ZW50Lm5hdGl2ZUV2ZW50LnRleHQ7CiAgICAgIHRoaXMucHJvcHMub25DaGFuZ2UgJiYgdGhpcy5wcm9wcy5vbkNoYW5nZShldmVudCk7CiAgICAgIHRoaXMucHJvcHMub25DaGFuZ2VUZXh0ICYmIHRoaXMucHJvcHMub25DaGFuZ2VUZXh0KHRleHQpOwoKICAgICAgaWYgKCF0aGlzLl9pbnB1dFJlZikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5fbGFzdE5hdGl2ZVRleHQgPSB0ZXh0OwogICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7CiAgICB9LAogICAgX29uQ29udGVudFNpemVDaGFuZ2U6IGZ1bmN0aW9uIF9vbkNvbnRlbnRTaXplQ2hhbmdlKGV2ZW50KSB7CiAgICAgIHZhciBjb250ZW50SGVpZ2h0ID0gZXZlbnQubmF0aXZlRXZlbnQuY29udGVudFNpemUuaGVpZ2h0OwoKICAgICAgaWYgKHRoaXMucHJvcHMuYXV0b0dyb3cpIHsKICAgICAgICBpZiAodGhpcy5wcm9wcy5tYXhIZWlnaHQpIHsKICAgICAgICAgIGNvbnRlbnRIZWlnaHQgPSBNYXRoLm1pbih0aGlzLnByb3BzLm1heEhlaWdodCwgY29udGVudEhlaWdodCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgIGxheW91dEhlaWdodDogTWF0aC5tYXgodGhpcy5fbGF5b3V0SGVpZ2h0LCBjb250ZW50SGVpZ2h0KQogICAgICAgIH0pOwogICAgICB9CgogICAgICB0aGlzLnByb3BzLm9uQ29udGVudFNpemVDaGFuZ2UgJiYgdGhpcy5wcm9wcy5vbkNvbnRlbnRTaXplQ2hhbmdlKGV2ZW50KTsKICAgIH0sCiAgICBfb25MYXlvdXQ6IGZ1bmN0aW9uIF9vbkxheW91dChldmVudCkgewogICAgICB2YXIgaGVpZ2h0ID0gZXZlbnQubmF0aXZlRXZlbnQubGF5b3V0LmhlaWdodDsKCiAgICAgIGlmIChoZWlnaHQpIHsKICAgICAgICB0aGlzLl9sYXlvdXRIZWlnaHQgPSBldmVudC5uYXRpdmVFdmVudC5sYXlvdXQuaGVpZ2h0OwogICAgICB9CgogICAgICB0aGlzLnByb3BzLm9uTGF5b3V0ICYmIHRoaXMucHJvcHMub25MYXlvdXQoZXZlbnQpOwogICAgfSwKICAgIF9vblNlbGVjdGlvbkNoYW5nZTogZnVuY3Rpb24gX29uU2VsZWN0aW9uQ2hhbmdlKGV2ZW50KSB7CiAgICAgIHRoaXMucHJvcHMub25TZWxlY3Rpb25DaGFuZ2UgJiYgdGhpcy5wcm9wcy5vblNlbGVjdGlvbkNoYW5nZShldmVudCk7CgogICAgICBpZiAoIXRoaXMuX2lucHV0UmVmKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLl9sYXN0TmF0aXZlU2VsZWN0aW9uID0gZXZlbnQubmF0aXZlRXZlbnQuc2VsZWN0aW9uOwoKICAgICAgaWYgKHRoaXMucHJvcHMuc2VsZWN0aW9uIHx8IHRoaXMucHJvcHMuc2VsZWN0aW9uU3RhdGUpIHsKICAgICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7CiAgICAgIH0KICAgIH0sCiAgICBjb21wb25lbnREaWRVcGRhdGU6IGZ1bmN0aW9uIGNvbXBvbmVudERpZFVwZGF0ZSgpIHsKICAgICAgdmFyIG5hdGl2ZVByb3BzID0ge307CgogICAgICBpZiAodGhpcy5fbGFzdE5hdGl2ZVRleHQgIT09IHRoaXMucHJvcHMudmFsdWUgJiYgdHlwZW9mIHRoaXMucHJvcHMudmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgbmF0aXZlUHJvcHMudGV4dCA9IHRoaXMucHJvcHMudmFsdWU7CiAgICAgIH0KCiAgICAgIHZhciBzZWxlY3Rpb24gPSB0aGlzLnByb3BzLnNlbGVjdGlvbjsKCiAgICAgIGlmICh0aGlzLl9sYXN0TmF0aXZlU2VsZWN0aW9uICYmIHNlbGVjdGlvbiAmJiAodGhpcy5fbGFzdE5hdGl2ZVNlbGVjdGlvbi5zdGFydCAhPT0gc2VsZWN0aW9uLnN0YXJ0IHx8IHRoaXMuX2xhc3ROYXRpdmVTZWxlY3Rpb24uZW5kICE9PSBzZWxlY3Rpb24uZW5kKSkgewogICAgICAgIG5hdGl2ZVByb3BzLnNlbGVjdGlvbiA9IHRoaXMucHJvcHMuc2VsZWN0aW9uOwogICAgICB9CgogICAgICBpZiAoT2JqZWN0LmtleXMobmF0aXZlUHJvcHMpLmxlbmd0aCA+IDAgJiYgdGhpcy5faW5wdXRSZWYpIHsKICAgICAgICB0aGlzLl9pbnB1dFJlZi5zZXROYXRpdmVQcm9wcyhuYXRpdmVQcm9wcyk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnByb3BzLnNlbGVjdGlvblN0YXRlICYmIHNlbGVjdGlvbikgewogICAgICAgIHRoaXMucHJvcHMuc2VsZWN0aW9uU3RhdGUudXBkYXRlKHNlbGVjdGlvbi5zdGFydCwgc2VsZWN0aW9uLmVuZCk7CiAgICAgIH0KICAgIH0sCiAgICBfb25CbHVyOiBmdW5jdGlvbiBfb25CbHVyKGV2ZW50KSB7CiAgICAgIHRoaXMuYmx1cigpOwoKICAgICAgaWYgKHRoaXMucHJvcHMub25CbHVyKSB7CiAgICAgICAgdGhpcy5wcm9wcy5vbkJsdXIoZXZlbnQpOwogICAgICB9CgogICAgICBpZiAodGhpcy5wcm9wcy5zZWxlY3Rpb25TdGF0ZSkgewogICAgICAgIHRoaXMucHJvcHMuc2VsZWN0aW9uU3RhdGUuYmx1cigpOwogICAgICB9CiAgICB9LAogICAgX29uVGV4dElucHV0OiBmdW5jdGlvbiBfb25UZXh0SW5wdXQoZXZlbnQpIHsKICAgICAgdGhpcy5wcm9wcy5vblRleHRJbnB1dCAmJiB0aGlzLnByb3BzLm9uVGV4dElucHV0KGV2ZW50KTsKICAgIH0sCiAgICBfb25TY3JvbGw6IGZ1bmN0aW9uIF9vblNjcm9sbChldmVudCkgewogICAgICB0aGlzLnByb3BzLm9uU2Nyb2xsICYmIHRoaXMucHJvcHMub25TY3JvbGwoZXZlbnQpOwogICAgfQogIH0pOwogIHZhciBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7CiAgICBtdWx0aWxpbmVJbnB1dDogewogICAgICBwYWRkaW5nVG9wOiA1CiAgICB9CiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBUZXh0SW5wdXQ7Cn0sMzAwLFsxMjMsMzAxLDY3LDEyNSw1MiwxMzAsMTcyLDEyNywyMSwxNjgsMTgxLDExNSwxOTEsMTkwLDEwNywxMzEsNTcsMTMsMTQ1LDU2XSwiVGV4dElucHV0Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgbWl4SW5FdmVudEVtaXR0ZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAibWl4SW5FdmVudEVtaXR0ZXIiKTsKCiAgdmFyIERvY3VtZW50U2VsZWN0aW9uU3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBEb2N1bWVudFNlbGVjdGlvblN0YXRlKGFuY2hvciwgZm9jdXMpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIERvY3VtZW50U2VsZWN0aW9uU3RhdGUpOwogICAgICB0aGlzLl9hbmNob3JPZmZzZXQgPSBhbmNob3I7CiAgICAgIHRoaXMuX2ZvY3VzT2Zmc2V0ID0gZm9jdXM7CiAgICAgIHRoaXMuX2hhc0ZvY3VzID0gZmFsc2U7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKERvY3VtZW50U2VsZWN0aW9uU3RhdGUsIFt7CiAgICAgIGtleTogInVwZGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiB1cGRhdGUoYW5jaG9yLCBmb2N1cykgewogICAgICAgIGlmICh0aGlzLl9hbmNob3JPZmZzZXQgIT09IGFuY2hvciB8fCB0aGlzLl9mb2N1c09mZnNldCAhPT0gZm9jdXMpIHsKICAgICAgICAgIHRoaXMuX2FuY2hvck9mZnNldCA9IGFuY2hvcjsKICAgICAgICAgIHRoaXMuX2ZvY3VzT2Zmc2V0ID0gZm9jdXM7CiAgICAgICAgICB0aGlzLmVtaXQoJ3VwZGF0ZScpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjb25zdHJhaW5MZW5ndGgiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29uc3RyYWluTGVuZ3RoKG1heExlbmd0aCkgewogICAgICAgIHRoaXMudXBkYXRlKE1hdGgubWluKHRoaXMuX2FuY2hvck9mZnNldCwgbWF4TGVuZ3RoKSwgTWF0aC5taW4odGhpcy5fZm9jdXNPZmZzZXQsIG1heExlbmd0aCkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImZvY3VzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGZvY3VzKCkgewogICAgICAgIGlmICghdGhpcy5faGFzRm9jdXMpIHsKICAgICAgICAgIHRoaXMuX2hhc0ZvY3VzID0gdHJ1ZTsKICAgICAgICAgIHRoaXMuZW1pdCgnZm9jdXMnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYmx1ciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBibHVyKCkgewogICAgICAgIGlmICh0aGlzLl9oYXNGb2N1cykgewogICAgICAgICAgdGhpcy5faGFzRm9jdXMgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuZW1pdCgnYmx1cicpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJoYXNGb2N1cyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBoYXNGb2N1cygpIHsKICAgICAgICByZXR1cm4gdGhpcy5faGFzRm9jdXM7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaXNDb2xsYXBzZWQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gaXNDb2xsYXBzZWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2FuY2hvck9mZnNldCA9PT0gdGhpcy5fZm9jdXNPZmZzZXQ7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiaXNCYWNrd2FyZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBpc0JhY2t3YXJkKCkgewogICAgICAgIHJldHVybiB0aGlzLl9hbmNob3JPZmZzZXQgPiB0aGlzLl9mb2N1c09mZnNldDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRBbmNob3JPZmZzZXQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0QW5jaG9yT2Zmc2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9oYXNGb2N1cyA/IHRoaXMuX2FuY2hvck9mZnNldCA6IG51bGw7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0Rm9jdXNPZmZzZXQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0Rm9jdXNPZmZzZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2hhc0ZvY3VzID8gdGhpcy5fZm9jdXNPZmZzZXQgOiBudWxsOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFN0YXJ0T2Zmc2V0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFN0YXJ0T2Zmc2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9oYXNGb2N1cyA/IE1hdGgubWluKHRoaXMuX2FuY2hvck9mZnNldCwgdGhpcy5fZm9jdXNPZmZzZXQpIDogbnVsbDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRFbmRPZmZzZXQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0RW5kT2Zmc2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9oYXNGb2N1cyA/IE1hdGgubWF4KHRoaXMuX2FuY2hvck9mZnNldCwgdGhpcy5fZm9jdXNPZmZzZXQpIDogbnVsbDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJvdmVybGFwcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBvdmVybGFwcyhzdGFydCwgZW5kKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaGFzRm9jdXMoKSAmJiB0aGlzLmdldFN0YXJ0T2Zmc2V0KCkgPD0gZW5kICYmIHN0YXJ0IDw9IHRoaXMuZ2V0RW5kT2Zmc2V0KCk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBEb2N1bWVudFNlbGVjdGlvblN0YXRlOwogIH0oKTsKCiAgbWl4SW5FdmVudEVtaXR0ZXIoRG9jdW1lbnRTZWxlY3Rpb25TdGF0ZSwgewogICAgJ2JsdXInOiB0cnVlLAogICAgJ2ZvY3VzJzogdHJ1ZSwKICAgICd1cGRhdGUnOiB0cnVlCiAgfSk7CiAgbW9kdWxlLmV4cG9ydHMgPSBEb2N1bWVudFNlbGVjdGlvblN0YXRlOwp9LDMwMSxbMzAyXSwiRG9jdW1lbnRTZWxlY3Rpb25TdGF0ZSIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJFdmVudEVtaXR0ZXIiKTsKCiAgdmFyIEV2ZW50RW1pdHRlcldpdGhIb2xkaW5nID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkV2ZW50RW1pdHRlcldpdGhIb2xkaW5nIik7CgogIHZhciBFdmVudEhvbGRlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJFdmVudEhvbGRlciIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIga2V5T2YgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiZmJqcy9saWIva2V5T2YiKTsKCiAgdmFyIFRZUEVTX0tFWSA9IGtleU9mKHsKICAgIF9fdHlwZXM6IHRydWUKICB9KTsKCiAgZnVuY3Rpb24gbWl4SW5FdmVudEVtaXR0ZXIoY2xzLCB0eXBlcykgewogICAgaW52YXJpYW50KHR5cGVzLCAnTXVzdCBzdXBwbHkgc2V0IG9mIHZhbGlkIGV2ZW50IHR5cGVzJyk7CiAgICB2YXIgdGFyZ2V0ID0gY2xzLnByb3RvdHlwZSB8fCBjbHM7CiAgICBpbnZhcmlhbnQoIXRhcmdldC5fX2V2ZW50RW1pdHRlciwgJ0FuIGFjdGl2ZSBlbWl0dGVyIGlzIGFscmVhZHkgbWl4ZWQgaW4nKTsKICAgIHZhciBjdG9yID0gY2xzLmNvbnN0cnVjdG9yOwoKICAgIGlmIChjdG9yKSB7CiAgICAgIGludmFyaWFudChjdG9yID09PSBPYmplY3QgfHwgY3RvciA9PT0gRnVuY3Rpb24sICdNaXggRXZlbnRFbWl0dGVyIGludG8gYSBjbGFzcywgbm90IGFuIGluc3RhbmNlJyk7CiAgICB9CgogICAgaWYgKHRhcmdldC5oYXNPd25Qcm9wZXJ0eShUWVBFU19LRVkpKSB7CiAgICAgIGJhYmVsSGVscGVycy5leHRlbmRzKHRhcmdldC5fX3R5cGVzLCB0eXBlcyk7CiAgICB9IGVsc2UgaWYgKHRhcmdldC5fX3R5cGVzKSB7CiAgICAgIHRhcmdldC5fX3R5cGVzID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIHRhcmdldC5fX3R5cGVzLCB0eXBlcyk7CiAgICB9IGVsc2UgewogICAgICB0YXJnZXQuX190eXBlcyA9IHR5cGVzOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5leHRlbmRzKHRhcmdldCwgRXZlbnRFbWl0dGVyTWl4aW4pOwogIH0KCiAgdmFyIEV2ZW50RW1pdHRlck1peGluID0gewogICAgZW1pdDogZnVuY3Rpb24gZW1pdChldmVudFR5cGUsIGEsIGIsIGMsIGQsIGUsIF8pIHsKICAgICAgcmV0dXJuIHRoaXMuX19nZXRFdmVudEVtaXR0ZXIoKS5lbWl0KGV2ZW50VHlwZSwgYSwgYiwgYywgZCwgZSwgXyk7CiAgICB9LAogICAgZW1pdEFuZEhvbGQ6IGZ1bmN0aW9uIGVtaXRBbmRIb2xkKGV2ZW50VHlwZSwgYSwgYiwgYywgZCwgZSwgXykgewogICAgICByZXR1cm4gdGhpcy5fX2dldEV2ZW50RW1pdHRlcigpLmVtaXRBbmRIb2xkKGV2ZW50VHlwZSwgYSwgYiwgYywgZCwgZSwgXyk7CiAgICB9LAogICAgYWRkTGlzdGVuZXI6IGZ1bmN0aW9uIGFkZExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMuX19nZXRFdmVudEVtaXR0ZXIoKS5hZGRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCBjb250ZXh0KTsKICAgIH0sCiAgICBvbmNlOiBmdW5jdGlvbiBvbmNlKGV2ZW50VHlwZSwgbGlzdGVuZXIsIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMuX19nZXRFdmVudEVtaXR0ZXIoKS5vbmNlKGV2ZW50VHlwZSwgbGlzdGVuZXIsIGNvbnRleHQpOwogICAgfSwKICAgIGFkZFJldHJvYWN0aXZlTGlzdGVuZXI6IGZ1bmN0aW9uIGFkZFJldHJvYWN0aXZlTGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgY29udGV4dCkgewogICAgICByZXR1cm4gdGhpcy5fX2dldEV2ZW50RW1pdHRlcigpLmFkZFJldHJvYWN0aXZlTGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgY29udGV4dCk7CiAgICB9LAogICAgYWRkTGlzdGVuZXJNYXA6IGZ1bmN0aW9uIGFkZExpc3RlbmVyTWFwKGxpc3RlbmVyTWFwLCBjb250ZXh0KSB7CiAgICAgIHJldHVybiB0aGlzLl9fZ2V0RXZlbnRFbWl0dGVyKCkuYWRkTGlzdGVuZXJNYXAobGlzdGVuZXJNYXAsIGNvbnRleHQpOwogICAgfSwKICAgIGFkZFJldHJvYWN0aXZlTGlzdGVuZXJNYXA6IGZ1bmN0aW9uIGFkZFJldHJvYWN0aXZlTGlzdGVuZXJNYXAobGlzdGVuZXJNYXAsIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMuX19nZXRFdmVudEVtaXR0ZXIoKS5hZGRMaXN0ZW5lck1hcChsaXN0ZW5lck1hcCwgY29udGV4dCk7CiAgICB9LAogICAgcmVtb3ZlQWxsTGlzdGVuZXJzOiBmdW5jdGlvbiByZW1vdmVBbGxMaXN0ZW5lcnMoKSB7CiAgICAgIHRoaXMuX19nZXRFdmVudEVtaXR0ZXIoKS5yZW1vdmVBbGxMaXN0ZW5lcnMoKTsKICAgIH0sCiAgICByZW1vdmVDdXJyZW50TGlzdGVuZXI6IGZ1bmN0aW9uIHJlbW92ZUN1cnJlbnRMaXN0ZW5lcigpIHsKICAgICAgdGhpcy5fX2dldEV2ZW50RW1pdHRlcigpLnJlbW92ZUN1cnJlbnRMaXN0ZW5lcigpOwogICAgfSwKICAgIHJlbGVhc2VIZWxkRXZlbnRUeXBlOiBmdW5jdGlvbiByZWxlYXNlSGVsZEV2ZW50VHlwZShldmVudFR5cGUpIHsKICAgICAgdGhpcy5fX2dldEV2ZW50RW1pdHRlcigpLnJlbGVhc2VIZWxkRXZlbnRUeXBlKGV2ZW50VHlwZSk7CiAgICB9LAogICAgX19nZXRFdmVudEVtaXR0ZXI6IGZ1bmN0aW9uIF9fZ2V0RXZlbnRFbWl0dGVyKCkgewogICAgICBpZiAoIXRoaXMuX19ldmVudEVtaXR0ZXIpIHsKICAgICAgICB2YXIgZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTsKCiAgICAgICAgaWYgKF9fREVWX18pIHsKICAgICAgICAgIHZhciBFdmVudFZhbGlkYXRvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJFdmVudFZhbGlkYXRvciIpOwoKICAgICAgICAgIGVtaXR0ZXIgPSBFdmVudFZhbGlkYXRvci5hZGRWYWxpZGF0aW9uKGVtaXR0ZXIsIHRoaXMuX190eXBlcyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgaG9sZGVyID0gbmV3IEV2ZW50SG9sZGVyKCk7CiAgICAgICAgdGhpcy5fX2V2ZW50RW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXJXaXRoSG9sZGluZyhlbWl0dGVyLCBob2xkZXIpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fX2V2ZW50RW1pdHRlcjsKICAgIH0KICB9OwogIG1vZHVsZS5leHBvcnRzID0gbWl4SW5FdmVudEVtaXR0ZXI7Cn0sMzAyLFs2NywzMDMsMzA0LDEzLDMwNSwzMDZdLCJtaXhJbkV2ZW50RW1pdHRlciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEV2ZW50RW1pdHRlcldpdGhIb2xkaW5nID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRXZlbnRFbWl0dGVyV2l0aEhvbGRpbmcoZW1pdHRlciwgaG9sZGVyKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBFdmVudEVtaXR0ZXJXaXRoSG9sZGluZyk7CiAgICAgIHRoaXMuX2VtaXR0ZXIgPSBlbWl0dGVyOwogICAgICB0aGlzLl9ldmVudEhvbGRlciA9IGhvbGRlcjsKICAgICAgdGhpcy5fY3VycmVudEV2ZW50VG9rZW4gPSBudWxsOwogICAgICB0aGlzLl9lbWl0dGluZ0hlbGRFdmVudHMgPSBmYWxzZTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoRXZlbnRFbWl0dGVyV2l0aEhvbGRpbmcsIFt7CiAgICAgIGtleTogImFkZExpc3RlbmVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGFkZExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIGNvbnRleHQpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZW1pdHRlci5hZGRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCBjb250ZXh0KTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJvbmNlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIG9uY2UoZXZlbnRUeXBlLCBsaXN0ZW5lciwgY29udGV4dCkgewogICAgICAgIHJldHVybiB0aGlzLl9lbWl0dGVyLm9uY2UoZXZlbnRUeXBlLCBsaXN0ZW5lciwgY29udGV4dCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYWRkUmV0cm9hY3RpdmVMaXN0ZW5lciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRSZXRyb2FjdGl2ZUxpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIGNvbnRleHQpIHsKICAgICAgICB2YXIgc3Vic2NyaXB0aW9uID0gdGhpcy5fZW1pdHRlci5hZGRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCBjb250ZXh0KTsKCiAgICAgICAgdGhpcy5fZW1pdHRpbmdIZWxkRXZlbnRzID0gdHJ1ZTsKCiAgICAgICAgdGhpcy5fZXZlbnRIb2xkZXIuZW1pdFRvTGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgY29udGV4dCk7CgogICAgICAgIHRoaXMuX2VtaXR0aW5nSGVsZEV2ZW50cyA9IGZhbHNlOwogICAgICAgIHJldHVybiBzdWJzY3JpcHRpb247CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVtb3ZlQWxsTGlzdGVuZXJzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUFsbExpc3RlbmVycyhldmVudFR5cGUpIHsKICAgICAgICB0aGlzLl9lbWl0dGVyLnJlbW92ZUFsbExpc3RlbmVycyhldmVudFR5cGUpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZUN1cnJlbnRMaXN0ZW5lciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVDdXJyZW50TGlzdGVuZXIoKSB7CiAgICAgICAgdGhpcy5fZW1pdHRlci5yZW1vdmVDdXJyZW50TGlzdGVuZXIoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJsaXN0ZW5lcnMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gbGlzdGVuZXJzKGV2ZW50VHlwZSkgewogICAgICAgIHJldHVybiB0aGlzLl9lbWl0dGVyLmxpc3RlbmVycyhldmVudFR5cGUpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImVtaXQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZW1pdChldmVudFR5cGUpIHsKICAgICAgICB2YXIgX2VtaXR0ZXI7CgogICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgfQoKICAgICAgICAoX2VtaXR0ZXIgPSB0aGlzLl9lbWl0dGVyKS5lbWl0LmFwcGx5KF9lbWl0dGVyLCBbZXZlbnRUeXBlXS5jb25jYXQoYmFiZWxIZWxwZXJzLnRvQ29uc3VtYWJsZUFycmF5KGFyZ3MpKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZW1pdEFuZEhvbGQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZW1pdEFuZEhvbGQoZXZlbnRUeXBlKSB7CiAgICAgICAgdmFyIF9ldmVudEhvbGRlciwgX2VtaXR0ZXIyOwoKICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fY3VycmVudEV2ZW50VG9rZW4gPSAoX2V2ZW50SG9sZGVyID0gdGhpcy5fZXZlbnRIb2xkZXIpLmhvbGRFdmVudC5hcHBseShfZXZlbnRIb2xkZXIsIFtldmVudFR5cGVdLmNvbmNhdChiYWJlbEhlbHBlcnMudG9Db25zdW1hYmxlQXJyYXkoYXJncykpKTsKCiAgICAgICAgKF9lbWl0dGVyMiA9IHRoaXMuX2VtaXR0ZXIpLmVtaXQuYXBwbHkoX2VtaXR0ZXIyLCBbZXZlbnRUeXBlXS5jb25jYXQoYmFiZWxIZWxwZXJzLnRvQ29uc3VtYWJsZUFycmF5KGFyZ3MpKSk7CgogICAgICAgIHRoaXMuX2N1cnJlbnRFdmVudFRva2VuID0gbnVsbDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZWxlYXNlQ3VycmVudEV2ZW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbGVhc2VDdXJyZW50RXZlbnQoKSB7CiAgICAgICAgaWYgKHRoaXMuX2N1cnJlbnRFdmVudFRva2VuKSB7CiAgICAgICAgICB0aGlzLl9ldmVudEhvbGRlci5yZWxlYXNlRXZlbnQodGhpcy5fY3VycmVudEV2ZW50VG9rZW4pOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5fZW1pdHRpbmdIZWxkRXZlbnRzKSB7CiAgICAgICAgICB0aGlzLl9ldmVudEhvbGRlci5yZWxlYXNlQ3VycmVudEV2ZW50KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbGVhc2VIZWxkRXZlbnRUeXBlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbGVhc2VIZWxkRXZlbnRUeXBlKGV2ZW50VHlwZSkgewogICAgICAgIHRoaXMuX2V2ZW50SG9sZGVyLnJlbGVhc2VFdmVudFR5cGUoZXZlbnRUeXBlKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEV2ZW50RW1pdHRlcldpdGhIb2xkaW5nOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXJXaXRoSG9sZGluZzsKfSwzMDMsW10sIkV2ZW50RW1pdHRlcldpdGhIb2xkaW5nIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgRXZlbnRIb2xkZXIgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBFdmVudEhvbGRlcigpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEV2ZW50SG9sZGVyKTsKICAgICAgdGhpcy5faGVsZEV2ZW50cyA9IHt9OwogICAgICB0aGlzLl9jdXJyZW50RXZlbnRLZXkgPSBudWxsOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhFdmVudEhvbGRlciwgW3sKICAgICAga2V5OiAiaG9sZEV2ZW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGhvbGRFdmVudChldmVudFR5cGUpIHsKICAgICAgICB0aGlzLl9oZWxkRXZlbnRzW2V2ZW50VHlwZV0gPSB0aGlzLl9oZWxkRXZlbnRzW2V2ZW50VHlwZV0gfHwgW107CiAgICAgICAgdmFyIGV2ZW50c09mVHlwZSA9IHRoaXMuX2hlbGRFdmVudHNbZXZlbnRUeXBlXTsKICAgICAgICB2YXIga2V5ID0gewogICAgICAgICAgZXZlbnRUeXBlOiBldmVudFR5cGUsCiAgICAgICAgICBpbmRleDogZXZlbnRzT2ZUeXBlLmxlbmd0aAogICAgICAgIH07CgogICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgfQoKICAgICAgICBldmVudHNPZlR5cGUucHVzaChhcmdzKTsKICAgICAgICByZXR1cm4ga2V5OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImVtaXRUb0xpc3RlbmVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGVtaXRUb0xpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIGNvbnRleHQpIHsKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICB2YXIgZXZlbnRzT2ZUeXBlID0gdGhpcy5faGVsZEV2ZW50c1tldmVudFR5cGVdOwoKICAgICAgICBpZiAoIWV2ZW50c09mVHlwZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIG9yaWdFdmVudEtleSA9IHRoaXMuX2N1cnJlbnRFdmVudEtleTsKICAgICAgICBldmVudHNPZlR5cGUuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnRIZWxkLCBpbmRleCkgewogICAgICAgICAgaWYgKCFldmVudEhlbGQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIF90aGlzLl9jdXJyZW50RXZlbnRLZXkgPSB7CiAgICAgICAgICAgIGV2ZW50VHlwZTogZXZlbnRUeXBlLAogICAgICAgICAgICBpbmRleDogaW5kZXgKICAgICAgICAgIH07CiAgICAgICAgICBsaXN0ZW5lci5hcHBseShjb250ZXh0LCBldmVudEhlbGQpOwogICAgICAgIH0pOwogICAgICAgIHRoaXMuX2N1cnJlbnRFdmVudEtleSA9IG9yaWdFdmVudEtleTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZWxlYXNlQ3VycmVudEV2ZW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbGVhc2VDdXJyZW50RXZlbnQoKSB7CiAgICAgICAgaW52YXJpYW50KHRoaXMuX2N1cnJlbnRFdmVudEtleSAhPT0gbnVsbCwgJ05vdCBpbiBhbiBlbWl0dGluZyBjeWNsZTsgdGhlcmUgaXMgbm8gY3VycmVudCBldmVudCcpOwogICAgICAgIHRoaXMuX2N1cnJlbnRFdmVudEtleSAmJiB0aGlzLnJlbGVhc2VFdmVudCh0aGlzLl9jdXJyZW50RXZlbnRLZXkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbGVhc2VFdmVudCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZWxlYXNlRXZlbnQodG9rZW4pIHsKICAgICAgICBkZWxldGUgdGhpcy5faGVsZEV2ZW50c1t0b2tlbi5ldmVudFR5cGVdW3Rva2VuLmluZGV4XTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZWxlYXNlRXZlbnRUeXBlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbGVhc2VFdmVudFR5cGUodHlwZSkgewogICAgICAgIHRoaXMuX2hlbGRFdmVudHNbdHlwZV0gPSBbXTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIEV2ZW50SG9sZGVyOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBFdmVudEhvbGRlcjsKfSwzMDQsWzEzXSwiRXZlbnRIb2xkZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAidXNlIHN0cmljdCI7CgogIHZhciBrZXlPZiA9IGZ1bmN0aW9uIGtleU9mKG9uZUtleU9iaikgewogICAgdmFyIGtleTsKCiAgICBmb3IgKGtleSBpbiBvbmVLZXlPYmopIHsKICAgICAgaWYgKCFvbmVLZXlPYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICByZXR1cm4ga2V5OwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH07CgogIG1vZHVsZS5leHBvcnRzID0ga2V5T2Y7Cn0sMzA1LFtdLCJmYmpzL2xpYi9rZXlPZi5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEV2ZW50VmFsaWRhdG9yID0gewogICAgYWRkVmFsaWRhdGlvbjogZnVuY3Rpb24gYWRkVmFsaWRhdGlvbihlbWl0dGVyLCB0eXBlcykgewogICAgICB2YXIgZXZlbnRUeXBlcyA9IE9iamVjdC5rZXlzKHR5cGVzKTsKICAgICAgdmFyIGVtaXR0ZXJXaXRoVmFsaWRhdGlvbiA9IE9iamVjdC5jcmVhdGUoZW1pdHRlcik7CiAgICAgIGJhYmVsSGVscGVycy5leHRlbmRzKGVtaXR0ZXJXaXRoVmFsaWRhdGlvbiwgewogICAgICAgIGVtaXQ6IGZ1bmN0aW9uIGVtaXQodHlwZSwgYSwgYiwgYywgZCwgZSwgXykgewogICAgICAgICAgYXNzZXJ0QWxsb3dzRXZlbnRUeXBlKHR5cGUsIGV2ZW50VHlwZXMpOwogICAgICAgICAgcmV0dXJuIGVtaXR0ZXIuZW1pdC5jYWxsKHRoaXMsIHR5cGUsIGEsIGIsIGMsIGQsIGUsIF8pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBlbWl0dGVyV2l0aFZhbGlkYXRpb247CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gYXNzZXJ0QWxsb3dzRXZlbnRUeXBlKHR5cGUsIGFsbG93ZWRUeXBlcykgewogICAgaWYgKGFsbG93ZWRUeXBlcy5pbmRleE9mKHR5cGUpID09PSAtMSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGVycm9yTWVzc2FnZUZvcih0eXBlLCBhbGxvd2VkVHlwZXMpKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGVycm9yTWVzc2FnZUZvcih0eXBlLCBhbGxvd2VkVHlwZXMpIHsKICAgIHZhciBtZXNzYWdlID0gJ1Vua25vd24gZXZlbnQgdHlwZSAiJyArIHR5cGUgKyAnIi4gJzsKCiAgICBpZiAoX19ERVZfXykgewogICAgICBtZXNzYWdlICs9IHJlY29tbWVuZGF0aW9uRm9yKHR5cGUsIGFsbG93ZWRUeXBlcyk7CiAgICB9CgogICAgbWVzc2FnZSArPSAnS25vd24gZXZlbnQgdHlwZXM6ICcgKyBhbGxvd2VkVHlwZXMuam9pbignLCAnKSArICcuJzsKICAgIHJldHVybiBtZXNzYWdlOwogIH0KCiAgaWYgKF9fREVWX18pIHsKICAgIHZhciByZWNvbW1lbmRhdGlvbkZvciA9IGZ1bmN0aW9uIHJlY29tbWVuZGF0aW9uRm9yKHR5cGUsIGFsbG93ZWRUeXBlcykgewogICAgICB2YXIgY2xvc2VzdFR5cGVSZWNvbW1lbmRhdGlvbiA9IGNsb3Nlc3RUeXBlRm9yKHR5cGUsIGFsbG93ZWRUeXBlcyk7CgogICAgICBpZiAoaXNDbG9zZUVub3VnaChjbG9zZXN0VHlwZVJlY29tbWVuZGF0aW9uLCB0eXBlKSkgewogICAgICAgIHJldHVybiAnRGlkIHlvdSBtZWFuICInICsgY2xvc2VzdFR5cGVSZWNvbW1lbmRhdGlvbi50eXBlICsgJyI/ICc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CiAgICB9OwoKICAgIHZhciBjbG9zZXN0VHlwZUZvciA9IGZ1bmN0aW9uIGNsb3Nlc3RUeXBlRm9yKHR5cGUsIGFsbG93ZWRUeXBlcykgewogICAgICB2YXIgdHlwZVJlY29tbWVuZGF0aW9ucyA9IGFsbG93ZWRUeXBlcy5tYXAodHlwZVJlY29tbWVuZGF0aW9uRm9yLmJpbmQodGhpcywgdHlwZSkpOwogICAgICByZXR1cm4gdHlwZVJlY29tbWVuZGF0aW9ucy5zb3J0KHJlY29tbWVuZGF0aW9uU29ydClbMF07CiAgICB9OwoKICAgIHZhciB0eXBlUmVjb21tZW5kYXRpb25Gb3IgPSBmdW5jdGlvbiB0eXBlUmVjb21tZW5kYXRpb25Gb3IodHlwZSwgcmVjb21lbmRlZFR5cGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB0eXBlOiByZWNvbWVuZGVkVHlwZSwKICAgICAgICBkaXN0YW5jZTogZGFtZXJhdUxldmVuc2h0ZWluRGlzdGFuY2UodHlwZSwgcmVjb21lbmRlZFR5cGUpCiAgICAgIH07CiAgICB9OwoKICAgIHZhciByZWNvbW1lbmRhdGlvblNvcnQgPSBmdW5jdGlvbiByZWNvbW1lbmRhdGlvblNvcnQocmVjb21tZW5kYXRpb25BLCByZWNvbW1lbmRhdGlvbkIpIHsKICAgICAgaWYgKHJlY29tbWVuZGF0aW9uQS5kaXN0YW5jZSA8IHJlY29tbWVuZGF0aW9uQi5kaXN0YW5jZSkgewogICAgICAgIHJldHVybiAtMTsKICAgICAgfSBlbHNlIGlmIChyZWNvbW1lbmRhdGlvbkEuZGlzdGFuY2UgPiByZWNvbW1lbmRhdGlvbkIuZGlzdGFuY2UpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgfTsKCiAgICB2YXIgaXNDbG9zZUVub3VnaCA9IGZ1bmN0aW9uIGlzQ2xvc2VFbm91Z2goY2xvc2VzdFR5cGUsIGFjdHVhbFR5cGUpIHsKICAgICAgcmV0dXJuIGNsb3Nlc3RUeXBlLmRpc3RhbmNlIC8gYWN0dWFsVHlwZS5sZW5ndGggPCAwLjMzNDsKICAgIH07CgogICAgdmFyIGRhbWVyYXVMZXZlbnNodGVpbkRpc3RhbmNlID0gZnVuY3Rpb24gZGFtZXJhdUxldmVuc2h0ZWluRGlzdGFuY2UoYSwgYikgewogICAgICB2YXIgaSA9IHZvaWQgMCwKICAgICAgICAgIGogPSB2b2lkIDA7CiAgICAgIHZhciBkID0gW107CgogICAgICBmb3IgKGkgPSAwOyBpIDw9IGEubGVuZ3RoOyBpKyspIHsKICAgICAgICBkW2ldID0gW2ldOwogICAgICB9CgogICAgICBmb3IgKGogPSAxOyBqIDw9IGIubGVuZ3RoOyBqKyspIHsKICAgICAgICBkWzBdW2pdID0gajsKICAgICAgfQoKICAgICAgZm9yIChpID0gMTsgaSA8PSBhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm9yIChqID0gMTsgaiA8PSBiLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICB2YXIgY29zdCA9IGEuY2hhckF0KGkgLSAxKSA9PT0gYi5jaGFyQXQoaiAtIDEpID8gMCA6IDE7CiAgICAgICAgICBkW2ldW2pdID0gTWF0aC5taW4oZFtpIC0gMV1bal0gKyAxLCBkW2ldW2ogLSAxXSArIDEsIGRbaSAtIDFdW2ogLSAxXSArIGNvc3QpOwoKICAgICAgICAgIGlmIChpID4gMSAmJiBqID4gMSAmJiBhLmNoYXJBdChpIC0gMSkgPT09IGIuY2hhckF0KGogLSAyKSAmJiBhLmNoYXJBdChpIC0gMikgPT09IGIuY2hhckF0KGogLSAxKSkgewogICAgICAgICAgICBkW2ldW2pdID0gTWF0aC5taW4oZFtpXVtqXSwgZFtpIC0gMl1baiAtIDJdICsgY29zdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZFthLmxlbmd0aF1bYi5sZW5ndGhdOwogICAgfTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gRXZlbnRWYWxpZGF0b3I7Cn0sMzA2LFtdLCJFdmVudFZhbGlkYXRvciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvbXBvbmVudHMvVG9vbGJhckFuZHJvaWQvVG9vbGJhckFuZHJvaWQuYW5kcm9pZC5qcyI7CgogIHZhciBJbWFnZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJJbWFnZSIpOwoKICB2YXIgTmF0aXZlTWV0aG9kc01peGluID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIk5hdGl2ZU1ldGhvZHNNaXhpbiIpOwoKICB2YXIgUmVhY3QgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUmVhY3QiKTsKCiAgdmFyIFByb3BUeXBlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJwcm9wLXR5cGVzIik7CgogIHZhciBSZWFjdE5hdGl2ZVZpZXdBdHRyaWJ1dGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlJlYWN0TmF0aXZlVmlld0F0dHJpYnV0ZXMiKTsKCiAgdmFyIFVJTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJVSU1hbmFnZXIiKTsKCiAgdmFyIFZpZXdQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAiVmlld1Byb3BUeXBlcyIpOwoKICB2YXIgQ29sb3JQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJDb2xvclByb3BUeXBlIik7CgogIHZhciBjcmVhdGVSZWFjdENsYXNzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4XSwgImNyZWF0ZS1yZWFjdC1jbGFzcyIpOwoKICB2YXIgcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOV0sICJyZXF1aXJlTmF0aXZlQ29tcG9uZW50Iik7CgogIHZhciByZXNvbHZlQXNzZXRTb3VyY2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEwXSwgInJlc29sdmVBc3NldFNvdXJjZSIpOwoKICB2YXIgb3B0aW9uYWxJbWFnZVNvdXJjZSA9IFByb3BUeXBlcy5vbmVPZlR5cGUoW0ltYWdlLnByb3BUeXBlcy5zb3VyY2UsIFByb3BUeXBlcy5vbmVPZihbXSldKTsKICB2YXIgVG9vbGJhckFuZHJvaWQgPSBjcmVhdGVSZWFjdENsYXNzKHsKICAgIGRpc3BsYXlOYW1lOiAnVG9vbGJhckFuZHJvaWQnLAogICAgbWl4aW5zOiBbTmF0aXZlTWV0aG9kc01peGluXSwKICAgIHByb3BUeXBlczogYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIFZpZXdQcm9wVHlwZXMsIHsKICAgICAgYWN0aW9uczogUHJvcFR5cGVzLmFycmF5T2YoUHJvcFR5cGVzLnNoYXBlKHsKICAgICAgICB0aXRsZTogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLAogICAgICAgIGljb246IG9wdGlvbmFsSW1hZ2VTb3VyY2UsCiAgICAgICAgc2hvdzogUHJvcFR5cGVzLm9uZU9mKFsnYWx3YXlzJywgJ2lmUm9vbScsICduZXZlciddKSwKICAgICAgICBzaG93V2l0aFRleHQ6IFByb3BUeXBlcy5ib29sCiAgICAgIH0pKSwKICAgICAgbG9nbzogb3B0aW9uYWxJbWFnZVNvdXJjZSwKICAgICAgbmF2SWNvbjogb3B0aW9uYWxJbWFnZVNvdXJjZSwKICAgICAgb25BY3Rpb25TZWxlY3RlZDogUHJvcFR5cGVzLmZ1bmMsCiAgICAgIG9uSWNvbkNsaWNrZWQ6IFByb3BUeXBlcy5mdW5jLAogICAgICBvdmVyZmxvd0ljb246IG9wdGlvbmFsSW1hZ2VTb3VyY2UsCiAgICAgIHN1YnRpdGxlOiBQcm9wVHlwZXMuc3RyaW5nLAogICAgICBzdWJ0aXRsZUNvbG9yOiBDb2xvclByb3BUeXBlLAogICAgICB0aXRsZTogUHJvcFR5cGVzLnN0cmluZywKICAgICAgdGl0bGVDb2xvcjogQ29sb3JQcm9wVHlwZSwKICAgICAgY29udGVudEluc2V0U3RhcnQ6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgIGNvbnRlbnRJbnNldEVuZDogUHJvcFR5cGVzLm51bWJlciwKICAgICAgcnRsOiBQcm9wVHlwZXMuYm9vbCwKICAgICAgdGVzdElEOiBQcm9wVHlwZXMuc3RyaW5nCiAgICB9KSwKICAgIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICB2YXIgbmF0aXZlUHJvcHMgPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcyk7CgogICAgICBpZiAodGhpcy5wcm9wcy5sb2dvKSB7CiAgICAgICAgbmF0aXZlUHJvcHMubG9nbyA9IHJlc29sdmVBc3NldFNvdXJjZSh0aGlzLnByb3BzLmxvZ28pOwogICAgICB9CgogICAgICBpZiAodGhpcy5wcm9wcy5uYXZJY29uKSB7CiAgICAgICAgbmF0aXZlUHJvcHMubmF2SWNvbiA9IHJlc29sdmVBc3NldFNvdXJjZSh0aGlzLnByb3BzLm5hdkljb24pOwogICAgICB9CgogICAgICBpZiAodGhpcy5wcm9wcy5vdmVyZmxvd0ljb24pIHsKICAgICAgICBuYXRpdmVQcm9wcy5vdmVyZmxvd0ljb24gPSByZXNvbHZlQXNzZXRTb3VyY2UodGhpcy5wcm9wcy5vdmVyZmxvd0ljb24pOwogICAgICB9CgogICAgICBpZiAodGhpcy5wcm9wcy5hY3Rpb25zKSB7CiAgICAgICAgdmFyIG5hdGl2ZUFjdGlvbnMgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnByb3BzLmFjdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBhY3Rpb24gPSBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcy5hY3Rpb25zW2ldKTsKCiAgICAgICAgICBpZiAoYWN0aW9uLmljb24pIHsKICAgICAgICAgICAgYWN0aW9uLmljb24gPSByZXNvbHZlQXNzZXRTb3VyY2UoYWN0aW9uLmljb24pOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChhY3Rpb24uc2hvdykgewogICAgICAgICAgICBhY3Rpb24uc2hvdyA9IFVJTWFuYWdlci5Ub29sYmFyQW5kcm9pZC5Db25zdGFudHMuU2hvd0FzQWN0aW9uW2FjdGlvbi5zaG93XTsKICAgICAgICAgIH0KCiAgICAgICAgICBuYXRpdmVBY3Rpb25zLnB1c2goYWN0aW9uKTsKICAgICAgICB9CgogICAgICAgIG5hdGl2ZVByb3BzLm5hdGl2ZUFjdGlvbnMgPSBuYXRpdmVBY3Rpb25zOwogICAgICB9CgogICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChOYXRpdmVUb29sYmFyLCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7CiAgICAgICAgb25TZWxlY3Q6IHRoaXMuX29uU2VsZWN0CiAgICAgIH0sIG5hdGl2ZVByb3BzLCB7CiAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICBsaW5lTnVtYmVyOiAxOTYKICAgICAgICB9CiAgICAgIH0pKTsKICAgIH0sCiAgICBfb25TZWxlY3Q6IGZ1bmN0aW9uIF9vblNlbGVjdChldmVudCkgewogICAgICB2YXIgcG9zaXRpb24gPSBldmVudC5uYXRpdmVFdmVudC5wb3NpdGlvbjsKCiAgICAgIGlmIChwb3NpdGlvbiA9PT0gLTEpIHsKICAgICAgICB0aGlzLnByb3BzLm9uSWNvbkNsaWNrZWQgJiYgdGhpcy5wcm9wcy5vbkljb25DbGlja2VkKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wcm9wcy5vbkFjdGlvblNlbGVjdGVkICYmIHRoaXMucHJvcHMub25BY3Rpb25TZWxlY3RlZChwb3NpdGlvbik7CiAgICAgIH0KICAgIH0KICB9KTsKICB2YXIgTmF0aXZlVG9vbGJhciA9IHJlcXVpcmVOYXRpdmVDb21wb25lbnQoJ1Rvb2xiYXJBbmRyb2lkJywgVG9vbGJhckFuZHJvaWQsIHsKICAgIG5hdGl2ZU9ubHk6IHsKICAgICAgbmF0aXZlQWN0aW9uczogdHJ1ZQogICAgfQogIH0pOwogIG1vZHVsZS5leHBvcnRzID0gVG9vbGJhckFuZHJvaWQ7Cn0sMzA3LFsyMjIsMTI1LDEzMCwxMjcsMTcxLDEwNywxMzEsMTIzLDE3MiwxNDUsMTYwXSwiVG9vbGJhckFuZHJvaWQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfY2xhc3MsCiAgICAgIF90ZW1wMiwKICAgICAgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29tcG9uZW50cy9WaWV3UGFnZXIvVmlld1BhZ2VyQW5kcm9pZC5hbmRyb2lkLmpzIjsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0Iik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgUmVhY3ROYXRpdmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiUmVhY3ROYXRpdmUiKTsKCiAgdmFyIFVJTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJVSU1hbmFnZXIiKTsKCiAgdmFyIFZpZXdQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiVmlld1Byb3BUeXBlcyIpOwoKICB2YXIgZGlzbWlzc0tleWJvYXJkID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs1XSwgImRpc21pc3NLZXlib2FyZCIpOwoKICB2YXIgcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNl0sICJyZXF1aXJlTmF0aXZlQ29tcG9uZW50Iik7CgogIHZhciBWSUVXUEFHRVJfUkVGID0gJ3ZpZXdQYWdlcic7CiAgdmFyIFZpZXdQYWdlckFuZHJvaWQgPSAoX3RlbXAyID0gX2NsYXNzID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhWaWV3UGFnZXJBbmRyb2lkLCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBWaWV3UGFnZXJBbmRyb2lkKCkgewogICAgICB2YXIgX3JlZjsKCiAgICAgIHZhciBfdGVtcCwgX3RoaXMsIF9yZXQ7CgogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgVmlld1BhZ2VyQW5kcm9pZCk7CgogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiBfcmV0ID0gKF90ZW1wID0gKF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKF9yZWYgPSBWaWV3UGFnZXJBbmRyb2lkLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoVmlld1BhZ2VyQW5kcm9pZCkpLmNhbGwuYXBwbHkoX3JlZiwgW3RoaXNdLmNvbmNhdChhcmdzKSkpLCBfdGhpcyksIF90aGlzLmdldElubmVyVmlld05vZGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF90aGlzLnJlZnNbVklFV1BBR0VSX1JFRl0uZ2V0SW5uZXJWaWV3Tm9kZSgpOwogICAgICB9LCBfdGhpcy5fY2hpbGRyZW5XaXRoT3ZlcnJpZGVuU3R5bGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIFJlYWN0LkNoaWxkcmVuLm1hcChfdGhpcy5wcm9wcy5jaGlsZHJlbiwgZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgICBpZiAoIWNoaWxkKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBuZXdQcm9wcyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBjaGlsZC5wcm9wcywgewogICAgICAgICAgICBzdHlsZTogW2NoaWxkLnByb3BzLnN0eWxlLCB7CiAgICAgICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAgICAgICAgICAgICAgbGVmdDogMCwKICAgICAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICAgICAgcmlnaHQ6IDAsCiAgICAgICAgICAgICAgYm90dG9tOiAwLAogICAgICAgICAgICAgIHdpZHRoOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgaGVpZ2h0OiB1bmRlZmluZWQKICAgICAgICAgICAgfV0sCiAgICAgICAgICAgIGNvbGxhcHNhYmxlOiBmYWxzZQogICAgICAgICAgfSk7CgogICAgICAgICAgaWYgKGNoaWxkLnR5cGUgJiYgY2hpbGQudHlwZS5kaXNwbGF5TmFtZSAmJiBjaGlsZC50eXBlLmRpc3BsYXlOYW1lICE9PSAnUkNUVmlldycgJiYgY2hpbGQudHlwZS5kaXNwbGF5TmFtZSAhPT0gJ1ZpZXcnKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignRWFjaCBWaWV3UGFnZXIgY2hpbGQgbXVzdCBiZSBhIDxWaWV3Pi4gV2FzICcgKyBjaGlsZC50eXBlLmRpc3BsYXlOYW1lKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChjaGlsZC50eXBlLCBuZXdQcm9wcyk7CiAgICAgICAgfSk7CiAgICAgIH0sIF90aGlzLl9vblBhZ2VTY3JvbGwgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIGlmIChfdGhpcy5wcm9wcy5vblBhZ2VTY3JvbGwpIHsKICAgICAgICAgIF90aGlzLnByb3BzLm9uUGFnZVNjcm9sbChlKTsKICAgICAgICB9CgogICAgICAgIGlmIChfdGhpcy5wcm9wcy5rZXlib2FyZERpc21pc3NNb2RlID09PSAnb24tZHJhZycpIHsKICAgICAgICAgIGRpc21pc3NLZXlib2FyZCgpOwogICAgICAgIH0KICAgICAgfSwgX3RoaXMuX29uUGFnZVNjcm9sbFN0YXRlQ2hhbmdlZCA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgaWYgKF90aGlzLnByb3BzLm9uUGFnZVNjcm9sbFN0YXRlQ2hhbmdlZCkgewogICAgICAgICAgX3RoaXMucHJvcHMub25QYWdlU2Nyb2xsU3RhdGVDaGFuZ2VkKGUubmF0aXZlRXZlbnQucGFnZVNjcm9sbFN0YXRlKTsKICAgICAgICB9CiAgICAgIH0sIF90aGlzLl9vblBhZ2VTZWxlY3RlZCA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgaWYgKF90aGlzLnByb3BzLm9uUGFnZVNlbGVjdGVkKSB7CiAgICAgICAgICBfdGhpcy5wcm9wcy5vblBhZ2VTZWxlY3RlZChlKTsKICAgICAgICB9CiAgICAgIH0sIF90aGlzLnNldFBhZ2UgPSBmdW5jdGlvbiAoc2VsZWN0ZWRQYWdlKSB7CiAgICAgICAgVUlNYW5hZ2VyLmRpc3BhdGNoVmlld01hbmFnZXJDb21tYW5kKFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKF90aGlzKSwgVUlNYW5hZ2VyLkFuZHJvaWRWaWV3UGFnZXIuQ29tbWFuZHMuc2V0UGFnZSwgW3NlbGVjdGVkUGFnZV0pOwogICAgICB9LCBfdGhpcy5zZXRQYWdlV2l0aG91dEFuaW1hdGlvbiA9IGZ1bmN0aW9uIChzZWxlY3RlZFBhZ2UpIHsKICAgICAgICBVSU1hbmFnZXIuZGlzcGF0Y2hWaWV3TWFuYWdlckNvbW1hbmQoUmVhY3ROYXRpdmUuZmluZE5vZGVIYW5kbGUoX3RoaXMpLCBVSU1hbmFnZXIuQW5kcm9pZFZpZXdQYWdlci5Db21tYW5kcy5zZXRQYWdlV2l0aG91dEFuaW1hdGlvbiwgW3NlbGVjdGVkUGFnZV0pOwogICAgICB9LCBfdGVtcCksIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKF90aGlzLCBfcmV0KTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoVmlld1BhZ2VyQW5kcm9pZCwgW3sKICAgICAga2V5OiAiY29tcG9uZW50RGlkTW91bnQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgICAgaWYgKHRoaXMucHJvcHMuaW5pdGlhbFBhZ2UgIT0gbnVsbCkgewogICAgICAgICAgdGhpcy5zZXRQYWdlV2l0aG91dEFuaW1hdGlvbih0aGlzLnByb3BzLmluaXRpYWxQYWdlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChOYXRpdmVBbmRyb2lkVmlld1BhZ2VyLCBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgdGhpcy5wcm9wcywgewogICAgICAgICAgcmVmOiBWSUVXUEFHRVJfUkVGLAogICAgICAgICAgc3R5bGU6IHRoaXMucHJvcHMuc3R5bGUsCiAgICAgICAgICBvblBhZ2VTY3JvbGw6IHRoaXMuX29uUGFnZVNjcm9sbCwKICAgICAgICAgIG9uUGFnZVNjcm9sbFN0YXRlQ2hhbmdlZDogdGhpcy5fb25QYWdlU2Nyb2xsU3RhdGVDaGFuZ2VkLAogICAgICAgICAgb25QYWdlU2VsZWN0ZWQ6IHRoaXMuX29uUGFnZVNlbGVjdGVkLAogICAgICAgICAgY2hpbGRyZW46IHRoaXMuX2NoaWxkcmVuV2l0aE92ZXJyaWRlblN0eWxlKCksCiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiAyMzgKICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBWaWV3UGFnZXJBbmRyb2lkOwogIH0oUmVhY3QuQ29tcG9uZW50KSwgX2NsYXNzLnByb3BUeXBlcyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBWaWV3UHJvcFR5cGVzLCB7CiAgICBpbml0aWFsUGFnZTogUHJvcFR5cGVzLm51bWJlciwKICAgIG9uUGFnZVNjcm9sbDogUHJvcFR5cGVzLmZ1bmMsCiAgICBvblBhZ2VTY3JvbGxTdGF0ZUNoYW5nZWQ6IFByb3BUeXBlcy5mdW5jLAogICAgb25QYWdlU2VsZWN0ZWQ6IFByb3BUeXBlcy5mdW5jLAogICAgcGFnZU1hcmdpbjogUHJvcFR5cGVzLm51bWJlciwKICAgIGtleWJvYXJkRGlzbWlzc01vZGU6IFByb3BUeXBlcy5vbmVPZihbJ25vbmUnLCAnb24tZHJhZyddKSwKICAgIHNjcm9sbEVuYWJsZWQ6IFByb3BUeXBlcy5ib29sLAogICAgcGVla0VuYWJsZWQ6IFByb3BUeXBlcy5ib29sCiAgfSksIF90ZW1wMik7CiAgdmFyIE5hdGl2ZUFuZHJvaWRWaWV3UGFnZXIgPSByZXF1aXJlTmF0aXZlQ29tcG9uZW50KCdBbmRyb2lkVmlld1BhZ2VyJywgVmlld1BhZ2VyQW5kcm9pZCk7CiAgbW9kdWxlLmV4cG9ydHMgPSBWaWV3UGFnZXJBbmRyb2lkOwp9LDMwOCxbMTMwLDEyNywyMSwxMDcsMTMxLDIyOSwxNDVdLCJWaWV3UGFnZXJBbmRyb2lkIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3Qvbm9kZV9tb2R1bGVzL3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29tcG9uZW50cy9XZWJWaWV3L1dlYlZpZXcuYW5kcm9pZC5qcyIsCiAgICAgIF9jbGFzcywKICAgICAgX3RlbXAyOwoKICB2YXIgRWRnZUluc2V0c1Byb3BUeXBlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIkVkZ2VJbnNldHNQcm9wVHlwZSIpOwoKICB2YXIgQWN0aXZpdHlJbmRpY2F0b3IgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiQWN0aXZpdHlJbmRpY2F0b3IiKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIlJlYWN0Iik7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgUmVhY3ROYXRpdmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiUmVhY3ROYXRpdmUiKTsKCiAgdmFyIFN0eWxlU2hlZXQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzVdLCAiU3R5bGVTaGVldCIpOwoKICB2YXIgVUlNYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs2XSwgIlVJTWFuYWdlciIpOwoKICB2YXIgVmlldyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJWaWV3Iik7CgogIHZhciBWaWV3UHJvcFR5cGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs4XSwgIlZpZXdQcm9wVHlwZXMiKTsKCiAgdmFyIGRlcHJlY2F0ZWRQcm9wVHlwZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbOV0sICJkZXByZWNhdGVkUHJvcFR5cGUiKTsKCiAgdmFyIGtleU1pcnJvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMTBdLCAiZmJqcy9saWIva2V5TWlycm9yIik7CgogIHZhciByZXF1aXJlTmF0aXZlQ29tcG9uZW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxMV0sICJyZXF1aXJlTmF0aXZlQ29tcG9uZW50Iik7CgogIHZhciByZXNvbHZlQXNzZXRTb3VyY2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzEyXSwgInJlc29sdmVBc3NldFNvdXJjZSIpOwoKICB2YXIgUkNUX1dFQlZJRVdfUkVGID0gJ3dlYnZpZXcnOwogIHZhciBXZWJWaWV3U3RhdGUgPSBrZXlNaXJyb3IoewogICAgSURMRTogbnVsbCwKICAgIExPQURJTkc6IG51bGwsCiAgICBFUlJPUjogbnVsbAogIH0pOwoKICB2YXIgZGVmYXVsdFJlbmRlckxvYWRpbmcgPSBmdW5jdGlvbiBkZWZhdWx0UmVuZGVyTG9hZGluZygpIHsKICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICBWaWV3LAogICAgICB7CiAgICAgICAgc3R5bGU6IHN0eWxlcy5sb2FkaW5nVmlldywKICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgIGxpbmVOdW1iZXI6IDM3CiAgICAgICAgfQogICAgICB9LAogICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KEFjdGl2aXR5SW5kaWNhdG9yLCB7CiAgICAgICAgc3R5bGU6IHN0eWxlcy5sb2FkaW5nUHJvZ3Jlc3NCYXIsCiAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICBsaW5lTnVtYmVyOiAzOAogICAgICAgIH0KICAgICAgfSkKICAgICk7CiAgfTsKCiAgdmFyIFdlYlZpZXcgPSAoX3RlbXAyID0gX2NsYXNzID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhXZWJWaWV3LCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgICBmdW5jdGlvbiBXZWJWaWV3KCkgewogICAgICB2YXIgX3JlZjsKCiAgICAgIHZhciBfdGVtcCwgX3RoaXMsIF9yZXQ7CgogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgV2ViVmlldyk7CgogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiBfcmV0ID0gKF90ZW1wID0gKF90aGlzID0gYmFiZWxIZWxwZXJzLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKF9yZWYgPSBXZWJWaWV3Ll9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoV2ViVmlldykpLmNhbGwuYXBwbHkoX3JlZiwgW3RoaXNdLmNvbmNhdChhcmdzKSkpLCBfdGhpcyksIF90aGlzLnN0YXRlID0gewogICAgICAgIHZpZXdTdGF0ZTogV2ViVmlld1N0YXRlLklETEUsCiAgICAgICAgbGFzdEVycm9yRXZlbnQ6IG51bGwsCiAgICAgICAgc3RhcnRJbkxvYWRpbmdTdGF0ZTogdHJ1ZQogICAgICB9LCBfdGhpcy5nb0ZvcndhcmQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgVUlNYW5hZ2VyLmRpc3BhdGNoVmlld01hbmFnZXJDb21tYW5kKF90aGlzLmdldFdlYlZpZXdIYW5kbGUoKSwgVUlNYW5hZ2VyLlJDVFdlYlZpZXcuQ29tbWFuZHMuZ29Gb3J3YXJkLCBudWxsKTsKICAgICAgfSwgX3RoaXMuZ29CYWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIFVJTWFuYWdlci5kaXNwYXRjaFZpZXdNYW5hZ2VyQ29tbWFuZChfdGhpcy5nZXRXZWJWaWV3SGFuZGxlKCksIFVJTWFuYWdlci5SQ1RXZWJWaWV3LkNvbW1hbmRzLmdvQmFjaywgbnVsbCk7CiAgICAgIH0sIF90aGlzLnJlbG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICB2aWV3U3RhdGU6IFdlYlZpZXdTdGF0ZS5MT0FESU5HCiAgICAgICAgfSk7CgogICAgICAgIFVJTWFuYWdlci5kaXNwYXRjaFZpZXdNYW5hZ2VyQ29tbWFuZChfdGhpcy5nZXRXZWJWaWV3SGFuZGxlKCksIFVJTWFuYWdlci5SQ1RXZWJWaWV3LkNvbW1hbmRzLnJlbG9hZCwgbnVsbCk7CiAgICAgIH0sIF90aGlzLnN0b3BMb2FkaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgIFVJTWFuYWdlci5kaXNwYXRjaFZpZXdNYW5hZ2VyQ29tbWFuZChfdGhpcy5nZXRXZWJWaWV3SGFuZGxlKCksIFVJTWFuYWdlci5SQ1RXZWJWaWV3LkNvbW1hbmRzLnN0b3BMb2FkaW5nLCBudWxsKTsKICAgICAgfSwgX3RoaXMucG9zdE1lc3NhZ2UgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIFVJTWFuYWdlci5kaXNwYXRjaFZpZXdNYW5hZ2VyQ29tbWFuZChfdGhpcy5nZXRXZWJWaWV3SGFuZGxlKCksIFVJTWFuYWdlci5SQ1RXZWJWaWV3LkNvbW1hbmRzLnBvc3RNZXNzYWdlLCBbU3RyaW5nKGRhdGEpXSk7CiAgICAgIH0sIF90aGlzLmluamVjdEphdmFTY3JpcHQgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIFVJTWFuYWdlci5kaXNwYXRjaFZpZXdNYW5hZ2VyQ29tbWFuZChfdGhpcy5nZXRXZWJWaWV3SGFuZGxlKCksIFVJTWFuYWdlci5SQ1RXZWJWaWV3LkNvbW1hbmRzLmluamVjdEphdmFTY3JpcHQsIFtkYXRhXSk7CiAgICAgIH0sIF90aGlzLnVwZGF0ZU5hdmlnYXRpb25TdGF0ZSA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGlmIChfdGhpcy5wcm9wcy5vbk5hdmlnYXRpb25TdGF0ZUNoYW5nZSkgewogICAgICAgICAgX3RoaXMucHJvcHMub25OYXZpZ2F0aW9uU3RhdGVDaGFuZ2UoZXZlbnQubmF0aXZlRXZlbnQpOwogICAgICAgIH0KICAgICAgfSwgX3RoaXMuZ2V0V2ViVmlld0hhbmRsZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gUmVhY3ROYXRpdmUuZmluZE5vZGVIYW5kbGUoX3RoaXMucmVmc1tSQ1RfV0VCVklFV19SRUZdKTsKICAgICAgfSwgX3RoaXMub25Mb2FkaW5nU3RhcnQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICB2YXIgb25Mb2FkU3RhcnQgPSBfdGhpcy5wcm9wcy5vbkxvYWRTdGFydDsKICAgICAgICBvbkxvYWRTdGFydCAmJiBvbkxvYWRTdGFydChldmVudCk7CgogICAgICAgIF90aGlzLnVwZGF0ZU5hdmlnYXRpb25TdGF0ZShldmVudCk7CiAgICAgIH0sIF90aGlzLm9uTG9hZGluZ0Vycm9yID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgZXZlbnQucGVyc2lzdCgpOwogICAgICAgIHZhciBfdGhpcyRwcm9wcyA9IF90aGlzLnByb3BzLAogICAgICAgICAgICBvbkVycm9yID0gX3RoaXMkcHJvcHMub25FcnJvciwKICAgICAgICAgICAgb25Mb2FkRW5kID0gX3RoaXMkcHJvcHMub25Mb2FkRW5kOwogICAgICAgIG9uRXJyb3IgJiYgb25FcnJvcihldmVudCk7CiAgICAgICAgb25Mb2FkRW5kICYmIG9uTG9hZEVuZChldmVudCk7CiAgICAgICAgY29uc29sZS53YXJuKCdFbmNvdW50ZXJlZCBhbiBlcnJvciBsb2FkaW5nIHBhZ2UnLCBldmVudC5uYXRpdmVFdmVudCk7CgogICAgICAgIF90aGlzLnNldFN0YXRlKHsKICAgICAgICAgIGxhc3RFcnJvckV2ZW50OiBldmVudC5uYXRpdmVFdmVudCwKICAgICAgICAgIHZpZXdTdGF0ZTogV2ViVmlld1N0YXRlLkVSUk9SCiAgICAgICAgfSk7CiAgICAgIH0sIF90aGlzLm9uTG9hZGluZ0ZpbmlzaCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHZhciBfdGhpcyRwcm9wczIgPSBfdGhpcy5wcm9wcywKICAgICAgICAgICAgb25Mb2FkID0gX3RoaXMkcHJvcHMyLm9uTG9hZCwKICAgICAgICAgICAgb25Mb2FkRW5kID0gX3RoaXMkcHJvcHMyLm9uTG9hZEVuZDsKICAgICAgICBvbkxvYWQgJiYgb25Mb2FkKGV2ZW50KTsKICAgICAgICBvbkxvYWRFbmQgJiYgb25Mb2FkRW5kKGV2ZW50KTsKCiAgICAgICAgX3RoaXMuc2V0U3RhdGUoewogICAgICAgICAgdmlld1N0YXRlOiBXZWJWaWV3U3RhdGUuSURMRQogICAgICAgIH0pOwoKICAgICAgICBfdGhpcy51cGRhdGVOYXZpZ2F0aW9uU3RhdGUoZXZlbnQpOwogICAgICB9LCBfdGhpcy5vbk1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICB2YXIgb25NZXNzYWdlID0gX3RoaXMucHJvcHMub25NZXNzYWdlOwogICAgICAgIG9uTWVzc2FnZSAmJiBvbk1lc3NhZ2UoZXZlbnQpOwogICAgICB9LCBfdGVtcCksIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKF90aGlzLCBfcmV0KTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoV2ViVmlldywgW3sKICAgICAga2V5OiAiY29tcG9uZW50V2lsbE1vdW50IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxNb3VudCgpIHsKICAgICAgICBpZiAodGhpcy5wcm9wcy5zdGFydEluTG9hZGluZ1N0YXRlKSB7CiAgICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgdmlld1N0YXRlOiBXZWJWaWV3U3RhdGUuTE9BRElORwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbmRlciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgdmFyIG90aGVyVmlldyA9IG51bGw7CgogICAgICAgIGlmICh0aGlzLnN0YXRlLnZpZXdTdGF0ZSA9PT0gV2ViVmlld1N0YXRlLkxPQURJTkcpIHsKICAgICAgICAgIG90aGVyVmlldyA9ICh0aGlzLnByb3BzLnJlbmRlckxvYWRpbmcgfHwgZGVmYXVsdFJlbmRlckxvYWRpbmcpKCk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlLnZpZXdTdGF0ZSA9PT0gV2ViVmlld1N0YXRlLkVSUk9SKSB7CiAgICAgICAgICB2YXIgZXJyb3JFdmVudCA9IHRoaXMuc3RhdGUubGFzdEVycm9yRXZlbnQ7CiAgICAgICAgICBvdGhlclZpZXcgPSB0aGlzLnByb3BzLnJlbmRlckVycm9yICYmIHRoaXMucHJvcHMucmVuZGVyRXJyb3IoZXJyb3JFdmVudC5kb21haW4sIGVycm9yRXZlbnQuY29kZSwgZXJyb3JFdmVudC5kZXNjcmlwdGlvbik7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlLnZpZXdTdGF0ZSAhPT0gV2ViVmlld1N0YXRlLklETEUpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1JDVFdlYlZpZXcgaW52YWxpZCBzdGF0ZSBlbmNvdW50ZXJlZDogJyArIHRoaXMuc3RhdGUubG9hZGluZyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgd2ViVmlld1N0eWxlcyA9IFtzdHlsZXMuY29udGFpbmVyLCB0aGlzLnByb3BzLnN0eWxlXTsKCiAgICAgICAgaWYgKHRoaXMuc3RhdGUudmlld1N0YXRlID09PSBXZWJWaWV3U3RhdGUuTE9BRElORyB8fCB0aGlzLnN0YXRlLnZpZXdTdGF0ZSA9PT0gV2ViVmlld1N0YXRlLkVSUk9SKSB7CiAgICAgICAgICB3ZWJWaWV3U3R5bGVzLnB1c2goc3R5bGVzLmhpZGRlbik7CiAgICAgICAgfQoKICAgICAgICB2YXIgc291cmNlID0gdGhpcy5wcm9wcy5zb3VyY2UgfHwge307CgogICAgICAgIGlmICh0aGlzLnByb3BzLmh0bWwpIHsKICAgICAgICAgIHNvdXJjZS5odG1sID0gdGhpcy5wcm9wcy5odG1sOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5wcm9wcy51cmwpIHsKICAgICAgICAgIHNvdXJjZS51cmkgPSB0aGlzLnByb3BzLnVybDsKICAgICAgICB9CgogICAgICAgIGlmIChzb3VyY2UubWV0aG9kID09PSAnUE9TVCcgJiYgc291cmNlLmhlYWRlcnMpIHsKICAgICAgICAgIGNvbnNvbGUud2FybignV2ViVmlldzogYHNvdXJjZS5oZWFkZXJzYCBpcyBub3Qgc3VwcG9ydGVkIHdoZW4gdXNpbmcgUE9TVC4nKTsKICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZS5tZXRob2QgPT09ICdHRVQnICYmIHNvdXJjZS5ib2R5KSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oJ1dlYlZpZXc6IGBzb3VyY2UuYm9keWAgaXMgbm90IHN1cHBvcnRlZCB3aGVuIHVzaW5nIEdFVC4nKTsKICAgICAgICB9CgogICAgICAgIHZhciBuYXRpdmVDb25maWcgPSB0aGlzLnByb3BzLm5hdGl2ZUNvbmZpZyB8fCB7fTsKICAgICAgICB2YXIgTmF0aXZlV2ViVmlldyA9IG5hdGl2ZUNvbmZpZy5jb21wb25lbnQgfHwgUkNUV2ViVmlldzsKICAgICAgICB2YXIgd2ViVmlldyA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQoTmF0aXZlV2ViVmlldywgYmFiZWxIZWxwZXJzLmV4dGVuZHMoewogICAgICAgICAgcmVmOiBSQ1RfV0VCVklFV19SRUYsCiAgICAgICAgICBrZXk6ICJ3ZWJWaWV3S2V5IiwKICAgICAgICAgIHN0eWxlOiB3ZWJWaWV3U3R5bGVzLAogICAgICAgICAgc291cmNlOiByZXNvbHZlQXNzZXRTb3VyY2Uoc291cmNlKSwKICAgICAgICAgIHNjYWxlc1BhZ2VUb0ZpdDogdGhpcy5wcm9wcy5zY2FsZXNQYWdlVG9GaXQsCiAgICAgICAgICBpbmplY3RlZEphdmFTY3JpcHQ6IHRoaXMucHJvcHMuaW5qZWN0ZWRKYXZhU2NyaXB0LAogICAgICAgICAgdXNlckFnZW50OiB0aGlzLnByb3BzLnVzZXJBZ2VudCwKICAgICAgICAgIGphdmFTY3JpcHRFbmFibGVkOiB0aGlzLnByb3BzLmphdmFTY3JpcHRFbmFibGVkLAogICAgICAgICAgdGhpcmRQYXJ0eUNvb2tpZXNFbmFibGVkOiB0aGlzLnByb3BzLnRoaXJkUGFydHlDb29raWVzRW5hYmxlZCwKICAgICAgICAgIGRvbVN0b3JhZ2VFbmFibGVkOiB0aGlzLnByb3BzLmRvbVN0b3JhZ2VFbmFibGVkLAogICAgICAgICAgbWVzc2FnaW5nRW5hYmxlZDogdHlwZW9mIHRoaXMucHJvcHMub25NZXNzYWdlID09PSAnZnVuY3Rpb24nLAogICAgICAgICAgb25NZXNzYWdlOiB0aGlzLm9uTWVzc2FnZSwKICAgICAgICAgIGNvbnRlbnRJbnNldDogdGhpcy5wcm9wcy5jb250ZW50SW5zZXQsCiAgICAgICAgICBhdXRvbWF0aWNhbGx5QWRqdXN0Q29udGVudEluc2V0czogdGhpcy5wcm9wcy5hdXRvbWF0aWNhbGx5QWRqdXN0Q29udGVudEluc2V0cywKICAgICAgICAgIG9uQ29udGVudFNpemVDaGFuZ2U6IHRoaXMucHJvcHMub25Db250ZW50U2l6ZUNoYW5nZSwKICAgICAgICAgIG9uTG9hZGluZ1N0YXJ0OiB0aGlzLm9uTG9hZGluZ1N0YXJ0LAogICAgICAgICAgb25Mb2FkaW5nRmluaXNoOiB0aGlzLm9uTG9hZGluZ0ZpbmlzaCwKICAgICAgICAgIG9uTG9hZGluZ0Vycm9yOiB0aGlzLm9uTG9hZGluZ0Vycm9yLAogICAgICAgICAgdGVzdElEOiB0aGlzLnByb3BzLnRlc3RJRCwKICAgICAgICAgIG1lZGlhUGxheWJhY2tSZXF1aXJlc1VzZXJBY3Rpb246IHRoaXMucHJvcHMubWVkaWFQbGF5YmFja1JlcXVpcmVzVXNlckFjdGlvbiwKICAgICAgICAgIGFsbG93VW5pdmVyc2FsQWNjZXNzRnJvbUZpbGVVUkxzOiB0aGlzLnByb3BzLmFsbG93VW5pdmVyc2FsQWNjZXNzRnJvbUZpbGVVUkxzLAogICAgICAgICAgbWl4ZWRDb250ZW50TW9kZTogdGhpcy5wcm9wcy5taXhlZENvbnRlbnRNb2RlLAogICAgICAgICAgc2F2ZUZvcm1EYXRhRGlzYWJsZWQ6IHRoaXMucHJvcHMuc2F2ZUZvcm1EYXRhRGlzYWJsZWQsCiAgICAgICAgICB1cmxQcmVmaXhlc0ZvckRlZmF1bHRJbnRlbnQ6IHRoaXMucHJvcHMudXJsUHJlZml4ZXNGb3JEZWZhdWx0SW50ZW50CiAgICAgICAgfSwgbmF0aXZlQ29uZmlnLnByb3BzLCB7CiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiAyOTYKICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBWaWV3LAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogc3R5bGVzLmNvbnRhaW5lciwKICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDMyNQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgd2ViVmlldywKICAgICAgICAgIG90aGVyVmlldwogICAgICAgICk7CiAgICAgIH0KICAgIH1dLCBbewogICAgICBrZXk6ICJleHRyYU5hdGl2ZUNvbXBvbmVudENvbmZpZyIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBuYXRpdmVPbmx5OiB7CiAgICAgICAgICAgIG1lc3NhZ2luZ0VuYWJsZWQ6IFByb3BUeXBlcy5ib29sCiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFdlYlZpZXc7CiAgfShSZWFjdC5Db21wb25lbnQpLCBfY2xhc3MucHJvcFR5cGVzID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIFZpZXdQcm9wVHlwZXMsIHsKICAgIHJlbmRlckVycm9yOiBQcm9wVHlwZXMuZnVuYywKICAgIHJlbmRlckxvYWRpbmc6IFByb3BUeXBlcy5mdW5jLAogICAgb25Mb2FkOiBQcm9wVHlwZXMuZnVuYywKICAgIG9uTG9hZEVuZDogUHJvcFR5cGVzLmZ1bmMsCiAgICBvbkxvYWRTdGFydDogUHJvcFR5cGVzLmZ1bmMsCiAgICBvbkVycm9yOiBQcm9wVHlwZXMuZnVuYywKICAgIGF1dG9tYXRpY2FsbHlBZGp1c3RDb250ZW50SW5zZXRzOiBQcm9wVHlwZXMuYm9vbCwKICAgIGNvbnRlbnRJbnNldDogRWRnZUluc2V0c1Byb3BUeXBlLAogICAgb25OYXZpZ2F0aW9uU3RhdGVDaGFuZ2U6IFByb3BUeXBlcy5mdW5jLAogICAgb25NZXNzYWdlOiBQcm9wVHlwZXMuZnVuYywKICAgIG9uQ29udGVudFNpemVDaGFuZ2U6IFByb3BUeXBlcy5mdW5jLAogICAgc3RhcnRJbkxvYWRpbmdTdGF0ZTogUHJvcFR5cGVzLmJvb2wsCiAgICBzdHlsZTogVmlld1Byb3BUeXBlcy5zdHlsZSwKICAgIGh0bWw6IGRlcHJlY2F0ZWRQcm9wVHlwZShQcm9wVHlwZXMuc3RyaW5nLCAnVXNlIHRoZSBgc291cmNlYCBwcm9wIGluc3RlYWQuJyksCiAgICB1cmw6IGRlcHJlY2F0ZWRQcm9wVHlwZShQcm9wVHlwZXMuc3RyaW5nLCAnVXNlIHRoZSBgc291cmNlYCBwcm9wIGluc3RlYWQuJyksCiAgICBzb3VyY2U6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5zaGFwZSh7CiAgICAgIHVyaTogUHJvcFR5cGVzLnN0cmluZywKICAgICAgbWV0aG9kOiBQcm9wVHlwZXMub25lT2YoWydHRVQnLCAnUE9TVCddKSwKICAgICAgaGVhZGVyczogUHJvcFR5cGVzLm9iamVjdCwKICAgICAgYm9keTogUHJvcFR5cGVzLnN0cmluZwogICAgfSksIFByb3BUeXBlcy5zaGFwZSh7CiAgICAgIGh0bWw6IFByb3BUeXBlcy5zdHJpbmcsCiAgICAgIGJhc2VVcmw6IFByb3BUeXBlcy5zdHJpbmcKICAgIH0pLCBQcm9wVHlwZXMubnVtYmVyXSksCiAgICBqYXZhU2NyaXB0RW5hYmxlZDogUHJvcFR5cGVzLmJvb2wsCiAgICB0aGlyZFBhcnR5Q29va2llc0VuYWJsZWQ6IFByb3BUeXBlcy5ib29sLAogICAgZG9tU3RvcmFnZUVuYWJsZWQ6IFByb3BUeXBlcy5ib29sLAogICAgaW5qZWN0ZWRKYXZhU2NyaXB0OiBQcm9wVHlwZXMuc3RyaW5nLAogICAgc2NhbGVzUGFnZVRvRml0OiBQcm9wVHlwZXMuYm9vbCwKICAgIHVzZXJBZ2VudDogUHJvcFR5cGVzLnN0cmluZywKICAgIHRlc3RJRDogUHJvcFR5cGVzLnN0cmluZywKICAgIG1lZGlhUGxheWJhY2tSZXF1aXJlc1VzZXJBY3Rpb246IFByb3BUeXBlcy5ib29sLAogICAgYWxsb3dVbml2ZXJzYWxBY2Nlc3NGcm9tRmlsZVVSTHM6IFByb3BUeXBlcy5ib29sLAogICAgaW5qZWN0SmF2YVNjcmlwdDogUHJvcFR5cGVzLmZ1bmMsCiAgICBtaXhlZENvbnRlbnRNb2RlOiBQcm9wVHlwZXMub25lT2YoWyduZXZlcicsICdhbHdheXMnLCAnY29tcGF0aWJpbGl0eSddKSwKICAgIHNhdmVGb3JtRGF0YURpc2FibGVkOiBQcm9wVHlwZXMuYm9vbCwKICAgIG5hdGl2ZUNvbmZpZzogUHJvcFR5cGVzLnNoYXBlKHsKICAgICAgY29tcG9uZW50OiBQcm9wVHlwZXMuYW55LAogICAgICBwcm9wczogUHJvcFR5cGVzLm9iamVjdCwKICAgICAgdmlld01hbmFnZXI6IFByb3BUeXBlcy5vYmplY3QKICAgIH0pLAogICAgdXJsUHJlZml4ZXNGb3JEZWZhdWx0SW50ZW50OiBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMuc3RyaW5nKQogIH0pLCBfY2xhc3MuZGVmYXVsdFByb3BzID0gewogICAgamF2YVNjcmlwdEVuYWJsZWQ6IHRydWUsCiAgICB0aGlyZFBhcnR5Q29va2llc0VuYWJsZWQ6IHRydWUsCiAgICBzY2FsZXNQYWdlVG9GaXQ6IHRydWUsCiAgICBzYXZlRm9ybURhdGFEaXNhYmxlZDogZmFsc2UKICB9LCBfdGVtcDIpOwogIHZhciBSQ1RXZWJWaWV3ID0gcmVxdWlyZU5hdGl2ZUNvbXBvbmVudCgnUkNUV2ViVmlldycsIFdlYlZpZXcsIFdlYlZpZXcuZXh0cmFOYXRpdmVDb21wb25lbnRDb25maWcpOwogIHZhciBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7CiAgICBjb250YWluZXI6IHsKICAgICAgZmxleDogMQogICAgfSwKICAgIGhpZGRlbjogewogICAgICBoZWlnaHQ6IDAsCiAgICAgIGZsZXg6IDAKICAgIH0sCiAgICBsb2FkaW5nVmlldzogewogICAgICBmbGV4OiAxLAogICAgICBqdXN0aWZ5Q29udGVudDogJ2NlbnRlcicsCiAgICAgIGFsaWduSXRlbXM6ICdjZW50ZXInCiAgICB9LAogICAgbG9hZGluZ1Byb2dyZXNzQmFyOiB7CiAgICAgIGhlaWdodDogMjAKICAgIH0KICB9KTsKICBtb2R1bGUuZXhwb3J0cyA9IFdlYlZpZXc7Cn0sMzA5LFsxMzIsMTIyLDEzMCwxMjcsMjEsMTY4LDEwNywxNzAsMTMxLDE0MywxNTAsMTQ1LDE2MF0sIldlYlZpZXciKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBSQ1RBY3Rpb25TaGVldE1hbmFnZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTmF0aXZlTW9kdWxlcyIpLkFjdGlvblNoZWV0TWFuYWdlcjsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIHByb2Nlc3NDb2xvciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJwcm9jZXNzQ29sb3IiKTsKCiAgdmFyIEFjdGlvblNoZWV0SU9TID0gewogICAgc2hvd0FjdGlvblNoZWV0V2l0aE9wdGlvbnM6IGZ1bmN0aW9uIHNob3dBY3Rpb25TaGVldFdpdGhPcHRpb25zKG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgICAgIGludmFyaWFudCh0eXBlb2Ygb3B0aW9ucyA9PT0gJ29iamVjdCcgJiYgb3B0aW9ucyAhPT0gbnVsbCwgJ09wdGlvbnMgbXVzdCBiZSBhIHZhbGlkIG9iamVjdCcpOwogICAgICBpbnZhcmlhbnQodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nLCAnTXVzdCBwcm92aWRlIGEgdmFsaWQgY2FsbGJhY2snKTsKICAgICAgUkNUQWN0aW9uU2hlZXRNYW5hZ2VyLnNob3dBY3Rpb25TaGVldFdpdGhPcHRpb25zKGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBvcHRpb25zLCB7CiAgICAgICAgdGludENvbG9yOiBwcm9jZXNzQ29sb3Iob3B0aW9ucy50aW50Q29sb3IpCiAgICAgIH0pLCBjYWxsYmFjayk7CiAgICB9LAogICAgc2hvd1NoYXJlQWN0aW9uU2hlZXRXaXRoT3B0aW9uczogZnVuY3Rpb24gc2hvd1NoYXJlQWN0aW9uU2hlZXRXaXRoT3B0aW9ucyhvcHRpb25zLCBmYWlsdXJlQ2FsbGJhY2ssIHN1Y2Nlc3NDYWxsYmFjaykgewogICAgICBpbnZhcmlhbnQodHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnICYmIG9wdGlvbnMgIT09IG51bGwsICdPcHRpb25zIG11c3QgYmUgYSB2YWxpZCBvYmplY3QnKTsKICAgICAgaW52YXJpYW50KHR5cGVvZiBmYWlsdXJlQ2FsbGJhY2sgPT09ICdmdW5jdGlvbicsICdNdXN0IHByb3ZpZGUgYSB2YWxpZCBmYWlsdXJlQ2FsbGJhY2snKTsKICAgICAgaW52YXJpYW50KHR5cGVvZiBzdWNjZXNzQ2FsbGJhY2sgPT09ICdmdW5jdGlvbicsICdNdXN0IHByb3ZpZGUgYSB2YWxpZCBzdWNjZXNzQ2FsbGJhY2snKTsKICAgICAgUkNUQWN0aW9uU2hlZXRNYW5hZ2VyLnNob3dTaGFyZUFjdGlvblNoZWV0V2l0aE9wdGlvbnMoYmFiZWxIZWxwZXJzLmV4dGVuZHMoe30sIG9wdGlvbnMsIHsKICAgICAgICB0aW50Q29sb3I6IHByb2Nlc3NDb2xvcihvcHRpb25zLnRpbnRDb2xvcikKICAgICAgfSksIGZhaWx1cmVDYWxsYmFjaywgc3VjY2Vzc0NhbGxiYWNrKTsKICAgIH0KICB9OwogIG1vZHVsZS5leHBvcnRzID0gQWN0aW9uU2hlZXRJT1M7Cn0sMzEwLFsxNSwxMywxNTJdLCJBY3Rpb25TaGVldElPUyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEJhdGNoZWRCcmlkZ2UgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiQmF0Y2hlZEJyaWRnZSIpOwoKICB2YXIgQnVnUmVwb3J0aW5nID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIkJ1Z1JlcG9ydGluZyIpOwoKICB2YXIgTmF0aXZlTW9kdWxlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJOYXRpdmVNb2R1bGVzIik7CgogIHZhciBSZWFjdE5hdGl2ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJSZWFjdE5hdGl2ZSIpOwoKICB2YXIgU2NlbmVUcmFja2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFs0XSwgIlNjZW5lVHJhY2tlciIpOwoKICB2YXIgaW5mb0xvZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbNV0sICJpbmZvTG9nIik7CgogIHZhciBpbnZhcmlhbnQgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzZdLCAiZmJqcy9saWIvaW52YXJpYW50Iik7CgogIHZhciByZW5kZXJBcHBsaWNhdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbN10sICJyZW5kZXJBcHBsaWNhdGlvbiIpOwoKICB2YXIgcnVubmFibGVzID0ge307CiAgdmFyIHJ1bkNvdW50ID0gMTsKICB2YXIgc2VjdGlvbnMgPSB7fTsKICB2YXIgdGFza3MgPSBuZXcgTWFwKCk7CgogIHZhciBjb21wb25lbnRQcm92aWRlckluc3RydW1lbnRhdGlvbkhvb2sgPSBmdW5jdGlvbiBjb21wb25lbnRQcm92aWRlckluc3RydW1lbnRhdGlvbkhvb2soY29tcG9uZW50KSB7CiAgICByZXR1cm4gY29tcG9uZW50KCk7CiAgfTsKCiAgdmFyIHdyYXBwZXJDb21wb25lbnRQcm92aWRlciA9IHZvaWQgMDsKICB2YXIgQXBwUmVnaXN0cnkgPSB7CiAgICBzZXRXcmFwcGVyQ29tcG9uZW50UHJvdmlkZXI6IGZ1bmN0aW9uIHNldFdyYXBwZXJDb21wb25lbnRQcm92aWRlcihwcm92aWRlcikgewogICAgICB3cmFwcGVyQ29tcG9uZW50UHJvdmlkZXIgPSBwcm92aWRlcjsKICAgIH0sCiAgICByZWdpc3RlckNvbmZpZzogZnVuY3Rpb24gcmVnaXN0ZXJDb25maWcoY29uZmlnKSB7CiAgICAgIGNvbmZpZy5mb3JFYWNoKGZ1bmN0aW9uIChhcHBDb25maWcpIHsKICAgICAgICBpZiAoYXBwQ29uZmlnLnJ1bikgewogICAgICAgICAgQXBwUmVnaXN0cnkucmVnaXN0ZXJSdW5uYWJsZShhcHBDb25maWcuYXBwS2V5LCBhcHBDb25maWcucnVuKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaW52YXJpYW50KGFwcENvbmZpZy5jb21wb25lbnQgIT0gbnVsbCwgJ0FwcFJlZ2lzdHJ5LnJlZ2lzdGVyQ29uZmlnKC4uLik6IEV2ZXJ5IGNvbmZpZyBpcyBleHBlY3RlZCB0byBzZXQgJyArICdlaXRoZXIgYHJ1bmAgb3IgYGNvbXBvbmVudGAsIGJ1dCBgJXNgIGhhcyBuZWl0aGVyLicsIGFwcENvbmZpZy5hcHBLZXkpOwogICAgICAgICAgQXBwUmVnaXN0cnkucmVnaXN0ZXJDb21wb25lbnQoYXBwQ29uZmlnLmFwcEtleSwgYXBwQ29uZmlnLmNvbXBvbmVudCwgYXBwQ29uZmlnLnNlY3Rpb24pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgcmVnaXN0ZXJDb21wb25lbnQ6IGZ1bmN0aW9uIHJlZ2lzdGVyQ29tcG9uZW50KGFwcEtleSwgY29tcG9uZW50UHJvdmlkZXIsIHNlY3Rpb24pIHsKICAgICAgcnVubmFibGVzW2FwcEtleV0gPSB7CiAgICAgICAgY29tcG9uZW50UHJvdmlkZXI6IGNvbXBvbmVudFByb3ZpZGVyLAogICAgICAgIHJ1bjogZnVuY3Rpb24gcnVuKGFwcFBhcmFtZXRlcnMpIHsKICAgICAgICAgIHJldHVybiByZW5kZXJBcHBsaWNhdGlvbihjb21wb25lbnRQcm92aWRlckluc3RydW1lbnRhdGlvbkhvb2soY29tcG9uZW50UHJvdmlkZXIpLCBhcHBQYXJhbWV0ZXJzLmluaXRpYWxQcm9wcywgYXBwUGFyYW1ldGVycy5yb290VGFnLCB3cmFwcGVyQ29tcG9uZW50UHJvdmlkZXIgJiYgd3JhcHBlckNvbXBvbmVudFByb3ZpZGVyKGFwcFBhcmFtZXRlcnMpKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAoc2VjdGlvbikgewogICAgICAgIHNlY3Rpb25zW2FwcEtleV0gPSBydW5uYWJsZXNbYXBwS2V5XTsKICAgICAgfQoKICAgICAgcmV0dXJuIGFwcEtleTsKICAgIH0sCiAgICByZWdpc3RlclJ1bm5hYmxlOiBmdW5jdGlvbiByZWdpc3RlclJ1bm5hYmxlKGFwcEtleSwgcnVuKSB7CiAgICAgIHJ1bm5hYmxlc1thcHBLZXldID0gewogICAgICAgIHJ1bjogcnVuCiAgICAgIH07CiAgICAgIHJldHVybiBhcHBLZXk7CiAgICB9LAogICAgcmVnaXN0ZXJTZWN0aW9uOiBmdW5jdGlvbiByZWdpc3RlclNlY3Rpb24oYXBwS2V5LCBjb21wb25lbnQpIHsKICAgICAgQXBwUmVnaXN0cnkucmVnaXN0ZXJDb21wb25lbnQoYXBwS2V5LCBjb21wb25lbnQsIHRydWUpOwogICAgfSwKICAgIGdldEFwcEtleXM6IGZ1bmN0aW9uIGdldEFwcEtleXMoKSB7CiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhydW5uYWJsZXMpOwogICAgfSwKICAgIGdldFNlY3Rpb25LZXlzOiBmdW5jdGlvbiBnZXRTZWN0aW9uS2V5cygpIHsKICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHNlY3Rpb25zKTsKICAgIH0sCiAgICBnZXRTZWN0aW9uczogZnVuY3Rpb24gZ2V0U2VjdGlvbnMoKSB7CiAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMuZXh0ZW5kcyh7fSwgc2VjdGlvbnMpOwogICAgfSwKICAgIGdldFJ1bm5hYmxlOiBmdW5jdGlvbiBnZXRSdW5uYWJsZShhcHBLZXkpIHsKICAgICAgcmV0dXJuIHJ1bm5hYmxlc1thcHBLZXldOwogICAgfSwKICAgIGdldFJlZ2lzdHJ5OiBmdW5jdGlvbiBnZXRSZWdpc3RyeSgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBzZWN0aW9uczogQXBwUmVnaXN0cnkuZ2V0U2VjdGlvbktleXMoKSwKICAgICAgICBydW5uYWJsZXM6IGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBydW5uYWJsZXMpCiAgICAgIH07CiAgICB9LAogICAgc2V0Q29tcG9uZW50UHJvdmlkZXJJbnN0cnVtZW50YXRpb25Ib29rOiBmdW5jdGlvbiBzZXRDb21wb25lbnRQcm92aWRlckluc3RydW1lbnRhdGlvbkhvb2soaG9vaykgewogICAgICBjb21wb25lbnRQcm92aWRlckluc3RydW1lbnRhdGlvbkhvb2sgPSBob29rOwogICAgfSwKICAgIHJ1bkFwcGxpY2F0aW9uOiBmdW5jdGlvbiBydW5BcHBsaWNhdGlvbihhcHBLZXksIGFwcFBhcmFtZXRlcnMpIHsKICAgICAgdmFyIG1zZyA9ICdSdW5uaW5nIGFwcGxpY2F0aW9uICInICsgYXBwS2V5ICsgJyIgd2l0aCBhcHBQYXJhbXM6ICcgKyBKU09OLnN0cmluZ2lmeShhcHBQYXJhbWV0ZXJzKSArICcuICcgKyAnX19ERVZfXyA9PT0gJyArIFN0cmluZyhfX0RFVl9fKSArICcsIGRldmVsb3BtZW50LWxldmVsIHdhcm5pbmcgYXJlICcgKyAoX19ERVZfXyA/ICdPTicgOiAnT0ZGJykgKyAnLCBwZXJmb3JtYW5jZSBvcHRpbWl6YXRpb25zIGFyZSAnICsgKF9fREVWX18gPyAnT0ZGJyA6ICdPTicpOwogICAgICBpbmZvTG9nKG1zZyk7CiAgICAgIEJ1Z1JlcG9ydGluZy5hZGRTb3VyY2UoJ0FwcFJlZ2lzdHJ5LnJ1bkFwcGxpY2F0aW9uJyArIHJ1bkNvdW50KyssIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gbXNnOwogICAgICB9KTsKICAgICAgaW52YXJpYW50KHJ1bm5hYmxlc1thcHBLZXldICYmIHJ1bm5hYmxlc1thcHBLZXldLnJ1biwgJ0FwcGxpY2F0aW9uICcgKyBhcHBLZXkgKyAnIGhhcyBub3QgYmVlbiByZWdpc3RlcmVkLlxuXG4nICsgIkhpbnQ6IFRoaXMgZXJyb3Igb2Z0ZW4gaGFwcGVucyB3aGVuIHlvdSdyZSBydW5uaW5nIHRoZSBwYWNrYWdlciAiICsgJyhsb2NhbCBkZXYgc2VydmVyKSBmcm9tIGEgd3JvbmcgZm9sZGVyLiBGb3IgZXhhbXBsZSB5b3UgaGF2ZSAnICsgJ211bHRpcGxlIGFwcHMgYW5kIHRoZSBwYWNrYWdlciBpcyBzdGlsbCBydW5uaW5nIGZvciB0aGUgYXBwIHlvdSAnICsgJ3dlcmUgd29ya2luZyBvbiBiZWZvcmUuXG5JZiB0aGlzIGlzIHRoZSBjYXNlLCBzaW1wbHkga2lsbCB0aGUgb2xkICcgKyAncGFja2FnZXIgaW5zdGFuY2UgKGUuZy4gY2xvc2UgdGhlIHBhY2thZ2VyIHRlcm1pbmFsIHdpbmRvdykgJyArICdhbmQgc3RhcnQgdGhlIHBhY2thZ2VyIGluIHRoZSBjb3JyZWN0IGFwcCBmb2xkZXIgKGUuZy4gY2QgaW50byBhcHAgJyArICJmb2xkZXIgYW5kIHJ1biAnbnBtIHN0YXJ0JykuXG5cbiIgKyAnVGhpcyBlcnJvciBjYW4gYWxzbyBoYXBwZW4gZHVlIHRvIGEgcmVxdWlyZSgpIGVycm9yIGR1cmluZyAnICsgJ2luaXRpYWxpemF0aW9uIG9yIGZhaWx1cmUgdG8gY2FsbCBBcHBSZWdpc3RyeS5yZWdpc3RlckNvbXBvbmVudC5cblxuJyk7CiAgICAgIFNjZW5lVHJhY2tlci5zZXRBY3RpdmVTY2VuZSh7CiAgICAgICAgbmFtZTogYXBwS2V5CiAgICAgIH0pOwogICAgICBydW5uYWJsZXNbYXBwS2V5XS5ydW4oYXBwUGFyYW1ldGVycyk7CiAgICB9LAogICAgdW5tb3VudEFwcGxpY2F0aW9uQ29tcG9uZW50QXRSb290VGFnOiBmdW5jdGlvbiB1bm1vdW50QXBwbGljYXRpb25Db21wb25lbnRBdFJvb3RUYWcocm9vdFRhZykgewogICAgICBSZWFjdE5hdGl2ZS51bm1vdW50Q29tcG9uZW50QXROb2RlQW5kUmVtb3ZlQ29udGFpbmVyKHJvb3RUYWcpOwogICAgfSwKICAgIHJlZ2lzdGVySGVhZGxlc3NUYXNrOiBmdW5jdGlvbiByZWdpc3RlckhlYWRsZXNzVGFzayh0YXNrS2V5LCB0YXNrKSB7CiAgICAgIGlmICh0YXNrcy5oYXModGFza0tleSkpIHsKICAgICAgICBjb25zb2xlLndhcm4oInJlZ2lzdGVySGVhZGxlc3NUYXNrIGNhbGxlZCBtdWx0aXBsZSB0aW1lcyBmb3Igc2FtZSBrZXkgJyIgKyB0YXNrS2V5ICsgIiciKTsKICAgICAgfQoKICAgICAgdGFza3Muc2V0KHRhc2tLZXksIHRhc2spOwogICAgfSwKICAgIHN0YXJ0SGVhZGxlc3NUYXNrOiBmdW5jdGlvbiBzdGFydEhlYWRsZXNzVGFzayh0YXNrSWQsIHRhc2tLZXksIGRhdGEpIHsKICAgICAgdmFyIHRhc2tQcm92aWRlciA9IHRhc2tzLmdldCh0YXNrS2V5KTsKCiAgICAgIGlmICghdGFza1Byb3ZpZGVyKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyB0YXNrIHJlZ2lzdGVyZWQgZm9yIGtleSAiICsgdGFza0tleSk7CiAgICAgIH0KCiAgICAgIHRhc2tQcm92aWRlcigpKGRhdGEpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBOYXRpdmVNb2R1bGVzLkhlYWRsZXNzSnNUYXNrU3VwcG9ydC5ub3RpZnlUYXNrRmluaXNoZWQodGFza0lkKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIGNvbnNvbGUuZXJyb3IocmVhc29uKTsKICAgICAgICBOYXRpdmVNb2R1bGVzLkhlYWRsZXNzSnNUYXNrU3VwcG9ydC5ub3RpZnlUYXNrRmluaXNoZWQodGFza0lkKTsKICAgICAgfSk7CiAgICB9CiAgfTsKICBCYXRjaGVkQnJpZGdlLnJlZ2lzdGVyQ2FsbGFibGVNb2R1bGUoJ0FwcFJlZ2lzdHJ5JywgQXBwUmVnaXN0cnkpOwogIG1vZHVsZS5leHBvcnRzID0gQXBwUmVnaXN0cnk7Cn0sMzExLFsxNiwzMTIsMTUsMjEsMzE0LDk0LDEzLDMxNV0sIkFwcFJlZ2lzdHJ5Iik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2NsYXNzLCBfdGVtcDsKCiAgdmFyIFJDVERldmljZUV2ZW50RW1pdHRlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJSQ1REZXZpY2VFdmVudEVtaXR0ZXIiKTsKCiAgdmFyIE1hcCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJNYXAiKTsKCiAgdmFyIGluZm9Mb2cgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzJdLCAiaW5mb0xvZyIpOwoKICBmdW5jdGlvbiBkZWZhdWx0RXh0cmFzKCkgewogICAgQnVnUmVwb3J0aW5nLmFkZEZpbGVTb3VyY2UoJ3JlYWN0X2hpZXJhcmNoeS50eHQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiZHVtcFJlYWN0VHJlZSIpKCk7CiAgICB9KTsKICB9CgogIHZhciBCdWdSZXBvcnRpbmcgPSAoX3RlbXAgPSBfY2xhc3MgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBCdWdSZXBvcnRpbmcoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBCdWdSZXBvcnRpbmcpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhCdWdSZXBvcnRpbmcsIG51bGwsIFt7CiAgICAgIGtleTogIl9tYXliZUluaXQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX21heWJlSW5pdCgpIHsKICAgICAgICBpZiAoIUJ1Z1JlcG9ydGluZy5fc3Vic2NyaXB0aW9uKSB7CiAgICAgICAgICBCdWdSZXBvcnRpbmcuX3N1YnNjcmlwdGlvbiA9IFJDVERldmljZUV2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcignY29sbGVjdEJ1Z0V4dHJhRGF0YScsIEJ1Z1JlcG9ydGluZy5jb2xsZWN0RXh0cmFEYXRhLCBudWxsKTsKICAgICAgICAgIGRlZmF1bHRFeHRyYXMoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYWRkU291cmNlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGFkZFNvdXJjZShrZXksIGNhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2FkZFNvdXJjZShrZXksIGNhbGxiYWNrLCBCdWdSZXBvcnRpbmcuX2V4dHJhU291cmNlcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYWRkRmlsZVNvdXJjZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRGaWxlU291cmNlKGtleSwgY2FsbGJhY2spIHsKICAgICAgICByZXR1cm4gdGhpcy5fYWRkU291cmNlKGtleSwgY2FsbGJhY2ssIEJ1Z1JlcG9ydGluZy5fZmlsZVNvdXJjZXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9hZGRTb3VyY2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2FkZFNvdXJjZShrZXksIGNhbGxiYWNrLCBzb3VyY2UpIHsKICAgICAgICBCdWdSZXBvcnRpbmcuX21heWJlSW5pdCgpOwoKICAgICAgICBpZiAoc291cmNlLmhhcyhrZXkpKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oIkJ1Z1JlcG9ydGluZy5hZGQqIGNhbGxlZCBtdWx0aXBsZSB0aW1lcyBmb3Igc2FtZSBrZXkgJyIgKyBrZXkgKyAiJyIpOwogICAgICAgIH0KCiAgICAgICAgc291cmNlLnNldChrZXksIGNhbGxiYWNrKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUoKSB7CiAgICAgICAgICAgIHNvdXJjZS5kZWxldGUoa2V5KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImNvbGxlY3RFeHRyYURhdGEiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gY29sbGVjdEV4dHJhRGF0YSgpIHsKICAgICAgICB2YXIgZXh0cmFEYXRhID0ge307CgogICAgICAgIGZvciAodmFyIF9pdGVyYXRvciA9IEJ1Z1JlcG9ydGluZy5fZXh0cmFTb3VyY2VzLCBfaXNBcnJheSA9IEFycmF5LmlzQXJyYXkoX2l0ZXJhdG9yKSwgX2kgPSAwLCBfaXRlcmF0b3IgPSBfaXNBcnJheSA/IF9pdGVyYXRvciA6IF9pdGVyYXRvclt0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iID8gU3ltYm9sLml0ZXJhdG9yIDogIkBAaXRlcmF0b3IiXSgpOzspIHsKICAgICAgICAgIHZhciBfcmVmMzsKCiAgICAgICAgICBpZiAoX2lzQXJyYXkpIHsKICAgICAgICAgICAgaWYgKF9pID49IF9pdGVyYXRvci5sZW5ndGgpIGJyZWFrOwogICAgICAgICAgICBfcmVmMyA9IF9pdGVyYXRvcltfaSsrXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF9pID0gX2l0ZXJhdG9yLm5leHQoKTsKICAgICAgICAgICAgaWYgKF9pLmRvbmUpIGJyZWFrOwogICAgICAgICAgICBfcmVmMyA9IF9pLnZhbHVlOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBfcmVmID0gX3JlZjM7CgogICAgICAgICAgdmFyIF9yZWYyID0gYmFiZWxIZWxwZXJzLnNsaWNlZFRvQXJyYXkoX3JlZiwgMik7CgogICAgICAgICAgdmFyIF9rZXkgPSBfcmVmMlswXTsKICAgICAgICAgIHZhciBjYWxsYmFjayA9IF9yZWYyWzFdOwogICAgICAgICAgZXh0cmFEYXRhW19rZXldID0gY2FsbGJhY2soKTsKICAgICAgICB9CgogICAgICAgIHZhciBmaWxlRGF0YSA9IHt9OwoKICAgICAgICBmb3IgKHZhciBfaXRlcmF0b3IyID0gQnVnUmVwb3J0aW5nLl9maWxlU291cmNlcywgX2lzQXJyYXkyID0gQXJyYXkuaXNBcnJheShfaXRlcmF0b3IyKSwgX2kyID0gMCwgX2l0ZXJhdG9yMiA9IF9pc0FycmF5MiA/IF9pdGVyYXRvcjIgOiBfaXRlcmF0b3IyW3R5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgPyBTeW1ib2wuaXRlcmF0b3IgOiAiQEBpdGVyYXRvciJdKCk7OykgewogICAgICAgICAgdmFyIF9yZWY2OwoKICAgICAgICAgIGlmIChfaXNBcnJheTIpIHsKICAgICAgICAgICAgaWYgKF9pMiA+PSBfaXRlcmF0b3IyLmxlbmd0aCkgYnJlYWs7CiAgICAgICAgICAgIF9yZWY2ID0gX2l0ZXJhdG9yMltfaTIrK107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfaTIgPSBfaXRlcmF0b3IyLm5leHQoKTsKICAgICAgICAgICAgaWYgKF9pMi5kb25lKSBicmVhazsKICAgICAgICAgICAgX3JlZjYgPSBfaTIudmFsdWU7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIF9yZWY0ID0gX3JlZjY7CgogICAgICAgICAgdmFyIF9yZWY1ID0gYmFiZWxIZWxwZXJzLnNsaWNlZFRvQXJyYXkoX3JlZjQsIDIpOwoKICAgICAgICAgIHZhciBfa2V5MiA9IF9yZWY1WzBdOwogICAgICAgICAgdmFyIF9jYWxsYmFjayA9IF9yZWY1WzFdOwogICAgICAgICAgZmlsZURhdGFbX2tleTJdID0gX2NhbGxiYWNrKCk7CiAgICAgICAgfQoKICAgICAgICBpbmZvTG9nKCdCdWdSZXBvcnRpbmcgZXh0cmFEYXRhOicsIGV4dHJhRGF0YSk7CgogICAgICAgIHZhciBCdWdSZXBvcnRpbmdOYXRpdmVNb2R1bGUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiTmF0aXZlTW9kdWxlcyIpLkJ1Z1JlcG9ydGluZzsKCiAgICAgICAgQnVnUmVwb3J0aW5nTmF0aXZlTW9kdWxlICYmIEJ1Z1JlcG9ydGluZ05hdGl2ZU1vZHVsZS5zZXRFeHRyYURhdGEgJiYgQnVnUmVwb3J0aW5nTmF0aXZlTW9kdWxlLnNldEV4dHJhRGF0YShleHRyYURhdGEsIGZpbGVEYXRhKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZXh0cmFzOiBleHRyYURhdGEsCiAgICAgICAgICBmaWxlczogZmlsZURhdGEKICAgICAgICB9OwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQnVnUmVwb3J0aW5nOwogIH0oKSwgX2NsYXNzLl9leHRyYVNvdXJjZXMgPSBuZXcgTWFwKCksIF9jbGFzcy5fZmlsZVNvdXJjZXMgPSBuZXcgTWFwKCksIF9jbGFzcy5fc3Vic2NyaXB0aW9uID0gbnVsbCwgX3RlbXApOwogIG1vZHVsZS5leHBvcnRzID0gQnVnUmVwb3J0aW5nOwp9LDMxMixbNzAsMjYsOTQsMzEzLDE1XSwiQnVnUmVwb3J0aW5nIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBkdW1wUmVhY3RUcmVlKCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGdldFJlYWN0VHJlZSgpOwogICAgfSBjYXRjaCAoZSkgewogICAgICByZXR1cm4gJ0ZhaWxlZCB0byBkdW1wIHJlYWN0IHRyZWU6ICcgKyBlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0UmVhY3RUcmVlKCkgewogICAgcmV0dXJuICdSZWFjdCB0cmVlIGR1bXBzIGhhdmUgYmVlbiB0ZW1wb3JhcmlseSBkaXNhYmxlZCB3aGlsZSBSZWFjdCBpcyAnICsgJ3VwZ3JhZGVkIHRvIEZpYmVyLic7CiAgfQoKICBtb2R1bGUuZXhwb3J0cyA9IGR1bXBSZWFjdFRyZWU7Cn0sMzEzLFtdLCJkdW1wUmVhY3RUcmVlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2xpc3RlbmVycyA9IFtdOwogIHZhciBfYWN0aXZlU2NlbmUgPSB7CiAgICBuYW1lOiAnZGVmYXVsdCcKICB9OwogIHZhciBTY2VuZVRyYWNrZXIgPSB7CiAgICBzZXRBY3RpdmVTY2VuZTogZnVuY3Rpb24gc2V0QWN0aXZlU2NlbmUoc2NlbmUpIHsKICAgICAgX2FjdGl2ZVNjZW5lID0gc2NlbmU7CgogICAgICBfbGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24gKGxpc3RlbmVyKSB7CiAgICAgICAgcmV0dXJuIGxpc3RlbmVyKF9hY3RpdmVTY2VuZSk7CiAgICAgIH0pOwogICAgfSwKICAgIGdldEFjdGl2ZVNjZW5lOiBmdW5jdGlvbiBnZXRBY3RpdmVTY2VuZSgpIHsKICAgICAgcmV0dXJuIF9hY3RpdmVTY2VuZTsKICAgIH0sCiAgICBhZGRBY3RpdmVTY2VuZUNoYW5nZWRMaXN0ZW5lcjogZnVuY3Rpb24gYWRkQWN0aXZlU2NlbmVDaGFuZ2VkTGlzdGVuZXIoY2FsbGJhY2spIHsKICAgICAgX2xpc3RlbmVycy5wdXNoKGNhbGxiYWNrKTsKCiAgICAgIHJldHVybiB7CiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUoKSB7CiAgICAgICAgICBfbGlzdGVuZXJzID0gX2xpc3RlbmVycy5maWx0ZXIoZnVuY3Rpb24gKGxpc3RlbmVyKSB7CiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayAhPT0gbGlzdGVuZXI7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IFNjZW5lVHJhY2tlcjsKfSwzMTQsW10sIlNjZW5lVHJhY2tlciIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9qc3hGaWxlTmFtZSA9ICIvaG9tZS9ob2ppbi9kZXYvaWduaXRlL1RleHRUZXN0L25vZGVfbW9kdWxlcy9yZWFjdC1uYXRpdmUvTGlicmFyaWVzL1JlYWN0TmF0aXZlL3JlbmRlckFwcGxpY2F0aW9uLmpzIjsKCiAgdmFyIEFwcENvbnRhaW5lciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJBcHBDb250YWluZXIiKTsKCiAgdmFyIFJlYWN0ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIlJlYWN0Iik7CgogIHZhciBSZWFjdE5hdGl2ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJSZWFjdE5hdGl2ZSIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzRdLCAiQmFja0hhbmRsZXIiKTsKCiAgZnVuY3Rpb24gcmVuZGVyQXBwbGljYXRpb24oUm9vdENvbXBvbmVudCwgaW5pdGlhbFByb3BzLCByb290VGFnLCBXcmFwcGVyQ29tcG9uZW50KSB7CiAgICBpbnZhcmlhbnQocm9vdFRhZywgJ0V4cGVjdCB0byBoYXZlIGEgdmFsaWQgcm9vdFRhZywgaW5zdGVhZCBnb3QgJywgcm9vdFRhZyk7CiAgICB2YXIgcmVuZGVyYWJsZSA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQoCiAgICAgIEFwcENvbnRhaW5lciwKICAgICAgewogICAgICAgIHJvb3RUYWc6IHJvb3RUYWcsCiAgICAgICAgV3JhcHBlckNvbXBvbmVudDogV3JhcHBlckNvbXBvbmVudCwKICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgIGxpbmVOdW1iZXI6IDM0CiAgICAgICAgfQogICAgICB9LAogICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KFJvb3RDb21wb25lbnQsIGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBpbml0aWFsUHJvcHMsIHsKICAgICAgICByb290VGFnOiByb290VGFnLAogICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgbGluZU51bWJlcjogMzUKICAgICAgICB9CiAgICAgIH0pKQogICAgKTsKCiAgICBpZiAoUm9vdENvbXBvbmVudC5wcm90b3R5cGUgIT0gbnVsbCAmJiBSb290Q29tcG9uZW50LnByb3RvdHlwZS51bnN0YWJsZV9pc0FzeW5jUmVhY3RDb21wb25lbnQgPT09IHRydWUpIHsKICAgICAgdmFyIEFwcENvbnRhaW5lckFzeW5jV3JhcHBlciA9IGZ1bmN0aW9uIChfUmVhY3QkdW5zdGFibGVfQXN5bmMpIHsKICAgICAgICBiYWJlbEhlbHBlcnMuaW5oZXJpdHMoQXBwQ29udGFpbmVyQXN5bmNXcmFwcGVyLCBfUmVhY3QkdW5zdGFibGVfQXN5bmMpOwoKICAgICAgICBmdW5jdGlvbiBBcHBDb250YWluZXJBc3luY1dyYXBwZXIoKSB7CiAgICAgICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgQXBwQ29udGFpbmVyQXN5bmNXcmFwcGVyKTsKICAgICAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoQXBwQ29udGFpbmVyQXN5bmNXcmFwcGVyLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQXBwQ29udGFpbmVyQXN5bmNXcmFwcGVyKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgfQoKICAgICAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoQXBwQ29udGFpbmVyQXN5bmNXcmFwcGVyLCBbewogICAgICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLmNoaWxkcmVuOwogICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgICByZXR1cm4gQXBwQ29udGFpbmVyQXN5bmNXcmFwcGVyOwogICAgICB9KFJlYWN0LnVuc3RhYmxlX0FzeW5jQ29tcG9uZW50KTsKCiAgICAgIHJlbmRlcmFibGUgPSBSZWFjdC5jcmVhdGVFbGVtZW50KAogICAgICAgIEFwcENvbnRhaW5lckFzeW5jV3JhcHBlciwKICAgICAgICB7CiAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICBmaWxlTmFtZTogX2pzeEZpbGVOYW1lLAogICAgICAgICAgICBsaW5lTnVtYmVyOiA1NAogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVuZGVyYWJsZQogICAgICApOwogICAgfQoKICAgIFJlYWN0TmF0aXZlLnJlbmRlcihyZW5kZXJhYmxlLCByb290VGFnKTsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gcmVuZGVyQXBwbGljYXRpb247Cn0sMzE1LFsyNjEsMTMwLDIxLDEzLDMxNl0sInJlbmRlckFwcGxpY2F0aW9uIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgRGV2aWNlRXZlbnRNYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIk5hdGl2ZU1vZHVsZXMiKS5EZXZpY2VFdmVudE1hbmFnZXI7CgogIHZhciBSQ1REZXZpY2VFdmVudEVtaXR0ZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUkNURGV2aWNlRXZlbnRFbWl0dGVyIik7CgogIHZhciBERVZJQ0VfQkFDS19FVkVOVCA9ICdoYXJkd2FyZUJhY2tQcmVzcyc7CgogIHZhciBfYmFja1ByZXNzU3Vic2NyaXB0aW9ucyA9IG5ldyBTZXQoKTsKCiAgUkNURGV2aWNlRXZlbnRFbWl0dGVyLmFkZExpc3RlbmVyKERFVklDRV9CQUNLX0VWRU5ULCBmdW5jdGlvbiAoKSB7CiAgICB2YXIgaW52b2tlRGVmYXVsdCA9IHRydWU7CiAgICB2YXIgc3Vic2NyaXB0aW9ucyA9IEFycmF5LmZyb20oX2JhY2tQcmVzc1N1YnNjcmlwdGlvbnMudmFsdWVzKCkpLnJldmVyc2UoKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN1YnNjcmlwdGlvbnMubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKHN1YnNjcmlwdGlvbnNbaV0oKSkgewogICAgICAgIGludm9rZURlZmF1bHQgPSBmYWxzZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIGlmIChpbnZva2VEZWZhdWx0KSB7CiAgICAgIEJhY2tIYW5kbGVyLmV4aXRBcHAoKTsKICAgIH0KICB9KTsKICB2YXIgQmFja0hhbmRsZXIgPSB7CiAgICBleGl0QXBwOiBmdW5jdGlvbiBleGl0QXBwKCkgewogICAgICBEZXZpY2VFdmVudE1hbmFnZXIuaW52b2tlRGVmYXVsdEJhY2tQcmVzc0hhbmRsZXIoKTsKICAgIH0sCiAgICBhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgaGFuZGxlcikgewogICAgICBfYmFja1ByZXNzU3Vic2NyaXB0aW9ucy5hZGQoaGFuZGxlcik7CgogICAgICByZXR1cm4gewogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gcmVtb3ZlKCkgewogICAgICAgICAgcmV0dXJuIEJhY2tIYW5kbGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBoYW5kbGVyKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9LAogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24gcmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGhhbmRsZXIpIHsKICAgICAgX2JhY2tQcmVzc1N1YnNjcmlwdGlvbnMuZGVsZXRlKGhhbmRsZXIpOwogICAgfQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBCYWNrSGFuZGxlcjsKfSwzMTYsWzE1LDcwXSwiQmFja0hhbmRsZXIiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBOYXRpdmVNb2R1bGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIk5hdGl2ZU1vZHVsZXMiKTsKCiAgdmFyIFJDVEFzeW5jU3RvcmFnZSA9IE5hdGl2ZU1vZHVsZXMuQXN5bmNSb2Nrc0RCU3RvcmFnZSB8fCBOYXRpdmVNb2R1bGVzLkFzeW5jU1FMaXRlREJTdG9yYWdlIHx8IE5hdGl2ZU1vZHVsZXMuQXN5bmNMb2NhbFN0b3JhZ2U7CiAgdmFyIEFzeW5jU3RvcmFnZSA9IHsKICAgIF9nZXRSZXF1ZXN0czogW10sCiAgICBfZ2V0S2V5czogW10sCiAgICBfaW1tZWRpYXRlOiBudWxsLAogICAgZ2V0SXRlbTogZnVuY3Rpb24gZ2V0SXRlbShrZXksIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgUkNUQXN5bmNTdG9yYWdlLm11bHRpR2V0KFtrZXldLCBmdW5jdGlvbiAoZXJyb3JzLCByZXN1bHQpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHJlc3VsdCAmJiByZXN1bHRbMF0gJiYgcmVzdWx0WzBdWzFdID8gcmVzdWx0WzBdWzFdIDogbnVsbDsKICAgICAgICAgIHZhciBlcnJzID0gY29udmVydEVycm9ycyhlcnJvcnMpOwogICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soZXJycyAmJiBlcnJzWzBdLCB2YWx1ZSk7CgogICAgICAgICAgaWYgKGVycnMpIHsKICAgICAgICAgICAgcmVqZWN0KGVycnNbMF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKICAgIHNldEl0ZW06IGZ1bmN0aW9uIHNldEl0ZW0oa2V5LCB2YWx1ZSwgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBSQ1RBc3luY1N0b3JhZ2UubXVsdGlTZXQoW1trZXksIHZhbHVlXV0sIGZ1bmN0aW9uIChlcnJvcnMpIHsKICAgICAgICAgIHZhciBlcnJzID0gY29udmVydEVycm9ycyhlcnJvcnMpOwogICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soZXJycyAmJiBlcnJzWzBdKTsKCiAgICAgICAgICBpZiAoZXJycykgewogICAgICAgICAgICByZWplY3QoZXJyc1swXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlKG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgICByZW1vdmVJdGVtOiBmdW5jdGlvbiByZW1vdmVJdGVtKGtleSwgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBSQ1RBc3luY1N0b3JhZ2UubXVsdGlSZW1vdmUoW2tleV0sIGZ1bmN0aW9uIChlcnJvcnMpIHsKICAgICAgICAgIHZhciBlcnJzID0gY29udmVydEVycm9ycyhlcnJvcnMpOwogICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soZXJycyAmJiBlcnJzWzBdKTsKCiAgICAgICAgICBpZiAoZXJycykgewogICAgICAgICAgICByZWplY3QoZXJyc1swXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlKG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgICBtZXJnZUl0ZW06IGZ1bmN0aW9uIG1lcmdlSXRlbShrZXksIHZhbHVlLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIFJDVEFzeW5jU3RvcmFnZS5tdWx0aU1lcmdlKFtba2V5LCB2YWx1ZV1dLCBmdW5jdGlvbiAoZXJyb3JzKSB7CiAgICAgICAgICB2YXIgZXJycyA9IGNvbnZlcnRFcnJvcnMoZXJyb3JzKTsKICAgICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKGVycnMgJiYgZXJyc1swXSk7CgogICAgICAgICAgaWYgKGVycnMpIHsKICAgICAgICAgICAgcmVqZWN0KGVycnNbMF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzb2x2ZShudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAogICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgUkNUQXN5bmNTdG9yYWdlLmNsZWFyKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soY29udmVydEVycm9yKGVycm9yKSk7CgogICAgICAgICAgaWYgKGVycm9yICYmIGNvbnZlcnRFcnJvcihlcnJvcikpIHsKICAgICAgICAgICAgcmVqZWN0KGNvbnZlcnRFcnJvcihlcnJvcikpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzb2x2ZShudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAogICAgZ2V0QWxsS2V5czogZnVuY3Rpb24gZ2V0QWxsS2V5cyhjYWxsYmFjaykgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIFJDVEFzeW5jU3RvcmFnZS5nZXRBbGxLZXlzKGZ1bmN0aW9uIChlcnJvciwga2V5cykgewogICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soY29udmVydEVycm9yKGVycm9yKSwga2V5cyk7CgogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHJlamVjdChjb252ZXJ0RXJyb3IoZXJyb3IpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmUoa2V5cyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKICAgIGZsdXNoR2V0UmVxdWVzdHM6IGZ1bmN0aW9uIGZsdXNoR2V0UmVxdWVzdHMoKSB7CiAgICAgIHZhciBnZXRSZXF1ZXN0cyA9IHRoaXMuX2dldFJlcXVlc3RzOwogICAgICB2YXIgZ2V0S2V5cyA9IHRoaXMuX2dldEtleXM7CiAgICAgIHRoaXMuX2dldFJlcXVlc3RzID0gW107CiAgICAgIHRoaXMuX2dldEtleXMgPSBbXTsKICAgICAgUkNUQXN5bmNTdG9yYWdlLm11bHRpR2V0KGdldEtleXMsIGZ1bmN0aW9uIChlcnJvcnMsIHJlc3VsdCkgewogICAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgICByZXN1bHQgJiYgcmVzdWx0LmZvckVhY2goZnVuY3Rpb24gKF9yZWYpIHsKICAgICAgICAgIHZhciBfcmVmMiA9IGJhYmVsSGVscGVycy5zbGljZWRUb0FycmF5KF9yZWYsIDIpLAogICAgICAgICAgICAgIGtleSA9IF9yZWYyWzBdLAogICAgICAgICAgICAgIHZhbHVlID0gX3JlZjJbMV07CgogICAgICAgICAgbWFwW2tleV0gPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9KTsKICAgICAgICB2YXIgcmVxTGVuZ3RoID0gZ2V0UmVxdWVzdHMubGVuZ3RoOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlcUxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgcmVxdWVzdCA9IGdldFJlcXVlc3RzW2ldOwogICAgICAgICAgdmFyIHJlcXVlc3RLZXlzID0gcmVxdWVzdC5rZXlzOwogICAgICAgICAgdmFyIHJlcXVlc3RSZXN1bHQgPSByZXF1ZXN0S2V5cy5tYXAoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICByZXR1cm4gW2tleSwgbWFwW2tleV1dOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXF1ZXN0LmNhbGxiYWNrICYmIHJlcXVlc3QuY2FsbGJhY2sobnVsbCwgcmVxdWVzdFJlc3VsdCk7CiAgICAgICAgICByZXF1ZXN0LnJlc29sdmUgJiYgcmVxdWVzdC5yZXNvbHZlKHJlcXVlc3RSZXN1bHQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgbXVsdGlHZXQ6IGZ1bmN0aW9uIG11bHRpR2V0KGtleXMsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBpZiAoIXRoaXMuX2ltbWVkaWF0ZSkgewogICAgICAgIHRoaXMuX2ltbWVkaWF0ZSA9IHNldEltbWVkaWF0ZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpcy5faW1tZWRpYXRlID0gbnVsbDsKCiAgICAgICAgICBfdGhpcy5mbHVzaEdldFJlcXVlc3RzKCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHZhciBnZXRSZXF1ZXN0ID0gewogICAgICAgIGtleXM6IGtleXMsCiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgIGtleUluZGV4OiB0aGlzLl9nZXRLZXlzLmxlbmd0aCwKICAgICAgICByZXNvbHZlOiBudWxsLAogICAgICAgIHJlamVjdDogbnVsbAogICAgICB9OwogICAgICB2YXIgcHJvbWlzZVJlc3VsdCA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBnZXRSZXF1ZXN0LnJlc29sdmUgPSByZXNvbHZlOwogICAgICAgIGdldFJlcXVlc3QucmVqZWN0ID0gcmVqZWN0OwogICAgICB9KTsKCiAgICAgIHRoaXMuX2dldFJlcXVlc3RzLnB1c2goZ2V0UmVxdWVzdCk7CgogICAgICBrZXlzLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIGlmIChfdGhpcy5fZ2V0S2V5cy5pbmRleE9mKGtleSkgPT09IC0xKSB7CiAgICAgICAgICBfdGhpcy5fZ2V0S2V5cy5wdXNoKGtleSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHByb21pc2VSZXN1bHQ7CiAgICB9LAogICAgbXVsdGlTZXQ6IGZ1bmN0aW9uIG11bHRpU2V0KGtleVZhbHVlUGFpcnMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgUkNUQXN5bmNTdG9yYWdlLm11bHRpU2V0KGtleVZhbHVlUGFpcnMsIGZ1bmN0aW9uIChlcnJvcnMpIHsKICAgICAgICAgIHZhciBlcnJvciA9IGNvbnZlcnRFcnJvcnMoZXJyb3JzKTsKICAgICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKGVycm9yKTsKCiAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmUobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKICAgIG11bHRpUmVtb3ZlOiBmdW5jdGlvbiBtdWx0aVJlbW92ZShrZXlzLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIFJDVEFzeW5jU3RvcmFnZS5tdWx0aVJlbW92ZShrZXlzLCBmdW5jdGlvbiAoZXJyb3JzKSB7CiAgICAgICAgICB2YXIgZXJyb3IgPSBjb252ZXJ0RXJyb3JzKGVycm9ycyk7CiAgICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayhlcnJvcik7CgogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlKG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgICBtdWx0aU1lcmdlOiBmdW5jdGlvbiBtdWx0aU1lcmdlKGtleVZhbHVlUGFpcnMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgUkNUQXN5bmNTdG9yYWdlLm11bHRpTWVyZ2Uoa2V5VmFsdWVQYWlycywgZnVuY3Rpb24gKGVycm9ycykgewogICAgICAgICAgdmFyIGVycm9yID0gY29udmVydEVycm9ycyhlcnJvcnMpOwogICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soZXJyb3IpOwoKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzb2x2ZShudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgaWYgKCFSQ1RBc3luY1N0b3JhZ2UubXVsdGlNZXJnZSkgewogICAgZGVsZXRlIEFzeW5jU3RvcmFnZS5tZXJnZUl0ZW07CiAgICBkZWxldGUgQXN5bmNTdG9yYWdlLm11bHRpTWVyZ2U7CiAgfQoKICBmdW5jdGlvbiBjb252ZXJ0RXJyb3JzKGVycnMpIHsKICAgIGlmICghZXJycykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICByZXR1cm4gKEFycmF5LmlzQXJyYXkoZXJycykgPyBlcnJzIDogW2VycnNdKS5tYXAoZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIGNvbnZlcnRFcnJvcihlKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gY29udmVydEVycm9yKGVycm9yKSB7CiAgICBpZiAoIWVycm9yKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHZhciBvdXQgPSBuZXcgRXJyb3IoZXJyb3IubWVzc2FnZSk7CiAgICBvdXQua2V5ID0gZXJyb3Iua2V5OwogICAgcmV0dXJuIG91dDsKICB9CgogIG1vZHVsZS5leHBvcnRzID0gQXN5bmNTdG9yYWdlOwp9LDMxNyxbMTVdLCJBc3luY1N0b3JhZ2UiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBCYWNrSGFuZGxlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJCYWNrSGFuZGxlciIpOwoKICB2YXIgd2FybmluZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJmYmpzL2xpYi93YXJuaW5nIik7CgogIHZhciBCYWNrQW5kcm9pZCA9IHsKICAgIGV4aXRBcHA6IGZ1bmN0aW9uIGV4aXRBcHAoKSB7CiAgICAgIHdhcm5pbmcoZmFsc2UsICdCYWNrQW5kcm9pZCBpcyBkZXByZWNhdGVkLiAgUGxlYXNlIHVzZSBCYWNrSGFuZGxlciBpbnN0ZWFkLicpOwogICAgICBCYWNrSGFuZGxlci5leGl0QXBwKCk7CiAgICB9LAogICAgYWRkRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGhhbmRsZXIpIHsKICAgICAgd2FybmluZyhmYWxzZSwgJ0JhY2tBbmRyb2lkIGlzIGRlcHJlY2F0ZWQuICBQbGVhc2UgdXNlIEJhY2tIYW5kbGVyIGluc3RlYWQuJyk7CiAgICAgIHJldHVybiBCYWNrSGFuZGxlci5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgaGFuZGxlcik7CiAgICB9LAogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24gcmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGhhbmRsZXIpIHsKICAgICAgd2FybmluZyhmYWxzZSwgJ0JhY2tBbmRyb2lkIGlzIGRlcHJlY2F0ZWQuICBQbGVhc2UgdXNlIEJhY2tIYW5kbGVyIGluc3RlYWQuJyk7CiAgICAgIEJhY2tIYW5kbGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBoYW5kbGVyKTsKICAgIH0KICB9OwogIG1vZHVsZS5leHBvcnRzID0gQmFja0FuZHJvaWQ7Cn0sMzE4LFszMTYsNTZdLCJCYWNrQW5kcm9pZCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9jbGFzcywgX3RlbXA7CgogIHZhciBQcm9wVHlwZXMgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAicHJvcC10eXBlcyIpOwoKICB2YXIgY2hlY2tQcm9wVHlwZXMgPSBQcm9wVHlwZXMuY2hlY2tQcm9wVHlwZXM7CgogIHZhciBSQ1RDYW1lcmFSb2xsTWFuYWdlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJOYXRpdmVNb2R1bGVzIikuQ2FtZXJhUm9sbE1hbmFnZXI7CgogIHZhciBjcmVhdGVTdHJpY3RTaGFwZVR5cGVDaGVja2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgImNyZWF0ZVN0cmljdFNoYXBlVHlwZUNoZWNrZXIiKTsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbM10sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIEdST1VQX1RZUEVTX09QVElPTlMgPSB7CiAgICBBbGJ1bTogJ0FsYnVtJywKICAgIEFsbDogJ0FsbCcsCiAgICBFdmVudDogJ0V2ZW50JywKICAgIEZhY2VzOiAnRmFjZXMnLAogICAgTGlicmFyeTogJ0xpYnJhcnknLAogICAgUGhvdG9TdHJlYW06ICdQaG90b1N0cmVhbScsCiAgICBTYXZlZFBob3RvczogJ1NhdmVkUGhvdG9zJwogIH07CiAgdmFyIEFTU0VUX1RZUEVfT1BUSU9OUyA9IHsKICAgIEFsbDogJ0FsbCcsCiAgICBWaWRlb3M6ICdWaWRlb3MnLAogICAgUGhvdG9zOiAnUGhvdG9zJwogIH07CiAgdmFyIGdldFBob3Rvc1BhcmFtQ2hlY2tlciA9IGNyZWF0ZVN0cmljdFNoYXBlVHlwZUNoZWNrZXIoewogICAgZmlyc3Q6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCwKICAgIGFmdGVyOiBQcm9wVHlwZXMuc3RyaW5nLAogICAgZ3JvdXBUeXBlczogUHJvcFR5cGVzLm9uZU9mKE9iamVjdC5rZXlzKEdST1VQX1RZUEVTX09QVElPTlMpKSwKICAgIGdyb3VwTmFtZTogUHJvcFR5cGVzLnN0cmluZywKICAgIGFzc2V0VHlwZTogUHJvcFR5cGVzLm9uZU9mKE9iamVjdC5rZXlzKEFTU0VUX1RZUEVfT1BUSU9OUykpLAogICAgbWltZVR5cGVzOiBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMuc3RyaW5nKQogIH0pOwogIHZhciBnZXRQaG90b3NSZXR1cm5DaGVja2VyID0gY3JlYXRlU3RyaWN0U2hhcGVUeXBlQ2hlY2tlcih7CiAgICBlZGdlczogUHJvcFR5cGVzLmFycmF5T2YoY3JlYXRlU3RyaWN0U2hhcGVUeXBlQ2hlY2tlcih7CiAgICAgIG5vZGU6IGNyZWF0ZVN0cmljdFNoYXBlVHlwZUNoZWNrZXIoewogICAgICAgIHR5cGU6IFByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCwKICAgICAgICBncm91cF9uYW1lOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsCiAgICAgICAgaW1hZ2U6IGNyZWF0ZVN0cmljdFNoYXBlVHlwZUNoZWNrZXIoewogICAgICAgICAgdXJpOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsCiAgICAgICAgICBoZWlnaHQ6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCwKICAgICAgICAgIHdpZHRoOiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsCiAgICAgICAgICBpc1N0b3JlZDogUHJvcFR5cGVzLmJvb2wsCiAgICAgICAgICBwbGF5YWJsZUR1cmF0aW9uOiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQKICAgICAgICB9KS5pc1JlcXVpcmVkLAogICAgICAgIHRpbWVzdGFtcDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLAogICAgICAgIGxvY2F0aW9uOiBjcmVhdGVTdHJpY3RTaGFwZVR5cGVDaGVja2VyKHsKICAgICAgICAgIGxhdGl0dWRlOiBQcm9wVHlwZXMubnVtYmVyLAogICAgICAgICAgbG9uZ2l0dWRlOiBQcm9wVHlwZXMubnVtYmVyLAogICAgICAgICAgYWx0aXR1ZGU6IFByb3BUeXBlcy5udW1iZXIsCiAgICAgICAgICBoZWFkaW5nOiBQcm9wVHlwZXMubnVtYmVyLAogICAgICAgICAgc3BlZWQ6IFByb3BUeXBlcy5udW1iZXIKICAgICAgICB9KQogICAgICB9KS5pc1JlcXVpcmVkCiAgICB9KSkuaXNSZXF1aXJlZCwKICAgIHBhZ2VfaW5mbzogY3JlYXRlU3RyaWN0U2hhcGVUeXBlQ2hlY2tlcih7CiAgICAgIGhhc19uZXh0X3BhZ2U6IFByb3BUeXBlcy5ib29sLmlzUmVxdWlyZWQsCiAgICAgIHN0YXJ0X2N1cnNvcjogUHJvcFR5cGVzLnN0cmluZywKICAgICAgZW5kX2N1cnNvcjogUHJvcFR5cGVzLnN0cmluZwogICAgfSkuaXNSZXF1aXJlZAogIH0pOwogIHZhciBDYW1lcmFSb2xsID0gKF90ZW1wID0gX2NsYXNzID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ2FtZXJhUm9sbCgpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIENhbWVyYVJvbGwpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhDYW1lcmFSb2xsLCBudWxsLCBbewogICAgICBrZXk6ICJzYXZlSW1hZ2VXaXRoVGFnIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNhdmVJbWFnZVdpdGhUYWcodGFnKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdgQ2FtZXJhUm9sbC5zYXZlSW1hZ2VXaXRoVGFnKClgIGlzIGRlcHJlY2F0ZWQuIFVzZSBgQ2FtZXJhUm9sbC5zYXZlVG9DYW1lcmFSb2xsKClgIGluc3RlYWQuJyk7CiAgICAgICAgcmV0dXJuIHRoaXMuc2F2ZVRvQ2FtZXJhUm9sbCh0YWcsICdwaG90bycpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImRlbGV0ZVBob3RvcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBkZWxldGVQaG90b3MocGhvdG9zKSB7CiAgICAgICAgcmV0dXJuIFJDVENhbWVyYVJvbGxNYW5hZ2VyLmRlbGV0ZVBob3RvcyhwaG90b3MpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNhdmVUb0NhbWVyYVJvbGwiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2F2ZVRvQ2FtZXJhUm9sbCh0YWcsIHR5cGUpIHsKICAgICAgICBpbnZhcmlhbnQodHlwZW9mIHRhZyA9PT0gJ3N0cmluZycsICdDYW1lcmFSb2xsLnNhdmVUb0NhbWVyYVJvbGwgbXVzdCBiZSBhIHZhbGlkIHN0cmluZy4nKTsKICAgICAgICBpbnZhcmlhbnQodHlwZSA9PT0gJ3Bob3RvJyB8fCB0eXBlID09PSAndmlkZW8nIHx8IHR5cGUgPT09IHVuZGVmaW5lZCwgIlRoZSBzZWNvbmQgYXJndW1lbnQgdG8gc2F2ZVRvQ2FtZXJhUm9sbCBtdXN0IGJlICdwaG90bycgb3IgJ3ZpZGVvJy4gWW91IHBhc3NlZCAiICsgKHR5cGUgfHwgJ3Vua25vd24nKSk7CiAgICAgICAgdmFyIG1lZGlhVHlwZSA9ICdwaG90byc7CgogICAgICAgIGlmICh0eXBlKSB7CiAgICAgICAgICBtZWRpYVR5cGUgPSB0eXBlOwogICAgICAgIH0gZWxzZSBpZiAoWydtb3YnLCAnbXA0J10uaW5kZXhPZih0YWcuc3BsaXQoJy4nKS5zbGljZSgtMSlbMF0pID49IDApIHsKICAgICAgICAgIG1lZGlhVHlwZSA9ICd2aWRlbyc7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gUkNUQ2FtZXJhUm9sbE1hbmFnZXIuc2F2ZVRvQ2FtZXJhUm9sbCh0YWcsIG1lZGlhVHlwZSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0UGhvdG9zIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFBob3RvcyhwYXJhbXMpIHsKICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgY2hlY2tQcm9wVHlwZXMoewogICAgICAgICAgICBwYXJhbXM6IGdldFBob3Rvc1BhcmFtQ2hlY2tlcgogICAgICAgICAgfSwgewogICAgICAgICAgICBwYXJhbXM6IHBhcmFtcwogICAgICAgICAgfSwgJ3BhcmFtcycsICdDYW1lcmFSb2xsLmdldFBob3RvcycpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oJ0NhbWVyYVJvbGwuZ2V0UGhvdG9zKHRhZywgc3VjY2VzcywgZXJyb3IpIGlzIGRlcHJlY2F0ZWQuICBVc2UgdGhlIHJldHVybmVkIFByb21pc2UgaW5zdGVhZCcpOwogICAgICAgICAgdmFyIHN1Y2Nlc3NDYWxsYmFjayA9IGFyZ3VtZW50c1sxXTsKCiAgICAgICAgICBpZiAoX19ERVZfXykgewogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBhcmd1bWVudHNbMV07CgogICAgICAgICAgICBzdWNjZXNzQ2FsbGJhY2sgPSBmdW5jdGlvbiBzdWNjZXNzQ2FsbGJhY2socmVzcG9uc2UpIHsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyh7CiAgICAgICAgICAgICAgICByZXNwb25zZTogZ2V0UGhvdG9zUmV0dXJuQ2hlY2tlcgogICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIHJlc3BvbnNlOiByZXNwb25zZQogICAgICAgICAgICAgIH0sICdyZXNwb25zZScsICdDYW1lcmFSb2xsLmdldFBob3RvcyBjYWxsYmFjaycpOwogICAgICAgICAgICAgIGNhbGxiYWNrKHJlc3BvbnNlKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZXJyb3JDYWxsYmFjayA9IGFyZ3VtZW50c1syXSB8fCBmdW5jdGlvbiAoKSB7fTsKCiAgICAgICAgICBSQ1RDYW1lcmFSb2xsTWFuYWdlci5nZXRQaG90b3MocGFyYW1zKS50aGVuKHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gUkNUQ2FtZXJhUm9sbE1hbmFnZXIuZ2V0UGhvdG9zKHBhcmFtcyk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBDYW1lcmFSb2xsOwogIH0oKSwgX2NsYXNzLkdyb3VwVHlwZXNPcHRpb25zID0gR1JPVVBfVFlQRVNfT1BUSU9OUywgX2NsYXNzLkFzc2V0VHlwZU9wdGlvbnMgPSBBU1NFVF9UWVBFX09QVElPTlMsIF90ZW1wKTsKICBtb2R1bGUuZXhwb3J0cyA9IENhbWVyYVJvbGw7Cn0sMzE5LFsxMjcsMTUsMTMzLDEzXSwiQ2FtZXJhUm9sbCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIENsaXBib2FyZCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIikuQ2xpcGJvYXJkOwoKICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGdldFN0cmluZzogZnVuY3Rpb24gZ2V0U3RyaW5nKCkgewogICAgICByZXR1cm4gQ2xpcGJvYXJkLmdldFN0cmluZygpOwogICAgfSwKICAgIHNldFN0cmluZzogZnVuY3Rpb24gc2V0U3RyaW5nKGNvbnRlbnQpIHsKICAgICAgQ2xpcGJvYXJkLnNldFN0cmluZyhjb250ZW50KTsKICAgIH0KICB9Owp9LDMyMCxbMTVdLCJDbGlwYm9hcmQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBEYXRlUGlja2VyTW9kdWxlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIk5hdGl2ZU1vZHVsZXMiKS5EYXRlUGlja2VyQW5kcm9pZDsKCiAgZnVuY3Rpb24gX3RvTWlsbGlzKG9wdGlvbnMsIGtleSkgewogICAgdmFyIGRhdGVWYWwgPSBvcHRpb25zW2tleV07CgogICAgaWYgKHR5cGVvZiBkYXRlVmFsID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgZGF0ZVZhbC5nZXRNb250aCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBvcHRpb25zW2tleV0gPSBkYXRlVmFsLmdldFRpbWUoKTsKICAgIH0KICB9CgogIHZhciBEYXRlUGlja2VyQW5kcm9pZCA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIERhdGVQaWNrZXJBbmRyb2lkKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgRGF0ZVBpY2tlckFuZHJvaWQpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhEYXRlUGlja2VyQW5kcm9pZCwgbnVsbCwgW3sKICAgICAga2V5OiAib3BlbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBvcGVuKG9wdGlvbnMpIHsKICAgICAgICB2YXIgb3B0aW9uc01zOwogICAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUuYXN5bmMoZnVuY3Rpb24gb3BlbiQoX2NvbnRleHQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBvcHRpb25zTXMgPSBvcHRpb25zOwoKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zTXMpIHsKICAgICAgICAgICAgICAgICAgX3RvTWlsbGlzKG9wdGlvbnMsICdkYXRlJyk7CgogICAgICAgICAgICAgICAgICBfdG9NaWxsaXMob3B0aW9ucywgJ21pbkRhdGUnKTsKCiAgICAgICAgICAgICAgICAgIF90b01pbGxpcyhvcHRpb25zLCAnbWF4RGF0ZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsIERhdGVQaWNrZXJNb2R1bGUub3BlbihvcHRpb25zKSk7CgogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIG51bGwsIHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImRhdGVTZXRBY3Rpb24iLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gJ2RhdGVTZXRBY3Rpb24nOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImRpc21pc3NlZEFjdGlvbiIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAnZGlzbWlzc2VkQWN0aW9uJzsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIERhdGVQaWNrZXJBbmRyb2lkOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBEYXRlUGlja2VyQW5kcm9pZDsKfSwzMjEsWzE1XSwiRGF0ZVBpY2tlckFuZHJvaWQiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBSQ1RJbWFnZVBpY2tlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIikuSW1hZ2VQaWNrZXJJT1M7CgogIHZhciBJbWFnZVBpY2tlcklPUyA9IHsKICAgIGNhblJlY29yZFZpZGVvczogZnVuY3Rpb24gY2FuUmVjb3JkVmlkZW9zKGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBSQ1RJbWFnZVBpY2tlci5jYW5SZWNvcmRWaWRlb3MoY2FsbGJhY2spOwogICAgfSwKICAgIGNhblVzZUNhbWVyYTogZnVuY3Rpb24gY2FuVXNlQ2FtZXJhKGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBSQ1RJbWFnZVBpY2tlci5jYW5Vc2VDYW1lcmEoY2FsbGJhY2spOwogICAgfSwKICAgIG9wZW5DYW1lcmFEaWFsb2c6IGZ1bmN0aW9uIG9wZW5DYW1lcmFEaWFsb2coY29uZmlnLCBzdWNjZXNzQ2FsbGJhY2ssIGNhbmNlbENhbGxiYWNrKSB7CiAgICAgIGNvbmZpZyA9IGJhYmVsSGVscGVycy5leHRlbmRzKHsKICAgICAgICB2aWRlb01vZGU6IGZhbHNlCiAgICAgIH0sIGNvbmZpZyk7CiAgICAgIHJldHVybiBSQ1RJbWFnZVBpY2tlci5vcGVuQ2FtZXJhRGlhbG9nKGNvbmZpZywgc3VjY2Vzc0NhbGxiYWNrLCBjYW5jZWxDYWxsYmFjayk7CiAgICB9LAogICAgb3BlblNlbGVjdERpYWxvZzogZnVuY3Rpb24gb3BlblNlbGVjdERpYWxvZyhjb25maWcsIHN1Y2Nlc3NDYWxsYmFjaywgY2FuY2VsQ2FsbGJhY2spIHsKICAgICAgY29uZmlnID0gYmFiZWxIZWxwZXJzLmV4dGVuZHMoewogICAgICAgIHNob3dJbWFnZXM6IHRydWUsCiAgICAgICAgc2hvd1ZpZGVvczogZmFsc2UKICAgICAgfSwgY29uZmlnKTsKICAgICAgcmV0dXJuIFJDVEltYWdlUGlja2VyLm9wZW5TZWxlY3REaWFsb2coY29uZmlnLCBzdWNjZXNzQ2FsbGJhY2ssIGNhbmNlbENhbGxiYWNrKTsKICAgIH0KICB9OwogIG1vZHVsZS5leHBvcnRzID0gSW1hZ2VQaWNrZXJJT1M7Cn0sMzIyLFsxNV0sIkltYWdlUGlja2VySU9TIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgTmF0aXZlRXZlbnRFbWl0dGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIk5hdGl2ZUV2ZW50RW1pdHRlciIpOwoKICB2YXIgTmF0aXZlTW9kdWxlcyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICJOYXRpdmVNb2R1bGVzIik7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJQbGF0Zm9ybSIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgTGlua2luZ01hbmFnZXIgPSBQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnID8gTmF0aXZlTW9kdWxlcy5JbnRlbnRBbmRyb2lkIDogTmF0aXZlTW9kdWxlcy5MaW5raW5nTWFuYWdlcjsKCiAgdmFyIExpbmtpbmcgPSBmdW5jdGlvbiAoX05hdGl2ZUV2ZW50RW1pdHRlcikgewogICAgYmFiZWxIZWxwZXJzLmluaGVyaXRzKExpbmtpbmcsIF9OYXRpdmVFdmVudEVtaXR0ZXIpOwoKICAgIGZ1bmN0aW9uIExpbmtpbmcoKSB7CiAgICAgIGJhYmVsSGVscGVycy5jbGFzc0NhbGxDaGVjayh0aGlzLCBMaW5raW5nKTsKICAgICAgcmV0dXJuIGJhYmVsSGVscGVycy5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIChMaW5raW5nLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoTGlua2luZykpLmNhbGwodGhpcywgTGlua2luZ01hbmFnZXIpKTsKICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoTGlua2luZywgW3sKICAgICAga2V5OiAiYWRkRXZlbnRMaXN0ZW5lciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZXIpIHsKICAgICAgICB0aGlzLmFkZExpc3RlbmVyKHR5cGUsIGhhbmRsZXIpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZUV2ZW50TGlzdGVuZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBoYW5kbGVyKSB7CiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBoYW5kbGVyKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJvcGVuVVJMIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIG9wZW5VUkwodXJsKSB7CiAgICAgICAgdGhpcy5fdmFsaWRhdGVVUkwodXJsKTsKCiAgICAgICAgcmV0dXJuIExpbmtpbmdNYW5hZ2VyLm9wZW5VUkwodXJsKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJjYW5PcGVuVVJMIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNhbk9wZW5VUkwodXJsKSB7CiAgICAgICAgdGhpcy5fdmFsaWRhdGVVUkwodXJsKTsKCiAgICAgICAgcmV0dXJuIExpbmtpbmdNYW5hZ2VyLmNhbk9wZW5VUkwodXJsKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRJbml0aWFsVVJMIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldEluaXRpYWxVUkwoKSB7CiAgICAgICAgcmV0dXJuIExpbmtpbmdNYW5hZ2VyLmdldEluaXRpYWxVUkwoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfdmFsaWRhdGVVUkwiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX3ZhbGlkYXRlVVJMKHVybCkgewogICAgICAgIGludmFyaWFudCh0eXBlb2YgdXJsID09PSAnc3RyaW5nJywgJ0ludmFsaWQgVVJMOiBzaG91bGQgYmUgYSBzdHJpbmcuIFdhczogJyArIHVybCk7CiAgICAgICAgaW52YXJpYW50KHVybCwgJ0ludmFsaWQgVVJMOiBjYW5ub3QgYmUgZW1wdHknKTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIExpbmtpbmc7CiAgfShOYXRpdmVFdmVudEVtaXR0ZXIpOwoKICBtb2R1bGUuZXhwb3J0cyA9IG5ldyBMaW5raW5nKCk7Cn0sMzIzLFs2OSwxNSw1MiwxM10sIkxpbmtpbmciKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBNYXAgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzBdLCAiTWFwIik7CgogIHZhciBOYXRpdmVFdmVudEVtaXR0ZXIgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiTmF0aXZlRXZlbnRFbWl0dGVyIik7CgogIHZhciBOYXRpdmVNb2R1bGVzID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgIk5hdGl2ZU1vZHVsZXMiKTsKCiAgdmFyIFBsYXRmb3JtID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFszXSwgIlBsYXRmb3JtIik7CgogIHZhciBSQ1ROZXRJbmZvID0gTmF0aXZlTW9kdWxlcy5OZXRJbmZvOwogIHZhciBOZXRJbmZvRXZlbnRFbWl0dGVyID0gbmV3IE5hdGl2ZUV2ZW50RW1pdHRlcihSQ1ROZXRJbmZvKTsKICB2YXIgREVWSUNFX0NPTk5FQ1RJVklUWV9FVkVOVCA9ICduZXR3b3JrU3RhdHVzRGlkQ2hhbmdlJzsKCiAgdmFyIF9zdWJzY3JpcHRpb25zID0gbmV3IE1hcCgpOwoKICB2YXIgX2lzQ29ubmVjdGVkRGVwcmVjYXRlZCA9IHZvaWQgMDsKCiAgaWYgKFBsYXRmb3JtLk9TID09PSAnaW9zJykgewogICAgX2lzQ29ubmVjdGVkRGVwcmVjYXRlZCA9IGZ1bmN0aW9uIF9pc0Nvbm5lY3RlZERlcHJlY2F0ZWQocmVhY2hhYmlsaXR5KSB7CiAgICAgIHJldHVybiByZWFjaGFiaWxpdHkgIT09ICdub25lJyAmJiByZWFjaGFiaWxpdHkgIT09ICd1bmtub3duJzsKICAgIH07CiAgfSBlbHNlIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7CiAgICBfaXNDb25uZWN0ZWREZXByZWNhdGVkID0gZnVuY3Rpb24gX2lzQ29ubmVjdGVkRGVwcmVjYXRlZChjb25uZWN0aW9uVHlwZSkgewogICAgICByZXR1cm4gY29ubmVjdGlvblR5cGUgIT09ICdOT05FJyAmJiBjb25uZWN0aW9uVHlwZSAhPT0gJ1VOS05PV04nOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIF9pc0Nvbm5lY3RlZChjb25uZWN0aW9uKSB7CiAgICByZXR1cm4gY29ubmVjdGlvbi50eXBlICE9PSAnbm9uZScgJiYgY29ubmVjdGlvbi50eXBlICE9PSAndW5rbm93bic7CiAgfQoKICB2YXIgX2lzQ29ubmVjdGVkU3Vic2NyaXB0aW9ucyA9IG5ldyBNYXAoKTsKCiAgdmFyIE5ldEluZm8gPSB7CiAgICBhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgaGFuZGxlcikgewogICAgICB2YXIgbGlzdGVuZXIgPSB2b2lkIDA7CgogICAgICBpZiAoZXZlbnROYW1lID09PSAnY29ubmVjdGlvbkNoYW5nZScpIHsKICAgICAgICBsaXN0ZW5lciA9IE5ldEluZm9FdmVudEVtaXR0ZXIuYWRkTGlzdGVuZXIoREVWSUNFX0NPTk5FQ1RJVklUWV9FVkVOVCwgZnVuY3Rpb24gKGFwcFN0YXRlRGF0YSkgewogICAgICAgICAgaGFuZGxlcih7CiAgICAgICAgICAgIHR5cGU6IGFwcFN0YXRlRGF0YS5jb25uZWN0aW9uVHlwZSwKICAgICAgICAgICAgZWZmZWN0aXZlVHlwZTogYXBwU3RhdGVEYXRhLmVmZmVjdGl2ZUNvbm5lY3Rpb25UeXBlCiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChldmVudE5hbWUgPT09ICdjaGFuZ2UnKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdOZXRJbmZvXCdzICJjaGFuZ2UiIGV2ZW50IGlzIGRlcHJlY2F0ZWQuIExpc3RlbiB0byB0aGUgImNvbm5lY3Rpb25DaGFuZ2UiIGV2ZW50IGluc3RlYWQuJyk7CiAgICAgICAgbGlzdGVuZXIgPSBOZXRJbmZvRXZlbnRFbWl0dGVyLmFkZExpc3RlbmVyKERFVklDRV9DT05ORUNUSVZJVFlfRVZFTlQsIGZ1bmN0aW9uIChhcHBTdGF0ZURhdGEpIHsKICAgICAgICAgIGhhbmRsZXIoYXBwU3RhdGVEYXRhLm5ldHdvcmtfaW5mbyk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS53YXJuKCdUcnlpbmcgdG8gc3Vic2NyaWJlIHRvIHVua25vd24gZXZlbnQ6ICInICsgZXZlbnROYW1lICsgJyInKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUoKSB7fQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIF9zdWJzY3JpcHRpb25zLnNldChoYW5kbGVyLCBsaXN0ZW5lcik7CgogICAgICByZXR1cm4gewogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gcmVtb3ZlKCkgewogICAgICAgICAgcmV0dXJuIE5ldEluZm8ucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGhhbmRsZXIpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0sCiAgICByZW1vdmVFdmVudExpc3RlbmVyOiBmdW5jdGlvbiByZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgaGFuZGxlcikgewogICAgICB2YXIgbGlzdGVuZXIgPSBfc3Vic2NyaXB0aW9ucy5nZXQoaGFuZGxlcik7CgogICAgICBpZiAoIWxpc3RlbmVyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBsaXN0ZW5lci5yZW1vdmUoKTsKCiAgICAgIF9zdWJzY3JpcHRpb25zLmRlbGV0ZShoYW5kbGVyKTsKICAgIH0sCiAgICBmZXRjaDogZnVuY3Rpb24gZmV0Y2goKSB7CiAgICAgIGNvbnNvbGUud2FybignTmV0SW5mby5mZXRjaCgpIGlzIGRlcHJlY2F0ZWQuIFVzZSBOZXRJbmZvLmdldENvbm5lY3Rpb25JbmZvKCkgaW5zdGVhZC4nKTsKICAgICAgcmV0dXJuIFJDVE5ldEluZm8uZ2V0Q3VycmVudENvbm5lY3Rpdml0eSgpLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICByZXR1cm4gcmVzcC5uZXR3b3JrX2luZm87CiAgICAgIH0pOwogICAgfSwKICAgIGdldENvbm5lY3Rpb25JbmZvOiBmdW5jdGlvbiBnZXRDb25uZWN0aW9uSW5mbygpIHsKICAgICAgcmV0dXJuIFJDVE5ldEluZm8uZ2V0Q3VycmVudENvbm5lY3Rpdml0eSgpLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogcmVzcC5jb25uZWN0aW9uVHlwZSwKICAgICAgICAgIGVmZmVjdGl2ZVR5cGU6IHJlc3AuZWZmZWN0aXZlQ29ubmVjdGlvblR5cGUKICAgICAgICB9OwogICAgICB9KTsKICAgIH0sCiAgICBpc0Nvbm5lY3RlZDogewogICAgICBhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgaGFuZGxlcikgewogICAgICAgIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uIGxpc3RlbmVyKGNvbm5lY3Rpb24pIHsKICAgICAgICAgIGlmIChldmVudE5hbWUgPT09ICdjaGFuZ2UnKSB7CiAgICAgICAgICAgIGhhbmRsZXIoX2lzQ29ubmVjdGVkRGVwcmVjYXRlZChjb25uZWN0aW9uKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50TmFtZSA9PT0gJ2Nvbm5lY3Rpb25DaGFuZ2UnKSB7CiAgICAgICAgICAgIGhhbmRsZXIoX2lzQ29ubmVjdGVkKGNvbm5lY3Rpb24pKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBfaXNDb25uZWN0ZWRTdWJzY3JpcHRpb25zLnNldChoYW5kbGVyLCBsaXN0ZW5lcik7CgogICAgICAgIE5ldEluZm8uYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGxpc3RlbmVyKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUoKSB7CiAgICAgICAgICAgIHJldHVybiBOZXRJbmZvLmlzQ29ubmVjdGVkLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBoYW5kbGVyKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9LAogICAgICByZW1vdmVFdmVudExpc3RlbmVyOiBmdW5jdGlvbiByZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgaGFuZGxlcikgewogICAgICAgIHZhciBsaXN0ZW5lciA9IF9pc0Nvbm5lY3RlZFN1YnNjcmlwdGlvbnMuZ2V0KGhhbmRsZXIpOwoKICAgICAgICBOZXRJbmZvLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBsaXN0ZW5lcik7CgogICAgICAgIF9pc0Nvbm5lY3RlZFN1YnNjcmlwdGlvbnMuZGVsZXRlKGhhbmRsZXIpOwogICAgICB9LAogICAgICBmZXRjaDogZnVuY3Rpb24gZmV0Y2goKSB7CiAgICAgICAgcmV0dXJuIE5ldEluZm8uZ2V0Q29ubmVjdGlvbkluZm8oKS50aGVuKF9pc0Nvbm5lY3RlZCk7CiAgICAgIH0KICAgIH0sCiAgICBpc0Nvbm5lY3Rpb25FeHBlbnNpdmU6IGZ1bmN0aW9uIGlzQ29ubmVjdGlvbkV4cGVuc2l2ZSgpIHsKICAgICAgcmV0dXJuIFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcgPyBSQ1ROZXRJbmZvLmlzQ29ubmVjdGlvbk1ldGVyZWQoKSA6IFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignQ3VycmVudGx5IG5vdCBzdXBwb3J0ZWQgb24gaU9TJykpOwogICAgfQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBOZXRJbmZvOwp9LDMyNCxbMjYsNjksMTUsNTJdLCJOZXRJbmZvIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX2NsYXNzLCBfdGVtcDsKCiAgdmFyIE5hdGl2ZUV2ZW50RW1pdHRlciA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVFdmVudEVtaXR0ZXIiKTsKCiAgdmFyIFJDVFB1c2hOb3RpZmljYXRpb25NYW5hZ2VyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgIk5hdGl2ZU1vZHVsZXMiKS5QdXNoTm90aWZpY2F0aW9uTWFuYWdlcjsKCiAgdmFyIGludmFyaWFudCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMl0sICJmYmpzL2xpYi9pbnZhcmlhbnQiKTsKCiAgdmFyIFB1c2hOb3RpZmljYXRpb25FbWl0dGVyID0gbmV3IE5hdGl2ZUV2ZW50RW1pdHRlcihSQ1RQdXNoTm90aWZpY2F0aW9uTWFuYWdlcik7CgogIHZhciBfbm90aWZIYW5kbGVycyA9IG5ldyBNYXAoKTsKCiAgdmFyIERFVklDRV9OT1RJRl9FVkVOVCA9ICdyZW1vdGVOb3RpZmljYXRpb25SZWNlaXZlZCc7CiAgdmFyIE5PVElGX1JFR0lTVEVSX0VWRU5UID0gJ3JlbW90ZU5vdGlmaWNhdGlvbnNSZWdpc3RlcmVkJzsKICB2YXIgTk9USUZfUkVHSVNUUkFUSU9OX0VSUk9SX0VWRU5UID0gJ3JlbW90ZU5vdGlmaWNhdGlvblJlZ2lzdHJhdGlvbkVycm9yJzsKICB2YXIgREVWSUNFX0xPQ0FMX05PVElGX0VWRU5UID0gJ2xvY2FsTm90aWZpY2F0aW9uUmVjZWl2ZWQnOwogIHZhciBQdXNoTm90aWZpY2F0aW9uSU9TID0gKF90ZW1wID0gX2NsYXNzID0gZnVuY3Rpb24gKCkgewogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKFB1c2hOb3RpZmljYXRpb25JT1MsIG51bGwsIFt7CiAgICAgIGtleTogInByZXNlbnRMb2NhbE5vdGlmaWNhdGlvbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBwcmVzZW50TG9jYWxOb3RpZmljYXRpb24oZGV0YWlscykgewogICAgICAgIFJDVFB1c2hOb3RpZmljYXRpb25NYW5hZ2VyLnByZXNlbnRMb2NhbE5vdGlmaWNhdGlvbihkZXRhaWxzKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJzY2hlZHVsZUxvY2FsTm90aWZpY2F0aW9uIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNjaGVkdWxlTG9jYWxOb3RpZmljYXRpb24oZGV0YWlscykgewogICAgICAgIFJDVFB1c2hOb3RpZmljYXRpb25NYW5hZ2VyLnNjaGVkdWxlTG9jYWxOb3RpZmljYXRpb24oZGV0YWlscyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY2FuY2VsQWxsTG9jYWxOb3RpZmljYXRpb25zIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNhbmNlbEFsbExvY2FsTm90aWZpY2F0aW9ucygpIHsKICAgICAgICBSQ1RQdXNoTm90aWZpY2F0aW9uTWFuYWdlci5jYW5jZWxBbGxMb2NhbE5vdGlmaWNhdGlvbnMoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJyZW1vdmVBbGxEZWxpdmVyZWROb3RpZmljYXRpb25zIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUFsbERlbGl2ZXJlZE5vdGlmaWNhdGlvbnMoKSB7CiAgICAgICAgUkNUUHVzaE5vdGlmaWNhdGlvbk1hbmFnZXIucmVtb3ZlQWxsRGVsaXZlcmVkTm90aWZpY2F0aW9ucygpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldERlbGl2ZXJlZE5vdGlmaWNhdGlvbnMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0RGVsaXZlcmVkTm90aWZpY2F0aW9ucyhjYWxsYmFjaykgewogICAgICAgIFJDVFB1c2hOb3RpZmljYXRpb25NYW5hZ2VyLmdldERlbGl2ZXJlZE5vdGlmaWNhdGlvbnMoY2FsbGJhY2spOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInJlbW92ZURlbGl2ZXJlZE5vdGlmaWNhdGlvbnMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlRGVsaXZlcmVkTm90aWZpY2F0aW9ucyhpZGVudGlmaWVycykgewogICAgICAgIFJDVFB1c2hOb3RpZmljYXRpb25NYW5hZ2VyLnJlbW92ZURlbGl2ZXJlZE5vdGlmaWNhdGlvbnMoaWRlbnRpZmllcnMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogInNldEFwcGxpY2F0aW9uSWNvbkJhZGdlTnVtYmVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldEFwcGxpY2F0aW9uSWNvbkJhZGdlTnVtYmVyKG51bWJlcikgewogICAgICAgIFJDVFB1c2hOb3RpZmljYXRpb25NYW5hZ2VyLnNldEFwcGxpY2F0aW9uSWNvbkJhZGdlTnVtYmVyKG51bWJlcik7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0QXBwbGljYXRpb25JY29uQmFkZ2VOdW1iZXIiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0QXBwbGljYXRpb25JY29uQmFkZ2VOdW1iZXIoY2FsbGJhY2spIHsKICAgICAgICBSQ1RQdXNoTm90aWZpY2F0aW9uTWFuYWdlci5nZXRBcHBsaWNhdGlvbkljb25CYWRnZU51bWJlcihjYWxsYmFjayk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY2FuY2VsTG9jYWxOb3RpZmljYXRpb25zIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNhbmNlbExvY2FsTm90aWZpY2F0aW9ucyh1c2VySW5mbykgewogICAgICAgIFJDVFB1c2hOb3RpZmljYXRpb25NYW5hZ2VyLmNhbmNlbExvY2FsTm90aWZpY2F0aW9ucyh1c2VySW5mbyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0U2NoZWR1bGVkTG9jYWxOb3RpZmljYXRpb25zIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFNjaGVkdWxlZExvY2FsTm90aWZpY2F0aW9ucyhjYWxsYmFjaykgewogICAgICAgIFJDVFB1c2hOb3RpZmljYXRpb25NYW5hZ2VyLmdldFNjaGVkdWxlZExvY2FsTm90aWZpY2F0aW9ucyhjYWxsYmFjayk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiYWRkRXZlbnRMaXN0ZW5lciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZXIpIHsKICAgICAgICBpbnZhcmlhbnQodHlwZSA9PT0gJ25vdGlmaWNhdGlvbicgfHwgdHlwZSA9PT0gJ3JlZ2lzdGVyJyB8fCB0eXBlID09PSAncmVnaXN0cmF0aW9uRXJyb3InIHx8IHR5cGUgPT09ICdsb2NhbE5vdGlmaWNhdGlvbicsICdQdXNoTm90aWZpY2F0aW9uSU9TIG9ubHkgc3VwcG9ydHMgYG5vdGlmaWNhdGlvbmAsIGByZWdpc3RlcmAsIGByZWdpc3RyYXRpb25FcnJvcmAsIGFuZCBgbG9jYWxOb3RpZmljYXRpb25gIGV2ZW50cycpOwogICAgICAgIHZhciBsaXN0ZW5lcjsKCiAgICAgICAgaWYgKHR5cGUgPT09ICdub3RpZmljYXRpb24nKSB7CiAgICAgICAgICBsaXN0ZW5lciA9IFB1c2hOb3RpZmljYXRpb25FbWl0dGVyLmFkZExpc3RlbmVyKERFVklDRV9OT1RJRl9FVkVOVCwgZnVuY3Rpb24gKG5vdGlmRGF0YSkgewogICAgICAgICAgICBoYW5kbGVyKG5ldyBQdXNoTm90aWZpY2F0aW9uSU9TKG5vdGlmRGF0YSkpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbG9jYWxOb3RpZmljYXRpb24nKSB7CiAgICAgICAgICBsaXN0ZW5lciA9IFB1c2hOb3RpZmljYXRpb25FbWl0dGVyLmFkZExpc3RlbmVyKERFVklDRV9MT0NBTF9OT1RJRl9FVkVOVCwgZnVuY3Rpb24gKG5vdGlmRGF0YSkgewogICAgICAgICAgICBoYW5kbGVyKG5ldyBQdXNoTm90aWZpY2F0aW9uSU9TKG5vdGlmRGF0YSkpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAncmVnaXN0ZXInKSB7CiAgICAgICAgICBsaXN0ZW5lciA9IFB1c2hOb3RpZmljYXRpb25FbWl0dGVyLmFkZExpc3RlbmVyKE5PVElGX1JFR0lTVEVSX0VWRU5ULCBmdW5jdGlvbiAocmVnaXN0cmF0aW9uSW5mbykgewogICAgICAgICAgICBoYW5kbGVyKHJlZ2lzdHJhdGlvbkluZm8uZGV2aWNlVG9rZW4pOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAncmVnaXN0cmF0aW9uRXJyb3InKSB7CiAgICAgICAgICBsaXN0ZW5lciA9IFB1c2hOb3RpZmljYXRpb25FbWl0dGVyLmFkZExpc3RlbmVyKE5PVElGX1JFR0lTVFJBVElPTl9FUlJPUl9FVkVOVCwgZnVuY3Rpb24gKGVycm9ySW5mbykgewogICAgICAgICAgICBoYW5kbGVyKGVycm9ySW5mbyk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIF9ub3RpZkhhbmRsZXJzLnNldCh0eXBlLCBsaXN0ZW5lcik7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVtb3ZlRXZlbnRMaXN0ZW5lciIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZXIpIHsKICAgICAgICBpbnZhcmlhbnQodHlwZSA9PT0gJ25vdGlmaWNhdGlvbicgfHwgdHlwZSA9PT0gJ3JlZ2lzdGVyJyB8fCB0eXBlID09PSAncmVnaXN0cmF0aW9uRXJyb3InIHx8IHR5cGUgPT09ICdsb2NhbE5vdGlmaWNhdGlvbicsICdQdXNoTm90aWZpY2F0aW9uSU9TIG9ubHkgc3VwcG9ydHMgYG5vdGlmaWNhdGlvbmAsIGByZWdpc3RlcmAsIGByZWdpc3RyYXRpb25FcnJvcmAsIGFuZCBgbG9jYWxOb3RpZmljYXRpb25gIGV2ZW50cycpOwoKICAgICAgICB2YXIgbGlzdGVuZXIgPSBfbm90aWZIYW5kbGVycy5nZXQodHlwZSk7CgogICAgICAgIGlmICghbGlzdGVuZXIpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGxpc3RlbmVyLnJlbW92ZSgpOwoKICAgICAgICBfbm90aWZIYW5kbGVycy5kZWxldGUodHlwZSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAicmVxdWVzdFBlcm1pc3Npb25zIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlcXVlc3RQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucykgewogICAgICAgIHZhciByZXF1ZXN0ZWRQZXJtaXNzaW9ucyA9IHt9OwoKICAgICAgICBpZiAocGVybWlzc2lvbnMpIHsKICAgICAgICAgIHJlcXVlc3RlZFBlcm1pc3Npb25zID0gewogICAgICAgICAgICBhbGVydDogISFwZXJtaXNzaW9ucy5hbGVydCwKICAgICAgICAgICAgYmFkZ2U6ICEhcGVybWlzc2lvbnMuYmFkZ2UsCiAgICAgICAgICAgIHNvdW5kOiAhIXBlcm1pc3Npb25zLnNvdW5kCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXF1ZXN0ZWRQZXJtaXNzaW9ucyA9IHsKICAgICAgICAgICAgYWxlcnQ6IHRydWUsCiAgICAgICAgICAgIGJhZGdlOiB0cnVlLAogICAgICAgICAgICBzb3VuZDogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBSQ1RQdXNoTm90aWZpY2F0aW9uTWFuYWdlci5yZXF1ZXN0UGVybWlzc2lvbnMocmVxdWVzdGVkUGVybWlzc2lvbnMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImFiYW5kb25QZXJtaXNzaW9ucyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBhYmFuZG9uUGVybWlzc2lvbnMoKSB7CiAgICAgICAgUkNUUHVzaE5vdGlmaWNhdGlvbk1hbmFnZXIuYWJhbmRvblBlcm1pc3Npb25zKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiY2hlY2tQZXJtaXNzaW9ucyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBjaGVja1Blcm1pc3Npb25zKGNhbGxiYWNrKSB7CiAgICAgICAgaW52YXJpYW50KHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJywgJ011c3QgcHJvdmlkZSBhIHZhbGlkIGNhbGxiYWNrJyk7CiAgICAgICAgUkNUUHVzaE5vdGlmaWNhdGlvbk1hbmFnZXIuY2hlY2tQZXJtaXNzaW9ucyhjYWxsYmFjayk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0SW5pdGlhbE5vdGlmaWNhdGlvbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRJbml0aWFsTm90aWZpY2F0aW9uKCkgewogICAgICAgIHJldHVybiBSQ1RQdXNoTm90aWZpY2F0aW9uTWFuYWdlci5nZXRJbml0aWFsTm90aWZpY2F0aW9uKCkudGhlbihmdW5jdGlvbiAobm90aWZpY2F0aW9uKSB7CiAgICAgICAgICByZXR1cm4gbm90aWZpY2F0aW9uICYmIG5ldyBQdXNoTm90aWZpY2F0aW9uSU9TKG5vdGlmaWNhdGlvbik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH1dKTsKCiAgICBmdW5jdGlvbiBQdXNoTm90aWZpY2F0aW9uSU9TKG5hdGl2ZU5vdGlmKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgUHVzaE5vdGlmaWNhdGlvbklPUyk7CiAgICAgIHRoaXMuX2RhdGEgPSB7fTsKICAgICAgdGhpcy5fcmVtb3RlTm90aWZpY2F0aW9uQ29tcGxldGVDYWxsYmFja0NhbGxlZCA9IGZhbHNlOwogICAgICB0aGlzLl9pc1JlbW90ZSA9IG5hdGl2ZU5vdGlmLnJlbW90ZTsKCiAgICAgIGlmICh0aGlzLl9pc1JlbW90ZSkgewogICAgICAgIHRoaXMuX25vdGlmaWNhdGlvbklkID0gbmF0aXZlTm90aWYubm90aWZpY2F0aW9uSWQ7CiAgICAgIH0KCiAgICAgIGlmIChuYXRpdmVOb3RpZi5yZW1vdGUpIHsKICAgICAgICBPYmplY3Qua2V5cyhuYXRpdmVOb3RpZikuZm9yRWFjaChmdW5jdGlvbiAobm90aWZLZXkpIHsKICAgICAgICAgIHZhciBub3RpZlZhbCA9IG5hdGl2ZU5vdGlmW25vdGlmS2V5XTsKCiAgICAgICAgICBpZiAobm90aWZLZXkgPT09ICdhcHMnKSB7CiAgICAgICAgICAgIF90aGlzLl9hbGVydCA9IG5vdGlmVmFsLmFsZXJ0OwogICAgICAgICAgICBfdGhpcy5fc291bmQgPSBub3RpZlZhbC5zb3VuZDsKICAgICAgICAgICAgX3RoaXMuX2JhZGdlQ291bnQgPSBub3RpZlZhbC5iYWRnZTsKICAgICAgICAgICAgX3RoaXMuX2NhdGVnb3J5ID0gbm90aWZWYWwuY2F0ZWdvcnk7CiAgICAgICAgICAgIF90aGlzLl9jb250ZW50QXZhaWxhYmxlID0gbm90aWZWYWxbJ2NvbnRlbnQtYXZhaWxhYmxlJ107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfdGhpcy5fZGF0YVtub3RpZktleV0gPSBub3RpZlZhbDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9iYWRnZUNvdW50ID0gbmF0aXZlTm90aWYuYXBwbGljYXRpb25JY29uQmFkZ2VOdW1iZXI7CiAgICAgICAgdGhpcy5fc291bmQgPSBuYXRpdmVOb3RpZi5zb3VuZE5hbWU7CiAgICAgICAgdGhpcy5fYWxlcnQgPSBuYXRpdmVOb3RpZi5hbGVydEJvZHk7CiAgICAgICAgdGhpcy5fZGF0YSA9IG5hdGl2ZU5vdGlmLnVzZXJJbmZvOwogICAgICAgIHRoaXMuX2NhdGVnb3J5ID0gbmF0aXZlTm90aWYuY2F0ZWdvcnk7CiAgICAgIH0KICAgIH0KCiAgICBiYWJlbEhlbHBlcnMuY3JlYXRlQ2xhc3MoUHVzaE5vdGlmaWNhdGlvbklPUywgW3sKICAgICAga2V5OiAiZmluaXNoIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGZpbmlzaChmZXRjaFJlc3VsdCkgewogICAgICAgIGlmICghdGhpcy5faXNSZW1vdGUgfHwgIXRoaXMuX25vdGlmaWNhdGlvbklkIHx8IHRoaXMuX3JlbW90ZU5vdGlmaWNhdGlvbkNvbXBsZXRlQ2FsbGJhY2tDYWxsZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3JlbW90ZU5vdGlmaWNhdGlvbkNvbXBsZXRlQ2FsbGJhY2tDYWxsZWQgPSB0cnVlOwogICAgICAgIFJDVFB1c2hOb3RpZmljYXRpb25NYW5hZ2VyLm9uRmluaXNoUmVtb3RlTm90aWZpY2F0aW9uKHRoaXMuX25vdGlmaWNhdGlvbklkLCBmZXRjaFJlc3VsdCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0TWVzc2FnZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRNZXNzYWdlKCkgewogICAgICAgIHJldHVybiB0aGlzLl9hbGVydDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRTb3VuZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRTb3VuZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc291bmQ7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0Q2F0ZWdvcnkiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0Q2F0ZWdvcnkoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NhdGVnb3J5OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldEFsZXJ0IiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldEFsZXJ0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9hbGVydDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRDb250ZW50QXZhaWxhYmxlIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldENvbnRlbnRBdmFpbGFibGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRlbnRBdmFpbGFibGU7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0QmFkZ2VDb3VudCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRCYWRnZUNvdW50KCkgewogICAgICAgIHJldHVybiB0aGlzLl9iYWRnZUNvdW50OwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldERhdGEiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0RGF0YSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZGF0YTsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFB1c2hOb3RpZmljYXRpb25JT1M7CiAgfSgpLCBfY2xhc3MuRmV0Y2hSZXN1bHQgPSB7CiAgICBOZXdEYXRhOiAnVUlCYWNrZ3JvdW5kRmV0Y2hSZXN1bHROZXdEYXRhJywKICAgIE5vRGF0YTogJ1VJQmFja2dyb3VuZEZldGNoUmVzdWx0Tm9EYXRhJywKICAgIFJlc3VsdEZhaWxlZDogJ1VJQmFja2dyb3VuZEZldGNoUmVzdWx0RmFpbGVkJwogIH0sIF90ZW1wKTsKICBtb2R1bGUuZXhwb3J0cyA9IFB1c2hOb3RpZmljYXRpb25JT1M7Cn0sMzI1LFs2OSwxNSwxM10sIlB1c2hOb3RpZmljYXRpb25JT1MiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBTZXR0aW5ncyA9IHsKICAgIGdldDogZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICBjb25zb2xlLndhcm4oJ1NldHRpbmdzIGlzIG5vdCB5ZXQgc3VwcG9ydGVkIG9uIEFuZHJvaWQnKTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiBzZXQoc2V0dGluZ3MpIHsKICAgICAgY29uc29sZS53YXJuKCdTZXR0aW5ncyBpcyBub3QgeWV0IHN1cHBvcnRlZCBvbiBBbmRyb2lkJyk7CiAgICB9LAogICAgd2F0Y2hLZXlzOiBmdW5jdGlvbiB3YXRjaEtleXMoa2V5cywgY2FsbGJhY2spIHsKICAgICAgY29uc29sZS53YXJuKCdTZXR0aW5ncyBpcyBub3QgeWV0IHN1cHBvcnRlZCBvbiBBbmRyb2lkJyk7CiAgICAgIHJldHVybiAtMTsKICAgIH0sCiAgICBjbGVhcldhdGNoOiBmdW5jdGlvbiBjbGVhcldhdGNoKHdhdGNoSWQpIHsKICAgICAgY29uc29sZS53YXJuKCdTZXR0aW5ncyBpcyBub3QgeWV0IHN1cHBvcnRlZCBvbiBBbmRyb2lkJyk7CiAgICB9CiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IFNldHRpbmdzOwp9LDMyNixbXSwiU2V0dGluZ3MiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBQbGF0Zm9ybSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJQbGF0Zm9ybSIpOwoKICB2YXIgaW52YXJpYW50ID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsxXSwgImZianMvbGliL2ludmFyaWFudCIpOwoKICB2YXIgcHJvY2Vzc0NvbG9yID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFsyXSwgInByb2Nlc3NDb2xvciIpOwoKICB2YXIgX3JlcXVpcmUgPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzNdLCAiTmF0aXZlTW9kdWxlcyIpLAogICAgICBBY3Rpb25TaGVldE1hbmFnZXIgPSBfcmVxdWlyZS5BY3Rpb25TaGVldE1hbmFnZXIsCiAgICAgIFNoYXJlTW9kdWxlID0gX3JlcXVpcmUuU2hhcmVNb2R1bGU7CgogIHZhciBTaGFyZSA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFNoYXJlKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgU2hhcmUpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhTaGFyZSwgbnVsbCwgW3sKICAgICAga2V5OiAic2hhcmUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gc2hhcmUoY29udGVudCkgewogICAgICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiB7fTsKICAgICAgICBpbnZhcmlhbnQodHlwZW9mIGNvbnRlbnQgPT09ICdvYmplY3QnICYmIGNvbnRlbnQgIT09IG51bGwsICdDb250ZW50IHRvIHNoYXJlIG11c3QgYmUgYSB2YWxpZCBvYmplY3QnKTsKICAgICAgICBpbnZhcmlhbnQodHlwZW9mIGNvbnRlbnQudXJsID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgY29udGVudC5tZXNzYWdlID09PSAnc3RyaW5nJywgJ0F0IGxlYXN0IG9uZSBvZiBVUkwgYW5kIG1lc3NhZ2UgaXMgcmVxdWlyZWQnKTsKICAgICAgICBpbnZhcmlhbnQodHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnICYmIG9wdGlvbnMgIT09IG51bGwsICdPcHRpb25zIG11c3QgYmUgYSB2YWxpZCBvYmplY3QnKTsKCiAgICAgICAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHsKICAgICAgICAgIGludmFyaWFudCghY29udGVudC50aXRsZSB8fCB0eXBlb2YgY29udGVudC50aXRsZSA9PT0gJ3N0cmluZycsICdJbnZhbGlkIHRpdGxlOiB0aXRsZSBzaG91bGQgYmUgYSBzdHJpbmcuJyk7CiAgICAgICAgICByZXR1cm4gU2hhcmVNb2R1bGUuc2hhcmUoY29udGVudCwgb3B0aW9ucy5kaWFsb2dUaXRsZSk7CiAgICAgICAgfSBlbHNlIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgIEFjdGlvblNoZWV0TWFuYWdlci5zaG93U2hhcmVBY3Rpb25TaGVldFdpdGhPcHRpb25zKGJhYmVsSGVscGVycy5leHRlbmRzKHt9LCBjb250ZW50LCBvcHRpb25zLCB7CiAgICAgICAgICAgICAgdGludENvbG9yOiBwcm9jZXNzQ29sb3Iob3B0aW9ucy50aW50Q29sb3IpCiAgICAgICAgICAgIH0pLCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24gKHN1Y2Nlc3MsIGFjdGl2aXR5VHlwZSkgewogICAgICAgICAgICAgIGlmIChzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICByZXNvbHZlKHsKICAgICAgICAgICAgICAgICAgJ2FjdGlvbic6ICdzaGFyZWRBY3Rpb24nLAogICAgICAgICAgICAgICAgICAnYWN0aXZpdHlUeXBlJzogYWN0aXZpdHlUeXBlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzb2x2ZSh7CiAgICAgICAgICAgICAgICAgICdhY3Rpb24nOiAnZGlzbWlzc2VkQWN0aW9uJwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdVbnN1cHBvcnRlZCBwbGF0Zm9ybScpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAic2hhcmVkQWN0aW9uIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuICdzaGFyZWRBY3Rpb24nOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImRpc21pc3NlZEFjdGlvbiIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAnZGlzbWlzc2VkQWN0aW9uJzsKICAgICAgfQogICAgfV0pOwogICAgcmV0dXJuIFNoYXJlOwogIH0oKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBTaGFyZTsKfSwzMjcsWzUyLDEzLDE1MiwxNV0sIlNoYXJlIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgTmF0aXZlRXZlbnRFbWl0dGVyID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIk5hdGl2ZUV2ZW50RW1pdHRlciIpOwoKICBtb2R1bGUuZXhwb3J0cyA9IG5ldyBOYXRpdmVFdmVudEVtaXR0ZXIoJ1N0YXR1c0Jhck1hbmFnZXInKTsKfSwzMjgsWzY5XSwiU3RhdHVzQmFySU9TIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgVGltZVBpY2tlck1vZHVsZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIikuVGltZVBpY2tlckFuZHJvaWQ7CgogIHZhciBUaW1lUGlja2VyQW5kcm9pZCA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFRpbWVQaWNrZXJBbmRyb2lkKCkgewogICAgICBiYWJlbEhlbHBlcnMuY2xhc3NDYWxsQ2hlY2sodGhpcywgVGltZVBpY2tlckFuZHJvaWQpOwogICAgfQoKICAgIGJhYmVsSGVscGVycy5jcmVhdGVDbGFzcyhUaW1lUGlja2VyQW5kcm9pZCwgbnVsbCwgW3sKICAgICAga2V5OiAib3BlbiIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBvcGVuKG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmFzeW5jKGZ1bmN0aW9uIG9wZW4kKF9jb250ZXh0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LmFicnVwdCgicmV0dXJuIiwgVGltZVBpY2tlck1vZHVsZS5vcGVuKG9wdGlvbnMpKTsKCiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgbnVsbCwgdGhpcyk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAidGltZVNldEFjdGlvbiIsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAndGltZVNldEFjdGlvbic7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZGlzbWlzc2VkQWN0aW9uIiwKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuICdkaXNtaXNzZWRBY3Rpb24nOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gVGltZVBpY2tlckFuZHJvaWQ7CiAgfSgpOwoKICBtb2R1bGUuZXhwb3J0cyA9IFRpbWVQaWNrZXJBbmRyb2lkOwp9LDMyOSxbMTVdLCJUaW1lUGlja2VyQW5kcm9pZCIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFJDVFZpYnJhdGlvbiA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJOYXRpdmVNb2R1bGVzIikuVmlicmF0aW9uOwoKICB2YXIgUGxhdGZvcm0gPSByZXF1aXJlKF9kZXBlbmRlbmN5TWFwWzFdLCAiUGxhdGZvcm0iKTsKCiAgdmFyIF92aWJyYXRpbmcgPSBmYWxzZTsKICB2YXIgX2lkID0gMDsKCiAgZnVuY3Rpb24gdmlicmF0ZUJ5UGF0dGVybihwYXR0ZXJuKSB7CiAgICB2YXIgcmVwZWF0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBmYWxzZTsKCiAgICBpZiAoX3ZpYnJhdGluZykgewogICAgICByZXR1cm47CiAgICB9CgogICAgX3ZpYnJhdGluZyA9IHRydWU7CgogICAgaWYgKHBhdHRlcm5bMF0gPT09IDApIHsKICAgICAgUkNUVmlicmF0aW9uLnZpYnJhdGUoKTsKICAgICAgcGF0dGVybiA9IHBhdHRlcm4uc2xpY2UoMSk7CiAgICB9CgogICAgaWYgKHBhdHRlcm4ubGVuZ3RoID09PSAwKSB7CiAgICAgIF92aWJyYXRpbmcgPSBmYWxzZTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdmlicmF0ZVNjaGVkdWxlcigrK19pZCwgcGF0dGVybiwgcmVwZWF0LCAxKTsKICAgIH0sIHBhdHRlcm5bMF0pOwogIH0KCiAgZnVuY3Rpb24gdmlicmF0ZVNjaGVkdWxlcihpZCwgcGF0dGVybiwgcmVwZWF0LCBuZXh0SW5kZXgpIHsKICAgIGlmICghX3ZpYnJhdGluZyB8fCBpZCAhPT0gX2lkKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBSQ1RWaWJyYXRpb24udmlicmF0ZSgpOwoKICAgIGlmIChuZXh0SW5kZXggPj0gcGF0dGVybi5sZW5ndGgpIHsKICAgICAgaWYgKHJlcGVhdCkgewogICAgICAgIG5leHRJbmRleCA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX3ZpYnJhdGluZyA9IGZhbHNlOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdmlicmF0ZVNjaGVkdWxlcihpZCwgcGF0dGVybiwgcmVwZWF0LCBuZXh0SW5kZXggKyAxKTsKICAgIH0sIHBhdHRlcm5bbmV4dEluZGV4XSk7CiAgfQoKICB2YXIgVmlicmF0aW9uID0gewogICAgdmlicmF0ZTogZnVuY3Rpb24gdmlicmF0ZSgpIHsKICAgICAgdmFyIHBhdHRlcm4gPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IDQwMDsKICAgICAgdmFyIHJlcGVhdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogZmFsc2U7CgogICAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJykgewogICAgICAgIGlmICh0eXBlb2YgcGF0dGVybiA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIFJDVFZpYnJhdGlvbi52aWJyYXRlKHBhdHRlcm4pOwogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShwYXR0ZXJuKSkgewogICAgICAgICAgUkNUVmlicmF0aW9uLnZpYnJhdGVCeVBhdHRlcm4ocGF0dGVybiwgcmVwZWF0ID8gMCA6IC0xKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdWaWJyYXRpb24gcGF0dGVybiBzaG91bGQgYmUgYSBudW1iZXIgb3IgYXJyYXknKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKF92aWJyYXRpbmcpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgcGF0dGVybiA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIFJDVFZpYnJhdGlvbi52aWJyYXRlKCk7CiAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHBhdHRlcm4pKSB7CiAgICAgICAgICB2aWJyYXRlQnlQYXR0ZXJuKHBhdHRlcm4sIHJlcGVhdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVmlicmF0aW9uIHBhdHRlcm4gc2hvdWxkIGJlIGEgbnVtYmVyIG9yIGFycmF5Jyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgY2FuY2VsOiBmdW5jdGlvbiBjYW5jZWwoKSB7CiAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2lvcycpIHsKICAgICAgICBfdmlicmF0aW5nID0gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgUkNUVmlicmF0aW9uLmNhbmNlbCgpOwogICAgICB9CiAgICB9CiAgfTsKICBtb2R1bGUuZXhwb3J0cyA9IFZpYnJhdGlvbjsKfSwzMzAsWzE1LDUyXSwiVmlicmF0aW9uIik7Cl9fZChmdW5jdGlvbiAoZ2xvYmFsLCByZXF1aXJlLCBtb2R1bGUsIGV4cG9ydHMsIF9kZXBlbmRlbmN5TWFwKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgd2FybmluZyA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJmYmpzL2xpYi93YXJuaW5nIik7CgogIHZhciBWaWJyYXRpb25JT1MgPSB7CiAgICB2aWJyYXRlOiBmdW5jdGlvbiB2aWJyYXRlKCkgewogICAgICB3YXJuaW5nKCdWaWJyYXRpb25JT1MgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGlzIHBsYXRmb3JtIScpOwogICAgfQogIH07CiAgbW9kdWxlLmV4cG9ydHMgPSBWaWJyYXRpb25JT1M7Cn0sMzMxLFs1Nl0sIlZpYnJhdGlvbklPUyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIF9yZXF1aXJlID0gcmVxdWlyZShfZGVwZW5kZW5jeU1hcFswXSwgIlJlYWN0TmF0aXZlIiksCiAgICAgIF9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEID0gX3JlcXVpcmUuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CgogIG1vZHVsZS5leHBvcnRzID0gX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQudGFrZVNuYXBzaG90Owp9LDMzMixbMjFdLCJ0YWtlU25hcHNob3QiKTsKX19kKGZ1bmN0aW9uIChnbG9iYWwsIHJlcXVpcmUsIG1vZHVsZSwgZXhwb3J0cywgX2RlcGVuZGVuY3lNYXApIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IHVuZGVmaW5lZDsKICB2YXIgX2pzeEZpbGVOYW1lID0gIi9ob21lL2hvamluL2Rldi9pZ25pdGUvVGV4dFRlc3QvQXBwLmpzIjsKCiAgdmFyIF9yZWFjdCA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMF0sICJyZWFjdCIpOwoKICB2YXIgX3JlYWN0MiA9IGJhYmVsSGVscGVycy5pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3JlYWN0KTsKCiAgdmFyIF9SZWFjdE5hdGl2ZUlnbml0ZSA9IHJlcXVpcmUoX2RlcGVuZGVuY3lNYXBbMV0sICIuL2pzL2lnbml0ZS9SZWFjdE5hdGl2ZUlnbml0ZSIpOwoKICB2YXIgQXBwID0gZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICAgIGJhYmVsSGVscGVycy5pbmhlcml0cyhBcHAsIF9SZWFjdCRDb21wb25lbnQpOwoKICAgIGZ1bmN0aW9uIEFwcCgpIHsKICAgICAgYmFiZWxIZWxwZXJzLmNsYXNzQ2FsbENoZWNrKHRoaXMsIEFwcCk7CiAgICAgIHJldHVybiBiYWJlbEhlbHBlcnMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoQXBwLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoQXBwKSkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9CgogICAgYmFiZWxIZWxwZXJzLmNyZWF0ZUNsYXNzKEFwcCwgW3sKICAgICAga2V5OiAicmVuZGVyIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICByZXR1cm4gX3JlYWN0Mi5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICBfUmVhY3ROYXRpdmVJZ25pdGUuVmlldywKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHN0eWxlcy5jb250YWluZXIsCiAgICAgICAgICAgIF9fc291cmNlOiB7CiAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICBsaW5lTnVtYmVyOiA4CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBfcmVhY3QyLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgX1JlYWN0TmF0aXZlSWduaXRlLlRleHQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJJR05JVEUhISIKICAgICAgICAgICksCiAgICAgICAgICBfcmVhY3QyLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgKICAgICAgICAgICAgX1JlYWN0TmF0aXZlSWduaXRlLlRleHQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBfX3NvdXJjZTogewogICAgICAgICAgICAgICAgZmlsZU5hbWU6IF9qc3hGaWxlTmFtZSwKICAgICAgICAgICAgICAgIGxpbmVOdW1iZXI6IDEwCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAiT3BlbiB1cCBBcHAuanMgdG8gc3RhcnQgd29ya2luZyBvbiB5b3VyIGFwcCEiCiAgICAgICAgICApLAogICAgICAgICAgX3JlYWN0Mi5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIF9SZWFjdE5hdGl2ZUlnbml0ZS5UZXh0LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAxMQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkNoYW5nZXMgeW91IG1ha2Ugd2lsbCBhdXRvbWF0aWNhbGx5IHJlbG9hZC4iCiAgICAgICAgICApLAogICAgICAgICAgX3JlYWN0Mi5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoCiAgICAgICAgICAgIF9SZWFjdE5hdGl2ZUlnbml0ZS5UZXh0LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgX19zb3VyY2U6IHsKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBfanN4RmlsZU5hbWUsCiAgICAgICAgICAgICAgICBsaW5lTnVtYmVyOiAxMgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlNoYWtlIHlvdXIgcGhvbmUgdG8gb3BlbiB0aGUgZGV2ZWxvcGVyIG1lbnUuIgogICAgICAgICAgKQogICAgICAgICk7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBBcHA7CiAgfShfcmVhY3QyLmRlZmF1bHQuQ29tcG9uZW50KTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gQXBwOwp9LDMzMyxbMTA4LDMzNF0sIlRleHRUZXN0L0FwcC5qcyIpOwpfX2QoZnVuY3Rpb24gKGdsb2JhbCwgcmVxdWlyZSwgbW9kdWxlLCBleHBvcnRzLCBfZGVwZW5kZW5jeU1hcCkgewogICAgdmFyIHZpZXdzID0ge307CiAgICB2YXIgVEFHID0gJ3RhZyc7CgogICAgZnVuY3Rpb24gdmlld01vdXNlRG93bihlKSB7CiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICB2YXIgdGFnID0gdGhpcy5nZXRBdHRyaWJ1dGUoVEFHKTsKICAgICAgICBFdmVudFNlbmRlci5zZW5kVG91Y2hTdGFydCh0YWcpOwogICAgfQoKICAgIGZ1bmN0aW9uIHZpZXdNb3VzZVVwKGUpIHsKICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIHZhciB0YWcgPSB0aGlzLmdldEF0dHJpYnV0ZShUQUcpOwogICAgICAgIEV2ZW50U2VuZGVyLnNlbmRUb3VjaEVuZCh0YWcpOwogICAgfQoKICAgIGZ1bmN0aW9uIE5BVElWRV9jcmVhdGVWaWV3KHRhZywgcHJvcHMpIHsKICAgICAgICBjb25zb2xlLmxvZygnTkFUSVZFX2NyZWF0ZVZpZXcgJyArIHRhZyArICcgJyArIHByb3BzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBOQVRJVkVfdXBkYXRlVmlldyh0YWcsIHByb3BzKSB7CiAgICAgICAgY29uc29sZS5sb2coJ05BVElWRV91cGRhdGVWaWV3ICcgKyB0YWcgKyAnICcgKyBwcm9wcyk7CiAgICB9CgogICAgZnVuY3Rpb24gTkFUSVZFX2NyZWF0ZVNjcm9sbFZpZXcodGFnLCBwcm9wcykgewogICAgICAgIGNvbnNvbGUubG9nKCdOQVRJVkVfY3JlYXRlU2Nyb2xsVmlldyAnICsgdGFnICsgJyAnICsgcHJvcHMpOwogICAgfQoKICAgIGZ1bmN0aW9uIE5BVElWRV9zY3JvbGxUbyh0YWcsIHByb3BzKSB7CiAgICAgICAgY29uc29sZS5sb2coJ05BVElWRV9zY3JvbGxUbyAnICsgdGFnICsgJyAnICsgcHJvcHMpOwogICAgfQoKICAgIGZ1bmN0aW9uIE5BVElWRV9jcmVhdGVJbWFnZVZpZXcodGFnLCBwcm9wcykgewogICAgICAgIGNvbnNvbGUubG9nKCdOQVRJVkVfY3JlYXRlSW1hZ2VWaWV3ICcgKyB0YWcgKyAnICcgKyBwcm9wcyk7CiAgICB9CgogICAgZnVuY3Rpb24gTkFUSVZFX2NyZWF0ZVRleHQodGFnLCBwcm9wcykgewogICAgICAgIGNvbnNvbGUubG9nKCdOQVRJVkVfY3JlYXRlVGV4dCAnICsgdGFnICsgJyAnICsgcHJvcHMpOwogICAgfQoKICAgIGZ1bmN0aW9uIE5BVElWRV91cGRhdGVUZXh0KHRhZywgcHJvcHMpIHsKICAgICAgICBjb25zb2xlLmxvZygnTkFUSVZFX3VwZGF0ZVRleHQgJyArIHRhZyArICcgJyArIHByb3BzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBOQVRJVkVfY3JlYXRlUmF3VGV4dCh0YWcsIHRleHQpIHsKICAgICAgICBjb25zb2xlLmxvZygnTkFUSVZFX2NyZWF0ZVJhd1RleHQgJyArIHRhZyArICcgJyArIHRleHQpOwogICAgICAgIE5hdGl2ZS5EcmF3VGV4dCh0ZXh0LCAxMDAsIDEwMCwgMCwgMCwgMjU1LCAwLCAwLCAyNTUsICdBbWF6b24gRW1iZXInLCAnNDAnLCAnMCcsICcwJyk7CiAgICAgICAgTmF0aXZlLlN3YXBCdWZmZXJzKCk7CiAgICB9CgogICAgZnVuY3Rpb24gTkFUSVZFX3VwZGF0ZVJhd1RleHQodGFnLCB0ZXh0KSB7CiAgICAgICAgY29uc29sZS5sb2coJ05BVElWRV91cGRhdGVSYXdUZXh0ICcgKyB0YWcgKyAnICcgKyB0ZXh0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBOQVRJVkVfc2V0Q2hpbGRyZW4odGFnLCBjaGlsZHJlbikgewogICAgICAgIGNvbnNvbGUubG9nKCdOQVRJVkVfc2V0Q2hpbGRyZW4gJyArIHRhZyArICcgJyArIGNoaWxkcmVuKTsKICAgIH0KCiAgICBmdW5jdGlvbiBOQVRJVkVfbWVhc3VyZUxheW91dFJlbGF0aXZlVG9QYXJlbnQodGFnLCBlcnJvciwgc3VjY2VzcykgewogICAgICAgIGNvbnNvbGUubG9nKCdOQVRJVkVfbWVhc3VyZUxheW91dFJlbGF0aXZlVG9QYXJlbnQgJyArIHRhZyArICcsIGVycm9yOiAnICsgZXJyb3IgKyAnLCBzdWNjZXNzOiAnICsgc3VjY2Vzcyk7CiAgICB9CgogICAgZnVuY3Rpb24gcmVxQW5pbUZyYW1lKGZ1bmMpIHsKICAgICAgICBpZiAod2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSkgewogICAgICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmMpOwogICAgICAgIH0gZWxzZSBpZiAod2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSkgewogICAgICAgICAgICB3aW5kb3cud2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmMpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBOQVRJVkVfYW5pbWF0ZVZhbHVlKHRhZywgc3R5bGVOYW1lLCB2YWx1ZXMpIHsKICAgICAgICBjb25zb2xlLmxvZygnTkFUSVZFX2FuaW1hdGVWYWx1ZSB0YWc6ICcgKyB0YWcgKyAnLCBzdHlsZU5hbWU6ICcgKyBzdHlsZU5hbWUgKyAnLCB2YWx1ZXM6ICcgKyB2YWx1ZXMpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbG9yQXNTdHJpbmcoY29sb3IpIHsKICAgICAgICBpZiAoIWNvbG9yKSB7CiAgICAgICAgICAgIHJldHVybiAnI2ZmZmZmZic7CiAgICAgICAgfQoKICAgICAgICB2YXIgYSA9IChjb2xvciA+PiAyNCAmIDB4RkYpIC8gMjU1OwogICAgICAgIHZhciByID0gY29sb3IgPj4gMTYgJiAweEZGOwogICAgICAgIHZhciBnID0gY29sb3IgPj4gOCAmIDB4RkY7CiAgICAgICAgdmFyIGIgPSBjb2xvciAmIDB4RkY7CiAgICAgICAgcmVzdWx0ID0gJ3JnYmEoJyArIHIgKyAnLCcgKyBnICsgJywnICsgYiArICcsJyArIGEgKyAnKSc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZVN0eWxlKHN0eWxlT2JqZWN0LCBkb21Ob2RlKSB7fQoKICAgIG5hdGl2ZU1vZHVsZVByb3h5LlRpbWluZyA9IHsKICAgICAgICBpbnRlcnZhbE1hcDoge30sCiAgICAgICAgdGltZW91dE1hcDoge30sCiAgICAgICAgY3JlYXRlVGltZXI6IGZ1bmN0aW9uIGNyZWF0ZVRpbWVyKGlkLCBkdXJhdGlvbiwgc3RhcnRUaW1lLCByZXBlYXQpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ2NyZWF0ZVRpbWVyIGlkOiAnICsgaWQgKyAnLCBkdXJhdGlvbjogJyArIGR1cmF0aW9uICsgJywgc3RhcnRUaW1lOiAnICsgc3RhcnRUaW1lICsgJywgcmVwZWF0OiAnICsgcmVwZWF0KTsKICAgICAgICB9LAogICAgICAgIGRlbGV0ZVRpbWVyOiBmdW5jdGlvbiBkZWxldGVUaW1lcihpZCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnZGVsZXRlVGltZXIgaWQ6ICcgKyBpZCk7CiAgICAgICAgfSwKICAgICAgICBzZXRTZW5kSWRsZUV2ZW50czogZnVuY3Rpb24gc2V0U2VuZElkbGVFdmVudHMoKSB7fQogICAgfTsKfSwzMzQsW10sIlRleHRUZXN0L2pzL2lnbml0ZS9SZWFjdE5hdGl2ZUlnbml0ZS5qcyIpOwpyZXF1aXJlKDIzKTsKcmVxdWlyZSgxMSk7Cg==</text>
      </register>
      <register name="1" type="2">
        <text encoding="base64">ICAgIGV2YWwoTmF0aXZlLlJlYWRGaWxlKCcuLi8uLi9UZXh0VGVzdC9kaXN0L1RleHRUZXN0LmpzJykpOwo=</text>
      </register>
      <register name="q" type="4">
        <keys>
          <key char="65535" code="27" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="119" code="0" mods="0" />
          <key char="119" code="0" mods="0" />
        </keys>
      </register>
      <register name="2" type="2">
        <text encoding="base64">aW1wb3J0IFJlYWN0LCB7IEFwcFJlZ2lzdHJ5IH0gZnJvbSAncmVhY3QtbmF0aXZlJzsKaW1wb3J0IEFwcCBmcm9tICcuL0FwcCcK</text>
      </register>
      <register name="3" type="2">
        <text encoding="base64">aW1wb3J0IFJlYWN0LCB7IEFwcFJlZ2lzdHJ5IH0gZnJvbSAncmVhY3QtbmF0aXZlJzsKaW1wb3J0IEFwcCBmcm9tICcuL0FwcCcK</text>
      </register>
      <register name="4" type="2">
        <text encoding="base64">ICAgIGltcG9ydCBSZWFjdCwgeyBBcHBSZWdpc3RyeSB9IGZyb20gJ3JlYWN0LW5hdGl2ZSc7CiAgICBpbXBvcnQgQXBwIGZyb20gJy4vQXBwJwo=</text>
      </register>
      <register name="t" type="2">
        <text encoding="base64">CnN0cnVjdCBNb2NrTG9nTGlzdGVuZXIgOiBwdWJsaWMgSUxvZ0xpc3RlbmVyCnsKCU1PQ0tfTUVUSE9EMShsaXN0ZW5Ub01lc3NhZ2UsIHZvaWQoY29uc3QgSUxvZ0xpc3RlbmVyOjpMb2dNZXNzYWdlJikpOwoJTU9DS19NRVRIT0QwKHByb2Nlc3NNZXNzYWdlcywgdm9pZCgpKTsKCU1PQ0tfTUVUSE9EMShmbHVzaE1lc3NhZ2VzLCB2b2lkKGNvbnN0IElMb2dMaXN0ZW5lcjo6Rmx1c2hPcHRpb24pKTsKfTsKClRFU1RfRihMb2dUZXN0LCBsaXN0ZW5Ub01lc3NhZ2VfY2FuQ2FsbExvZykKewoJYXV0byBsaXN0ZW5lciA9IGNvcmU6Om1lbW9yeTo6bWFrZV9zaGFyZWQ8TW9ja0xvZ0xpc3RlbmVyPigpOwoJRVhQRUNUX0NBTEwoKmxpc3RlbmVyLCBsaXN0ZW5Ub01lc3NhZ2UoXykpCgkJCS5XaWxsT25jZSgKCQkJCQlJbnZva2VXaXRob3V0QXJncygKCQkJCQkJCVt0aGlzXSgpCgkJCQkJCQl7CgkJCQkJCQkJTG9nOjpnZXQoKS5kZWJ1ZygKCQkJCQkJCQkJCXRlc3RDaGFubmVsSWQsCgkJCQkJCQkJCQkiQ2FsbGluZyBsb2cgZnJvbSBsb2cgbGlzdGVuZXIiKTsKCQkJCQkJCX0pKTsKCglMb2c6OmdldCgpLnJlZ2lzdGVyTGlzdGVuZXIobGlzdGVuZXIuZ2V0KCkpOwoJTG9nOjpnZXQoKS5kZWJ1Zyh0ZXN0Q2hhbm5lbElkLCAibG9nZ2luZyBhIGRlYnVnIG1lc3NhZ2UiKTsKCUxvZzo6Z2V0KCkudW5yZWdpc3Rlckxpc3RlbmVyKGxpc3RlbmVyLmdldCgpKTsKfQoKVEVTVF9GKExvZ1Rlc3QsIHByb2Nlc3NNZXNzYWdlc19jYW5DYWxsTG9nKQp7CglhdXRvIGxpc3RlbmVyID0gY29yZTo6bWVtb3J5OjptYWtlX3NoYXJlZDxNb2NrTG9nTGlzdGVuZXI+KCk7CglFWFBFQ1RfQ0FMTCgqbGlzdGVuZXIsIHByb2Nlc3NNZXNzYWdlcygpKQoJCQkuV2lsbE9uY2UoCgkJCQkJSW52b2tlV2l0aG91dEFyZ3MoCgkJCQkJCQlbdGhpc10oKQoJCQkJCQkJewoJCQkJCQkJCUxvZzo6Z2V0KCkuZGVidWcoCgkJCQkJCQkJCQl0ZXN0Q2hhbm5lbElkLAoJCQkJCQkJCQkJIkNhbGxpbmcgbG9nIGZyb20gbG9nIGxpc3RlbmVyIik7CgkJCQkJCQl9KSk7CgoJTG9nOjpnZXQoKS5yZWdpc3Rlckxpc3RlbmVyKGxpc3RlbmVyLmdldCgpKTsKCUxvZzo6Z2V0KCkuZGVidWcodGVzdENoYW5uZWxJZCwgImxvZ2dpbmcgYSBkZWJ1ZyBtZXNzYWdlIik7CglsaXN0ZW5lci0+cHJvY2Vzc01lc3NhZ2VzKCk7CglMb2c6OmdldCgpLnVucmVnaXN0ZXJMaXN0ZW5lcihsaXN0ZW5lci5nZXQoKSk7Cn0KClRFU1RfRihMb2dUZXN0LCBmbHVzaF9jYW5DYWxsTG9nKQp7CglhdXRvIGxpc3RlbmVyID0gY29yZTo6bWVtb3J5OjptYWtlX3NoYXJlZDxNb2NrTG9nTGlzdGVuZXI+KCk7CglFWFBFQ1RfQ0FMTCgqbGlzdGVuZXIsIGZsdXNoTWVzc2FnZXMoXykpCgkJCS5XaWxsT25jZSgKCQkJCQlJbnZva2VXaXRob3V0QXJncygKCQkJCQkJCVt0aGlzXSgpCgkJCQkJCQl7CgkJCQkJCQkJTG9nOjpnZXQoKS5kZWJ1ZygKCQkJCQkJCQkJCXRlc3RDaGFubmVsSWQsCgkJCQkJCQkJCQkiQ2FsbGluZyBsb2cgZnJvbSBsb2cgbGlzdGVuZXIiKTsKCQkJCQkJCX0pKTsKCglMb2c6OmdldCgpLnJlZ2lzdGVyTGlzdGVuZXIobGlzdGVuZXIuZ2V0KCkpOwoJTG9nOjpnZXQoKS5kZWJ1Zyh0ZXN0Q2hhbm5lbElkLCAibG9nZ2luZyBhIGRlYnVnIG1lc3NhZ2UiKTsKCUxvZzo6Z2V0KCkuZmx1c2goKTsKCUxvZzo6Z2V0KCkudW5yZWdpc3Rlckxpc3RlbmVyKGxpc3RlbmVyLmdldCgpKTsKfQo=</text>
      </register>
      <register name="5" type="2">
        <text encoding="base64">ICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ2xvYWRNb2R1bGVJbXBsZW1lbnRhdGlvbjonICsgSlNPTi5zdHJpbmdpZnkobG9hZE1vZHVsZUltcGxlbWVudGF0aW9uKSk7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdtb2R1bGVJZDonICsgSlNPTi5zdHJpbmdpZnkobW9kdWxlSWQpKTsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ21vZHVsZS52ZXJib3NlTmFtZTogJyArIG1vZHVsZS52ZXJib3NlTmFtZSk7Cg==</text>
      </register>
      <register name="6" type="2">
        <text encoding="base64">ICAgICAgICAgICAgY29uc29sZS53YXJuKCdtb2R1bGUudmVyYm9zZU5hbWU6ICcgKyBtb2R1bGUudmVyYm9zZU5hbWUpOwo=</text>
      </register>
      <register name="7" type="2">
        <text encoding="base64">ICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ21vZHVsZS46JyArIEpTT04uc3RyaW5naWZ5KG1vZHVsZUlkKSk7Cg==</text>
      </register>
      <register name="8" type="2">
        <text encoding="base64">ICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ21vZHVsZUlkOicgKyBKU09OLnN0cmluZ2lmeShtb2R1bGVJZCkpOwo=</text>
      </register>
      <register name="9" type="2">
        <text encoding="base64">ICBjb25zb2xlLndhcm4oJ21vZHVsZUlkOiAnICsgSlNPTi5zdHJpbmdpZnkobW9kdWxlSWQpKTsK</text>
      </register>
      <register name="y" type="2">
        <text encoding="base64">CiMgTG9hZCBkZXZpY2UgbGF5ZXIgbGlicmFyeSBhbmQgdXNlIGRldmljZSBBUElzIGZyb20gaXQKQ01BS0VfT1BUSU9OUz0iJENNQUtFX09QVElPTlMgLURVU0VfREVWSUNFX0xBWUVSPVlFUyIKCiMgVXNlIERQQyB0byBnZXQgaW5mb3JtYXRpb24gZnJvbSBkZXZpY2VzLgpDTUFLRV9PUFRJT05TPSIkQ01BS0VfT1BUSU9OUyAtRFVTRV9ERVZJQ0VfUFJPUEVSVElFU19DT01QT05FTlQ9WUVTIgpDTUFLRV9PUFRJT05TPSIkQ01BS0VfT1BUSU9OUyAtRERFVklDRV9QUk9QRVJUSUVTX1BST1ZJREVSX0xPQ0FUSU9OPSQiCg==</text>
      </register>
      <register name=":" type="4">
        <text>w</text>
      </register>
    </registers>
    <search>
      <last-search encoding="base64">XDxfX1JDVFByb2ZpbGVJc1Byb2ZpbGluZ1w+</last-search>
      <last-offset />
      <last-pattern encoding="base64">XDxfX1JDVFByb2ZpbGVJc1Byb2ZpbGluZ1w+</last-pattern>
      <last-replace />
      <last-substitute encoding="base64">XDxBcHBcPg==</last-substitute>
      <last-dir>1</last-dir>
      <show-last>false</show-last>
    </search>
    <history>
      <history-search>
        <entry encoding="base64">XDxTY3JvbGxWaWV3XD4=</entry>
        <entry>return</entry>
        <entry encoding="base64">XDxyZXR1cm5cPg==</entry>
        <entry encoding="base64">XDxjb2xvckFzU3RyaW5nXD4=</entry>
        <entry>IGNITE</entry>
        <entry encoding="base64">XDxpbXBvcnRcPg==</entry>
        <entry encoding="base64">XDxNeUFwcFw+</entry>
        <entry encoding="base64">XDxOQVRJVkVfY3JlYXRlVmlld1w+</entry>
        <entry encoding="base64">XDxOQVRJVkVfY3JlYXRlUmF3VGV4dFw+</entry>
        <entry>Open up</entry>
        <entry encoding="base64">XDxBcHBcPg==</entry>
        <entry encoding="base64">XDxfQXBwXD4=</entry>
        <entry encoding="base64">XDxfQXBwMlw+</entry>
        <entry encoding="base64">XDxTaW1wbGVUZXN0XD4=</entry>
        <entry encoding="base64">XDxzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3NcPg==</entry>
        <entry encoding="base64">XDxfX2RcPg==</entry>
        <entry encoding="base64">XDwxMVw+</entry>
        <entry>YellowBox</entry>
        <entry encoding="base64">XDxZZWxsb3dCb3hcPg==</entry>
        <entry encoding="base64">XDxfX1JDVFByb2ZpbGVJc1Byb2ZpbGluZ1w+</entry>
      </history-search>
      <history-cmd>
        <entry>wq</entry>
        <entry encoding="base64">JzwsJz5zL1woc3JjXHxyZXN1bHRcKS9cMTIvcw==</entry>
        <entry encoding="base64">JzwsJz5zL1woc3JjXHxyZXN1bHRcKS9cMSAyL3M=</entry>
        <entry encoding="base64">JzwsJz5zL1woc3JjfHJlc3VsdFwpL1wxMi9z</entry>
        <entry encoding="base64">JzwsJz5zL1woc3JjXCkvXDEgMi9z</entry>
        <entry encoding="base64">JzwsJz5zLyhzcmMpL1wxIDIvcw==</entry>
        <entry encoding="base64">JzwsJz5zL3NyYy9zcmMyL3M=</entry>
        <entry encoding="base64">JzwsJz5zL3NyYy9zcmMyL2c=</entry>
        <entry encoding="base64">JzwsJz5zL1woc3JjfHJlc3VsdFwpL1wxMi9n</entry>
        <entry encoding="base64">JzwsJz5zL1woc3JjXCkvc3JjMi9n</entry>
        <entry encoding="base64">JzwsJz5zL1woc3JjXCkvXDEyL2c=</entry>
        <entry encoding="base64">JzwsJz5zL1woc3JjXHxyZXN1bHRcKS9cMTIvZw==</entry>
        <entry encoding="base64">JzwsJz5zL1woc3JjXHxyZXN1bHRcKS9cMTMvZw==</entry>
        <entry encoding="base64">JzwsJz5zL1woc3JjXHxyZXN1bHRcKS9cMTQvZw==</entry>
        <entry encoding="base64">JzwsJz5zL1woc3JjXHxyZXN1bHRcKS9cMTUvZw==</entry>
        <entry>%s/&quot;/'/g</entry>
        <entry>g/develop/d</entry>
        <entry encoding="base64">JXMvXDxMSU5VWF8vL2c=</entry>
        <entry>buf</entry>
        <entry>w</entry>
      </history-cmd>
      <history-expr />
      <history-input />
    </history>
    <shortcut-conflicts>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed R</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed CLOSE_BRACKET</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed W</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed D</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed B</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed E</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed V</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed T</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed N</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed P</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed A</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed H</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed F</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed O</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed I</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed S</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed X</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed C</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed U</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed Y</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed 2</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed OPEN_BRACKET</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed G</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed Q</text>
      </shortcut-conflict>
    </shortcut-conflicts>
  </component>
</application>